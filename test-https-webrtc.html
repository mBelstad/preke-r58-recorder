<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R58 HTTPS WebRTC Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .test-section h3 {
            margin-top: 0;
            color: #667eea;
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 5px;
            font-weight: bold;
            margin: 5px;
        }
        .status.pending { background: #FF9800; }
        .status.success { background: #4CAF50; }
        .status.error { background: #f44336; }
        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
        }
        button:hover {
            background: #764ba2;
        }
        .result {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }
        .log {
            background: #1a1a1a;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.85em;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 2px 0;
        }
        .log-entry.info { color: #2196F3; }
        .log-entry.success { color: #4CAF50; }
        .log-entry.error { color: #f44336; }
        .log-entry.warning { color: #FF9800; }
        video {
            width: 100%;
            max-width: 640px;
            background: #000;
            border-radius: 5px;
        }
        .link {
            color: #667eea;
            text-decoration: none;
        }
        .link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîí R58 HTTPS WebRTC Test Suite</h1>
        <p>Testing secure connections to R58 services via Coolify VPS</p>
    </div>

    <div class="test-section">
        <h3>1. SSL Certificate Test</h3>
        <p>Current page protocol: <strong id="protocol"></strong></p>
        <p>Current page is secure: <strong id="isSecure"></strong></p>
        <button onclick="testSSL()">Test SSL Certificates</button>
        <div id="sslResult" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h3>2. MediaMTX API Test</h3>
        <button onclick="testAPI()">Test API Connection</button>
        <span id="apiStatus" class="status pending">Pending</span>
        <div id="apiResult" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h3>3. VDO.ninja Connection Test</h3>
        <button onclick="testVDO()">Test VDO.ninja</button>
        <span id="vdoStatus" class="status pending">Pending</span>
        <div id="vdoResult" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h3>4. WebRTC Capability Test</h3>
        <button onclick="testWebRTC()">Test WebRTC Support</button>
        <span id="webrtcStatus" class="status pending">Pending</span>
        <div id="webrtcResult" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h3>5. MediaMTX WHEP Stream Test</h3>
        <p>Select camera to test:</p>
        <button onclick="testWHEP('cam0')">Test cam0</button>
        <button onclick="testWHEP('cam1')">Test cam1</button>
        <button onclick="testWHEP('cam2')">Test cam2</button>
        <button onclick="testWHEP('cam3')">Test cam3</button>
        <span id="whepStatus" class="status pending">Pending</span>
        <div id="whepResult" class="result" style="display:none;"></div>
        <video id="whepVideo" autoplay muted playsinline style="display:none;"></video>
    </div>

    <div class="test-section">
        <h3>6. Quick Links</h3>
        <p>
            <a href="https://r58-api.itagenten.no/v3/paths/list" target="_blank" class="link">üìä MediaMTX API</a><br>
            <a href="https://r58-vdo.itagenten.no/" target="_blank" class="link">üé• VDO.ninja Home</a><br>
            <a href="https://r58-vdo.itagenten.no/?director=r58studio&wss=r58-vdo.itagenten.no" target="_blank" class="link">üé¨ VDO.ninja Director</a><br>
            <a href="https://r58-mediamtx.itagenten.no/cam0" target="_blank" class="link">üìπ MediaMTX cam0</a>
        </p>
    </div>

    <div class="test-section">
        <h3>Test Log</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        // Initialize
        document.getElementById('protocol').textContent = window.location.protocol;
        document.getElementById('isSecure').textContent = window.isSecureContext ? '‚úÖ Yes' : '‚ùå No';
        log('Test page loaded', 'success');

        async function testSSL() {
            log('Testing SSL certificates...', 'info');
            const result = document.getElementById('sslResult');
            result.style.display = 'block';
            
            let html = '<h4>SSL Certificate Tests:</h4>';
            
            const urls = [
                'https://r58-api.itagenten.no/v3/paths/list',
                'https://r58-vdo.itagenten.no/',
                'https://r58-mediamtx.itagenten.no/cam0'
            ];
            
            for (const url of urls) {
                try {
                    const response = await fetch(url, { method: 'HEAD' });
                    html += `<div>‚úÖ ${url} - HTTPS OK (${response.status})</div>`;
                    log(`SSL test passed: ${url}`, 'success');
                } catch (error) {
                    html += `<div>‚ùå ${url} - Error: ${error.message}</div>`;
                    log(`SSL test failed: ${url} - ${error.message}`, 'error');
                }
            }
            
            result.innerHTML = html;
        }

        async function testAPI() {
            log('Testing MediaMTX API...', 'info');
            const status = document.getElementById('apiStatus');
            const result = document.getElementById('apiResult');
            
            status.textContent = 'Testing...';
            status.className = 'status pending';
            result.style.display = 'block';
            
            try {
                const response = await fetch('https://r58-api.itagenten.no/v3/paths/list');
                const data = await response.json();
                
                status.textContent = '‚úÖ Success';
                status.className = 'status success';
                
                result.innerHTML = `
                    <h4>API Response:</h4>
                    <div>Status: ${response.status}</div>
                    <div>Paths found: ${data.itemCount}</div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                log('API test successful', 'success');
            } catch (error) {
                status.textContent = '‚ùå Failed';
                status.className = 'status error';
                result.innerHTML = `<div>Error: ${error.message}</div>`;
                log(`API test failed: ${error.message}`, 'error');
            }
        }

        async function testVDO() {
            log('Testing VDO.ninja connection...', 'info');
            const status = document.getElementById('vdoStatus');
            const result = document.getElementById('vdoResult');
            
            status.textContent = 'Testing...';
            status.className = 'status pending';
            result.style.display = 'block';
            
            try {
                const response = await fetch('https://r58-vdo.itagenten.no/');
                const text = await response.text();
                
                status.textContent = '‚úÖ Success';
                status.className = 'status success';
                
                result.innerHTML = `
                    <h4>VDO.ninja Response:</h4>
                    <div>Status: ${response.status}</div>
                    <div>Content-Type: ${response.headers.get('content-type')}</div>
                    <div>Page size: ${(text.length / 1024).toFixed(2)} KB</div>
                    <div>Contains VDO.ninja: ${text.includes('VDO.Ninja') ? '‚úÖ Yes' : '‚ùå No'}</div>
                `;
                log('VDO.ninja test successful', 'success');
            } catch (error) {
                status.textContent = '‚ùå Failed';
                status.className = 'status error';
                result.innerHTML = `<div>Error: ${error.message}</div>`;
                log(`VDO.ninja test failed: ${error.message}`, 'error');
            }
        }

        async function testWebRTC() {
            log('Testing WebRTC capabilities...', 'info');
            const status = document.getElementById('webrtcStatus');
            const result = document.getElementById('webrtcResult');
            
            status.textContent = 'Testing...';
            status.className = 'status pending';
            result.style.display = 'block';
            
            let html = '<h4>WebRTC Support:</h4>';
            
            // Check secure context
            html += `<div>Secure Context: ${window.isSecureContext ? '‚úÖ Yes' : '‚ùå No'}</div>`;
            
            // Check RTCPeerConnection
            html += `<div>RTCPeerConnection: ${typeof RTCPeerConnection !== 'undefined' ? '‚úÖ Supported' : '‚ùå Not supported'}</div>`;
            
            // Check getUserMedia
            html += `<div>getUserMedia: ${navigator.mediaDevices && navigator.mediaDevices.getUserMedia ? '‚úÖ Supported' : '‚ùå Not supported'}</div>`;
            
            // Check WebSocket
            html += `<div>WebSocket: ${typeof WebSocket !== 'undefined' ? '‚úÖ Supported' : '‚ùå Not supported'}</div>`;
            
            // Test ICE servers
            if (typeof RTCPeerConnection !== 'undefined') {
                try {
                    const pc = new RTCPeerConnection({
                        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                    });
                    html += '<div>‚úÖ Can create RTCPeerConnection with STUN</div>';
                    pc.close();
                    log('WebRTC test successful', 'success');
                } catch (error) {
                    html += `<div>‚ùå RTCPeerConnection error: ${error.message}</div>`;
                    log(`WebRTC test failed: ${error.message}`, 'error');
                }
            }
            
            const allSupported = window.isSecureContext && typeof RTCPeerConnection !== 'undefined';
            status.textContent = allSupported ? '‚úÖ Supported' : '‚ö†Ô∏è Limited';
            status.className = allSupported ? 'status success' : 'status error';
            
            result.innerHTML = html;
        }

        async function testWHEP(camera) {
            log(`Testing WHEP stream for ${camera}...`, 'info');
            const status = document.getElementById('whepStatus');
            const result = document.getElementById('whepResult');
            const video = document.getElementById('whepVideo');
            
            status.textContent = 'Connecting...';
            status.className = 'status pending';
            result.style.display = 'block';
            video.style.display = 'none';
            
            try {
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                pc.addTransceiver('video', { direction: 'recvonly' });
                pc.addTransceiver('audio', { direction: 'recvonly' });
                
                pc.ontrack = (event) => {
                    log(`Received ${event.track.kind} track`, 'success');
                    video.srcObject = event.streams[0];
                    video.style.display = 'block';
                    status.textContent = '‚úÖ Streaming';
                    status.className = 'status success';
                };
                
                pc.oniceconnectionstatechange = () => {
                    log(`ICE connection state: ${pc.iceConnectionState}`, 'info');
                    result.innerHTML = `
                        <h4>WHEP Connection Status:</h4>
                        <div>Camera: ${camera}</div>
                        <div>ICE State: ${pc.iceConnectionState}</div>
                        <div>Connection State: ${pc.connectionState}</div>
                    `;
                };
                
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                const whepUrl = `https://r58-mediamtx.itagenten.no/${camera}/whep`;
                log(`Sending WHEP offer to ${whepUrl}`, 'info');
                
                const response = await fetch(whepUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/sdp' },
                    body: offer.sdp
                });
                
                if (!response.ok) {
                    throw new Error(`WHEP request failed: ${response.status} ${response.statusText}`);
                }
                
                const answerSdp = await response.text();
                await pc.setRemoteDescription({ type: 'answer', sdp: answerSdp });
                
                log('WHEP connection established', 'success');
                
            } catch (error) {
                status.textContent = '‚ùå Failed';
                status.className = 'status error';
                result.innerHTML = `
                    <h4>WHEP Connection Error:</h4>
                    <div>${error.message}</div>
                    <div style="margin-top:10px; color: #FF9800;">
                        Note: If you see "404" or "stream not found", the camera might not be streaming yet.
                        Start recording on R58 first.
                    </div>
                `;
                log(`WHEP test failed: ${error.message}`, 'error');
            }
        }

        // Auto-run basic tests on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('Running automatic tests...', 'info');
                testSSL();
                testAPI();
                testWebRTC();
            }, 500);
        });
    </script>
</body>
</html>







