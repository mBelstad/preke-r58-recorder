import{D as F,E as D,o as O,k as Z,G as Pe,r as w,i as x,H as Le,d as G,I as de,m as B,T as le,p as ce,c as y,e as T,z as Be,a as e,w as fe,A as be,t as S,J as De,h as b,_ as q,K as We,g as H,F as N,n as M,x as z,L as ye,q as X,M as J,N as we,u as ve,l as Ne,y as ue,B as Fe,f as ke,O as He,b as Ue,v as Ge}from"./index-CF6Mgpgb.js";import{M as Ve}from"./ModeLoadingScreen-Dk4NFv6J.js";const I=w(!1),Y=w(!1);let j=null;function Ie(){const o=F();D(()=>o.status,g=>{I.value=g==="recording"},{immediate:!0});function t(g){if(I.value)return g.preventDefault(),g.returnValue="Recording in progress. Are you sure you want to leave?",g.returnValue}O(()=>{window.addEventListener("beforeunload",t)}),Z(()=>{window.removeEventListener("beforeunload",t)}),Pe((g,c,i)=>{I.value?(j=()=>i(),Y.value=!0,i(!1)):i()});function n(){Y.value=!1,I.value=!1,o.stopRecording().finally(()=>{j&&(j(),j=null)})}function m(){Y.value=!1,j=null}return{isGuardActive:I,showLeaveConfirmation:Y,confirmLeave:n,cancelLeave:m}}const C=w(null),te=w(!1),me=w(null),ne=w(null),je=10,oe=2,ze=25;function Oe(){const o=x(()=>C.value?C.value.available_gb<oe?"critical":C.value.available_gb<je?"warning":"ok":"unknown"),t=x(()=>C.value?C.value.available_gb>=oe:!0),n=x(()=>{if(!C.value)return null;const r=C.value.available_gb*1024*1024*1024,u=ze*1024*1024,h=r/u,l=Math.floor(h/3600),_=Math.floor(h%3600/60);return l>24?`${Math.floor(l/24)}d ${l%24}h`:l>0?`${l}h ${_}m`:`${_}m`}),m=x(()=>{switch(o.value){case"ok":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}}),g=x(()=>C.value?o.value==="critical"?`Disk space critically low (${C.value.available_gb.toFixed(1)} GB). Cannot start recording.`:o.value==="warning"?`Low disk space (${C.value.available_gb.toFixed(1)} GB). Estimated recording time: ${n.value}`:null:null);async function c(){te.value=!0,ne.value=null;try{const r=await Le.getDegradation();if(r.resources&&r.resources.disk_free_gb!==void 0){const u=r.resources.disk_free_gb,h=u*3;C.value={available_gb:u,total_gb:h,used_percent:100-u/h*100,recording_path:"/opt/r58-app/shared/recordings"}}return me.value=new Date,C.value}catch(r){return ne.value=r.message||"Failed to check disk space",console.error("Failed to check disk space:",r),null}finally{te.value=!1}}async function i(){return await c(),C.value?o.value==="critical"?{ok:!1,message:`Insufficient disk space (${C.value.available_gb.toFixed(1)} GB). Need at least ${oe} GB to start recording.`}:o.value==="warning"?{ok:!0,message:`Low disk space warning: ${C.value.available_gb.toFixed(1)} GB available. Estimated recording time: ${n.value}`}:{ok:!0}:{ok:!0,message:"Could not verify disk space. Proceeding with caution."}}return{diskSpace:C,isLoading:te,lastCheck:me,error:ne,status:o,statusColor:m,canStartRecording:t,estimatedRecordingTime:n,warningMessage:g,checkDiskSpace:c,preflightCheck:i}}const P=w(localStorage.getItem("r58_audio_feedback")!=="false");let ae=null;function qe(){return ae||(ae=new(window.AudioContext||window.webkitAudioContext)),ae}function E(o,t,n="sine",m=.3){if(P.value)try{const g=qe();g.state==="suspended"&&g.resume();const c=g.createOscillator(),i=g.createGain();c.connect(i),i.connect(g.destination),c.type=n,c.frequency.value=o;const r=g.currentTime;i.gain.setValueAtTime(0,r),i.gain.linearRampToValueAtTime(m,r+.01),i.gain.linearRampToValueAtTime(0,r+t),c.start(r),c.stop(r+t)}catch(g){console.warn("Audio feedback failed:",g)}}function Ke(){P.value&&(E(440,.1,"sine",.2),setTimeout(()=>E(554,.1,"sine",.2),100),setTimeout(()=>E(659,.15,"sine",.25),200))}function Ye(){P.value&&(E(880,.08,"sine",.3),setTimeout(()=>E(880,.15,"sine",.3),120))}function Qe(){P.value&&(E(659,.1,"sine",.25),setTimeout(()=>E(554,.1,"sine",.2),100),setTimeout(()=>E(440,.15,"sine",.2),200))}function Xe(){P.value&&(E(200,.15,"square",.15),setTimeout(()=>E(180,.2,"square",.15),180))}function Je(){P.value&&(E(1e3,.08,"sine",.2),setTimeout(()=>E(1e3,.08,"sine",.2),150))}function he(){P.value&&E(1200,.03,"sine",.1)}function Ze(o=50){if(P.value&&"vibrate"in navigator)try{navigator.vibrate(o)}catch{}}function et(){function o(n){P.value=n,localStorage.setItem("r58_audio_feedback",String(n))}function t(){o(!P.value),P.value&&he()}return{enabled:P,setEnabled:o,toggle:t,playSuccess:Ke,playError:Xe,playWarning:Je,playClick:he,playRecordStart:Ye,playRecordStop:Qe,vibrate:Ze}}const tt={class:"bg-r58-bg-secondary rounded-lg shadow-xl max-w-md w-full p-6"},nt=["placeholder"],ot={class:"text-xs text-r58-text-secondary mt-2"},at=G({__name:"SessionNameDialog",props:{open:{type:Boolean},suggestedName:{}},emits:["confirm","cancel","skip"],setup(o,{emit:t}){const n=o,m=t,g=w(""),c=w(null),i=x(()=>{const k=new Date,d=k.toLocaleDateString("en-CA"),a=k.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}).replace(":","");return`Recording_${d}_${a}`}),r=x(()=>n.suggestedName||i.value);D(()=>n.open,k=>{k&&(g.value=r.value,setTimeout(()=>{var d,a;(d=c.value)==null||d.focus(),(a=c.value)==null||a.select()},100))});function u(){m("confirm",g.value.trim()||r.value)}function h(){m("skip")}function l(){m("cancel")}function _(k){k.key==="Enter"?u():k.key==="Escape"&&l()}return(k,d)=>(b(),de(De,{to:"body"},[B(le,{name:"fade"},{default:ce(()=>[o.open?(b(),y("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:Be(l,["self"]),onKeydown:_},[e("div",tt,[d[1]||(d[1]=e("h2",{class:"text-lg font-semibold mb-2"},"Name This Recording",-1)),d[2]||(d[2]=e("p",{class:"text-r58-text-secondary text-sm mb-4"}," Give your recording a name to find it easily later (optional). ",-1)),fe(e("input",{ref_key:"inputRef",ref:c,"onUpdate:modelValue":d[0]||(d[0]=a=>g.value=a),type:"text",placeholder:r.value,class:"w-full px-4 py-2 bg-r58-bg-tertiary border border-r58-bg-tertiary rounded-lg text-r58-text-primary placeholder-r58-text-secondary focus:outline-none focus:ring-2 focus:ring-r58-accent-primary"},null,8,nt),[[be,g.value]]),e("p",ot," Suggested: "+S(r.value),1),e("div",{class:"flex justify-between mt-6"},[e("button",{onClick:h,class:"text-sm text-r58-text-secondary hover:text-r58-text-primary transition-colors"}," Skip (use default) "),e("div",{class:"flex gap-3"},[e("button",{onClick:l,class:"btn"}," Cancel "),e("button",{onClick:u,class:"btn btn-primary"}," Start Recording ")])])])],32)):T("",!0)]),_:1})]))}}),st=q(at,[["__scopeId","data-v-df8c0a50"]]),rt={class:"recorder-controls"},it={key:0,class:"recorder-controls__duration"},lt=["disabled","title"],ct={key:0,class:"recorder-controls__spinner"},ut={key:0,class:"recorder-controls__icon recorder-controls__icon--stop"},dt={key:1,class:"recorder-controls__icon recorder-controls__icon--record"},ft={class:"recorder-controls__hint"},vt=G({__name:"RecorderControls",setup(o){const t=F(),{register:n}=We(),{preflightCheck:m,status:g,canStartRecording:c}=Oe(),{playRecordStart:i,playRecordStop:r,playError:u,playWarning:h,vibrate:l}=et(),_=w(null),k=w(!1),d=w(!1),a=w(!1),s=w(!1),f=w(void 0),v=x(()=>t.status==="recording"),p=x(()=>t.status==="starting"),$=x(()=>t.status==="stopping"),L=x(()=>t.formattedDuration),xe=x(()=>p.value||$.value||d.value),Se=x(()=>p.value?"Starting recording...":$.value?"Stopping recording...":d.value?"Checking disk space...":!v.value&&!c.value?"Insufficient disk space":"");let ee=null;O(()=>{ee=n({key:" ",description:"Toggle Recording",action:$e,context:"recorder",enabled:()=>!p.value&&!$.value})}),Z(()=>{ee&&ee()});async function $e(){v.value?_e():await K()}async function K(R){d.value=!0;try{const A=await m();if(!A.ok){u(),l(200),H.error("Cannot start recording",A.message||"Preflight check failed");return}if(A.message&&g.value==="warning"&&(h(),H.warning("Low disk space",A.message)),s.value&&!R){f.value=void 0,a.value=!0;return}await pe(R||f.value)}finally{d.value=!1}}async function pe(R){try{await t.startRecording(R);const A=R||t.sessionId;i(),l([50,30,50]),H.success("Recording started",`Session: ${A}`)}catch(A){u(),l(200),H.error("Failed to start recording",A.message||"Unknown error",{label:"Retry",onClick:()=>K(R)})}}function Ce(R){a.value=!1,f.value=R,K(R)}function Re(){a.value=!1,f.value=void 0,K()}function Me(){a.value=!1,d.value=!1}async function Te(){try{await t.stopRecording(),r(),l(100),H.success("Recording stopped",`Duration: ${L.value}`)}catch(R){u(),l(200),H.error("Failed to stop recording",R.message||"Unknown error")}}function _e(){var R;k.value=!1,(R=_.value)==null||R.open(),setTimeout(()=>{k.value=!0},500)}function Ae(){k.value&&Te()}async function Ee(){v.value?_e():await pe()}return(R,A)=>(b(),y(N,null,[e("div",rt,[v.value?(b(),y("div",it,S(L.value),1)):T("",!0),e("button",{onClick:Ee,disabled:xe.value,class:M(["recorder-controls__btn",v.value?"recorder-controls__btn--stop":"recorder-controls__btn--start"]),title:Se.value||(v.value?"Stop Recording (Space)":"Start Recording (Space)")},[p.value||$.value||d.value?(b(),y("span",ct)):(b(),y(N,{key:1},[v.value?(b(),y("span",ut)):(b(),y("span",dt))],64)),e("span",null,S(d.value?"Checking...":v.value?"Stop":"Start Recording"),1)],10,lt),e("span",ft,[A[0]||(A[0]=z(" Press ",-1)),A[1]||(A[1]=e("kbd",null,"Space",-1)),z(" to "+S(v.value?"stop":"start"),1)])]),B(ye,{ref_key:"stopConfirmDialog",ref:_,title:"Stop Recording?",message:`You have been recording for ${L.value}. This will finalize all files.`,"confirm-text":"Stop Recording","cancel-text":"Keep Recording",danger:!0,onConfirm:Ae},null,8,["message"]),B(st,{open:a.value,onConfirm:Ce,onSkip:Re,onCancel:Me},null,8,["open"])],64))}}),gt=q(vt,[["__scopeId","data-v-38c04e0c"]]),Q=w(localStorage.getItem("r58_performance_mode")==="true"),se=w(localStorage.getItem("r58_performance_mode_auto")!=="false"),pt=3,_t=100,mt=500;function ht(){const o=F(),t=x(()=>Q.value?!0:se.value&&o.isRecording?o.inputs.filter(_=>_.isRecording).length>=pt:!1),n=x(()=>t.value?mt:_t);D(t,l=>{l?document.body.classList.add("performance-mode"):document.body.classList.remove("performance-mode")},{immediate:!0});function m(l){Q.value=l,localStorage.setItem("r58_performance_mode",String(l))}function g(l){se.value=l,localStorage.setItem("r58_performance_mode_auto",String(l))}function c(){m(!Q.value)}function i(l,_){let k=0,d=null;return(...a)=>{const s=Date.now(),f=_??n.value,v=s-k;v>=f?(k=s,l(...a)):d||(d=window.setTimeout(()=>{k=Date.now(),d=null,l(...a)},f-v))}}function r(l,_){let k=null;return(...d)=>{k&&clearTimeout(k),k=window.setTimeout(()=>{l(...d),k=null},_??n.value)}}function u(l){return t.value?window.setTimeout(()=>l(performance.now()),n.value):requestAnimationFrame(l)}function h(l){t.value?clearTimeout(l):cancelAnimationFrame(l)}return{enabled:Q,autoEnable:se,isActive:t,updateInterval:n,setEnabled:m,setAutoEnable:g,toggle:c,throttle:i,debounce:r,requestFrame:u,cancelFrame:h}}const bt=["title"],yt={class:"flex items-center gap-1.5 text-sm"},wt={key:0,class:"flex items-center gap-1.5 text-sm"},kt={key:1,class:"flex items-center gap-1.5 text-sm text-red-400"},xt={class:"font-mono"},St=G({__name:"RecordingHealth",setup(o,{expose:t}){const n=F(),{isActive:m}=ht(),g=w({}),c=w(0),i=w(0),r=w(0);let u=null;function h(){const a={};let s=0;n.inputs.forEach(v=>{a[v.id]=v.bytesWritten;const p=g.value[v.id]||0;s+=v.bytesWritten-p});const f=m.value?2:1;c.value=Math.round(s/(1024*1024)/f*10)/10,g.value=a}D(()=>n.isRecording,a=>{if(a){g.value={},c.value=0,i.value=0,r.value=0;const s=m.value?2e3:1e3;u=window.setInterval(h,s)}else u&&(clearInterval(u),u=null)},{immediate:!0}),D(m,a=>{if(n.isRecording&&u){clearInterval(u);const s=a?2e3:1e3;u=window.setInterval(h,s)}}),Z(()=>{u&&clearInterval(u)});const l=x(()=>n.isRecording?r.value>0||i.value>90?"critical":c.value<1||i.value>70?"warning":"healthy":"idle"),_=x(()=>{switch(l.value){case"healthy":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}});x(()=>{switch(l.value){case"healthy":return"Healthy";case"warning":return"Warning";case"critical":return"Critical";default:return"Idle"}});const k=x(()=>{if(!n.isRecording)return"Not recording";const a=[`Write speed: ${c.value} MB/s`,`Buffer: ${i.value}%`];return r.value>0&&a.push(`Frames dropped: ${r.value}`),a.join(`
`)});function d(a){a.buffer_percent!==void 0&&(i.value=a.buffer_percent),a.frames_dropped!==void 0&&(r.value=a.frames_dropped)}return t({updateFromMetrics:d}),(a,s)=>X(n).isRecording?(b(),y("div",{key:0,class:M(["flex items-center gap-3 px-3 py-1.5 rounded-lg transition-colors cursor-help",{"bg-emerald-500/10":_.value==="emerald","bg-amber-500/10":_.value==="amber","bg-red-500/10":_.value==="red"}]),title:k.value},[e("span",{class:M(["w-2 h-2 rounded-full",_.value==="emerald"?"bg-emerald-500":"",_.value==="amber"?"bg-amber-500 animate-pulse":"",_.value==="red"?"bg-red-500 animate-pulse":""])},null,2),e("div",yt,[s[0]||(s[0]=e("svg",{class:"w-3.5 h-3.5 text-r58-text-secondary",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})],-1)),e("span",{class:M(["font-mono",_.value==="emerald"?"text-emerald-400":"",_.value==="amber"?"text-amber-400":"",_.value==="red"?"text-red-400":""])},S(c.value)+" MB/s ",3)]),i.value>0?(b(),y("div",wt,[s[1]||(s[1]=e("span",{class:"text-r58-text-secondary"},"Buf:",-1)),e("span",{class:M(["font-mono",i.value<50?"text-emerald-400":"",i.value>=50&&i.value<80?"text-amber-400":"",i.value>=80?"text-red-400":""])},S(i.value)+"% ",3)])):T("",!0),r.value>0?(b(),y("div",kt,[s[2]||(s[2]=e("svg",{class:"w-3.5 h-3.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),e("span",xt,S(r.value)+" dropped",1)])):T("",!0)],10,bt)):T("",!0)}}),$t=["65.109.32.111"],Ct=5,Rt=1e3,Mt=3e4,W=new Map,V=new Map;function Tt(o){const t=J(),n=we();if(t&&!n)try{return`http://${new URL(t).hostname}:8889/${o}/whep`}catch{console.warn("[WHEP Manager] Invalid device URL, falling back to FRP")}return`https://r58-mediamtx.itagenten.no/${o}/whep`}async function At(o,t){const n=W.get(t);if(!n)return"unknown";try{const c=new URL(n.whepUrl).hostname;if(c.includes("itagenten.no"))return console.log(`[WHEP Manager ${t}] Detected relay (FRP URL)`),"relay";if(c.startsWith("100."))return console.log(`[WHEP Manager ${t}] Detected P2P (Tailscale IP: ${c})`),"p2p";if(c.startsWith("192.168.")||c.startsWith("10.")||c.startsWith("172."))return console.log(`[WHEP Manager ${t}] Detected P2P (LAN IP: ${c})`),"p2p"}catch(g){console.warn(`[WHEP Manager ${t}] Failed to parse WHEP URL:`,g)}try{const g=await o.getStats();for(const c of g.values())if(c.type==="candidate-pair"&&c.state==="succeeded"){const i=g.get(c.remoteCandidateId);if((i==null?void 0:i.candidateType)==="relay")return console.log(`[WHEP Manager ${t}] Detected relay (TURN candidate)`),"relay";const r=i==null?void 0:i.address;if(r&&$t.includes(r))return console.log(`[WHEP Manager ${t}] Detected relay (VPS IP: ${r})`),"relay"}}catch(g){console.warn(`[WHEP Manager ${t}] Failed to get WebRTC stats:`,g)}return J()&&!we()?(console.log(`[WHEP Manager ${t}] Assuming P2P (direct device URL configured)`),"p2p"):"unknown"}function U(o){const t=W.get(o);if(!t)return;const n=V.get(o);n&&n.forEach(m=>m(t))}function re(o){const t=W.get(o);if(!t)return;if(t.reconnectAttempts>=Ct){console.error(`[WHEP Manager ${o}] Max reconnect attempts reached`),t.state="failed",U(o);return}t.reconnectAttempts++;const n=Math.min(Rt*Math.pow(2,t.reconnectAttempts-1),Mt);console.log(`[WHEP Manager ${o}] Scheduling reconnect #${t.reconnectAttempts} in ${n}ms`),t.state="connecting",U(o),t.reconnectTimeout&&clearTimeout(t.reconnectTimeout),t.reconnectTimeout=setTimeout(()=>{ge(o)},n)}async function ge(o){let t=W.get(o);if(t&&(t.state==="connected"||t.state==="connecting"))return console.log(`[WHEP Manager ${o}] Reusing existing connection (state: ${t.state})`),t;let n=J(),m=0;for(;!n&&m<5;)console.log(`[WHEP Manager ${o}] No device URL yet, waiting... (attempt ${m+1})`),await new Promise(r=>setTimeout(r,100)),n=J(),m++;const g=performance.now(),c=Tt(o);console.log(`[WHEP Manager ${o}] Creating connection to: ${c}`),console.log(`[WHEP Manager ${o}] Device URL was: ${n}`),t!=null&&t.peerConnection&&t.peerConnection.close();const i=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}]});t?(t.peerConnection=i,t.state="connecting",t.whepUrl=c,t.mediaStream=null,t.connectionType="unknown",t.connectionStartTime=g):(t={cameraId:o,peerConnection:i,mediaStream:null,state:"connecting",connectionType:"unknown",refCount:0,whepUrl:c,lastConnectedAt:null,reconnectAttempts:(t==null?void 0:t.reconnectAttempts)||0,reconnectTimeout:null,connectionStartTime:g},W.set(o,t)),i.ontrack=r=>{r.streams[0]&&(t.mediaStream=r.streams[0],console.log(`[WHEP Manager ${o}] Received media stream`),U(o))},i.oniceconnectionstatechange=async()=>{const r=i.iceConnectionState;if(console.log(`[WHEP Manager ${o}] ICE state: ${r}`),r==="connected"||r==="completed"){t.state="connected",t.lastConnectedAt=Date.now(),t.reconnectAttempts=0,t.connectionType=await At(i,o);const u=t.connectionStartTime?Math.round(performance.now()-t.connectionStartTime):0;console.log(`[WHEP Manager ${o}] Connected (${t.connectionType}) in ${u}ms`),U(o)}else r==="failed"?(t.state="failed",t.connectionType="unknown",U(o),t.refCount>0&&re(o)):r==="disconnected"&&setTimeout(()=>{(i.iceConnectionState==="disconnected"||i.iceConnectionState==="failed")&&(t.state="disconnected",U(o),t.refCount>0&&re(o))},3e3)},i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"});try{const r=await i.createOffer();await i.setLocalDescription(r);const u=await fetch(c,{method:"POST",headers:{"Content-Type":"application/sdp"},body:r.sdp});if(!u.ok)throw new Error(`WHEP request failed: ${u.status}`);const h=await u.text();await i.setRemoteDescription({type:"answer",sdp:h})}catch(r){console.error(`[WHEP Manager ${o}] Connection error:`,r),t.state="failed",U(o),t.refCount>0&&re(o)}return t}async function Et(o,t){V.has(o)||V.set(o,new Set),V.get(o).add(t);let n=W.get(o);return(!n||n.state==="failed"||n.state==="disconnected")&&(n=await ge(o)),n.refCount++,console.log(`[WHEP Manager ${o}] Acquired connection (refCount: ${n.refCount})`),t(n),n}function Pt(o,t){const n=W.get(o);if(!n)return;const m=V.get(o);m&&(m.delete(t),m.size===0&&V.delete(o)),n.refCount=Math.max(0,n.refCount-1),console.log(`[WHEP Manager ${o}] Released connection (refCount: ${n.refCount})`),n.refCount===0&&(console.log(`[WHEP Manager ${o}] Closing unused connection`),n.reconnectTimeout&&clearTimeout(n.reconnectTimeout),n.peerConnection.close(),W.delete(o))}function ie(o){const t=W.get(o);t&&(console.log(`[WHEP Manager ${o}] Force reconnecting...`),t.reconnectAttempts=0,ge(o))}const Lt={class:"relative w-full h-full bg-black"},Bt=["title"],Dt={key:1,class:"absolute inset-0 flex items-center justify-center bg-black/50"},Wt={key:2,class:"absolute inset-0 flex items-center justify-center bg-black/70"},Nt={class:"text-center"},Ft={class:"text-xs text-amber-400"},Ht={key:3,class:"absolute inset-0 flex items-center justify-center bg-black/80"},Ut={class:"text-center text-r58-text-secondary"},Gt={class:"text-sm"},Vt=G({__name:"InputPreview",props:{inputId:{},protocol:{}},emits:["videoReady"],setup(o,{emit:t}){const n=o,m=t,g=F();let c=!1;const i=x(()=>g.status==="recording"),r=w(null),u=w(!0),h=w(null),l=w("unknown"),_=w(!1),k=w(0);let d=null;function a(p){switch(console.log(`[InputPreview ${n.inputId}] Connection update:`,{state:p.state,type:p.connectionType,hasStream:!!p.mediaStream}),l.value=p.connectionType,k.value=p.reconnectAttempts,p.state){case"connecting":u.value=!0,h.value=null,_.value=p.reconnectAttempts>0;break;case"connected":u.value=!1,h.value=null,_.value=!1,p.mediaStream&&r.value&&r.value.srcObject!==p.mediaStream&&(r.value.srcObject=p.mediaStream,c||(r.value.onloadeddata=()=>{c||(c=!0,console.log(`[InputPreview ${n.inputId}] Video ready (first frame displayed)`),m("videoReady"))}));break;case"disconnected":_.value=!0,h.value=`Reconnecting... (${p.reconnectAttempts}/5)`;break;case"failed":u.value=!1,_.value=!1,h.value="Connection failed after multiple attempts";break}}async function s(){if(r.value){v(),u.value=!0,h.value=null,d=a;try{await Et(n.inputId,d)}catch(p){console.error(`[InputPreview ${n.inputId}] Failed to acquire connection:`,p),h.value=p instanceof Error?p.message:"Failed to connect",u.value=!1}}}function f(){ie(n.inputId)}function v(){d&&(Pt(n.inputId,d),d=null)}return O(()=>{s()}),D(()=>n.inputId,()=>{s()}),D(i,(p,$)=>{$&&!p&&h.value?(console.log("[InputPreview] Recording stopped, reconnecting preview..."),ie(n.inputId)):!$&&p&&(console.log("[InputPreview] Recording started, will try to reconnect preview after delay..."),setTimeout(()=>{i.value&&(console.log("[InputPreview] Attempting to reconnect preview during recording..."),ie(n.inputId))},2e3))}),Z(()=>{v()}),(p,$)=>(b(),y("div",Lt,[e("video",{ref_key:"videoRef",ref:r,autoplay:"",muted:"",playsinline:"",class:"w-full h-full object-contain"},null,512),!u.value&&!h.value&&l.value!=="unknown"?(b(),y("div",{key:0,class:M(["absolute top-1 right-1 px-1.5 py-0.5 text-[10px] font-medium rounded",l.value==="p2p"?"bg-emerald-500/80 text-white":"bg-amber-500/80 text-white"]),title:l.value==="p2p"?"Direct P2P connection":"Relay connection (FRP)"},S(l.value==="p2p"?"P2P":"RELAY"),11,Bt)):T("",!0),u.value&&!_.value?(b(),y("div",Dt,[...$[0]||($[0]=[e("div",{class:"animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"},null,-1)])])):T("",!0),_.value?(b(),y("div",Wt,[e("div",Nt,[$[1]||($[1]=e("div",{class:"animate-spin w-5 h-5 border-2 border-amber-400 border-t-transparent rounded-full mx-auto mb-2"},null,-1)),e("p",Ft,S(h.value||"Reconnecting..."),1)])])):h.value&&!u.value?(b(),y("div",Ht,[e("div",Ut,[e("p",Gt,S(h.value),1),e("button",{onClick:f,class:"mt-2 text-xs text-r58-accent-primary hover:underline"}," Retry ")])])):T("",!0)]))}}),It={key:0,class:"h-full flex items-center justify-center"},jt={key:1,class:"input-grid"},zt={key:0,class:"input-grid__warning"},Ot=["data-count"],qt=["title"],Kt={key:1,class:"w-full h-full flex items-center justify-center bg-r58-bg-tertiary"},Yt={class:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-4"},Qt={class:"flex items-center justify-between"},Xt={class:"flex items-center gap-2"},Jt={class:"font-medium"},Zt={key:0,class:"flex items-center gap-2 text-sm"},en={class:"text-r58-text-secondary"},tn={key:0,class:"mt-2 flex items-center justify-between"},nn={class:"text-sm font-mono text-r58-text-secondary"},on=G({__name:"InputGrid",emits:["allVideosReady"],setup(o,{emit:t}){const n=F(),m=ve(),g=t,c=w(new Set);function i(s){c.value.add(s),console.log(`[InputGrid] Video ready: ${s} (${c.value.size}/${u.value.length})`),c.value.size>=u.value.length&&(console.log("[InputGrid] All videos ready!"),g("allVideosReady"))}D(()=>u.value.length,()=>{c.value.clear()});const r=x(()=>{var s;return((s=m.capabilities)==null?void 0:s.current_mode)==="recorder"}),u=x(()=>n.inputs.filter(s=>s.hasSignal)),h=x(()=>n.framerateMismatch);function l(s){return s.isRecording?"border-r58-accent-danger ring-2 ring-r58-accent-danger/20":s.hasSignal?"border-emerald-500/50 hover:border-emerald-500":"border-r58-bg-tertiary/50 opacity-60"}function _(s){return s.hasSignal?s.framerate>=29?"excellent":s.framerate>=24?"good":"unstable":"none"}function k(s){switch(_(s)){case"excellent":return"text-emerald-400";case"good":return"text-emerald-400";case"unstable":return"text-amber-400";case"none":return"text-r58-text-secondary"}}function d(s){if(s===0)return"0 B";const f=1024,v=["B","KB","MB","GB"],p=Math.floor(Math.log(s)/Math.log(f));return parseFloat((s/Math.pow(f,p)).toFixed(1))+" "+v[p]}function a(s){if(!s.hasSignal)return`${s.label}: No signal detected`;const f=[`${s.label}`,`Resolution: ${s.resolution}`,`Framerate: ${s.framerate} fps`,`Quality: ${_(s)}`];return s.isRecording&&f.push(`Written: ${d(s.bytesWritten)}`),f.join(`
`)}return(s,f)=>u.value.length===0?(b(),y("div",It,[...f[0]||(f[0]=[Ne('<div class="text-center text-r58-text-secondary" data-v-f2a1b710><svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-f2a1b710><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" data-v-f2a1b710></path></svg><p class="text-lg font-medium" data-v-f2a1b710>No Video Sources Connected</p><p class="text-sm mt-2" data-v-f2a1b710>Connect HDMI cables to begin recording</p></div>',1)])])):(b(),y("div",jt,[h.value?(b(),y("div",zt,[f[1]||(f[1]=e("svg",{class:"w-4 h-4 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),e("span",null,S(h.value),1)])):T("",!0),e("div",{class:"input-grid__container","data-count":u.value.length},[(b(!0),y(N,null,ue(u.value,v=>(b(),y("div",{key:v.id,class:M(["input-grid__tile",l(v)]),title:a(v)},[r.value?(b(),de(Vt,{key:0,"input-id":v.id,class:"w-full h-full",onVideoReady:p=>i(v.id)},null,8,["input-id","onVideoReady"])):(b(),y("div",Kt,[...f[2]||(f[2]=[e("div",{class:"text-center"},[e("svg",{class:"w-8 h-8 mx-auto mb-2 text-r58-text-secondary/50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})]),e("span",{class:"text-xs text-r58-text-secondary/70"},"Mixer mode")],-1)])])),e("div",Yt,[e("div",Qt,[e("div",Xt,[e("span",{class:M(["w-2 h-2 rounded-full transition-colors",{"bg-emerald-500":_(v)==="excellent"||_(v)==="good","bg-amber-500 animate-pulse":_(v)==="unstable","bg-r58-text-secondary":_(v)==="none"}])},null,2),e("span",Jt,S(v.label),1)]),v.hasSignal?(b(),y("div",Zt,[e("span",en,S(v.resolution),1),e("span",{class:M(k(v))},S(v.framerate)+"fps",3)])):T("",!0)]),v.isRecording?(b(),y("div",tn,[f[3]||(f[3]=e("div",{class:"flex items-center gap-2 text-r58-accent-danger"},[e("span",{class:"w-2 h-2 rounded-full bg-r58-accent-danger animate-recording"}),e("span",{class:"text-sm font-medium"},"REC")],-1)),e("span",nn,S(d(v.bytesWritten)),1)])):T("",!0)])],10,qt))),128))],8,Ot)]))}}),an=q(on,[["__scopeId","data-v-f2a1b710"]]),sn={class:"sidebar"},rn={class:"sidebar__card"},ln=["disabled"],cn={class:"sidebar__card sidebar__card--recording"},un={class:"recording__duration"},dn={class:"recording__meta"},fn={class:"sidebar__card"},vn={class:"stats"},gn={class:"stats__label"},pn={class:"stats__value"},_n={key:0,class:"sidebar__card sidebar__card--warning"},mn={class:"warning__text"},hn={class:"sidebar__card"},bn={class:"sidebar__hint"},yn={class:"sidebar__card"},wn={class:"cameras"},kn={class:"camera__header"},xn={class:"camera__controls"},Sn=["onClick"],$n={class:"camera__btn-label"},Cn=["onClick"],Rn={class:"camera__btn-label"},Mn=["onClick"],Tn={class:"camera__btn-label"},An=["onClick"],En={class:"camera__btn-label"},Pn={key:0,class:"sidebar__card"},Ln={class:"storage"},Bn={class:"storage__bar"},Dn={class:"storage__info"},Wn={class:"storage__estimate"},Nn=G({__name:"SessionInfoV2",setup(o){const t=ke(),n=F(),m=ve();x(()=>n.currentSession);const g=x(()=>n.activeInputs),c=x(()=>n.isRecording),i=x(()=>n.inputs.filter(d=>d.isRecording)),r=w("");O(()=>{const a=new Date().toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,".");r.value=`Session ${a}`});const u=w([{id:"cam1",name:"CAM 1",focus:"auto",wb:"auto",shutter:"auto",aperture:"auto"},{id:"cam2",name:"CAM 2",focus:"auto",wb:"auto",shutter:"auto",aperture:"auto"},{id:"cam3",name:"CAM 3",focus:"auto",wb:"auto",shutter:"auto",aperture:"auto"},{id:"cam4",name:"CAM 4",focus:"auto",wb:"auto",shutter:"auto",aperture:"auto"}]);function h(d,a){const s=u.value[d];s&&(s[a]=s[a]==="auto"?"manual":"auto")}const l=x(()=>{const d=m.capabilities;if(!d)return null;const a=d.storage_used_gb||0,s=d.storage_total_gb||1,f=s-a,v=Math.round(a/s*100),p=f/10;return{freeGB:Math.round(f),totalGB:Math.round(s),percent:v,hoursRemaining:Math.round(p*10)/10,isLow:v>85,isCritical:v>95}});function _(d){if(d===0)return"0 B";const a=1024,s=["B","KB","MB","GB","TB"],f=Math.floor(Math.log(d)/Math.log(a));return parseFloat((d/Math.pow(a,f)).toFixed(2))+" "+s[f]}function k(){t.push({name:"admin",query:{tab:"settings"}})}return(d,a)=>{var s;return b(),y("div",sn,[e("div",rn,[a[1]||(a[1]=e("label",{class:"sidebar__label"},"Session Name",-1)),fe(e("input",{"onUpdate:modelValue":a[0]||(a[0]=f=>r.value=f),type:"text",class:"sidebar__input",placeholder:"Session 06.01.2026",disabled:c.value},null,8,ln),[[be,r.value]])]),c.value?(b(),y(N,{key:0},[e("div",cn,[a[2]||(a[2]=e("div",{class:"recording__header"},[e("span",{class:"recording__dot"}),e("span",{class:"recording__label"},"Recording")],-1)),e("div",un,S(X(n).formattedDuration),1),e("div",dn,S(i.value.length)+" camera"+S(i.value.length!==1?"s":"")+" recording ",1)]),e("div",fn,[a[3]||(a[3]=e("div",{class:"sidebar__label"},"Recording Stats",-1)),e("div",vn,[(b(!0),y(N,null,ue(i.value,f=>(b(),y("div",{key:f.id,class:"stats__item"},[e("span",gn,S(f.label),1),e("span",pn,S(_(f.bytesWritten)),1)]))),128))])]),(s=l.value)!=null&&s.isLow?(b(),y("div",_n,[a[5]||(a[5]=e("span",{class:"warning__icon"},"⚠️",-1)),e("div",mn,[a[4]||(a[4]=e("strong",null,"Low storage",-1)),e("span",null,S(l.value.freeGB)+" GB remaining",1)])])):T("",!0)],64)):(b(),y(N,{key:1},[e("div",hn,[a[8]||(a[8]=e("div",{class:"sidebar__label"},"Status",-1)),e("p",bn,[z(S(g.value.length)+" input"+S(g.value.length!==1?"s":"")+" with signal. Press ",1),a[6]||(a[6]=e("kbd",null,"Space",-1)),a[7]||(a[7]=z(" to start recording. ",-1))])]),e("div",yn,[a[13]||(a[13]=e("div",{class:"sidebar__label"},"Camera Controls",-1)),e("div",wn,[(b(!0),y(N,null,ue(u.value,(f,v)=>(b(),y("div",{key:f.id,class:"camera"},[e("div",kn,S(f.name),1),e("div",xn,[e("button",{class:M(["camera__btn",{"camera__btn--auto":f.focus==="auto"}]),onClick:p=>h(v,"focus"),title:"Focus"},[a[9]||(a[9]=e("span",{class:"camera__btn-icon"},"◎",-1)),e("span",$n,S(f.focus==="auto"?"A":"M"),1)],10,Sn),e("button",{class:M(["camera__btn",{"camera__btn--auto":f.wb==="auto"}]),onClick:p=>h(v,"wb"),title:"White Balance"},[a[10]||(a[10]=e("span",{class:"camera__btn-icon"},"☀",-1)),e("span",Rn,S(f.wb==="auto"?"A":"M"),1)],10,Cn),e("button",{class:M(["camera__btn",{"camera__btn--auto":f.shutter==="auto"}]),onClick:p=>h(v,"shutter"),title:"Shutter"},[a[11]||(a[11]=e("span",{class:"camera__btn-icon"},"⏱",-1)),e("span",Tn,S(f.shutter==="auto"?"A":"M"),1)],10,Mn),e("button",{class:M(["camera__btn",{"camera__btn--auto":f.aperture==="auto"}]),onClick:p=>h(v,"aperture"),title:"Aperture"},[a[12]||(a[12]=e("span",{class:"camera__btn-icon"},"◐",-1)),e("span",En,S(f.aperture==="auto"?"A":"M"),1)],10,An)])]))),128))])]),l.value?(b(),y("div",Pn,[a[14]||(a[14]=e("div",{class:"sidebar__label"},"Storage",-1)),e("div",Ln,[e("div",Bn,[e("div",{class:M(["storage__fill",{"storage__fill--ok":!l.value.isLow,"storage__fill--low":l.value.isLow&&!l.value.isCritical,"storage__fill--critical":l.value.isCritical}]),style:Fe({width:`${l.value.percent}%`})},null,6)]),e("div",Dn,[e("span",null,S(l.value.freeGB)+" GB free",1),e("span",Wn,"~"+S(l.value.hoursRemaining)+"h",1)])])])):T("",!0),e("div",{class:"sidebar__card"},[a[16]||(a[16]=e("div",{class:"sidebar__label"},"Quick Actions",-1)),e("button",{onClick:k,class:"sidebar__btn"},[...a[15]||(a[15]=[e("svg",{class:"sidebar__btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","stroke-width":"1.8"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("circle",{cx:"12",cy:"12",r:"3"})],-1),z(" Configure Inputs ",-1)])])])],64))])}}}),Fn=q(Nn,[["__scopeId","data-v-a60d7209"]]),Hn={class:"h-full flex flex-col"},Un={class:"recorder-header"},Gn={class:"recorder-header__left"},Vn={class:"recorder-header__title"},In={key:0,class:"recorder-header__badge"},jn={class:"flex-1 flex min-h-0 overflow-hidden"},zn={class:"flex-1 min-h-0 min-w-0 p-3 overflow-hidden"},On={class:"w-72 flex-shrink-0 border-l border-preke-surface-border bg-preke-surface/80 backdrop-blur-lg p-4 overflow-y-auto"},qn=G({__name:"RecorderView",setup(o){const t=ke(),n=F(),m=ve(),{showLeaveConfirmation:g,confirmLeave:c,cancelLeave:i}=Ie();function r(){t.push("/")}const u=x(()=>n.status==="recording"),h=x(()=>n.formattedDuration),l=w(!0),_=w(!1),k=w(!1),d=x(()=>_.value&&k.value);function a(){l.value=!1}async function s(){var $;if(!He())return;await m.fetchCapabilities();const p=($=m.capabilities)==null?void 0:$.current_mode;if(p&&p!=="recorder"){console.log("[Recorder] Not in recorder mode, switching...");try{(await fetch(Ue("/api/mode/recorder"),{method:"POST"})).ok&&(await m.fetchCapabilities(),H.success("Switched to Recorder mode"))}catch(L){console.warn("[Recorder] Failed to switch mode:",L)}}}function f(){console.log("[Recorder] All videos ready!"),k.value=!0}O(async()=>{const p=performance.now();await Promise.all([s(),n.fetchInputs(),n.fetchStatus()]);const $=n.inputs.filter(L=>L.hasSignal).length;console.log(`[Recorder] Data loaded: ${n.inputs.length} inputs, ${$} with signal (${Math.round(performance.now()-p)}ms)`),_.value=!0,$===0&&(k.value=!0)});const v=w(null);return D(g,p=>{var $,L;p?($=v.value)==null||$.open():(L=v.value)==null||L.close()}),(p,$)=>(b(),y(N,null,[B(le,{name:"fade"},{default:ce(()=>[l.value?(b(),de(Ve,{key:0,mode:"recorder","content-ready":d.value,"min-time":1500,"max-time":5e3,"show-cancel":!0,onReady:a,onCancel:r},null,8,["content-ready"])):T("",!0)]),_:1}),B(le,{name:"content-fade"},{default:ce(()=>[fe(e("div",Hn,[e("header",Un,[e("div",Gn,[e("div",Vn,[e("span",{class:M(["recorder-header__indicator",{"recorder-header__indicator--active":u.value}])},null,2),$[0]||($[0]=e("span",{class:"recorder-header__label"},"Recorder",-1))]),u.value?(b(),y("span",In," REC ")):T("",!0),B(St)]),B(gt)]),e("div",jn,[e("div",zn,[B(an,{onAllVideosReady:f})]),e("aside",On,[B(Fn)])]),B(ye,{ref_key:"leaveDialog",ref:v,title:"Recording in Progress",message:`You are currently recording (${h.value}). Leaving will stop the recording and save all files.`,"confirm-text":"Leave and Stop Recording","cancel-text":"Stay",danger:!0,onConfirm:X(c),onCancel:X(i)},null,8,["message","onConfirm","onCancel"])],512),[[Ge,!l.value]])]),_:1})],64))}}),Qn=q(qn,[["__scopeId","data-v-52bf7624"]]);export{Qn as default};
