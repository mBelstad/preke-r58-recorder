const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DUBhsRZp.js","assets/index-n7u0C3Yf.css"])))=>i.map(i=>d[i]);
import{r as y,D as J,E as Q,o as oe,l as _e,G as Ve,j as T,H as fe,d as Z,I as ae,m as V,T as pe,p as ne,c as h,f as W,z as Le,e,w as X,A as ce,t as R,J as Ae,i as f,_ as le,K as je,h as ee,F as Y,n as U,x as se,L as De,q as re,M as me,N as Ie,O as Be,u as $e,a as He,y as ge,B as Ge,P as We,Q as Oe,R as ze,S as qe,U as Ke,V as Ye,k as Qe,g as Ne,W as Xe,b as Je,v as Ze}from"./index-DUBhsRZp.js";import{u as et,C as tt,M as nt}from"./ModeLoadingScreen-gxfWckTm.js";function ot(){const n=y(!1),t=y(!1);let o=null;const _=J();Q(()=>_.status,a=>{n.value=a==="recording"},{immediate:!0});function l(a){if(n.value)return a.preventDefault(),a.returnValue="Recording in progress. Are you sure you want to leave?",a.returnValue}oe(()=>{window.addEventListener("beforeunload",l)}),_e(()=>{window.removeEventListener("beforeunload",l)}),Ve((a,r,u)=>{n.value?(o=()=>u(),t.value=!0,u(!1)):u()});function c(){t.value=!1,n.value=!1,_.stopRecording().finally(()=>{o&&(o(),o=null)})}function s(){t.value=!1,o=null}return{isGuardActive:n,showLeaveConfirmation:t,confirmLeave:c,cancelLeave:s}}const F=y(null),he=y(!1),Se=y(null),be=y(null),at=10,we=2,st=25;function rt(){const n=T(()=>F.value?F.value.available_gb<we?"critical":F.value.available_gb<at?"warning":"ok":"unknown"),t=T(()=>F.value?F.value.available_gb>=we:!0),o=T(()=>{if(!F.value)return null;const a=F.value.available_gb*1024*1024*1024,r=st*1024*1024,u=a/r,i=Math.floor(u/3600),$=Math.floor(u%3600/60);return i>24?`${Math.floor(i/24)}d ${i%24}h`:i>0?`${i}h ${$}m`:`${$}m`}),_=T(()=>{switch(n.value){case"ok":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}}),l=T(()=>F.value?n.value==="critical"?`Disk space critically low (${F.value.available_gb.toFixed(1)} GB). Cannot start recording.`:n.value==="warning"?`Low disk space (${F.value.available_gb.toFixed(1)} GB). Estimated recording time: ${o.value}`:null:null);async function c(){he.value=!0,be.value=null;try{const a=await fe.getDegradation();if(a.resources&&a.resources.disk_free_gb!==void 0){const r=a.resources.disk_free_gb,u=r*3;F.value={available_gb:r,total_gb:u,used_percent:100-r/u*100,recording_path:"/opt/r58-app/shared/recordings"}}return Se.value=new Date,F.value}catch(a){return be.value=a.message||"Failed to check disk space",console.error("Failed to check disk space:",a),null}finally{he.value=!1}}async function s(){return await c(),F.value?n.value==="critical"?{ok:!1,message:`Insufficient disk space (${F.value.available_gb.toFixed(1)} GB). Need at least ${we} GB to start recording.`}:n.value==="warning"?{ok:!0,message:`Low disk space warning: ${F.value.available_gb.toFixed(1)} GB available. Estimated recording time: ${o.value}`}:{ok:!0}:{ok:!0,message:"Could not verify disk space. Proceeding with caution."}}return{diskSpace:F,isLoading:he,lastCheck:Se,error:be,status:n,statusColor:_,canStartRecording:t,estimatedRecordingTime:o,warningMessage:l,checkDiskSpace:c,preflightCheck:s}}const G=y(localStorage.getItem("r58_audio_feedback")!=="false");let ye=null;function it(){return ye||(ye=new(window.AudioContext||window.webkitAudioContext)),ye}function j(n,t,o="sine",_=.3){if(G.value)try{const l=it();l.state==="suspended"&&l.resume();const c=l.createOscillator(),s=l.createGain();c.connect(s),s.connect(l.destination),c.type=o,c.frequency.value=n;const a=l.currentTime;s.gain.setValueAtTime(0,a),s.gain.linearRampToValueAtTime(_,a+.01),s.gain.linearRampToValueAtTime(0,a+t),c.start(a),c.stop(a+t)}catch(l){console.warn("Audio feedback failed:",l)}}function lt(){G.value&&(j(440,.1,"sine",.2),setTimeout(()=>j(554,.1,"sine",.2),100),setTimeout(()=>j(659,.15,"sine",.25),200))}function ct(){G.value&&(j(880,.08,"sine",.3),setTimeout(()=>j(880,.15,"sine",.3),120))}function ut(){G.value&&(j(659,.1,"sine",.25),setTimeout(()=>j(554,.1,"sine",.2),100),setTimeout(()=>j(440,.15,"sine",.2),200))}function dt(){G.value&&(j(200,.15,"square",.15),setTimeout(()=>j(180,.2,"square",.15),180))}function ft(){G.value&&(j(1e3,.08,"sine",.2),setTimeout(()=>j(1e3,.08,"sine",.2),150))}function Me(){G.value&&j(1200,.03,"sine",.1)}function vt(n=50){if(G.value&&"vibrate"in navigator)try{navigator.vibrate(n)}catch{}}function pt(){function n(o){G.value=o,localStorage.setItem("r58_audio_feedback",String(o))}function t(){n(!G.value),G.value&&Me()}return{enabled:G,setEnabled:n,toggle:t,playSuccess:lt,playError:dt,playWarning:ft,playClick:Me,playRecordStart:ct,playRecordStop:ut,vibrate:vt}}const mt={class:"bg-preke-bg-elevated rounded-lg shadow-xl max-w-md w-full p-6"},gt=["placeholder"],_t={class:"text-xs text-preke-text-dim mt-2"},ht=Z({__name:"SessionNameDialog",props:{open:{type:Boolean},suggestedName:{}},emits:["confirm","cancel","skip"],setup(n,{emit:t}){const o=n,_=t,l=y(""),c=y(null),s=T(()=>{const d=new Date,m=d.toLocaleDateString("en-CA"),v=d.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}).replace(":","");return`Recording_${m}_${v}`}),a=T(()=>o.suggestedName||s.value);Q(()=>o.open,d=>{d&&(l.value=a.value,setTimeout(()=>{var m,v;(m=c.value)==null||m.focus(),(v=c.value)==null||v.select()},100))});function r(){_("confirm",l.value.trim()||a.value)}function u(){_("skip")}function i(){_("cancel")}function $(d){d.key==="Enter"?r():d.key==="Escape"&&i()}return(d,m)=>(f(),ae(Ae,{to:"body"},[V(pe,{name:"fade"},{default:ne(()=>[n.open?(f(),h("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:Le(i,["self"]),onKeydown:$},[e("div",mt,[m[1]||(m[1]=e("h2",{class:"text-lg font-semibold mb-2"},"Name This Recording",-1)),m[2]||(m[2]=e("p",{class:"text-preke-text-dim text-sm mb-4"}," Give your recording a name to find it easily later (optional). ",-1)),X(e("input",{ref_key:"inputRef",ref:c,"onUpdate:modelValue":m[0]||(m[0]=v=>l.value=v),type:"text",placeholder:a.value,class:"w-full px-4 py-2 bg-preke-bg-surface border border-preke-bg-surface rounded-lg text-preke-text placeholder-preke-text-dim focus:outline-none focus:ring-2 focus:ring-preke-gold"},null,8,gt),[[ce,l.value]]),e("p",_t," Suggested: "+R(a.value),1),e("div",{class:"flex justify-between mt-6"},[e("button",{onClick:u,class:"text-sm text-preke-text-dim hover:text-preke-text transition-colors"}," Skip (use default) "),e("div",{class:"flex gap-3"},[e("button",{onClick:i,class:"btn"}," Cancel "),e("button",{onClick:r,class:"btn btn-primary"}," Start Recording ")])])])],32)):W("",!0)]),_:1})]))}}),bt=le(ht,[["__scopeId","data-v-2eeca4e8"]]),wt={class:"recorder-controls"},yt={key:0,class:"recorder-controls__duration"},kt=["disabled","title"],Ct={key:0,class:"recorder-controls__spinner"},xt={key:0,class:"recorder-controls__icon recorder-controls__icon--stop"},$t={key:1,class:"recorder-controls__icon recorder-controls__icon--record"},Rt={class:"recorder-controls__hint"},St=Z({__name:"RecorderControls",setup(n){const t=J(),{register:o}=je(),{preflightCheck:_,status:l,canStartRecording:c}=rt(),{playRecordStart:s,playRecordStop:a,playError:r,playWarning:u,vibrate:i}=pt(),$=y(null),d=y(!1),m=y(!1),v=y(!1),M=y(!1),B=y(void 0),k=T(()=>t.status==="recording"),C=T(()=>t.status==="starting"),S=T(()=>t.status==="stopping"),H=T(()=>t.formattedDuration),b=T(()=>C.value||S.value||m.value),A=T(()=>C.value?"Starting recording...":S.value?"Stopping recording...":m.value?"Checking disk space...":!k.value&&!c.value?"Insufficient disk space":"");let L=null;oe(()=>{L=o({key:" ",description:"Toggle Recording",action:I,context:"recorder",enabled:()=>!C.value&&!S.value})}),_e(()=>{L&&L()});async function I(){k.value?O():await q()}async function q(D){m.value=!0;try{const P=await _();if(!P.ok){r(),i(200),ee.error("Cannot start recording",P.message||"Preflight check failed");return}if(P.message&&l.value==="warning"&&(u(),ee.warning("Low disk space",P.message)),M.value&&!D){B.value=void 0,v.value=!0;return}await N(D||B.value)}finally{m.value=!1}}async function N(D){try{await t.startRecording(D);const P=D||t.sessionId;s(),i([50,30,50]),ee.success("Recording started",`Session: ${P}`)}catch(P){r(),i(200),ee.error("Failed to start recording",P.message||"Unknown error",{label:"Retry",onClick:()=>q(D)})}}function K(D){v.value=!1,B.value=D,q(D)}function g(){v.value=!1,B.value=void 0,q()}function p(){v.value=!1,m.value=!1}async function E(){try{await t.stopRecording(),a(),i(100),ee.success("Recording stopped")}catch(D){r(),i(200),ee.error("Failed to stop recording",D.message||"Unknown error")}}function O(){var D;d.value=!1,(D=$.value)==null||D.open(),setTimeout(()=>{d.value=!0},500)}function x(){d.value&&E()}async function w(){k.value?O():await N()}return(D,P)=>(f(),h(Y,null,[e("div",wt,[k.value?(f(),h("div",yt,R(H.value),1)):W("",!0),e("button",{onClick:w,disabled:b.value,class:U(["recorder-controls__btn",k.value?"recorder-controls__btn--stop":"recorder-controls__btn--start"]),title:A.value||(k.value?"Stop Recording (Space)":"Start Recording (Space)")},[C.value||S.value||m.value?(f(),h("span",Ct)):(f(),h(Y,{key:1},[k.value?(f(),h("span",xt)):(f(),h("span",$t))],64)),e("span",null,R(m.value?"Checking...":k.value?"Stop":"Start Recording"),1)],10,kt),e("span",Rt,[P[0]||(P[0]=se(" Press ",-1)),P[1]||(P[1]=e("kbd",null,"Space",-1)),se(" to "+R(k.value?"stop":"start"),1)])]),V(De,{ref_key:"stopConfirmDialog",ref:$,title:"Stop Recording?",message:`You have been recording for ${H.value}. This will finalize all files.`,"confirm-text":"Stop Recording","cancel-text":"Keep Recording",danger:!0,onConfirm:x},null,8,["message"]),V(bt,{open:v.value,onConfirm:K,onSkip:g,onCancel:p},null,8,["open"])],64))}}),Mt=le(St,[["__scopeId","data-v-1e32920d"]]),de=y(localStorage.getItem("r58_performance_mode")==="true"),ke=y(localStorage.getItem("r58_performance_mode_auto")!=="false"),Tt=3,Et=100,Pt=500;function Lt(){const n=J(),t=T(()=>de.value?!0:ke.value&&n.isRecording?n.inputs.filter($=>$.isRecording).length>=Tt:!1),o=T(()=>t.value?Pt:Et);Q(t,i=>{i?document.body.classList.add("performance-mode"):document.body.classList.remove("performance-mode")},{immediate:!0});function _(i){de.value=i,localStorage.setItem("r58_performance_mode",String(i))}function l(i){ke.value=i,localStorage.setItem("r58_performance_mode_auto",String(i))}function c(){_(!de.value)}function s(i,$){let d=0,m=null;return(...v)=>{const M=Date.now(),B=$??o.value,k=M-d;k>=B?(d=M,i(...v)):m||(m=window.setTimeout(()=>{d=Date.now(),m=null,i(...v)},B-k))}}function a(i,$){let d=null;return(...m)=>{d&&clearTimeout(d),d=window.setTimeout(()=>{i(...m),d=null},$??o.value)}}function r(i){return t.value?window.setTimeout(()=>i(performance.now()),o.value):requestAnimationFrame(i)}function u(i){t.value?clearTimeout(i):cancelAnimationFrame(i)}return{enabled:de,autoEnable:ke,isActive:t,updateInterval:o,setEnabled:_,setAutoEnable:l,toggle:c,throttle:s,debounce:a,requestFrame:r,cancelFrame:u}}const At=["title"],Dt={class:"flex items-center gap-1.5 text-sm"},Bt={key:0,class:"flex items-center gap-1.5 text-sm"},Ht={key:1,class:"flex items-center gap-1.5 text-sm text-red-400"},Wt={class:"font-mono"},Nt=Z({__name:"RecordingHealth",setup(n,{expose:t}){const o=J(),{isActive:_}=Lt(),l=y({}),c=y(0),s=y(0),a=y(0);let r=null;function u(){const v={};let M=0;o.inputs.forEach(k=>{v[k.id]=k.bytesWritten;const C=l.value[k.id]||0;M+=k.bytesWritten-C});const B=_.value?2:1;c.value=Math.round(M/(1024*1024)/B*10)/10,l.value=v}Q(()=>o.isRecording,v=>{if(v){l.value={},c.value=0,s.value=0,a.value=0;const M=_.value?2e3:1e3;r=window.setInterval(u,M)}else r&&(clearInterval(r),r=null)},{immediate:!0}),Q(_,v=>{if(o.isRecording&&r){clearInterval(r);const M=v?2e3:1e3;r=window.setInterval(u,M)}}),_e(()=>{r&&clearInterval(r)});const i=T(()=>o.isRecording?a.value>0||s.value>90?"critical":c.value<1||s.value>70?"warning":"healthy":"idle"),$=T(()=>{switch(i.value){case"healthy":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}});T(()=>{switch(i.value){case"healthy":return"Healthy";case"warning":return"Warning";case"critical":return"Critical";default:return"Idle"}});const d=T(()=>{if(!o.isRecording)return"Not recording";const v=[`Write speed: ${c.value} MB/s`,`Buffer: ${s.value}%`];return a.value>0&&v.push(`Frames dropped: ${a.value}`),v.join(`
`)});function m(v){v.buffer_percent!==void 0&&(s.value=v.buffer_percent),v.frames_dropped!==void 0&&(a.value=v.frames_dropped)}return t({updateFromMetrics:m}),(v,M)=>re(o).isRecording?(f(),h("div",{key:0,class:U(["flex items-center gap-3 px-3 py-1.5 rounded-lg transition-colors cursor-help",{"bg-emerald-500/10":$.value==="emerald","bg-amber-500/10":$.value==="amber","bg-red-500/10":$.value==="red"}]),title:d.value},[e("span",{class:U(["w-2 h-2 rounded-full",$.value==="emerald"?"bg-emerald-500":"",$.value==="amber"?"bg-amber-500 animate-pulse":"",$.value==="red"?"bg-red-500 animate-pulse":""])},null,2),e("div",Dt,[M[0]||(M[0]=e("svg",{class:"w-3.5 h-3.5 text-preke-text-dim",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})],-1)),e("span",{class:U(["font-mono",$.value==="emerald"?"text-emerald-400":"",$.value==="amber"?"text-amber-400":"",$.value==="red"?"text-red-400":""])},R(c.value)+" MB/s ",3)]),s.value>0?(f(),h("div",Bt,[M[1]||(M[1]=e("span",{class:"text-preke-text-dim"},"Buf:",-1)),e("span",{class:U(["font-mono",s.value<50?"text-emerald-400":"",s.value>=50&&s.value<80?"text-amber-400":"",s.value>=80?"text-red-400":""])},R(s.value)+"% ",3)])):W("",!0),a.value>0?(f(),h("div",Ht,[M[2]||(M[2]=e("svg",{class:"w-3.5 h-3.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),e("span",Wt,R(a.value)+" dropped",1)])):W("",!0)],10,At)):W("",!0)}});function Te(n){return n.startsWith("192.168.")||n.startsWith("10.")||n.startsWith("172.")||n.startsWith("100.")||n==="127.0.0.1"||n==="localhost"}const Ft=5,Ut=1e3,Vt=3e4,jt=()=>typeof window<"u"&&window.__NETWORK_DEBUG__===!0,Ee=new Map,It=1e3;function ve(n,t,...o){if(!jt())return;const _=Date.now(),l=Ee.get(n)||0;_-l<It||(Ee.set(n,_),console.log(`[NETWORK DEBUG ${n}] ${t}`,...o))}const z=new Map,ie=new Map;async function Gt(n){const t=me(),o=Be();if(t&&!o)try{return`http://${new URL(t).hostname}:8889/${n}/whep`}catch{console.warn("[WHEP Manager] Invalid device URL, falling back to FRP")}if(!(typeof window<"u"&&!!window.electronAPI)&&typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"))return console.log("[WHEP Manager] Local device mode, using localhost MediaMTX"),`http://localhost:8889/${n}/whep`;if(typeof window<"u"&&window.location.hostname==="app.itagenten.no")return console.log("[WHEP Manager] Browser access from app.itagenten.no, using same-domain proxy"),`https://app.itagenten.no/${n}/whep`;const{getFrpUrl:l}=await Ie(async()=>{const{getFrpUrl:s}=await import("./index-DUBhsRZp.js").then(a=>a.a4);return{getFrpUrl:s}},__vite__mapDeps([0,1])),c=await l();if(c)try{const s=new URL(c);return s.hostname.includes("itagenten.no")?`https://app.itagenten.no/${n}/whep`:s.hostname.includes("mediamtx")?`${c}/${n}/whep`:`https://${s.hostname.replace("api","mediamtx")}/${n}/whep`}catch{console.warn("[WHEP Manager] Invalid FRP URL, cannot build WHEP URL")}throw new Error("No device configured and no FRP fallback available")}async function Ot(n,t){const o=z.get(t);if(!o)return"unknown";try{const c=new URL(o.whepUrl).hostname;if(c.includes("itagenten.no"))return console.log(`[WHEP Manager ${t}] Detected relay (FRP URL)`),"relay";if(Te(c))return console.log(`[WHEP Manager ${t}] Detected P2P (private IP: ${c})`),"p2p"}catch(l){console.warn(`[WHEP Manager ${t}] Failed to parse WHEP URL:`,l)}try{const l=await n.getStats();for(const c of l.values())if(c.type==="candidate-pair"&&c.state==="succeeded"){const s=l.get(c.remoteCandidateId);if((s==null?void 0:s.candidateType)==="relay")return console.log(`[WHEP Manager ${t}] Detected relay (TURN candidate)`),"relay";const a=s==null?void 0:s.address;if(a&&!Te(a))return console.log(`[WHEP Manager ${t}] Detected relay (public IP: ${a})`),"relay"}}catch(l){console.warn(`[WHEP Manager ${t}] Failed to get WebRTC stats:`,l)}return me()&&!Be()?(console.log(`[WHEP Manager ${t}] Assuming P2P (direct device URL configured)`),"p2p"):"unknown"}function te(n){const t=z.get(n);if(!t)return;const o=ie.get(n);o&&o.forEach(_=>_(t))}function Ce(n){const t=z.get(n);if(!t)return;if(t.reconnectAttempts>=Ft){console.error(`[WHEP Manager ${n}] Max reconnect attempts reached`),t.state="failed",te(n);return}t.reconnectAttempts++;const o=Math.min(Ut*Math.pow(2,t.reconnectAttempts-1),Vt),_=o*.2*(Math.random()*2-1),l=Math.max(100,Math.round(o+_));ve("WHEP",`Camera ${n}: Reconnect #${t.reconnectAttempts} in ${l}ms (base: ${o}ms)`),console.log(`[WHEP Manager ${n}] Scheduling reconnect #${t.reconnectAttempts} in ${l}ms`),t.state="connecting",te(n),t.reconnectTimeout&&clearTimeout(t.reconnectTimeout),t.reconnectTimeout=setTimeout(()=>{Re(n)},l)}async function Re(n){let t=z.get(n);if(t&&(t.state==="connected"||t.state==="connecting"))return console.log(`[WHEP Manager ${n}] Reusing existing connection (state: ${t.state})`),t;if(t!=null&&t.isConnecting){for(ve("WHEP",`Camera ${n}: Connection already in progress, skipping duplicate attempt`),console.log(`[WHEP Manager ${n}] Connection already in progress, waiting...`);t.isConnecting&&t.state==="connecting"&&(await new Promise(r=>setTimeout(r,100)),t=z.get(n),!!t););if(t)return t}const _=!(typeof window<"u"&&!!window.electronAPI)&&typeof window<"u"&&(window.location.hostname==="app.itagenten.no"||window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1");let l=me();if(_)console.log(`[WHEP Manager ${n}] Browser-only mode (no Electron) - using appropriate proxy`);else{let r=0;for(;!l&&r<5;)console.log(`[WHEP Manager ${n}] No device URL yet, waiting... (attempt ${r+1})`),await new Promise(u=>setTimeout(u,100)),l=me(),r++}const c=performance.now(),s=await Gt(n);ve("WHEP",`Camera ${n}: Creating connection to ${s}`),console.log(`[WHEP Manager ${n}] Creating connection to: ${s}`),console.log(`[WHEP Manager ${n}] Device URL was: ${l||"none (browser mode)"}`),t!=null&&t.peerConnection&&t.peerConnection.close(),t!=null&&t.disconnectedTimeout&&(clearTimeout(t.disconnectedTimeout),t.disconnectedTimeout=null),t&&(t.isConnecting=!0);const a=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}]});t?(t.peerConnection=a,t.state="connecting",t.whepUrl=s,t.mediaStream=null,t.connectionType="unknown",t.connectionStartTime=c,t.isConnecting=!0):(t={cameraId:n,peerConnection:a,mediaStream:null,state:"connecting",connectionType:"unknown",refCount:0,whepUrl:s,lastConnectedAt:null,reconnectAttempts:0,reconnectTimeout:null,disconnectedTimeout:null,connectionStartTime:c,isConnecting:!0},z.set(n,t)),a.ontrack=r=>{if(r.streams[0]){t.mediaStream=r.streams[0],console.log(`[WHEP Manager ${n}] Received media stream`);try{const u=a.getReceivers();for(const i of u)i.track.kind==="video"&&"jitterBufferTarget"in i&&(i.jitterBufferTarget=100,console.log(`[WHEP Manager ${n}] Set jitterBufferTarget to 100ms for low latency`))}catch(u){console.warn(`[WHEP Manager ${n}] Could not set jitterBufferTarget:`,u)}te(n)}},a.oniceconnectionstatechange=async()=>{const r=a.iceConnectionState;if(ve("WHEP",`Camera ${n}: ICE state changed to ${r}`),console.log(`[WHEP Manager ${n}] ICE state: ${r}`),r==="connected"||r==="completed"){t.state="connected",t.lastConnectedAt=Date.now(),t.reconnectAttempts=0,t.isConnecting=!1,t.connectionType=await Ot(a,n),t.disconnectedTimeout&&(clearTimeout(t.disconnectedTimeout),t.disconnectedTimeout=null);const u=t.connectionStartTime?Math.round(performance.now()-t.connectionStartTime):0;console.log(`[WHEP Manager ${n}] Connected (${t.connectionType}) in ${u}ms`),te(n)}else r==="failed"?(t.state="failed",t.connectionType="unknown",t.isConnecting=!1,te(n),t.refCount>0&&Ce(n)):r==="disconnected"&&(t.disconnectedTimeout&&clearTimeout(t.disconnectedTimeout),t.disconnectedTimeout=setTimeout(()=>{(a.iceConnectionState==="disconnected"||a.iceConnectionState==="failed")&&(t.state="disconnected",t.isConnecting=!1,te(n),t.refCount>0&&Ce(n)),t.disconnectedTimeout=null},3e3))},a.addTransceiver("video",{direction:"recvonly"}),a.addTransceiver("audio",{direction:"recvonly"});try{const r=await a.createOffer();await a.setLocalDescription(r);const u=await fetch(s,{method:"POST",headers:{"Content-Type":"application/sdp"},body:r.sdp});if(!u.ok)throw new Error(`WHEP request failed: ${u.status}`);const i=await u.text();await a.setRemoteDescription({type:"answer",sdp:i})}catch(r){console.error(`[WHEP Manager ${n}] Connection error:`,r),t.state="failed",t.isConnecting=!1,te(n),t.refCount>0&&Ce(n)}return t}async function zt(n,t){ie.has(n)||ie.set(n,new Set),ie.get(n).add(t);let o=z.get(n);return(!o||o.state==="failed"||o.state==="disconnected")&&(o=await Re(n)),o.refCount++,console.log(`[WHEP Manager ${n}] Acquired connection (refCount: ${o.refCount})`),t(o),o}function qt(n,t){const o=z.get(n);if(!o)return;const _=ie.get(n);_&&(_.delete(t),_.size===0&&ie.delete(n)),o.refCount=Math.max(0,o.refCount-1),console.log(`[WHEP Manager ${n}] Released connection (refCount: ${o.refCount})`),o.refCount===0&&(console.log(`[WHEP Manager ${n}] Closing unused connection`),o.reconnectTimeout&&clearTimeout(o.reconnectTimeout),o.disconnectedTimeout&&clearTimeout(o.disconnectedTimeout),o.peerConnection.close(),z.delete(n))}function xe(n){const t=z.get(n);t&&(console.log(`[WHEP Manager ${n}] Force reconnecting...`),t.reconnectAttempts=0,Re(n))}const Kt={class:"relative w-full h-full bg-black"},Yt=["title"],Qt={key:1,class:"absolute inset-0 flex items-center justify-center bg-black/50"},Xt={class:"text-center"},Jt={class:"text-xs text-amber-400"},Zt={key:3,class:"absolute inset-0 flex items-center justify-center bg-black/80"},en={class:"text-center text-preke-text-dim"},tn={class:"text-sm"},Pe=Z({__name:"InputPreview",props:{inputId:{},protocol:{}},emits:["videoReady","aspectRatio"],setup(n,{emit:t}){const o=n,_=t,l=J();let c=!1;const s=T(()=>l.status==="recording"),a=y(null),r=y(!0),u=y(null),i=y("unknown"),$=y(!1),d=y(0);let m=null;function v(C){switch(console.log(`[InputPreview ${o.inputId}] Connection update:`,{state:C.state,type:C.connectionType,hasStream:!!C.mediaStream}),i.value=C.connectionType,d.value=C.reconnectAttempts,C.state){case"connecting":r.value=!0,u.value=null,$.value=C.reconnectAttempts>0;break;case"connected":r.value=!1,u.value=null,$.value=!1,C.mediaStream&&a.value&&a.value.srcObject!==C.mediaStream&&(a.value.srcObject=C.mediaStream,a.value.play().catch(S=>{console.warn(`[InputPreview ${o.inputId}] Autoplay prevented:`,S)}),c||(a.value.onloadeddata=()=>{if(!c&&a.value){c=!0;const S=a.value.videoWidth,H=a.value.videoHeight,b=S&&H?S/H:16/9;console.log(`[InputPreview ${o.inputId}] Video ready (${S}x${H}, ratio: ${b.toFixed(3)})`),_("aspectRatio",b),_("videoReady")}}));break;case"disconnected":$.value=!0,u.value=`Reconnecting... (${C.reconnectAttempts}/5)`;break;case"failed":r.value=!1,$.value=!1,u.value="Connection failed after multiple attempts";break}}async function M(){if(a.value){k(),r.value=!0,u.value=null,m=v;try{await zt(o.inputId,m)}catch(C){console.error(`[InputPreview ${o.inputId}] Failed to acquire connection:`,C),u.value=C instanceof Error?C.message:"Failed to connect",r.value=!1}}}function B(){xe(o.inputId)}function k(){m&&(qt(o.inputId,m),m=null)}return oe(()=>{M()}),Q(()=>o.inputId,()=>{M()}),Q(s,(C,S)=>{S&&!C&&u.value?(console.log("[InputPreview] Recording stopped, reconnecting preview..."),xe(o.inputId)):!S&&C&&(console.log("[InputPreview] Recording started, will try to reconnect preview after delay..."),setTimeout(()=>{s.value&&(console.log("[InputPreview] Attempting to reconnect preview during recording..."),xe(o.inputId))},2e3))}),_e(()=>{k()}),(C,S)=>(f(),h("div",Kt,[e("video",{ref_key:"videoRef",ref:a,autoplay:"",muted:"",playsinline:"",class:"w-full h-full object-contain"},null,512),!r.value&&!u.value&&i.value!=="unknown"?(f(),h("div",{key:0,class:U(["absolute top-1 right-1 px-1.5 py-0.5 text-[10px] font-medium rounded",i.value==="p2p"?"bg-emerald-500/80 text-white":"bg-amber-500/80 text-white"]),title:i.value==="p2p"?"Direct P2P connection":"Relay connection (FRP)"},R(i.value==="p2p"?"P2P":"RELAY"),11,Yt)):W("",!0),r.value&&!$.value?(f(),h("div",Qt,[...S[0]||(S[0]=[e("div",{class:"animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"},null,-1)])])):W("",!0),$.value?(f(),h("div",{key:2,class:"absolute inset-0 flex items-center justify-center bg-black/70 cursor-pointer",onClick:B,title:"Click to force reconnect"},[e("div",Xt,[S[1]||(S[1]=e("div",{class:"animate-spin w-5 h-5 border-2 border-amber-400 border-t-transparent rounded-full mx-auto mb-2"},null,-1)),e("p",Jt,R(u.value||"Reconnecting..."),1),S[2]||(S[2]=e("p",{class:"text-xs text-amber-400/60 mt-1"},"Tap to retry",-1))])])):u.value&&!r.value?(f(),h("div",Zt,[e("div",en,[e("p",tn,R(u.value),1),e("button",{onClick:B,class:"mt-2 text-xs text-preke-gold hover:underline"}," Retry ")])])):W("",!0)]))}}),nn={key:0,class:"h-full flex items-center justify-center"},on={key:1,class:"input-grid"},an={key:0,class:"input-grid__warning"},sn=["data-count"],rn=["title","onClick"],ln={key:1,class:"w-full h-full flex items-center justify-center bg-preke-bg-surface"},cn={class:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-4"},un={class:"flex items-center justify-between"},dn={class:"flex items-center gap-2"},fn={class:"font-medium"},vn={key:0,class:"flex items-center gap-2 text-sm"},pn={class:"text-preke-text-dim"},mn={class:"enlarged-modal__info"},gn={class:"flex items-center gap-3"},_n={class:"font-semibold text-lg"},hn={key:0,class:"px-2 py-0.5 text-xs font-bold bg-preke-red/20 text-preke-red rounded"},bn={class:"flex items-center gap-4 text-sm"},wn={class:"text-preke-text-dim"},yn=Z({__name:"InputGrid",emits:["allVideosReady"],setup(n,{emit:t}){const o=J(),_=$e(),l=t,c=y(new Set),s=y(null);function a(b){s.value=b}function r(){s.value=null}const u=y({});function i(b){c.value.add(b),console.log(`[InputGrid] Video ready: ${b} (${c.value.size}/${v.value.length})`),c.value.size>=v.value.length&&(console.log("[InputGrid] All videos ready!"),l("allVideosReady"))}function $(b,A){u.value[b]=A,console.log(`[InputGrid] Aspect ratio for ${b}: ${A.toFixed(3)}`)}function d(b){return{aspectRatio:`${u.value[b]||1.7777777777777777}`}}Q(()=>v.value.length,()=>{c.value.clear()});const m=T(()=>{var b;return((b=_.capabilities)==null?void 0:b.current_mode)==="recorder"}),v=T(()=>o.inputs.filter(b=>b.hasSignal)),M=T(()=>o.framerateMismatch);function B(b){return b.isRecording?"border-preke-red ring-2 ring-preke-red/20":b.hasSignal?"border-emerald-500/50 hover:border-emerald-500":"border-preke-bg-surface/50 opacity-60"}function k(b){return b.hasSignal?b.framerate>=29?"excellent":b.framerate>=24?"good":"unstable":"none"}function C(b){switch(k(b)){case"excellent":return"text-emerald-400";case"good":return"text-emerald-400";case"unstable":return"text-amber-400";case"none":return"text-preke-text-dim"}}function S(b){if(b===0)return"0 B";const A=1024,L=["B","KB","MB","GB"],I=Math.floor(Math.log(b)/Math.log(A));return parseFloat((b/Math.pow(A,I)).toFixed(1))+" "+L[I]}function H(b){if(!b.hasSignal)return`${b.label}: No signal detected`;const A=[`${b.label}`,`Resolution: ${b.resolution}`,`Framerate: ${b.framerate} fps`,`Quality: ${k(b)}`];return b.isRecording&&A.push(`Written: ${S(b.bytesWritten)}`),A.join(`
`)}return(b,A)=>v.value.length===0?(f(),h("div",nn,[...A[1]||(A[1]=[He('<div class="text-center text-preke-text-dim" data-v-53f60619><svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-53f60619><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" data-v-53f60619></path></svg><p class="text-lg font-medium" data-v-53f60619>No Video Sources Connected</p><p class="text-sm mt-2" data-v-53f60619>Connect HDMI cables to begin recording</p></div>',1)])])):(f(),h("div",on,[M.value?(f(),h("div",an,[A[2]||(A[2]=e("svg",{class:"w-4 h-4 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),e("span",null,R(M.value),1)])):W("",!0),e("div",{class:"input-grid__container","data-count":v.value.length},[(f(!0),h(Y,null,ge(v.value,L=>(f(),h("div",{key:L.id,class:U(["input-grid__tile",B(L)]),style:Ge(d(L.id)),title:H(L),onClick:I=>a(L)},[m.value?(f(),ae(Pe,{key:0,"input-id":L.id,class:"w-full h-full",onVideoReady:I=>i(L.id),onAspectRatio:I=>$(L.id,I)},null,8,["input-id","onVideoReady","onAspectRatio"])):(f(),h("div",ln,[...A[3]||(A[3]=[e("div",{class:"text-center"},[e("svg",{class:"w-8 h-8 mx-auto mb-2 text-preke-text-dim/50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})]),e("span",{class:"text-xs text-preke-text-dim/70"},"Mixer mode")],-1)])])),e("div",cn,[e("div",un,[e("div",dn,[e("span",{class:U(["w-2 h-2 rounded-full transition-colors",{"bg-emerald-500":k(L)==="excellent"||k(L)==="good","bg-amber-500 animate-pulse":k(L)==="unstable","bg-preke-text-dim":k(L)==="none"}])},null,2),e("span",fn,R(L.label),1)]),L.hasSignal?(f(),h("div",vn,[e("span",pn,R(L.resolution),1),e("span",{class:U(C(L))},R(L.framerate)+"fps",3)])):W("",!0)])])],14,rn))),128))],8,sn),(f(),ae(Ae,{to:"body"},[V(pe,{name:"enlarged"},{default:ne(()=>[s.value?(f(),h("div",{key:0,class:"enlarged-modal",onClick:r},[e("div",{class:"enlarged-modal__content",onClick:A[0]||(A[0]=Le(()=>{},["stop"]))},[m.value?(f(),ae(Pe,{key:0,"input-id":s.value.id,class:"w-full h-full"},null,8,["input-id"])):W("",!0),e("div",mn,[e("div",gn,[e("span",{class:U(["w-2.5 h-2.5 rounded-full",{"bg-emerald-500":k(s.value)==="excellent"||k(s.value)==="good","bg-amber-500 animate-pulse":k(s.value)==="unstable","bg-preke-text-dim":k(s.value)==="none"}])},null,2),e("span",_n,R(s.value.label),1),s.value.isRecording?(f(),h("span",hn," REC ")):W("",!0)]),e("div",bn,[e("span",wn,R(s.value.resolution),1),e("span",{class:U(C(s.value))},R(s.value.framerate)+"fps",3)])]),e("button",{class:"enlarged-modal__close",onClick:r,title:"Close (or click outside)"},[...A[4]||(A[4]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])])):W("",!0)]),_:1})]))]))}}),kn=le(yn,[["__scopeId","data-v-53f60619"]]),Cn={key:0,class:"py-8 text-center text-preke-text-muted"},xn={key:1,class:"camera-setup"},$n={class:"camera-list"},Rn={class:"list-header"},Sn=["disabled"],Mn={key:0,class:"empty-state"},Tn={key:1,class:"camera-items"},En={class:"camera-item__info"},Pn={class:"camera-item__header"},Ln={class:"camera-item__name"},An={class:"camera-item__details"},Dn={class:"camera-item__type"},Bn={class:"camera-item__ip"},Hn={class:"camera-item__actions"},Wn=["onClick","disabled"],Nn={key:0,class:"btn-icon-sm",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Fn={key:1,class:"spinner"},Un=["onClick","disabled"],Vn=["onClick","disabled"],jn={key:0,class:"camera-form"},In={class:"form-header"},Gn={class:"form-title"},On={class:"form-content"},zn={class:"form-group"},qn={class:"form-group"},Kn=["value"],Yn={class:"form-group"},Qn={class:"form-group"},Xn=["placeholder"],Jn={class:"form-hint"},Zn={class:"form-group"},eo={class:"form-checkbox"},to={class:"form-actions"},no={class:"flex items-center justify-between w-full"},oo={key:0,class:"text-sm text-amber-400"},ao={key:1,class:"text-sm text-preke-text-muted"},so={class:"flex gap-3"},ro=["disabled"],io=Z({__name:"CameraSetupModal",emits:["close","updated"],setup(n,{expose:t,emit:o}){const _=o,l=y(null),c=We(),s=y(!1),a=y(!1),r=y(null),u=y([]),i=y(null),$=[{value:"blackmagic",label:"Blackmagic Design Studio Camera 4K Pro"},{value:"obsbot_tail2",label:"OBSbot Tail 2"}],d=y({name:"",type:"blackmagic",ip:"",port:void 0,enabled:!0}),m={blackmagic:80,obsbot_tail2:52381},v=T(()=>i.value!==null),M=y(!1);async function B(){s.value=!0;try{const g=await fe.cameras.getConfig();u.value=g.cameras.map(p=>({name:p.name,type:p.type,ip:p.ip,port:p.port,enabled:p.enabled??!0})),M.value=!1}catch(g){console.error("[CameraSetup] Failed to load config:",g),c.error("Failed to load camera configuration")}finally{s.value=!1}}function k(){d.value={name:"",type:"blackmagic",ip:"",port:void 0,enabled:!0},i.value=null}function C(g){i.value=g,d.value={...u.value[g]}}function S(){k()}function H(){k(),i.value=-1}async function b(g){confirm(`Delete camera "${u.value[g].name}"?`)&&(u.value.splice(g,1),M.value=!0,await q())}async function A(g){r.value=g.name;try{(await fe.cameras.getStatus(g.name)).connected?c.success(`${g.name} is connected!`):c.warning(`${g.name} is not connected`)}catch{try{const E=await fetch(`http://${g.ip}:${g.port||m[g.type]}/`,{method:"HEAD",mode:"no-cors",signal:AbortSignal.timeout(3e3)});c.info(`${g.name}: IP ${g.ip} is reachable`)}catch{c.error(`${g.name}: Cannot reach ${g.ip}`)}}finally{r.value=null}}function L(){return d.value.name.trim()?d.value.ip.trim()?/^(\d{1,3}\.){3}\d{1,3}$/.test(d.value.ip)?u.value.findIndex((E,O)=>E.name===d.value.name&&O!==i.value)>=0?(c.error("Camera name already exists"),!1):!0:(c.error("Invalid IP address format"),!1):(c.error("Camera IP address is required"),!1):(c.error("Camera name is required"),!1)}function I(){L()&&(d.value.port||(d.value.port=m[d.value.type]),i.value===-1?u.value.push({...d.value}):i.value!==null&&i.value>=0&&(u.value[i.value]={...d.value}),M.value=!0,k())}async function q(){a.value=!0;try{await fe.cameras.updateConfig(u.value),c.success("Camera configuration saved!"),M.value=!1,_("updated")}catch(g){console.error("[CameraSetup] Failed to save config:",g),c.error("Failed to save configuration: "+(g.message||"Unknown error"))}finally{a.value=!1}}function N(){var g;(g=l.value)==null||g.open(),B()}function K(){var g;M.value&&!confirm("You have unsaved changes. Close anyway?")||((g=l.value)==null||g.close(),k(),M.value=!1,_("close"))}return t({open:N,close:K}),oe(()=>{B()}),(g,p)=>(f(),ae(qe,{ref_key:"modalRef",ref:l,title:"Camera Setup",size:"xl",onClose:K},{header:ne(()=>[...p[5]||(p[5]=[e("div",{class:"flex items-center justify-between w-full"},[e("div",null,[e("h2",{class:"text-lg font-semibold text-preke-text"},"Camera Setup"),e("p",{class:"text-sm text-preke-text-muted mt-1"}," Configure external cameras for control ")])],-1)])]),footer:ne(()=>[e("div",no,[M.value?(f(),h("div",oo," You have unsaved changes ")):(f(),h("div",ao,R(u.value.length)+" camera"+R(u.value.length!==1?"s":"")+" configured ",1)),e("div",so,[e("button",{onClick:K,class:"btn-secondary"}," Close "),e("button",{onClick:q,disabled:!M.value||a.value,class:"btn-primary"},R(a.value?"Saving...":"Save Configuration"),9,ro)])])]),default:ne(()=>[s.value?(f(),h("div",Cn," Loading camera configuration... ")):(f(),h("div",xn,[e("div",$n,[e("div",Rn,[p[7]||(p[7]=e("h3",{class:"list-title"},"Configured Cameras",-1)),e("button",{onClick:H,class:"btn-add",disabled:v.value},[...p[6]||(p[6]=[e("svg",{class:"btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),se(" Add Camera ",-1)])],8,Sn)]),u.value.length===0&&!v.value?(f(),h("div",Mn,[...p[8]||(p[8]=[e("svg",{class:"empty-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})],-1),e("p",{class:"empty-text"},"No cameras configured",-1),e("p",{class:"empty-hint"},'Click "Add Camera" to get started',-1)])])):(f(),h("div",Tn,[(f(!0),h(Y,null,ge(u.value,(E,O)=>{var x;return f(),h("div",{key:O,class:U(["camera-item",{"camera-item--disabled":!E.enabled}])},[e("div",En,[e("div",Pn,[e("span",Ln,R(E.name),1),e("span",{class:U(["camera-item__badge",E.enabled?"camera-item__badge--enabled":"camera-item__badge--disabled"])},R(E.enabled?"Enabled":"Disabled"),3)]),e("div",An,[e("span",Dn,R(((x=$.find(w=>w.value===E.type))==null?void 0:x.label)||E.type),1),e("span",Bn,R(E.ip)+":"+R(E.port||m[E.type]),1)])]),e("div",Hn,[e("button",{onClick:w=>A(E),disabled:r.value===E.name,class:"btn-test",title:"Test Connection"},[r.value!==E.name?(f(),h("svg",Nn,[...p[9]||(p[9]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 10V3L4 14h7v7l9-11h-7z"},null,-1)])])):(f(),h("span",Fn))],8,Wn),e("button",{onClick:w=>C(O),disabled:v.value,class:"btn-edit",title:"Edit"},[...p[10]||(p[10]=[e("svg",{class:"btn-icon-sm",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})],-1)])],8,Un),e("button",{onClick:w=>b(O),disabled:v.value,class:"btn-delete",title:"Delete"},[...p[11]||(p[11]=[e("svg",{class:"btn-icon-sm",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})],-1)])],8,Vn)])],2)}),128))]))]),v.value?(f(),h("div",jn,[e("div",In,[e("h3",Gn,R(i.value===-1?"Add Camera":"Edit Camera"),1),e("button",{onClick:S,class:"btn-cancel-form"},"Cancel")]),e("div",On,[e("div",zn,[p[12]||(p[12]=e("label",{class:"form-label"},"Camera Name *",-1)),X(e("input",{"onUpdate:modelValue":p[0]||(p[0]=E=>d.value.name=E),type:"text",class:"form-input",placeholder:"e.g., BMD Cam 1"},null,512),[[ce,d.value.name]])]),e("div",qn,[p[13]||(p[13]=e("label",{class:"form-label"},"Camera Type *",-1)),X(e("select",{"onUpdate:modelValue":p[1]||(p[1]=E=>d.value.type=E),class:"form-input"},[(f(),h(Y,null,ge($,E=>e("option",{key:E.value,value:E.value},R(E.label),9,Kn)),64))],512),[[Oe,d.value.type]])]),e("div",Yn,[p[14]||(p[14]=e("label",{class:"form-label"},"IP Address *",-1)),X(e("input",{"onUpdate:modelValue":p[2]||(p[2]=E=>d.value.ip=E),type:"text",class:"form-input",placeholder:"192.168.1.101"},null,512),[[ce,d.value.ip]]),p[15]||(p[15]=e("p",{class:"form-hint"},"Camera's network IP address",-1))]),e("div",Qn,[p[16]||(p[16]=e("label",{class:"form-label"},"Port",-1)),X(e("input",{"onUpdate:modelValue":p[3]||(p[3]=E=>d.value.port=E),type:"number",class:"form-input",placeholder:String(m[d.value.type])},null,8,Xn),[[ce,d.value.port,void 0,{number:!0}]]),e("p",Jn,"Default: "+R(m[d.value.type])+" for "+R(d.value.type),1)]),e("div",Zn,[e("label",eo,[X(e("input",{"onUpdate:modelValue":p[4]||(p[4]=E=>d.value.enabled=E),type:"checkbox",class:"checkbox"},null,512),[[ze,d.value.enabled]]),p[17]||(p[17]=e("span",null,"Enabled",-1))]),p[18]||(p[18]=e("p",{class:"form-hint"},"Disable to keep configuration but not use the camera",-1))]),e("div",to,[e("button",{onClick:I,class:"btn-save-form"},R(i.value===-1?"Add Camera":"Update Camera"),1),e("button",{onClick:S,class:"btn-cancel-form"}," Cancel ")])])])):W("",!0)]))]),_:1},512))}}),lo=le(io,[["__scopeId","data-v-d42e0adf"]]),co={class:"sidebar"},uo={class:"sidebar__card sidebar__card--header"},fo={class:"connection-row"},vo={class:"connection-status"},po={class:"connection-label"},mo={key:0,class:"connection-latency"},go=["disabled"],_o={class:"sidebar__card sidebar__card--recording"},ho={class:"recording__duration"},bo={class:"recording__meta"},wo={key:0,class:"sidebar__card sidebar__card--warning"},yo={class:"warning__text"},ko={key:1,class:"sidebar__card sidebar__card--davinci"},Co={class:"davinci__buttons"},xo=["disabled"],$o=["disabled"],Ro=["disabled"],So={class:"sidebar__card"},Mo={key:0,class:"cameras"},To={class:"camera__header"},Eo=["onClick","disabled"],Po={key:1,class:"cameras-empty"},Lo=Z({__name:"SessionInfoV2",setup(n){const t=Ne(),o=J(),_=$e(),l=We(),{state:c,latencyMs:s}=Ke(),{connectionMethod:a}=Ye(),r=T(()=>{const x=c.value==="connected",w=c.value==="connecting",D=c.value==="degraded";if(x){let P="";return a.value==="relay"?P="Relay":a.value==="p2p"?P="P2P":a.value==="local"&&(P="Local"),{status:"online",color:"green",label:P||"Connected",latency:s.value,pulse:!1}}return w?{status:"connecting",color:"amber",label:"Connecting...",latency:null,pulse:!0}:D?{status:"degraded",color:"amber",label:"Slow",latency:s.value,pulse:!1}:{status:"offline",color:"red",label:"Offline",latency:null,pulse:!0}}),u=T(()=>o.currentSession),i=T(()=>o.activeInputs),$=T(()=>o.isRecording),d=T(()=>o.inputs.filter(x=>x.isRecording)),m=y("");oe(()=>{const w=new Date().toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,".");m.value=`Session ${w}`});const{cameras:v,loadCameras:M}=et(),B=y(null),k=y(null),C=y(null);oe(async()=>{await M()});function S(x){var w;B.value=x,(w=k.value)==null||w.open()}function H(){B.value=null}function b(){var x;(x=C.value)==null||x.open()}function A(){M()}const L=T(()=>{const x=_.capabilities;if(!x)return null;const w=x.storage_total_gb||1,D=x.storage_available_gb||0,P=w-D,ue=Math.round(P/w*100),Fe=(i.value.length||1)*8,Ue=D/Fe;return{freeGB:Math.round(D),totalGB:Math.round(w),percent:ue,hoursRemaining:Math.round(Ue*10)/10,isLow:ue>85,isCritical:ue>95}});function I(){t.push({name:"admin",query:{tab:"settings"}})}const q=T(()=>Qe()),N=y(!1),K=T(()=>{const x=u.value;return x!=null&&x.id?`Preke_${x.id}`:`Preke_${m.value.replace(/\s+/g,"_")}`}),g=window.electronAPI;async function p(){if(g!=null&&g.davinciOpenProject){N.value=!0,l.info("Opening DaVinci Resolve...");try{const x=await g.davinciOpenProject(K.value);x.success?l.success(`Opened project: ${x.projectName}`):l.error(x.error||"Failed to open DaVinci project")}catch(x){console.error("DaVinci error:",x),l.error("Failed to connect to DaVinci Resolve")}finally{N.value=!1}}}async function E(){if(g!=null&&g.davinciCreateMulticam){N.value=!0;try{g.davinciOpenProject&&await g.davinciOpenProject(K.value);const x=await g.davinciCreateMulticam({projectName:K.value,clipName:`Multicam_${m.value.replace(/\s+/g,"_")}`,syncMethod:"timecode"});x.success?l.success(`Created timeline: ${x.timelineName}`):l.error(x.error||"Failed to create multicam timeline")}catch(x){console.error("DaVinci error:",x),l.error("Failed to create multicam timeline")}finally{N.value=!1}}}async function O(){if(g!=null&&g.davinciRefreshClips){N.value=!0,l.info("Refreshing growing clips...");try{const x=await g.davinciRefreshClips();if(x.success){const w=x.clipsRefreshed||0;l.success(`Refreshed ${w} clip${w!==1?"s":""}`)}else l.error(x.error||"Failed to refresh clips")}catch(x){console.error("DaVinci refresh error:",x),l.error("Failed to refresh clips")}finally{N.value=!1}}}return(x,w)=>{var D;return f(),h("div",co,[e("div",uo,[e("div",fo,[e("div",vo,[e("span",{class:U(["connection-dot",[`connection-dot--${r.value.color}`,{"connection-dot--pulse":r.value.pulse}]])},null,2),e("span",po,R(r.value.label),1),r.value.latency?(f(),h("span",mo,R(r.value.latency)+"ms ",1)):W("",!0)])]),w[1]||(w[1]=e("div",{class:"sidebar__divider"},null,-1)),w[2]||(w[2]=e("label",{class:"sidebar__label"},"Session Name",-1)),X(e("input",{"onUpdate:modelValue":w[0]||(w[0]=P=>m.value=P),type:"text",class:"sidebar__input",placeholder:"Session 06.01.2026",disabled:$.value},null,8,go),[[ce,m.value]])]),$.value?(f(),h(Y,{key:0},[e("div",_o,[w[3]||(w[3]=e("div",{class:"recording__header"},[e("span",{class:"recording__dot"}),e("span",{class:"recording__label"},"Recording")],-1)),e("div",ho,R(re(o).formattedDuration),1),e("div",bo,R(d.value.length)+" camera"+R(d.value.length!==1?"s":"")+" recording ",1)]),(D=L.value)!=null&&D.isLow?(f(),h("div",wo,[w[5]||(w[5]=e("span",{class:"warning__icon"},"⚠️",-1)),e("div",yo,[w[4]||(w[4]=e("strong",null,"Low storage",-1)),e("span",null,R(L.value.freeGB)+" GB remaining",1)])])):W("",!0),q.value?(f(),h("div",ko,[w[6]||(w[6]=He('<div class="davinci__header" data-v-66bc798a><svg class="davinci__icon" viewBox="0 0 24 24" fill="currentColor" data-v-66bc798a><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" data-v-66bc798a></path></svg><span class="davinci__label" data-v-66bc798a>DaVinci Resolve</span></div><p class="davinci__hint" data-v-66bc798a>Edit while recording (mount R58 recordings via SMB)</p>',2)),e("div",Co,[e("button",{onClick:p,disabled:N.value,class:"davinci__btn"},R(N.value?"Opening...":"Open Project"),9,xo),e("button",{onClick:E,disabled:N.value,class:"davinci__btn davinci__btn--secondary"}," Create Multicam ",8,$o),e("button",{onClick:O,disabled:N.value,class:"davinci__btn davinci__btn--secondary",title:"Refresh growing clips to update duration"},R(N.value?"Refreshing...":"Refresh Clips"),9,Ro)])])):W("",!0)],64)):(f(),h(Y,{key:1},[e("div",So,[e("div",{class:"sidebar__label"},[w[8]||(w[8]=se(" Camera Controls ",-1)),e("button",{onClick:b,class:"camera-setup-btn",title:"Setup Cameras"},[...w[7]||(w[7]=[e("svg",{class:"camera-setup-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("circle",{cx:"12",cy:"12",r:"3"})],-1)])])]),re(v).length>0?(f(),h("div",Mo,[(f(!0),h(Y,null,ge(re(v),P=>(f(),h("div",{key:P.name,class:"camera"},[e("div",To,[se(R(P.name)+" ",1),e("span",{class:U(["camera__status",P.connected?"camera__status--connected":"camera__status--disconnected"])},R(P.connected?"●":"○"),3)]),e("button",{class:"camera__control-btn",onClick:ue=>S(P.name),disabled:!P.connected},[...w[9]||(w[9]=[e("svg",{class:"camera__control-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("circle",{cx:"12",cy:"12",r:"3"})],-1),e("span",null,"Controls",-1)])],8,Eo)]))),128))])):(f(),h("div",Po,[w[10]||(w[10]=e("p",{class:"cameras-empty__text"},"No cameras configured",-1)),e("button",{onClick:b,class:"cameras-empty__btn"}," Setup Cameras ")]))]),V(tt,{ref_key:"cameraModalRef",ref:k,"camera-name":B.value,onClose:H},null,8,["camera-name"]),V(lo,{ref_key:"cameraSetupModalRef",ref:C,onUpdated:A},null,512),e("div",{class:"sidebar__card"},[w[12]||(w[12]=e("div",{class:"sidebar__label"},"Quick Actions",-1)),e("button",{onClick:I,class:"sidebar__btn"},[...w[11]||(w[11]=[e("svg",{class:"sidebar__btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","stroke-width":"1.8"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("circle",{cx:"12",cy:"12",r:"3"})],-1),se(" Configure Inputs ",-1)])])])],64))])}}}),Ao=le(Lo,[["__scopeId","data-v-66bc798a"]]),Do={class:"h-full flex flex-col"},Bo={class:"recorder-header"},Ho={class:"recorder-header__left"},Wo={class:"recorder-header__title"},No={key:0,class:"recorder-header__badge"},Fo={class:"flex-1 flex min-h-0 overflow-hidden"},Uo={class:"flex-1 min-h-0 min-w-0 p-3 overflow-hidden"},Vo={class:"w-72 flex-shrink-0 border-l border-preke-surface-border bg-preke-surface/80 backdrop-blur-lg p-4 overflow-y-auto"},jo=Z({__name:"RecorderView",setup(n){const t=Ne(),o=J(),_=$e(),{showLeaveConfirmation:l,confirmLeave:c,cancelLeave:s}=ot();function a(){t.push("/")}const r=T(()=>o.status==="recording"),u=T(()=>o.formattedDuration),i=y(!0),$=y(!1),d=y(!1),m=T(()=>$.value&&d.value);function v(){i.value=!1}async function M(){var S;if(!Xe())return;await _.fetchCapabilities();const C=(S=_.capabilities)==null?void 0:S.current_mode;if(C&&C!=="recorder"){console.log("[Recorder] Not in recorder mode, switching...");try{(await fetch(await Je("/api/mode/recorder"),{method:"POST"})).ok&&(await _.fetchCapabilities(),ee.success("Switched to Recorder mode"))}catch(H){console.warn("[Recorder] Failed to switch mode:",H)}}}function B(){console.log("[Recorder] All videos ready!"),d.value=!0}oe(async()=>{const C=performance.now();await Promise.all([M(),o.fetchInputs(),o.fetchStatus()]);const S=o.inputs.filter(H=>H.hasSignal).length;console.log(`[Recorder] Data loaded: ${o.inputs.length} inputs, ${S} with signal (${Math.round(performance.now()-C)}ms)`),$.value=!0,S===0&&(d.value=!0)});const k=y(null);return Q(l,C=>{var S,H;C?(S=k.value)==null||S.open():(H=k.value)==null||H.close()}),(C,S)=>(f(),h(Y,null,[V(pe,{name:"fade"},{default:ne(()=>[i.value?(f(),ae(nt,{key:0,mode:"recorder","content-ready":m.value,"min-time":1500,"max-time":5e3,"show-cancel":!0,onReady:v,onCancel:a},null,8,["content-ready"])):W("",!0)]),_:1}),V(pe,{name:"content-fade"},{default:ne(()=>[X(e("div",Do,[e("header",Bo,[e("div",Ho,[e("div",Wo,[e("span",{class:U(["recorder-header__indicator",{"recorder-header__indicator--active":r.value}])},null,2),S[0]||(S[0]=e("span",{class:"recorder-header__label"},"Recorder",-1))]),r.value?(f(),h("span",No," REC ")):W("",!0),V(Nt)]),V(Mt)]),e("div",Fo,[e("div",Uo,[V(kn,{onAllVideosReady:B})]),e("aside",Vo,[V(Ao)])]),V(De,{ref_key:"leaveDialog",ref:k,title:"Recording in Progress",message:`You are currently recording (${u.value}). Leaving will stop the recording and save all files.`,"confirm-text":"Leave and Stop Recording","cancel-text":"Stay",danger:!0,onConfirm:re(c),onCancel:re(s)},null,8,["message","onConfirm","onCancel"])],512),[[Ze,!i.value]])]),_:1})],64))}}),zo=le(jo,[["__scopeId","data-v-a7fdeea3"]]);export{zo as default};
