import{B,C as W,o as G,l as X,D as Le,r as b,k as We,E as Be,G as De,j as w,H as Ne,d as D,I as ce,m as A,T as ue,p as de,J as He,c as y,e as C,a as t,w as Fe,y as Ue,t as _,x as je,i as h,_ as fe,K as Ie,h as N,F as V,n as k,q as Q,L as he,M as $,u as ye,f as Ve,s as be,g as Ge,N as Oe,b as qe}from"./index-tWw6F2ft.js";import{M as ze}from"./ModeLoadingScreen-Yqcj3GzO.js";const j=b(!1),z=b(!1);let I=null;function Ke(){const n=B();W(()=>n.status,a=>{j.value=a==="recording"},{immediate:!0});function e(a){if(j.value)return a.preventDefault(),a.returnValue="Recording in progress. Are you sure you want to leave?",a.returnValue}G(()=>{window.addEventListener("beforeunload",e)}),X(()=>{window.removeEventListener("beforeunload",e)}),Le((a,o,r)=>{j.value?(I=()=>r(),z.value=!0,r(!1)):r()});function s(){z.value=!1,j.value=!1,n.stopRecording().finally(()=>{I&&(I(),I=null)})}function m(){z.value=!1,I=null}return{isGuardActive:j,showLeaveConfirmation:z,confirmLeave:s,cancelLeave:m}}const le="https://r58-mediamtx.itagenten.no",Ye="100.98.37.53",Qe="192.168.1.24";let Y=null,we=0;const Xe=3e4;async function Je(n,e,s=3e3){const m=`${n}/${e}/whep`,a=performance.now();try{const o=new AbortController,r=setTimeout(()=>o.abort(),s),i=await fetch(m,{method:"OPTIONS",signal:o.signal,mode:"cors"});clearTimeout(r);const d=performance.now()-a;return{reachable:i.ok||i.status===405||i.status===204,latencyMs:d}}catch{return{reachable:!1,latencyMs:performance.now()-a}}}function Ze(){const n=[];return We()?(n.push({type:"lan",url:`http://${Qe}:8889`,priority:1}),n.push({type:"tailscale",url:`http://${Ye}:8889`,priority:2}),n.push({type:"frp",url:le,priority:3})):n.push({type:"frp",url:le,priority:1}),n}async function xe(n="cam0"){const e=performance.now(),s=Ze();console.log(`[Connection Racer] Racing ${s.length} paths for ${n}...`);const m=s.map(async d=>{const v=await Je(d.url,n);return d.latencyMs=v.latencyMs,d.working=v.reachable,v.reachable?console.log(`[Connection Racer] ✓ ${d.type} (${d.url}): ${Math.round(v.latencyMs)}ms`):console.log(`[Connection Racer] ✗ ${d.type} (${d.url}): failed`),{path:d,result:v}}),a=await Promise.all(m),o=performance.now()-e,i=a.filter(d=>d.result.reachable).map(d=>d.path).sort((d,v)=>d.priority!==v.priority?d.priority-v.priority:(d.latencyMs||9999)-(v.latencyMs||9999))[0]||null;return i?(console.log(`[Connection Racer] Winner: ${i.type} (${i.url}) in ${Math.round(o)}ms`),Y=i,we=Date.now()):console.warn("[Connection Racer] No working paths found!"),{bestPath:i,allPaths:s,raceTimeMs:o}}async function et(n){const e=Date.now();if(Y&&e-we<Xe)return console.log(`[Connection Racer] Using cached path: ${Y.type}`),`${Y.url}/${n}/whep`;const s=await xe(n);return s.bestPath?`${s.bestPath.url}/${n}/whep`:(console.warn("[Connection Racer] All paths failed, using FRP fallback"),`${le}/${n}/whep`)}const tt=["65.109.32.111"],nt=5,ot=1e3,st=3e4,L=new Map,U=new Map;async function rt(n){return et(n)}async function at(n,e){const s=L.get(e);if(!s)return"unknown";try{const o=new URL(s.whepUrl).hostname;if(o.includes("itagenten.no"))return console.log(`[WHEP Manager ${e}] Detected relay (FRP URL)`),"relay";if(o.startsWith("100."))return console.log(`[WHEP Manager ${e}] Detected P2P (Tailscale IP: ${o})`),"p2p";if(o.startsWith("192.168.")||o.startsWith("10.")||o.startsWith("172."))return console.log(`[WHEP Manager ${e}] Detected P2P (LAN IP: ${o})`),"p2p"}catch(a){console.warn(`[WHEP Manager ${e}] Failed to parse WHEP URL:`,a)}try{const a=await n.getStats();for(const o of a.values())if(o.type==="candidate-pair"&&o.state==="succeeded"){const r=a.get(o.remoteCandidateId);if((r==null?void 0:r.candidateType)==="relay")return console.log(`[WHEP Manager ${e}] Detected relay (TURN candidate)`),"relay";const i=r==null?void 0:r.address;if(i&&tt.includes(i))return console.log(`[WHEP Manager ${e}] Detected relay (VPS IP: ${i})`),"relay"}}catch(a){console.warn(`[WHEP Manager ${e}] Failed to get WebRTC stats:`,a)}return De()&&!Be()?(console.log(`[WHEP Manager ${e}] Assuming P2P (direct device URL configured)`),"p2p"):"unknown"}function H(n){const e=L.get(n);if(!e)return;const s=U.get(n);s&&s.forEach(m=>m(e))}function te(n){const e=L.get(n);if(!e)return;if(e.reconnectAttempts>=nt){console.error(`[WHEP Manager ${n}] Max reconnect attempts reached`),e.state="failed",H(n);return}e.reconnectAttempts++;const s=Math.min(ot*Math.pow(2,e.reconnectAttempts-1),st);console.log(`[WHEP Manager ${n}] Scheduling reconnect #${e.reconnectAttempts} in ${s}ms`),e.state="connecting",H(n),e.reconnectTimeout&&clearTimeout(e.reconnectTimeout),e.reconnectTimeout=setTimeout(()=>{J(n)},s)}async function J(n){let e=L.get(n);if(e&&(e.state==="connected"||e.state==="connecting"))return console.log(`[WHEP Manager ${n}] Reusing existing connection (state: ${e.state})`),e;const s=performance.now();console.log(`[WHEP Manager ${n}] Racing connections to find best path...`);const m=await rt(n),a=Math.round(performance.now()-s);console.log(`[WHEP Manager ${n}] Best URL found in ${a}ms: ${m}`),e!=null&&e.peerConnection&&e.peerConnection.close();const o=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}]});e?(e.peerConnection=o,e.state="connecting",e.whepUrl=m,e.mediaStream=null,e.connectionType="unknown",e.connectionStartTime=s):(e={cameraId:n,peerConnection:o,mediaStream:null,state:"connecting",connectionType:"unknown",refCount:0,whepUrl:m,lastConnectedAt:null,reconnectAttempts:(e==null?void 0:e.reconnectAttempts)||0,reconnectTimeout:null,connectionStartTime:s},L.set(n,e)),o.ontrack=r=>{r.streams[0]&&(e.mediaStream=r.streams[0],console.log(`[WHEP Manager ${n}] Received media stream`),H(n))},o.oniceconnectionstatechange=async()=>{const r=o.iceConnectionState;if(console.log(`[WHEP Manager ${n}] ICE state: ${r}`),r==="connected"||r==="completed"){e.state="connected",e.lastConnectedAt=Date.now(),e.reconnectAttempts=0,e.connectionType=await at(o,n);const i=e.connectionStartTime?Math.round(performance.now()-e.connectionStartTime):0;console.log(`[WHEP Manager ${n}] Connected (${e.connectionType}) in ${i}ms`),H(n)}else r==="failed"?(e.state="failed",e.connectionType="unknown",H(n),e.refCount>0&&te(n)):r==="disconnected"&&setTimeout(()=>{(o.iceConnectionState==="disconnected"||o.iceConnectionState==="failed")&&(e.state="disconnected",H(n),e.refCount>0&&te(n))},3e3)},o.addTransceiver("video",{direction:"recvonly"}),o.addTransceiver("audio",{direction:"recvonly"});try{const r=await o.createOffer();await o.setLocalDescription(r);const i=await fetch(m,{method:"POST",headers:{"Content-Type":"application/sdp"},body:r.sdp});if(!i.ok)throw new Error(`WHEP request failed: ${i.status}`);const d=await i.text();await o.setRemoteDescription({type:"answer",sdp:d})}catch(r){console.error(`[WHEP Manager ${n}] Connection error:`,r),e.state="failed",H(n),e.refCount>0&&te(n)}return e}async function it(n,e){U.has(n)||U.set(n,new Set),U.get(n).add(e);let s=L.get(n);return(!s||s.state==="failed"||s.state==="disconnected")&&(s=await J(n)),s.refCount++,console.log(`[WHEP Manager ${n}] Acquired connection (refCount: ${s.refCount})`),e(s),s}function lt(n,e){const s=L.get(n);if(!s)return;const m=U.get(n);m&&(m.delete(e),m.size===0&&U.delete(n)),s.refCount=Math.max(0,s.refCount-1),console.log(`[WHEP Manager ${n}] Released connection (refCount: ${s.refCount})`),s.refCount===0&&(console.log(`[WHEP Manager ${n}] Closing unused connection`),s.reconnectTimeout&&clearTimeout(s.reconnectTimeout),s.peerConnection.close(),L.delete(n))}function ne(n){const e=L.get(n);e&&(console.log(`[WHEP Manager ${n}] Force reconnecting...`),e.reconnectAttempts=0,J(n))}async function ct(n){var m;console.log(`[WHEP Manager] Preloading ${n.length} connections: ${n.join(", ")}`);const e=performance.now();if(n.length>0){console.log("[WHEP Manager] Step 1: Racing to find best connection path...");const a=await xe(n[0]);console.log(`[WHEP Manager] Race complete: ${((m=a.bestPath)==null?void 0:m.type)||"none"} won in ${Math.round(a.raceTimeMs)}ms`)}console.log(`[WHEP Manager] Step 2: Creating ${n.length} connections...`);const s=n.map(async a=>{try{await J(a);const o=L.get(a);if(!o)return;for(let r=0;r<30;r++){if(o.mediaStream&&o.mediaStream.getVideoTracks().length>0&&o.mediaStream.getVideoTracks()[0].readyState==="live"){console.log(`[WHEP Manager ${a}] Stream ready after ${Math.round(performance.now()-e)}ms`);return}await new Promise(i=>setTimeout(i,100))}console.log(`[WHEP Manager ${a}] Stream timeout (3s) - continuing anyway`)}catch(o){console.warn(`[WHEP Manager ${a}] Preload failed:`,o)}});await Promise.all(s),console.log(`[WHEP Manager] All preloads complete in ${Math.round(performance.now()-e)}ms`)}const R=b(null),oe=b(!1),me=b(null),se=b(null),ut=10,re=2,dt=25;function ft(){const n=w(()=>R.value?R.value.available_gb<re?"critical":R.value.available_gb<ut?"warning":"ok":"unknown"),e=w(()=>R.value?R.value.available_gb>=re:!0),s=w(()=>{if(!R.value)return null;const i=R.value.available_gb*1024*1024*1024,d=dt*1024*1024,v=i/d,l=Math.floor(v/3600),c=Math.floor(v%3600/60);return l>24?`${Math.floor(l/24)}d ${l%24}h`:l>0?`${l}h ${c}m`:`${c}m`}),m=w(()=>{switch(n.value){case"ok":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}}),a=w(()=>R.value?n.value==="critical"?`Disk space critically low (${R.value.available_gb.toFixed(1)} GB). Cannot start recording.`:n.value==="warning"?`Low disk space (${R.value.available_gb.toFixed(1)} GB). Estimated recording time: ${s.value}`:null:null);async function o(){oe.value=!0,se.value=null;try{const i=await Ne.getDegradation();if(i.resources&&i.resources.disk_free_gb!==void 0){const d=i.resources.disk_free_gb,v=d*3;R.value={available_gb:d,total_gb:v,used_percent:100-d/v*100,recording_path:"/opt/r58-app/shared/recordings"}}return me.value=new Date,R.value}catch(i){return se.value=i.message||"Failed to check disk space",console.error("Failed to check disk space:",i),null}finally{oe.value=!1}}async function r(){return await o(),R.value?n.value==="critical"?{ok:!1,message:`Insufficient disk space (${R.value.available_gb.toFixed(1)} GB). Need at least ${re} GB to start recording.`}:n.value==="warning"?{ok:!0,message:`Low disk space warning: ${R.value.available_gb.toFixed(1)} GB available. Estimated recording time: ${s.value}`}:{ok:!0}:{ok:!0,message:"Could not verify disk space. Proceeding with caution."}}return{diskSpace:R,isLoading:oe,lastCheck:me,error:se,status:n,statusColor:m,canStartRecording:e,estimatedRecordingTime:s,warningMessage:a,checkDiskSpace:o,preflightCheck:r}}const E=b(localStorage.getItem("r58_audio_feedback")!=="false");let ae=null;function pt(){return ae||(ae=new(window.AudioContext||window.webkitAudioContext)),ae}function P(n,e,s="sine",m=.3){if(E.value)try{const a=pt();a.state==="suspended"&&a.resume();const o=a.createOscillator(),r=a.createGain();o.connect(r),r.connect(a.destination),o.type=s,o.frequency.value=n;const i=a.currentTime;r.gain.setValueAtTime(0,i),r.gain.linearRampToValueAtTime(m,i+.01),r.gain.linearRampToValueAtTime(0,i+e),o.start(i),o.stop(i+e)}catch(a){console.warn("Audio feedback failed:",a)}}function gt(){E.value&&(P(440,.1,"sine",.2),setTimeout(()=>P(554,.1,"sine",.2),100),setTimeout(()=>P(659,.15,"sine",.25),200))}function mt(){E.value&&(P(880,.08,"sine",.3),setTimeout(()=>P(880,.15,"sine",.3),120))}function vt(){E.value&&(P(659,.1,"sine",.25),setTimeout(()=>P(554,.1,"sine",.2),100),setTimeout(()=>P(440,.15,"sine",.2),200))}function ht(){E.value&&(P(200,.15,"square",.15),setTimeout(()=>P(180,.2,"square",.15),180))}function yt(){E.value&&(P(1e3,.08,"sine",.2),setTimeout(()=>P(1e3,.08,"sine",.2),150))}function ve(){E.value&&P(1200,.03,"sine",.1)}function bt(n=50){if(E.value&&"vibrate"in navigator)try{navigator.vibrate(n)}catch{}}function _e(){function n(s){E.value=s,localStorage.setItem("r58_audio_feedback",String(s))}function e(){n(!E.value),E.value&&ve()}return{enabled:E,setEnabled:n,toggle:e,playSuccess:gt,playError:ht,playWarning:yt,playClick:ve,playRecordStart:mt,playRecordStop:vt,vibrate:bt}}const wt={class:"bg-r58-bg-secondary rounded-lg shadow-xl max-w-md w-full p-6"},xt=["placeholder"],_t={class:"text-xs text-r58-text-secondary mt-2"},kt=D({__name:"SessionNameDialog",props:{open:{type:Boolean},suggestedName:{}},emits:["confirm","cancel","skip"],setup(n,{emit:e}){const s=n,m=e,a=b(""),o=b(null),r=w(()=>{const p=new Date,u=p.toLocaleDateString("en-CA"),g=p.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}).replace(":","");return`Recording_${u}_${g}`}),i=w(()=>s.suggestedName||r.value);W(()=>s.open,p=>{p&&(a.value=i.value,setTimeout(()=>{var u,g;(u=o.value)==null||u.focus(),(g=o.value)==null||g.select()},100))});function d(){m("confirm",a.value.trim()||i.value)}function v(){m("skip")}function l(){m("cancel")}function c(p){p.key==="Enter"?d():p.key==="Escape"&&l()}return(p,u)=>(h(),ce(He,{to:"body"},[A(ue,{name:"fade"},{default:de(()=>[n.open?(h(),y("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:je(l,["self"]),onKeydown:c},[t("div",wt,[u[1]||(u[1]=t("h2",{class:"text-lg font-semibold mb-2"},"Name This Recording",-1)),u[2]||(u[2]=t("p",{class:"text-r58-text-secondary text-sm mb-4"}," Give your recording a name to find it easily later (optional). ",-1)),Fe(t("input",{ref_key:"inputRef",ref:o,"onUpdate:modelValue":u[0]||(u[0]=g=>a.value=g),type:"text",placeholder:i.value,class:"w-full px-4 py-2 bg-r58-bg-tertiary border border-r58-bg-tertiary rounded-lg text-r58-text-primary placeholder-r58-text-secondary focus:outline-none focus:ring-2 focus:ring-r58-accent-primary"},null,8,xt),[[Ue,a.value]]),t("p",_t," Suggested: "+_(i.value),1),t("div",{class:"flex justify-between mt-6"},[t("button",{onClick:v,class:"text-sm text-r58-text-secondary hover:text-r58-text-primary transition-colors"}," Skip (use default) "),t("div",{class:"flex gap-3"},[t("button",{onClick:l,class:"btn"}," Cancel "),t("button",{onClick:d,class:"btn btn-primary"}," Start Recording ")])])])],32)):C("",!0)]),_:1})]))}}),$t=fe(kt,[["__scopeId","data-v-df8c0a50"]]),St={class:"flex items-center gap-4"},Ct={key:0,class:"font-mono text-xl text-r58-accent-danger"},Rt=["disabled","title"],Tt={key:0,class:"animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"},Mt={key:0,class:"w-3 h-3 bg-white rounded-sm"},Pt={key:1,class:"w-3 h-3 bg-white rounded-full"},Et={class:"text-xs text-r58-text-secondary hidden md:inline"},At=D({__name:"RecorderControls",setup(n){const e=B(),{register:s}=Ie(),{preflightCheck:m,status:a,canStartRecording:o}=ft(),{playRecordStart:r,playRecordStop:i,playError:d,playWarning:v,vibrate:l}=_e(),c=b(null),p=b(!1),u=b(!1),g=b(!1),f=b(!1),x=b(void 0),S=w(()=>e.status==="recording"),F=w(()=>e.status==="starting"),O=w(()=>e.status==="stopping"),Z=w(()=>e.formattedDuration),$e=w(()=>F.value||O.value||u.value),Se=w(()=>F.value?"Starting recording...":O.value?"Stopping recording...":u.value?"Checking disk space...":!S.value&&!o.value?"Insufficient disk space":"");let ee=null;G(()=>{ee=s({key:" ",description:"Toggle Recording",action:Ce,context:"recorder",enabled:()=>!F.value&&!O.value})}),X(()=>{ee&&ee()});async function Ce(){S.value?ge():await q()}async function q(T){u.value=!0;try{const M=await m();if(!M.ok){d(),l(200),N.error("Cannot start recording",M.message||"Preflight check failed");return}if(M.message&&a.value==="warning"&&(v(),N.warning("Low disk space",M.message)),f.value&&!T){x.value=void 0,g.value=!0;return}await pe(T||x.value)}finally{u.value=!1}}async function pe(T){try{await e.startRecording(T);const M=T||e.sessionId;r(),l([50,30,50]),N.success("Recording started",`Session: ${M}`)}catch(M){d(),l(200),N.error("Failed to start recording",M.message||"Unknown error",{label:"Retry",onClick:()=>q(T)})}}function Re(T){g.value=!1,x.value=T,q(T)}function Te(){g.value=!1,x.value=void 0,q()}function Me(){g.value=!1,u.value=!1}async function Pe(){try{await e.stopRecording(),i(),l(100),N.success("Recording stopped",`Duration: ${Z.value}`)}catch(T){d(),l(200),N.error("Failed to stop recording",T.message||"Unknown error")}}function ge(){var T;p.value=!1,(T=c.value)==null||T.open(),setTimeout(()=>{p.value=!0},500)}function Ee(){p.value&&Pe()}async function Ae(){S.value?ge():await pe()}return(T,M)=>(h(),y(V,null,[t("div",St,[S.value?(h(),y("div",Ct,_(Z.value),1)):C("",!0),t("button",{onClick:Ae,disabled:$e.value,class:k(["flex items-center gap-2 px-6 py-2 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed",[S.value?"bg-r58-accent-danger hover:bg-red-600 text-white":"bg-r58-accent-success hover:bg-green-600 text-white"]]),title:Se.value||(S.value?"Stop Recording (Space)":"Start Recording (Space)")},[F.value||O.value||u.value?(h(),y("span",Tt)):(h(),y(V,{key:1},[S.value?(h(),y("span",Mt)):(h(),y("span",Pt))],64)),t("span",null,_(u.value?"Checking...":S.value?"Stop":"Start Recording"),1)],10,Rt),t("span",Et,[M[0]||(M[0]=Q(" Press ",-1)),M[1]||(M[1]=t("kbd",{class:"px-1 py-0.5 bg-r58-bg-tertiary rounded text-xs font-mono"},"Space",-1)),Q(" to "+_(S.value?"stop":"start"),1)])]),A(he,{ref_key:"stopConfirmDialog",ref:c,title:"Stop Recording?",message:`You have been recording for ${Z.value}. This will finalize all files.`,"confirm-text":"Stop Recording","cancel-text":"Keep Recording",danger:!0,onConfirm:Ee},null,8,["message"]),A($t,{open:g.value,onConfirm:Re,onSkip:Te,onCancel:Me},null,8,["open"])],64))}}),K=b(localStorage.getItem("r58_performance_mode")==="true"),ie=b(localStorage.getItem("r58_performance_mode_auto")!=="false"),Lt=3,Wt=100,Bt=500;function ke(){const n=B(),e=w(()=>K.value?!0:ie.value&&n.isRecording?n.inputs.filter(c=>c.isRecording).length>=Lt:!1),s=w(()=>e.value?Bt:Wt);W(e,l=>{l?document.body.classList.add("performance-mode"):document.body.classList.remove("performance-mode")},{immediate:!0});function m(l){K.value=l,localStorage.setItem("r58_performance_mode",String(l))}function a(l){ie.value=l,localStorage.setItem("r58_performance_mode_auto",String(l))}function o(){m(!K.value)}function r(l,c){let p=0,u=null;return(...g)=>{const f=Date.now(),x=c??s.value,S=f-p;S>=x?(p=f,l(...g)):u||(u=window.setTimeout(()=>{p=Date.now(),u=null,l(...g)},x-S))}}function i(l,c){let p=null;return(...u)=>{p&&clearTimeout(p),p=window.setTimeout(()=>{l(...u),p=null},c??s.value)}}function d(l){return e.value?window.setTimeout(()=>l(performance.now()),s.value):requestAnimationFrame(l)}function v(l){e.value?clearTimeout(l):cancelAnimationFrame(l)}return{enabled:K,autoEnable:ie,isActive:e,updateInterval:s,setEnabled:m,setAutoEnable:a,toggle:o,throttle:r,debounce:i,requestFrame:d,cancelFrame:v}}const Dt=["title"],Nt={class:"flex items-center gap-1.5 text-sm"},Ht={key:0,class:"flex items-center gap-1.5 text-sm"},Ft={key:1,class:"flex items-center gap-1.5 text-sm text-red-400"},Ut={class:"font-mono"},jt=D({__name:"RecordingHealth",setup(n,{expose:e}){const s=B(),{isActive:m}=ke(),a=b({}),o=b(0),r=b(0),i=b(0);let d=null;function v(){const g={};let f=0;s.inputs.forEach(S=>{g[S.id]=S.bytesWritten;const F=a.value[S.id]||0;f+=S.bytesWritten-F});const x=m.value?2:1;o.value=Math.round(f/(1024*1024)/x*10)/10,a.value=g}W(()=>s.isRecording,g=>{if(g){a.value={},o.value=0,r.value=0,i.value=0;const f=m.value?2e3:1e3;d=window.setInterval(v,f)}else d&&(clearInterval(d),d=null)},{immediate:!0}),W(m,g=>{if(s.isRecording&&d){clearInterval(d);const f=g?2e3:1e3;d=window.setInterval(v,f)}}),X(()=>{d&&clearInterval(d)});const l=w(()=>s.isRecording?i.value>0||r.value>90?"critical":o.value<1||r.value>70?"warning":"healthy":"idle"),c=w(()=>{switch(l.value){case"healthy":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}});w(()=>{switch(l.value){case"healthy":return"Healthy";case"warning":return"Warning";case"critical":return"Critical";default:return"Idle"}});const p=w(()=>{if(!s.isRecording)return"Not recording";const g=[`Write speed: ${o.value} MB/s`,`Buffer: ${r.value}%`];return i.value>0&&g.push(`Frames dropped: ${i.value}`),g.join(`
`)});function u(g){g.buffer_percent!==void 0&&(r.value=g.buffer_percent),g.frames_dropped!==void 0&&(i.value=g.frames_dropped)}return e({updateFromMetrics:u}),(g,f)=>$(s).isRecording?(h(),y("div",{key:0,class:k(["flex items-center gap-3 px-3 py-1.5 rounded-lg transition-colors cursor-help",{"bg-emerald-500/10":c.value==="emerald","bg-amber-500/10":c.value==="amber","bg-red-500/10":c.value==="red"}]),title:p.value},[t("span",{class:k(["w-2 h-2 rounded-full",c.value==="emerald"?"bg-emerald-500":"",c.value==="amber"?"bg-amber-500 animate-pulse":"",c.value==="red"?"bg-red-500 animate-pulse":""])},null,2),t("div",Nt,[f[0]||(f[0]=t("svg",{class:"w-3.5 h-3.5 text-r58-text-secondary",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})],-1)),t("span",{class:k(["font-mono",c.value==="emerald"?"text-emerald-400":"",c.value==="amber"?"text-amber-400":"",c.value==="red"?"text-red-400":""])},_(o.value)+" MB/s ",3)]),r.value>0?(h(),y("div",Ht,[f[1]||(f[1]=t("span",{class:"text-r58-text-secondary"},"Buf:",-1)),t("span",{class:k(["font-mono",r.value<50?"text-emerald-400":"",r.value>=50&&r.value<80?"text-amber-400":"",r.value>=80?"text-red-400":""])},_(r.value)+"% ",3)])):C("",!0),i.value>0?(h(),y("div",Ft,[f[2]||(f[2]=t("svg",{class:"w-3.5 h-3.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),t("span",Ut,_(i.value)+" dropped",1)])):C("",!0)],10,Dt)):C("",!0)}}),It={class:"relative w-full h-full bg-black"},Vt=["title"],Gt={key:1,class:"absolute inset-0 flex items-center justify-center bg-black/50"},Ot={key:2,class:"absolute inset-0 flex items-center justify-center bg-black/70"},qt={class:"text-center"},zt={class:"text-xs text-amber-400"},Kt={key:3,class:"absolute inset-0 flex items-center justify-center bg-black/80"},Yt={class:"text-center text-r58-text-secondary"},Qt={class:"text-sm"},Xt=D({__name:"InputPreview",props:{inputId:{},protocol:{}},setup(n){const e=n,s=B(),m=w(()=>s.status==="recording"),a=b(null),o=b(!0),r=b(null),i=b("unknown"),d=b(!1),v=b(0);let l=null;function c(f){switch(console.log(`[InputPreview ${e.inputId}] Connection update:`,{state:f.state,type:f.connectionType,hasStream:!!f.mediaStream}),i.value=f.connectionType,v.value=f.reconnectAttempts,f.state){case"connecting":o.value=!0,r.value=null,d.value=f.reconnectAttempts>0;break;case"connected":o.value=!1,r.value=null,d.value=!1,f.mediaStream&&a.value&&a.value.srcObject!==f.mediaStream&&(a.value.srcObject=f.mediaStream);break;case"disconnected":d.value=!0,r.value=`Reconnecting... (${f.reconnectAttempts}/5)`;break;case"failed":o.value=!1,d.value=!1,r.value="Connection failed after multiple attempts";break}}async function p(){if(a.value){g(),o.value=!0,r.value=null,l=c;try{await it(e.inputId,l)}catch(f){console.error(`[InputPreview ${e.inputId}] Failed to acquire connection:`,f),r.value=f instanceof Error?f.message:"Failed to connect",o.value=!1}}}function u(){ne(e.inputId)}function g(){l&&(lt(e.inputId,l),l=null)}return G(()=>{p()}),W(()=>e.inputId,()=>{p()}),W(m,(f,x)=>{x&&!f&&r.value?(console.log("[InputPreview] Recording stopped, reconnecting preview..."),ne(e.inputId)):!x&&f&&(console.log("[InputPreview] Recording started, will try to reconnect preview after delay..."),setTimeout(()=>{m.value&&(console.log("[InputPreview] Attempting to reconnect preview during recording..."),ne(e.inputId))},2e3))}),X(()=>{g()}),(f,x)=>(h(),y("div",It,[t("video",{ref_key:"videoRef",ref:a,autoplay:"",muted:"",playsinline:"",class:"w-full h-full object-contain"},null,512),!o.value&&!r.value&&i.value!=="unknown"?(h(),y("div",{key:0,class:k(["absolute top-1 right-1 px-1.5 py-0.5 text-[10px] font-medium rounded",i.value==="p2p"?"bg-emerald-500/80 text-white":"bg-amber-500/80 text-white"]),title:i.value==="p2p"?"Direct P2P connection":"Relay connection (FRP)"},_(i.value==="p2p"?"P2P":"RELAY"),11,Vt)):C("",!0),o.value&&!d.value?(h(),y("div",Gt,[...x[0]||(x[0]=[t("div",{class:"animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"},null,-1)])])):C("",!0),d.value?(h(),y("div",Ot,[t("div",qt,[x[1]||(x[1]=t("div",{class:"animate-spin w-5 h-5 border-2 border-amber-400 border-t-transparent rounded-full mx-auto mb-2"},null,-1)),t("p",zt,_(r.value||"Reconnecting..."),1)])])):r.value&&!o.value?(h(),y("div",Kt,[t("div",Yt,[t("p",Qt,_(r.value),1),t("button",{onClick:u,class:"mt-2 text-xs text-r58-accent-primary hover:underline"}," Retry ")])])):C("",!0)]))}}),Jt={key:0,class:"h-full flex items-center justify-center"},Zt={key:1,class:"h-full flex flex-col gap-2"},en={key:0,class:"flex items-center gap-2 px-3 py-1.5 bg-amber-500/10 border border-amber-500/30 rounded-lg text-amber-400 text-sm"},tn=["title"],nn={key:1,class:"w-full h-full flex items-center justify-center bg-r58-bg-tertiary"},on={class:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-4"},sn={class:"flex items-center justify-between"},rn={class:"flex items-center gap-2"},an={class:"font-medium"},ln={key:0,class:"flex items-center gap-2 text-sm"},cn={class:"text-r58-text-secondary"},un={key:0,class:"mt-2 flex items-center justify-between"},dn={class:"text-sm font-mono text-r58-text-secondary"},fn=D({__name:"InputGrid",setup(n){const e=B(),s=ye(),m=w(()=>{var c;return((c=s.capabilities)==null?void 0:c.current_mode)==="recorder"}),a=w(()=>e.inputs.filter(c=>c.hasSignal)),o=w(()=>e.framerateMismatch);function r(c){return c.isRecording?"border-r58-accent-danger ring-2 ring-r58-accent-danger/20":c.hasSignal?"border-emerald-500/50 hover:border-emerald-500":"border-r58-bg-tertiary/50 opacity-60"}function i(c){return c.hasSignal?c.framerate>=29?"excellent":c.framerate>=24?"good":"unstable":"none"}function d(c){switch(i(c)){case"excellent":return"text-emerald-400";case"good":return"text-emerald-400";case"unstable":return"text-amber-400";case"none":return"text-r58-text-secondary"}}function v(c){if(c===0)return"0 B";const p=1024,u=["B","KB","MB","GB"],g=Math.floor(Math.log(c)/Math.log(p));return parseFloat((c/Math.pow(p,g)).toFixed(1))+" "+u[g]}function l(c){if(!c.hasSignal)return`${c.label}: No signal detected`;const p=[`${c.label}`,`Resolution: ${c.resolution}`,`Framerate: ${c.framerate} fps`,`Quality: ${i(c)}`];return c.isRecording&&p.push(`Written: ${v(c.bytesWritten)}`),p.join(`
`)}return(c,p)=>a.value.length===0?(h(),y("div",Jt,[...p[0]||(p[0]=[Ve('<div class="text-center text-r58-text-secondary"><svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg><p class="text-lg font-medium">No Video Sources Connected</p><p class="text-sm mt-2">Connect HDMI cables to begin recording</p></div>',1)])])):(h(),y("div",Zt,[o.value?(h(),y("div",en,[p[1]||(p[1]=t("svg",{class:"w-4 h-4 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20"},[t("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),t("span",null,_(o.value),1)])):C("",!0),t("div",{class:k(["flex-1 grid gap-4",a.value.length===1?"grid-cols-1":"grid-cols-2"])},[(h(!0),y(V,null,be(a.value,u=>(h(),y("div",{key:u.id,class:k(["relative rounded-lg overflow-hidden border-2 transition-all cursor-pointer aspect-video bg-black",r(u)]),title:l(u)},[m.value?(h(),ce(Xt,{key:0,"input-id":u.id,class:"w-full h-full"},null,8,["input-id"])):(h(),y("div",nn,[...p[2]||(p[2]=[t("div",{class:"text-center"},[t("svg",{class:"w-8 h-8 mx-auto mb-2 text-r58-text-secondary/50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})]),t("span",{class:"text-xs text-r58-text-secondary/70"},"Mixer mode")],-1)])])),t("div",on,[t("div",sn,[t("div",rn,[t("span",{class:k(["w-2 h-2 rounded-full transition-colors",{"bg-emerald-500":i(u)==="excellent"||i(u)==="good","bg-amber-500 animate-pulse":i(u)==="unstable","bg-r58-text-secondary":i(u)==="none"}])},null,2),t("span",an,_(u.label),1)]),u.hasSignal?(h(),y("div",ln,[t("span",cn,_(u.resolution),1),t("span",{class:k(d(u))},_(u.framerate)+"fps",3)])):C("",!0)]),u.isRecording?(h(),y("div",un,[p[3]||(p[3]=t("div",{class:"flex items-center gap-2 text-r58-accent-danger"},[t("span",{class:"w-2 h-2 rounded-full bg-r58-accent-danger animate-recording"}),t("span",{class:"text-sm font-medium"},"REC")],-1)),t("span",dn,_(v(u.bytesWritten)),1)])):C("",!0)])],10,tn))),128))],2)]))}}),pn={class:"space-y-4"},gn={class:"flex items-center justify-between py-2 cursor-pointer"},mn=["aria-checked"],vn={class:"flex items-center justify-between py-2 cursor-pointer"},hn=["aria-checked"],yn={class:"flex items-center justify-between py-2 cursor-pointer"},bn={class:"text-xs text-r58-text-secondary"},wn={key:0,class:"text-amber-400"},xn=["aria-checked"],_n={class:"flex items-center justify-between py-2 pl-4 cursor-pointer opacity-80"},kn=["aria-checked"],$n=D({__name:"SettingsPanel",setup(n){const{enabled:e,toggle:s,playClick:m}=_e(),{enabled:a,autoEnable:o,isActive:r,setEnabled:i,setAutoEnable:d}=ke(),v=b(!1);function l(){v.value=!v.value,v.value?(document.body.classList.add("touch-mode"),localStorage.setItem("r58_touch_mode","true")):(document.body.classList.remove("touch-mode"),localStorage.setItem("r58_touch_mode","false"))}G(()=>{const p=localStorage.getItem("r58_touch_mode")==="true";v.value=p,p&&document.body.classList.add("touch-mode")});function c(){s(),e.value&&m()}return(p,u)=>(h(),y("div",pn,[u[7]||(u[7]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide"}," Interface Settings ",-1)),t("label",gn,[u[2]||(u[2]=t("div",null,[t("span",{class:"text-r58-text-primary"},"Audio Feedback"),t("p",{class:"text-xs text-r58-text-secondary"},"Play sounds for recording start/stop")],-1)),t("button",{onClick:c,class:k(["relative w-12 h-7 rounded-full transition-colors",$(e)?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":$(e)},[t("span",{class:k(["absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform",$(e)?"translate-x-6":"translate-x-1"])},null,2)],10,mn)]),t("label",vn,[u[3]||(u[3]=t("div",null,[t("span",{class:"text-r58-text-primary"},"Touch Mode"),t("p",{class:"text-xs text-r58-text-secondary"},"Larger buttons for touchscreen")],-1)),t("button",{onClick:l,class:k(["relative w-12 h-7 rounded-full transition-colors",v.value?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":v.value},[t("span",{class:k(["absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform",v.value?"translate-x-6":"translate-x-1"])},null,2)],10,hn)]),t("label",yn,[t("div",null,[u[5]||(u[5]=t("span",{class:"text-r58-text-primary"},"Performance Mode",-1)),t("p",bn,[u[4]||(u[4]=Q(" Reduce UI updates during recording ",-1)),$(r)&&!$(a)?(h(),y("span",wn,"(auto-enabled)")):C("",!0)])]),t("button",{onClick:u[0]||(u[0]=g=>$(i)(!$(a))),class:k(["relative w-12 h-7 rounded-full transition-colors",$(a)?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":$(a)},[t("span",{class:k(["absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform",$(a)?"translate-x-6":"translate-x-1"])},null,2)],10,xn)]),t("label",_n,[u[6]||(u[6]=t("div",null,[t("span",{class:"text-sm text-r58-text-primary"},"Auto-enable when recording 3+ inputs")],-1)),t("button",{onClick:u[1]||(u[1]=g=>$(d)(!$(o))),class:k(["relative w-10 h-6 rounded-full transition-colors",$(o)?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":$(o)},[t("span",{class:k(["absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform",$(o)?"translate-x-4":"translate-x-0.5"])},null,2)],10,kn)])]))}}),Sn={class:"space-y-6"},Cn={key:0,class:"card"},Rn={class:"space-y-2"},Tn={class:"flex justify-between"},Mn={class:"flex justify-between"},Pn={class:"font-mono"},En={class:"flex justify-between"},An={class:"card"},Ln={class:"space-y-3"},Wn={class:"flex items-center gap-2"},Bn={key:0,class:"text-sm text-r58-text-secondary"},Dn={key:0,class:"text-r58-accent-danger"},Nn={key:1},Hn={key:1,class:"text-sm text-r58-text-secondary"},Fn={class:"card"},Un={class:"space-y-2"},jn=["disabled","title"],In={key:0,class:"absolute -top-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-r58-bg-tertiary text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none"},Vn={key:0,class:"card"},Gn=D({__name:"SessionInfo",setup(n){const e=Ge(),s=B(),m=w(()=>s.currentSession),a=w(()=>s.activeInputs),o=w(()=>s.isRecording),r=b(!1);function i(v){if(v===0)return"0 B";const l=1024,c=["B","KB","MB","GB","TB"],p=Math.floor(Math.log(v)/Math.log(l));return parseFloat((v/Math.pow(l,p)).toFixed(2))+" "+c[p]}function d(){e.push({name:"admin",query:{tab:"settings"}})}return(v,l)=>(h(),y("div",Sn,[m.value?(h(),y("div",Cn,[l[4]||(l[4]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide mb-3"},"Current Session",-1)),t("div",Rn,[t("div",Tn,[l[1]||(l[1]=t("span",{class:"text-r58-text-secondary"},"Started",-1)),t("span",null,_(m.value.startedAt.toLocaleTimeString()),1)]),t("div",Mn,[l[2]||(l[2]=t("span",{class:"text-r58-text-secondary"},"Duration",-1)),t("span",Pn,_($(s).formattedDuration),1)]),t("div",En,[l[3]||(l[3]=t("span",{class:"text-r58-text-secondary"},"Inputs",-1)),t("span",null,_(a.value.length)+" active",1)])])])):C("",!0),t("div",An,[l[5]||(l[5]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide mb-3"},"Input Status",-1)),t("div",Ln,[(h(!0),y(V,null,be($(s).inputs,c=>(h(),y("div",{key:c.id,class:"flex items-center justify-between py-2 border-b border-r58-bg-tertiary last:border-0"},[t("div",Wn,[t("span",{class:k(["w-2 h-2 rounded-full",c.hasSignal?"bg-r58-accent-success":"bg-r58-text-secondary"])},null,2),t("span",{class:k(c.hasSignal?"":"text-r58-text-secondary")},_(c.label),3)]),c.hasSignal?(h(),y("div",Bn,[c.isRecording?(h(),y("span",Dn,_(i(c.bytesWritten)),1)):(h(),y("span",Nn,_(c.resolution),1))])):(h(),y("span",Hn,"No signal"))]))),128))])]),t("div",Fn,[l[7]||(l[7]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide mb-3"},"Quick Actions",-1)),t("div",Un,[t("button",{onClick:d,class:"btn w-full justify-center disabled:opacity-50 disabled:cursor-not-allowed group relative",disabled:o.value,title:o.value?"Cannot configure while recording":"Open input configuration"},[l[6]||(l[6]=Q(" Configure Inputs ",-1)),o.value?(h(),y("span",In," Stop recording first ")):C("",!0)],8,jn),t("button",{onClick:l[0]||(l[0]=c=>r.value=!r.value),class:"btn w-full justify-center"},_(r.value?"Hide Settings":"Interface Settings"),1)])]),A(ue,{name:"slide-fade"},{default:de(()=>[r.value?(h(),y("div",Vn,[A($n)])):C("",!0)]),_:1})]))}}),On=fe(Gn,[["__scopeId","data-v-8910ebdc"]]),qn={class:"h-full flex flex-col"},zn={class:"flex items-center justify-between px-6 py-4 border-b border-r58-bg-tertiary bg-r58-bg-secondary"},Kn={class:"flex items-center gap-4"},Yn={class:"flex items-center gap-2"},Qn={key:0,class:"badge badge-danger"},Xn={class:"flex-1 flex overflow-hidden"},Jn={class:"flex-1 p-4"},Zn={class:"w-80 border-l border-r58-bg-tertiary bg-r58-bg-secondary p-4 overflow-y-auto"},eo=D({__name:"RecorderView",setup(n){const e=B(),s=ye(),{showLeaveConfirmation:m,confirmLeave:a,cancelLeave:o}=Ke(),r=w(()=>e.status==="recording"),i=w(()=>e.formattedDuration),d=b(!0),v=b(!1);function l(){d.value=!1}async function c(){var f;if(!Oe())return;await s.fetchCapabilities();const g=(f=s.capabilities)==null?void 0:f.current_mode;if(g&&g!=="recorder"){console.log("[Recorder] Not in recorder mode, switching...");try{(await fetch(qe("/api/mode/recorder"),{method:"POST"})).ok&&(await s.fetchCapabilities(),N.success("Switched to Recorder mode"))}catch(x){console.warn("[Recorder] Failed to switch mode:",x)}}}async function p(){const g=e.inputs.filter(f=>f.hasSignal).map(f=>f.id);if(g.length===0){console.log("[Recorder] No cameras with signal to preload");return}console.log(`[Recorder] Preloading ${g.length} video streams...`),await ct(g)}G(async()=>{const g=performance.now();await Promise.all([c(),e.fetchInputs(),e.fetchStatus()]),console.log(`[Recorder] Loaded ${e.inputs.length} inputs, ${e.inputs.filter(f=>f.hasSignal).length} with signal`),await p(),console.log(`[Recorder] Total load time: ${Math.round(performance.now()-g)}ms`),v.value=!0});const u=b(null);return W(m,g=>{var f,x;g?(f=u.value)==null||f.open():(x=u.value)==null||x.close()}),(g,f)=>(h(),y(V,null,[A(ue,{name:"fade"},{default:de(()=>[d.value?(h(),ce(ze,{key:0,mode:"recorder","content-ready":v.value,"min-time":1500,"max-time":5e3,onReady:l},null,8,["content-ready"])):C("",!0)]),_:1}),t("div",qn,[t("header",zn,[t("div",Kn,[t("div",Yn,[t("span",{class:k(["w-3 h-3 rounded-full",r.value?"bg-r58-accent-danger animate-recording":"bg-r58-bg-tertiary"])},null,2),f[0]||(f[0]=t("span",{class:"text-xl font-semibold"},"Recorder",-1))]),r.value?(h(),y("span",Qn,"RECORDING")):C("",!0),A(jt)]),A(At)]),t("div",Xn,[t("div",Jn,[A(fn)]),t("aside",Zn,[A(On)])]),A(he,{ref_key:"leaveDialog",ref:u,title:"Recording in Progress",message:`You are currently recording (${i.value}). Leaving will stop the recording and save all files.`,"confirm-text":"Leave and Stop Recording","cancel-text":"Stay",danger:!0,onConfirm:$(a),onCancel:$(o)},null,8,["message","onConfirm","onCancel"])])],64))}}),oo=fe(eo,[["__scopeId","data-v-59d3aa14"]]);export{oo as default};
