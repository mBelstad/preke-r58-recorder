import{D as H,E as W,o as K,l as te,G as Ee,r as x,j as S,H as Le,d as I,I as ve,m as D,T as ue,p as de,c as y,f as T,z as Be,e,w as pe,A as ye,t as C,J as De,i as b,_ as Y,K as We,h as G,F,n as M,x as q,L as ke,q as Z,M as ee,N as xe,u as ge,a as Ne,y as fe,O as Fe,P as He,B as Ue,g as Ce,Q as Ge,b as Ve,v as Ie}from"./index-DxPuJKr5.js";import{M as je}from"./ModeLoadingScreen-BdxfA0B1.js";const z=x(!1),X=x(!1);let O=null;function ze(){const a=H();W(()=>a.status,f=>{z.value=f==="recording"},{immediate:!0});function t(f){if(z.value)return f.preventDefault(),f.returnValue="Recording in progress. Are you sure you want to leave?",f.returnValue}K(()=>{window.addEventListener("beforeunload",t)}),te(()=>{window.removeEventListener("beforeunload",t)}),Ee((f,c,r)=>{z.value?(O=()=>r(),X.value=!0,r(!1)):r()});function o(){X.value=!1,z.value=!1,a.stopRecording().finally(()=>{O&&(O(),O=null)})}function m(){X.value=!1,O=null}return{isGuardActive:z,showLeaveConfirmation:X,confirmLeave:o,cancelLeave:m}}const R=x(null),oe=x(!1),be=x(null),ae=x(null),Oe=10,se=2,qe=25;function Ke(){const a=S(()=>R.value?R.value.available_gb<se?"critical":R.value.available_gb<Oe?"warning":"ok":"unknown"),t=S(()=>R.value?R.value.available_gb>=se:!0),o=S(()=>{if(!R.value)return null;const s=R.value.available_gb*1024*1024*1024,d=qe*1024*1024,w=s/d,u=Math.floor(w/3600),p=Math.floor(w%3600/60);return u>24?`${Math.floor(u/24)}d ${u%24}h`:u>0?`${u}h ${p}m`:`${p}m`}),m=S(()=>{switch(a.value){case"ok":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}}),f=S(()=>R.value?a.value==="critical"?`Disk space critically low (${R.value.available_gb.toFixed(1)} GB). Cannot start recording.`:a.value==="warning"?`Low disk space (${R.value.available_gb.toFixed(1)} GB). Estimated recording time: ${o.value}`:null:null);async function c(){oe.value=!0,ae.value=null;try{const s=await Le.getDegradation();if(s.resources&&s.resources.disk_free_gb!==void 0){const d=s.resources.disk_free_gb,w=d*3;R.value={available_gb:d,total_gb:w,used_percent:100-d/w*100,recording_path:"/opt/r58-app/shared/recordings"}}return be.value=new Date,R.value}catch(s){return ae.value=s.message||"Failed to check disk space",console.error("Failed to check disk space:",s),null}finally{oe.value=!1}}async function r(){return await c(),R.value?a.value==="critical"?{ok:!1,message:`Insufficient disk space (${R.value.available_gb.toFixed(1)} GB). Need at least ${se} GB to start recording.`}:a.value==="warning"?{ok:!0,message:`Low disk space warning: ${R.value.available_gb.toFixed(1)} GB available. Estimated recording time: ${o.value}`}:{ok:!0}:{ok:!0,message:"Could not verify disk space. Proceeding with caution."}}return{diskSpace:R,isLoading:oe,lastCheck:be,error:ae,status:a,statusColor:m,canStartRecording:t,estimatedRecordingTime:o,warningMessage:f,checkDiskSpace:c,preflightCheck:r}}const L=x(localStorage.getItem("r58_audio_feedback")!=="false");let re=null;function Ye(){return re||(re=new(window.AudioContext||window.webkitAudioContext)),re}function E(a,t,o="sine",m=.3){if(L.value)try{const f=Ye();f.state==="suspended"&&f.resume();const c=f.createOscillator(),r=f.createGain();c.connect(r),r.connect(f.destination),c.type=o,c.frequency.value=a;const s=f.currentTime;r.gain.setValueAtTime(0,s),r.gain.linearRampToValueAtTime(m,s+.01),r.gain.linearRampToValueAtTime(0,s+t),c.start(s),c.stop(s+t)}catch(f){console.warn("Audio feedback failed:",f)}}function Qe(){L.value&&(E(440,.1,"sine",.2),setTimeout(()=>E(554,.1,"sine",.2),100),setTimeout(()=>E(659,.15,"sine",.25),200))}function Xe(){L.value&&(E(880,.08,"sine",.3),setTimeout(()=>E(880,.15,"sine",.3),120))}function Je(){L.value&&(E(659,.1,"sine",.25),setTimeout(()=>E(554,.1,"sine",.2),100),setTimeout(()=>E(440,.15,"sine",.2),200))}function Ze(){L.value&&(E(200,.15,"square",.15),setTimeout(()=>E(180,.2,"square",.15),180))}function et(){L.value&&(E(1e3,.08,"sine",.2),setTimeout(()=>E(1e3,.08,"sine",.2),150))}function we(){L.value&&E(1200,.03,"sine",.1)}function tt(a=50){if(L.value&&"vibrate"in navigator)try{navigator.vibrate(a)}catch{}}function nt(){function a(o){L.value=o,localStorage.setItem("r58_audio_feedback",String(o))}function t(){a(!L.value),L.value&&we()}return{enabled:L,setEnabled:a,toggle:t,playSuccess:Qe,playError:Ze,playWarning:et,playClick:we,playRecordStart:Xe,playRecordStop:Je,vibrate:tt}}const ot={class:"bg-preke-bg-elevated rounded-lg shadow-xl max-w-md w-full p-6"},at=["placeholder"],st={class:"text-xs text-preke-text-dim mt-2"},rt=I({__name:"SessionNameDialog",props:{open:{type:Boolean},suggestedName:{}},emits:["confirm","cancel","skip"],setup(a,{emit:t}){const o=a,m=t,f=x(""),c=x(null),r=S(()=>{const k=new Date,g=k.toLocaleDateString("en-CA"),v=k.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}).replace(":","");return`Recording_${g}_${v}`}),s=S(()=>o.suggestedName||r.value);W(()=>o.open,k=>{k&&(f.value=s.value,setTimeout(()=>{var g,v;(g=c.value)==null||g.focus(),(v=c.value)==null||v.select()},100))});function d(){m("confirm",f.value.trim()||s.value)}function w(){m("skip")}function u(){m("cancel")}function p(k){k.key==="Enter"?d():k.key==="Escape"&&u()}return(k,g)=>(b(),ve(De,{to:"body"},[D(ue,{name:"fade"},{default:de(()=>[a.open?(b(),y("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:Be(u,["self"]),onKeydown:p},[e("div",ot,[g[1]||(g[1]=e("h2",{class:"text-lg font-semibold mb-2"},"Name This Recording",-1)),g[2]||(g[2]=e("p",{class:"text-preke-text-dim text-sm mb-4"}," Give your recording a name to find it easily later (optional). ",-1)),pe(e("input",{ref_key:"inputRef",ref:c,"onUpdate:modelValue":g[0]||(g[0]=v=>f.value=v),type:"text",placeholder:s.value,class:"w-full px-4 py-2 bg-preke-bg-surface border border-preke-bg-surface rounded-lg text-preke-text placeholder-preke-text-dim focus:outline-none focus:ring-2 focus:ring-preke-gold"},null,8,at),[[ye,f.value]]),e("p",st," Suggested: "+C(s.value),1),e("div",{class:"flex justify-between mt-6"},[e("button",{onClick:w,class:"text-sm text-preke-text-dim hover:text-preke-text transition-colors"}," Skip (use default) "),e("div",{class:"flex gap-3"},[e("button",{onClick:u,class:"btn"}," Cancel "),e("button",{onClick:d,class:"btn btn-primary"}," Start Recording ")])])])],32)):T("",!0)]),_:1})]))}}),it=Y(rt,[["__scopeId","data-v-2eeca4e8"]]),lt={class:"recorder-controls"},ct={key:0,class:"recorder-controls__duration"},ut=["disabled","title"],dt={key:0,class:"recorder-controls__spinner"},ft={key:0,class:"recorder-controls__icon recorder-controls__icon--stop"},vt={key:1,class:"recorder-controls__icon recorder-controls__icon--record"},pt={class:"recorder-controls__hint"},gt=I({__name:"RecorderControls",setup(a){const t=H(),{register:o}=We(),{preflightCheck:m,status:f,canStartRecording:c}=Ke(),{playRecordStart:r,playRecordStop:s,playError:d,playWarning:w,vibrate:u}=nt(),p=x(null),k=x(!1),g=x(!1),v=x(!1),l=x(!1),$=x(void 0),i=S(()=>t.status==="recording"),n=S(()=>t.status==="starting"),_=S(()=>t.status==="stopping"),h=S(()=>t.formattedDuration),B=S(()=>n.value||_.value||g.value),U=S(()=>n.value?"Starting recording...":_.value?"Stopping recording...":g.value?"Checking disk space...":!i.value&&!c.value?"Insufficient disk space":"");let ne=null;K(()=>{ne=o({key:" ",description:"Toggle Recording",action:Se,context:"recorder",enabled:()=>!n.value&&!_.value})}),te(()=>{ne&&ne()});async function Se(){i.value?he():await Q()}async function Q(A){g.value=!0;try{const P=await m();if(!P.ok){d(),u(200),G.error("Cannot start recording",P.message||"Preflight check failed");return}if(P.message&&f.value==="warning"&&(w(),G.warning("Low disk space",P.message)),l.value&&!A){$.value=void 0,v.value=!0;return}await _e(A||$.value)}finally{g.value=!1}}async function _e(A){try{await t.startRecording(A);const P=A||t.sessionId;r(),u([50,30,50]),G.success("Recording started",`Session: ${P}`)}catch(P){d(),u(200),G.error("Failed to start recording",P.message||"Unknown error",{label:"Retry",onClick:()=>Q(A)})}}function $e(A){v.value=!1,$.value=A,Q(A)}function Re(){v.value=!1,$.value=void 0,Q()}function Me(){v.value=!1,g.value=!1}async function Te(){try{await t.stopRecording(),s(),u(100),G.success("Recording stopped",`Duration: ${h.value}`)}catch(A){d(),u(200),G.error("Failed to stop recording",A.message||"Unknown error")}}function he(){var A;k.value=!1,(A=p.value)==null||A.open(),setTimeout(()=>{k.value=!0},500)}function Ae(){k.value&&Te()}async function Pe(){i.value?he():await _e()}return(A,P)=>(b(),y(F,null,[e("div",lt,[i.value?(b(),y("div",ct,C(h.value),1)):T("",!0),e("button",{onClick:Pe,disabled:B.value,class:M(["recorder-controls__btn",i.value?"recorder-controls__btn--stop":"recorder-controls__btn--start"]),title:U.value||(i.value?"Stop Recording (Space)":"Start Recording (Space)")},[n.value||_.value||g.value?(b(),y("span",dt)):(b(),y(F,{key:1},[i.value?(b(),y("span",ft)):(b(),y("span",vt))],64)),e("span",null,C(g.value?"Checking...":i.value?"Stop":"Start Recording"),1)],10,ut),e("span",pt,[P[0]||(P[0]=q(" Press ",-1)),P[1]||(P[1]=e("kbd",null,"Space",-1)),q(" to "+C(i.value?"stop":"start"),1)])]),D(ke,{ref_key:"stopConfirmDialog",ref:p,title:"Stop Recording?",message:`You have been recording for ${h.value}. This will finalize all files.`,"confirm-text":"Stop Recording","cancel-text":"Keep Recording",danger:!0,onConfirm:Ae},null,8,["message"]),D(it,{open:v.value,onConfirm:$e,onSkip:Re,onCancel:Me},null,8,["open"])],64))}}),mt=Y(gt,[["__scopeId","data-v-38c04e0c"]]),J=x(localStorage.getItem("r58_performance_mode")==="true"),ie=x(localStorage.getItem("r58_performance_mode_auto")!=="false"),_t=3,ht=100,bt=500;function wt(){const a=H(),t=S(()=>J.value?!0:ie.value&&a.isRecording?a.inputs.filter(p=>p.isRecording).length>=_t:!1),o=S(()=>t.value?bt:ht);W(t,u=>{u?document.body.classList.add("performance-mode"):document.body.classList.remove("performance-mode")},{immediate:!0});function m(u){J.value=u,localStorage.setItem("r58_performance_mode",String(u))}function f(u){ie.value=u,localStorage.setItem("r58_performance_mode_auto",String(u))}function c(){m(!J.value)}function r(u,p){let k=0,g=null;return(...v)=>{const l=Date.now(),$=p??o.value,i=l-k;i>=$?(k=l,u(...v)):g||(g=window.setTimeout(()=>{k=Date.now(),g=null,u(...v)},$-i))}}function s(u,p){let k=null;return(...g)=>{k&&clearTimeout(k),k=window.setTimeout(()=>{u(...g),k=null},p??o.value)}}function d(u){return t.value?window.setTimeout(()=>u(performance.now()),o.value):requestAnimationFrame(u)}function w(u){t.value?clearTimeout(u):cancelAnimationFrame(u)}return{enabled:J,autoEnable:ie,isActive:t,updateInterval:o,setEnabled:m,setAutoEnable:f,toggle:c,throttle:r,debounce:s,requestFrame:d,cancelFrame:w}}const yt=["title"],kt={class:"flex items-center gap-1.5 text-sm"},xt={key:0,class:"flex items-center gap-1.5 text-sm"},Ct={key:1,class:"flex items-center gap-1.5 text-sm text-red-400"},St={class:"font-mono"},$t=I({__name:"RecordingHealth",setup(a,{expose:t}){const o=H(),{isActive:m}=wt(),f=x({}),c=x(0),r=x(0),s=x(0);let d=null;function w(){const v={};let l=0;o.inputs.forEach(i=>{v[i.id]=i.bytesWritten;const n=f.value[i.id]||0;l+=i.bytesWritten-n});const $=m.value?2:1;c.value=Math.round(l/(1024*1024)/$*10)/10,f.value=v}W(()=>o.isRecording,v=>{if(v){f.value={},c.value=0,r.value=0,s.value=0;const l=m.value?2e3:1e3;d=window.setInterval(w,l)}else d&&(clearInterval(d),d=null)},{immediate:!0}),W(m,v=>{if(o.isRecording&&d){clearInterval(d);const l=v?2e3:1e3;d=window.setInterval(w,l)}}),te(()=>{d&&clearInterval(d)});const u=S(()=>o.isRecording?s.value>0||r.value>90?"critical":c.value<1||r.value>70?"warning":"healthy":"idle"),p=S(()=>{switch(u.value){case"healthy":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}});S(()=>{switch(u.value){case"healthy":return"Healthy";case"warning":return"Warning";case"critical":return"Critical";default:return"Idle"}});const k=S(()=>{if(!o.isRecording)return"Not recording";const v=[`Write speed: ${c.value} MB/s`,`Buffer: ${r.value}%`];return s.value>0&&v.push(`Frames dropped: ${s.value}`),v.join(`
`)});function g(v){v.buffer_percent!==void 0&&(r.value=v.buffer_percent),v.frames_dropped!==void 0&&(s.value=v.frames_dropped)}return t({updateFromMetrics:g}),(v,l)=>Z(o).isRecording?(b(),y("div",{key:0,class:M(["flex items-center gap-3 px-3 py-1.5 rounded-lg transition-colors cursor-help",{"bg-emerald-500/10":p.value==="emerald","bg-amber-500/10":p.value==="amber","bg-red-500/10":p.value==="red"}]),title:k.value},[e("span",{class:M(["w-2 h-2 rounded-full",p.value==="emerald"?"bg-emerald-500":"",p.value==="amber"?"bg-amber-500 animate-pulse":"",p.value==="red"?"bg-red-500 animate-pulse":""])},null,2),e("div",kt,[l[0]||(l[0]=e("svg",{class:"w-3.5 h-3.5 text-preke-text-dim",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})],-1)),e("span",{class:M(["font-mono",p.value==="emerald"?"text-emerald-400":"",p.value==="amber"?"text-amber-400":"",p.value==="red"?"text-red-400":""])},C(c.value)+" MB/s ",3)]),r.value>0?(b(),y("div",xt,[l[1]||(l[1]=e("span",{class:"text-preke-text-dim"},"Buf:",-1)),e("span",{class:M(["font-mono",r.value<50?"text-emerald-400":"",r.value>=50&&r.value<80?"text-amber-400":"",r.value>=80?"text-red-400":""])},C(r.value)+"% ",3)])):T("",!0),s.value>0?(b(),y("div",Ct,[l[2]||(l[2]=e("svg",{class:"w-3.5 h-3.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),e("span",St,C(s.value)+" dropped",1)])):T("",!0)],10,yt)):T("",!0)}}),Rt=["65.109.32.111"],Mt=5,Tt=1e3,At=3e4,N=new Map,j=new Map;function Pt(a){const t=ee(),o=xe();if(t&&!o)try{return`http://${new URL(t).hostname}:8889/${a}/whep`}catch{console.warn("[WHEP Manager] Invalid device URL, falling back to FRP")}return`https://r58-mediamtx.itagenten.no/${a}/whep`}async function Et(a,t){const o=N.get(t);if(!o)return"unknown";try{const c=new URL(o.whepUrl).hostname;if(c.includes("itagenten.no"))return console.log(`[WHEP Manager ${t}] Detected relay (FRP URL)`),"relay";if(c.startsWith("100."))return console.log(`[WHEP Manager ${t}] Detected P2P (Tailscale IP: ${c})`),"p2p";if(c.startsWith("192.168.")||c.startsWith("10.")||c.startsWith("172."))return console.log(`[WHEP Manager ${t}] Detected P2P (LAN IP: ${c})`),"p2p"}catch(f){console.warn(`[WHEP Manager ${t}] Failed to parse WHEP URL:`,f)}try{const f=await a.getStats();for(const c of f.values())if(c.type==="candidate-pair"&&c.state==="succeeded"){const r=f.get(c.remoteCandidateId);if((r==null?void 0:r.candidateType)==="relay")return console.log(`[WHEP Manager ${t}] Detected relay (TURN candidate)`),"relay";const s=r==null?void 0:r.address;if(s&&Rt.includes(s))return console.log(`[WHEP Manager ${t}] Detected relay (VPS IP: ${s})`),"relay"}}catch(f){console.warn(`[WHEP Manager ${t}] Failed to get WebRTC stats:`,f)}return ee()&&!xe()?(console.log(`[WHEP Manager ${t}] Assuming P2P (direct device URL configured)`),"p2p"):"unknown"}function V(a){const t=N.get(a);if(!t)return;const o=j.get(a);o&&o.forEach(m=>m(t))}function le(a){const t=N.get(a);if(!t)return;if(t.reconnectAttempts>=Mt){console.error(`[WHEP Manager ${a}] Max reconnect attempts reached`),t.state="failed",V(a);return}t.reconnectAttempts++;const o=Math.min(Tt*Math.pow(2,t.reconnectAttempts-1),At);console.log(`[WHEP Manager ${a}] Scheduling reconnect #${t.reconnectAttempts} in ${o}ms`),t.state="connecting",V(a),t.reconnectTimeout&&clearTimeout(t.reconnectTimeout),t.reconnectTimeout=setTimeout(()=>{me(a)},o)}async function me(a){let t=N.get(a);if(t&&(t.state==="connected"||t.state==="connecting"))return console.log(`[WHEP Manager ${a}] Reusing existing connection (state: ${t.state})`),t;let o=ee(),m=0;for(;!o&&m<5;)console.log(`[WHEP Manager ${a}] No device URL yet, waiting... (attempt ${m+1})`),await new Promise(s=>setTimeout(s,100)),o=ee(),m++;const f=performance.now(),c=Pt(a);console.log(`[WHEP Manager ${a}] Creating connection to: ${c}`),console.log(`[WHEP Manager ${a}] Device URL was: ${o}`),t!=null&&t.peerConnection&&t.peerConnection.close();const r=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}]});t?(t.peerConnection=r,t.state="connecting",t.whepUrl=c,t.mediaStream=null,t.connectionType="unknown",t.connectionStartTime=f):(t={cameraId:a,peerConnection:r,mediaStream:null,state:"connecting",connectionType:"unknown",refCount:0,whepUrl:c,lastConnectedAt:null,reconnectAttempts:(t==null?void 0:t.reconnectAttempts)||0,reconnectTimeout:null,connectionStartTime:f},N.set(a,t)),r.ontrack=s=>{s.streams[0]&&(t.mediaStream=s.streams[0],console.log(`[WHEP Manager ${a}] Received media stream`),V(a))},r.oniceconnectionstatechange=async()=>{const s=r.iceConnectionState;if(console.log(`[WHEP Manager ${a}] ICE state: ${s}`),s==="connected"||s==="completed"){t.state="connected",t.lastConnectedAt=Date.now(),t.reconnectAttempts=0,t.connectionType=await Et(r,a);const d=t.connectionStartTime?Math.round(performance.now()-t.connectionStartTime):0;console.log(`[WHEP Manager ${a}] Connected (${t.connectionType}) in ${d}ms`),V(a)}else s==="failed"?(t.state="failed",t.connectionType="unknown",V(a),t.refCount>0&&le(a)):s==="disconnected"&&setTimeout(()=>{(r.iceConnectionState==="disconnected"||r.iceConnectionState==="failed")&&(t.state="disconnected",V(a),t.refCount>0&&le(a))},3e3)},r.addTransceiver("video",{direction:"recvonly"}),r.addTransceiver("audio",{direction:"recvonly"});try{const s=await r.createOffer();await r.setLocalDescription(s);const d=await fetch(c,{method:"POST",headers:{"Content-Type":"application/sdp"},body:s.sdp});if(!d.ok)throw new Error(`WHEP request failed: ${d.status}`);const w=await d.text();await r.setRemoteDescription({type:"answer",sdp:w})}catch(s){console.error(`[WHEP Manager ${a}] Connection error:`,s),t.state="failed",V(a),t.refCount>0&&le(a)}return t}async function Lt(a,t){j.has(a)||j.set(a,new Set),j.get(a).add(t);let o=N.get(a);return(!o||o.state==="failed"||o.state==="disconnected")&&(o=await me(a)),o.refCount++,console.log(`[WHEP Manager ${a}] Acquired connection (refCount: ${o.refCount})`),t(o),o}function Bt(a,t){const o=N.get(a);if(!o)return;const m=j.get(a);m&&(m.delete(t),m.size===0&&j.delete(a)),o.refCount=Math.max(0,o.refCount-1),console.log(`[WHEP Manager ${a}] Released connection (refCount: ${o.refCount})`),o.refCount===0&&(console.log(`[WHEP Manager ${a}] Closing unused connection`),o.reconnectTimeout&&clearTimeout(o.reconnectTimeout),o.peerConnection.close(),N.delete(a))}function ce(a){const t=N.get(a);t&&(console.log(`[WHEP Manager ${a}] Force reconnecting...`),t.reconnectAttempts=0,me(a))}const Dt={class:"relative w-full h-full bg-black"},Wt=["title"],Nt={key:1,class:"absolute inset-0 flex items-center justify-center bg-black/50"},Ft={key:2,class:"absolute inset-0 flex items-center justify-center bg-black/70"},Ht={class:"text-center"},Ut={class:"text-xs text-amber-400"},Gt={key:3,class:"absolute inset-0 flex items-center justify-center bg-black/80"},Vt={class:"text-center text-preke-text-dim"},It={class:"text-sm"},jt=I({__name:"InputPreview",props:{inputId:{},protocol:{}},emits:["videoReady"],setup(a,{emit:t}){const o=a,m=t,f=H();let c=!1;const r=S(()=>f.status==="recording"),s=x(null),d=x(!0),w=x(null),u=x("unknown"),p=x(!1),k=x(0);let g=null;function v(n){switch(console.log(`[InputPreview ${o.inputId}] Connection update:`,{state:n.state,type:n.connectionType,hasStream:!!n.mediaStream}),u.value=n.connectionType,k.value=n.reconnectAttempts,n.state){case"connecting":d.value=!0,w.value=null,p.value=n.reconnectAttempts>0;break;case"connected":d.value=!1,w.value=null,p.value=!1,n.mediaStream&&s.value&&s.value.srcObject!==n.mediaStream&&(s.value.srcObject=n.mediaStream,c||(s.value.onloadeddata=()=>{c||(c=!0,console.log(`[InputPreview ${o.inputId}] Video ready (first frame displayed)`),m("videoReady"))}));break;case"disconnected":p.value=!0,w.value=`Reconnecting... (${n.reconnectAttempts}/5)`;break;case"failed":d.value=!1,p.value=!1,w.value="Connection failed after multiple attempts";break}}async function l(){if(s.value){i(),d.value=!0,w.value=null,g=v;try{await Lt(o.inputId,g)}catch(n){console.error(`[InputPreview ${o.inputId}] Failed to acquire connection:`,n),w.value=n instanceof Error?n.message:"Failed to connect",d.value=!1}}}function $(){ce(o.inputId)}function i(){g&&(Bt(o.inputId,g),g=null)}return K(()=>{l()}),W(()=>o.inputId,()=>{l()}),W(r,(n,_)=>{_&&!n&&w.value?(console.log("[InputPreview] Recording stopped, reconnecting preview..."),ce(o.inputId)):!_&&n&&(console.log("[InputPreview] Recording started, will try to reconnect preview after delay..."),setTimeout(()=>{r.value&&(console.log("[InputPreview] Attempting to reconnect preview during recording..."),ce(o.inputId))},2e3))}),te(()=>{i()}),(n,_)=>(b(),y("div",Dt,[e("video",{ref_key:"videoRef",ref:s,autoplay:"",muted:"",playsinline:"",class:"w-full h-full object-contain"},null,512),!d.value&&!w.value&&u.value!=="unknown"?(b(),y("div",{key:0,class:M(["absolute top-1 right-1 px-1.5 py-0.5 text-[10px] font-medium rounded",u.value==="p2p"?"bg-emerald-500/80 text-white":"bg-amber-500/80 text-white"]),title:u.value==="p2p"?"Direct P2P connection":"Relay connection (FRP)"},C(u.value==="p2p"?"P2P":"RELAY"),11,Wt)):T("",!0),d.value&&!p.value?(b(),y("div",Nt,[..._[0]||(_[0]=[e("div",{class:"animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"},null,-1)])])):T("",!0),p.value?(b(),y("div",Ft,[e("div",Ht,[_[1]||(_[1]=e("div",{class:"animate-spin w-5 h-5 border-2 border-amber-400 border-t-transparent rounded-full mx-auto mb-2"},null,-1)),e("p",Ut,C(w.value||"Reconnecting..."),1)])])):w.value&&!d.value?(b(),y("div",Gt,[e("div",Vt,[e("p",It,C(w.value),1),e("button",{onClick:$,class:"mt-2 text-xs text-preke-gold hover:underline"}," Retry ")])])):T("",!0)]))}}),zt={key:0,class:"h-full flex items-center justify-center"},Ot={key:1,class:"input-grid"},qt={key:0,class:"input-grid__warning"},Kt=["data-count"],Yt=["title"],Qt={key:1,class:"w-full h-full flex items-center justify-center bg-preke-bg-surface"},Xt={class:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-4"},Jt={class:"flex items-center justify-between"},Zt={class:"flex items-center gap-2"},en={class:"font-medium"},tn={key:0,class:"flex items-center gap-2 text-sm"},nn={class:"text-preke-text-dim"},on={key:0,class:"mt-2 flex items-center justify-between"},an={class:"text-sm font-mono text-preke-text-dim"},sn=I({__name:"InputGrid",emits:["allVideosReady"],setup(a,{emit:t}){const o=H(),m=ge(),f=t,c=x(new Set);function r(l){c.value.add(l),console.log(`[InputGrid] Video ready: ${l} (${c.value.size}/${d.value.length})`),c.value.size>=d.value.length&&(console.log("[InputGrid] All videos ready!"),f("allVideosReady"))}W(()=>d.value.length,()=>{c.value.clear()});const s=S(()=>{var l;return((l=m.capabilities)==null?void 0:l.current_mode)==="recorder"}),d=S(()=>o.inputs.filter(l=>l.hasSignal)),w=S(()=>o.framerateMismatch);function u(l){return l.isRecording?"border-preke-red ring-2 ring-preke-red/20":l.hasSignal?"border-emerald-500/50 hover:border-emerald-500":"border-preke-bg-surface/50 opacity-60"}function p(l){return l.hasSignal?l.framerate>=29?"excellent":l.framerate>=24?"good":"unstable":"none"}function k(l){switch(p(l)){case"excellent":return"text-emerald-400";case"good":return"text-emerald-400";case"unstable":return"text-amber-400";case"none":return"text-preke-text-dim"}}function g(l){if(l===0)return"0 B";const $=1024,i=["B","KB","MB","GB"],n=Math.floor(Math.log(l)/Math.log($));return parseFloat((l/Math.pow($,n)).toFixed(1))+" "+i[n]}function v(l){if(!l.hasSignal)return`${l.label}: No signal detected`;const $=[`${l.label}`,`Resolution: ${l.resolution}`,`Framerate: ${l.framerate} fps`,`Quality: ${p(l)}`];return l.isRecording&&$.push(`Written: ${g(l.bytesWritten)}`),$.join(`
`)}return(l,$)=>d.value.length===0?(b(),y("div",zt,[...$[0]||($[0]=[Ne('<div class="text-center text-preke-text-dim" data-v-4b8607a1><svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-4b8607a1><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" data-v-4b8607a1></path></svg><p class="text-lg font-medium" data-v-4b8607a1>No Video Sources Connected</p><p class="text-sm mt-2" data-v-4b8607a1>Connect HDMI cables to begin recording</p></div>',1)])])):(b(),y("div",Ot,[w.value?(b(),y("div",qt,[$[1]||($[1]=e("svg",{class:"w-4 h-4 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),e("span",null,C(w.value),1)])):T("",!0),e("div",{class:"input-grid__container","data-count":d.value.length},[(b(!0),y(F,null,fe(d.value,i=>(b(),y("div",{key:i.id,class:M(["input-grid__tile",u(i)]),title:v(i)},[s.value?(b(),ve(jt,{key:0,"input-id":i.id,class:"w-full h-full",onVideoReady:n=>r(i.id)},null,8,["input-id","onVideoReady"])):(b(),y("div",Qt,[...$[2]||($[2]=[e("div",{class:"text-center"},[e("svg",{class:"w-8 h-8 mx-auto mb-2 text-preke-text-dim/50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})]),e("span",{class:"text-xs text-preke-text-dim/70"},"Mixer mode")],-1)])])),e("div",Xt,[e("div",Jt,[e("div",Zt,[e("span",{class:M(["w-2 h-2 rounded-full transition-colors",{"bg-emerald-500":p(i)==="excellent"||p(i)==="good","bg-amber-500 animate-pulse":p(i)==="unstable","bg-preke-text-dim":p(i)==="none"}])},null,2),e("span",en,C(i.label),1)]),i.hasSignal?(b(),y("div",tn,[e("span",nn,C(i.resolution),1),e("span",{class:M(k(i))},C(i.framerate)+"fps",3)])):T("",!0)]),i.isRecording?(b(),y("div",on,[$[3]||($[3]=e("div",{class:"flex items-center gap-2 text-preke-red"},[e("span",{class:"w-2 h-2 rounded-full bg-preke-red animate-recording"}),e("span",{class:"text-sm font-medium"},"REC")],-1)),e("span",an,C(g(i.bytesWritten)),1)])):T("",!0)])],10,Yt))),128))],8,Kt)]))}}),rn=Y(sn,[["__scopeId","data-v-4b8607a1"]]),ln={class:"sidebar"},cn={class:"sidebar__card sidebar__card--header"},un={class:"connection-row"},dn={class:"connection-status"},fn={class:"connection-label"},vn={key:0,class:"connection-latency"},pn=["disabled"],gn={class:"sidebar__card sidebar__card--recording"},mn={class:"recording__duration"},_n={class:"recording__meta"},hn={class:"sidebar__card"},bn={class:"stats"},wn={class:"stats__label"},yn={class:"stats__value"},kn={key:0,class:"sidebar__card sidebar__card--warning"},xn={class:"warning__text"},Cn={class:"sidebar__card"},Sn={class:"sidebar__hint"},$n={class:"sidebar__card"},Rn={class:"cameras"},Mn={class:"camera__header"},Tn={class:"camera__controls"},An=["onClick"],Pn={class:"camera__btn-label"},En=["onClick"],Ln={class:"camera__btn-label"},Bn=["onClick"],Dn={class:"camera__btn-label"},Wn=["onClick"],Nn={class:"camera__btn-label"},Fn={key:0,class:"sidebar__card"},Hn={class:"storage"},Un={class:"storage__bar"},Gn={class:"storage__info"},Vn={class:"storage__estimate"},In=I({__name:"SessionInfoV2",setup(a){const t=Ce(),o=H(),m=ge(),{state:f,latencyMs:c}=Fe(),{connectionMethod:r}=He(),s=S(()=>{const i=f.value==="connected",n=f.value==="connecting",_=f.value==="degraded";if(i){let h="";return r.value==="relay"?h="Relay":r.value==="p2p"?h="P2P":r.value==="local"&&(h="Local"),{status:"online",color:"green",label:h||"Connected",latency:c.value,pulse:!1}}return n?{status:"connecting",color:"amber",label:"Connecting...",latency:null,pulse:!0}:_?{status:"degraded",color:"amber",label:"Slow",latency:c.value,pulse:!1}:{status:"offline",color:"red",label:"Offline",latency:null,pulse:!0}});S(()=>o.currentSession);const d=S(()=>o.activeInputs),w=S(()=>o.isRecording),u=S(()=>o.inputs.filter(i=>i.isRecording)),p=x("");K(()=>{const n=new Date().toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,".");p.value=`Session ${n}`});const k=x([{id:"cam1",name:"CAM 1",focus:"auto",wb:"auto",shutter:"auto",aperture:"auto"},{id:"cam2",name:"CAM 2",focus:"auto",wb:"auto",shutter:"auto",aperture:"auto"},{id:"cam3",name:"CAM 3",focus:"auto",wb:"auto",shutter:"auto",aperture:"auto"},{id:"cam4",name:"CAM 4",focus:"auto",wb:"auto",shutter:"auto",aperture:"auto"}]);function g(i,n){const _=k.value[i];_&&(_[n]=_[n]==="auto"?"manual":"auto")}const v=S(()=>{const i=m.capabilities;if(!i)return null;const n=i.storage_used_gb||0,_=i.storage_total_gb||1,h=_-n,B=Math.round(n/_*100),U=h/10;return{freeGB:Math.round(h),totalGB:Math.round(_),percent:B,hoursRemaining:Math.round(U*10)/10,isLow:B>85,isCritical:B>95}});function l(i){if(i===0)return"0 B";const n=1024,_=["B","KB","MB","GB","TB"],h=Math.floor(Math.log(i)/Math.log(n));return parseFloat((i/Math.pow(n,h)).toFixed(2))+" "+_[h]}function $(){t.push({name:"admin",query:{tab:"settings"}})}return(i,n)=>{var _;return b(),y("div",ln,[e("div",cn,[e("div",un,[e("div",dn,[e("span",{class:M(["connection-dot",[`connection-dot--${s.value.color}`,{"connection-dot--pulse":s.value.pulse}]])},null,2),e("span",fn,C(s.value.label),1),s.value.latency?(b(),y("span",vn,C(s.value.latency)+"ms ",1)):T("",!0)])]),n[1]||(n[1]=e("div",{class:"sidebar__divider"},null,-1)),n[2]||(n[2]=e("label",{class:"sidebar__label"},"Session Name",-1)),pe(e("input",{"onUpdate:modelValue":n[0]||(n[0]=h=>p.value=h),type:"text",class:"sidebar__input",placeholder:"Session 06.01.2026",disabled:w.value},null,8,pn),[[ye,p.value]])]),w.value?(b(),y(F,{key:0},[e("div",gn,[n[3]||(n[3]=e("div",{class:"recording__header"},[e("span",{class:"recording__dot"}),e("span",{class:"recording__label"},"Recording")],-1)),e("div",mn,C(Z(o).formattedDuration),1),e("div",_n,C(u.value.length)+" camera"+C(u.value.length!==1?"s":"")+" recording ",1)]),e("div",hn,[n[4]||(n[4]=e("div",{class:"sidebar__label"},"Recording Stats",-1)),e("div",bn,[(b(!0),y(F,null,fe(u.value,h=>(b(),y("div",{key:h.id,class:"stats__item"},[e("span",wn,C(h.label),1),e("span",yn,C(l(h.bytesWritten)),1)]))),128))])]),(_=v.value)!=null&&_.isLow?(b(),y("div",kn,[n[6]||(n[6]=e("span",{class:"warning__icon"},"⚠️",-1)),e("div",xn,[n[5]||(n[5]=e("strong",null,"Low storage",-1)),e("span",null,C(v.value.freeGB)+" GB remaining",1)])])):T("",!0)],64)):(b(),y(F,{key:1},[e("div",Cn,[n[9]||(n[9]=e("div",{class:"sidebar__label"},"Status",-1)),e("p",Sn,[q(C(d.value.length)+" input"+C(d.value.length!==1?"s":"")+" with signal. Press ",1),n[7]||(n[7]=e("kbd",null,"Space",-1)),n[8]||(n[8]=q(" to start recording. ",-1))])]),e("div",$n,[n[14]||(n[14]=e("div",{class:"sidebar__label"},"Camera Controls",-1)),e("div",Rn,[(b(!0),y(F,null,fe(k.value,(h,B)=>(b(),y("div",{key:h.id,class:"camera"},[e("div",Mn,C(h.name),1),e("div",Tn,[e("button",{class:M(["camera__btn",{"camera__btn--auto":h.focus==="auto"}]),onClick:U=>g(B,"focus"),title:"Focus"},[n[10]||(n[10]=e("span",{class:"camera__btn-icon"},"◎",-1)),e("span",Pn,C(h.focus==="auto"?"A":"M"),1)],10,An),e("button",{class:M(["camera__btn",{"camera__btn--auto":h.wb==="auto"}]),onClick:U=>g(B,"wb"),title:"White Balance"},[n[11]||(n[11]=e("span",{class:"camera__btn-icon"},"☀",-1)),e("span",Ln,C(h.wb==="auto"?"A":"M"),1)],10,En),e("button",{class:M(["camera__btn",{"camera__btn--auto":h.shutter==="auto"}]),onClick:U=>g(B,"shutter"),title:"Shutter"},[n[12]||(n[12]=e("span",{class:"camera__btn-icon"},"⏱",-1)),e("span",Dn,C(h.shutter==="auto"?"A":"M"),1)],10,Bn),e("button",{class:M(["camera__btn",{"camera__btn--auto":h.aperture==="auto"}]),onClick:U=>g(B,"aperture"),title:"Aperture"},[n[13]||(n[13]=e("span",{class:"camera__btn-icon"},"◐",-1)),e("span",Nn,C(h.aperture==="auto"?"A":"M"),1)],10,Wn)])]))),128))])]),v.value?(b(),y("div",Fn,[n[15]||(n[15]=e("div",{class:"sidebar__label"},"Storage",-1)),e("div",Hn,[e("div",Un,[e("div",{class:M(["storage__fill",{"storage__fill--ok":!v.value.isLow,"storage__fill--low":v.value.isLow&&!v.value.isCritical,"storage__fill--critical":v.value.isCritical}]),style:Ue({width:`${v.value.percent}%`})},null,6)]),e("div",Gn,[e("span",null,C(v.value.freeGB)+" GB free",1),e("span",Vn,"~"+C(v.value.hoursRemaining)+"h",1)])])])):T("",!0),e("div",{class:"sidebar__card"},[n[17]||(n[17]=e("div",{class:"sidebar__label"},"Quick Actions",-1)),e("button",{onClick:$,class:"sidebar__btn"},[...n[16]||(n[16]=[e("svg",{class:"sidebar__btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","stroke-width":"1.8"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("circle",{cx:"12",cy:"12",r:"3"})],-1),q(" Configure Inputs ",-1)])])])],64))])}}}),jn=Y(In,[["__scopeId","data-v-dd5d083c"]]),zn={class:"h-full flex flex-col"},On={class:"recorder-header"},qn={class:"recorder-header__left"},Kn={class:"recorder-header__title"},Yn={key:0,class:"recorder-header__badge"},Qn={class:"flex-1 flex min-h-0 overflow-hidden"},Xn={class:"flex-1 min-h-0 min-w-0 p-3 overflow-hidden"},Jn={class:"w-72 flex-shrink-0 border-l border-preke-surface-border bg-preke-surface/80 backdrop-blur-lg p-4 overflow-y-auto"},Zn=I({__name:"RecorderView",setup(a){const t=Ce(),o=H(),m=ge(),{showLeaveConfirmation:f,confirmLeave:c,cancelLeave:r}=ze();function s(){t.push("/")}const d=S(()=>o.status==="recording"),w=S(()=>o.formattedDuration),u=x(!0),p=x(!1),k=x(!1),g=S(()=>p.value&&k.value);function v(){u.value=!1}async function l(){var _;if(!Ge())return;await m.fetchCapabilities();const n=(_=m.capabilities)==null?void 0:_.current_mode;if(n&&n!=="recorder"){console.log("[Recorder] Not in recorder mode, switching...");try{(await fetch(Ve("/api/mode/recorder"),{method:"POST"})).ok&&(await m.fetchCapabilities(),G.success("Switched to Recorder mode"))}catch(h){console.warn("[Recorder] Failed to switch mode:",h)}}}function $(){console.log("[Recorder] All videos ready!"),k.value=!0}K(async()=>{const n=performance.now();await Promise.all([l(),o.fetchInputs(),o.fetchStatus()]);const _=o.inputs.filter(h=>h.hasSignal).length;console.log(`[Recorder] Data loaded: ${o.inputs.length} inputs, ${_} with signal (${Math.round(performance.now()-n)}ms)`),p.value=!0,_===0&&(k.value=!0)});const i=x(null);return W(f,n=>{var _,h;n?(_=i.value)==null||_.open():(h=i.value)==null||h.close()}),(n,_)=>(b(),y(F,null,[D(ue,{name:"fade"},{default:de(()=>[u.value?(b(),ve(je,{key:0,mode:"recorder","content-ready":g.value,"min-time":1500,"max-time":5e3,"show-cancel":!0,onReady:v,onCancel:s},null,8,["content-ready"])):T("",!0)]),_:1}),D(ue,{name:"content-fade"},{default:de(()=>[pe(e("div",zn,[e("header",On,[e("div",qn,[e("div",Kn,[e("span",{class:M(["recorder-header__indicator",{"recorder-header__indicator--active":d.value}])},null,2),_[0]||(_[0]=e("span",{class:"recorder-header__label"},"Recorder",-1))]),d.value?(b(),y("span",Yn," REC ")):T("",!0),D($t)]),D(mt)]),e("div",Qn,[e("div",Xn,[D(rn,{onAllVideosReady:$})]),e("aside",Jn,[D(jn)])]),D(ke,{ref_key:"leaveDialog",ref:i,title:"Recording in Progress",message:`You are currently recording (${w.value}). Leaving will stop the recording and save all files.`,"confirm-text":"Leave and Stop Recording","cancel-text":"Stay",danger:!0,onConfirm:Z(c),onCancel:Z(r)},null,8,["message","onConfirm","onCancel"])],512),[[Ie,!u.value]])]),_:1})],64))}}),no=Y(Zn,[["__scopeId","data-v-52bf7624"]]);export{no as default};
