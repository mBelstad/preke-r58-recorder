const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BMV0MFpw.js","assets/index-BVc8gw8a.css"])))=>i.map(i=>d[i]);
import{D as N,E as H,o as z,l as ee,G as Be,r as k,j as C,H as We,d as V,I as fe,m as B,T as ce,p as ue,c as x,f as E,z as He,e as n,w as pe,A as ke,t as R,J as Ne,i as $,_ as q,K as Ue,h as U,F as G,n as M,x as de,L as $e,q as J,M as Z,N as Fe,O as Ce,u as ve,a as Ge,y as xe,B as Ve,P as Ie,Q as Oe,g as Re,R as je,b as ze,v as qe}from"./index-BMV0MFpw.js";import{M as Ke}from"./ModeLoadingScreen-BjQaiBxf.js";const O=k(!1),Q=k(!1);let j=null;function Qe(){const t=N();H(()=>t.status,i=>{O.value=i==="recording"},{immediate:!0});function e(i){if(O.value)return i.preventDefault(),i.returnValue="Recording in progress. Are you sure you want to leave?",i.returnValue}z(()=>{window.addEventListener("beforeunload",e)}),ee(()=>{window.removeEventListener("beforeunload",e)}),Be((i,l,r)=>{O.value?(j=()=>r(),Q.value=!0,r(!1)):r()});function a(){Q.value=!1,O.value=!1,t.stopRecording().finally(()=>{j&&(j(),j=null)})}function p(){Q.value=!1,j=null}return{isGuardActive:O,showLeaveConfirmation:Q,confirmLeave:a,cancelLeave:p}}const S=k(null),ne=k(!1),he=k(null),oe=k(null),Ye=10,ae=2,Xe=25;function Je(){const t=C(()=>S.value?S.value.available_gb<ae?"critical":S.value.available_gb<Ye?"warning":"ok":"unknown"),e=C(()=>S.value?S.value.available_gb>=ae:!0),a=C(()=>{if(!S.value)return null;const s=S.value.available_gb*1024*1024*1024,f=Xe*1024*1024,y=s/f,u=Math.floor(y/3600),g=Math.floor(y%3600/60);return u>24?`${Math.floor(u/24)}d ${u%24}h`:u>0?`${u}h ${g}m`:`${g}m`}),p=C(()=>{switch(t.value){case"ok":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}}),i=C(()=>S.value?t.value==="critical"?`Disk space critically low (${S.value.available_gb.toFixed(1)} GB). Cannot start recording.`:t.value==="warning"?`Low disk space (${S.value.available_gb.toFixed(1)} GB). Estimated recording time: ${a.value}`:null:null);async function l(){ne.value=!0,oe.value=null;try{const s=await We.getDegradation();if(s.resources&&s.resources.disk_free_gb!==void 0){const f=s.resources.disk_free_gb,y=f*3;S.value={available_gb:f,total_gb:y,used_percent:100-f/y*100,recording_path:"/opt/r58-app/shared/recordings"}}return he.value=new Date,S.value}catch(s){return oe.value=s.message||"Failed to check disk space",console.error("Failed to check disk space:",s),null}finally{ne.value=!1}}async function r(){return await l(),S.value?t.value==="critical"?{ok:!1,message:`Insufficient disk space (${S.value.available_gb.toFixed(1)} GB). Need at least ${ae} GB to start recording.`}:t.value==="warning"?{ok:!0,message:`Low disk space warning: ${S.value.available_gb.toFixed(1)} GB available. Estimated recording time: ${a.value}`}:{ok:!0}:{ok:!0,message:"Could not verify disk space. Proceeding with caution."}}return{diskSpace:S,isLoading:ne,lastCheck:he,error:oe,status:t,statusColor:p,canStartRecording:e,estimatedRecordingTime:a,warningMessage:i,checkDiskSpace:l,preflightCheck:r}}const L=k(localStorage.getItem("r58_audio_feedback")!=="false");let se=null;function Ze(){return se||(se=new(window.AudioContext||window.webkitAudioContext)),se}function A(t,e,a="sine",p=.3){if(L.value)try{const i=Ze();i.state==="suspended"&&i.resume();const l=i.createOscillator(),r=i.createGain();l.connect(r),r.connect(i.destination),l.type=a,l.frequency.value=t;const s=i.currentTime;r.gain.setValueAtTime(0,s),r.gain.linearRampToValueAtTime(p,s+.01),r.gain.linearRampToValueAtTime(0,s+e),l.start(s),l.stop(s+e)}catch(i){console.warn("Audio feedback failed:",i)}}function et(){L.value&&(A(440,.1,"sine",.2),setTimeout(()=>A(554,.1,"sine",.2),100),setTimeout(()=>A(659,.15,"sine",.25),200))}function tt(){L.value&&(A(880,.08,"sine",.3),setTimeout(()=>A(880,.15,"sine",.3),120))}function nt(){L.value&&(A(659,.1,"sine",.25),setTimeout(()=>A(554,.1,"sine",.2),100),setTimeout(()=>A(440,.15,"sine",.2),200))}function ot(){L.value&&(A(200,.15,"square",.15),setTimeout(()=>A(180,.2,"square",.15),180))}function at(){L.value&&(A(1e3,.08,"sine",.2),setTimeout(()=>A(1e3,.08,"sine",.2),150))}function be(){L.value&&A(1200,.03,"sine",.1)}function st(t=50){if(L.value&&"vibrate"in navigator)try{navigator.vibrate(t)}catch{}}function rt(){function t(a){L.value=a,localStorage.setItem("r58_audio_feedback",String(a))}function e(){t(!L.value),L.value&&be()}return{enabled:L,setEnabled:t,toggle:e,playSuccess:et,playError:ot,playWarning:at,playClick:be,playRecordStart:tt,playRecordStop:nt,vibrate:st}}const it={class:"bg-preke-bg-elevated rounded-lg shadow-xl max-w-md w-full p-6"},lt=["placeholder"],ct={class:"text-xs text-preke-text-dim mt-2"},ut=V({__name:"SessionNameDialog",props:{open:{type:Boolean},suggestedName:{}},emits:["confirm","cancel","skip"],setup(t,{emit:e}){const a=t,p=e,i=k(""),l=k(null),r=C(()=>{const b=new Date,m=b.toLocaleDateString("en-CA"),v=b.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}).replace(":","");return`Recording_${m}_${v}`}),s=C(()=>a.suggestedName||r.value);H(()=>a.open,b=>{b&&(i.value=s.value,setTimeout(()=>{var m,v;(m=l.value)==null||m.focus(),(v=l.value)==null||v.select()},100))});function f(){p("confirm",i.value.trim()||s.value)}function y(){p("skip")}function u(){p("cancel")}function g(b){b.key==="Enter"?f():b.key==="Escape"&&u()}return(b,m)=>($(),fe(Ne,{to:"body"},[B(ce,{name:"fade"},{default:ue(()=>[t.open?($(),x("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:He(u,["self"]),onKeydown:g},[n("div",it,[m[1]||(m[1]=n("h2",{class:"text-lg font-semibold mb-2"},"Name This Recording",-1)),m[2]||(m[2]=n("p",{class:"text-preke-text-dim text-sm mb-4"}," Give your recording a name to find it easily later (optional). ",-1)),pe(n("input",{ref_key:"inputRef",ref:l,"onUpdate:modelValue":m[0]||(m[0]=v=>i.value=v),type:"text",placeholder:s.value,class:"w-full px-4 py-2 bg-preke-bg-surface border border-preke-bg-surface rounded-lg text-preke-text placeholder-preke-text-dim focus:outline-none focus:ring-2 focus:ring-preke-gold"},null,8,lt),[[ke,i.value]]),n("p",ct," Suggested: "+R(s.value),1),n("div",{class:"flex justify-between mt-6"},[n("button",{onClick:y,class:"text-sm text-preke-text-dim hover:text-preke-text transition-colors"}," Skip (use default) "),n("div",{class:"flex gap-3"},[n("button",{onClick:u,class:"btn"}," Cancel "),n("button",{onClick:f,class:"btn btn-primary"}," Start Recording ")])])])],32)):E("",!0)]),_:1})]))}}),dt=q(ut,[["__scopeId","data-v-2eeca4e8"]]),ft={class:"recorder-controls"},pt={key:0,class:"recorder-controls__duration"},vt=["disabled","title"],gt={key:0,class:"recorder-controls__spinner"},mt={key:0,class:"recorder-controls__icon recorder-controls__icon--stop"},_t={key:1,class:"recorder-controls__icon recorder-controls__icon--record"},ht={class:"recorder-controls__hint"},bt=V({__name:"RecorderControls",setup(t){const e=N(),{register:a}=Ue(),{preflightCheck:p,status:i,canStartRecording:l}=Je(),{playRecordStart:r,playRecordStop:s,playError:f,playWarning:y,vibrate:u}=rt(),g=k(null),b=k(!1),m=k(!1),v=k(!1),w=k(!1),d=k(void 0),h=C(()=>e.status==="recording"),o=C(()=>e.status==="starting"),c=C(()=>e.status==="stopping"),_=C(()=>e.formattedDuration),D=C(()=>o.value||c.value||m.value),Se=C(()=>o.value?"Starting recording...":c.value?"Stopping recording...":m.value?"Checking disk space...":!h.value&&!l.value?"Insufficient disk space":"");let te=null;z(()=>{te=a({key:" ",description:"Toggle Recording",action:Te,context:"recorder",enabled:()=>!o.value&&!c.value})}),ee(()=>{te&&te()});async function Te(){h.value?_e():await K()}async function K(T){m.value=!0;try{const P=await p();if(!P.ok){f(),u(200),U.error("Cannot start recording",P.message||"Preflight check failed");return}if(P.message&&i.value==="warning"&&(y(),U.warning("Low disk space",P.message)),w.value&&!T){d.value=void 0,v.value=!0;return}await me(T||d.value)}finally{m.value=!1}}async function me(T){try{await e.startRecording(T);const P=T||e.sessionId;r(),u([50,30,50]),U.success("Recording started",`Session: ${P}`)}catch(P){f(),u(200),U.error("Failed to start recording",P.message||"Unknown error",{label:"Retry",onClick:()=>K(T)})}}function Me(T){v.value=!1,d.value=T,K(T)}function Ee(){v.value=!1,d.value=void 0,K()}function Pe(){v.value=!1,m.value=!1}async function Ae(){try{await e.stopRecording(),s(),u(100),U.success("Recording stopped",`Duration: ${_.value}`)}catch(T){f(),u(200),U.error("Failed to stop recording",T.message||"Unknown error")}}function _e(){var T;b.value=!1,(T=g.value)==null||T.open(),setTimeout(()=>{b.value=!0},500)}function Le(){b.value&&Ae()}async function De(){h.value?_e():await me()}return(T,P)=>($(),x(G,null,[n("div",ft,[h.value?($(),x("div",pt,R(_.value),1)):E("",!0),n("button",{onClick:De,disabled:D.value,class:M(["recorder-controls__btn",h.value?"recorder-controls__btn--stop":"recorder-controls__btn--start"]),title:Se.value||(h.value?"Stop Recording (Space)":"Start Recording (Space)")},[o.value||c.value||m.value?($(),x("span",gt)):($(),x(G,{key:1},[h.value?($(),x("span",mt)):($(),x("span",_t))],64)),n("span",null,R(m.value?"Checking...":h.value?"Stop":"Start Recording"),1)],10,vt),n("span",ht,[P[0]||(P[0]=de(" Press ",-1)),P[1]||(P[1]=n("kbd",null,"Space",-1)),de(" to "+R(h.value?"stop":"start"),1)])]),B($e,{ref_key:"stopConfirmDialog",ref:g,title:"Stop Recording?",message:`You have been recording for ${_.value}. This will finalize all files.`,"confirm-text":"Stop Recording","cancel-text":"Keep Recording",danger:!0,onConfirm:Le},null,8,["message"]),B(dt,{open:v.value,onConfirm:Me,onSkip:Ee,onCancel:Pe},null,8,["open"])],64))}}),wt=q(bt,[["__scopeId","data-v-38c04e0c"]]),Y=k(localStorage.getItem("r58_performance_mode")==="true"),re=k(localStorage.getItem("r58_performance_mode_auto")!=="false"),yt=3,kt=100,$t=500;function Ct(){const t=N(),e=C(()=>Y.value?!0:re.value&&t.isRecording?t.inputs.filter(g=>g.isRecording).length>=yt:!1),a=C(()=>e.value?$t:kt);H(e,u=>{u?document.body.classList.add("performance-mode"):document.body.classList.remove("performance-mode")},{immediate:!0});function p(u){Y.value=u,localStorage.setItem("r58_performance_mode",String(u))}function i(u){re.value=u,localStorage.setItem("r58_performance_mode_auto",String(u))}function l(){p(!Y.value)}function r(u,g){let b=0,m=null;return(...v)=>{const w=Date.now(),d=g??a.value,h=w-b;h>=d?(b=w,u(...v)):m||(m=window.setTimeout(()=>{b=Date.now(),m=null,u(...v)},d-h))}}function s(u,g){let b=null;return(...m)=>{b&&clearTimeout(b),b=window.setTimeout(()=>{u(...m),b=null},g??a.value)}}function f(u){return e.value?window.setTimeout(()=>u(performance.now()),a.value):requestAnimationFrame(u)}function y(u){e.value?clearTimeout(u):cancelAnimationFrame(u)}return{enabled:Y,autoEnable:re,isActive:e,updateInterval:a,setEnabled:p,setAutoEnable:i,toggle:l,throttle:r,debounce:s,requestFrame:f,cancelFrame:y}}const xt=["title"],Rt={class:"flex items-center gap-1.5 text-sm"},St={key:0,class:"flex items-center gap-1.5 text-sm"},Tt={key:1,class:"flex items-center gap-1.5 text-sm text-red-400"},Mt={class:"font-mono"},Et=V({__name:"RecordingHealth",setup(t,{expose:e}){const a=N(),{isActive:p}=Ct(),i=k({}),l=k(0),r=k(0),s=k(0);let f=null;function y(){const v={};let w=0;a.inputs.forEach(h=>{v[h.id]=h.bytesWritten;const o=i.value[h.id]||0;w+=h.bytesWritten-o});const d=p.value?2:1;l.value=Math.round(w/(1024*1024)/d*10)/10,i.value=v}H(()=>a.isRecording,v=>{if(v){i.value={},l.value=0,r.value=0,s.value=0;const w=p.value?2e3:1e3;f=window.setInterval(y,w)}else f&&(clearInterval(f),f=null)},{immediate:!0}),H(p,v=>{if(a.isRecording&&f){clearInterval(f);const w=v?2e3:1e3;f=window.setInterval(y,w)}}),ee(()=>{f&&clearInterval(f)});const u=C(()=>a.isRecording?s.value>0||r.value>90?"critical":l.value<1||r.value>70?"warning":"healthy":"idle"),g=C(()=>{switch(u.value){case"healthy":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}});C(()=>{switch(u.value){case"healthy":return"Healthy";case"warning":return"Warning";case"critical":return"Critical";default:return"Idle"}});const b=C(()=>{if(!a.isRecording)return"Not recording";const v=[`Write speed: ${l.value} MB/s`,`Buffer: ${r.value}%`];return s.value>0&&v.push(`Frames dropped: ${s.value}`),v.join(`
`)});function m(v){v.buffer_percent!==void 0&&(r.value=v.buffer_percent),v.frames_dropped!==void 0&&(s.value=v.frames_dropped)}return e({updateFromMetrics:m}),(v,w)=>J(a).isRecording?($(),x("div",{key:0,class:M(["flex items-center gap-3 px-3 py-1.5 rounded-lg transition-colors cursor-help",{"bg-emerald-500/10":g.value==="emerald","bg-amber-500/10":g.value==="amber","bg-red-500/10":g.value==="red"}]),title:b.value},[n("span",{class:M(["w-2 h-2 rounded-full",g.value==="emerald"?"bg-emerald-500":"",g.value==="amber"?"bg-amber-500 animate-pulse":"",g.value==="red"?"bg-red-500 animate-pulse":""])},null,2),n("div",Rt,[w[0]||(w[0]=n("svg",{class:"w-3.5 h-3.5 text-preke-text-dim",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})],-1)),n("span",{class:M(["font-mono",g.value==="emerald"?"text-emerald-400":"",g.value==="amber"?"text-amber-400":"",g.value==="red"?"text-red-400":""])},R(l.value)+" MB/s ",3)]),r.value>0?($(),x("div",St,[w[1]||(w[1]=n("span",{class:"text-preke-text-dim"},"Buf:",-1)),n("span",{class:M(["font-mono",r.value<50?"text-emerald-400":"",r.value>=50&&r.value<80?"text-amber-400":"",r.value>=80?"text-red-400":""])},R(r.value)+"% ",3)])):E("",!0),s.value>0?($(),x("div",Tt,[w[2]||(w[2]=n("svg",{class:"w-3.5 h-3.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),n("span",Mt,R(s.value)+" dropped",1)])):E("",!0)],10,xt)):E("",!0)}});function we(t){return t.startsWith("192.168.")||t.startsWith("10.")||t.startsWith("172.")||t.startsWith("100.")||t==="127.0.0.1"||t==="localhost"}const Pt=5,At=1e3,Lt=3e4,Dt=()=>typeof window<"u"&&window.__NETWORK_DEBUG__===!0,ye=new Map,Bt=1e3;function X(t,e,...a){if(!Dt())return;const p=Date.now(),i=ye.get(t)||0;p-i<Bt||(ye.set(t,p),console.log(`[NETWORK DEBUG ${t}] ${e}`,...a))}const W=new Map,I=new Map;async function Wt(t){const e=Z(),a=Ce();if(e&&!a)try{return`http://${new URL(e).hostname}:8889/${t}/whep`}catch{console.warn("[WHEP Manager] Invalid device URL, falling back to FRP")}if(typeof window<"u"&&window.location.hostname==="app.itagenten.no")return console.log("[WHEP Manager] Browser access from app.itagenten.no, using same-domain proxy"),`https://app.itagenten.no/${t}/whep`;const{getFrpUrl:p}=await Fe(async()=>{const{getFrpUrl:l}=await import("./index-BMV0MFpw.js").then(r=>r.a3);return{getFrpUrl:l}},__vite__mapDeps([0,1])),i=await p();if(i)try{const l=new URL(i);return l.hostname.includes("mediamtx")?`${i}/${t}/whep`:`https://${l.hostname.replace("api","mediamtx")}/${t}/whep`}catch{console.warn("[WHEP Manager] Invalid FRP URL, cannot build WHEP URL")}throw new Error("No device configured and no FRP fallback available")}async function Ht(t,e){const a=W.get(e);if(!a)return"unknown";try{const l=new URL(a.whepUrl).hostname;if(l.includes("itagenten.no"))return console.log(`[WHEP Manager ${e}] Detected relay (FRP URL)`),"relay";if(we(l))return console.log(`[WHEP Manager ${e}] Detected P2P (private IP: ${l})`),"p2p"}catch(i){console.warn(`[WHEP Manager ${e}] Failed to parse WHEP URL:`,i)}try{const i=await t.getStats();for(const l of i.values())if(l.type==="candidate-pair"&&l.state==="succeeded"){const r=i.get(l.remoteCandidateId);if((r==null?void 0:r.candidateType)==="relay")return console.log(`[WHEP Manager ${e}] Detected relay (TURN candidate)`),"relay";const s=r==null?void 0:r.address;if(s&&!we(s))return console.log(`[WHEP Manager ${e}] Detected relay (public IP: ${s})`),"relay"}}catch(i){console.warn(`[WHEP Manager ${e}] Failed to get WebRTC stats:`,i)}return Z()&&!Ce()?(console.log(`[WHEP Manager ${e}] Assuming P2P (direct device URL configured)`),"p2p"):"unknown"}function F(t){const e=W.get(t);if(!e)return;const a=I.get(t);a&&a.forEach(p=>p(e))}function ie(t){const e=W.get(t);if(!e)return;if(e.reconnectAttempts>=Pt){console.error(`[WHEP Manager ${t}] Max reconnect attempts reached`),e.state="failed",F(t);return}e.reconnectAttempts++;const a=Math.min(At*Math.pow(2,e.reconnectAttempts-1),Lt),p=a*.2*(Math.random()*2-1),i=Math.max(100,Math.round(a+p));X("WHEP",`Camera ${t}: Reconnect #${e.reconnectAttempts} in ${i}ms (base: ${a}ms)`),console.log(`[WHEP Manager ${t}] Scheduling reconnect #${e.reconnectAttempts} in ${i}ms`),e.state="connecting",F(t),e.reconnectTimeout&&clearTimeout(e.reconnectTimeout),e.reconnectTimeout=setTimeout(()=>{ge(t)},i)}async function ge(t){let e=W.get(t);if(e&&(e.state==="connected"||e.state==="connecting"))return console.log(`[WHEP Manager ${t}] Reusing existing connection (state: ${e.state})`),e;if(e!=null&&e.isConnecting){for(X("WHEP",`Camera ${t}: Connection already in progress, skipping duplicate attempt`),console.log(`[WHEP Manager ${t}] Connection already in progress, waiting...`);e.isConnecting&&e.state==="connecting"&&(await new Promise(s=>setTimeout(s,100)),e=W.get(t),!!e););if(e)return e}const a=typeof window<"u"&&window.location.hostname==="app.itagenten.no";let p=Z();if(a)console.log(`[WHEP Manager ${t}] Browser mode - using MediaMTX proxy`);else{let s=0;for(;!p&&s<5;)console.log(`[WHEP Manager ${t}] No device URL yet, waiting... (attempt ${s+1})`),await new Promise(f=>setTimeout(f,100)),p=Z(),s++}const i=performance.now(),l=await Wt(t);X("WHEP",`Camera ${t}: Creating connection to ${l}`),console.log(`[WHEP Manager ${t}] Creating connection to: ${l}`),console.log(`[WHEP Manager ${t}] Device URL was: ${p||"none (browser mode)"}`),e!=null&&e.peerConnection&&e.peerConnection.close(),e!=null&&e.disconnectedTimeout&&(clearTimeout(e.disconnectedTimeout),e.disconnectedTimeout=null),e&&(e.isConnecting=!0);const r=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}]});e?(e.peerConnection=r,e.state="connecting",e.whepUrl=l,e.mediaStream=null,e.connectionType="unknown",e.connectionStartTime=i,e.isConnecting=!0):(e={cameraId:t,peerConnection:r,mediaStream:null,state:"connecting",connectionType:"unknown",refCount:0,whepUrl:l,lastConnectedAt:null,reconnectAttempts:0,reconnectTimeout:null,disconnectedTimeout:null,connectionStartTime:i,isConnecting:!0},W.set(t,e)),r.ontrack=s=>{s.streams[0]&&(e.mediaStream=s.streams[0],console.log(`[WHEP Manager ${t}] Received media stream`),F(t))},r.oniceconnectionstatechange=async()=>{const s=r.iceConnectionState;if(X("WHEP",`Camera ${t}: ICE state changed to ${s}`),console.log(`[WHEP Manager ${t}] ICE state: ${s}`),s==="connected"||s==="completed"){e.state="connected",e.lastConnectedAt=Date.now(),e.reconnectAttempts=0,e.isConnecting=!1,e.connectionType=await Ht(r,t),e.disconnectedTimeout&&(clearTimeout(e.disconnectedTimeout),e.disconnectedTimeout=null);const f=e.connectionStartTime?Math.round(performance.now()-e.connectionStartTime):0;console.log(`[WHEP Manager ${t}] Connected (${e.connectionType}) in ${f}ms`),F(t)}else s==="failed"?(e.state="failed",e.connectionType="unknown",e.isConnecting=!1,F(t),e.refCount>0&&ie(t)):s==="disconnected"&&(e.disconnectedTimeout&&clearTimeout(e.disconnectedTimeout),e.disconnectedTimeout=setTimeout(()=>{(r.iceConnectionState==="disconnected"||r.iceConnectionState==="failed")&&(e.state="disconnected",e.isConnecting=!1,F(t),e.refCount>0&&ie(t)),e.disconnectedTimeout=null},3e3))},r.addTransceiver("video",{direction:"recvonly"}),r.addTransceiver("audio",{direction:"recvonly"});try{const s=await r.createOffer();await r.setLocalDescription(s);const f=await fetch(l,{method:"POST",headers:{"Content-Type":"application/sdp"},body:s.sdp});if(!f.ok)throw new Error(`WHEP request failed: ${f.status}`);const y=await f.text();await r.setRemoteDescription({type:"answer",sdp:y})}catch(s){console.error(`[WHEP Manager ${t}] Connection error:`,s),e.state="failed",e.isConnecting=!1,F(t),e.refCount>0&&ie(t)}return e}async function Nt(t,e){I.has(t)||I.set(t,new Set),I.get(t).add(e);let a=W.get(t);return(!a||a.state==="failed"||a.state==="disconnected")&&(a=await ge(t)),a.refCount++,console.log(`[WHEP Manager ${t}] Acquired connection (refCount: ${a.refCount})`),e(a),a}function Ut(t,e){const a=W.get(t);if(!a)return;const p=I.get(t);p&&(p.delete(e),p.size===0&&I.delete(t)),a.refCount=Math.max(0,a.refCount-1),console.log(`[WHEP Manager ${t}] Released connection (refCount: ${a.refCount})`),a.refCount===0&&(console.log(`[WHEP Manager ${t}] Closing unused connection`),a.reconnectTimeout&&clearTimeout(a.reconnectTimeout),a.disconnectedTimeout&&clearTimeout(a.disconnectedTimeout),a.peerConnection.close(),W.delete(t))}function le(t){const e=W.get(t);e&&(console.log(`[WHEP Manager ${t}] Force reconnecting...`),e.reconnectAttempts=0,ge(t))}const Ft={class:"relative w-full h-full bg-black"},Gt=["title"],Vt={key:1,class:"absolute inset-0 flex items-center justify-center bg-black/50"},It={key:2,class:"absolute inset-0 flex items-center justify-center bg-black/70"},Ot={class:"text-center"},jt={class:"text-xs text-amber-400"},zt={key:3,class:"absolute inset-0 flex items-center justify-center bg-black/80"},qt={class:"text-center text-preke-text-dim"},Kt={class:"text-sm"},Qt=V({__name:"InputPreview",props:{inputId:{},protocol:{}},emits:["videoReady","aspectRatio"],setup(t,{emit:e}){const a=t,p=e,i=N();let l=!1;const r=C(()=>i.status==="recording"),s=k(null),f=k(!0),y=k(null),u=k("unknown"),g=k(!1),b=k(0);let m=null;function v(o){switch(console.log(`[InputPreview ${a.inputId}] Connection update:`,{state:o.state,type:o.connectionType,hasStream:!!o.mediaStream}),u.value=o.connectionType,b.value=o.reconnectAttempts,o.state){case"connecting":f.value=!0,y.value=null,g.value=o.reconnectAttempts>0;break;case"connected":f.value=!1,y.value=null,g.value=!1,o.mediaStream&&s.value&&s.value.srcObject!==o.mediaStream&&(s.value.srcObject=o.mediaStream,s.value.play().catch(c=>{console.warn(`[InputPreview ${a.inputId}] Autoplay prevented:`,c)}),l||(s.value.onloadeddata=()=>{if(!l&&s.value){l=!0;const c=s.value.videoWidth,_=s.value.videoHeight,D=c&&_?c/_:16/9;console.log(`[InputPreview ${a.inputId}] Video ready (${c}x${_}, ratio: ${D.toFixed(3)})`),p("aspectRatio",D),p("videoReady")}}));break;case"disconnected":g.value=!0,y.value=`Reconnecting... (${o.reconnectAttempts}/5)`;break;case"failed":f.value=!1,g.value=!1,y.value="Connection failed after multiple attempts";break}}async function w(){if(s.value){h(),f.value=!0,y.value=null,m=v;try{await Nt(a.inputId,m)}catch(o){console.error(`[InputPreview ${a.inputId}] Failed to acquire connection:`,o),y.value=o instanceof Error?o.message:"Failed to connect",f.value=!1}}}function d(){le(a.inputId)}function h(){m&&(Ut(a.inputId,m),m=null)}return z(()=>{w()}),H(()=>a.inputId,()=>{w()}),H(r,(o,c)=>{c&&!o&&y.value?(console.log("[InputPreview] Recording stopped, reconnecting preview..."),le(a.inputId)):!c&&o&&(console.log("[InputPreview] Recording started, will try to reconnect preview after delay..."),setTimeout(()=>{r.value&&(console.log("[InputPreview] Attempting to reconnect preview during recording..."),le(a.inputId))},2e3))}),ee(()=>{h()}),(o,c)=>($(),x("div",Ft,[n("video",{ref_key:"videoRef",ref:s,autoplay:"",muted:"",playsinline:"",class:"w-full h-full object-contain"},null,512),!f.value&&!y.value&&u.value!=="unknown"?($(),x("div",{key:0,class:M(["absolute top-1 right-1 px-1.5 py-0.5 text-[10px] font-medium rounded",u.value==="p2p"?"bg-emerald-500/80 text-white":"bg-amber-500/80 text-white"]),title:u.value==="p2p"?"Direct P2P connection":"Relay connection (FRP)"},R(u.value==="p2p"?"P2P":"RELAY"),11,Gt)):E("",!0),f.value&&!g.value?($(),x("div",Vt,[...c[0]||(c[0]=[n("div",{class:"animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"},null,-1)])])):E("",!0),g.value?($(),x("div",It,[n("div",Ot,[c[1]||(c[1]=n("div",{class:"animate-spin w-5 h-5 border-2 border-amber-400 border-t-transparent rounded-full mx-auto mb-2"},null,-1)),n("p",jt,R(y.value||"Reconnecting..."),1)])])):y.value&&!f.value?($(),x("div",zt,[n("div",qt,[n("p",Kt,R(y.value),1),n("button",{onClick:d,class:"mt-2 text-xs text-preke-gold hover:underline"}," Retry ")])])):E("",!0)]))}}),Yt={key:0,class:"h-full flex items-center justify-center"},Xt={key:1,class:"input-grid"},Jt={key:0,class:"input-grid__warning"},Zt=["data-count"],en=["title"],tn={key:1,class:"w-full h-full flex items-center justify-center bg-preke-bg-surface"},nn={class:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-4"},on={class:"flex items-center justify-between"},an={class:"flex items-center gap-2"},sn={class:"font-medium"},rn={key:0,class:"flex items-center gap-2 text-sm"},ln={class:"text-preke-text-dim"},cn=V({__name:"InputGrid",emits:["allVideosReady"],setup(t,{emit:e}){const a=N(),p=ve(),i=e,l=k(new Set),r=k({});function s(o){l.value.add(o),console.log(`[InputGrid] Video ready: ${o} (${l.value.size}/${g.value.length})`),l.value.size>=g.value.length&&(console.log("[InputGrid] All videos ready!"),i("allVideosReady"))}function f(o,c){r.value[o]=c,console.log(`[InputGrid] Aspect ratio for ${o}: ${c.toFixed(3)}`)}function y(o){return{aspectRatio:`${r.value[o]||1.7777777777777777}`}}H(()=>g.value.length,()=>{l.value.clear()});const u=C(()=>{var o;return((o=p.capabilities)==null?void 0:o.current_mode)==="recorder"}),g=C(()=>a.inputs.filter(o=>o.hasSignal)),b=C(()=>a.framerateMismatch);function m(o){return o.isRecording?"border-preke-red ring-2 ring-preke-red/20":o.hasSignal?"border-emerald-500/50 hover:border-emerald-500":"border-preke-bg-surface/50 opacity-60"}function v(o){return o.hasSignal?o.framerate>=29?"excellent":o.framerate>=24?"good":"unstable":"none"}function w(o){switch(v(o)){case"excellent":return"text-emerald-400";case"good":return"text-emerald-400";case"unstable":return"text-amber-400";case"none":return"text-preke-text-dim"}}function d(o){if(o===0)return"0 B";const c=1024,_=["B","KB","MB","GB"],D=Math.floor(Math.log(o)/Math.log(c));return parseFloat((o/Math.pow(c,D)).toFixed(1))+" "+_[D]}function h(o){if(!o.hasSignal)return`${o.label}: No signal detected`;const c=[`${o.label}`,`Resolution: ${o.resolution}`,`Framerate: ${o.framerate} fps`,`Quality: ${v(o)}`];return o.isRecording&&c.push(`Written: ${d(o.bytesWritten)}`),c.join(`
`)}return(o,c)=>g.value.length===0?($(),x("div",Yt,[...c[0]||(c[0]=[Ge('<div class="text-center text-preke-text-dim" data-v-206e9703><svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-206e9703><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" data-v-206e9703></path></svg><p class="text-lg font-medium" data-v-206e9703>No Video Sources Connected</p><p class="text-sm mt-2" data-v-206e9703>Connect HDMI cables to begin recording</p></div>',1)])])):($(),x("div",Xt,[b.value?($(),x("div",Jt,[c[1]||(c[1]=n("svg",{class:"w-4 h-4 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20"},[n("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),n("span",null,R(b.value),1)])):E("",!0),n("div",{class:"input-grid__container","data-count":g.value.length},[($(!0),x(G,null,xe(g.value,_=>($(),x("div",{key:_.id,class:M(["input-grid__tile",m(_)]),style:Ve(y(_.id)),title:h(_)},[u.value?($(),fe(Qt,{key:0,"input-id":_.id,class:"w-full h-full",onVideoReady:D=>s(_.id),onAspectRatio:D=>f(_.id,D)},null,8,["input-id","onVideoReady","onAspectRatio"])):($(),x("div",tn,[...c[2]||(c[2]=[n("div",{class:"text-center"},[n("svg",{class:"w-8 h-8 mx-auto mb-2 text-preke-text-dim/50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})]),n("span",{class:"text-xs text-preke-text-dim/70"},"Mixer mode")],-1)])])),n("div",nn,[n("div",on,[n("div",an,[n("span",{class:M(["w-2 h-2 rounded-full transition-colors",{"bg-emerald-500":v(_)==="excellent"||v(_)==="good","bg-amber-500 animate-pulse":v(_)==="unstable","bg-preke-text-dim":v(_)==="none"}])},null,2),n("span",sn,R(_.label),1)]),_.hasSignal?($(),x("div",rn,[n("span",ln,R(_.resolution),1),n("span",{class:M(w(_))},R(_.framerate)+"fps",3)])):E("",!0)])])],14,en))),128))],8,Zt)]))}}),un=q(cn,[["__scopeId","data-v-206e9703"]]),dn={class:"sidebar"},fn={class:"sidebar__card sidebar__card--header"},pn={class:"connection-row"},vn={class:"connection-status"},gn={class:"connection-label"},mn={key:0,class:"connection-latency"},_n=["disabled"],hn={class:"sidebar__card sidebar__card--recording"},bn={class:"recording__duration"},wn={class:"recording__meta"},yn={key:0,class:"sidebar__card sidebar__card--warning"},kn={class:"warning__text"},$n={class:"sidebar__card"},Cn={class:"cameras"},xn={class:"camera__header"},Rn={class:"camera__controls"},Sn=["onClick"],Tn={class:"camera__btn-label"},Mn=["onClick"],En={class:"camera__btn-label"},Pn=["onClick"],An={class:"camera__btn-label"},Ln=["onClick"],Dn={class:"camera__btn-label"},Bn=V({__name:"SessionInfoV2",setup(t){const e=Re(),a=N(),p=ve(),{state:i,latencyMs:l}=Ie(),{connectionMethod:r}=Oe(),s=C(()=>{const w=i.value==="connected",d=i.value==="connecting",h=i.value==="degraded";if(w){let o="";return r.value==="relay"?o="Relay":r.value==="p2p"?o="P2P":r.value==="local"&&(o="Local"),{status:"online",color:"green",label:o||"Connected",latency:l.value,pulse:!1}}return d?{status:"connecting",color:"amber",label:"Connecting...",latency:null,pulse:!0}:h?{status:"degraded",color:"amber",label:"Slow",latency:l.value,pulse:!1}:{status:"offline",color:"red",label:"Offline",latency:null,pulse:!0}});C(()=>a.currentSession),C(()=>a.activeInputs);const f=C(()=>a.isRecording),y=C(()=>a.inputs.filter(w=>w.isRecording)),u=k("");z(()=>{const d=new Date().toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,".");u.value=`Session ${d}`});const g=k([{id:"cam1",name:"CAM 1",focus:"auto",wb:"auto",shutter:"auto",aperture:"auto"},{id:"cam2",name:"CAM 2",focus:"auto",wb:"auto",shutter:"auto",aperture:"auto"},{id:"cam3",name:"CAM 3",focus:"auto",wb:"auto",shutter:"auto",aperture:"auto"},{id:"cam4",name:"CAM 4",focus:"auto",wb:"auto",shutter:"auto",aperture:"auto"}]);function b(w,d){const h=g.value[w];h&&(h[d]=h[d]==="auto"?"manual":"auto")}const m=C(()=>{const w=p.capabilities;if(!w)return null;const d=w.storage_used_gb||0,h=w.storage_total_gb||1,o=h-d,c=Math.round(d/h*100),_=o/10;return{freeGB:Math.round(o),totalGB:Math.round(h),percent:c,hoursRemaining:Math.round(_*10)/10,isLow:c>85,isCritical:c>95}});function v(){e.push({name:"admin",query:{tab:"settings"}})}return(w,d)=>{var h;return $(),x("div",dn,[n("div",fn,[n("div",pn,[n("div",vn,[n("span",{class:M(["connection-dot",[`connection-dot--${s.value.color}`,{"connection-dot--pulse":s.value.pulse}]])},null,2),n("span",gn,R(s.value.label),1),s.value.latency?($(),x("span",mn,R(s.value.latency)+"ms ",1)):E("",!0)])]),d[1]||(d[1]=n("div",{class:"sidebar__divider"},null,-1)),d[2]||(d[2]=n("label",{class:"sidebar__label"},"Session Name",-1)),pe(n("input",{"onUpdate:modelValue":d[0]||(d[0]=o=>u.value=o),type:"text",class:"sidebar__input",placeholder:"Session 06.01.2026",disabled:f.value},null,8,_n),[[ke,u.value]])]),f.value?($(),x(G,{key:0},[n("div",hn,[d[3]||(d[3]=n("div",{class:"recording__header"},[n("span",{class:"recording__dot"}),n("span",{class:"recording__label"},"Recording")],-1)),n("div",bn,R(J(a).formattedDuration),1),n("div",wn,R(y.value.length)+" camera"+R(y.value.length!==1?"s":"")+" recording ",1)]),(h=m.value)!=null&&h.isLow?($(),x("div",yn,[d[5]||(d[5]=n("span",{class:"warning__icon"},"⚠️",-1)),n("div",kn,[d[4]||(d[4]=n("strong",null,"Low storage",-1)),n("span",null,R(m.value.freeGB)+" GB remaining",1)])])):E("",!0)],64)):($(),x(G,{key:1},[n("div",$n,[d[10]||(d[10]=n("div",{class:"sidebar__label"},"Camera Controls",-1)),n("div",Cn,[($(!0),x(G,null,xe(g.value,(o,c)=>($(),x("div",{key:o.id,class:"camera"},[n("div",xn,R(o.name),1),n("div",Rn,[n("button",{class:M(["camera__btn",{"camera__btn--auto":o.focus==="auto"}]),onClick:_=>b(c,"focus"),title:"Focus"},[d[6]||(d[6]=n("span",{class:"camera__btn-icon"},"◎",-1)),n("span",Tn,R(o.focus==="auto"?"A":"M"),1)],10,Sn),n("button",{class:M(["camera__btn",{"camera__btn--auto":o.wb==="auto"}]),onClick:_=>b(c,"wb"),title:"White Balance"},[d[7]||(d[7]=n("span",{class:"camera__btn-icon"},"☀",-1)),n("span",En,R(o.wb==="auto"?"A":"M"),1)],10,Mn),n("button",{class:M(["camera__btn",{"camera__btn--auto":o.shutter==="auto"}]),onClick:_=>b(c,"shutter"),title:"Shutter"},[d[8]||(d[8]=n("span",{class:"camera__btn-icon"},"⏱",-1)),n("span",An,R(o.shutter==="auto"?"A":"M"),1)],10,Pn),n("button",{class:M(["camera__btn",{"camera__btn--auto":o.aperture==="auto"}]),onClick:_=>b(c,"aperture"),title:"Aperture"},[d[9]||(d[9]=n("span",{class:"camera__btn-icon"},"◐",-1)),n("span",Dn,R(o.aperture==="auto"?"A":"M"),1)],10,Ln)])]))),128))])]),n("div",{class:"sidebar__card"},[d[12]||(d[12]=n("div",{class:"sidebar__label"},"Quick Actions",-1)),n("button",{onClick:v,class:"sidebar__btn"},[...d[11]||(d[11]=[n("svg",{class:"sidebar__btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","stroke-width":"1.8"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),n("circle",{cx:"12",cy:"12",r:"3"})],-1),de(" Configure Inputs ",-1)])])])],64))])}}}),Wn=q(Bn,[["__scopeId","data-v-418534da"]]),Hn={class:"h-full flex flex-col"},Nn={class:"recorder-header"},Un={class:"recorder-header__left"},Fn={class:"recorder-header__title"},Gn={key:0,class:"recorder-header__badge"},Vn={class:"flex-1 flex min-h-0 overflow-hidden"},In={class:"flex-1 min-h-0 min-w-0 p-3 overflow-hidden"},On={class:"w-72 flex-shrink-0 border-l border-preke-surface-border bg-preke-surface/80 backdrop-blur-lg p-4 overflow-y-auto"},jn=V({__name:"RecorderView",setup(t){const e=Re(),a=N(),p=ve(),{showLeaveConfirmation:i,confirmLeave:l,cancelLeave:r}=Qe();function s(){e.push("/")}const f=C(()=>a.status==="recording"),y=C(()=>a.formattedDuration),u=k(!0),g=k(!1),b=k(!1),m=C(()=>g.value&&b.value);function v(){u.value=!1}async function w(){var c;if(!je())return;await p.fetchCapabilities();const o=(c=p.capabilities)==null?void 0:c.current_mode;if(o&&o!=="recorder"){console.log("[Recorder] Not in recorder mode, switching...");try{(await fetch(await ze("/api/mode/recorder"),{method:"POST"})).ok&&(await p.fetchCapabilities(),U.success("Switched to Recorder mode"))}catch(_){console.warn("[Recorder] Failed to switch mode:",_)}}}function d(){console.log("[Recorder] All videos ready!"),b.value=!0}z(async()=>{const o=performance.now();await Promise.all([w(),a.fetchInputs(),a.fetchStatus()]);const c=a.inputs.filter(_=>_.hasSignal).length;console.log(`[Recorder] Data loaded: ${a.inputs.length} inputs, ${c} with signal (${Math.round(performance.now()-o)}ms)`),g.value=!0,c===0&&(b.value=!0)});const h=k(null);return H(i,o=>{var c,_;o?(c=h.value)==null||c.open():(_=h.value)==null||_.close()}),(o,c)=>($(),x(G,null,[B(ce,{name:"fade"},{default:ue(()=>[u.value?($(),fe(Ke,{key:0,mode:"recorder","content-ready":m.value,"min-time":1500,"max-time":5e3,"show-cancel":!0,onReady:v,onCancel:s},null,8,["content-ready"])):E("",!0)]),_:1}),B(ce,{name:"content-fade"},{default:ue(()=>[pe(n("div",Hn,[n("header",Nn,[n("div",Un,[n("div",Fn,[n("span",{class:M(["recorder-header__indicator",{"recorder-header__indicator--active":f.value}])},null,2),c[0]||(c[0]=n("span",{class:"recorder-header__label"},"Recorder",-1))]),f.value?($(),x("span",Gn," REC ")):E("",!0),B(Et)]),B(wt)]),n("div",Vn,[n("div",In,[B(un,{onAllVideosReady:d})]),n("aside",On,[B(Wn)])]),B($e,{ref_key:"leaveDialog",ref:h,title:"Recording in Progress",message:`You are currently recording (${y.value}). Leaving will stop the recording and save all files.`,"confirm-text":"Leave and Stop Recording","cancel-text":"Stay",danger:!0,onConfirm:J(l),onCancel:J(r)},null,8,["message","onConfirm","onCancel"])],512),[[qe,!u.value]])]),_:1})],64))}}),Kn=q(jn,[["__scopeId","data-v-a7fdeea3"]]);export{Kn as default};
