const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-3JfoDJ9v.js","assets/index-n7u0C3Yf.css"])))=>i.map(i=>d[i]);
import{r as h,D as J,E as Y,o as oe,l as ge,G as Fe,j as T,H as de,d as Z,I as ae,m as I,T as ve,p as ne,c as g,f as W,z as Pe,e,w as X,A as ce,t as $,J as Le,i as f,_ as le,K as Ue,h as ee,F as K,n as V,x as se,L as Ae,q as re,M as pe,N as Ve,O as De,u as xe,a as Be,y as me,B as je,P as He,Q as Ie,R as Ge,S as Oe,U as ze,V as qe,k as Ke,g as Ne,W as Ye,b as Qe,v as Xe}from"./index-3JfoDJ9v.js";import{u as Je,C as Ze,M as et}from"./ModeLoadingScreen-BEetp4uN.js";function tt(){const n=h(!1),t=h(!1);let o=null;const m=J();Y(()=>m.status,a=>{n.value=a==="recording"},{immediate:!0});function i(a){if(n.value)return a.preventDefault(),a.returnValue="Recording in progress. Are you sure you want to leave?",a.returnValue}oe(()=>{window.addEventListener("beforeunload",i)}),ge(()=>{window.removeEventListener("beforeunload",i)}),Fe((a,r,d)=>{n.value?(o=()=>d(),t.value=!0,d(!1)):d()});function c(){t.value=!1,n.value=!1,m.stopRecording().finally(()=>{o&&(o(),o=null)})}function s(){t.value=!1,o=null}return{isGuardActive:n,showLeaveConfirmation:t,confirmLeave:c,cancelLeave:s}}const U=h(null),_e=h(!1),Re=h(null),he=h(null),nt=10,be=2,ot=25;function at(){const n=T(()=>U.value?U.value.available_gb<be?"critical":U.value.available_gb<nt?"warning":"ok":"unknown"),t=T(()=>U.value?U.value.available_gb>=be:!0),o=T(()=>{if(!U.value)return null;const a=U.value.available_gb*1024*1024*1024,r=ot*1024*1024,d=a/r,l=Math.floor(d/3600),C=Math.floor(d%3600/60);return l>24?`${Math.floor(l/24)}d ${l%24}h`:l>0?`${l}h ${C}m`:`${C}m`}),m=T(()=>{switch(n.value){case"ok":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}}),i=T(()=>U.value?n.value==="critical"?`Disk space critically low (${U.value.available_gb.toFixed(1)} GB). Cannot start recording.`:n.value==="warning"?`Low disk space (${U.value.available_gb.toFixed(1)} GB). Estimated recording time: ${o.value}`:null:null);async function c(){_e.value=!0,he.value=null;try{const a=await de.getDegradation();if(a.resources&&a.resources.disk_free_gb!==void 0){const r=a.resources.disk_free_gb,d=r*3;U.value={available_gb:r,total_gb:d,used_percent:100-r/d*100,recording_path:"/opt/r58-app/shared/recordings"}}return Re.value=new Date,U.value}catch(a){return he.value=a.message||"Failed to check disk space",console.error("Failed to check disk space:",a),null}finally{_e.value=!1}}async function s(){return await c(),U.value?n.value==="critical"?{ok:!1,message:`Insufficient disk space (${U.value.available_gb.toFixed(1)} GB). Need at least ${be} GB to start recording.`}:n.value==="warning"?{ok:!0,message:`Low disk space warning: ${U.value.available_gb.toFixed(1)} GB available. Estimated recording time: ${o.value}`}:{ok:!0}:{ok:!0,message:"Could not verify disk space. Proceeding with caution."}}return{diskSpace:U,isLoading:_e,lastCheck:Re,error:he,status:n,statusColor:m,canStartRecording:t,estimatedRecordingTime:o,warningMessage:i,checkDiskSpace:c,preflightCheck:s}}const z=h(localStorage.getItem("r58_audio_feedback")!=="false");let we=null;function st(){return we||(we=new(window.AudioContext||window.webkitAudioContext)),we}function G(n,t,o="sine",m=.3){if(z.value)try{const i=st();i.state==="suspended"&&i.resume();const c=i.createOscillator(),s=i.createGain();c.connect(s),s.connect(i.destination),c.type=o,c.frequency.value=n;const a=i.currentTime;s.gain.setValueAtTime(0,a),s.gain.linearRampToValueAtTime(m,a+.01),s.gain.linearRampToValueAtTime(0,a+t),c.start(a),c.stop(a+t)}catch(i){console.warn("Audio feedback failed:",i)}}function rt(){z.value&&(G(440,.1,"sine",.2),setTimeout(()=>G(554,.1,"sine",.2),100),setTimeout(()=>G(659,.15,"sine",.25),200))}function it(){z.value&&(G(880,.08,"sine",.3),setTimeout(()=>G(880,.15,"sine",.3),120))}function lt(){z.value&&(G(659,.1,"sine",.25),setTimeout(()=>G(554,.1,"sine",.2),100),setTimeout(()=>G(440,.15,"sine",.2),200))}function ct(){z.value&&(G(200,.15,"square",.15),setTimeout(()=>G(180,.2,"square",.15),180))}function ut(){z.value&&(G(1e3,.08,"sine",.2),setTimeout(()=>G(1e3,.08,"sine",.2),150))}function Se(){z.value&&G(1200,.03,"sine",.1)}function dt(n=50){if(z.value&&"vibrate"in navigator)try{navigator.vibrate(n)}catch{}}function ft(){function n(o){z.value=o,localStorage.setItem("r58_audio_feedback",String(o))}function t(){n(!z.value),z.value&&Se()}return{enabled:z,setEnabled:n,toggle:t,playSuccess:rt,playError:ct,playWarning:ut,playClick:Se,playRecordStart:it,playRecordStop:lt,vibrate:dt}}const vt={class:"bg-preke-bg-elevated rounded-lg shadow-xl max-w-md w-full p-6"},pt=["placeholder"],mt={class:"text-xs text-preke-text-dim mt-2"},gt=Z({__name:"SessionNameDialog",props:{open:{type:Boolean},suggestedName:{}},emits:["confirm","cancel","skip"],setup(n,{emit:t}){const o=n,m=t,i=h(""),c=h(null),s=T(()=>{const u=new Date,_=u.toLocaleDateString("en-CA"),v=u.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}).replace(":","");return`Recording_${_}_${v}`}),a=T(()=>o.suggestedName||s.value);Y(()=>o.open,u=>{u&&(i.value=a.value,setTimeout(()=>{var _,v;(_=c.value)==null||_.focus(),(v=c.value)==null||v.select()},100))});function r(){m("confirm",i.value.trim()||a.value)}function d(){m("skip")}function l(){m("cancel")}function C(u){u.key==="Enter"?r():u.key==="Escape"&&l()}return(u,_)=>(f(),ae(Le,{to:"body"},[I(ve,{name:"fade"},{default:ne(()=>[n.open?(f(),g("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:Pe(l,["self"]),onKeydown:C},[e("div",vt,[_[1]||(_[1]=e("h2",{class:"text-lg font-semibold mb-2"},"Name This Recording",-1)),_[2]||(_[2]=e("p",{class:"text-preke-text-dim text-sm mb-4"}," Give your recording a name to find it easily later (optional). ",-1)),X(e("input",{ref_key:"inputRef",ref:c,"onUpdate:modelValue":_[0]||(_[0]=v=>i.value=v),type:"text",placeholder:a.value,class:"w-full px-4 py-2 bg-preke-bg-surface border border-preke-bg-surface rounded-lg text-preke-text placeholder-preke-text-dim focus:outline-none focus:ring-2 focus:ring-preke-gold"},null,8,pt),[[ce,i.value]]),e("p",mt," Suggested: "+$(a.value),1),e("div",{class:"flex justify-between mt-6"},[e("button",{onClick:d,class:"text-sm text-preke-text-dim hover:text-preke-text transition-colors"}," Skip (use default) "),e("div",{class:"flex gap-3"},[e("button",{onClick:l,class:"btn"}," Cancel "),e("button",{onClick:r,class:"btn btn-primary"}," Start Recording ")])])])],32)):W("",!0)]),_:1})]))}}),_t=le(gt,[["__scopeId","data-v-2eeca4e8"]]),ht={class:"recorder-controls"},bt={key:0,class:"recorder-controls__duration"},wt=["disabled","title"],yt={key:0,class:"recorder-controls__spinner"},kt={key:0,class:"recorder-controls__icon recorder-controls__icon--stop"},Ct={key:1,class:"recorder-controls__icon recorder-controls__icon--record"},xt={class:"recorder-controls__hint"},$t=Z({__name:"RecorderControls",setup(n){const t=J(),{register:o}=Ue(),{preflightCheck:m,status:i,canStartRecording:c}=at(),{playRecordStart:s,playRecordStop:a,playError:r,playWarning:d,vibrate:l}=ft(),C=h(null),u=h(!1),_=h(!1),v=h(!1),R=h(!1),D=h(void 0),k=T(()=>t.status==="recording"),x=T(()=>t.status==="starting"),S=T(()=>t.status==="stopping"),B=T(()=>t.formattedDuration),b=T(()=>x.value||S.value||_.value),L=T(()=>x.value?"Starting recording...":S.value?"Stopping recording...":_.value?"Checking disk space...":!k.value&&!c.value?"Insufficient disk space":"");let A=null;oe(()=>{A=o({key:" ",description:"Toggle Recording",action:O,context:"recorder",enabled:()=>!x.value&&!S.value})}),ge(()=>{A&&A()});async function O(){k.value?w():await N()}async function N(P){_.value=!0;try{const F=await m();if(!F.ok){r(),l(200),ee.error("Cannot start recording",F.message||"Preflight check failed");return}if(F.message&&i.value==="warning"&&(d(),ee.warning("Low disk space",F.message)),R.value&&!P){D.value=void 0,v.value=!0;return}await Q(P||D.value)}finally{_.value=!1}}async function Q(P){try{await t.startRecording(P);const F=P||t.sessionId;s(),l([50,30,50]),ee.success("Recording started",`Session: ${F}`)}catch(F){r(),l(200),ee.error("Failed to start recording",F.message||"Unknown error",{label:"Retry",onClick:()=>N(P)})}}function H(P){v.value=!1,D.value=P,N(P)}function M(){v.value=!1,D.value=void 0,N()}function p(){v.value=!1,_.value=!1}async function E(){try{await t.stopRecording(),a(),l(100),ee.success("Recording stopped")}catch(P){r(),l(200),ee.error("Failed to stop recording",P.message||"Unknown error")}}function w(){var P;u.value=!1,(P=C.value)==null||P.open(),setTimeout(()=>{u.value=!0},500)}function y(){u.value&&E()}async function j(){k.value?w():await Q()}return(P,F)=>(f(),g(K,null,[e("div",ht,[k.value?(f(),g("div",bt,$(B.value),1)):W("",!0),e("button",{onClick:j,disabled:b.value,class:V(["recorder-controls__btn",k.value?"recorder-controls__btn--stop":"recorder-controls__btn--start"]),title:L.value||(k.value?"Stop Recording (Space)":"Start Recording (Space)")},[x.value||S.value||_.value?(f(),g("span",yt)):(f(),g(K,{key:1},[k.value?(f(),g("span",kt)):(f(),g("span",Ct))],64)),e("span",null,$(_.value?"Checking...":k.value?"Stop":"Start Recording"),1)],10,wt),e("span",xt,[F[0]||(F[0]=se(" Press ",-1)),F[1]||(F[1]=e("kbd",null,"Space",-1)),se(" to "+$(k.value?"stop":"start"),1)])]),I(Ae,{ref_key:"stopConfirmDialog",ref:C,title:"Stop Recording?",message:`You have been recording for ${B.value}. This will finalize all files.`,"confirm-text":"Stop Recording","cancel-text":"Keep Recording",danger:!0,onConfirm:y},null,8,["message"]),I(_t,{open:v.value,onConfirm:H,onSkip:M,onCancel:p},null,8,["open"])],64))}}),Rt=le($t,[["__scopeId","data-v-1e32920d"]]),ue=h(localStorage.getItem("r58_performance_mode")==="true"),ye=h(localStorage.getItem("r58_performance_mode_auto")!=="false"),St=3,Mt=100,Tt=500;function Et(){const n=J(),t=T(()=>ue.value?!0:ye.value&&n.isRecording?n.inputs.filter(C=>C.isRecording).length>=St:!1),o=T(()=>t.value?Tt:Mt);Y(t,l=>{l?document.body.classList.add("performance-mode"):document.body.classList.remove("performance-mode")},{immediate:!0});function m(l){ue.value=l,localStorage.setItem("r58_performance_mode",String(l))}function i(l){ye.value=l,localStorage.setItem("r58_performance_mode_auto",String(l))}function c(){m(!ue.value)}function s(l,C){let u=0,_=null;return(...v)=>{const R=Date.now(),D=C??o.value,k=R-u;k>=D?(u=R,l(...v)):_||(_=window.setTimeout(()=>{u=Date.now(),_=null,l(...v)},D-k))}}function a(l,C){let u=null;return(..._)=>{u&&clearTimeout(u),u=window.setTimeout(()=>{l(..._),u=null},C??o.value)}}function r(l){return t.value?window.setTimeout(()=>l(performance.now()),o.value):requestAnimationFrame(l)}function d(l){t.value?clearTimeout(l):cancelAnimationFrame(l)}return{enabled:ue,autoEnable:ye,isActive:t,updateInterval:o,setEnabled:m,setAutoEnable:i,toggle:c,throttle:s,debounce:a,requestFrame:r,cancelFrame:d}}const Pt=["title"],Lt={class:"flex items-center gap-1.5 text-sm"},At={key:0,class:"flex items-center gap-1.5 text-sm"},Dt={key:1,class:"flex items-center gap-1.5 text-sm text-red-400"},Bt={class:"font-mono"},Ht=Z({__name:"RecordingHealth",setup(n,{expose:t}){const o=J(),{isActive:m}=Et(),i=h({}),c=h(0),s=h(0),a=h(0);let r=null;function d(){const v={};let R=0;o.inputs.forEach(k=>{v[k.id]=k.bytesWritten;const x=i.value[k.id]||0;R+=k.bytesWritten-x});const D=m.value?2:1;c.value=Math.round(R/(1024*1024)/D*10)/10,i.value=v}Y(()=>o.isRecording,v=>{if(v){i.value={},c.value=0,s.value=0,a.value=0;const R=m.value?2e3:1e3;r=window.setInterval(d,R)}else r&&(clearInterval(r),r=null)},{immediate:!0}),Y(m,v=>{if(o.isRecording&&r){clearInterval(r);const R=v?2e3:1e3;r=window.setInterval(d,R)}}),ge(()=>{r&&clearInterval(r)});const l=T(()=>o.isRecording?a.value>0||s.value>90?"critical":c.value<1||s.value>70?"warning":"healthy":"idle"),C=T(()=>{switch(l.value){case"healthy":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}});T(()=>{switch(l.value){case"healthy":return"Healthy";case"warning":return"Warning";case"critical":return"Critical";default:return"Idle"}});const u=T(()=>{if(!o.isRecording)return"Not recording";const v=[`Write speed: ${c.value} MB/s`,`Buffer: ${s.value}%`];return a.value>0&&v.push(`Frames dropped: ${a.value}`),v.join(`
`)});function _(v){v.buffer_percent!==void 0&&(s.value=v.buffer_percent),v.frames_dropped!==void 0&&(a.value=v.frames_dropped)}return t({updateFromMetrics:_}),(v,R)=>re(o).isRecording?(f(),g("div",{key:0,class:V(["flex items-center gap-3 px-3 py-1.5 rounded-lg transition-colors cursor-help",{"bg-emerald-500/10":C.value==="emerald","bg-amber-500/10":C.value==="amber","bg-red-500/10":C.value==="red"}]),title:u.value},[e("span",{class:V(["w-2 h-2 rounded-full",C.value==="emerald"?"bg-emerald-500":"",C.value==="amber"?"bg-amber-500 animate-pulse":"",C.value==="red"?"bg-red-500 animate-pulse":""])},null,2),e("div",Lt,[R[0]||(R[0]=e("svg",{class:"w-3.5 h-3.5 text-preke-text-dim",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})],-1)),e("span",{class:V(["font-mono",C.value==="emerald"?"text-emerald-400":"",C.value==="amber"?"text-amber-400":"",C.value==="red"?"text-red-400":""])},$(c.value)+" MB/s ",3)]),s.value>0?(f(),g("div",At,[R[1]||(R[1]=e("span",{class:"text-preke-text-dim"},"Buf:",-1)),e("span",{class:V(["font-mono",s.value<50?"text-emerald-400":"",s.value>=50&&s.value<80?"text-amber-400":"",s.value>=80?"text-red-400":""])},$(s.value)+"% ",3)])):W("",!0),a.value>0?(f(),g("div",Dt,[R[2]||(R[2]=e("svg",{class:"w-3.5 h-3.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),e("span",Bt,$(a.value)+" dropped",1)])):W("",!0)],10,Pt)):W("",!0)}});function Me(n){return n.startsWith("192.168.")||n.startsWith("10.")||n.startsWith("172.")||n.startsWith("100.")||n==="127.0.0.1"||n==="localhost"}const Nt=5,Wt=1e3,Ft=3e4,Ut=()=>typeof window<"u"&&window.__NETWORK_DEBUG__===!0,Te=new Map,Vt=1e3;function fe(n,t,...o){if(!Ut())return;const m=Date.now(),i=Te.get(n)||0;m-i<Vt||(Te.set(n,m),console.log(`[NETWORK DEBUG ${n}] ${t}`,...o))}const q=new Map,ie=new Map;async function jt(n){const t=pe(),o=De();if(t&&!o)try{return`http://${new URL(t).hostname}:8889/${n}/whep`}catch{console.warn("[WHEP Manager] Invalid device URL, falling back to FRP")}if(!(typeof window<"u"&&!!window.electronAPI)&&typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"))return console.log("[WHEP Manager] Local device mode, using localhost MediaMTX"),`http://localhost:8889/${n}/whep`;if(typeof window<"u"&&window.location.hostname==="app.itagenten.no")return console.log("[WHEP Manager] Browser access from app.itagenten.no, using same-domain proxy"),`https://app.itagenten.no/${n}/whep`;const{getFrpUrl:i}=await Ve(async()=>{const{getFrpUrl:s}=await import("./index-3JfoDJ9v.js").then(a=>a.a3);return{getFrpUrl:s}},__vite__mapDeps([0,1])),c=await i();if(c)try{const s=new URL(c);return s.hostname.includes("itagenten.no")?`https://app.itagenten.no/${n}/whep`:s.hostname.includes("mediamtx")?`${c}/${n}/whep`:`https://${s.hostname.replace("api","mediamtx")}/${n}/whep`}catch{console.warn("[WHEP Manager] Invalid FRP URL, cannot build WHEP URL")}throw new Error("No device configured and no FRP fallback available")}async function It(n,t){const o=q.get(t);if(!o)return"unknown";try{const c=new URL(o.whepUrl).hostname;if(c.includes("itagenten.no"))return console.log(`[WHEP Manager ${t}] Detected relay (FRP URL)`),"relay";if(Me(c))return console.log(`[WHEP Manager ${t}] Detected P2P (private IP: ${c})`),"p2p"}catch(i){console.warn(`[WHEP Manager ${t}] Failed to parse WHEP URL:`,i)}try{const i=await n.getStats();for(const c of i.values())if(c.type==="candidate-pair"&&c.state==="succeeded"){const s=i.get(c.remoteCandidateId);if((s==null?void 0:s.candidateType)==="relay")return console.log(`[WHEP Manager ${t}] Detected relay (TURN candidate)`),"relay";const a=s==null?void 0:s.address;if(a&&!Me(a))return console.log(`[WHEP Manager ${t}] Detected relay (public IP: ${a})`),"relay"}}catch(i){console.warn(`[WHEP Manager ${t}] Failed to get WebRTC stats:`,i)}return pe()&&!De()?(console.log(`[WHEP Manager ${t}] Assuming P2P (direct device URL configured)`),"p2p"):"unknown"}function te(n){const t=q.get(n);if(!t)return;const o=ie.get(n);o&&o.forEach(m=>m(t))}function ke(n){const t=q.get(n);if(!t)return;if(t.reconnectAttempts>=Nt){console.error(`[WHEP Manager ${n}] Max reconnect attempts reached`),t.state="failed",te(n);return}t.reconnectAttempts++;const o=Math.min(Wt*Math.pow(2,t.reconnectAttempts-1),Ft),m=o*.2*(Math.random()*2-1),i=Math.max(100,Math.round(o+m));fe("WHEP",`Camera ${n}: Reconnect #${t.reconnectAttempts} in ${i}ms (base: ${o}ms)`),console.log(`[WHEP Manager ${n}] Scheduling reconnect #${t.reconnectAttempts} in ${i}ms`),t.state="connecting",te(n),t.reconnectTimeout&&clearTimeout(t.reconnectTimeout),t.reconnectTimeout=setTimeout(()=>{$e(n)},i)}async function $e(n){let t=q.get(n);if(t&&(t.state==="connected"||t.state==="connecting"))return console.log(`[WHEP Manager ${n}] Reusing existing connection (state: ${t.state})`),t;if(t!=null&&t.isConnecting){for(fe("WHEP",`Camera ${n}: Connection already in progress, skipping duplicate attempt`),console.log(`[WHEP Manager ${n}] Connection already in progress, waiting...`);t.isConnecting&&t.state==="connecting"&&(await new Promise(r=>setTimeout(r,100)),t=q.get(n),!!t););if(t)return t}const m=!(typeof window<"u"&&!!window.electronAPI)&&typeof window<"u"&&(window.location.hostname==="app.itagenten.no"||window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1");let i=pe();if(m)console.log(`[WHEP Manager ${n}] Browser-only mode (no Electron) - using appropriate proxy`);else{let r=0;for(;!i&&r<5;)console.log(`[WHEP Manager ${n}] No device URL yet, waiting... (attempt ${r+1})`),await new Promise(d=>setTimeout(d,100)),i=pe(),r++}const c=performance.now(),s=await jt(n);fe("WHEP",`Camera ${n}: Creating connection to ${s}`),console.log(`[WHEP Manager ${n}] Creating connection to: ${s}`),console.log(`[WHEP Manager ${n}] Device URL was: ${i||"none (browser mode)"}`),t!=null&&t.peerConnection&&t.peerConnection.close(),t!=null&&t.disconnectedTimeout&&(clearTimeout(t.disconnectedTimeout),t.disconnectedTimeout=null),t&&(t.isConnecting=!0);const a=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}]});t?(t.peerConnection=a,t.state="connecting",t.whepUrl=s,t.mediaStream=null,t.connectionType="unknown",t.connectionStartTime=c,t.isConnecting=!0):(t={cameraId:n,peerConnection:a,mediaStream:null,state:"connecting",connectionType:"unknown",refCount:0,whepUrl:s,lastConnectedAt:null,reconnectAttempts:0,reconnectTimeout:null,disconnectedTimeout:null,connectionStartTime:c,isConnecting:!0},q.set(n,t)),a.ontrack=r=>{r.streams[0]&&(t.mediaStream=r.streams[0],console.log(`[WHEP Manager ${n}] Received media stream`),te(n))},a.oniceconnectionstatechange=async()=>{const r=a.iceConnectionState;if(fe("WHEP",`Camera ${n}: ICE state changed to ${r}`),console.log(`[WHEP Manager ${n}] ICE state: ${r}`),r==="connected"||r==="completed"){t.state="connected",t.lastConnectedAt=Date.now(),t.reconnectAttempts=0,t.isConnecting=!1,t.connectionType=await It(a,n),t.disconnectedTimeout&&(clearTimeout(t.disconnectedTimeout),t.disconnectedTimeout=null);const d=t.connectionStartTime?Math.round(performance.now()-t.connectionStartTime):0;console.log(`[WHEP Manager ${n}] Connected (${t.connectionType}) in ${d}ms`),te(n)}else r==="failed"?(t.state="failed",t.connectionType="unknown",t.isConnecting=!1,te(n),t.refCount>0&&ke(n)):r==="disconnected"&&(t.disconnectedTimeout&&clearTimeout(t.disconnectedTimeout),t.disconnectedTimeout=setTimeout(()=>{(a.iceConnectionState==="disconnected"||a.iceConnectionState==="failed")&&(t.state="disconnected",t.isConnecting=!1,te(n),t.refCount>0&&ke(n)),t.disconnectedTimeout=null},3e3))},a.addTransceiver("video",{direction:"recvonly"}),a.addTransceiver("audio",{direction:"recvonly"});try{const r=await a.createOffer();await a.setLocalDescription(r);const d=await fetch(s,{method:"POST",headers:{"Content-Type":"application/sdp"},body:r.sdp});if(!d.ok)throw new Error(`WHEP request failed: ${d.status}`);const l=await d.text();await a.setRemoteDescription({type:"answer",sdp:l})}catch(r){console.error(`[WHEP Manager ${n}] Connection error:`,r),t.state="failed",t.isConnecting=!1,te(n),t.refCount>0&&ke(n)}return t}async function Gt(n,t){ie.has(n)||ie.set(n,new Set),ie.get(n).add(t);let o=q.get(n);return(!o||o.state==="failed"||o.state==="disconnected")&&(o=await $e(n)),o.refCount++,console.log(`[WHEP Manager ${n}] Acquired connection (refCount: ${o.refCount})`),t(o),o}function Ot(n,t){const o=q.get(n);if(!o)return;const m=ie.get(n);m&&(m.delete(t),m.size===0&&ie.delete(n)),o.refCount=Math.max(0,o.refCount-1),console.log(`[WHEP Manager ${n}] Released connection (refCount: ${o.refCount})`),o.refCount===0&&(console.log(`[WHEP Manager ${n}] Closing unused connection`),o.reconnectTimeout&&clearTimeout(o.reconnectTimeout),o.disconnectedTimeout&&clearTimeout(o.disconnectedTimeout),o.peerConnection.close(),q.delete(n))}function Ce(n){const t=q.get(n);t&&(console.log(`[WHEP Manager ${n}] Force reconnecting...`),t.reconnectAttempts=0,$e(n))}const zt={class:"relative w-full h-full bg-black"},qt=["title"],Kt={key:1,class:"absolute inset-0 flex items-center justify-center bg-black/50"},Yt={class:"text-center"},Qt={class:"text-xs text-amber-400"},Xt={key:3,class:"absolute inset-0 flex items-center justify-center bg-black/80"},Jt={class:"text-center text-preke-text-dim"},Zt={class:"text-sm"},Ee=Z({__name:"InputPreview",props:{inputId:{},protocol:{}},emits:["videoReady","aspectRatio"],setup(n,{emit:t}){const o=n,m=t,i=J();let c=!1;const s=T(()=>i.status==="recording"),a=h(null),r=h(!0),d=h(null),l=h("unknown"),C=h(!1),u=h(0);let _=null;function v(x){switch(console.log(`[InputPreview ${o.inputId}] Connection update:`,{state:x.state,type:x.connectionType,hasStream:!!x.mediaStream}),l.value=x.connectionType,u.value=x.reconnectAttempts,x.state){case"connecting":r.value=!0,d.value=null,C.value=x.reconnectAttempts>0;break;case"connected":r.value=!1,d.value=null,C.value=!1,x.mediaStream&&a.value&&a.value.srcObject!==x.mediaStream&&(a.value.srcObject=x.mediaStream,a.value.play().catch(S=>{console.warn(`[InputPreview ${o.inputId}] Autoplay prevented:`,S)}),c||(a.value.onloadeddata=()=>{if(!c&&a.value){c=!0;const S=a.value.videoWidth,B=a.value.videoHeight,b=S&&B?S/B:16/9;console.log(`[InputPreview ${o.inputId}] Video ready (${S}x${B}, ratio: ${b.toFixed(3)})`),m("aspectRatio",b),m("videoReady")}}));break;case"disconnected":C.value=!0,d.value=`Reconnecting... (${x.reconnectAttempts}/5)`;break;case"failed":r.value=!1,C.value=!1,d.value="Connection failed after multiple attempts";break}}async function R(){if(a.value){k(),r.value=!0,d.value=null,_=v;try{await Gt(o.inputId,_)}catch(x){console.error(`[InputPreview ${o.inputId}] Failed to acquire connection:`,x),d.value=x instanceof Error?x.message:"Failed to connect",r.value=!1}}}function D(){Ce(o.inputId)}function k(){_&&(Ot(o.inputId,_),_=null)}return oe(()=>{R()}),Y(()=>o.inputId,()=>{R()}),Y(s,(x,S)=>{S&&!x&&d.value?(console.log("[InputPreview] Recording stopped, reconnecting preview..."),Ce(o.inputId)):!S&&x&&(console.log("[InputPreview] Recording started, will try to reconnect preview after delay..."),setTimeout(()=>{s.value&&(console.log("[InputPreview] Attempting to reconnect preview during recording..."),Ce(o.inputId))},2e3))}),ge(()=>{k()}),(x,S)=>(f(),g("div",zt,[e("video",{ref_key:"videoRef",ref:a,autoplay:"",muted:"",playsinline:"",class:"w-full h-full object-contain"},null,512),!r.value&&!d.value&&l.value!=="unknown"?(f(),g("div",{key:0,class:V(["absolute top-1 right-1 px-1.5 py-0.5 text-[10px] font-medium rounded",l.value==="p2p"?"bg-emerald-500/80 text-white":"bg-amber-500/80 text-white"]),title:l.value==="p2p"?"Direct P2P connection":"Relay connection (FRP)"},$(l.value==="p2p"?"P2P":"RELAY"),11,qt)):W("",!0),r.value&&!C.value?(f(),g("div",Kt,[...S[0]||(S[0]=[e("div",{class:"animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"},null,-1)])])):W("",!0),C.value?(f(),g("div",{key:2,class:"absolute inset-0 flex items-center justify-center bg-black/70 cursor-pointer",onClick:D,title:"Click to force reconnect"},[e("div",Yt,[S[1]||(S[1]=e("div",{class:"animate-spin w-5 h-5 border-2 border-amber-400 border-t-transparent rounded-full mx-auto mb-2"},null,-1)),e("p",Qt,$(d.value||"Reconnecting..."),1),S[2]||(S[2]=e("p",{class:"text-xs text-amber-400/60 mt-1"},"Tap to retry",-1))])])):d.value&&!r.value?(f(),g("div",Xt,[e("div",Jt,[e("p",Zt,$(d.value),1),e("button",{onClick:D,class:"mt-2 text-xs text-preke-gold hover:underline"}," Retry ")])])):W("",!0)]))}}),en={key:0,class:"h-full flex items-center justify-center"},tn={key:1,class:"input-grid"},nn={key:0,class:"input-grid__warning"},on=["data-count"],an=["title","onClick"],sn={key:1,class:"w-full h-full flex items-center justify-center bg-preke-bg-surface"},rn={class:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-4"},ln={class:"flex items-center justify-between"},cn={class:"flex items-center gap-2"},un={class:"font-medium"},dn={key:0,class:"flex items-center gap-2 text-sm"},fn={class:"text-preke-text-dim"},vn={class:"enlarged-modal__info"},pn={class:"flex items-center gap-3"},mn={class:"font-semibold text-lg"},gn={key:0,class:"px-2 py-0.5 text-xs font-bold bg-preke-red/20 text-preke-red rounded"},_n={class:"flex items-center gap-4 text-sm"},hn={class:"text-preke-text-dim"},bn=Z({__name:"InputGrid",emits:["allVideosReady"],setup(n,{emit:t}){const o=J(),m=xe(),i=t,c=h(new Set),s=h(null);function a(b){s.value=b}function r(){s.value=null}const d=h({});function l(b){c.value.add(b),console.log(`[InputGrid] Video ready: ${b} (${c.value.size}/${v.value.length})`),c.value.size>=v.value.length&&(console.log("[InputGrid] All videos ready!"),i("allVideosReady"))}function C(b,L){d.value[b]=L,console.log(`[InputGrid] Aspect ratio for ${b}: ${L.toFixed(3)}`)}function u(b){return{aspectRatio:`${d.value[b]||1.7777777777777777}`}}Y(()=>v.value.length,()=>{c.value.clear()});const _=T(()=>{var b;return((b=m.capabilities)==null?void 0:b.current_mode)==="recorder"}),v=T(()=>o.inputs.filter(b=>b.hasSignal)),R=T(()=>o.framerateMismatch);function D(b){return b.isRecording?"border-preke-red ring-2 ring-preke-red/20":b.hasSignal?"border-emerald-500/50 hover:border-emerald-500":"border-preke-bg-surface/50 opacity-60"}function k(b){return b.hasSignal?b.framerate>=29?"excellent":b.framerate>=24?"good":"unstable":"none"}function x(b){switch(k(b)){case"excellent":return"text-emerald-400";case"good":return"text-emerald-400";case"unstable":return"text-amber-400";case"none":return"text-preke-text-dim"}}function S(b){if(b===0)return"0 B";const L=1024,A=["B","KB","MB","GB"],O=Math.floor(Math.log(b)/Math.log(L));return parseFloat((b/Math.pow(L,O)).toFixed(1))+" "+A[O]}function B(b){if(!b.hasSignal)return`${b.label}: No signal detected`;const L=[`${b.label}`,`Resolution: ${b.resolution}`,`Framerate: ${b.framerate} fps`,`Quality: ${k(b)}`];return b.isRecording&&L.push(`Written: ${S(b.bytesWritten)}`),L.join(`
`)}return(b,L)=>v.value.length===0?(f(),g("div",en,[...L[1]||(L[1]=[Be('<div class="text-center text-preke-text-dim" data-v-53f60619><svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-53f60619><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" data-v-53f60619></path></svg><p class="text-lg font-medium" data-v-53f60619>No Video Sources Connected</p><p class="text-sm mt-2" data-v-53f60619>Connect HDMI cables to begin recording</p></div>',1)])])):(f(),g("div",tn,[R.value?(f(),g("div",nn,[L[2]||(L[2]=e("svg",{class:"w-4 h-4 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),e("span",null,$(R.value),1)])):W("",!0),e("div",{class:"input-grid__container","data-count":v.value.length},[(f(!0),g(K,null,me(v.value,A=>(f(),g("div",{key:A.id,class:V(["input-grid__tile",D(A)]),style:je(u(A.id)),title:B(A),onClick:O=>a(A)},[_.value?(f(),ae(Ee,{key:0,"input-id":A.id,class:"w-full h-full",onVideoReady:O=>l(A.id),onAspectRatio:O=>C(A.id,O)},null,8,["input-id","onVideoReady","onAspectRatio"])):(f(),g("div",sn,[...L[3]||(L[3]=[e("div",{class:"text-center"},[e("svg",{class:"w-8 h-8 mx-auto mb-2 text-preke-text-dim/50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})]),e("span",{class:"text-xs text-preke-text-dim/70"},"Mixer mode")],-1)])])),e("div",rn,[e("div",ln,[e("div",cn,[e("span",{class:V(["w-2 h-2 rounded-full transition-colors",{"bg-emerald-500":k(A)==="excellent"||k(A)==="good","bg-amber-500 animate-pulse":k(A)==="unstable","bg-preke-text-dim":k(A)==="none"}])},null,2),e("span",un,$(A.label),1)]),A.hasSignal?(f(),g("div",dn,[e("span",fn,$(A.resolution),1),e("span",{class:V(x(A))},$(A.framerate)+"fps",3)])):W("",!0)])])],14,an))),128))],8,on),(f(),ae(Le,{to:"body"},[I(ve,{name:"enlarged"},{default:ne(()=>[s.value?(f(),g("div",{key:0,class:"enlarged-modal",onClick:r},[e("div",{class:"enlarged-modal__content",onClick:L[0]||(L[0]=Pe(()=>{},["stop"]))},[_.value?(f(),ae(Ee,{key:0,"input-id":s.value.id,class:"w-full h-full"},null,8,["input-id"])):W("",!0),e("div",vn,[e("div",pn,[e("span",{class:V(["w-2.5 h-2.5 rounded-full",{"bg-emerald-500":k(s.value)==="excellent"||k(s.value)==="good","bg-amber-500 animate-pulse":k(s.value)==="unstable","bg-preke-text-dim":k(s.value)==="none"}])},null,2),e("span",mn,$(s.value.label),1),s.value.isRecording?(f(),g("span",gn," REC ")):W("",!0)]),e("div",_n,[e("span",hn,$(s.value.resolution),1),e("span",{class:V(x(s.value))},$(s.value.framerate)+"fps",3)])]),e("button",{class:"enlarged-modal__close",onClick:r,title:"Close (or click outside)"},[...L[4]||(L[4]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])])):W("",!0)]),_:1})]))]))}}),wn=le(bn,[["__scopeId","data-v-53f60619"]]),yn={key:0,class:"py-8 text-center text-preke-text-muted"},kn={key:1,class:"camera-setup"},Cn={class:"camera-list"},xn={class:"list-header"},$n=["disabled"],Rn={key:0,class:"empty-state"},Sn={key:1,class:"camera-items"},Mn={class:"camera-item__info"},Tn={class:"camera-item__header"},En={class:"camera-item__name"},Pn={class:"camera-item__details"},Ln={class:"camera-item__type"},An={class:"camera-item__ip"},Dn={class:"camera-item__actions"},Bn=["onClick","disabled"],Hn={key:0,class:"btn-icon-sm",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Nn={key:1,class:"spinner"},Wn=["onClick","disabled"],Fn=["onClick","disabled"],Un={key:0,class:"camera-form"},Vn={class:"form-header"},jn={class:"form-title"},In={class:"form-content"},Gn={class:"form-group"},On={class:"form-group"},zn=["value"],qn={class:"form-group"},Kn={class:"form-group"},Yn=["placeholder"],Qn={class:"form-hint"},Xn={class:"form-group"},Jn={class:"form-checkbox"},Zn={class:"form-actions"},eo={class:"flex items-center justify-between w-full"},to={key:0,class:"text-sm text-amber-400"},no={key:1,class:"text-sm text-preke-text-muted"},oo={class:"flex gap-3"},ao=["disabled"],so=Z({__name:"CameraSetupModal",emits:["close","updated"],setup(n,{expose:t,emit:o}){const m=o,i=h(null),c=He(),s=h(!1),a=h(!1),r=h(null),d=h([]),l=h(null),C=[{value:"blackmagic",label:"Blackmagic Design Studio Camera 4K Pro"},{value:"obsbot_tail2",label:"OBSbot Tail 2"}],u=h({name:"",type:"blackmagic",ip:"",port:void 0,enabled:!0}),_={blackmagic:80,obsbot_tail2:52381},v=T(()=>l.value!==null),R=h(!1);async function D(){s.value=!0;try{const M=await de.cameras.getConfig();d.value=M.cameras.map(p=>({name:p.name,type:p.type,ip:p.ip,port:p.port,enabled:p.enabled??!0})),R.value=!1}catch(M){console.error("[CameraSetup] Failed to load config:",M),c.error("Failed to load camera configuration")}finally{s.value=!1}}function k(){u.value={name:"",type:"blackmagic",ip:"",port:void 0,enabled:!0},l.value=null}function x(M){l.value=M,u.value={...d.value[M]}}function S(){k()}function B(){k(),l.value=-1}async function b(M){confirm(`Delete camera "${d.value[M].name}"?`)&&(d.value.splice(M,1),R.value=!0,await N())}async function L(M){r.value=M.name;try{(await de.cameras.getStatus(M.name)).connected?c.success(`${M.name} is connected!`):c.warning(`${M.name} is not connected`)}catch{try{const E=await fetch(`http://${M.ip}:${M.port||_[M.type]}/`,{method:"HEAD",mode:"no-cors",signal:AbortSignal.timeout(3e3)});c.info(`${M.name}: IP ${M.ip} is reachable`)}catch{c.error(`${M.name}: Cannot reach ${M.ip}`)}}finally{r.value=null}}function A(){return u.value.name.trim()?u.value.ip.trim()?/^(\d{1,3}\.){3}\d{1,3}$/.test(u.value.ip)?d.value.findIndex((E,w)=>E.name===u.value.name&&w!==l.value)>=0?(c.error("Camera name already exists"),!1):!0:(c.error("Invalid IP address format"),!1):(c.error("Camera IP address is required"),!1):(c.error("Camera name is required"),!1)}function O(){A()&&(u.value.port||(u.value.port=_[u.value.type]),l.value===-1?d.value.push({...u.value}):l.value!==null&&l.value>=0&&(d.value[l.value]={...u.value}),R.value=!0,k())}async function N(){a.value=!0;try{await de.cameras.updateConfig(d.value),c.success("Camera configuration saved!"),R.value=!1,m("updated")}catch(M){console.error("[CameraSetup] Failed to save config:",M),c.error("Failed to save configuration: "+(M.message||"Unknown error"))}finally{a.value=!1}}function Q(){var M;(M=i.value)==null||M.open(),D()}function H(){var M;R.value&&!confirm("You have unsaved changes. Close anyway?")||((M=i.value)==null||M.close(),k(),R.value=!1,m("close"))}return t({open:Q,close:H}),oe(()=>{D()}),(M,p)=>(f(),ae(Oe,{ref_key:"modalRef",ref:i,title:"Camera Setup",size:"xl",onClose:H},{header:ne(()=>[...p[5]||(p[5]=[e("div",{class:"flex items-center justify-between w-full"},[e("div",null,[e("h2",{class:"text-lg font-semibold text-preke-text"},"Camera Setup"),e("p",{class:"text-sm text-preke-text-muted mt-1"}," Configure external cameras for control ")])],-1)])]),footer:ne(()=>[e("div",eo,[R.value?(f(),g("div",to," You have unsaved changes ")):(f(),g("div",no,$(d.value.length)+" camera"+$(d.value.length!==1?"s":"")+" configured ",1)),e("div",oo,[e("button",{onClick:H,class:"btn-secondary"}," Close "),e("button",{onClick:N,disabled:!R.value||a.value,class:"btn-primary"},$(a.value?"Saving...":"Save Configuration"),9,ao)])])]),default:ne(()=>[s.value?(f(),g("div",yn," Loading camera configuration... ")):(f(),g("div",kn,[e("div",Cn,[e("div",xn,[p[7]||(p[7]=e("h3",{class:"list-title"},"Configured Cameras",-1)),e("button",{onClick:B,class:"btn-add",disabled:v.value},[...p[6]||(p[6]=[e("svg",{class:"btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),se(" Add Camera ",-1)])],8,$n)]),d.value.length===0&&!v.value?(f(),g("div",Rn,[...p[8]||(p[8]=[e("svg",{class:"empty-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})],-1),e("p",{class:"empty-text"},"No cameras configured",-1),e("p",{class:"empty-hint"},'Click "Add Camera" to get started',-1)])])):(f(),g("div",Sn,[(f(!0),g(K,null,me(d.value,(E,w)=>{var y;return f(),g("div",{key:w,class:V(["camera-item",{"camera-item--disabled":!E.enabled}])},[e("div",Mn,[e("div",Tn,[e("span",En,$(E.name),1),e("span",{class:V(["camera-item__badge",E.enabled?"camera-item__badge--enabled":"camera-item__badge--disabled"])},$(E.enabled?"Enabled":"Disabled"),3)]),e("div",Pn,[e("span",Ln,$(((y=C.find(j=>j.value===E.type))==null?void 0:y.label)||E.type),1),e("span",An,$(E.ip)+":"+$(E.port||_[E.type]),1)])]),e("div",Dn,[e("button",{onClick:j=>L(E),disabled:r.value===E.name,class:"btn-test",title:"Test Connection"},[r.value!==E.name?(f(),g("svg",Hn,[...p[9]||(p[9]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 10V3L4 14h7v7l9-11h-7z"},null,-1)])])):(f(),g("span",Nn))],8,Bn),e("button",{onClick:j=>x(w),disabled:v.value,class:"btn-edit",title:"Edit"},[...p[10]||(p[10]=[e("svg",{class:"btn-icon-sm",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})],-1)])],8,Wn),e("button",{onClick:j=>b(w),disabled:v.value,class:"btn-delete",title:"Delete"},[...p[11]||(p[11]=[e("svg",{class:"btn-icon-sm",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})],-1)])],8,Fn)])],2)}),128))]))]),v.value?(f(),g("div",Un,[e("div",Vn,[e("h3",jn,$(l.value===-1?"Add Camera":"Edit Camera"),1),e("button",{onClick:S,class:"btn-cancel-form"},"Cancel")]),e("div",In,[e("div",Gn,[p[12]||(p[12]=e("label",{class:"form-label"},"Camera Name *",-1)),X(e("input",{"onUpdate:modelValue":p[0]||(p[0]=E=>u.value.name=E),type:"text",class:"form-input",placeholder:"e.g., BMD Cam 1"},null,512),[[ce,u.value.name]])]),e("div",On,[p[13]||(p[13]=e("label",{class:"form-label"},"Camera Type *",-1)),X(e("select",{"onUpdate:modelValue":p[1]||(p[1]=E=>u.value.type=E),class:"form-input"},[(f(),g(K,null,me(C,E=>e("option",{key:E.value,value:E.value},$(E.label),9,zn)),64))],512),[[Ie,u.value.type]])]),e("div",qn,[p[14]||(p[14]=e("label",{class:"form-label"},"IP Address *",-1)),X(e("input",{"onUpdate:modelValue":p[2]||(p[2]=E=>u.value.ip=E),type:"text",class:"form-input",placeholder:"192.168.1.101"},null,512),[[ce,u.value.ip]]),p[15]||(p[15]=e("p",{class:"form-hint"},"Camera's network IP address",-1))]),e("div",Kn,[p[16]||(p[16]=e("label",{class:"form-label"},"Port",-1)),X(e("input",{"onUpdate:modelValue":p[3]||(p[3]=E=>u.value.port=E),type:"number",class:"form-input",placeholder:String(_[u.value.type])},null,8,Yn),[[ce,u.value.port,void 0,{number:!0}]]),e("p",Qn,"Default: "+$(_[u.value.type])+" for "+$(u.value.type),1)]),e("div",Xn,[e("label",Jn,[X(e("input",{"onUpdate:modelValue":p[4]||(p[4]=E=>u.value.enabled=E),type:"checkbox",class:"checkbox"},null,512),[[Ge,u.value.enabled]]),p[17]||(p[17]=e("span",null,"Enabled",-1))]),p[18]||(p[18]=e("p",{class:"form-hint"},"Disable to keep configuration but not use the camera",-1))]),e("div",Zn,[e("button",{onClick:O,class:"btn-save-form"},$(l.value===-1?"Add Camera":"Update Camera"),1),e("button",{onClick:S,class:"btn-cancel-form"}," Cancel ")])])])):W("",!0)]))]),_:1},512))}}),ro=le(so,[["__scopeId","data-v-d42e0adf"]]),io={class:"sidebar"},lo={class:"sidebar__card sidebar__card--header"},co={class:"connection-row"},uo={class:"connection-status"},fo={class:"connection-label"},vo={key:0,class:"connection-latency"},po=["disabled"],mo={class:"sidebar__card sidebar__card--recording"},go={class:"recording__duration"},_o={class:"recording__meta"},ho={key:0,class:"sidebar__card sidebar__card--warning"},bo={class:"warning__text"},wo={key:1,class:"sidebar__card sidebar__card--davinci"},yo={class:"davinci__buttons"},ko=["disabled"],Co=["disabled"],xo=["disabled"],$o={class:"sidebar__card"},Ro={key:0,class:"cameras"},So={class:"camera__header"},Mo=["onClick","disabled"],To={key:1,class:"cameras-empty"},Eo=Z({__name:"SessionInfoV2",setup(n){const t=Ne(),o=J(),m=xe(),i=He(),{state:c,latencyMs:s}=ze(),{connectionMethod:a}=qe(),r=T(()=>{const w=c.value==="connected",y=c.value==="connecting",j=c.value==="degraded";if(w){let P="";return a.value==="relay"?P="Relay":a.value==="p2p"?P="P2P":a.value==="local"&&(P="Local"),{status:"online",color:"green",label:P||"Connected",latency:s.value,pulse:!1}}return y?{status:"connecting",color:"amber",label:"Connecting...",latency:null,pulse:!0}:j?{status:"degraded",color:"amber",label:"Slow",latency:s.value,pulse:!1}:{status:"offline",color:"red",label:"Offline",latency:null,pulse:!0}}),d=T(()=>o.currentSession);T(()=>o.activeInputs);const l=T(()=>o.isRecording),C=T(()=>o.inputs.filter(w=>w.isRecording)),u=h("");oe(()=>{const y=new Date().toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,".");u.value=`Session ${y}`});const{cameras:_,loadCameras:v}=Je(),R=h(null),D=h(null),k=h(null);oe(async()=>{await v()});function x(w){var y;R.value=w,(y=D.value)==null||y.open()}function S(){R.value=null}function B(){var w;(w=k.value)==null||w.open()}function b(){v()}const L=T(()=>{const w=m.capabilities;if(!w)return null;const y=w.storage_used_gb||0,j=w.storage_total_gb||1,P=j-y,F=Math.round(y/j*100),We=P/10;return{freeGB:Math.round(P),totalGB:Math.round(j),percent:F,hoursRemaining:Math.round(We*10)/10,isLow:F>85,isCritical:F>95}});function A(){t.push({name:"admin",query:{tab:"settings"}})}const O=T(()=>Ke()),N=h(!1),Q=T(()=>{const w=d.value;return w!=null&&w.id?`Preke_${w.id}`:`Preke_${u.value.replace(/\s+/g,"_")}`}),H=window.electronAPI;async function M(){if(H!=null&&H.davinciOpenProject){N.value=!0,i.info("Opening DaVinci Resolve...");try{const w=await H.davinciOpenProject(Q.value);w.success?i.success(`Opened project: ${w.projectName}`):i.error(w.error||"Failed to open DaVinci project")}catch(w){console.error("DaVinci error:",w),i.error("Failed to connect to DaVinci Resolve")}finally{N.value=!1}}}async function p(){if(H!=null&&H.davinciCreateMulticam){N.value=!0;try{H.davinciOpenProject&&await H.davinciOpenProject(Q.value);const w=await H.davinciCreateMulticam({projectName:Q.value,clipName:`Multicam_${u.value.replace(/\s+/g,"_")}`,syncMethod:"timecode"});w.success?i.success(`Created timeline: ${w.timelineName}`):i.error(w.error||"Failed to create multicam timeline")}catch(w){console.error("DaVinci error:",w),i.error("Failed to create multicam timeline")}finally{N.value=!1}}}async function E(){if(H!=null&&H.davinciRefreshClips){N.value=!0,i.info("Refreshing growing clips...");try{const w=await H.davinciRefreshClips();if(w.success){const y=w.clipsRefreshed||0;i.success(`Refreshed ${y} clip${y!==1?"s":""}`)}else i.error(w.error||"Failed to refresh clips")}catch(w){console.error("DaVinci refresh error:",w),i.error("Failed to refresh clips")}finally{N.value=!1}}}return(w,y)=>{var j;return f(),g("div",io,[e("div",lo,[e("div",co,[e("div",uo,[e("span",{class:V(["connection-dot",[`connection-dot--${r.value.color}`,{"connection-dot--pulse":r.value.pulse}]])},null,2),e("span",fo,$(r.value.label),1),r.value.latency?(f(),g("span",vo,$(r.value.latency)+"ms ",1)):W("",!0)])]),y[1]||(y[1]=e("div",{class:"sidebar__divider"},null,-1)),y[2]||(y[2]=e("label",{class:"sidebar__label"},"Session Name",-1)),X(e("input",{"onUpdate:modelValue":y[0]||(y[0]=P=>u.value=P),type:"text",class:"sidebar__input",placeholder:"Session 06.01.2026",disabled:l.value},null,8,po),[[ce,u.value]])]),l.value?(f(),g(K,{key:0},[e("div",mo,[y[3]||(y[3]=e("div",{class:"recording__header"},[e("span",{class:"recording__dot"}),e("span",{class:"recording__label"},"Recording")],-1)),e("div",go,$(re(o).formattedDuration),1),e("div",_o,$(C.value.length)+" camera"+$(C.value.length!==1?"s":"")+" recording ",1)]),(j=L.value)!=null&&j.isLow?(f(),g("div",ho,[y[5]||(y[5]=e("span",{class:"warning__icon"},"⚠️",-1)),e("div",bo,[y[4]||(y[4]=e("strong",null,"Low storage",-1)),e("span",null,$(L.value.freeGB)+" GB remaining",1)])])):W("",!0),O.value?(f(),g("div",wo,[y[6]||(y[6]=Be('<div class="davinci__header" data-v-a373edd4><svg class="davinci__icon" viewBox="0 0 24 24" fill="currentColor" data-v-a373edd4><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" data-v-a373edd4></path></svg><span class="davinci__label" data-v-a373edd4>DaVinci Resolve</span></div><p class="davinci__hint" data-v-a373edd4>Edit while recording (mount R58 recordings via SMB)</p>',2)),e("div",yo,[e("button",{onClick:M,disabled:N.value,class:"davinci__btn"},$(N.value?"Opening...":"Open Project"),9,ko),e("button",{onClick:p,disabled:N.value,class:"davinci__btn davinci__btn--secondary"}," Create Multicam ",8,Co),e("button",{onClick:E,disabled:N.value,class:"davinci__btn davinci__btn--secondary",title:"Refresh growing clips to update duration"},$(N.value?"Refreshing...":"Refresh Clips"),9,xo)])])):W("",!0)],64)):(f(),g(K,{key:1},[e("div",$o,[e("div",{class:"sidebar__label"},[y[8]||(y[8]=se(" Camera Controls ",-1)),e("button",{onClick:B,class:"camera-setup-btn",title:"Setup Cameras"},[...y[7]||(y[7]=[e("svg",{class:"camera-setup-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("circle",{cx:"12",cy:"12",r:"3"})],-1)])])]),re(_).length>0?(f(),g("div",Ro,[(f(!0),g(K,null,me(re(_),P=>(f(),g("div",{key:P.name,class:"camera"},[e("div",So,[se($(P.name)+" ",1),e("span",{class:V(["camera__status",P.connected?"camera__status--connected":"camera__status--disconnected"])},$(P.connected?"●":"○"),3)]),e("button",{class:"camera__control-btn",onClick:F=>x(P.name),disabled:!P.connected},[...y[9]||(y[9]=[e("svg",{class:"camera__control-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("circle",{cx:"12",cy:"12",r:"3"})],-1),e("span",null,"Controls",-1)])],8,Mo)]))),128))])):(f(),g("div",To,[y[10]||(y[10]=e("p",{class:"cameras-empty__text"},"No cameras configured",-1)),e("button",{onClick:B,class:"cameras-empty__btn"}," Setup Cameras ")]))]),I(Ze,{ref_key:"cameraModalRef",ref:D,"camera-name":R.value,onClose:S},null,8,["camera-name"]),I(ro,{ref_key:"cameraSetupModalRef",ref:k,onUpdated:b},null,512),e("div",{class:"sidebar__card"},[y[12]||(y[12]=e("div",{class:"sidebar__label"},"Quick Actions",-1)),e("button",{onClick:A,class:"sidebar__btn"},[...y[11]||(y[11]=[e("svg",{class:"sidebar__btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","stroke-width":"1.8"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("circle",{cx:"12",cy:"12",r:"3"})],-1),se(" Configure Inputs ",-1)])])])],64))])}}}),Po=le(Eo,[["__scopeId","data-v-a373edd4"]]),Lo={class:"h-full flex flex-col"},Ao={class:"recorder-header"},Do={class:"recorder-header__left"},Bo={class:"recorder-header__title"},Ho={key:0,class:"recorder-header__badge"},No={class:"flex-1 flex min-h-0 overflow-hidden"},Wo={class:"flex-1 min-h-0 min-w-0 p-3 overflow-hidden"},Fo={class:"w-72 flex-shrink-0 border-l border-preke-surface-border bg-preke-surface/80 backdrop-blur-lg p-4 overflow-y-auto"},Uo=Z({__name:"RecorderView",setup(n){const t=Ne(),o=J(),m=xe(),{showLeaveConfirmation:i,confirmLeave:c,cancelLeave:s}=tt();function a(){t.push("/")}const r=T(()=>o.status==="recording"),d=T(()=>o.formattedDuration),l=h(!0),C=h(!1),u=h(!1),_=T(()=>C.value&&u.value);function v(){l.value=!1}async function R(){var S;if(!Ye())return;await m.fetchCapabilities();const x=(S=m.capabilities)==null?void 0:S.current_mode;if(x&&x!=="recorder"){console.log("[Recorder] Not in recorder mode, switching...");try{(await fetch(await Qe("/api/mode/recorder"),{method:"POST"})).ok&&(await m.fetchCapabilities(),ee.success("Switched to Recorder mode"))}catch(B){console.warn("[Recorder] Failed to switch mode:",B)}}}function D(){console.log("[Recorder] All videos ready!"),u.value=!0}oe(async()=>{const x=performance.now();await Promise.all([R(),o.fetchInputs(),o.fetchStatus()]);const S=o.inputs.filter(B=>B.hasSignal).length;console.log(`[Recorder] Data loaded: ${o.inputs.length} inputs, ${S} with signal (${Math.round(performance.now()-x)}ms)`),C.value=!0,S===0&&(u.value=!0)});const k=h(null);return Y(i,x=>{var S,B;x?(S=k.value)==null||S.open():(B=k.value)==null||B.close()}),(x,S)=>(f(),g(K,null,[I(ve,{name:"fade"},{default:ne(()=>[l.value?(f(),ae(et,{key:0,mode:"recorder","content-ready":_.value,"min-time":1500,"max-time":5e3,"show-cancel":!0,onReady:v,onCancel:a},null,8,["content-ready"])):W("",!0)]),_:1}),I(ve,{name:"content-fade"},{default:ne(()=>[X(e("div",Lo,[e("header",Ao,[e("div",Do,[e("div",Bo,[e("span",{class:V(["recorder-header__indicator",{"recorder-header__indicator--active":r.value}])},null,2),S[0]||(S[0]=e("span",{class:"recorder-header__label"},"Recorder",-1))]),r.value?(f(),g("span",Ho," REC ")):W("",!0),I(Ht)]),I(Rt)]),e("div",No,[e("div",Wo,[I(wn,{onAllVideosReady:D})]),e("aside",Fo,[I(Po)])]),I(Ae,{ref_key:"leaveDialog",ref:k,title:"Recording in Progress",message:`You are currently recording (${d.value}). Leaving will stop the recording and save all files.`,"confirm-text":"Leave and Stop Recording","cancel-text":"Stay",danger:!0,onConfirm:re(c),onCancel:re(s)},null,8,["message","onConfirm","onCancel"])],512),[[Xe,!l.value]])]),_:1})],64))}}),Io=le(Uo,[["__scopeId","data-v-a7fdeea3"]]);export{Io as default};
