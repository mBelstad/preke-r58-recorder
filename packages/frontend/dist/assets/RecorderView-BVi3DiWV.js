import{B as W,C as D,o as G,l as X,D as Pe,r as y,E as Y,G as me,j as w,H as Ae,d as B,I as le,m as A,T as ce,p as ue,J as Le,c as b,e as R,a as t,w as De,y as We,t as _,x as Be,i as m,_ as de,K as He,h as H,F as I,n as k,q as Q,L as he,M as $,u as be,f as Ne,s as ye,g as Ue,N as Fe,b as je}from"./index-DFQ6yhp7.js";import{M as Ve}from"./ModeLoadingScreen-DBw8DHDv.js";const j=y(!1),z=y(!1);let V=null;function Ie(){const n=W();D(()=>n.status,r=>{j.value=r==="recording"},{immediate:!0});function e(r){if(j.value)return r.preventDefault(),r.returnValue="Recording in progress. Are you sure you want to leave?",r.returnValue}G(()=>{window.addEventListener("beforeunload",e)}),X(()=>{window.removeEventListener("beforeunload",e)}),Pe((r,l,s)=>{j.value?(V=()=>s(),z.value=!0,s(!1)):s()});function o(){z.value=!1,j.value=!1,n.stopRecording().finally(()=>{V&&(V(),V=null)})}function p(){z.value=!1,V=null}return{isGuardActive:j,showLeaveConfirmation:z,confirmLeave:o,cancelLeave:p}}const Ge=["65.109.32.111"],Oe=5,qe=1e3,ze=3e4,L=new Map,F=new Map;function Ke(n){const e=Y(),o=me();if(console.log(`[WHEP Manager ${n}] Building URL:`),console.log(`  - deviceUrl: "${e}"`),console.log(`  - usingFrpFallback: ${o}`),console.log(`  - window.__R58_DEVICE_URL__: "${window.__R58_DEVICE_URL__}"`),e)try{const l=`http://${new URL(e).hostname}:8889/${n}/whep`;return console.log(`[WHEP Manager ${n}] ✓ Using direct P2P URL: ${l}`),l}catch(r){console.warn(`[WHEP Manager ${n}] Invalid device URL, falling back to FRP:`,r)}const p=`https://r58-mediamtx.itagenten.no/${n}/whep`;return console.log(`[WHEP Manager ${n}] ✗ Using FRP URL (no device URL): ${p}`),p}async function Ye(n,e){const o=L.get(e);if(!o)return"unknown";try{const l=new URL(o.whepUrl).hostname;if(l.includes("itagenten.no"))return console.log(`[WHEP Manager ${e}] Detected relay (FRP URL)`),"relay";if(l.startsWith("100."))return console.log(`[WHEP Manager ${e}] Detected P2P (Tailscale IP: ${l})`),"p2p";if(l.startsWith("192.168.")||l.startsWith("10.")||l.startsWith("172."))return console.log(`[WHEP Manager ${e}] Detected P2P (LAN IP: ${l})`),"p2p"}catch(r){console.warn(`[WHEP Manager ${e}] Failed to parse WHEP URL:`,r)}try{const r=await n.getStats();for(const l of r.values())if(l.type==="candidate-pair"&&l.state==="succeeded"){const s=r.get(l.remoteCandidateId);if((s==null?void 0:s.candidateType)==="relay")return console.log(`[WHEP Manager ${e}] Detected relay (TURN candidate)`),"relay";const a=s==null?void 0:s.address;if(a&&Ge.includes(a))return console.log(`[WHEP Manager ${e}] Detected relay (VPS IP: ${a})`),"relay"}}catch(r){console.warn(`[WHEP Manager ${e}] Failed to get WebRTC stats:`,r)}return Y()&&!me()?(console.log(`[WHEP Manager ${e}] Assuming P2P (direct device URL configured)`),"p2p"):"unknown"}function N(n){const e=L.get(n);if(!e)return;const o=F.get(n);o&&o.forEach(p=>p(e))}function te(n){const e=L.get(n);if(!e)return;if(e.reconnectAttempts>=Oe){console.error(`[WHEP Manager ${n}] Max reconnect attempts reached`),e.state="failed",N(n);return}e.reconnectAttempts++;const o=Math.min(qe*Math.pow(2,e.reconnectAttempts-1),ze);console.log(`[WHEP Manager ${n}] Scheduling reconnect #${e.reconnectAttempts} in ${o}ms`),e.state="connecting",N(n),e.reconnectTimeout&&clearTimeout(e.reconnectTimeout),e.reconnectTimeout=setTimeout(()=>{J(n)},o)}async function J(n){let e=L.get(n);if(e&&(e.state==="connected"||e.state==="connecting"))return console.log(`[WHEP Manager ${n}] Reusing existing connection (state: ${e.state})`),e;let o=Y(),p=0;for(;!o&&p<5;)console.log(`[WHEP Manager ${n}] No device URL yet, waiting... (attempt ${p+1})`),await new Promise(a=>setTimeout(a,100)),o=Y(),p++;const r=performance.now(),l=Ke(n);console.log(`[WHEP Manager ${n}] Creating connection to: ${l}`),console.log(`[WHEP Manager ${n}] Device URL was: ${o}`),e!=null&&e.peerConnection&&e.peerConnection.close();const s=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}]});e?(e.peerConnection=s,e.state="connecting",e.whepUrl=l,e.mediaStream=null,e.connectionType="unknown",e.connectionStartTime=r):(e={cameraId:n,peerConnection:s,mediaStream:null,state:"connecting",connectionType:"unknown",refCount:0,whepUrl:l,lastConnectedAt:null,reconnectAttempts:(e==null?void 0:e.reconnectAttempts)||0,reconnectTimeout:null,connectionStartTime:r},L.set(n,e)),s.ontrack=a=>{a.streams[0]&&(e.mediaStream=a.streams[0],console.log(`[WHEP Manager ${n}] Received media stream`),N(n))},s.oniceconnectionstatechange=async()=>{const a=s.iceConnectionState;if(console.log(`[WHEP Manager ${n}] ICE state: ${a}`),a==="connected"||a==="completed"){e.state="connected",e.lastConnectedAt=Date.now(),e.reconnectAttempts=0,e.connectionType=await Ye(s,n);const v=e.connectionStartTime?Math.round(performance.now()-e.connectionStartTime):0;console.log(`[WHEP Manager ${n}] Connected (${e.connectionType}) in ${v}ms`),N(n)}else a==="failed"?(e.state="failed",e.connectionType="unknown",N(n),e.refCount>0&&te(n)):a==="disconnected"&&setTimeout(()=>{(s.iceConnectionState==="disconnected"||s.iceConnectionState==="failed")&&(e.state="disconnected",N(n),e.refCount>0&&te(n))},3e3)},s.addTransceiver("video",{direction:"recvonly"}),s.addTransceiver("audio",{direction:"recvonly"});try{const a=await s.createOffer();await s.setLocalDescription(a);const v=await fetch(l,{method:"POST",headers:{"Content-Type":"application/sdp"},body:a.sdp});if(!v.ok)throw new Error(`WHEP request failed: ${v.status}`);const h=await v.text();await s.setRemoteDescription({type:"answer",sdp:h})}catch(a){console.error(`[WHEP Manager ${n}] Connection error:`,a),e.state="failed",N(n),e.refCount>0&&te(n)}return e}async function Qe(n,e){F.has(n)||F.set(n,new Set),F.get(n).add(e);let o=L.get(n);return(!o||o.state==="failed"||o.state==="disconnected")&&(o=await J(n)),o.refCount++,console.log(`[WHEP Manager ${n}] Acquired connection (refCount: ${o.refCount})`),e(o),o}function Xe(n,e){const o=L.get(n);if(!o)return;const p=F.get(n);p&&(p.delete(e),p.size===0&&F.delete(n)),o.refCount=Math.max(0,o.refCount-1),console.log(`[WHEP Manager ${n}] Released connection (refCount: ${o.refCount})`),o.refCount===0&&(console.log(`[WHEP Manager ${n}] Closing unused connection`),o.reconnectTimeout&&clearTimeout(o.reconnectTimeout),o.peerConnection.close(),L.delete(n))}function ne(n){const e=L.get(n);e&&(console.log(`[WHEP Manager ${n}] Force reconnecting...`),e.reconnectAttempts=0,J(n))}async function Je(n){console.log(`[WHEP Manager] Preloading ${n.length} connections: ${n.join(", ")}`);const e=performance.now(),o=n.map(async p=>{try{await J(p);const r=L.get(p);if(!r)return;for(let l=0;l<30;l++){if(r.mediaStream&&r.mediaStream.getVideoTracks().length>0&&r.mediaStream.getVideoTracks()[0].readyState==="live"){console.log(`[WHEP Manager ${p}] Stream ready after ${Math.round(performance.now()-e)}ms`);return}await new Promise(s=>setTimeout(s,100))}console.log(`[WHEP Manager ${p}] Stream timeout (3s) - continuing anyway`)}catch(r){console.warn(`[WHEP Manager ${p}] Preload failed:`,r)}});await Promise.all(o),console.log(`[WHEP Manager] All preloads complete in ${Math.round(performance.now()-e)}ms`)}const C=y(null),oe=y(!1),pe=y(null),se=y(null),Ze=10,re=2,et=25;function tt(){const n=w(()=>C.value?C.value.available_gb<re?"critical":C.value.available_gb<Ze?"warning":"ok":"unknown"),e=w(()=>C.value?C.value.available_gb>=re:!0),o=w(()=>{if(!C.value)return null;const a=C.value.available_gb*1024*1024*1024,v=et*1024*1024,h=a/v,i=Math.floor(h/3600),c=Math.floor(h%3600/60);return i>24?`${Math.floor(i/24)}d ${i%24}h`:i>0?`${i}h ${c}m`:`${c}m`}),p=w(()=>{switch(n.value){case"ok":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}}),r=w(()=>C.value?n.value==="critical"?`Disk space critically low (${C.value.available_gb.toFixed(1)} GB). Cannot start recording.`:n.value==="warning"?`Low disk space (${C.value.available_gb.toFixed(1)} GB). Estimated recording time: ${o.value}`:null:null);async function l(){oe.value=!0,se.value=null;try{const a=await Ae.getDegradation();if(a.resources&&a.resources.disk_free_gb!==void 0){const v=a.resources.disk_free_gb,h=v*3;C.value={available_gb:v,total_gb:h,used_percent:100-v/h*100,recording_path:"/opt/r58-app/shared/recordings"}}return pe.value=new Date,C.value}catch(a){return se.value=a.message||"Failed to check disk space",console.error("Failed to check disk space:",a),null}finally{oe.value=!1}}async function s(){return await l(),C.value?n.value==="critical"?{ok:!1,message:`Insufficient disk space (${C.value.available_gb.toFixed(1)} GB). Need at least ${re} GB to start recording.`}:n.value==="warning"?{ok:!0,message:`Low disk space warning: ${C.value.available_gb.toFixed(1)} GB available. Estimated recording time: ${o.value}`}:{ok:!0}:{ok:!0,message:"Could not verify disk space. Proceeding with caution."}}return{diskSpace:C,isLoading:oe,lastCheck:pe,error:se,status:n,statusColor:p,canStartRecording:e,estimatedRecordingTime:o,warningMessage:r,checkDiskSpace:l,preflightCheck:s}}const P=y(localStorage.getItem("r58_audio_feedback")!=="false");let ae=null;function nt(){return ae||(ae=new(window.AudioContext||window.webkitAudioContext)),ae}function E(n,e,o="sine",p=.3){if(P.value)try{const r=nt();r.state==="suspended"&&r.resume();const l=r.createOscillator(),s=r.createGain();l.connect(s),s.connect(r.destination),l.type=o,l.frequency.value=n;const a=r.currentTime;s.gain.setValueAtTime(0,a),s.gain.linearRampToValueAtTime(p,a+.01),s.gain.linearRampToValueAtTime(0,a+e),l.start(a),l.stop(a+e)}catch(r){console.warn("Audio feedback failed:",r)}}function ot(){P.value&&(E(440,.1,"sine",.2),setTimeout(()=>E(554,.1,"sine",.2),100),setTimeout(()=>E(659,.15,"sine",.25),200))}function st(){P.value&&(E(880,.08,"sine",.3),setTimeout(()=>E(880,.15,"sine",.3),120))}function rt(){P.value&&(E(659,.1,"sine",.25),setTimeout(()=>E(554,.1,"sine",.2),100),setTimeout(()=>E(440,.15,"sine",.2),200))}function at(){P.value&&(E(200,.15,"square",.15),setTimeout(()=>E(180,.2,"square",.15),180))}function it(){P.value&&(E(1e3,.08,"sine",.2),setTimeout(()=>E(1e3,.08,"sine",.2),150))}function ve(){P.value&&E(1200,.03,"sine",.1)}function lt(n=50){if(P.value&&"vibrate"in navigator)try{navigator.vibrate(n)}catch{}}function we(){function n(o){P.value=o,localStorage.setItem("r58_audio_feedback",String(o))}function e(){n(!P.value),P.value&&ve()}return{enabled:P,setEnabled:n,toggle:e,playSuccess:ot,playError:at,playWarning:it,playClick:ve,playRecordStart:st,playRecordStop:rt,vibrate:lt}}const ct={class:"bg-r58-bg-secondary rounded-lg shadow-xl max-w-md w-full p-6"},ut=["placeholder"],dt={class:"text-xs text-r58-text-secondary mt-2"},ft=B({__name:"SessionNameDialog",props:{open:{type:Boolean},suggestedName:{}},emits:["confirm","cancel","skip"],setup(n,{emit:e}){const o=n,p=e,r=y(""),l=y(null),s=w(()=>{const f=new Date,u=f.toLocaleDateString("en-CA"),g=f.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}).replace(":","");return`Recording_${u}_${g}`}),a=w(()=>o.suggestedName||s.value);D(()=>o.open,f=>{f&&(r.value=a.value,setTimeout(()=>{var u,g;(u=l.value)==null||u.focus(),(g=l.value)==null||g.select()},100))});function v(){p("confirm",r.value.trim()||a.value)}function h(){p("skip")}function i(){p("cancel")}function c(f){f.key==="Enter"?v():f.key==="Escape"&&i()}return(f,u)=>(m(),le(Le,{to:"body"},[A(ce,{name:"fade"},{default:ue(()=>[n.open?(m(),b("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:Be(i,["self"]),onKeydown:c},[t("div",ct,[u[1]||(u[1]=t("h2",{class:"text-lg font-semibold mb-2"},"Name This Recording",-1)),u[2]||(u[2]=t("p",{class:"text-r58-text-secondary text-sm mb-4"}," Give your recording a name to find it easily later (optional). ",-1)),De(t("input",{ref_key:"inputRef",ref:l,"onUpdate:modelValue":u[0]||(u[0]=g=>r.value=g),type:"text",placeholder:a.value,class:"w-full px-4 py-2 bg-r58-bg-tertiary border border-r58-bg-tertiary rounded-lg text-r58-text-primary placeholder-r58-text-secondary focus:outline-none focus:ring-2 focus:ring-r58-accent-primary"},null,8,ut),[[We,r.value]]),t("p",dt," Suggested: "+_(a.value),1),t("div",{class:"flex justify-between mt-6"},[t("button",{onClick:h,class:"text-sm text-r58-text-secondary hover:text-r58-text-primary transition-colors"}," Skip (use default) "),t("div",{class:"flex gap-3"},[t("button",{onClick:i,class:"btn"}," Cancel "),t("button",{onClick:v,class:"btn btn-primary"}," Start Recording ")])])])],32)):R("",!0)]),_:1})]))}}),gt=de(ft,[["__scopeId","data-v-df8c0a50"]]),pt={class:"flex items-center gap-4"},vt={key:0,class:"font-mono text-xl text-r58-accent-danger"},mt=["disabled","title"],ht={key:0,class:"animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"},bt={key:0,class:"w-3 h-3 bg-white rounded-sm"},yt={key:1,class:"w-3 h-3 bg-white rounded-full"},wt={class:"text-xs text-r58-text-secondary hidden md:inline"},xt=B({__name:"RecorderControls",setup(n){const e=W(),{register:o}=He(),{preflightCheck:p,status:r,canStartRecording:l}=tt(),{playRecordStart:s,playRecordStop:a,playError:v,playWarning:h,vibrate:i}=we(),c=y(null),f=y(!1),u=y(!1),g=y(!1),d=y(!1),x=y(void 0),S=w(()=>e.status==="recording"),U=w(()=>e.status==="starting"),O=w(()=>e.status==="stopping"),Z=w(()=>e.formattedDuration),_e=w(()=>U.value||O.value||u.value),ke=w(()=>U.value?"Starting recording...":O.value?"Stopping recording...":u.value?"Checking disk space...":!S.value&&!l.value?"Insufficient disk space":"");let ee=null;G(()=>{ee=o({key:" ",description:"Toggle Recording",action:$e,context:"recorder",enabled:()=>!U.value&&!O.value})}),X(()=>{ee&&ee()});async function $e(){S.value?ge():await q()}async function q(T){u.value=!0;try{const M=await p();if(!M.ok){v(),i(200),H.error("Cannot start recording",M.message||"Preflight check failed");return}if(M.message&&r.value==="warning"&&(h(),H.warning("Low disk space",M.message)),d.value&&!T){x.value=void 0,g.value=!0;return}await fe(T||x.value)}finally{u.value=!1}}async function fe(T){try{await e.startRecording(T);const M=T||e.sessionId;s(),i([50,30,50]),H.success("Recording started",`Session: ${M}`)}catch(M){v(),i(200),H.error("Failed to start recording",M.message||"Unknown error",{label:"Retry",onClick:()=>q(T)})}}function Se(T){g.value=!1,x.value=T,q(T)}function Re(){g.value=!1,x.value=void 0,q()}function Ce(){g.value=!1,u.value=!1}async function Te(){try{await e.stopRecording(),a(),i(100),H.success("Recording stopped",`Duration: ${Z.value}`)}catch(T){v(),i(200),H.error("Failed to stop recording",T.message||"Unknown error")}}function ge(){var T;f.value=!1,(T=c.value)==null||T.open(),setTimeout(()=>{f.value=!0},500)}function Me(){f.value&&Te()}async function Ee(){S.value?ge():await fe()}return(T,M)=>(m(),b(I,null,[t("div",pt,[S.value?(m(),b("div",vt,_(Z.value),1)):R("",!0),t("button",{onClick:Ee,disabled:_e.value,class:k(["flex items-center gap-2 px-6 py-2 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed",[S.value?"bg-r58-accent-danger hover:bg-red-600 text-white":"bg-r58-accent-success hover:bg-green-600 text-white"]]),title:ke.value||(S.value?"Stop Recording (Space)":"Start Recording (Space)")},[U.value||O.value||u.value?(m(),b("span",ht)):(m(),b(I,{key:1},[S.value?(m(),b("span",bt)):(m(),b("span",yt))],64)),t("span",null,_(u.value?"Checking...":S.value?"Stop":"Start Recording"),1)],10,mt),t("span",wt,[M[0]||(M[0]=Q(" Press ",-1)),M[1]||(M[1]=t("kbd",{class:"px-1 py-0.5 bg-r58-bg-tertiary rounded text-xs font-mono"},"Space",-1)),Q(" to "+_(S.value?"stop":"start"),1)])]),A(he,{ref_key:"stopConfirmDialog",ref:c,title:"Stop Recording?",message:`You have been recording for ${Z.value}. This will finalize all files.`,"confirm-text":"Stop Recording","cancel-text":"Keep Recording",danger:!0,onConfirm:Me},null,8,["message"]),A(gt,{open:g.value,onConfirm:Se,onSkip:Re,onCancel:Ce},null,8,["open"])],64))}}),K=y(localStorage.getItem("r58_performance_mode")==="true"),ie=y(localStorage.getItem("r58_performance_mode_auto")!=="false"),_t=3,kt=100,$t=500;function xe(){const n=W(),e=w(()=>K.value?!0:ie.value&&n.isRecording?n.inputs.filter(c=>c.isRecording).length>=_t:!1),o=w(()=>e.value?$t:kt);D(e,i=>{i?document.body.classList.add("performance-mode"):document.body.classList.remove("performance-mode")},{immediate:!0});function p(i){K.value=i,localStorage.setItem("r58_performance_mode",String(i))}function r(i){ie.value=i,localStorage.setItem("r58_performance_mode_auto",String(i))}function l(){p(!K.value)}function s(i,c){let f=0,u=null;return(...g)=>{const d=Date.now(),x=c??o.value,S=d-f;S>=x?(f=d,i(...g)):u||(u=window.setTimeout(()=>{f=Date.now(),u=null,i(...g)},x-S))}}function a(i,c){let f=null;return(...u)=>{f&&clearTimeout(f),f=window.setTimeout(()=>{i(...u),f=null},c??o.value)}}function v(i){return e.value?window.setTimeout(()=>i(performance.now()),o.value):requestAnimationFrame(i)}function h(i){e.value?clearTimeout(i):cancelAnimationFrame(i)}return{enabled:K,autoEnable:ie,isActive:e,updateInterval:o,setEnabled:p,setAutoEnable:r,toggle:l,throttle:s,debounce:a,requestFrame:v,cancelFrame:h}}const St=["title"],Rt={class:"flex items-center gap-1.5 text-sm"},Ct={key:0,class:"flex items-center gap-1.5 text-sm"},Tt={key:1,class:"flex items-center gap-1.5 text-sm text-red-400"},Mt={class:"font-mono"},Et=B({__name:"RecordingHealth",setup(n,{expose:e}){const o=W(),{isActive:p}=xe(),r=y({}),l=y(0),s=y(0),a=y(0);let v=null;function h(){const g={};let d=0;o.inputs.forEach(S=>{g[S.id]=S.bytesWritten;const U=r.value[S.id]||0;d+=S.bytesWritten-U});const x=p.value?2:1;l.value=Math.round(d/(1024*1024)/x*10)/10,r.value=g}D(()=>o.isRecording,g=>{if(g){r.value={},l.value=0,s.value=0,a.value=0;const d=p.value?2e3:1e3;v=window.setInterval(h,d)}else v&&(clearInterval(v),v=null)},{immediate:!0}),D(p,g=>{if(o.isRecording&&v){clearInterval(v);const d=g?2e3:1e3;v=window.setInterval(h,d)}}),X(()=>{v&&clearInterval(v)});const i=w(()=>o.isRecording?a.value>0||s.value>90?"critical":l.value<1||s.value>70?"warning":"healthy":"idle"),c=w(()=>{switch(i.value){case"healthy":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}});w(()=>{switch(i.value){case"healthy":return"Healthy";case"warning":return"Warning";case"critical":return"Critical";default:return"Idle"}});const f=w(()=>{if(!o.isRecording)return"Not recording";const g=[`Write speed: ${l.value} MB/s`,`Buffer: ${s.value}%`];return a.value>0&&g.push(`Frames dropped: ${a.value}`),g.join(`
`)});function u(g){g.buffer_percent!==void 0&&(s.value=g.buffer_percent),g.frames_dropped!==void 0&&(a.value=g.frames_dropped)}return e({updateFromMetrics:u}),(g,d)=>$(o).isRecording?(m(),b("div",{key:0,class:k(["flex items-center gap-3 px-3 py-1.5 rounded-lg transition-colors cursor-help",{"bg-emerald-500/10":c.value==="emerald","bg-amber-500/10":c.value==="amber","bg-red-500/10":c.value==="red"}]),title:f.value},[t("span",{class:k(["w-2 h-2 rounded-full",c.value==="emerald"?"bg-emerald-500":"",c.value==="amber"?"bg-amber-500 animate-pulse":"",c.value==="red"?"bg-red-500 animate-pulse":""])},null,2),t("div",Rt,[d[0]||(d[0]=t("svg",{class:"w-3.5 h-3.5 text-r58-text-secondary",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})],-1)),t("span",{class:k(["font-mono",c.value==="emerald"?"text-emerald-400":"",c.value==="amber"?"text-amber-400":"",c.value==="red"?"text-red-400":""])},_(l.value)+" MB/s ",3)]),s.value>0?(m(),b("div",Ct,[d[1]||(d[1]=t("span",{class:"text-r58-text-secondary"},"Buf:",-1)),t("span",{class:k(["font-mono",s.value<50?"text-emerald-400":"",s.value>=50&&s.value<80?"text-amber-400":"",s.value>=80?"text-red-400":""])},_(s.value)+"% ",3)])):R("",!0),a.value>0?(m(),b("div",Tt,[d[2]||(d[2]=t("svg",{class:"w-3.5 h-3.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),t("span",Mt,_(a.value)+" dropped",1)])):R("",!0)],10,St)):R("",!0)}}),Pt={class:"relative w-full h-full bg-black"},At=["title"],Lt={key:1,class:"absolute inset-0 flex items-center justify-center bg-black/50"},Dt={key:2,class:"absolute inset-0 flex items-center justify-center bg-black/70"},Wt={class:"text-center"},Bt={class:"text-xs text-amber-400"},Ht={key:3,class:"absolute inset-0 flex items-center justify-center bg-black/80"},Nt={class:"text-center text-r58-text-secondary"},Ut={class:"text-sm"},Ft=B({__name:"InputPreview",props:{inputId:{},protocol:{}},setup(n){const e=n,o=W(),p=w(()=>o.status==="recording"),r=y(null),l=y(!0),s=y(null),a=y("unknown"),v=y(!1),h=y(0);let i=null;function c(d){switch(console.log(`[InputPreview ${e.inputId}] Connection update:`,{state:d.state,type:d.connectionType,hasStream:!!d.mediaStream}),a.value=d.connectionType,h.value=d.reconnectAttempts,d.state){case"connecting":l.value=!0,s.value=null,v.value=d.reconnectAttempts>0;break;case"connected":l.value=!1,s.value=null,v.value=!1,d.mediaStream&&r.value&&r.value.srcObject!==d.mediaStream&&(r.value.srcObject=d.mediaStream);break;case"disconnected":v.value=!0,s.value=`Reconnecting... (${d.reconnectAttempts}/5)`;break;case"failed":l.value=!1,v.value=!1,s.value="Connection failed after multiple attempts";break}}async function f(){if(r.value){g(),l.value=!0,s.value=null,i=c;try{await Qe(e.inputId,i)}catch(d){console.error(`[InputPreview ${e.inputId}] Failed to acquire connection:`,d),s.value=d instanceof Error?d.message:"Failed to connect",l.value=!1}}}function u(){ne(e.inputId)}function g(){i&&(Xe(e.inputId,i),i=null)}return G(()=>{f()}),D(()=>e.inputId,()=>{f()}),D(p,(d,x)=>{x&&!d&&s.value?(console.log("[InputPreview] Recording stopped, reconnecting preview..."),ne(e.inputId)):!x&&d&&(console.log("[InputPreview] Recording started, will try to reconnect preview after delay..."),setTimeout(()=>{p.value&&(console.log("[InputPreview] Attempting to reconnect preview during recording..."),ne(e.inputId))},2e3))}),X(()=>{g()}),(d,x)=>(m(),b("div",Pt,[t("video",{ref_key:"videoRef",ref:r,autoplay:"",muted:"",playsinline:"",class:"w-full h-full object-contain"},null,512),!l.value&&!s.value&&a.value!=="unknown"?(m(),b("div",{key:0,class:k(["absolute top-1 right-1 px-1.5 py-0.5 text-[10px] font-medium rounded",a.value==="p2p"?"bg-emerald-500/80 text-white":"bg-amber-500/80 text-white"]),title:a.value==="p2p"?"Direct P2P connection":"Relay connection (FRP)"},_(a.value==="p2p"?"P2P":"RELAY"),11,At)):R("",!0),l.value&&!v.value?(m(),b("div",Lt,[...x[0]||(x[0]=[t("div",{class:"animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"},null,-1)])])):R("",!0),v.value?(m(),b("div",Dt,[t("div",Wt,[x[1]||(x[1]=t("div",{class:"animate-spin w-5 h-5 border-2 border-amber-400 border-t-transparent rounded-full mx-auto mb-2"},null,-1)),t("p",Bt,_(s.value||"Reconnecting..."),1)])])):s.value&&!l.value?(m(),b("div",Ht,[t("div",Nt,[t("p",Ut,_(s.value),1),t("button",{onClick:u,class:"mt-2 text-xs text-r58-accent-primary hover:underline"}," Retry ")])])):R("",!0)]))}}),jt={key:0,class:"h-full flex items-center justify-center"},Vt={key:1,class:"h-full flex flex-col gap-2"},It={key:0,class:"flex items-center gap-2 px-3 py-1.5 bg-amber-500/10 border border-amber-500/30 rounded-lg text-amber-400 text-sm"},Gt=["title"],Ot={key:1,class:"w-full h-full flex items-center justify-center bg-r58-bg-tertiary"},qt={class:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-4"},zt={class:"flex items-center justify-between"},Kt={class:"flex items-center gap-2"},Yt={class:"font-medium"},Qt={key:0,class:"flex items-center gap-2 text-sm"},Xt={class:"text-r58-text-secondary"},Jt={key:0,class:"mt-2 flex items-center justify-between"},Zt={class:"text-sm font-mono text-r58-text-secondary"},en=B({__name:"InputGrid",setup(n){const e=W(),o=be(),p=w(()=>{var c;return((c=o.capabilities)==null?void 0:c.current_mode)==="recorder"}),r=w(()=>e.inputs.filter(c=>c.hasSignal)),l=w(()=>e.framerateMismatch);function s(c){return c.isRecording?"border-r58-accent-danger ring-2 ring-r58-accent-danger/20":c.hasSignal?"border-emerald-500/50 hover:border-emerald-500":"border-r58-bg-tertiary/50 opacity-60"}function a(c){return c.hasSignal?c.framerate>=29?"excellent":c.framerate>=24?"good":"unstable":"none"}function v(c){switch(a(c)){case"excellent":return"text-emerald-400";case"good":return"text-emerald-400";case"unstable":return"text-amber-400";case"none":return"text-r58-text-secondary"}}function h(c){if(c===0)return"0 B";const f=1024,u=["B","KB","MB","GB"],g=Math.floor(Math.log(c)/Math.log(f));return parseFloat((c/Math.pow(f,g)).toFixed(1))+" "+u[g]}function i(c){if(!c.hasSignal)return`${c.label}: No signal detected`;const f=[`${c.label}`,`Resolution: ${c.resolution}`,`Framerate: ${c.framerate} fps`,`Quality: ${a(c)}`];return c.isRecording&&f.push(`Written: ${h(c.bytesWritten)}`),f.join(`
`)}return(c,f)=>r.value.length===0?(m(),b("div",jt,[...f[0]||(f[0]=[Ne('<div class="text-center text-r58-text-secondary"><svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg><p class="text-lg font-medium">No Video Sources Connected</p><p class="text-sm mt-2">Connect HDMI cables to begin recording</p></div>',1)])])):(m(),b("div",Vt,[l.value?(m(),b("div",It,[f[1]||(f[1]=t("svg",{class:"w-4 h-4 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20"},[t("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),t("span",null,_(l.value),1)])):R("",!0),t("div",{class:k(["flex-1 grid gap-4",r.value.length===1?"grid-cols-1":"grid-cols-2"])},[(m(!0),b(I,null,ye(r.value,u=>(m(),b("div",{key:u.id,class:k(["relative rounded-lg overflow-hidden border-2 transition-all cursor-pointer aspect-video bg-black",s(u)]),title:i(u)},[p.value?(m(),le(Ft,{key:0,"input-id":u.id,class:"w-full h-full"},null,8,["input-id"])):(m(),b("div",Ot,[...f[2]||(f[2]=[t("div",{class:"text-center"},[t("svg",{class:"w-8 h-8 mx-auto mb-2 text-r58-text-secondary/50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})]),t("span",{class:"text-xs text-r58-text-secondary/70"},"Mixer mode")],-1)])])),t("div",qt,[t("div",zt,[t("div",Kt,[t("span",{class:k(["w-2 h-2 rounded-full transition-colors",{"bg-emerald-500":a(u)==="excellent"||a(u)==="good","bg-amber-500 animate-pulse":a(u)==="unstable","bg-r58-text-secondary":a(u)==="none"}])},null,2),t("span",Yt,_(u.label),1)]),u.hasSignal?(m(),b("div",Qt,[t("span",Xt,_(u.resolution),1),t("span",{class:k(v(u))},_(u.framerate)+"fps",3)])):R("",!0)]),u.isRecording?(m(),b("div",Jt,[f[3]||(f[3]=t("div",{class:"flex items-center gap-2 text-r58-accent-danger"},[t("span",{class:"w-2 h-2 rounded-full bg-r58-accent-danger animate-recording"}),t("span",{class:"text-sm font-medium"},"REC")],-1)),t("span",Zt,_(h(u.bytesWritten)),1)])):R("",!0)])],10,Gt))),128))],2)]))}}),tn={class:"space-y-4"},nn={class:"flex items-center justify-between py-2 cursor-pointer"},on=["aria-checked"],sn={class:"flex items-center justify-between py-2 cursor-pointer"},rn=["aria-checked"],an={class:"flex items-center justify-between py-2 cursor-pointer"},ln={class:"text-xs text-r58-text-secondary"},cn={key:0,class:"text-amber-400"},un=["aria-checked"],dn={class:"flex items-center justify-between py-2 pl-4 cursor-pointer opacity-80"},fn=["aria-checked"],gn=B({__name:"SettingsPanel",setup(n){const{enabled:e,toggle:o,playClick:p}=we(),{enabled:r,autoEnable:l,isActive:s,setEnabled:a,setAutoEnable:v}=xe(),h=y(!1);function i(){h.value=!h.value,h.value?(document.body.classList.add("touch-mode"),localStorage.setItem("r58_touch_mode","true")):(document.body.classList.remove("touch-mode"),localStorage.setItem("r58_touch_mode","false"))}G(()=>{const f=localStorage.getItem("r58_touch_mode")==="true";h.value=f,f&&document.body.classList.add("touch-mode")});function c(){o(),e.value&&p()}return(f,u)=>(m(),b("div",tn,[u[7]||(u[7]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide"}," Interface Settings ",-1)),t("label",nn,[u[2]||(u[2]=t("div",null,[t("span",{class:"text-r58-text-primary"},"Audio Feedback"),t("p",{class:"text-xs text-r58-text-secondary"},"Play sounds for recording start/stop")],-1)),t("button",{onClick:c,class:k(["relative w-12 h-7 rounded-full transition-colors",$(e)?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":$(e)},[t("span",{class:k(["absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform",$(e)?"translate-x-6":"translate-x-1"])},null,2)],10,on)]),t("label",sn,[u[3]||(u[3]=t("div",null,[t("span",{class:"text-r58-text-primary"},"Touch Mode"),t("p",{class:"text-xs text-r58-text-secondary"},"Larger buttons for touchscreen")],-1)),t("button",{onClick:i,class:k(["relative w-12 h-7 rounded-full transition-colors",h.value?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":h.value},[t("span",{class:k(["absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform",h.value?"translate-x-6":"translate-x-1"])},null,2)],10,rn)]),t("label",an,[t("div",null,[u[5]||(u[5]=t("span",{class:"text-r58-text-primary"},"Performance Mode",-1)),t("p",ln,[u[4]||(u[4]=Q(" Reduce UI updates during recording ",-1)),$(s)&&!$(r)?(m(),b("span",cn,"(auto-enabled)")):R("",!0)])]),t("button",{onClick:u[0]||(u[0]=g=>$(a)(!$(r))),class:k(["relative w-12 h-7 rounded-full transition-colors",$(r)?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":$(r)},[t("span",{class:k(["absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform",$(r)?"translate-x-6":"translate-x-1"])},null,2)],10,un)]),t("label",dn,[u[6]||(u[6]=t("div",null,[t("span",{class:"text-sm text-r58-text-primary"},"Auto-enable when recording 3+ inputs")],-1)),t("button",{onClick:u[1]||(u[1]=g=>$(v)(!$(l))),class:k(["relative w-10 h-6 rounded-full transition-colors",$(l)?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":$(l)},[t("span",{class:k(["absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform",$(l)?"translate-x-4":"translate-x-0.5"])},null,2)],10,fn)])]))}}),pn={class:"space-y-6"},vn={key:0,class:"card"},mn={class:"space-y-2"},hn={class:"flex justify-between"},bn={class:"flex justify-between"},yn={class:"font-mono"},wn={class:"flex justify-between"},xn={class:"card"},_n={class:"space-y-3"},kn={class:"flex items-center gap-2"},$n={key:0,class:"text-sm text-r58-text-secondary"},Sn={key:0,class:"text-r58-accent-danger"},Rn={key:1},Cn={key:1,class:"text-sm text-r58-text-secondary"},Tn={class:"card"},Mn={class:"space-y-2"},En=["disabled","title"],Pn={key:0,class:"absolute -top-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-r58-bg-tertiary text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none"},An={key:0,class:"card"},Ln=B({__name:"SessionInfo",setup(n){const e=Ue(),o=W(),p=w(()=>o.currentSession),r=w(()=>o.activeInputs),l=w(()=>o.isRecording),s=y(!1);function a(h){if(h===0)return"0 B";const i=1024,c=["B","KB","MB","GB","TB"],f=Math.floor(Math.log(h)/Math.log(i));return parseFloat((h/Math.pow(i,f)).toFixed(2))+" "+c[f]}function v(){e.push({name:"admin",query:{tab:"settings"}})}return(h,i)=>(m(),b("div",pn,[p.value?(m(),b("div",vn,[i[4]||(i[4]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide mb-3"},"Current Session",-1)),t("div",mn,[t("div",hn,[i[1]||(i[1]=t("span",{class:"text-r58-text-secondary"},"Started",-1)),t("span",null,_(p.value.startedAt.toLocaleTimeString()),1)]),t("div",bn,[i[2]||(i[2]=t("span",{class:"text-r58-text-secondary"},"Duration",-1)),t("span",yn,_($(o).formattedDuration),1)]),t("div",wn,[i[3]||(i[3]=t("span",{class:"text-r58-text-secondary"},"Inputs",-1)),t("span",null,_(r.value.length)+" active",1)])])])):R("",!0),t("div",xn,[i[5]||(i[5]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide mb-3"},"Input Status",-1)),t("div",_n,[(m(!0),b(I,null,ye($(o).inputs,c=>(m(),b("div",{key:c.id,class:"flex items-center justify-between py-2 border-b border-r58-bg-tertiary last:border-0"},[t("div",kn,[t("span",{class:k(["w-2 h-2 rounded-full",c.hasSignal?"bg-r58-accent-success":"bg-r58-text-secondary"])},null,2),t("span",{class:k(c.hasSignal?"":"text-r58-text-secondary")},_(c.label),3)]),c.hasSignal?(m(),b("div",$n,[c.isRecording?(m(),b("span",Sn,_(a(c.bytesWritten)),1)):(m(),b("span",Rn,_(c.resolution),1))])):(m(),b("span",Cn,"No signal"))]))),128))])]),t("div",Tn,[i[7]||(i[7]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide mb-3"},"Quick Actions",-1)),t("div",Mn,[t("button",{onClick:v,class:"btn w-full justify-center disabled:opacity-50 disabled:cursor-not-allowed group relative",disabled:l.value,title:l.value?"Cannot configure while recording":"Open input configuration"},[i[6]||(i[6]=Q(" Configure Inputs ",-1)),l.value?(m(),b("span",Pn," Stop recording first ")):R("",!0)],8,En),t("button",{onClick:i[0]||(i[0]=c=>s.value=!s.value),class:"btn w-full justify-center"},_(s.value?"Hide Settings":"Interface Settings"),1)])]),A(ce,{name:"slide-fade"},{default:ue(()=>[s.value?(m(),b("div",An,[A(gn)])):R("",!0)]),_:1})]))}}),Dn=de(Ln,[["__scopeId","data-v-8910ebdc"]]),Wn={class:"h-full flex flex-col"},Bn={class:"flex items-center justify-between px-6 py-4 border-b border-r58-bg-tertiary bg-r58-bg-secondary"},Hn={class:"flex items-center gap-4"},Nn={class:"flex items-center gap-2"},Un={key:0,class:"badge badge-danger"},Fn={class:"flex-1 flex overflow-hidden"},jn={class:"flex-1 p-4"},Vn={class:"w-80 border-l border-r58-bg-tertiary bg-r58-bg-secondary p-4 overflow-y-auto"},In=B({__name:"RecorderView",setup(n){const e=W(),o=be(),{showLeaveConfirmation:p,confirmLeave:r,cancelLeave:l}=Ie(),s=w(()=>e.status==="recording"),a=w(()=>e.formattedDuration),v=y(!0),h=y(!1);function i(){v.value=!1}async function c(){var d;if(!Fe())return;await o.fetchCapabilities();const g=(d=o.capabilities)==null?void 0:d.current_mode;if(g&&g!=="recorder"){console.log("[Recorder] Not in recorder mode, switching...");try{(await fetch(je("/api/mode/recorder"),{method:"POST"})).ok&&(await o.fetchCapabilities(),H.success("Switched to Recorder mode"))}catch(x){console.warn("[Recorder] Failed to switch mode:",x)}}}async function f(){const g=e.inputs.filter(d=>d.hasSignal).map(d=>d.id);if(g.length===0){console.log("[Recorder] No cameras with signal to preload");return}console.log(`[Recorder] Preloading ${g.length} video streams...`),await Je(g)}G(async()=>{const g=performance.now();await Promise.all([c(),e.fetchInputs(),e.fetchStatus()]),console.log(`[Recorder] Loaded ${e.inputs.length} inputs, ${e.inputs.filter(d=>d.hasSignal).length} with signal`),await f(),console.log(`[Recorder] Total load time: ${Math.round(performance.now()-g)}ms`),h.value=!0});const u=y(null);return D(p,g=>{var d,x;g?(d=u.value)==null||d.open():(x=u.value)==null||x.close()}),(g,d)=>(m(),b(I,null,[A(ce,{name:"fade"},{default:ue(()=>[v.value?(m(),le(Ve,{key:0,mode:"recorder","content-ready":h.value,"min-time":1500,"max-time":5e3,onReady:i},null,8,["content-ready"])):R("",!0)]),_:1}),t("div",Wn,[t("header",Bn,[t("div",Hn,[t("div",Nn,[t("span",{class:k(["w-3 h-3 rounded-full",s.value?"bg-r58-accent-danger animate-recording":"bg-r58-bg-tertiary"])},null,2),d[0]||(d[0]=t("span",{class:"text-xl font-semibold"},"Recorder",-1))]),s.value?(m(),b("span",Un,"RECORDING")):R("",!0),A(Et)]),A(xt)]),t("div",Fn,[t("div",jn,[A(en)]),t("aside",Vn,[A(Dn)])]),A(he,{ref_key:"leaveDialog",ref:u,title:"Recording in Progress",message:`You are currently recording (${a.value}). Leaving will stop the recording and save all files.`,"confirm-text":"Leave and Stop Recording","cancel-text":"Stay",danger:!0,onConfirm:$(r),onCancel:$(l)},null,8,["message","onConfirm","onCancel"])])],64))}}),qn=de(In,[["__scopeId","data-v-59d3aa14"]]);export{qn as default};
