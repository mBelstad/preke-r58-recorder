const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-51tLXJEQ.js","assets/index-CUkGBgLQ.css"])))=>i.map(i=>d[i]);
import{a4 as E,a1 as O,a5 as D,d as B,G as j,l as q,r as m,o as G,H as A,p as V,c as T,e as g,f as R,n as X,t as M,k as P}from"./index-51tLXJEQ.js";function S(t){return t.startsWith("192.168.")||t.startsWith("10.")||t.startsWith("172.")||t.startsWith("100.")||t==="127.0.0.1"||t==="localhost"}const Y=5,z=1e3,K=3e4,J=()=>typeof window<"u"&&window.__NETWORK_DEBUG__===!0,L=new Map,Q=1e3;function C(t,e,...n){if(!J())return;const u=Date.now(),r=L.get(t)||0;u-r<Q||(L.set(t,u),console.log(`[NETWORK DEBUG ${t}] ${e}`,...n))}const f=new Map,h=new Map;async function Z(t){const e=E(),n=D();if(e&&!n)try{return`http://${new URL(e).hostname}:8889/${t}/whep`}catch{console.warn("[WHEP Manager] Invalid device URL, falling back to FRP")}if(!(typeof window<"u"&&!!window.electronAPI)&&typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"))return console.log("[WHEP Manager] Local device mode, using localhost MediaMTX"),`http://localhost:8889/${t}/whep`;if(typeof window<"u"&&window.location.hostname==="app.itagenten.no")return console.log("[WHEP Manager] Browser access from app.itagenten.no, using same-domain proxy"),`https://app.itagenten.no/${t}/whep`;const{getFrpUrl:r}=await O(async()=>{const{getFrpUrl:s}=await import("./index-51tLXJEQ.js").then(o=>o.a8);return{getFrpUrl:s}},__vite__mapDeps([0,1])),l=await r();if(l)try{const s=new URL(l);return s.hostname.includes("itagenten.no")?`https://app.itagenten.no/${t}/whep`:s.hostname.includes("mediamtx")?`${l}/${t}/whep`:`https://${s.hostname.replace("api","mediamtx")}/${t}/whep`}catch{console.warn("[WHEP Manager] Invalid FRP URL, cannot build WHEP URL")}throw new Error("No device configured and no FRP fallback available")}async function I(t,e){const n=f.get(e);if(!n)return"unknown";try{const l=new URL(n.whepUrl).hostname;if(l.includes("itagenten.no"))return console.log(`[WHEP Manager ${e}] Detected relay (FRP URL)`),"relay";if(S(l))return console.log(`[WHEP Manager ${e}] Detected P2P (private IP: ${l})`),"p2p"}catch(r){console.warn(`[WHEP Manager ${e}] Failed to parse WHEP URL:`,r)}try{const r=await t.getStats();for(const l of r.values())if(l.type==="candidate-pair"&&l.state==="succeeded"){const s=r.get(l.remoteCandidateId);if((s==null?void 0:s.candidateType)==="relay")return console.log(`[WHEP Manager ${e}] Detected relay (TURN candidate)`),"relay";const o=s==null?void 0:s.address;if(o&&!S(o))return console.log(`[WHEP Manager ${e}] Detected relay (public IP: ${o})`),"relay"}}catch(r){console.warn(`[WHEP Manager ${e}] Failed to get WebRTC stats:`,r)}return E()&&!D()?(console.log(`[WHEP Manager ${e}] Assuming P2P (direct device URL configured)`),"p2p"):"unknown"}function w(t){const e=f.get(t);if(!e)return;const n=h.get(t);n&&n.forEach(u=>u(e))}function b(t){const e=f.get(t);if(!e)return;if(e.reconnectAttempts>=Y){console.error(`[WHEP Manager ${t}] Max reconnect attempts reached`),e.state="failed",w(t);return}e.reconnectAttempts++;const n=Math.min(z*Math.pow(2,e.reconnectAttempts-1),K),u=n*.2*(Math.random()*2-1),r=Math.max(100,Math.round(n+u));C("WHEP",`Camera ${t}: Reconnect #${e.reconnectAttempts} in ${r}ms (base: ${n}ms)`),console.log(`[WHEP Manager ${t}] Scheduling reconnect #${e.reconnectAttempts} in ${r}ms`),e.state="connecting",w(t),e.reconnectTimeout&&clearTimeout(e.reconnectTimeout),e.reconnectTimeout=setTimeout(()=>{H(t)},r)}async function H(t){let e=f.get(t);if(e&&(e.state==="connected"||e.state==="connecting"))return console.log(`[WHEP Manager ${t}] Reusing existing connection (state: ${e.state})`),e;if(e!=null&&e.isConnecting){for(C("WHEP",`Camera ${t}: Connection already in progress, skipping duplicate attempt`),console.log(`[WHEP Manager ${t}] Connection already in progress, waiting...`);e.isConnecting&&e.state==="connecting"&&(await new Promise(i=>setTimeout(i,100)),e=f.get(t),!!e););if(e)return e}const u=!(typeof window<"u"&&!!window.electronAPI)&&typeof window<"u"&&(window.location.hostname==="app.itagenten.no"||window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1");let r=E();if(u)console.log(`[WHEP Manager ${t}] Browser-only mode (no Electron) - using appropriate proxy`);else{let i=0;for(;!r&&i<5;)console.log(`[WHEP Manager ${t}] No device URL yet, waiting... (attempt ${i+1})`),await new Promise(c=>setTimeout(c,100)),r=E(),i++}const l=performance.now(),s=await Z(t);C("WHEP",`Camera ${t}: Creating connection to ${s}`),console.log(`[WHEP Manager ${t}] Creating connection to: ${s}`),console.log(`[WHEP Manager ${t}] Device URL was: ${r||"none (browser mode)"}`),e!=null&&e.peerConnection&&e.peerConnection.close(),e!=null&&e.disconnectedTimeout&&(clearTimeout(e.disconnectedTimeout),e.disconnectedTimeout=null),e&&(e.isConnecting=!0);const o=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}]});e?(e.peerConnection=o,e.state="connecting",e.whepUrl=s,e.mediaStream=null,e.connectionType="unknown",e.connectionStartTime=l,e.isConnecting=!0):(e={cameraId:t,peerConnection:o,mediaStream:null,state:"connecting",connectionType:"unknown",refCount:0,whepUrl:s,lastConnectedAt:null,reconnectAttempts:0,reconnectTimeout:null,disconnectedTimeout:null,connectionStartTime:l,isConnecting:!0},f.set(t,e)),o.ontrack=i=>{if(i.streams[0]){e.mediaStream=i.streams[0],console.log(`[WHEP Manager ${t}] Received media stream`);try{const c=o.getReceivers();for(const p of c)p.track.kind==="video"&&"jitterBufferTarget"in p&&(p.jitterBufferTarget=100,console.log(`[WHEP Manager ${t}] Set jitterBufferTarget to 100ms for low latency`))}catch(c){console.warn(`[WHEP Manager ${t}] Could not set jitterBufferTarget:`,c)}w(t)}},o.oniceconnectionstatechange=async()=>{const i=o.iceConnectionState;if(C("WHEP",`Camera ${t}: ICE state changed to ${i}`),console.log(`[WHEP Manager ${t}] ICE state: ${i}`),i==="connected"||i==="completed"){e.state="connected",e.lastConnectedAt=Date.now(),e.reconnectAttempts=0,e.isConnecting=!1,e.connectionType=await I(o,t),e.disconnectedTimeout&&(clearTimeout(e.disconnectedTimeout),e.disconnectedTimeout=null);const c=e.connectionStartTime?Math.round(performance.now()-e.connectionStartTime):0;console.log(`[WHEP Manager ${t}] Connected (${e.connectionType}) in ${c}ms`),w(t)}else i==="failed"?(e.state="failed",e.connectionType="unknown",e.isConnecting=!1,w(t),e.refCount>0&&b(t)):i==="disconnected"&&(e.disconnectedTimeout&&clearTimeout(e.disconnectedTimeout),e.disconnectedTimeout=setTimeout(()=>{(o.iceConnectionState==="disconnected"||o.iceConnectionState==="failed")&&(e.state="disconnected",e.isConnecting=!1,w(t),e.refCount>0&&b(t)),e.disconnectedTimeout=null},3e3))},o.addTransceiver("video",{direction:"recvonly"}),o.addTransceiver("audio",{direction:"recvonly"});try{const i=await o.createOffer();await o.setLocalDescription(i);const c=await fetch(s,{method:"POST",headers:{"Content-Type":"application/sdp"},body:i.sdp});if(!c.ok)throw new Error(`WHEP request failed: ${c.status}`);const p=await c.text();await o.setRemoteDescription({type:"answer",sdp:p})}catch(i){console.error(`[WHEP Manager ${t}] Connection error:`,i),e.state="failed",e.isConnecting=!1,w(t),e.refCount>0&&b(t)}return e}async function ee(t,e){h.has(t)||h.set(t,new Set),h.get(t).add(e);let n=f.get(t);return(!n||n.state==="failed"||n.state==="disconnected")&&(n=await H(t)),n.refCount++,console.log(`[WHEP Manager ${t}] Acquired connection (refCount: ${n.refCount})`),e(n),n}function te(t,e){const n=f.get(t);if(!n)return;const u=h.get(t);u&&(u.delete(e),u.size===0&&h.delete(t)),n.refCount=Math.max(0,n.refCount-1),console.log(`[WHEP Manager ${t}] Released connection (refCount: ${n.refCount})`),n.refCount===0&&(console.log(`[WHEP Manager ${t}] Closing unused connection`),n.reconnectTimeout&&clearTimeout(n.reconnectTimeout),n.disconnectedTimeout&&clearTimeout(n.disconnectedTimeout),n.peerConnection.close(),f.delete(t))}function W(t){const e=f.get(t);e&&(console.log(`[WHEP Manager ${t}] Force reconnecting...`),e.reconnectAttempts=0,H(t))}const ne={class:"relative w-full h-full bg-black"},oe=["title"],ie={key:1,class:"absolute inset-0 flex items-center justify-center bg-black/50"},se={class:"text-center"},ce={class:"text-xs text-amber-400"},re={key:3,class:"absolute inset-0 flex items-center justify-center bg-black/80"},ae={class:"text-center text-preke-text-dim"},le={class:"text-sm"},de=B({__name:"InputPreview",props:{inputId:{},protocol:{}},emits:["videoReady","aspectRatio"],setup(t,{emit:e}){const n=t,u=e,r=j();let l=!1;const s=q(()=>r.status==="recording"),o=m(null),i=m(!0),c=m(null),p=m("unknown"),v=m(!1),F=m(0);let y=null;function N(a){switch(console.log(`[InputPreview ${n.inputId}] Connection update:`,{state:a.state,type:a.connectionType,hasStream:!!a.mediaStream}),p.value=a.connectionType,F.value=a.reconnectAttempts,a.state){case"connecting":i.value=!0,c.value=null,v.value=a.reconnectAttempts>0;break;case"connected":i.value=!1,c.value=null,v.value=!1,a.mediaStream&&o.value&&o.value.srcObject!==a.mediaStream&&(o.value.srcObject=a.mediaStream,o.value.play().catch(d=>{console.warn(`[InputPreview ${n.inputId}] Autoplay prevented:`,d)}),l||(o.value.onloadeddata=()=>{if(!l&&o.value){l=!0;const d=o.value.videoWidth,$=o.value.videoHeight,U=d&&$?d/$:16/9;console.log(`[InputPreview ${n.inputId}] Video ready (${d}x${$}, ratio: ${U.toFixed(3)})`),u("aspectRatio",U),u("videoReady")}}));break;case"disconnected":v.value=!0,c.value=`Reconnecting... (${a.reconnectAttempts}/5)`;break;case"failed":i.value=!1,v.value=!1,c.value="Connection failed after multiple attempts";break}}async function k(){if(o.value){_(),i.value=!0,c.value=null,y=N;try{await ee(n.inputId,y)}catch(a){console.error(`[InputPreview ${n.inputId}] Failed to acquire connection:`,a),c.value=a instanceof Error?a.message:"Failed to connect",i.value=!1}}}function x(){W(n.inputId)}function _(){y&&(te(n.inputId,y),y=null)}return G(()=>{k()}),A(()=>n.inputId,()=>{k()}),A(s,(a,d)=>{d&&!a&&c.value?(console.log("[InputPreview] Recording stopped, reconnecting preview..."),W(n.inputId)):!d&&a&&(console.log("[InputPreview] Recording started, will try to reconnect preview after delay..."),setTimeout(()=>{s.value&&(console.log("[InputPreview] Attempting to reconnect preview during recording..."),W(n.inputId))},2e3))}),V(()=>{_()}),(a,d)=>(P(),T("div",ne,[g("video",{ref_key:"videoRef",ref:o,autoplay:"",muted:"",playsinline:"",class:"w-full h-full object-contain"},null,512),!i.value&&!c.value&&p.value!=="unknown"?(P(),T("div",{key:0,class:X(["absolute top-1 right-1 px-1.5 py-0.5 text-[10px] font-medium rounded",p.value==="p2p"?"bg-emerald-500/80 text-white":"bg-amber-500/80 text-white"]),title:p.value==="p2p"?"Direct P2P connection":"Relay connection (FRP)"},M(p.value==="p2p"?"P2P":"RELAY"),11,oe)):R("",!0),i.value&&!v.value?(P(),T("div",ie,[...d[0]||(d[0]=[g("div",{class:"animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"},null,-1)])])):R("",!0),v.value?(P(),T("div",{key:2,class:"absolute inset-0 flex items-center justify-center bg-black/70 cursor-pointer",onClick:x,title:"Click to force reconnect"},[g("div",se,[d[1]||(d[1]=g("div",{class:"animate-spin w-5 h-5 border-2 border-amber-400 border-t-transparent rounded-full mx-auto mb-2"},null,-1)),g("p",ce,M(c.value||"Reconnecting..."),1),d[2]||(d[2]=g("p",{class:"text-xs text-amber-400/60 mt-1"},"Tap to retry",-1))])])):c.value&&!i.value?(P(),T("div",re,[g("div",ae,[g("p",le,M(c.value),1),g("button",{onClick:x,class:"mt-2 text-xs text-preke-gold hover:underline"}," Retry ")])])):R("",!0)]))}});export{de as _};
