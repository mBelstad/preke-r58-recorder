const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-C-y8EoDv.js","assets/index-D6CbdW7O.css"])))=>i.map(i=>d[i]);
import{r as _,E as ee,G as Z,o as ae,p as be,H as Ve,l as M,I as pe,d as te,J as se,g as O,T as me,w as oe,c as m,f as H,A as Ae,e,q as K,B as re,t as C,K as Be,k as p,_ as ue,L as Ie,j as X,F as Y,n as F,y as le,M as De,s as U,N as ge,O as Ge,P as je,u as Re,a as Ne,z as ce,C as Oe,Q as He,R as $e,S as ze,U as qe,V as Ke,W as Ye,m as Qe,i as We,X as Xe,b as Je,v as Ze,Y as et}from"./index-C-y8EoDv.js";import{u as tt,C as nt,M as ot}from"./ModeLoadingScreen-B44flc9Y.js";function at(){const o=_(!1),t=_(!1);let n=null;const k=ee();Z(()=>k.status,a=>{o.value=a==="recording"},{immediate:!0});function c(a){if(o.value)return a.preventDefault(),a.returnValue="Recording in progress. Are you sure you want to leave?",a.returnValue}ae(()=>{window.addEventListener("beforeunload",c)}),be(()=>{window.removeEventListener("beforeunload",c)}),Ve((a,r,u)=>{o.value?(n=()=>u(),t.value=!0,u(!1)):u()});function d(){t.value=!1,o.value=!1,k.stopRecording().finally(()=>{n&&(n(),n=null)})}function s(){t.value=!1,n=null}return{isGuardActive:o,showLeaveConfirmation:t,confirmLeave:d,cancelLeave:s}}const I=_(null),_e=_(!1),Te=_(null),he=_(null),st=10,ye=2,rt=25;function lt(){const o=M(()=>I.value?I.value.available_gb<ye?"critical":I.value.available_gb<st?"warning":"ok":"unknown"),t=M(()=>I.value?I.value.available_gb>=ye:!0),n=M(()=>{if(!I.value)return null;const a=I.value.available_gb*1024*1024*1024,r=rt*1024*1024,u=a/r,l=Math.floor(u/3600),R=Math.floor(u%3600/60);return l>24?`${Math.floor(l/24)}d ${l%24}h`:l>0?`${l}h ${R}m`:`${R}m`}),k=M(()=>{switch(o.value){case"ok":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}}),c=M(()=>I.value?o.value==="critical"?`Disk space critically low (${I.value.available_gb.toFixed(1)} GB). Cannot start recording.`:o.value==="warning"?`Low disk space (${I.value.available_gb.toFixed(1)} GB). Estimated recording time: ${n.value}`:null:null);async function d(){_e.value=!0,he.value=null;try{const a=await pe.getDegradation();if(a.resources&&a.resources.disk_free_gb!==void 0){const r=a.resources.disk_free_gb,u=r*3;I.value={available_gb:r,total_gb:u,used_percent:100-r/u*100,recording_path:"/opt/r58-app/shared/recordings"}}return Te.value=new Date,I.value}catch(a){return he.value=a.message||"Failed to check disk space",console.error("Failed to check disk space:",a),null}finally{_e.value=!1}}async function s(){return await d(),I.value?o.value==="critical"?{ok:!1,message:`Insufficient disk space (${I.value.available_gb.toFixed(1)} GB). Need at least ${ye} GB to start recording.`}:o.value==="warning"?{ok:!0,message:`Low disk space warning: ${I.value.available_gb.toFixed(1)} GB available. Estimated recording time: ${n.value}`}:{ok:!0}:{ok:!0,message:"Could not verify disk space. Proceeding with caution."}}return{diskSpace:I,isLoading:_e,lastCheck:Te,error:he,status:o,statusColor:k,canStartRecording:t,estimatedRecordingTime:n,warningMessage:c,checkDiskSpace:d,preflightCheck:s}}const q=_(localStorage.getItem("r58_audio_feedback")!=="false");let ke=null;function it(){return ke||(ke=new(window.AudioContext||window.webkitAudioContext)),ke}function z(o,t,n="sine",k=.3){if(q.value)try{const c=it();c.state==="suspended"&&c.resume();const d=c.createOscillator(),s=c.createGain();d.connect(s),s.connect(c.destination),d.type=n,d.frequency.value=o;const a=c.currentTime;s.gain.setValueAtTime(0,a),s.gain.linearRampToValueAtTime(k,a+.01),s.gain.linearRampToValueAtTime(0,a+t),d.start(a),d.stop(a+t)}catch(c){console.warn("Audio feedback failed:",c)}}function ct(){q.value&&(z(440,.1,"sine",.2),setTimeout(()=>z(554,.1,"sine",.2),100),setTimeout(()=>z(659,.15,"sine",.25),200))}function ut(){q.value&&(z(880,.08,"sine",.3),setTimeout(()=>z(880,.15,"sine",.3),120))}function dt(){q.value&&(z(659,.1,"sine",.25),setTimeout(()=>z(554,.1,"sine",.2),100),setTimeout(()=>z(440,.15,"sine",.2),200))}function ft(){q.value&&(z(200,.15,"square",.15),setTimeout(()=>z(180,.2,"square",.15),180))}function pt(){q.value&&(z(1e3,.08,"sine",.2),setTimeout(()=>z(1e3,.08,"sine",.2),150))}function Me(){q.value&&z(1200,.03,"sine",.1)}function vt(o=50){if(q.value&&"vibrate"in navigator)try{navigator.vibrate(o)}catch{}}function mt(){function o(n){q.value=n,localStorage.setItem("r58_audio_feedback",String(n))}function t(){o(!q.value),q.value&&Me()}return{enabled:q,setEnabled:o,toggle:t,playSuccess:ct,playError:ft,playWarning:pt,playClick:Me,playRecordStart:ut,playRecordStop:dt,vibrate:vt}}const gt={class:"bg-preke-bg-elevated rounded-lg shadow-xl max-w-md w-full p-6"},bt=["placeholder"],_t={class:"text-xs text-preke-text-dim mt-2"},ht=te({__name:"SessionNameDialog",props:{open:{type:Boolean},suggestedName:{}},emits:["confirm","cancel","skip"],setup(o,{emit:t}){const n=o,k=t,c=_(""),d=_(null),s=M(()=>{const v=new Date,h=v.toLocaleDateString("en-CA"),g=v.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}).replace(":","");return`Recording_${h}_${g}`}),a=M(()=>n.suggestedName||s.value);Z(()=>n.open,v=>{v&&(c.value=a.value,setTimeout(()=>{var h,g;(h=d.value)==null||h.focus(),(g=d.value)==null||g.select()},100))});function r(){k("confirm",c.value.trim()||a.value)}function u(){k("skip")}function l(){k("cancel")}function R(v){v.key==="Enter"?r():v.key==="Escape"&&l()}return(v,h)=>(p(),se(Be,{to:"body"},[O(me,{name:"fade"},{default:oe(()=>[o.open?(p(),m("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:Ae(l,["self"]),onKeydown:R},[e("div",gt,[h[1]||(h[1]=e("h2",{class:"text-lg font-semibold mb-2"},"Name This Recording",-1)),h[2]||(h[2]=e("p",{class:"text-preke-text-dim text-sm mb-4"}," Give your recording a name to find it easily later (optional). ",-1)),K(e("input",{ref_key:"inputRef",ref:d,"onUpdate:modelValue":h[0]||(h[0]=g=>c.value=g),type:"text",placeholder:a.value,class:"w-full px-4 py-2 bg-preke-bg-surface border border-preke-bg-surface rounded-lg text-preke-text placeholder-preke-text-dim focus:outline-none focus:ring-2 focus:ring-preke-gold"},null,8,bt),[[re,c.value]]),e("p",_t," Suggested: "+C(a.value),1),e("div",{class:"flex justify-between mt-6"},[e("button",{onClick:u,class:"text-sm text-preke-text-dim hover:text-preke-text transition-colors"}," Skip (use default) "),e("div",{class:"flex gap-3"},[e("button",{onClick:l,class:"btn"}," Cancel "),e("button",{onClick:r,class:"btn btn-primary"}," Start Recording ")])])])],32)):H("",!0)]),_:1})]))}}),yt=ue(ht,[["__scopeId","data-v-2eeca4e8"]]),kt={class:"recorder-controls"},wt={key:0,class:"recorder-controls__duration"},Ct=["disabled","title"],xt={key:0,class:"recorder-controls__spinner"},$t={key:0,class:"recorder-controls__icon recorder-controls__icon--stop"},Rt={key:1,class:"recorder-controls__icon recorder-controls__icon--record"},St={class:"recorder-controls__hint"},Tt=te({__name:"RecorderControls",setup(o){const t=ee(),{register:n}=Ie(),{preflightCheck:k,status:c,canStartRecording:d}=lt(),{playRecordStart:s,playRecordStop:a,playError:r,playWarning:u,vibrate:l}=mt(),R=_(null),v=_(!1),h=_(!1),g=_(!1),S=_(!1),D=_(void 0),$=M(()=>t.status==="recording"),T=M(()=>t.status==="starting"),L=M(()=>t.status==="stopping"),G=M(()=>t.formattedDuration),y=M(()=>T.value||L.value||h.value),A=M(()=>T.value?"Starting recording...":L.value?"Stopping recording...":h.value?"Checking disk space...":!$.value&&!d.value?"Insufficient disk space":"");let E=null;ae(()=>{E=n({key:" ",description:"Toggle Recording",action:V,context:"recorder",enabled:()=>!T.value&&!L.value})}),be(()=>{E&&E()});async function V(){$.value?Q():await N()}async function N(j){h.value=!0;try{const B=await k();if(!B.ok){r(),l(200),X.error("Cannot start recording",B.message||"Preflight check failed");return}if(B.message&&c.value==="warning"&&(u(),X.warning("Low disk space",B.message)),S.value&&!j){D.value=void 0,g.value=!0;return}await f(j||D.value)}finally{h.value=!1}}async function f(j){try{await t.startRecording(j);const B=j||t.sessionId;s(),l([50,30,50]),X.success("Recording started",`Session: ${B}`)}catch(B){r(),l(200),X.error("Failed to start recording",B.message||"Unknown error",{label:"Retry",onClick:()=>N(j)})}}function W(j){g.value=!1,D.value=j,N(j)}function i(){g.value=!1,D.value=void 0,N()}function b(){g.value=!1,h.value=!1}async function P(){try{await t.stopRecording(),a(),l(100),X.success("Recording stopped")}catch(j){r(),l(200),X.error("Failed to stop recording",j.message||"Unknown error")}}function Q(){var j;v.value=!1,(j=R.value)==null||j.open(),setTimeout(()=>{v.value=!0},500)}function x(){v.value&&P()}async function w(){$.value?Q():await f()}return(j,B)=>(p(),m(Y,null,[e("div",kt,[$.value?(p(),m("div",wt,C(G.value),1)):H("",!0),e("button",{onClick:w,disabled:y.value,class:F(["recorder-controls__btn",$.value?"recorder-controls__btn--stop":"recorder-controls__btn--start"]),title:A.value||($.value?"Stop Recording (Space)":"Start Recording (Space)")},[T.value||L.value||h.value?(p(),m("span",xt)):(p(),m(Y,{key:1},[$.value?(p(),m("span",$t)):(p(),m("span",Rt))],64)),e("span",null,C(h.value?"Checking...":$.value?"Stop":"Start Recording"),1)],10,Ct),e("span",St,[B[0]||(B[0]=le(" Press ",-1)),B[1]||(B[1]=e("kbd",null,"Space",-1)),le(" to "+C($.value?"stop":"start"),1)])]),O(De,{ref_key:"stopConfirmDialog",ref:R,title:"Stop Recording?",message:`You have been recording for ${G.value}. This will finalize all files.`,"confirm-text":"Stop Recording","cancel-text":"Keep Recording",danger:!0,onConfirm:x},null,8,["message"]),O(yt,{open:g.value,onConfirm:W,onSkip:i,onCancel:b},null,8,["open"])],64))}}),Mt=ue(Tt,[["__scopeId","data-v-1e32920d"]]),fe=_(localStorage.getItem("r58_performance_mode")==="true"),we=_(localStorage.getItem("r58_performance_mode_auto")!=="false"),Pt=3,Et=100,Lt=500;function At(){const o=ee(),t=M(()=>fe.value?!0:we.value&&o.isRecording?o.inputs.filter(R=>R.isRecording).length>=Pt:!1),n=M(()=>t.value?Lt:Et);Z(t,l=>{l?document.body.classList.add("performance-mode"):document.body.classList.remove("performance-mode")},{immediate:!0});function k(l){fe.value=l,localStorage.setItem("r58_performance_mode",String(l))}function c(l){we.value=l,localStorage.setItem("r58_performance_mode_auto",String(l))}function d(){k(!fe.value)}function s(l,R){let v=0,h=null;return(...g)=>{const S=Date.now(),D=R??n.value,$=S-v;$>=D?(v=S,l(...g)):h||(h=window.setTimeout(()=>{v=Date.now(),h=null,l(...g)},D-$))}}function a(l,R){let v=null;return(...h)=>{v&&clearTimeout(v),v=window.setTimeout(()=>{l(...h),v=null},R??n.value)}}function r(l){return t.value?window.setTimeout(()=>l(performance.now()),n.value):requestAnimationFrame(l)}function u(l){t.value?clearTimeout(l):cancelAnimationFrame(l)}return{enabled:fe,autoEnable:we,isActive:t,updateInterval:n,setEnabled:k,setAutoEnable:c,toggle:d,throttle:s,debounce:a,requestFrame:r,cancelFrame:u}}const Bt=["title"],Dt={class:"flex items-center gap-1.5 text-sm"},jt={key:0,class:"flex items-center gap-1.5 text-sm"},Nt={key:1,class:"flex items-center gap-1.5 text-sm text-red-400"},Ht={class:"font-mono"},Wt=te({__name:"RecordingHealth",setup(o,{expose:t}){const n=ee(),{isActive:k}=At(),c=_({}),d=_(0),s=_(0),a=_(0);let r=null;function u(){const g={};let S=0;n.inputs.forEach($=>{g[$.id]=$.bytesWritten;const T=c.value[$.id]||0;S+=$.bytesWritten-T});const D=k.value?2:1;d.value=Math.round(S/(1024*1024)/D*10)/10,c.value=g}Z(()=>n.isRecording,g=>{if(g){c.value={},d.value=0,s.value=0,a.value=0;const S=k.value?2e3:1e3;r=window.setInterval(u,S)}else r&&(clearInterval(r),r=null)},{immediate:!0}),Z(k,g=>{if(n.isRecording&&r){clearInterval(r);const S=g?2e3:1e3;r=window.setInterval(u,S)}}),be(()=>{r&&clearInterval(r)});const l=M(()=>n.isRecording?a.value>0||s.value>90?"critical":d.value<1||s.value>70?"warning":"healthy":"idle"),R=M(()=>{switch(l.value){case"healthy":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}});M(()=>{switch(l.value){case"healthy":return"Healthy";case"warning":return"Warning";case"critical":return"Critical";default:return"Idle"}});const v=M(()=>{if(!n.isRecording)return"Not recording";const g=[`Write speed: ${d.value} MB/s`,`Buffer: ${s.value}%`];return a.value>0&&g.push(`Frames dropped: ${a.value}`),g.join(`
`)});function h(g){g.buffer_percent!==void 0&&(s.value=g.buffer_percent),g.frames_dropped!==void 0&&(a.value=g.frames_dropped)}return t({updateFromMetrics:h}),(g,S)=>U(n).isRecording?(p(),m("div",{key:0,class:F(["flex items-center gap-3 px-3 py-1.5 rounded-lg transition-colors cursor-help",{"bg-emerald-500/10":R.value==="emerald","bg-amber-500/10":R.value==="amber","bg-red-500/10":R.value==="red"}]),title:v.value},[e("span",{class:F(["w-2 h-2 rounded-full",R.value==="emerald"?"bg-emerald-500":"",R.value==="amber"?"bg-amber-500 animate-pulse":"",R.value==="red"?"bg-red-500 animate-pulse":""])},null,2),e("div",Dt,[S[0]||(S[0]=e("svg",{class:"w-3.5 h-3.5 text-preke-text-dim",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})],-1)),e("span",{class:F(["font-mono",R.value==="emerald"?"text-emerald-400":"",R.value==="amber"?"text-amber-400":"",R.value==="red"?"text-red-400":""])},C(d.value)+" MB/s ",3)]),s.value>0?(p(),m("div",jt,[S[1]||(S[1]=e("span",{class:"text-preke-text-dim"},"Buf:",-1)),e("span",{class:F(["font-mono",s.value<50?"text-emerald-400":"",s.value>=50&&s.value<80?"text-amber-400":"",s.value>=80?"text-red-400":""])},C(s.value)+"% ",3)])):H("",!0),a.value>0?(p(),m("div",Nt,[S[2]||(S[2]=e("svg",{class:"w-3.5 h-3.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),e("span",Ht,C(a.value)+" dropped",1)])):H("",!0)],10,Bt)):H("",!0)}});function Pe(o){return o.startsWith("192.168.")||o.startsWith("10.")||o.startsWith("172.")||o.startsWith("100.")||o==="127.0.0.1"||o==="localhost"}const Ut=5,Ft=1e3,Vt=3e4,It=()=>typeof window<"u"&&window.__NETWORK_DEBUG__===!0,Ee=new Map,Gt=1e3;function ve(o,t,...n){if(!It())return;const k=Date.now(),c=Ee.get(o)||0;k-c<Gt||(Ee.set(o,k),console.log(`[NETWORK DEBUG ${o}] ${t}`,...n))}const J=new Map,ie=new Map;async function Ot(o){const t=ge(),n=je();if(t&&!n)try{return`http://${new URL(t).hostname}:8889/${o}/whep`}catch{console.warn("[WHEP Manager] Invalid device URL, falling back to FRP")}if(!(typeof window<"u"&&!!window.electronAPI)&&typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"))return console.log("[WHEP Manager] Local device mode, using localhost MediaMTX"),`http://localhost:8889/${o}/whep`;if(typeof window<"u"&&window.location.hostname==="app.itagenten.no")return console.log("[WHEP Manager] Browser access from app.itagenten.no, using same-domain proxy"),`https://app.itagenten.no/${o}/whep`;const{getFrpUrl:c}=await Ge(async()=>{const{getFrpUrl:s}=await import("./index-C-y8EoDv.js").then(a=>a.a4);return{getFrpUrl:s}},__vite__mapDeps([0,1])),d=await c();if(d)try{const s=new URL(d);return s.hostname.includes("itagenten.no")?`https://app.itagenten.no/${o}/whep`:s.hostname.includes("mediamtx")?`${d}/${o}/whep`:`https://${s.hostname.replace("api","mediamtx")}/${o}/whep`}catch{console.warn("[WHEP Manager] Invalid FRP URL, cannot build WHEP URL")}throw new Error("No device configured and no FRP fallback available")}async function zt(o,t){const n=J.get(t);if(!n)return"unknown";try{const d=new URL(n.whepUrl).hostname;if(d.includes("itagenten.no"))return console.log(`[WHEP Manager ${t}] Detected relay (FRP URL)`),"relay";if(Pe(d))return console.log(`[WHEP Manager ${t}] Detected P2P (private IP: ${d})`),"p2p"}catch(c){console.warn(`[WHEP Manager ${t}] Failed to parse WHEP URL:`,c)}try{const c=await o.getStats();for(const d of c.values())if(d.type==="candidate-pair"&&d.state==="succeeded"){const s=c.get(d.remoteCandidateId);if((s==null?void 0:s.candidateType)==="relay")return console.log(`[WHEP Manager ${t}] Detected relay (TURN candidate)`),"relay";const a=s==null?void 0:s.address;if(a&&!Pe(a))return console.log(`[WHEP Manager ${t}] Detected relay (public IP: ${a})`),"relay"}}catch(c){console.warn(`[WHEP Manager ${t}] Failed to get WebRTC stats:`,c)}return ge()&&!je()?(console.log(`[WHEP Manager ${t}] Assuming P2P (direct device URL configured)`),"p2p"):"unknown"}function ne(o){const t=J.get(o);if(!t)return;const n=ie.get(o);n&&n.forEach(k=>k(t))}function Ce(o){const t=J.get(o);if(!t)return;if(t.reconnectAttempts>=Ut){console.error(`[WHEP Manager ${o}] Max reconnect attempts reached`),t.state="failed",ne(o);return}t.reconnectAttempts++;const n=Math.min(Ft*Math.pow(2,t.reconnectAttempts-1),Vt),k=n*.2*(Math.random()*2-1),c=Math.max(100,Math.round(n+k));ve("WHEP",`Camera ${o}: Reconnect #${t.reconnectAttempts} in ${c}ms (base: ${n}ms)`),console.log(`[WHEP Manager ${o}] Scheduling reconnect #${t.reconnectAttempts} in ${c}ms`),t.state="connecting",ne(o),t.reconnectTimeout&&clearTimeout(t.reconnectTimeout),t.reconnectTimeout=setTimeout(()=>{Se(o)},c)}async function Se(o){let t=J.get(o);if(t&&(t.state==="connected"||t.state==="connecting"))return console.log(`[WHEP Manager ${o}] Reusing existing connection (state: ${t.state})`),t;if(t!=null&&t.isConnecting){for(ve("WHEP",`Camera ${o}: Connection already in progress, skipping duplicate attempt`),console.log(`[WHEP Manager ${o}] Connection already in progress, waiting...`);t.isConnecting&&t.state==="connecting"&&(await new Promise(r=>setTimeout(r,100)),t=J.get(o),!!t););if(t)return t}const k=!(typeof window<"u"&&!!window.electronAPI)&&typeof window<"u"&&(window.location.hostname==="app.itagenten.no"||window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1");let c=ge();if(k)console.log(`[WHEP Manager ${o}] Browser-only mode (no Electron) - using appropriate proxy`);else{let r=0;for(;!c&&r<5;)console.log(`[WHEP Manager ${o}] No device URL yet, waiting... (attempt ${r+1})`),await new Promise(u=>setTimeout(u,100)),c=ge(),r++}const d=performance.now(),s=await Ot(o);ve("WHEP",`Camera ${o}: Creating connection to ${s}`),console.log(`[WHEP Manager ${o}] Creating connection to: ${s}`),console.log(`[WHEP Manager ${o}] Device URL was: ${c||"none (browser mode)"}`),t!=null&&t.peerConnection&&t.peerConnection.close(),t!=null&&t.disconnectedTimeout&&(clearTimeout(t.disconnectedTimeout),t.disconnectedTimeout=null),t&&(t.isConnecting=!0);const a=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}]});t?(t.peerConnection=a,t.state="connecting",t.whepUrl=s,t.mediaStream=null,t.connectionType="unknown",t.connectionStartTime=d,t.isConnecting=!0):(t={cameraId:o,peerConnection:a,mediaStream:null,state:"connecting",connectionType:"unknown",refCount:0,whepUrl:s,lastConnectedAt:null,reconnectAttempts:0,reconnectTimeout:null,disconnectedTimeout:null,connectionStartTime:d,isConnecting:!0},J.set(o,t)),a.ontrack=r=>{if(r.streams[0]){t.mediaStream=r.streams[0],console.log(`[WHEP Manager ${o}] Received media stream`);try{const u=a.getReceivers();for(const l of u)l.track.kind==="video"&&"jitterBufferTarget"in l&&(l.jitterBufferTarget=100,console.log(`[WHEP Manager ${o}] Set jitterBufferTarget to 100ms for low latency`))}catch(u){console.warn(`[WHEP Manager ${o}] Could not set jitterBufferTarget:`,u)}ne(o)}},a.oniceconnectionstatechange=async()=>{const r=a.iceConnectionState;if(ve("WHEP",`Camera ${o}: ICE state changed to ${r}`),console.log(`[WHEP Manager ${o}] ICE state: ${r}`),r==="connected"||r==="completed"){t.state="connected",t.lastConnectedAt=Date.now(),t.reconnectAttempts=0,t.isConnecting=!1,t.connectionType=await zt(a,o),t.disconnectedTimeout&&(clearTimeout(t.disconnectedTimeout),t.disconnectedTimeout=null);const u=t.connectionStartTime?Math.round(performance.now()-t.connectionStartTime):0;console.log(`[WHEP Manager ${o}] Connected (${t.connectionType}) in ${u}ms`),ne(o)}else r==="failed"?(t.state="failed",t.connectionType="unknown",t.isConnecting=!1,ne(o),t.refCount>0&&Ce(o)):r==="disconnected"&&(t.disconnectedTimeout&&clearTimeout(t.disconnectedTimeout),t.disconnectedTimeout=setTimeout(()=>{(a.iceConnectionState==="disconnected"||a.iceConnectionState==="failed")&&(t.state="disconnected",t.isConnecting=!1,ne(o),t.refCount>0&&Ce(o)),t.disconnectedTimeout=null},3e3))},a.addTransceiver("video",{direction:"recvonly"}),a.addTransceiver("audio",{direction:"recvonly"});try{const r=await a.createOffer();await a.setLocalDescription(r);const u=await fetch(s,{method:"POST",headers:{"Content-Type":"application/sdp"},body:r.sdp});if(!u.ok)throw new Error(`WHEP request failed: ${u.status}`);const l=await u.text();await a.setRemoteDescription({type:"answer",sdp:l})}catch(r){console.error(`[WHEP Manager ${o}] Connection error:`,r),t.state="failed",t.isConnecting=!1,ne(o),t.refCount>0&&Ce(o)}return t}async function qt(o,t){ie.has(o)||ie.set(o,new Set),ie.get(o).add(t);let n=J.get(o);return(!n||n.state==="failed"||n.state==="disconnected")&&(n=await Se(o)),n.refCount++,console.log(`[WHEP Manager ${o}] Acquired connection (refCount: ${n.refCount})`),t(n),n}function Kt(o,t){const n=J.get(o);if(!n)return;const k=ie.get(o);k&&(k.delete(t),k.size===0&&ie.delete(o)),n.refCount=Math.max(0,n.refCount-1),console.log(`[WHEP Manager ${o}] Released connection (refCount: ${n.refCount})`),n.refCount===0&&(console.log(`[WHEP Manager ${o}] Closing unused connection`),n.reconnectTimeout&&clearTimeout(n.reconnectTimeout),n.disconnectedTimeout&&clearTimeout(n.disconnectedTimeout),n.peerConnection.close(),J.delete(o))}function xe(o){const t=J.get(o);t&&(console.log(`[WHEP Manager ${o}] Force reconnecting...`),t.reconnectAttempts=0,Se(o))}const Yt={class:"relative w-full h-full bg-black"},Qt=["title"],Xt={key:1,class:"absolute inset-0 flex items-center justify-center bg-black/50"},Jt={class:"text-center"},Zt={class:"text-xs text-amber-400"},en={key:3,class:"absolute inset-0 flex items-center justify-center bg-black/80"},tn={class:"text-center text-preke-text-dim"},nn={class:"text-sm"},Le=te({__name:"InputPreview",props:{inputId:{},protocol:{}},emits:["videoReady","aspectRatio"],setup(o,{emit:t}){const n=o,k=t,c=ee();let d=!1;const s=M(()=>c.status==="recording"),a=_(null),r=_(!0),u=_(null),l=_("unknown"),R=_(!1),v=_(0);let h=null;function g(T){switch(console.log(`[InputPreview ${n.inputId}] Connection update:`,{state:T.state,type:T.connectionType,hasStream:!!T.mediaStream}),l.value=T.connectionType,v.value=T.reconnectAttempts,T.state){case"connecting":r.value=!0,u.value=null,R.value=T.reconnectAttempts>0;break;case"connected":r.value=!1,u.value=null,R.value=!1,T.mediaStream&&a.value&&a.value.srcObject!==T.mediaStream&&(a.value.srcObject=T.mediaStream,a.value.play().catch(L=>{console.warn(`[InputPreview ${n.inputId}] Autoplay prevented:`,L)}),d||(a.value.onloadeddata=()=>{if(!d&&a.value){d=!0;const L=a.value.videoWidth,G=a.value.videoHeight,y=L&&G?L/G:16/9;console.log(`[InputPreview ${n.inputId}] Video ready (${L}x${G}, ratio: ${y.toFixed(3)})`),k("aspectRatio",y),k("videoReady")}}));break;case"disconnected":R.value=!0,u.value=`Reconnecting... (${T.reconnectAttempts}/5)`;break;case"failed":r.value=!1,R.value=!1,u.value="Connection failed after multiple attempts";break}}async function S(){if(a.value){$(),r.value=!0,u.value=null,h=g;try{await qt(n.inputId,h)}catch(T){console.error(`[InputPreview ${n.inputId}] Failed to acquire connection:`,T),u.value=T instanceof Error?T.message:"Failed to connect",r.value=!1}}}function D(){xe(n.inputId)}function $(){h&&(Kt(n.inputId,h),h=null)}return ae(()=>{S()}),Z(()=>n.inputId,()=>{S()}),Z(s,(T,L)=>{L&&!T&&u.value?(console.log("[InputPreview] Recording stopped, reconnecting preview..."),xe(n.inputId)):!L&&T&&(console.log("[InputPreview] Recording started, will try to reconnect preview after delay..."),setTimeout(()=>{s.value&&(console.log("[InputPreview] Attempting to reconnect preview during recording..."),xe(n.inputId))},2e3))}),be(()=>{$()}),(T,L)=>(p(),m("div",Yt,[e("video",{ref_key:"videoRef",ref:a,autoplay:"",muted:"",playsinline:"",class:"w-full h-full object-contain"},null,512),!r.value&&!u.value&&l.value!=="unknown"?(p(),m("div",{key:0,class:F(["absolute top-1 right-1 px-1.5 py-0.5 text-[10px] font-medium rounded",l.value==="p2p"?"bg-emerald-500/80 text-white":"bg-amber-500/80 text-white"]),title:l.value==="p2p"?"Direct P2P connection":"Relay connection (FRP)"},C(l.value==="p2p"?"P2P":"RELAY"),11,Qt)):H("",!0),r.value&&!R.value?(p(),m("div",Xt,[...L[0]||(L[0]=[e("div",{class:"animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"},null,-1)])])):H("",!0),R.value?(p(),m("div",{key:2,class:"absolute inset-0 flex items-center justify-center bg-black/70 cursor-pointer",onClick:D,title:"Click to force reconnect"},[e("div",Jt,[L[1]||(L[1]=e("div",{class:"animate-spin w-5 h-5 border-2 border-amber-400 border-t-transparent rounded-full mx-auto mb-2"},null,-1)),e("p",Zt,C(u.value||"Reconnecting..."),1),L[2]||(L[2]=e("p",{class:"text-xs text-amber-400/60 mt-1"},"Tap to retry",-1))])])):u.value&&!r.value?(p(),m("div",en,[e("div",tn,[e("p",nn,C(u.value),1),e("button",{onClick:D,class:"mt-2 text-xs text-preke-gold hover:underline"}," Retry ")])])):H("",!0)]))}}),on={key:0,class:"h-full flex items-center justify-center"},an={key:1,class:"input-grid"},sn={key:0,class:"input-grid__warning"},rn=["data-count"],ln=["title","onClick"],cn={key:1,class:"w-full h-full flex items-center justify-center bg-preke-bg-surface"},un={class:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-4"},dn={class:"flex items-center justify-between"},fn={class:"flex items-center gap-2"},pn={class:"font-medium"},vn={key:0,class:"flex items-center gap-2 text-sm"},mn={class:"text-preke-text-dim"},gn={class:"enlarged-modal__info"},bn={class:"flex items-center gap-3"},_n={class:"font-semibold text-lg"},hn={key:0,class:"px-2 py-0.5 text-xs font-bold bg-preke-red/20 text-preke-red rounded"},yn={class:"flex items-center gap-4 text-sm"},kn={class:"text-preke-text-dim"},wn=te({__name:"InputGrid",emits:["allVideosReady"],setup(o,{emit:t}){const n=ee(),k=Re(),c=t,d=_(new Set),s=_(null);function a(y){s.value=y}function r(){s.value=null}const u=_({});function l(y){d.value.add(y),console.log(`[InputGrid] Video ready: ${y} (${d.value.size}/${g.value.length})`),d.value.size>=g.value.length&&(console.log("[InputGrid] All videos ready!"),c("allVideosReady"))}function R(y,A){u.value[y]=A,console.log(`[InputGrid] Aspect ratio for ${y}: ${A.toFixed(3)}`)}function v(y){return{aspectRatio:`${u.value[y]||1.7777777777777777}`}}Z(()=>g.value.length,()=>{d.value.clear()});const h=M(()=>{var y;return((y=k.capabilities)==null?void 0:y.current_mode)==="recorder"}),g=M(()=>n.inputs.filter(y=>y.hasSignal)),S=M(()=>n.framerateMismatch);function D(y){return y.isRecording?"border-preke-red ring-2 ring-preke-red/20":y.hasSignal?"border-emerald-500/50 hover:border-emerald-500":"border-preke-bg-surface/50 opacity-60"}function $(y){return y.hasSignal?y.framerate>=29?"excellent":y.framerate>=24?"good":"unstable":"none"}function T(y){switch($(y)){case"excellent":return"text-emerald-400";case"good":return"text-emerald-400";case"unstable":return"text-amber-400";case"none":return"text-preke-text-dim"}}function L(y){if(y===0)return"0 B";const A=1024,E=["B","KB","MB","GB"],V=Math.floor(Math.log(y)/Math.log(A));return parseFloat((y/Math.pow(A,V)).toFixed(1))+" "+E[V]}function G(y){if(!y.hasSignal)return`${y.label}: No signal detected`;const A=[`${y.label}`,`Resolution: ${y.resolution}`,`Framerate: ${y.framerate} fps`,`Quality: ${$(y)}`];return y.isRecording&&A.push(`Written: ${L(y.bytesWritten)}`),A.join(`
`)}return(y,A)=>g.value.length===0?(p(),m("div",on,[...A[1]||(A[1]=[Ne('<div class="text-center text-preke-text-dim" data-v-53f60619><svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-53f60619><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" data-v-53f60619></path></svg><p class="text-lg font-medium" data-v-53f60619>No Video Sources Connected</p><p class="text-sm mt-2" data-v-53f60619>Connect HDMI cables to begin recording</p></div>',1)])])):(p(),m("div",an,[S.value?(p(),m("div",sn,[A[2]||(A[2]=e("svg",{class:"w-4 h-4 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),e("span",null,C(S.value),1)])):H("",!0),e("div",{class:"input-grid__container","data-count":g.value.length},[(p(!0),m(Y,null,ce(g.value,E=>(p(),m("div",{key:E.id,class:F(["input-grid__tile",D(E)]),style:Oe(v(E.id)),title:G(E),onClick:V=>a(E)},[h.value?(p(),se(Le,{key:0,"input-id":E.id,class:"w-full h-full",onVideoReady:V=>l(E.id),onAspectRatio:V=>R(E.id,V)},null,8,["input-id","onVideoReady","onAspectRatio"])):(p(),m("div",cn,[...A[3]||(A[3]=[e("div",{class:"text-center"},[e("svg",{class:"w-8 h-8 mx-auto mb-2 text-preke-text-dim/50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})]),e("span",{class:"text-xs text-preke-text-dim/70"},"Mixer mode")],-1)])])),e("div",un,[e("div",dn,[e("div",fn,[e("span",{class:F(["w-2 h-2 rounded-full transition-colors",{"bg-emerald-500":$(E)==="excellent"||$(E)==="good","bg-amber-500 animate-pulse":$(E)==="unstable","bg-preke-text-dim":$(E)==="none"}])},null,2),e("span",pn,C(E.label),1)]),E.hasSignal?(p(),m("div",vn,[e("span",mn,C(E.resolution),1),e("span",{class:F(T(E))},C(E.framerate)+"fps",3)])):H("",!0)])])],14,ln))),128))],8,rn),(p(),se(Be,{to:"body"},[O(me,{name:"enlarged"},{default:oe(()=>[s.value?(p(),m("div",{key:0,class:"enlarged-modal",onClick:r},[e("div",{class:"enlarged-modal__content",onClick:A[0]||(A[0]=Ae(()=>{},["stop"]))},[h.value?(p(),se(Le,{key:0,"input-id":s.value.id,class:"w-full h-full"},null,8,["input-id"])):H("",!0),e("div",gn,[e("div",bn,[e("span",{class:F(["w-2.5 h-2.5 rounded-full",{"bg-emerald-500":$(s.value)==="excellent"||$(s.value)==="good","bg-amber-500 animate-pulse":$(s.value)==="unstable","bg-preke-text-dim":$(s.value)==="none"}])},null,2),e("span",_n,C(s.value.label),1),s.value.isRecording?(p(),m("span",hn," REC ")):H("",!0)]),e("div",yn,[e("span",kn,C(s.value.resolution),1),e("span",{class:F(T(s.value))},C(s.value.framerate)+"fps",3)])]),e("button",{class:"enlarged-modal__close",onClick:r,title:"Close (or click outside)"},[...A[4]||(A[4]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])])):H("",!0)]),_:1})]))]))}}),Cn=ue(wn,[["__scopeId","data-v-53f60619"]]),xn={key:0,class:"py-8 text-center text-preke-text-muted"},$n={key:1,class:"camera-setup"},Rn={class:"camera-list"},Sn={class:"list-header"},Tn=["disabled"],Mn={key:0,class:"empty-state"},Pn={key:1,class:"camera-items"},En={class:"camera-item__info"},Ln={class:"camera-item__header"},An={class:"camera-item__name"},Bn={class:"camera-item__details"},Dn={class:"camera-item__type"},jn={class:"camera-item__ip"},Nn={class:"camera-item__actions"},Hn=["onClick","disabled"],Wn={key:0,class:"btn-icon-sm",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Un={key:1,class:"spinner"},Fn=["onClick","disabled"],Vn=["onClick","disabled"],In={key:0,class:"camera-form"},Gn={class:"form-header"},On={class:"form-title"},zn={class:"form-content"},qn={class:"form-group"},Kn={class:"form-group"},Yn=["value"],Qn={class:"form-group"},Xn={class:"form-group"},Jn=["placeholder"],Zn={class:"form-hint"},eo={class:"form-group"},to={class:"form-checkbox"},no={class:"form-actions"},oo={class:"flex items-center justify-between w-full"},ao={key:0,class:"text-sm text-amber-400"},so={key:1,class:"text-sm text-preke-text-muted"},ro={class:"flex gap-3"},lo=["disabled"],io=te({__name:"CameraSetupModal",emits:["close","updated"],setup(o,{expose:t,emit:n}){const k=n,c=_(null),d=He(),s=_(!1),a=_(!1),r=_(null),u=_([]),l=_(null),R=[{value:"blackmagic",label:"Blackmagic Design Studio Camera 4K Pro"},{value:"obsbot_tail2",label:"OBSbot Tail 2"}],v=_({name:"",type:"blackmagic",ip:"",port:void 0,enabled:!0}),h={blackmagic:80,obsbot_tail2:52381},g=M(()=>l.value!==null),S=_(!1);async function D(){s.value=!0;try{const i=await pe.cameras.getConfig();u.value=i.cameras.map(b=>({name:b.name,type:b.type,ip:b.ip,port:b.port,enabled:b.enabled??!0})),S.value=!1}catch(i){console.error("[CameraSetup] Failed to load config:",i),d.error("Failed to load camera configuration")}finally{s.value=!1}}function $(){v.value={name:"",type:"blackmagic",ip:"",port:void 0,enabled:!0},l.value=null}function T(i){l.value=i,v.value={...u.value[i]}}function L(){$()}function G(){$(),l.value=-1}async function y(i){confirm(`Delete camera "${u.value[i].name}"?`)&&(u.value.splice(i,1),S.value=!0,await N())}async function A(i){r.value=i.name;try{(await pe.cameras.getStatus(i.name)).connected?d.success(`${i.name} is connected!`):d.warning(`${i.name} is not connected`)}catch{try{const P=await fetch(`http://${i.ip}:${i.port||h[i.type]}/`,{method:"HEAD",mode:"no-cors",signal:AbortSignal.timeout(3e3)});d.info(`${i.name}: IP ${i.ip} is reachable`)}catch{d.error(`${i.name}: Cannot reach ${i.ip}`)}}finally{r.value=null}}function E(){return v.value.name.trim()?v.value.ip.trim()?/^(\d{1,3}\.){3}\d{1,3}$/.test(v.value.ip)?u.value.findIndex((P,Q)=>P.name===v.value.name&&Q!==l.value)>=0?(d.error("Camera name already exists"),!1):!0:(d.error("Invalid IP address format"),!1):(d.error("Camera IP address is required"),!1):(d.error("Camera name is required"),!1)}function V(){E()&&(v.value.port||(v.value.port=h[v.value.type]),l.value===-1?u.value.push({...v.value}):l.value!==null&&l.value>=0&&(u.value[l.value]={...v.value}),S.value=!0,$())}async function N(){a.value=!0;try{await pe.cameras.updateConfig(u.value),d.success("Camera configuration saved!"),S.value=!1,k("updated")}catch(i){console.error("[CameraSetup] Failed to save config:",i),d.error("Failed to save configuration: "+(i.message||"Unknown error"))}finally{a.value=!1}}function f(){var i;(i=c.value)==null||i.open(),D()}function W(){var i;S.value&&!confirm("You have unsaved changes. Close anyway?")||((i=c.value)==null||i.close(),$(),S.value=!1,k("close"))}return t({open:f,close:W}),ae(()=>{D()}),(i,b)=>(p(),se(qe,{ref_key:"modalRef",ref:c,title:"Camera Setup",size:"xl",onClose:W},{header:oe(()=>[...b[5]||(b[5]=[e("div",{class:"flex items-center justify-between w-full"},[e("div",null,[e("h2",{class:"text-lg font-semibold text-preke-text"},"Camera Setup"),e("p",{class:"text-sm text-preke-text-muted mt-1"}," Configure external cameras for control ")])],-1)])]),footer:oe(()=>[e("div",oo,[S.value?(p(),m("div",ao," You have unsaved changes ")):(p(),m("div",so,C(u.value.length)+" camera"+C(u.value.length!==1?"s":"")+" configured ",1)),e("div",ro,[e("button",{onClick:W,class:"btn-secondary"}," Close "),e("button",{onClick:N,disabled:!S.value||a.value,class:"btn-primary"},C(a.value?"Saving...":"Save Configuration"),9,lo)])])]),default:oe(()=>[s.value?(p(),m("div",xn," Loading camera configuration... ")):(p(),m("div",$n,[e("div",Rn,[e("div",Sn,[b[7]||(b[7]=e("h3",{class:"list-title"},"Configured Cameras",-1)),e("button",{onClick:G,class:"btn-add",disabled:g.value},[...b[6]||(b[6]=[e("svg",{class:"btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),le(" Add Camera ",-1)])],8,Tn)]),u.value.length===0&&!g.value?(p(),m("div",Mn,[...b[8]||(b[8]=[e("svg",{class:"empty-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})],-1),e("p",{class:"empty-text"},"No cameras configured",-1),e("p",{class:"empty-hint"},'Click "Add Camera" to get started',-1)])])):(p(),m("div",Pn,[(p(!0),m(Y,null,ce(u.value,(P,Q)=>{var x;return p(),m("div",{key:Q,class:F(["camera-item",{"camera-item--disabled":!P.enabled}])},[e("div",En,[e("div",Ln,[e("span",An,C(P.name),1),e("span",{class:F(["camera-item__badge",P.enabled?"camera-item__badge--enabled":"camera-item__badge--disabled"])},C(P.enabled?"Enabled":"Disabled"),3)]),e("div",Bn,[e("span",Dn,C(((x=R.find(w=>w.value===P.type))==null?void 0:x.label)||P.type),1),e("span",jn,C(P.ip)+":"+C(P.port||h[P.type]),1)])]),e("div",Nn,[e("button",{onClick:w=>A(P),disabled:r.value===P.name,class:"btn-test",title:"Test Connection"},[r.value!==P.name?(p(),m("svg",Wn,[...b[9]||(b[9]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 10V3L4 14h7v7l9-11h-7z"},null,-1)])])):(p(),m("span",Un))],8,Hn),e("button",{onClick:w=>T(Q),disabled:g.value,class:"btn-edit",title:"Edit"},[...b[10]||(b[10]=[e("svg",{class:"btn-icon-sm",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})],-1)])],8,Fn),e("button",{onClick:w=>y(Q),disabled:g.value,class:"btn-delete",title:"Delete"},[...b[11]||(b[11]=[e("svg",{class:"btn-icon-sm",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})],-1)])],8,Vn)])],2)}),128))]))]),g.value?(p(),m("div",In,[e("div",Gn,[e("h3",On,C(l.value===-1?"Add Camera":"Edit Camera"),1),e("button",{onClick:L,class:"btn-cancel-form"},"Cancel")]),e("div",zn,[e("div",qn,[b[12]||(b[12]=e("label",{class:"form-label"},"Camera Name *",-1)),K(e("input",{"onUpdate:modelValue":b[0]||(b[0]=P=>v.value.name=P),type:"text",class:"form-input",placeholder:"e.g., BMD Cam 1"},null,512),[[re,v.value.name]])]),e("div",Kn,[b[13]||(b[13]=e("label",{class:"form-label"},"Camera Type *",-1)),K(e("select",{"onUpdate:modelValue":b[1]||(b[1]=P=>v.value.type=P),class:"form-input"},[(p(),m(Y,null,ce(R,P=>e("option",{key:P.value,value:P.value},C(P.label),9,Yn)),64))],512),[[$e,v.value.type]])]),e("div",Qn,[b[14]||(b[14]=e("label",{class:"form-label"},"IP Address *",-1)),K(e("input",{"onUpdate:modelValue":b[2]||(b[2]=P=>v.value.ip=P),type:"text",class:"form-input",placeholder:"192.168.1.101"},null,512),[[re,v.value.ip]]),b[15]||(b[15]=e("p",{class:"form-hint"},"Camera's network IP address",-1))]),e("div",Xn,[b[16]||(b[16]=e("label",{class:"form-label"},"Port",-1)),K(e("input",{"onUpdate:modelValue":b[3]||(b[3]=P=>v.value.port=P),type:"number",class:"form-input",placeholder:String(h[v.value.type])},null,8,Jn),[[re,v.value.port,void 0,{number:!0}]]),e("p",Zn,"Default: "+C(h[v.value.type])+" for "+C(v.value.type),1)]),e("div",eo,[e("label",to,[K(e("input",{"onUpdate:modelValue":b[4]||(b[4]=P=>v.value.enabled=P),type:"checkbox",class:"checkbox"},null,512),[[ze,v.value.enabled]]),b[17]||(b[17]=e("span",null,"Enabled",-1))]),b[18]||(b[18]=e("p",{class:"form-hint"},"Disable to keep configuration but not use the camera",-1))]),e("div",no,[e("button",{onClick:V,class:"btn-save-form"},C(l.value===-1?"Add Camera":"Update Camera"),1),e("button",{onClick:L,class:"btn-cancel-form"}," Cancel ")])])])):H("",!0)]))]),_:1},512))}}),co=ue(io,[["__scopeId","data-v-d42e0adf"]]),uo={class:"sidebar"},fo={class:"sidebar__card sidebar__card--header"},po={class:"connection-row"},vo={class:"connection-status"},mo={class:"connection-label"},go={key:0,class:"connection-latency"},bo=["disabled"],_o={class:"sidebar__card sidebar__card--recording"},ho={class:"recording__duration"},yo={class:"recording__meta"},ko={key:0,class:"sidebar__card sidebar__card--warning"},wo={class:"warning__text"},Co={key:1,class:"sidebar__card sidebar__card--davinci"},xo={class:"davinci__buttons"},$o=["disabled"],Ro=["disabled"],So=["disabled"],To={class:"sidebar__card"},Mo={key:0,class:"cameras"},Po={class:"camera__header"},Eo=["onClick","disabled"],Lo={key:1,class:"cameras-empty"},Ao=te({__name:"SessionInfoV2",setup(o){const t=We(),n=ee(),k=Re(),c=He(),{state:d,latencyMs:s}=Ke(),{connectionMethod:a}=Ye(),r=M(()=>{const x=d.value==="connected",w=d.value==="connecting",j=d.value==="degraded";if(x){let B="";return a.value==="relay"?B="Relay":a.value==="p2p"?B="P2P":a.value==="local"&&(B="Local"),{status:"online",color:"green",label:B||"Connected",latency:s.value,pulse:!1}}return w?{status:"connecting",color:"amber",label:"Connecting...",latency:null,pulse:!0}:j?{status:"degraded",color:"amber",label:"Slow",latency:s.value,pulse:!1}:{status:"offline",color:"red",label:"Offline",latency:null,pulse:!0}}),u=M(()=>n.currentSession),l=M(()=>n.activeInputs),R=M(()=>n.isRecording),v=M(()=>n.inputs.filter(x=>x.isRecording)),h=_("");ae(()=>{const w=new Date().toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,".");h.value=`Session ${w}`});const{cameras:g,loadCameras:S}=tt(),D=_(null),$=_(null),T=_(null);ae(async()=>{await S()});function L(x){var w;D.value=x,(w=$.value)==null||w.open()}function G(){D.value=null}function y(){var x;(x=T.value)==null||x.open()}function A(){S()}const E=M(()=>{const x=k.capabilities;if(!x)return null;const w=x.storage_total_gb||1,j=x.storage_available_gb||0,B=w-j,de=Math.round(B/w*100),Ue=(l.value.length||1)*8,Fe=j/Ue;return{freeGB:Math.round(j),totalGB:Math.round(w),percent:de,hoursRemaining:Math.round(Fe*10)/10,isLow:de>85,isCritical:de>95}});function V(){t.push({name:"admin",query:{tab:"settings"}})}const N=M(()=>Qe()),f=_(!1),W=M(()=>{const x=u.value;return x!=null&&x.id?`Preke_${x.id}`:`Preke_${h.value.replace(/\s+/g,"_")}`}),i=window.electronAPI;async function b(){if(i!=null&&i.davinciOpenProject){f.value=!0,c.info("Opening DaVinci Resolve...");try{const x=await i.davinciOpenProject(W.value);x.success?c.success(`Opened project: ${x.projectName}`):c.error(x.error||"Failed to open DaVinci project")}catch(x){console.error("DaVinci error:",x),c.error("Failed to connect to DaVinci Resolve")}finally{f.value=!1}}}async function P(){if(i!=null&&i.davinciCreateMulticam){f.value=!0;try{i.davinciOpenProject&&await i.davinciOpenProject(W.value);const x=await i.davinciCreateMulticam({projectName:W.value,clipName:`Multicam_${h.value.replace(/\s+/g,"_")}`,syncMethod:"timecode"});x.success?c.success(`Created timeline: ${x.timelineName}`):c.error(x.error||"Failed to create multicam timeline")}catch(x){console.error("DaVinci error:",x),c.error("Failed to create multicam timeline")}finally{f.value=!1}}}async function Q(){if(i!=null&&i.davinciRefreshClips){f.value=!0,c.info("Refreshing growing clips...");try{const x=await i.davinciRefreshClips();if(x.success){const w=x.clipsRefreshed||0;c.success(`Refreshed ${w} clip${w!==1?"s":""}`)}else c.error(x.error||"Failed to refresh clips")}catch(x){console.error("DaVinci refresh error:",x),c.error("Failed to refresh clips")}finally{f.value=!1}}}return(x,w)=>{var j;return p(),m("div",uo,[e("div",fo,[e("div",po,[e("div",vo,[e("span",{class:F(["connection-dot",[`connection-dot--${r.value.color}`,{"connection-dot--pulse":r.value.pulse}]])},null,2),e("span",mo,C(r.value.label),1),r.value.latency?(p(),m("span",go,C(r.value.latency)+"ms ",1)):H("",!0)])]),w[1]||(w[1]=e("div",{class:"sidebar__divider"},null,-1)),w[2]||(w[2]=e("label",{class:"sidebar__label"},"Session Name",-1)),K(e("input",{"onUpdate:modelValue":w[0]||(w[0]=B=>h.value=B),type:"text",class:"sidebar__input",placeholder:"Session 06.01.2026",disabled:R.value},null,8,bo),[[re,h.value]])]),R.value?(p(),m(Y,{key:0},[e("div",_o,[w[3]||(w[3]=e("div",{class:"recording__header"},[e("span",{class:"recording__dot"}),e("span",{class:"recording__label"},"Recording")],-1)),e("div",ho,C(U(n).formattedDuration),1),e("div",yo,C(v.value.length)+" camera"+C(v.value.length!==1?"s":"")+" recording ",1)]),(j=E.value)!=null&&j.isLow?(p(),m("div",ko,[w[5]||(w[5]=e("span",{class:"warning__icon"},"⚠️",-1)),e("div",wo,[w[4]||(w[4]=e("strong",null,"Low storage",-1)),e("span",null,C(E.value.freeGB)+" GB remaining",1)])])):H("",!0),N.value?(p(),m("div",Co,[w[6]||(w[6]=Ne('<div class="davinci__header" data-v-66bc798a><svg class="davinci__icon" viewBox="0 0 24 24" fill="currentColor" data-v-66bc798a><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" data-v-66bc798a></path></svg><span class="davinci__label" data-v-66bc798a>DaVinci Resolve</span></div><p class="davinci__hint" data-v-66bc798a>Edit while recording (mount R58 recordings via SMB)</p>',2)),e("div",xo,[e("button",{onClick:b,disabled:f.value,class:"davinci__btn"},C(f.value?"Opening...":"Open Project"),9,$o),e("button",{onClick:P,disabled:f.value,class:"davinci__btn davinci__btn--secondary"}," Create Multicam ",8,Ro),e("button",{onClick:Q,disabled:f.value,class:"davinci__btn davinci__btn--secondary",title:"Refresh growing clips to update duration"},C(f.value?"Refreshing...":"Refresh Clips"),9,So)])])):H("",!0)],64)):(p(),m(Y,{key:1},[e("div",To,[e("div",{class:"sidebar__label"},[w[8]||(w[8]=le(" Camera Controls ",-1)),e("button",{onClick:y,class:"camera-setup-btn",title:"Setup Cameras"},[...w[7]||(w[7]=[e("svg",{class:"camera-setup-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("circle",{cx:"12",cy:"12",r:"3"})],-1)])])]),U(g).length>0?(p(),m("div",Mo,[(p(!0),m(Y,null,ce(U(g),B=>(p(),m("div",{key:B.name,class:"camera"},[e("div",Po,[le(C(B.name)+" ",1),e("span",{class:F(["camera__status",B.connected?"camera__status--connected":"camera__status--disconnected"])},C(B.connected?"●":"○"),3)]),e("button",{class:"camera__control-btn",onClick:de=>L(B.name),disabled:!B.connected},[...w[9]||(w[9]=[e("svg",{class:"camera__control-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("circle",{cx:"12",cy:"12",r:"3"})],-1),e("span",null,"Controls",-1)])],8,Eo)]))),128))])):(p(),m("div",Lo,[w[10]||(w[10]=e("p",{class:"cameras-empty__text"},"No cameras configured",-1)),e("button",{onClick:y,class:"cameras-empty__btn"}," Setup Cameras ")]))]),O(nt,{ref_key:"cameraModalRef",ref:$,"camera-name":D.value,onClose:G},null,8,["camera-name"]),O(co,{ref_key:"cameraSetupModalRef",ref:T,onUpdated:A},null,512),e("div",{class:"sidebar__card"},[w[12]||(w[12]=e("div",{class:"sidebar__label"},"Quick Actions",-1)),e("button",{onClick:V,class:"sidebar__btn"},[...w[11]||(w[11]=[e("svg",{class:"sidebar__btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","stroke-width":"1.8"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("circle",{cx:"12",cy:"12",r:"3"})],-1),le(" Configure Inputs ",-1)])])])],64))])}}}),Bo=ue(Ao,[["__scopeId","data-v-66bc798a"]]),Do={class:"h-full flex flex-col"},jo={class:"recorder-header"},No={class:"recorder-header__left"},Ho={class:"recorder-header__title"},Wo={key:0,class:"recorder-header__badge"},Uo={class:"flex-1 flex min-h-0 overflow-hidden"},Fo={class:"flex-1 min-h-0 min-w-0 p-3 overflow-hidden"},Vo={class:"w-72 flex-shrink-0 border-l border-preke-surface-border bg-preke-surface/80 backdrop-blur-lg p-4 overflow-y-auto"},Io={class:"mb-4"},Go={key:0,class:"mt-2 space-y-3 p-3 bg-preke-bg-base border border-preke-border rounded-lg"},Oo=["value"],zo={key:0},qo=["value"],Ko=["value"],Yo={key:1,class:"p-3 bg-preke-bg-elevated border border-preke-border-gold rounded"},Qo={class:"flex gap-2"},Xo=["disabled"],Jo={key:2,class:"text-xs text-preke-text-muted"},Zo={class:"font-mono"},ea=te({__name:"RecorderView",setup(o){const t=We(),n=ee(),k=Re(),{showLeaveConfirmation:c,confirmLeave:d,cancelLeave:s}=at(),a=_(!1),r=_(!1),u=_(""),l=_(!1);function R(){t.push("/")}const v=M(()=>n.status==="recording"),h=M(()=>n.formattedDuration),g=_(!0),S=_(!1),D=_(!1),$=M(()=>S.value&&D.value);function T(){g.value=!1}async function L(){var f;if(!Xe())return;await k.fetchCapabilities();const N=(f=k.capabilities)==null?void 0:f.current_mode;if(N&&N!=="recorder"){console.log("[Recorder] Not in recorder mode, switching...");try{(await fetch(await Je("/api/mode/recorder"),{method:"POST"})).ok&&(await k.fetchCapabilities(),X.success("Switched to Recorder mode"))}catch(W){console.warn("[Recorder] Failed to switch mode:",W)}}}function G(){console.log("[Recorder] All videos ready!"),D.value=!0}async function y(){n.selectedClient?await n.loadProjects(n.selectedClient.id):n.projects=[],n.setProject(null)}async function A(N){const f=N.target.value;if(f==="new")r.value=!0;else if(f){const W=n.projects.find(i=>i.id===parseInt(f));n.setProject(W)}else n.setProject(null)}async function E(){if(!n.selectedClient||!u.value.trim()){X.error("Please enter a project name");return}l.value=!0;try{const N=await n.createProject(n.selectedClient.id,u.value.trim(),n.recordingType||"podcast");await n.loadProjects(n.selectedClient.id),n.setProject(N),r.value=!1,u.value="",X.success("Project created")}catch(N){X.error(N.message||"Failed to create project")}finally{l.value=!1}}ae(async()=>{const N=performance.now();await Promise.all([L(),n.fetchInputs(),n.fetchStatus(),n.loadClients()]);const f=n.inputs.filter(W=>W.hasSignal).length;console.log(`[Recorder] Data loaded: ${n.inputs.length} inputs, ${f} with signal (${Math.round(performance.now()-N)}ms)`),S.value=!0,f===0&&(D.value=!0)});const V=_(null);return Z(c,N=>{var f,W;N?(f=V.value)==null||f.open():(W=V.value)==null||W.close()}),(N,f)=>(p(),m(Y,null,[O(me,{name:"fade"},{default:oe(()=>[g.value?(p(),se(ot,{key:0,mode:"recorder","content-ready":$.value,"min-time":1500,"max-time":5e3,"show-cancel":!0,onReady:T,onCancel:R},null,8,["content-ready"])):H("",!0)]),_:1}),O(me,{name:"content-fade"},{default:oe(()=>{var W;return[K(e("div",Do,[e("header",jo,[e("div",No,[e("div",Ho,[e("span",{class:F(["recorder-header__indicator",{"recorder-header__indicator--active":v.value}])},null,2),f[6]||(f[6]=e("span",{class:"recorder-header__label"},"Recorder",-1))]),v.value?(p(),m("span",Wo," REC ")):H("",!0),O(Wt)]),O(Mt)]),e("div",Uo,[e("div",Fo,[O(Cn,{onAllVideosReady:G})]),e("aside",Vo,[e("div",Io,[e("button",{onClick:f[0]||(f[0]=i=>a.value=!a.value),class:"w-full flex items-center justify-between p-3 bg-preke-bg-elevated border border-preke-border rounded-lg hover:border-preke-border-gold transition-colors"},[f[8]||(f[8]=e("span",{class:"text-sm font-medium text-preke-text-dim"},"Project (Optional)",-1)),(p(),m("svg",{class:F(["w-4 h-4 text-preke-text-muted transition-transform",{"rotate-180":a.value}]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[...f[7]||(f[7]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)])],2))]),a.value?(p(),m("div",Go,[e("div",null,[f[10]||(f[10]=e("label",{class:"block text-xs font-medium text-preke-text-subtle mb-1"},"Recording Type",-1)),K(e("select",{"onUpdate:modelValue":f[1]||(f[1]=i=>U(n).recordingType=i),onChange:f[2]||(f[2]=i=>U(n).setRecordingType(i.target.value)),class:"w-full px-3 py-2 bg-preke-bg-elevated border border-preke-border rounded text-sm text-preke-text-primary focus:outline-none focus:ring-2 focus:ring-preke-gold"},[...f[9]||(f[9]=[e("option",{value:null},"Select type...",-1),e("option",{value:"podcast"},"Podcast",-1),e("option",{value:"recording"},"Talking Head",-1),e("option",{value:"course"},"Course",-1),e("option",{value:"webinar"},"Webinar",-1)])],544),[[$e,U(n).recordingType]])]),e("div",null,[f[12]||(f[12]=e("label",{class:"block text-xs font-medium text-preke-text-subtle mb-1"},"Client",-1)),K(e("select",{"onUpdate:modelValue":f[3]||(f[3]=i=>U(n).selectedClient=i),onChange:y,class:"w-full px-3 py-2 bg-preke-bg-elevated border border-preke-border rounded text-sm text-preke-text-primary focus:outline-none focus:ring-2 focus:ring-preke-gold"},[f[11]||(f[11]=e("option",{value:null},"Select client...",-1)),(p(!0),m(Y,null,ce(U(n).clients,i=>(p(),m("option",{key:i.id,value:i},C(i.name),9,Oo))),128))],544),[[$e,U(n).selectedClient]])]),U(n).selectedClient?(p(),m("div",zo,[f[15]||(f[15]=e("label",{class:"block text-xs font-medium text-preke-text-subtle mb-1"},"Project",-1)),e("select",{value:((W=U(n).selectedProject)==null?void 0:W.id)||"",onChange:A,class:"w-full px-3 py-2 bg-preke-bg-elevated border border-preke-border rounded text-sm text-preke-text-primary focus:outline-none focus:ring-2 focus:ring-preke-gold"},[f[13]||(f[13]=e("option",{value:""},"Select project...",-1)),(p(!0),m(Y,null,ce(U(n).projects,i=>(p(),m("option",{key:i.id,value:i.id},C(i.name),9,Ko))),128)),f[14]||(f[14]=e("option",{value:"new"},"+ Create New Project",-1))],40,qo)])):H("",!0),r.value?(p(),m("div",Yo,[f[16]||(f[16]=e("label",{class:"block text-xs font-medium text-preke-text-subtle mb-1"},"New Project Name",-1)),K(e("input",{"onUpdate:modelValue":f[4]||(f[4]=i=>u.value=i),type:"text",placeholder:"Project name",class:"w-full px-3 py-2 bg-preke-bg-base border border-preke-border rounded text-sm text-preke-text-primary focus:outline-none focus:ring-2 focus:ring-preke-gold mb-2",onKeyup:et(E,["enter"])},null,544),[[re,u.value]]),e("div",Qo,[e("button",{onClick:E,disabled:l.value||!u.value.trim(),class:"flex-1 px-3 py-1.5 bg-preke-gold text-preke-bg-base rounded text-xs font-medium hover:bg-preke-gold-hover disabled:opacity-50 disabled:cursor-not-allowed"},C(l.value?"Creating...":"Create"),9,Xo),e("button",{onClick:f[5]||(f[5]=i=>{r.value=!1,u.value=""}),class:"flex-1 px-3 py-1.5 bg-preke-bg-base border border-preke-border rounded text-xs font-medium hover:bg-preke-bg-elevated"}," Cancel ")])])):H("",!0),U(n).selectedClient&&U(n).selectedProject?(p(),m("div",Jo,[e("span",Zo,C(U(n).recordingPath),1)])):H("",!0)])):H("",!0)]),O(Bo)])]),O(De,{ref_key:"leaveDialog",ref:V,title:"Recording in Progress",message:`You are currently recording (${h.value}). Leaving will stop the recording and save all files.`,"confirm-text":"Leave and Stop Recording","cancel-text":"Stay",danger:!0,onConfirm:U(d),onCancel:U(s)},null,8,["message","onConfirm","onCancel"])],512),[[Ze,!g.value]])]}),_:1})],64))}}),aa=ue(ea,[["__scopeId","data-v-0c8a0007"]]);export{aa as default};
