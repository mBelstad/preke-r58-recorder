import{X as Fe,r as v,k as L,h as re,d as le,K as pe,c,e as D,b as e,q as oe,P as Oe,B as de,y as ie,F as te,z as se,t as $,n as q,s as X,L as He,j as E,o as i,Y as De,H as ue,Z as Te,m as ge,_ as fe,f as ne,T as he,w as ke,W as Ae,p as We,G as Ue,u as Ke,$ as Ne,V as $e,v as qe,i as ze}from"./index-Dkkjpo3l.js";import{b as Le,a as ye,o as Ge,c as Xe,V as me,g as je,d as Pe,e as Me,f as Ve,h as Ye,i as Qe,j as Ze}from"./vdoninja-uKGezzqg.js";import{u as Je,P as et,C as tt,p as ot,M as nt}from"./ModeLoadingScreen-Bzkc0xHm.js";import"./AnimatedBackground-C_25UXl0.js";const Q=[{id:"youtube",name:"YouTube Live",icon:"â–¶ï¸",rtmpBaseUrl:"rtmp://a.rtmp.youtube.com/live2/",streamKeyPlaceholder:"xxxx-xxxx-xxxx-xxxx-xxxx",helpUrl:"https://support.google.com/youtube/answer/2907883"},{id:"twitch",name:"Twitch",icon:"ðŸ“º",rtmpBaseUrl:"rtmp://live.twitch.tv/app/",streamKeyPlaceholder:"live_xxxxxxxxxx_xxxxxxxxxxxxxx",helpUrl:"https://help.twitch.tv/s/article/twitch-stream-key-faq"},{id:"facebook",name:"Facebook Live",icon:"ðŸ“˜",rtmpBaseUrl:"rtmps://live-api-s.facebook.com:443/rtmp/",streamKeyPlaceholder:"FB-xxxxxxxxxx-x",helpUrl:"https://www.facebook.com/help/587160588142067"},{id:"restream",name:"Restream",icon:"ðŸ”„",rtmpBaseUrl:"rtmp://live.restream.io/live/",streamKeyPlaceholder:"re_xxxxxx_xxxxxxxxxx",helpUrl:"https://support.restream.io/en/"},{id:"custom",name:"Custom RTMP",icon:"âš™ï¸",rtmpBaseUrl:"",streamKeyPlaceholder:"your-stream-key"}],be=Fe("streaming",()=>{const f=v([]),w=v(!1),a=v(null),m=v("alpha"),l=v(null),R=v(null),k=v(null),h=v({enabled:!1,host:"",port:8890,streamId:"mixer_program"}),S=L(()=>f.value.find(r=>r.id===a.value)),V=L(()=>f.value.filter(r=>r.enabled)),s=L(()=>Q),x=L(()=>{const r=window.location.hostname,M=r==="localhost"||r==="127.0.0.1",A=M?"localhost":"app.itagenten.no";return{rtmp:M?"rtmp://localhost:1935/mixer_program":"rtmp://app.itagenten.no:1935/mixer_program",rtsp:M?"rtsp://localhost:8554/mixer_program":"rtsp://app.itagenten.no:8554/mixer_program",srt:M?"srt://localhost:8890?streamid=read:mixer_program":"srt://app.itagenten.no:8890?streamid=read:mixer_program",hls:`https://${A}/hls/mixer_program/index.m3u8`,whep:`https://${A}/mixer_program/whep`}});function u(r,M){const A=Q.find(ae=>ae.id===r);if(!A)throw new Error(`Unknown platform: ${r}`);const J={id:`dest-${Date.now()}`,platformId:r,name:M||A.name,streamKey:"",enabled:!1};return f.value.push(J),J}function y(r,M){const A=f.value.findIndex(J=>J.id===r);A!==-1&&(f.value[A]={...f.value[A],...M})}function P(r){const M=f.value.findIndex(A=>A.id===r);M!==-1&&f.value.splice(M,1),a.value===r&&(a.value=null)}function W(r){a.value=r}function z(r){h.value.enabled=r}function B(r){h.value={...h.value,...r}}function H(){w.value=!0}function K(){w.value=!1}function N(r){const M=Q.find(A=>A.id===r.platformId);return M?r.platformId==="custom"?`${r.name}${r.streamKey}`:`${M.rtmpBaseUrl}${r.streamKey}`:""}function O(){const r=window.location.hostname;return`srt://${r==="localhost"||r==="127.0.0.1"?"localhost":"app.itagenten.no"}:${h.value.port}?streamid=read:${h.value.streamId}`}function g(){try{const r=localStorage.getItem("r58-streaming-destinations");if(r){const M=JSON.parse(r);f.value=M.destinations||[],M.srtOutput&&(h.value={...h.value,...M.srtOutput}),M.programOutputMode&&(m.value=M.programOutputMode)}}catch(r){console.warn("Failed to load saved streaming destinations:",r)}}function b(){try{localStorage.setItem("r58-streaming-destinations",JSON.stringify({destinations:f.value,srtOutput:h.value,programOutputMode:m.value}))}catch(r){console.warn("Failed to save streaming destinations:",r)}}async function j(){try{const r=V.value;if(r.length===0)return console.warn("[Streaming] No enabled destinations to stream to"),{success:!1,message:"No destinations configured"};const M=r.map(ae=>{var ve;return{platform:ae.platformId,rtmp_url:((ve=Q.find(xe=>xe.id===ae.platformId))==null?void 0:ve.rtmpBaseUrl)||"",stream_key:ae.streamKey,enabled:!0}}),A=await fetch(await re("/api/streaming/rtmp/start"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({destinations:M})}),J=await A.json();if(!A.ok)throw new Error(J.detail||"Failed to start RTMP relay");return console.log("[Streaming] RTMP relay configured via MediaMTX runOnReady:",J),{success:!0,message:J.message||`Streaming to ${r.length} destination(s)`}}catch(r){const M=r instanceof Error?r.message:"Failed to start RTMP relay";return console.error("[Streaming] Failed to start RTMP relay:",r),{success:!1,message:M}}}async function p(){try{const r=await fetch(await re("/api/streaming/rtmp/stop"),{method:"POST"}),M=await r.json();if(!r.ok)throw new Error(M.detail||"Failed to stop RTMP relay");return console.log("[Streaming] RTMP relay stopped"),{success:!0,message:"RTMP relay stopped"}}catch(r){const M=r instanceof Error?r.message:"Failed to stop RTMP relay";return console.error("[Streaming] Failed to stop RTMP relay:",r),{success:!1,message:M}}}async function t(){try{const r=await fetch(await re("/api/streaming/status"));if(!r.ok)throw new Error("Failed to get streaming status");return await r.json()}catch(r){return console.error("[Streaming] Failed to get streaming status:",r),null}}async function n(){try{const r=await fetch(await re("/api/streaming/stats"));if(!r.ok)throw new Error("Failed to get streaming stats");return await r.json()}catch(r){return console.error("[Streaming] Failed to get streaming stats:",r),null}}function o(r){m.value=r,b()}function U(r){r?l.value||(l.value=Date.now()):l.value=null}return g(),{destinations:f,isStreaming:w,activeDestinationId:a,srtOutput:h,programOutputMode:m,streamStartTime:l,streamStatus:R,streamStats:k,activeDestination:S,enabledDestinations:V,platforms:s,programOutputUrls:x,addDestination:u,updateDestination:y,removeDestination:P,setActiveDestination:W,toggleSrtOutput:z,updateSrtConfig:B,startStreaming:H,stopStreaming:K,setProgramOutputMode:o,markStreamActive:U,buildRtmpUrl:N,getSrtOutputUrl:O,saveDestinations:b,loadSavedDestinations:g,startRtmpRelay:j,stopRtmpRelay:p,getStreamingStatus:t,getStreamingStats:n}}),st={key:0,class:"fixed inset-0 z-50 flex items-center justify-center"},at={class:"relative bg-preke-bg-elevated border border-preke-bg-surface rounded-xl w-full max-w-2xl max-h-[80vh] overflow-hidden shadow-2xl"},rt={class:"p-6 overflow-y-auto max-h-[60vh]"},lt={key:0,class:"mb-8 p-6 bg-gradient-to-br from-amber-600/20 to-red-600/20 rounded-xl border border-amber-500/30"},it={class:"flex gap-3 mb-4"},ut=["placeholder"],ct={class:"text-xs text-preke-text-dim"},dt=["href"],pt={class:"mb-8"},mt={class:"flex items-center justify-between mb-4"},gt={key:0,class:"mb-4 p-4 bg-preke-bg-surface rounded-lg"},vt={class:"grid grid-cols-2 gap-2"},ft=["onClick"],bt={class:"text-xl"},xt={key:1,class:"space-y-3"},ht=["onClick"],kt={class:"text-xl"},wt={class:"flex-1"},yt={class:"font-medium"},_t={class:"text-xs text-preke-text-dim"},St=["onClick"],Ct=["onClick"],$t={key:2,class:"text-preke-text-dim text-sm"},Pt={key:1,class:"mb-8 p-4 bg-preke-bg-surface rounded-lg"},Mt={class:"text-lg font-medium mb-4"},Rt={class:"space-y-4"},Ot=["placeholder"],Dt={key:0},Tt={class:"flex gap-2"},Ut={class:"mb-8"},Lt={class:"space-y-3"},jt={class:"p-3 bg-preke-bg-surface rounded-lg"},Vt={class:"flex items-center justify-between mb-1"},It={class:"text-xs text-preke-text-dim break-all"},Et={class:"p-3 bg-preke-bg-surface rounded-lg"},Bt={class:"flex items-center justify-between mb-1"},Ft={class:"text-xs text-preke-text-dim break-all"},Ht={class:"p-3 bg-preke-bg-surface rounded-lg"},At={class:"flex items-center justify-between mb-1"},Wt={class:"text-xs text-preke-text-dim break-all"},Kt={class:"p-3 bg-preke-bg-surface rounded-lg"},Nt={class:"flex items-center justify-between mb-1"},qt={class:"text-xs text-preke-text-dim break-all"},zt={class:"p-3 bg-preke-bg-surface rounded-lg"},Gt={class:"flex items-center justify-between mb-1"},Xt={class:"text-xs text-preke-text-dim break-all"},Yt={class:"mb-8"},Qt={class:"p-4 bg-preke-bg-surface rounded-lg space-y-3"},Zt={class:"flex items-center gap-3 text-sm"},Jt=["checked"],eo={class:"flex items-center gap-3 text-sm"},to=["checked"],oo={class:"p-4 bg-preke-bg-surface rounded-lg"},no={class:"flex items-center gap-3 mb-4"},so=le({__name:"StreamingSettings",setup(f,{expose:w}){const a=be(),m=v(!1),l=v(null),R=v(!1),k=v("youtube"),h=v("");v(""),v("");const S=L(()=>a.destinations),V=L(()=>Q),s=L(()=>a.programOutputUrls),x=L(()=>a.programOutputMode);function u(){m.value=!0}function y(){m.value=!1,l.value=null,R.value=!1}function P(p){const t=a.addDestination(p);l.value=t,R.value=!1,a.saveDestinations()}function W(){l.value&&(a.updateDestination(l.value.id,l.value),a.saveDestinations(),l.value=null,E.success("Streaming destination saved"))}function z(p){a.removeDestination(p),a.saveDestinations(),E.info("Destination removed")}function B(p){a.updateDestination(p.id,{enabled:!p.enabled}),a.saveDestinations()}function H(p,t){navigator.clipboard.writeText(p),E.success(`${t} copied to clipboard`)}function K(p){const t=Q.find(n=>n.id===p);return(t==null?void 0:t.icon)||"ðŸ“¡"}function N(p){const t=Q.find(n=>n.id===p);return(t==null?void 0:t.name)||"Unknown"}function O(){const p=Q.find(t=>t.id===k.value);return(p==null?void 0:p.streamKeyPlaceholder)||"Enter stream key"}function g(){switch(k.value){case"youtube":return"https://support.google.com/youtube/answer/2907883";case"twitch":return"https://help.twitch.tv/s/article/twitch-stream-key-faq";case"facebook":return"https://www.facebook.com/help/587160588142067";case"restream":return"https://support.restream.io/en/";default:return"#"}}function b(){if(!h.value.trim()){E.error("Please enter your stream key");return}const p=a.addDestination(k.value);a.updateDestination(p.id,{streamKey:h.value,enabled:!0}),a.saveDestinations(),h.value="",E.success(`${N(k.value)} configured and enabled!`)}function j(p){a.setProgramOutputMode(p),E.success(`Program output mode set to ${p==="alpha"?"Alpha publish":"WHIP output"}`)}return w({open:u}),(p,t)=>{var n;return i(),pe(He,{to:"body"},[m.value?(i(),c("div",st,[e("div",{class:"absolute inset-0 bg-black/60",onClick:y}),e("div",at,[e("div",{class:"flex items-center justify-between px-6 py-4 border-b border-preke-bg-surface"},[t[15]||(t[15]=e("h2",{class:"text-xl font-semibold"},"Streaming Settings",-1)),e("button",{onClick:y,class:"text-preke-text-dim hover:text-preke-text text-2xl"}," Ã— ")]),e("div",rt,[S.value.length===0?(i(),c("section",lt,[t[18]||(t[18]=e("h3",{class:"text-xl font-semibold mb-2 flex items-center gap-2"}," ðŸ”´ Quick Setup: Stream to YouTube ",-1)),t[19]||(t[19]=e("p",{class:"text-sm text-preke-text-dim mb-4"}," Get streaming in seconds! Just paste your stream key below. ",-1)),e("div",it,[oe(e("select",{"onUpdate:modelValue":t[0]||(t[0]=o=>k.value=o),class:"px-4 py-3 bg-preke-bg-elevated border border-preke-bg-surface rounded-lg text-base"},[...t[16]||(t[16]=[e("option",{value:"youtube"},"â–¶ï¸ YouTube Live",-1),e("option",{value:"twitch"},"ðŸ“º Twitch",-1),e("option",{value:"facebook"},"ðŸ“˜ Facebook",-1),e("option",{value:"restream"},"ðŸ”„ Restream",-1)])],512),[[Oe,k.value]]),oe(e("input",{"onUpdate:modelValue":t[1]||(t[1]=o=>h.value=o),type:"password",placeholder:O(),class:"flex-1 px-4 py-3 bg-preke-bg-elevated border border-preke-bg-surface rounded-lg font-mono text-base focus:border-amber-500 focus:outline-none"},null,8,ut),[[de,h.value]]),e("button",{onClick:b,class:"px-6 py-3 bg-red-600 hover:bg-red-500 text-white rounded-lg font-semibold transition-colors"}," Save & Enable ")]),e("p",ct,[t[17]||(t[17]=ie(" ðŸ”’ Your stream key is stored locally on this device and never sent to any server. ",-1)),e("a",{href:g(),target:"_blank",class:"text-amber-400 hover:underline ml-2"}," Where do I find my stream key? â†’ ",8,dt)])])):D("",!0),e("section",pt,[e("div",mt,[t[20]||(t[20]=e("h3",{class:"text-lg font-medium"},"Streaming Destinations",-1)),e("button",{onClick:t[2]||(t[2]=o=>R.value=!R.value),class:"btn btn-sm btn-primary"}," + Add Platform ")]),R.value?(i(),c("div",gt,[t[21]||(t[21]=e("p",{class:"text-sm text-preke-text-dim mb-3"},"Select a streaming platform:",-1)),e("div",vt,[(i(!0),c(te,null,se(V.value,o=>(i(),c("button",{key:o.id,onClick:U=>P(o.id),class:"flex items-center gap-2 p-3 bg-preke-bg-elevated hover:bg-preke-gold/20 rounded-lg transition-colors text-left"},[e("span",bt,$(o.icon),1),e("span",null,$(o.name),1)],8,ft))),128))])])):D("",!0),S.value.length>0?(i(),c("div",xt,[(i(!0),c(te,null,se(S.value,o=>(i(),c("div",{key:o.id,class:"flex items-center gap-3 p-3 bg-preke-bg-surface rounded-lg"},[e("button",{onClick:U=>B(o),class:q(["w-10 h-6 rounded-full transition-colors relative",o.enabled?"bg-preke-green":"bg-preke-bg-elevated"])},[e("span",{class:q(["absolute top-1 w-4 h-4 rounded-full bg-white transition-transform",o.enabled?"left-5":"left-1"])},null,2)],10,ht),e("span",kt,$(K(o.platformId)),1),e("div",wt,[e("div",yt,$(o.name),1),e("div",_t,$(o.streamKey?"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"+o.streamKey.slice(-4):"No stream key"),1)]),e("button",{onClick:U=>l.value={...o},class:"text-preke-gold hover:underline text-sm"}," Edit ",8,St),e("button",{onClick:U=>z(o.id),class:"text-preke-red hover:underline text-sm"}," Remove ",8,Ct)]))),128))])):(i(),c("p",$t," No streaming destinations configured. Add a platform above. "))]),l.value?(i(),c("section",Pt,[e("h3",Mt," Edit "+$(N(l.value.platformId)),1),e("div",Rt,[e("div",null,[t[22]||(t[22]=e("label",{class:"block text-sm text-preke-text-dim mb-1"},"Display Name",-1)),oe(e("input",{"onUpdate:modelValue":t[3]||(t[3]=o=>l.value.name=o),type:"text",class:"w-full px-3 py-2 bg-preke-bg-elevated border border-preke-bg-surface rounded-lg focus:border-preke-gold focus:outline-none"},null,512),[[de,l.value.name]])]),e("div",null,[t[23]||(t[23]=e("label",{class:"block text-sm text-preke-text-dim mb-1"},"Stream Key",-1)),oe(e("input",{"onUpdate:modelValue":t[4]||(t[4]=o=>l.value.streamKey=o),type:"password",placeholder:(n=X(Q).find(o=>o.id===l.value.platformId))==null?void 0:n.streamKeyPlaceholder,class:"w-full px-3 py-2 bg-preke-bg-elevated border border-preke-bg-surface rounded-lg focus:border-preke-gold focus:outline-none font-mono"},null,8,Ot),[[de,l.value.streamKey]]),t[24]||(t[24]=e("p",{class:"text-xs text-preke-text-dim mt-1"}," Your stream key is stored locally and never sent to our servers. ",-1))]),l.value.platformId==="custom"?(i(),c("div",Dt,[t[25]||(t[25]=e("label",{class:"block text-sm text-preke-text-dim mb-1"},"RTMP URL",-1)),oe(e("input",{"onUpdate:modelValue":t[5]||(t[5]=o=>l.value.name=o),type:"text",placeholder:"rtmp://your-server.com/live/",class:"w-full px-3 py-2 bg-preke-bg-elevated border border-preke-bg-surface rounded-lg focus:border-preke-gold focus:outline-none font-mono"},null,512),[[de,l.value.name]])])):D("",!0),e("div",Tt,[e("button",{onClick:W,class:"btn btn-primary"}," Save "),e("button",{onClick:t[6]||(t[6]=o=>l.value=null),class:"btn"}," Cancel ")])])])):D("",!0),e("section",Ut,[t[34]||(t[34]=e("h3",{class:"text-lg font-medium mb-4"},"Program Output URLs",-1)),t[35]||(t[35]=e("p",{class:"text-sm text-preke-text-dim mb-4"}," Use these URLs to consume the program feed from MediaMTX: ",-1)),e("div",Lt,[e("div",jt,[e("div",Vt,[t[26]||(t[26]=e("span",{class:"font-medium"},"ðŸ”´ SRT Output",-1)),e("button",{onClick:t[7]||(t[7]=o=>H(s.value.srt,"SRT URL")),class:"text-xs text-preke-gold hover:underline"}," Copy ")]),e("code",It,$(s.value.srt),1),t[27]||(t[27]=e("p",{class:"text-xs text-preke-text-dim mt-1"}," Low-latency, reliable transport. Ideal for remote production. ",-1))]),e("div",Et,[e("div",Bt,[t[28]||(t[28]=e("span",{class:"font-medium"},"ðŸ“º RTMP Output",-1)),e("button",{onClick:t[8]||(t[8]=o=>H(s.value.rtmp,"RTMP URL")),class:"text-xs text-preke-gold hover:underline"}," Copy ")]),e("code",Ft,$(s.value.rtmp),1)]),e("div",Ht,[e("div",At,[t[29]||(t[29]=e("span",{class:"font-medium"},"ðŸŽ¬ RTSP Output",-1)),e("button",{onClick:t[9]||(t[9]=o=>H(s.value.rtsp,"RTSP URL")),class:"text-xs text-preke-gold hover:underline"}," Copy ")]),e("code",Wt,$(s.value.rtsp),1)]),e("div",Kt,[e("div",Nt,[t[30]||(t[30]=e("span",{class:"font-medium"},"ðŸŒ HLS Output",-1)),e("button",{onClick:t[10]||(t[10]=o=>H(s.value.hls,"HLS URL")),class:"text-xs text-preke-gold hover:underline"}," Copy ")]),e("code",qt,$(s.value.hls),1),t[31]||(t[31]=e("p",{class:"text-xs text-preke-text-dim mt-1"}," Browser-compatible streaming. Higher latency. ",-1))]),e("div",zt,[e("div",Gt,[t[32]||(t[32]=e("span",{class:"font-medium"},"âš¡ WebRTC (WHEP)",-1)),e("button",{onClick:t[11]||(t[11]=o=>H(s.value.whep,"WHEP URL")),class:"text-xs text-preke-gold hover:underline"}," Copy ")]),e("code",Xt,$(s.value.whep),1),t[33]||(t[33]=e("p",{class:"text-xs text-preke-text-dim mt-1"}," Ultra-low latency WebRTC. Best for interactive use. ",-1))])])]),e("section",Yt,[t[39]||(t[39]=e("h3",{class:"text-lg font-medium mb-4"},"Program Output Mode",-1)),e("div",Qt,[e("label",Zt,[e("input",{type:"radio",name:"program-output-mode",value:"alpha",checked:x.value==="alpha",onChange:t[12]||(t[12]=o=>j("alpha"))},null,40,Jt),t[36]||(t[36]=e("span",null,"Alpha publish mode (`&publish&mediamtx=`)",-1))]),e("label",eo,[e("input",{type:"radio",name:"program-output-mode",value:"whipout",checked:x.value==="whipout",onChange:t[13]||(t[13]=o=>j("whipout"))},null,40,to),t[37]||(t[37]=e("span",null,"WHIP output mode (`&whipout=`)",-1))]),t[38]||(t[38]=e("p",{class:"text-xs text-preke-text-dim"}," Alpha publish mode matches the newest VDO.Ninja alpha workflow and is recommended for MediaMTX. ",-1))])]),e("section",null,[t[42]||(t[42]=e("h3",{class:"text-lg font-medium mb-4"},"SRT Configuration",-1)),e("div",oo,[e("div",no,[e("button",{onClick:t[14]||(t[14]=o=>X(a).toggleSrtOutput(!X(a).srtOutput.enabled)),class:q(["w-10 h-6 rounded-full transition-colors relative",X(a).srtOutput.enabled?"bg-preke-green":"bg-preke-bg-elevated"])},[e("span",{class:q(["absolute top-1 w-4 h-4 rounded-full bg-white transition-transform",X(a).srtOutput.enabled?"left-5":"left-1"])},null,2)],2),t[40]||(t[40]=e("span",null,"Enable SRT Output",-1))]),t[41]||(t[41]=e("div",{class:"text-sm text-preke-text-dim"},[e("p",{class:"mb-2"},"SRT (Secure Reliable Transport) provides:"),e("ul",{class:"list-disc list-inside space-y-1"},[e("li",null,"Low latency (typically 1-2 seconds)"),e("li",null,"Error correction for unreliable networks"),e("li",null,"AES encryption support"),e("li",null,"Compatible with OBS, vMix, and professional equipment")])],-1))])])]),e("div",{class:"flex items-center justify-end gap-3 px-6 py-4 border-t border-preke-bg-surface"},[e("button",{onClick:y,class:"btn"},"Close")])])])):D("",!0)])}}}),ao={class:"program-output space-y-3","data-testid":"program-output"},ro={class:"flex items-center gap-2 px-3 py-2 bg-preke-bg-surface rounded-lg","data-testid":"program-output-status"},lo={class:"text-sm font-medium","data-testid":"program-output-text"},io={key:0,class:"space-y-2"},uo={class:"flex items-center gap-2 px-3 py-2 bg-preke-bg-surface/50 rounded-lg"},co={class:"flex-1 text-xs truncate text-preke-text-dim"},po={key:0,class:"flex items-center gap-2 px-3 py-2 bg-preke-bg-surface/50 rounded-lg"},mo={class:"text-xs text-preke-text-dim"},go={key:1,class:"text-xs text-preke-text-dim px-3"},vo={class:"hidden"},fo=["src"],bo=le({__name:"ProgramOutput",setup(f){const w=De(),a=be(),m=v(!1),l=v("idle"),R=v(""),k=v(null),h=v(null);let S=null;const V=L(()=>a.programOutputMode==="alpha");function s(){return"https://app.itagenten.no/mixer_program/whip"}async function x(){if(m.value)return;l.value="connecting";const O=V.value?await Le():await ye(s());if(!O){l.value="error",console.error("[ProgramOutput] Failed to build VDO.ninja URL - VDO.ninja not configured");return}R.value=O,m.value=!0,console.log("[ProgramOutput] Starting program output:",O)}function u(){m.value&&(m.value=!1,R.value="",l.value="idle",k.value=null,h.value=null,B(),console.log("[ProgramOutput] Stopped WHIP push"))}function y(){m.value&&(l.value="live",console.log("[ProgramOutput] WHIP push connected"))}function P(){l.value="error",console.error("[ProgramOutput] WHIP push failed")}async function W(){u(),await new Promise(O=>setTimeout(O,500)),await x()}ue(()=>w.isLive,async O=>{O?(await x(),z()):u()});function z(){S||(S=setInterval(async()=>{try{const O=await a.getStreamingStatus();if(!O)return;k.value=O,h.value=O.error||null,O.mixer_program_active?l.value="live":O.error?l.value="error":m.value&&(l.value="connecting")}catch(O){h.value=O instanceof Error?O.message:"Status polling failed"}},2e3))}function B(){S&&(clearInterval(S),S=null)}Te(()=>{B()});function H(){switch(l.value){case"live":return"bg-emerald-500";case"connecting":return"bg-amber-500 animate-pulse";case"error":return"bg-red-500";default:return"bg-gray-500"}}function K(){switch(l.value){case"live":return"MediaMTX connected";case"connecting":return"Connecting...";case"error":return"Connection failed";default:return"Inactive"}}function N(){const O=a.programOutputUrls.srt;navigator.clipboard.writeText(O),E.success("SRT URL copied")}return(O,g)=>(i(),c("div",ao,[e("div",ro,[e("span",{class:q(["w-2 h-2 rounded-full",H()]),"data-testid":"program-output-indicator"},null,2),e("span",lo,$(K()),1),l.value==="error"?(i(),c("button",{key:0,onClick:g[0]||(g[0]=b=>W()),class:"ml-auto text-xs text-preke-gold hover:underline"}," Retry ")):D("",!0)]),l.value==="live"?(i(),c("div",io,[e("div",uo,[g[1]||(g[1]=e("span",{class:"text-xs text-preke-text-dim"},"ðŸ”´ SRT:",-1)),e("code",co,$(X(a).programOutputUrls.srt),1),e("button",{onClick:N,class:"text-xs text-preke-gold hover:underline"},"Copy")]),X(a).enabledDestinations.length>0?(i(),c("div",po,[g[2]||(g[2]=e("span",{class:"w-2 h-2 rounded-full bg-emerald-500"},null,-1)),e("span",mo,$(X(a).enabledDestinations.length)+" streaming destination"+$(X(a).enabledDestinations.length>1?"s":"")+" active ",1)])):D("",!0)])):D("",!0),l.value==="idle"?(i(),c("p",go," Program output will start automatically when you go live. ")):D("",!0),e("div",vo,[m.value&&R.value?(i(),c("iframe",{key:0,src:R.value,onLoad:y,onError:P,allow:"camera; microphone; autoplay",class:"w-0 h-0"},null,40,fo)):D("",!0)])]))}}),xo={class:"stream-health space-y-3"},ho={class:"flex items-center gap-2"},ko={class:"text-sm font-medium"},wo={key:0,class:"text-xs text-preke-green"},yo={class:"grid grid-cols-2 gap-3 text-xs text-preke-text-dim"},_o={class:"flex items-center justify-between bg-preke-bg-surface/50 rounded-md px-3 py-2"},So={class:"text-preke-text"},Co={class:"flex items-center justify-between bg-preke-bg-surface/50 rounded-md px-3 py-2"},$o={class:"text-preke-text"},Po={class:"flex items-center justify-between bg-preke-bg-surface/50 rounded-md px-3 py-2"},Mo={class:"text-preke-text"},Ro={class:"flex items-center justify-between bg-preke-bg-surface/50 rounded-md px-3 py-2"},Oo={class:"text-preke-text"},Do={class:"flex items-center justify-between bg-preke-bg-surface/50 rounded-md px-3 py-2"},To={class:"text-preke-text"},Uo={key:0,class:"text-xs text-preke-text-dim bg-preke-bg-surface/50 rounded-md px-3 py-2"},Lo={class:"block truncate text-preke-text"},jo={key:1,class:"text-xs text-preke-text-dim bg-preke-bg-surface/50 rounded-md px-3 py-2"},Vo={class:"flex items-center justify-between gap-2"},Io={class:"block truncate text-preke-text"},Eo={key:2,class:"text-xs text-preke-red bg-preke-bg-surface/50 rounded-md px-3 py-2"},Bo=le({__name:"StreamHealthMonitor",setup(f){const w=be(),a=v(Date.now()),m=v(null),l=v(null);let R=null,k=null;const h=v(""),S=L(()=>{var g;return((g=m.value)==null?void 0:g.mixer_program_active)===!0}),V=L(()=>{var g;return((g=m.value)==null?void 0:g.rtmp_relay_configured)===!0}),s=L(()=>{var g;return((g=m.value)==null?void 0:g.run_on_ready)||null}),x=L(()=>{var g,b;return((g=m.value)==null?void 0:g.error)||((b=l.value)==null?void 0:b.error)||null}),u=L(()=>{var b,j;const g=((b=l.value)==null?void 0:b.bitrate_bps)||((j=l.value)==null?void 0:j.bitrate)||null;return typeof g=="number"?g:null}),y=L(()=>{var g,b,j,p;return((g=l.value)==null?void 0:g.resolution)||((p=(j=(b=l.value)==null?void 0:b.source)==null?void 0:j.video)==null?void 0:p.resolution)||null}),P=L(()=>{var g,b,j,p;return((g=l.value)==null?void 0:g.fps)||((p=(j=(b=l.value)==null?void 0:b.source)==null?void 0:j.video)==null?void 0:p.fps)||null}),W=L(()=>{const g=w.streamStartTime;if(!g)return"â€”";const b=a.value-g;if(b<0)return"â€”";const j=Math.floor(b/1e3),p=Math.floor(j/3600),t=Math.floor(j%3600/60),n=j%60;return p>0?`${p}:${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`:`${t}:${n.toString().padStart(2,"0")}`}),z=L(()=>{if(!u.value)return"â€”";const g=u.value/1e3;return g<1e3?`${g.toFixed(0)} kbps`:`${(g/1e3).toFixed(2)} Mbps`}),B=L(()=>S.value?u.value?u.value>=2e6?"Good":u.value>=8e5?"Fair":"Poor":"Connecting":"Offline");async function H(){const g=await w.getStreamingStatus();g&&(m.value=g,w.streamStatus=g,w.markStreamActive(g.mixer_program_active===!0));const b=await w.getStreamingStats();b&&(l.value=b,w.streamStats=b)}async function K(){const b=w.programOutputMode==="alpha"?await Le():await ye("https://app.itagenten.no/mixer_program/whip");h.value=b||""}function N(){R||(R=setInterval(H,2e3))}function O(){R&&(clearInterval(R),R=null)}return ge(()=>{H(),K(),N(),k=setInterval(()=>{a.value=Date.now()},1e3)}),Te(()=>{O(),k&&(clearInterval(k),k=null)}),ue(S,g=>{w.markStreamActive(g)}),ue(()=>w.programOutputMode,()=>{K()}),(g,b)=>(i(),c("div",xo,[e("div",ho,[e("span",{class:q(["w-2 h-2 rounded-full",S.value?"bg-emerald-500":"bg-gray-500"])},null,2),e("span",ko,$(S.value?"Program output active":"Program output inactive"),1),V.value?(i(),c("span",wo,"RTMP relay on")):D("",!0)]),e("div",yo,[e("div",_o,[b[1]||(b[1]=e("span",null,"Duration",-1)),e("span",So,$(W.value),1)]),e("div",Co,[b[2]||(b[2]=e("span",null,"Quality",-1)),e("span",$o,$(B.value),1)]),e("div",Po,[b[3]||(b[3]=e("span",null,"Bitrate",-1)),e("span",Mo,$(z.value),1)]),e("div",Ro,[b[4]||(b[4]=e("span",null,"Resolution",-1)),e("span",Oo,$(y.value||"â€”"),1)]),e("div",Do,[b[5]||(b[5]=e("span",null,"FPS",-1)),e("span",To,$(P.value||"â€”"),1)])]),s.value?(i(),c("div",Uo,[b[6]||(b[6]=e("span",{class:"block text-preke-text-muted"},"RTMP relay",-1)),e("code",Lo,$(s.value),1)])):D("",!0),h.value?(i(),c("div",jo,[e("div",Vo,[b[7]||(b[7]=e("span",{class:"text-preke-text-muted"},"Program output URL",-1)),e("button",{class:"text-preke-gold hover:underline",onClick:b[0]||(b[0]=j=>g.navigator.clipboard.writeText(h.value))}," Copy ")]),e("code",Io,$(h.value),1)])):D("",!0),x.value?(i(),c("div",Eo,$(x.value),1)):D("",!0)]))}}),Fo=fe(Bo,[["__scopeId","data-v-9e82c88e"]]),Ho={class:"streaming-control-panel"},Ao={class:"control-bar"},Wo={key:0,class:"control-bar__room"},Ko={class:"control-bar__room-name"},No={key:0,class:"control-bar__camera-count"},qo={key:1,class:"control-bar__divider"},zo={class:"control-bar__status"},Go={class:"control-bar__status-text"},Xo={key:0,class:"control-bar__btn-icon",fill:"currentColor",viewBox:"0 0 24 24"},Yo={key:1,class:"control-bar__btn-icon",fill:"currentColor",viewBox:"0 0 24 24"},Qo={key:3,class:"control-bar__destinations"},Zo={class:"control-bar__destinations-list"},Jo=["title"],en={key:0,class:"quick-setup"},tn={class:"quick-setup__form"},on={class:"quick-setup__platform"},nn={class:"quick-setup__platform-icon"},sn={class:"quick-setup__input-wrap"},an=["placeholder"],rn={key:0,class:"px-4 py-3"},ln={class:"hidden"},un=le({__name:"StreamingControlPanel",props:{roomName:{default:""},cameraCount:{default:0}},setup(f){const w=f,a=De(),m=be(),l=v(null),R=v(null),k=v(!1),h=v("youtube"),S=v(""),V=L(()=>a.isLive),s=L(()=>m.destinations.length>0),x=L(()=>m.enabledDestinations.length>0),u=L(()=>V.value?"live":"idle");function y(){V.value?z():P()}async function P(){if(a.setLive(!0),m.enabledDestinations.length>0){const n=await m.startRtmpRelay();if(n.success){E.success(n.message);try{const o=await W();o.success?E.success("Program output started on device"):E.warning(`Note: ${o.message}. You may need to manually trigger program output.`)}catch(o){console.warn("[Streaming] Could not trigger device program output:",o)}}else E.error(`RTMP relay failed: ${n.message}`)}else E.success("Streaming started (no RTMP destinations configured)")}async function W(){try{const o=await(await fetch(await re("/api/streaming/program-output/start"),{method:"POST",headers:{"Content-Type":"application/json"}})).json();return o.status==="success"?(console.log("[Streaming] Device program output triggered:",o),{success:!0,message:o.message||"Program output started"}):(console.warn("[Streaming] Device program output trigger failed:",o),{success:!1,message:o.message||"Failed to trigger program output"})}catch(n){const o=n instanceof Error?n.message:"Unknown error";return console.error("[Streaming] Failed to trigger device program output:",n),{success:!1,message:o}}}async function z(){if(a.setLive(!1),m.enabledDestinations.length>0){const n=await m.stopRtmpRelay();n.success||E.warning(`Note: ${n.message}`)}E.info("Streaming stopped")}function B(){Ge(0)?E.success("Program window opened"):E.error("Popup blocked - please allow popups for this site")}async function H(){const o=await ye("https://app.itagenten.no/mixer_program/whip");if(!o){E.error("Failed to build scene output URL");return}window.open(o,"vdo-scene-output","width=1280,height=720,menubar=no,toolbar=no")?E.success("Scene output window opened - streaming to MediaMTX"):E.error("Popup blocked - please allow popups for this site")}async function K(){const n=await Xe(0,{room:w.roomName||me});if(!n){E.error("Failed to build scene view URL");return}await navigator.clipboard.writeText(n),E.success('Scene view link copied! Open this URL, then use "Publishing setup" in the mixer to screen-share it to MediaMTX')}function N(){var n;(n=l.value)==null||n.open()}function O(){k.value=!k.value}function g(){if(!S.value.trim()){E.error("Please enter your stream key");return}if(!Q.find(U=>U.id===h.value))return;const o=m.destinations.find(U=>U.platformId===h.value);if(o)m.updateDestination(o.id,{streamKey:S.value,enabled:!0});else{const U=m.addDestination(h.value);m.updateDestination(U.id,{streamKey:S.value,enabled:!0})}m.saveDestinations(),k.value=!1,S.value="",P()}function b(){const n=Q.find(o=>o.id===h.value);return(n==null?void 0:n.streamKeyPlaceholder)||"Enter your stream key"}function j(){const n=Q.find(o=>o.id===h.value);return(n==null?void 0:n.icon)||"ðŸ“¡"}function p(){switch(u.value){case"live":return"control-bar__dot--live";case"connecting":return"control-bar__dot--connecting";case"error":return"control-bar__dot--error";default:return"control-bar__dot--idle"}}function t(){switch(u.value){case"live":return"LIVE";case"connecting":return"Connecting...";case"error":return"Error";default:return"Offline"}}return(n,o)=>(i(),c("div",Ho,[e("div",Ao,[w.roomName?(i(),c("div",Wo,[o[3]||(o[3]=e("span",{class:"control-bar__room-label"},"Room",-1)),e("span",Ko,$(w.roomName),1),w.cameraCount>0?(i(),c("span",No,$(w.cameraCount)+" cam"+$(w.cameraCount!==1?"s":""),1)):D("",!0)])):D("",!0),w.roomName?(i(),c("div",qo)):D("",!0),e("div",zo,[e("span",{class:q(["control-bar__dot",p()])},null,2),e("span",Go,$(t()),1)]),o[12]||(o[12]=e("div",{class:"control-bar__divider"},null,-1)),e("button",{onClick:y,class:q(["control-bar__btn",V.value?"control-bar__btn--stop":"control-bar__btn--start"])},[V.value?(i(),c("svg",Xo,[...o[4]||(o[4]=[e("rect",{x:"6",y:"6",width:"12",height:"12",rx:"1"},null,-1)])])):(i(),c("svg",Yo,[...o[5]||(o[5]=[e("path",{d:"M8 5.14v14l11-7-11-7z"},null,-1)])])),ie(" "+$(V.value?"Stop":"Start Streaming"),1)],2),s.value?D("",!0):(i(),c("button",{key:2,onClick:O,class:q(["control-bar__btn control-bar__btn--dashed",k.value?"control-bar__btn--active":""])},[...o[6]||(o[6]=[e("svg",{class:"control-bar__btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","stroke-width":"1.8"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"})],-1),ie(" Add Stream Key ",-1)])],2)),e("button",{onClick:B,class:"control-bar__btn control-bar__btn--secondary",title:"Open program output in new window"},[...o[7]||(o[7]=[e("svg",{class:"control-bar__btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","stroke-width":"1.8"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})],-1),ie(" Watch ",-1)])]),e("button",{onClick:H,class:"control-bar__btn control-bar__btn--secondary",title:"Open scene output window - pushes mixed scene to MediaMTX for streaming (uses &whipout parameter)"},[...o[8]||(o[8]=[e("svg",{class:"control-bar__btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","stroke-width":"1.8"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})],-1),ie(" Scene Output ",-1)])]),e("button",{onClick:K,class:"control-bar__btn control-bar__btn--secondary control-bar__btn--icon-only",title:"Copy scene view link - open this URL, then use 'Publishing setup' to screen-share it to MediaMTX"},[...o[9]||(o[9]=[e("svg",{class:"control-bar__btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","stroke-width":"1.8"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"})],-1)])]),e("button",{onClick:N,class:"control-bar__btn control-bar__btn--secondary control-bar__btn--icon-only",title:"Configure streaming destinations"},[...o[10]||(o[10]=[e("svg",{class:"control-bar__btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","stroke-width":"1.8"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("circle",{cx:"12",cy:"12",r:"3"})],-1)])]),x.value?(i(),c("div",Qo,[o[11]||(o[11]=e("span",{class:"control-bar__destinations-label"},"To:",-1)),e("div",Zo,[(i(!0),c(te,null,se(X(m).enabledDestinations,U=>(i(),c("span",{key:U.id,class:"control-bar__destination",title:U.name},$(U.platformId==="youtube"?"â–¶ï¸":U.platformId==="twitch"?"ðŸ“º":"ðŸ”´"),9,Jo))),128))])])):D("",!0)]),ne(he,{name:"slide"},{default:ke(()=>[k.value?(i(),c("div",en,[e("div",tn,[e("div",on,[e("span",nn,$(j()),1),oe(e("select",{"onUpdate:modelValue":o[0]||(o[0]=U=>h.value=U),class:"quick-setup__select"},[...o[13]||(o[13]=[e("option",{value:"youtube"},"YouTube",-1),e("option",{value:"twitch"},"Twitch",-1),e("option",{value:"facebook"},"Facebook",-1),e("option",{value:"restream"},"Restream",-1)])],512),[[Oe,h.value]])]),e("div",sn,[oe(e("input",{"onUpdate:modelValue":o[1]||(o[1]=U=>S.value=U),type:"password",placeholder:b(),class:"quick-setup__input",onKeyup:Ae(g,["enter"])},null,40,an),[[de,S.value]])]),e("button",{onClick:g,class:"quick-setup__go-live"}," ðŸ”´ Go Live "),e("button",{onClick:o[2]||(o[2]=U=>k.value=!1),class:"quick-setup__cancel"},"âœ•")])])):D("",!0)]),_:1}),V.value?(i(),c("div",rn,[ne(Fo)])):D("",!0),e("div",ln,[ne(bo,{ref_key:"programOutputRef",ref:R},null,512)]),ne(so,{ref_key:"streamingSettingsRef",ref:l},null,512)]))}}),cn=fe(un,[["__scopeId","data-v-8ba4b853"]]),we="vdo-debug",dn=500,ee=[];let _e=typeof localStorage<"u"&&localStorage.getItem(we)==="true";function Re(f){_e=f,typeof localStorage<"u"&&(f?localStorage.setItem(we,"true"):localStorage.removeItem(we)),console.log(`[VDO.ninja Debug] ${f?"Enabled":"Disabled"}`)}function ce(f){if(ee.push(f),ee.length>dn&&ee.shift(),_e){const w=new Date(f.timestamp).toISOString().split("T")[1].slice(0,-1),a=f.direction==="outgoing"?"âž¡ï¸ OUT":"â¬…ï¸ IN",m=f.direction==="outgoing"?"color: #3b82f6; font-weight: bold":"color: #22c55e; font-weight: bold";console.groupCollapsed(`%c[VDO.ninja ${a}] %c${f.type}`,m,"color: inherit"),console.log("Time:",w),f.target&&console.log("Target:",f.target),console.log("Data:",f.data),f.raw&&f.raw!==f.data&&console.log("Raw:",f.raw),console.groupEnd()}}function Ie(){return[...ee]}function pn(){ee.length=0,console.log("[VDO.ninja Debug] Event history cleared")}function Ee(){const f={total:ee.length,incoming:0,outgoing:0,byType:{},lastActivity:ee.length>0?ee[ee.length-1].timestamp:null};for(const w of ee)w.direction==="incoming"?f.incoming++:f.outgoing++,f.byType[w.type]=(f.byType[w.type]||0)+1;return f}typeof window<"u"&&(window.__VDO_DEBUG__={getHistory:Ie,clearHistory:pn,getStats:Ee,enable:()=>Re(!0),disable:()=>Re(!1),isEnabled:()=>_e});function mn(f){const w=v(!1),a=v(new Map),m=v(0),l=v(null),R=v(!1),k=v("disconnected"),h=v(null),S=je(),V=new Map;function s(d,C,_,G){var T;if(!((T=f.value)!=null&&T.contentWindow)){console.warn("[VDO.ninja] Cannot send command - iframe not ready"),h.value="iframe not ready";return}const F={action:d};C&&(F.target=C),_!==void 0&&(F.value=_),G!==void 0&&(F.value2=G),ce({timestamp:Date.now(),direction:"outgoing",type:d,target:C,data:{action:d,target:C,value:_,value2:G},raw:F});try{f.value.contentWindow.postMessage(F,"*")}catch(I){console.error("[VDO.ninja] Failed to send command:",I),h.value=String(I)}}function x(d,C){var G;if(!((G=f.value)!=null&&G.contentWindow)){console.warn("[VDO.ninja] Cannot send DOM command - iframe not ready");return}const _={action:"",target:d,...C};ce({timestamp:Date.now(),direction:"outgoing",type:"dom-manipulation",target:d,data:C,raw:_});try{f.value.contentWindow.postMessage(_,"*")}catch(F){console.error("[VDO.ninja] Failed to send DOM command:",F)}}function u(d,C=1){var F;const _=V.get(d)||d;if(_!==d&&console.log(`[VDO.ninja] Resolved UUID ${d} to stream ID ${_} for addToScene`),!((F=f.value)!=null&&F.contentWindow)){console.warn("[VDO.ninja] Cannot send addToScene - iframe not ready");return}const G={addToScene:C,target:_};ce({timestamp:Date.now(),direction:"outgoing",type:"addToScene",target:_,data:{sceneNumber:C},raw:G});try{f.value.contentWindow.postMessage(G,"*"),l.value=C}catch(T){console.error("[VDO.ninja] Failed to send addToScene:",T)}}function y(d,C=1){var F;const _=V.get(d)||d;if(!((F=f.value)!=null&&F.contentWindow)){console.warn("[VDO.ninja] Cannot send removeFromScene - iframe not ready");return}const G={removeFromScene:C,target:_};ce({timestamp:Date.now(),direction:"outgoing",type:"removeFromScene",target:_,data:{sceneNumber:C},raw:G});try{f.value.contentWindow.postMessage(G,"*")}catch(T){console.error("[VDO.ninja] Failed to send removeFromScene:",T)}}function P(d){x(d,{replace:!0})}function W(d){x(d,{add:!0})}function z(d){x(d,{remove:!0})}function B(d,C){s("mic",d,!C);const _=a.value.get(d);_&&(_.muted=C)}function H(d){s("mic",d,"toggle");const C=a.value.get(d);C&&(C.muted=!C.muted)}function K(d,C){s("volume",d,Math.max(0,Math.min(200,C)))}function N(d){s("soloChat",d)}function O(d){s("soloChatBidirectional",d)}function g(d,C){s("sendChat",d,C)}function b(d,C){s("sendDirectorChat",d,C)}function j(d){s("hangup",d),a.value.delete(d)}function p(d){d?s("togglescreenshare",d):s("togglescreenshare")}function t(d,C){s("forward",d,C)}function n(d="guests"){s("getGuestList",void 0,void 0)}function o(){s("record",void 0,!0),R.value=!0}function U(){s("record",void 0,!1),R.value=!1}function r(d){s("layout",void 0,d)}function M(d){d?s("reload",d):s("reload")}function A(d,C){s("mixorder",d,C==="up"?-1:1)}function J(d){s("camera",void 0,d)}function ae(d,C){s("camera",d,C)}function ve(d,C=!1){C?s("zoom",void 0,d,"abs"):s("zoom",void 0,d)}function xe(d){s("pan",void 0,d)}function Be(d){s("tilt",void 0,d)}function Se(d){const C=d.origin;if(!C.includes(S.split(":")[0])&&!C.includes("vdo.ninja")&&!C.includes("vdo.itagenten")&&!C.includes("localhost"))return;const _=d.data;if(!_||typeof _!="object")return;const G=_.type||_.action||"unknown",F=_.streamID||_.UUID||_.streamId;switch(ce({timestamp:Date.now(),direction:"incoming",type:G,target:F,data:_.data||_.value,raw:_}),G){case"director-ready":case"mixer-ready":case"loaded":case"ready":case"started":case"director":case"joined-room-complete":case"seeding-started":w.value=!0,k.value="connected",h.value=null,console.log("[VDO.ninja] Ready event received:",G);break;case"stream-id-detected":{const T=_.value||_.data,I=_.UUID;if(T){if(I){V.set(I,T),console.log(`[VDO.ninja] Stream ID mapping: ${I} -> ${T}`);const Z=a.value.get(I);Z&&(a.value.delete(I),Z.id=T,a.value.set(T,Z),m.value++,console.log(`[VDO.ninja] Updated source ID from UUID to stream ID: ${T}`))}if(!a.value.has(T)){const Z={id:T,label:_.label||T,type:"guest",hasVideo:!0,hasAudio:!0,muted:!1,audioLevel:0};a.value.set(T,Z),m.value++,console.log(`[VDO.ninja] Source added via stream-id-detected: ${T}`)}}break}case"new-guest":case"guest-connected":case"push":case"view":case"joined":case"new-push-connection":case"push-connection":case"new-view-connection":case"view-connection":{const T=_.UUID,I=_.streamID,Z=I||T||F;if(Z){T&&I&&V.set(T,I);const Y=_.data,Ce={id:Z,label:(Y==null?void 0:Y.label)||_.label||Z,type:(Y==null?void 0:Y.type)||"guest",hasVideo:(Y==null?void 0:Y.video)!==!1,hasAudio:(Y==null?void 0:Y.audio)!==!1,muted:!1,audioLevel:0};a.value.set(Z,Ce),m.value++,console.log(`[VDO.ninja] Source added: ${Z} (${Ce.label})${T&&!I?" (UUID, awaiting stream ID)":""}`)}break}case"guest-left":case"guest-disconnected":case"left":case"disconnect":F&&(a.value.delete(F),m.value++);break;case"audio-level":case"loudness":{if(F){const T=a.value.get(F);if(T){const I=_.data;T.audioLevel=(I==null?void 0:I.level)||_.value||0}}break}case"mute-state":case"muted":{if(F){const T=a.value.get(F);if(T){const I=_.data;T.muted=(I==null?void 0:I.muted)??_.value??!1}}break}case"scene-changed":case"scene":{const T=_.data,I=(T==null?void 0:T.scene)||_.value;l.value=typeof I=="number"?I:null;break}case"recording-started":R.value=!0;break;case"recording-stopped":R.value=!1;break;case"error":console.error("[VDO.ninja Error]",_.data),h.value=String(_.data);break}}return ge(()=>{k.value="connecting",window.addEventListener("message",Se),setTimeout(()=>{!w.value&&f.value&&(w.value=!0,k.value="connected")},5e3)}),We(()=>{window.removeEventListener("message",Se),k.value="disconnected"}),{isReady:w,sources:a,sourcesVersion:m,activeScene:l,isRecording:R,connectionState:k,lastError:h,addToScene:u,removeFromScene:y,setProgram:P,addSource:W,removeSource:z,setLayout:r,changeMixOrder:A,setMute:B,toggleMute:H,setVolume:K,soloAudio:N,soloChatBidirectional:O,sendToGuest:g,sendDirectorMessage:b,kickGuest:j,toggleScreenShare:p,transferGuest:t,getGuestList:n,refreshSource:M,setCamera:J,setGuestCamera:ae,zoom:ve,pan:xe,tilt:Be,startRecording:o,stopRecording:U,sendCommand:s,sendDomCommand:x,getEventHistory:Ie,getEventStats:Ee}}const gn={class:"flex items-center justify-between p-3 border-b border-preke-border"},vn={key:0,class:"text-sm font-semibold text-preke-text"},fn=["title"],bn={key:0,class:"p-3 space-y-4 max-h-[calc(100vh-200px)] overflow-y-auto"},xn={class:"grid grid-cols-3 gap-2"},hn=["onClick"],kn={class:"flex items-center justify-center gap-2"},wn={key:0,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 24 24"},yn={key:1,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 24 24"},_n={key:0},Sn={class:"space-y-2"},Cn={class:"flex items-center justify-between mb-1"},$n={class:"text-xs text-preke-text"},Pn=["onClick","title"],Mn={key:0,class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Rn={key:1,class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},On=["value","onInput"],Dn={key:1},Tn={class:"space-y-1"},Un=["onClick"],Ln={class:"flex items-center justify-between"},jn={key:1,class:"mt-2"},Vn={key:1,class:"p-2 space-y-2"},In=["title"],En=le({__name:"MixerControlPanel",props:{iframeRef:{}},emits:["close"],setup(f,{emit:w}){const a=f,m=v(null),l=mn(m);ue(()=>{var p;return(p=a.iframeRef)==null?void 0:p.value},p=>{p?(console.log("[MixerControlPanel] Iframe ref available, updating:",p),m.value=p):m.value=null},{immediate:!0}),ge(()=>{var p;(p=a.iframeRef)!=null&&p.value&&(console.log("[MixerControlPanel] On mount, iframe ref:",a.iframeRef.value),m.value=a.iframeRef.value)});const R=L(()=>l.sources.value),k=L(()=>l.isRecording.value),h=l.setLayout,S=l.toggleMute,V=l.setVolume,s=l.startRecording,x=l.stopRecording,{cameras:u}=Je(),y=v(null),P=v(!1),W=v(!1),z=v(null),B=v(!1);function H(p){var n,o,U;if(console.log("[MixerControlPanel] Switching to scene",p,"setLayout:",h,"iframeRef:",(n=a.iframeRef)==null?void 0:n.value,"dummyRef:",m.value,"vdo.isReady:",l.isReady.value),!h){console.warn("[MixerControlPanel] setLayout not available");return}if(l.isReady.value||(console.warn("[MixerControlPanel] VDO.ninja not ready yet (isReady:",l.isReady.value,"connectionState:",l.connectionState.value,")"),console.warn("[MixerControlPanel] Attempting anyway - VDO.ninja might queue the command")),!((U=(o=a.iframeRef)==null?void 0:o.value)!=null&&U.contentWindow)){console.error("[MixerControlPanel] Iframe contentWindow not available!");return}const t=p-1;console.log("[MixerControlPanel] Calling setLayout with layout number",t,"for scene",p),console.log("[MixerControlPanel] Iframe:",a.iframeRef.value,"ContentWindow:",a.iframeRef.value.contentWindow);try{h(t),z.value=p,console.log("[MixerControlPanel] setLayout called successfully")}catch(r){console.error("[MixerControlPanel] Error calling setLayout:",r)}}function K(p){console.log("[MixerControlPanel] Toggling mute for",p,"toggleMute:",S),S?S(p):console.warn("[MixerControlPanel] toggleMute not available")}function N(p,t){V&&V(p,t)}function O(){console.log("[MixerControlPanel] Recording toggle, current:",k.value,"startRecording:",s,"stopRecording:",x),k.value?x?x():console.warn("[MixerControlPanel] stopRecording not available"):s?s():console.warn("[MixerControlPanel] startRecording not available")}function g(p){y.value=p,P.value=!0}function b(){P.value=!1,y.value=null}const j=L(()=>Array.from(R.value.values()));return L(()=>u.value.filter(p=>j.value.some(t=>{var n;return((n=t.label)==null?void 0:n.toLowerCase().includes(p.name.toLowerCase()))||t.id===p.name}))),(p,t)=>(i(),c("div",{class:q(["mixer-control-panel fixed top-4 right-4 z-50 bg-preke-bg-surface border border-preke-border rounded-lg shadow-lg transition-all duration-300",B.value?"w-12":"w-80"])},[e("div",gn,[B.value?D("",!0):(i(),c("h3",vn,"Mixer Controls")),e("button",{onClick:t[0]||(t[0]=n=>B.value=!B.value),class:"p-1 rounded hover:bg-preke-bg-elevated transition-colors",title:B.value?"Expand":"Collapse"},[(i(),c("svg",{class:q(["w-4 h-4 transition-transform",{"rotate-180":B.value}]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[...t[4]||(t[4]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"},null,-1)])],2))],8,fn)]),B.value?(i(),c("div",Vn,[e("button",{onClick:t[3]||(t[3]=n=>H(1)),class:"w-full aspect-square flex items-center justify-center text-xs font-bold rounded bg-preke-bg-elevated hover:bg-preke-bg-elevated/80",title:"Scene 1"}," 1 "),e("button",{onClick:O,class:q(["w-full aspect-square flex items-center justify-center rounded",k.value.value?"bg-red-600 text-white":"bg-preke-bg-elevated hover:bg-preke-bg-elevated/80"]),title:k.value.value?"Stop Recording":"Start Recording"},[...t[16]||(t[16]=[e("svg",{class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 24 24"},[e("circle",{cx:"12",cy:"12",r:"6"})],-1)])],10,In)])):(i(),c("div",bn,[e("div",null,[t[5]||(t[5]=e("label",{class:"text-xs font-medium text-preke-text-dim mb-2 block"},"Scenes",-1)),e("div",xn,[(i(),c(te,null,se(9,n=>e("button",{key:n,onClick:o=>H(n),class:q(["aspect-square flex items-center justify-center text-sm font-bold rounded transition-all",z.value===n?"bg-preke-purple text-white ring-2 ring-preke-purple":"bg-preke-bg-elevated hover:bg-preke-bg-elevated/80 text-preke-text"])},$(n),11,hn)),64))])]),e("div",null,[t[8]||(t[8]=e("label",{class:"text-xs font-medium text-preke-text-dim mb-2 block"},"Recording",-1)),e("button",{onClick:O,class:q(["w-full px-4 py-2 rounded transition-all",k.value.value?"bg-red-600 hover:bg-red-700 text-white":"bg-preke-bg-elevated hover:bg-preke-bg-elevated/80 text-preke-text"])},[e("span",kn,[k.value.value?(i(),c("svg",wn,[...t[6]||(t[6]=[e("circle",{cx:"12",cy:"12",r:"6"},null,-1)])])):(i(),c("svg",yn,[...t[7]||(t[7]=[e("circle",{cx:"12",cy:"12",r:"10"},null,-1)])])),ie(" "+$(k.value.value?"Stop Recording":"Start Recording"),1)])],2)]),j.value.length>0?(i(),c("div",_n,[t[11]||(t[11]=e("label",{class:"text-xs font-medium text-preke-text-dim mb-2 block"},"Sources",-1)),e("div",Sn,[(i(!0),c(te,null,se(j.value,n=>(i(),c("div",{key:n.id,class:"p-2 bg-preke-bg-elevated rounded"},[e("div",Cn,[e("span",$n,$(n.label||n.id),1),e("button",{onClick:o=>K(n.id),class:q(["p-1 rounded hover:bg-preke-bg-surface transition-colors",n.muted?"text-red-400":"text-preke-text-dim"]),title:n.muted?"Unmute":"Mute"},[n.muted?(i(),c("svg",Mn,[...t[9]||(t[9]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"},null,-1),e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"},null,-1)])])):(i(),c("svg",Rn,[...t[10]||(t[10]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"},null,-1)])]))],10,Pn)]),n.hasAudio?(i(),c("input",{key:0,type:"range",value:n.audioLevel||100,onInput:o=>N(n.id,Number(o.target.value)),min:"0",max:"200",class:"w-full h-1 bg-preke-bg-base rounded-lg appearance-none cursor-pointer accent-preke-gold"},null,40,On)):D("",!0)]))),128))])])):D("",!0),X(u).length>0?(i(),c("div",Dn,[t[13]||(t[13]=e("label",{class:"text-xs font-medium text-preke-text-dim mb-2 block"},"Camera Controls",-1)),e("div",Tn,[(i(!0),c(te,null,se(X(u),n=>(i(),c("button",{key:n.name,onClick:o=>g(n.name),class:"w-full px-3 py-2 text-left text-xs bg-preke-bg-elevated hover:bg-preke-bg-elevated/80 rounded transition-colors"},[e("span",Ln,[e("span",null,$(n.name),1),t[12]||(t[12]=e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"})],-1))])],8,Un))),128))])])):D("",!0),e("div",null,[t[15]||(t[15]=e("label",{class:"text-xs font-medium text-preke-text-dim mb-2 block"},"PTZ Controller",-1)),W.value?(i(),c("div",jn,[ne(et,{"camera-name":y.value,onClose:t[2]||(t[2]=n=>W.value=!1)},null,8,["camera-name"])])):(i(),c("button",{key:0,onClick:t[1]||(t[1]=n=>W.value=!0),class:"w-full px-3 py-2 text-left text-xs bg-preke-bg-elevated hover:bg-preke-bg-elevated/80 rounded transition-colors"},[...t[14]||(t[14]=[e("span",{class:"flex items-center justify-between"},[e("span",null,"Open PTZ Controller"),e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"})])],-1)])]))])])),P.value&&y.value?(i(),pe(tt,{key:2,"camera-name":y.value,onClose:b},null,8,["camera-name"])):D("",!0)],2))}}),Bn=fe(En,[["__scopeId","data-v-5be44a96"]]),Fn={class:"camera-push-bar border-t border-preke-bg-surface bg-preke-bg-elevated","data-testid":"camera-push-bar"},Hn={class:"flex items-center gap-2"},An={class:"text-preke-text-dim"},Wn={key:0,class:"px-4 pb-3"},Kn={key:0,class:"flex gap-3 flex-wrap"},Nn={class:"text-sm font-medium"},qn={class:"text-xs text-preke-text-dim"},zn=["onClick"],Gn={key:1,class:"text-sm text-preke-text-dim py-2"},Xn={class:"fixed -left-[9999px] -top-[9999px] w-[10px] h-[10px] overflow-hidden pointer-events-none opacity-0"},Yn=["src","onLoad","onError","title"],Qn=le({__name:"CameraPushBar",setup(f){const w=Ue(),a=v(new Map),m=v(!0),l=L(()=>w.inputs.filter(s=>s.hasSignal));ge(()=>{console.log("[CameraPush] Component mounted"),console.log("[CameraPush] Initial inputs:",w.inputs.length),console.log("[CameraPush] Initial cameras with signal:",l.value.length),console.log("[CameraPush] Inputs loaded:",w.inputsLoaded)}),ue(()=>w.inputsLoaded,s=>{if(s){console.log("[CameraPush] Inputs loaded, checking for cameras with signal");const x=l.value;x.length>0&&console.log(`[CameraPush] Found ${x.length} cameras with signal after inputs loaded`)}}),ue(l,async s=>{console.log(`[CameraPush] Cameras with signal changed: ${s.length}`,s.map(u=>u.id));for(const u of s)if(!a.value.has(u.id))try{console.log(`[CameraPush] Setting up ${u.id} (${u.label})`);const y=await Pe(u.id);if(!y){console.error(`[CameraPush] No WHEP URL for ${u.id}`);continue}console.log(`[CameraPush] WHEP URL for ${u.id}:`,y);const P=await Me(u.id,y,u.label,{useMediamtx:!0});if(!P){console.error(`[CameraPush] Failed to build contribution URL for ${u.id}`);continue}console.log(`[CameraPush] Contribution URL for ${u.id}:`,P),console.log("[CameraPush] Full URL breakdown:",{cameraId:u.id,label:u.label,whepUrl:y,iframeSrc:P.substring(0,300)+"...",room:me,password:Ve.substring(0,4)+"..."}),a.value.set(u.id,{cameraId:u.id,label:u.label,status:"connecting",iframeSrc:P})}catch(y){console.error(`[CameraPush] Error setting up ${u.id}:`,y)}const x=new Set(s.map(u=>u.id));for(const[u]of a.value)x.has(u)||a.value.delete(u)},{immediate:!0});function R(s){const x=a.value.get(s);x&&(x.status="connected",console.log(`[CameraPush] ${s} iframe loaded - URL:`,x.iframeSrc.substring(0,200)+"..."),setTimeout(()=>{var y;const u=document.querySelector(`iframe[title*="${x.label}"]`);if(u)try{(u.contentDocument||((y=u.contentWindow)==null?void 0:y.document))&&console.log(`[CameraPush] ${s} iframe document accessible`)}catch{console.log(`[CameraPush] ${s} iframe loaded (cross-origin, cannot inspect content)`)}},2e3))}function k(s){const x=a.value.get(s);x&&(x.status="error",console.error(`[CameraPush] ${s} iframe failed to load - URL:`,x.iframeSrc.substring(0,200)+"..."))}async function h(s){const x=w.inputs.find(u=>u.id===s);if(!(!x||!x.hasSignal))try{const u=await Pe(s);if(!u){console.error(`[CameraPush] No WHEP URL for ${s}`);return}const y=await Me(s,u,x.label,{useMediamtx:!0});if(!y){console.error(`[CameraPush] Failed to build contribution URL for ${s}`);return}a.value.set(s,{cameraId:s,label:x.label,status:"connecting",iframeSrc:y+`&_t=${Date.now()}`})}catch(u){console.error(`[CameraPush] Error retrying ${s}:`,u)}}function S(s){switch(s){case"connected":return"bg-emerald-500";case"connecting":return"bg-amber-500 animate-pulse";case"error":return"bg-red-500";default:return"bg-gray-500"}}function V(s){switch(s){case"connected":return"Live in VDO.ninja";case"connecting":return"Connecting...";case"error":return"Failed to connect";default:return"Idle"}}return(s,x)=>(i(),c("div",Fn,[e("button",{onClick:x[0]||(x[0]=u=>m.value=!m.value),class:"w-full px-4 py-2 flex items-center justify-between text-sm hover:bg-preke-bg-surface/50 transition-colors","data-testid":"camera-push-toggle","aria-expanded":"expanded"},[e("div",Hn,[x[1]||(x[1]=e("span",{class:"font-medium"},"Camera Sources",-1)),e("span",An,"("+$(l.value.length)+" active)",1)]),(i(),c("svg",{class:q(["w-4 h-4 transition-transform",{"rotate-180":m.value}]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[...x[2]||(x[2]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)])],2))]),m.value?(i(),c("div",Wn,[a.value.size>0?(i(),c("div",Kn,[(i(!0),c(te,null,se(a.value,([u,y])=>(i(),c("div",{key:u,class:"flex items-center gap-2 px-3 py-2 bg-preke-bg-surface rounded-lg"},[e("span",{class:q(["w-2 h-2 rounded-full",S(y.status)])},null,2),e("span",Nn,$(y.label),1),e("span",qn,$(V(y.status)),1),y.status==="error"?(i(),c("button",{key:0,onClick:P=>h(u),class:"ml-2 text-xs text-preke-gold hover:underline"}," Retry ",8,zn)):D("",!0)]))),128))])):(i(),c("div",Gn," No cameras connected. Connect HDMI sources to push them to the mixer. "))])):D("",!0),e("div",Xn,[(i(!0),c(te,null,se(a.value,([u,y])=>(i(),c("iframe",{key:u,src:y.iframeSrc,onLoad:P=>R(u),onError:P=>k(u),allow:"camera; microphone; autoplay; display-capture",class:"w-full h-full border-0",title:`Camera push for ${y.label}`,sandbox:"allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox"},null,40,Yn))),128))])]))}}),Zn={class:"h-full flex flex-col bg-preke-bg"},Jn={key:0,class:"px-4 py-2 bg-preke-bg-elevated border-b border-preke-bg-surface flex items-center justify-between text-xs text-preke-text-dim"},es=["title"],ts={class:"flex-1 relative"},os=["src"],ns={key:0,class:"absolute inset-0 flex items-center justify-center bg-preke-bg"},ss=["title"],as=le({__name:"MixerView",setup(f){const w=ze(),a=Ue(),m=Ke();function l(){w.push("/")}const R=v(!0),k=v(!1),h=v(!1),S=v("Starting mixer..."),V=v(void 0),s=v(void 0),x=v(null),u=v(!0),y=L(()=>Ne.isElectron()),P=v(!0),W=L(()=>y.value&&P.value);function z(){if(typeof window>"u")return;const t=window.localStorage.getItem("preke_mixer_use_local_bridge");t!==null?P.value=t==="true":P.value=!0,console.log("[Mixer] Local bridge preference:",P.value)}async function B(){P.value=!P.value,typeof window<"u"&&window.localStorage.setItem("preke_mixer_use_local_bridge",String(P.value)),k.value=!1,await N()}const H=L(()=>a.inputs.filter(t=>t.hasSignal)),K=v("");async function N(){const t=!(y.value&&P.value),n=t?await Ye():null,o=await Qe({mediamtxHost:n||void 0,room:me,useMediamtx:t});if(o)K.value=o,console.log("[Mixer] Mixer URL initialized with API key");else{const U=await je()||"app.itagenten.no",r=Ze(),M=new URL(`${r}://${U}/mixer.html`);M.searchParams.set("room",me),M.searchParams.set("password",Ve),M.searchParams.set("css",`${r}://${U}/css/preke-colors.css`),K.value=M.toString(),console.warn("[Mixer] Using fallback URL without API key")}}function O(){console.log("[Mixer] VDO.ninja mixer iframe loaded"),k.value=!0,S.value="Waiting for cameras..."}function g(){R.value=!1}async function b(){const t=performance.now();S.value="Starting camera bridge...";for(let n=0;n<40;n++){try{if((await(await fetch(await re("/api/mode/status"))).json()).current_mode==="mixer"){const r=Math.round((performance.now()-t)/1e3);if(r>=5){console.log(`[Mixer] Bridge likely ready after ${r}s`),h.value=!0,S.value="Cameras connecting...";return}}}catch{}await new Promise(o=>setTimeout(o,500)),S.value=`Starting camera bridge... (${Math.round((performance.now()-t)/1e3)}s)`}console.log("[Mixer] Bridge wait timeout - continuing anyway"),h.value=!0}async function j(){var n;if(!$e())return;S.value="Checking mode...",await m.fetchCapabilities();const t=(n=m.capabilities)==null?void 0:n.current_mode;if(t&&t!=="mixer"){console.log("[Mixer] Not in mixer mode, switching..."),S.value="Switching to mixer mode...";try{(await fetch(await re("/api/mode/mixer"),{method:"POST"})).ok&&(await m.fetchCapabilities(),E.success("Switched to Mixer mode"))}catch(o){console.warn("[Mixer] Failed to switch mode:",o)}}}async function p(){if(!$e()){S.value="No device configured";return}S.value="Finding best connection...";const t=await ot(n=>{S.value=n});s.value=t.method.toUpperCase()}return ge(async()=>{const t=performance.now();y.value&&(z(),console.log("[Mixer] Electron app detected, useLocalBridge:",P.value,"showCameraPushBar:",W.value));const n=p();await Promise.all([n,j(),a.fetchInputs(),N()]),await b(),console.log(`[Mixer] Total load time: ${Math.round(performance.now()-t)}ms`)}),(t,n)=>(i(),c(te,null,[ne(he,{name:"fade"},{default:ke(()=>[R.value?(i(),pe(nt,{key:0,mode:"mixer","content-ready":k.value&&h.value,"min-time":2e3,"max-time":2e4,"show-cancel":!0,"status-text":S.value,progress:V.value,"connection-method":s.value,onReady:g,onCancel:l},null,8,["content-ready","status-text","progress","connection-method"])):D("",!0)]),_:1}),ne(he,{name:"content-fade"},{default:ke(()=>[oe(e("div",Zn,[ne(cn,{"room-name":X(me),"camera-count":H.value.length},null,8,["room-name","camera-count"]),y.value?(i(),c("div",Jn,[e("span",null,"Camera sources: "+$(P.value?"Local bridge":"External bridge"),1),e("button",{class:"text-preke-gold hover:underline",onClick:B,title:P.value?"Disable local bridge to use external fallback":"Enable local bridge for Electron"},$(P.value?"Use fallback":"Use local bridge"),9,es)])):D("",!0),e("div",ts,[e("iframe",{ref_key:"iframeRef",ref:x,src:K.value,onLoad:O,class:"absolute inset-0 w-full h-full border-0",allow:"camera; microphone; autoplay; display-capture",allowfullscreen:""},null,40,os),k.value?D("",!0):(i(),c("div",ns,[...n[1]||(n[1]=[e("div",{class:"flex flex-col items-center gap-4"},[e("div",{class:"w-8 h-8 border-2 border-preke-gold border-t-transparent rounded-full animate-spin"}),e("span",{class:"text-preke-text-muted"},"Loading VDO.ninja mixer..."),e("span",{class:"text-xs text-preke-text-subtle"},"Cameras will appear when bridge is running")],-1)])])),k.value?(i(),c("button",{key:1,onClick:n[0]||(n[0]=o=>u.value=!u.value),class:"absolute top-4 left-4 z-40 p-2 bg-preke-bg-surface border border-preke-border rounded-lg shadow-lg hover:bg-preke-bg-elevated transition-colors",title:u.value?"Hide Controls":"Show Controls"},[...n[2]||(n[2]=[e("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"})],-1)])],8,ss)):D("",!0),u.value&&k.value?(i(),pe(Bn,{"iframe-ref":x.value,key:k.value?"ready":"loading"},null,8,["iframe-ref"])):D("",!0)]),W.value?(i(),pe(Qn,{key:1})):D("",!0)],512),[[qe,!R.value]])]),_:1})],64))}}),cs=fe(as,[["__scopeId","data-v-475510f8"]]);export{cs as default};
