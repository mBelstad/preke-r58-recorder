import{C as N,D,o as O,l as Z,E as Ae,r as x,j as k,G as Le,d as H,H as ce,m as L,T as Q,p as X,c as _,e as C,x as Be,a as t,w as he,y as De,t as $,I as We,i as y,B as ue,J as Ne,h as F,F as U,n as R,q as z,K as be,L as S,M as J,N as ye,u as de,f as He,s as we,z as Fe,g as Ie,O as Ue,b as Ve,v as Ge}from"./index-BKUAO3ok.js";import{M as je}from"./ModeLoadingScreen-CbOL5xOn.js";const G=x(!1),K=x(!1);let j=null;function ze(){const n=N();D(()=>n.status,d=>{G.value=d==="recording"},{immediate:!0});function e(d){if(G.value)return d.preventDefault(),d.returnValue="Recording in progress. Are you sure you want to leave?",d.returnValue}O(()=>{window.addEventListener("beforeunload",e)}),Z(()=>{window.removeEventListener("beforeunload",e)}),Ae((d,u,a)=>{G.value?(j=()=>a(),K.value=!0,a(!1)):a()});function o(){K.value=!1,G.value=!1,n.stopRecording().finally(()=>{j&&(j(),j=null)})}function h(){K.value=!1,j=null}return{isGuardActive:G,showLeaveConfirmation:K,confirmLeave:o,cancelLeave:h}}const T=x(null),ne=x(!1),pe=x(null),oe=x(null),Oe=10,se=2,qe=25;function Ke(){const n=k(()=>T.value?T.value.available_gb<se?"critical":T.value.available_gb<Oe?"warning":"ok":"unknown"),e=k(()=>T.value?T.value.available_gb>=se:!0),o=k(()=>{if(!T.value)return null;const s=T.value.available_gb*1024*1024*1024,r=qe*1024*1024,m=s/r,f=Math.floor(m/3600),g=Math.floor(m%3600/60);return f>24?`${Math.floor(f/24)}d ${f%24}h`:f>0?`${f}h ${g}m`:`${g}m`}),h=k(()=>{switch(n.value){case"ok":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}}),d=k(()=>T.value?n.value==="critical"?`Disk space critically low (${T.value.available_gb.toFixed(1)} GB). Cannot start recording.`:n.value==="warning"?`Low disk space (${T.value.available_gb.toFixed(1)} GB). Estimated recording time: ${o.value}`:null:null);async function u(){ne.value=!0,oe.value=null;try{const s=await Le.getDegradation();if(s.resources&&s.resources.disk_free_gb!==void 0){const r=s.resources.disk_free_gb,m=r*3;T.value={available_gb:r,total_gb:m,used_percent:100-r/m*100,recording_path:"/opt/r58-app/shared/recordings"}}return pe.value=new Date,T.value}catch(s){return oe.value=s.message||"Failed to check disk space",console.error("Failed to check disk space:",s),null}finally{ne.value=!1}}async function a(){return await u(),T.value?n.value==="critical"?{ok:!1,message:`Insufficient disk space (${T.value.available_gb.toFixed(1)} GB). Need at least ${se} GB to start recording.`}:n.value==="warning"?{ok:!0,message:`Low disk space warning: ${T.value.available_gb.toFixed(1)} GB available. Estimated recording time: ${o.value}`}:{ok:!0}:{ok:!0,message:"Could not verify disk space. Proceeding with caution."}}return{diskSpace:T,isLoading:ne,lastCheck:pe,error:oe,status:n,statusColor:h,canStartRecording:e,estimatedRecordingTime:o,warningMessage:d,checkDiskSpace:u,preflightCheck:a}}const B=x(localStorage.getItem("r58_audio_feedback")!=="false");let ae=null;function Ye(){return ae||(ae=new(window.AudioContext||window.webkitAudioContext)),ae}function P(n,e,o="sine",h=.3){if(B.value)try{const d=Ye();d.state==="suspended"&&d.resume();const u=d.createOscillator(),a=d.createGain();u.connect(a),a.connect(d.destination),u.type=o,u.frequency.value=n;const s=d.currentTime;a.gain.setValueAtTime(0,s),a.gain.linearRampToValueAtTime(h,s+.01),a.gain.linearRampToValueAtTime(0,s+e),u.start(s),u.stop(s+e)}catch(d){console.warn("Audio feedback failed:",d)}}function Qe(){B.value&&(P(440,.1,"sine",.2),setTimeout(()=>P(554,.1,"sine",.2),100),setTimeout(()=>P(659,.15,"sine",.25),200))}function Xe(){B.value&&(P(880,.08,"sine",.3),setTimeout(()=>P(880,.15,"sine",.3),120))}function Je(){B.value&&(P(659,.1,"sine",.25),setTimeout(()=>P(554,.1,"sine",.2),100),setTimeout(()=>P(440,.15,"sine",.2),200))}function Ze(){B.value&&(P(200,.15,"square",.15),setTimeout(()=>P(180,.2,"square",.15),180))}function et(){B.value&&(P(1e3,.08,"sine",.2),setTimeout(()=>P(1e3,.08,"sine",.2),150))}function me(){B.value&&P(1200,.03,"sine",.1)}function tt(n=50){if(B.value&&"vibrate"in navigator)try{navigator.vibrate(n)}catch{}}function _e(){function n(o){B.value=o,localStorage.setItem("r58_audio_feedback",String(o))}function e(){n(!B.value),B.value&&me()}return{enabled:B,setEnabled:n,toggle:e,playSuccess:Qe,playError:Ze,playWarning:et,playClick:me,playRecordStart:Xe,playRecordStop:Je,vibrate:tt}}const nt={class:"bg-r58-bg-secondary rounded-lg shadow-xl max-w-md w-full p-6"},ot=["placeholder"],st={class:"text-xs text-r58-text-secondary mt-2"},at=H({__name:"SessionNameDialog",props:{open:{type:Boolean},suggestedName:{}},emits:["confirm","cancel","skip"],setup(n,{emit:e}){const o=n,h=e,d=x(""),u=x(null),a=k(()=>{const l=new Date,i=l.toLocaleDateString("en-CA"),p=l.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}).replace(":","");return`Recording_${i}_${p}`}),s=k(()=>o.suggestedName||a.value);D(()=>o.open,l=>{l&&(d.value=s.value,setTimeout(()=>{var i,p;(i=u.value)==null||i.focus(),(p=u.value)==null||p.select()},100))});function r(){h("confirm",d.value.trim()||s.value)}function m(){h("skip")}function f(){h("cancel")}function g(l){l.key==="Enter"?r():l.key==="Escape"&&f()}return(l,i)=>(y(),ce(We,{to:"body"},[L(Q,{name:"fade"},{default:X(()=>[n.open?(y(),_("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:Be(f,["self"]),onKeydown:g},[t("div",nt,[i[1]||(i[1]=t("h2",{class:"text-lg font-semibold mb-2"},"Name This Recording",-1)),i[2]||(i[2]=t("p",{class:"text-r58-text-secondary text-sm mb-4"}," Give your recording a name to find it easily later (optional). ",-1)),he(t("input",{ref_key:"inputRef",ref:u,"onUpdate:modelValue":i[0]||(i[0]=p=>d.value=p),type:"text",placeholder:s.value,class:"w-full px-4 py-2 bg-r58-bg-tertiary border border-r58-bg-tertiary rounded-lg text-r58-text-primary placeholder-r58-text-secondary focus:outline-none focus:ring-2 focus:ring-r58-accent-primary"},null,8,ot),[[De,d.value]]),t("p",st," Suggested: "+$(s.value),1),t("div",{class:"flex justify-between mt-6"},[t("button",{onClick:m,class:"text-sm text-r58-text-secondary hover:text-r58-text-primary transition-colors"}," Skip (use default) "),t("div",{class:"flex gap-3"},[t("button",{onClick:f,class:"btn"}," Cancel "),t("button",{onClick:r,class:"btn btn-primary"}," Start Recording ")])])])],32)):C("",!0)]),_:1})]))}}),rt=ue(at,[["__scopeId","data-v-df8c0a50"]]),it={class:"flex items-center gap-4"},lt={key:0,class:"font-mono text-xl text-r58-accent-danger"},ct=["disabled","title"],ut={key:0,class:"animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"},dt={key:0,class:"w-3 h-3 bg-white rounded-sm"},ft={key:1,class:"w-3 h-3 bg-white rounded-full"},gt={class:"text-xs text-r58-text-secondary hidden md:inline"},vt=H({__name:"RecorderControls",setup(n){const e=N(),{register:o}=Ne(),{preflightCheck:h,status:d,canStartRecording:u}=Ke(),{playRecordStart:a,playRecordStop:s,playError:r,playWarning:m,vibrate:f}=_e(),g=x(null),l=x(!1),i=x(!1),p=x(!1),c=x(!1),w=x(void 0),v=k(()=>e.status==="recording"),b=k(()=>e.status==="starting"),A=k(()=>e.status==="stopping"),ee=k(()=>e.formattedDuration),ke=k(()=>b.value||A.value||i.value),$e=k(()=>b.value?"Starting recording...":A.value?"Stopping recording...":i.value?"Checking disk space...":!v.value&&!u.value?"Insufficient disk space":"");let te=null;O(()=>{te=o({key:" ",description:"Toggle Recording",action:Re,context:"recorder",enabled:()=>!b.value&&!A.value})}),Z(()=>{te&&te()});async function Re(){v.value?ve():await q()}async function q(M){i.value=!0;try{const E=await h();if(!E.ok){r(),f(200),F.error("Cannot start recording",E.message||"Preflight check failed");return}if(E.message&&d.value==="warning"&&(m(),F.warning("Low disk space",E.message)),c.value&&!M){w.value=void 0,p.value=!0;return}await ge(M||w.value)}finally{i.value=!1}}async function ge(M){try{await e.startRecording(M);const E=M||e.sessionId;a(),f([50,30,50]),F.success("Recording started",`Session: ${E}`)}catch(E){r(),f(200),F.error("Failed to start recording",E.message||"Unknown error",{label:"Retry",onClick:()=>q(M)})}}function Se(M){p.value=!1,w.value=M,q(M)}function Ce(){p.value=!1,w.value=void 0,q()}function Te(){p.value=!1,i.value=!1}async function Me(){try{await e.stopRecording(),s(),f(100),F.success("Recording stopped",`Duration: ${ee.value}`)}catch(M){r(),f(200),F.error("Failed to stop recording",M.message||"Unknown error")}}function ve(){var M;l.value=!1,(M=g.value)==null||M.open(),setTimeout(()=>{l.value=!0},500)}function Ee(){l.value&&Me()}async function Pe(){v.value?ve():await ge()}return(M,E)=>(y(),_(U,null,[t("div",it,[v.value?(y(),_("div",lt,$(ee.value),1)):C("",!0),t("button",{onClick:Pe,disabled:ke.value,class:R(["flex items-center gap-2 px-6 py-2 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed",[v.value?"bg-r58-accent-danger hover:bg-red-600 text-white":"bg-r58-accent-success hover:bg-green-600 text-white"]]),title:$e.value||(v.value?"Stop Recording (Space)":"Start Recording (Space)")},[b.value||A.value||i.value?(y(),_("span",ut)):(y(),_(U,{key:1},[v.value?(y(),_("span",dt)):(y(),_("span",ft))],64)),t("span",null,$(i.value?"Checking...":v.value?"Stop":"Start Recording"),1)],10,ct),t("span",gt,[E[0]||(E[0]=z(" Press ",-1)),E[1]||(E[1]=t("kbd",{class:"px-1 py-0.5 bg-r58-bg-tertiary rounded text-xs font-mono"},"Space",-1)),z(" to "+$(v.value?"stop":"start"),1)])]),L(be,{ref_key:"stopConfirmDialog",ref:g,title:"Stop Recording?",message:`You have been recording for ${ee.value}. This will finalize all files.`,"confirm-text":"Stop Recording","cancel-text":"Keep Recording",danger:!0,onConfirm:Ee},null,8,["message"]),L(rt,{open:p.value,onConfirm:Se,onSkip:Ce,onCancel:Te},null,8,["open"])],64))}}),Y=x(localStorage.getItem("r58_performance_mode")==="true"),re=x(localStorage.getItem("r58_performance_mode_auto")!=="false"),pt=3,mt=100,ht=500;function xe(){const n=N(),e=k(()=>Y.value?!0:re.value&&n.isRecording?n.inputs.filter(g=>g.isRecording).length>=pt:!1),o=k(()=>e.value?ht:mt);D(e,f=>{f?document.body.classList.add("performance-mode"):document.body.classList.remove("performance-mode")},{immediate:!0});function h(f){Y.value=f,localStorage.setItem("r58_performance_mode",String(f))}function d(f){re.value=f,localStorage.setItem("r58_performance_mode_auto",String(f))}function u(){h(!Y.value)}function a(f,g){let l=0,i=null;return(...p)=>{const c=Date.now(),w=g??o.value,v=c-l;v>=w?(l=c,f(...p)):i||(i=window.setTimeout(()=>{l=Date.now(),i=null,f(...p)},w-v))}}function s(f,g){let l=null;return(...i)=>{l&&clearTimeout(l),l=window.setTimeout(()=>{f(...i),l=null},g??o.value)}}function r(f){return e.value?window.setTimeout(()=>f(performance.now()),o.value):requestAnimationFrame(f)}function m(f){e.value?clearTimeout(f):cancelAnimationFrame(f)}return{enabled:Y,autoEnable:re,isActive:e,updateInterval:o,setEnabled:h,setAutoEnable:d,toggle:u,throttle:a,debounce:s,requestFrame:r,cancelFrame:m}}const bt=["title"],yt={class:"flex items-center gap-1.5 text-sm"},wt={key:0,class:"flex items-center gap-1.5 text-sm"},_t={key:1,class:"flex items-center gap-1.5 text-sm text-red-400"},xt={class:"font-mono"},kt=H({__name:"RecordingHealth",setup(n,{expose:e}){const o=N(),{isActive:h}=xe(),d=x({}),u=x(0),a=x(0),s=x(0);let r=null;function m(){const p={};let c=0;o.inputs.forEach(v=>{p[v.id]=v.bytesWritten;const b=d.value[v.id]||0;c+=v.bytesWritten-b});const w=h.value?2:1;u.value=Math.round(c/(1024*1024)/w*10)/10,d.value=p}D(()=>o.isRecording,p=>{if(p){d.value={},u.value=0,a.value=0,s.value=0;const c=h.value?2e3:1e3;r=window.setInterval(m,c)}else r&&(clearInterval(r),r=null)},{immediate:!0}),D(h,p=>{if(o.isRecording&&r){clearInterval(r);const c=p?2e3:1e3;r=window.setInterval(m,c)}}),Z(()=>{r&&clearInterval(r)});const f=k(()=>o.isRecording?s.value>0||a.value>90?"critical":u.value<1||a.value>70?"warning":"healthy":"idle"),g=k(()=>{switch(f.value){case"healthy":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}});k(()=>{switch(f.value){case"healthy":return"Healthy";case"warning":return"Warning";case"critical":return"Critical";default:return"Idle"}});const l=k(()=>{if(!o.isRecording)return"Not recording";const p=[`Write speed: ${u.value} MB/s`,`Buffer: ${a.value}%`];return s.value>0&&p.push(`Frames dropped: ${s.value}`),p.join(`
`)});function i(p){p.buffer_percent!==void 0&&(a.value=p.buffer_percent),p.frames_dropped!==void 0&&(s.value=p.frames_dropped)}return e({updateFromMetrics:i}),(p,c)=>S(o).isRecording?(y(),_("div",{key:0,class:R(["flex items-center gap-3 px-3 py-1.5 rounded-lg transition-colors cursor-help",{"bg-emerald-500/10":g.value==="emerald","bg-amber-500/10":g.value==="amber","bg-red-500/10":g.value==="red"}]),title:l.value},[t("span",{class:R(["w-2 h-2 rounded-full",g.value==="emerald"?"bg-emerald-500":"",g.value==="amber"?"bg-amber-500 animate-pulse":"",g.value==="red"?"bg-red-500 animate-pulse":""])},null,2),t("div",yt,[c[0]||(c[0]=t("svg",{class:"w-3.5 h-3.5 text-r58-text-secondary",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})],-1)),t("span",{class:R(["font-mono",g.value==="emerald"?"text-emerald-400":"",g.value==="amber"?"text-amber-400":"",g.value==="red"?"text-red-400":""])},$(u.value)+" MB/s ",3)]),a.value>0?(y(),_("div",wt,[c[1]||(c[1]=t("span",{class:"text-r58-text-secondary"},"Buf:",-1)),t("span",{class:R(["font-mono",a.value<50?"text-emerald-400":"",a.value>=50&&a.value<80?"text-amber-400":"",a.value>=80?"text-red-400":""])},$(a.value)+"% ",3)])):C("",!0),s.value>0?(y(),_("div",_t,[c[2]||(c[2]=t("svg",{class:"w-3.5 h-3.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),t("span",xt,$(s.value)+" dropped",1)])):C("",!0)],10,bt)):C("",!0)}}),$t=["65.109.32.111"],Rt=5,St=1e3,Ct=3e4,W=new Map,V=new Map;function Tt(n){const e=J(),o=ye();if(e&&!o)try{return`http://${new URL(e).hostname}:8889/${n}/whep`}catch{console.warn("[WHEP Manager] Invalid device URL, falling back to FRP")}return`https://r58-mediamtx.itagenten.no/${n}/whep`}async function Mt(n,e){const o=W.get(e);if(!o)return"unknown";try{const u=new URL(o.whepUrl).hostname;if(u.includes("itagenten.no"))return console.log(`[WHEP Manager ${e}] Detected relay (FRP URL)`),"relay";if(u.startsWith("100."))return console.log(`[WHEP Manager ${e}] Detected P2P (Tailscale IP: ${u})`),"p2p";if(u.startsWith("192.168.")||u.startsWith("10.")||u.startsWith("172."))return console.log(`[WHEP Manager ${e}] Detected P2P (LAN IP: ${u})`),"p2p"}catch(d){console.warn(`[WHEP Manager ${e}] Failed to parse WHEP URL:`,d)}try{const d=await n.getStats();for(const u of d.values())if(u.type==="candidate-pair"&&u.state==="succeeded"){const a=d.get(u.remoteCandidateId);if((a==null?void 0:a.candidateType)==="relay")return console.log(`[WHEP Manager ${e}] Detected relay (TURN candidate)`),"relay";const s=a==null?void 0:a.address;if(s&&$t.includes(s))return console.log(`[WHEP Manager ${e}] Detected relay (VPS IP: ${s})`),"relay"}}catch(d){console.warn(`[WHEP Manager ${e}] Failed to get WebRTC stats:`,d)}return J()&&!ye()?(console.log(`[WHEP Manager ${e}] Assuming P2P (direct device URL configured)`),"p2p"):"unknown"}function I(n){const e=W.get(n);if(!e)return;const o=V.get(n);o&&o.forEach(h=>h(e))}function ie(n){const e=W.get(n);if(!e)return;if(e.reconnectAttempts>=Rt){console.error(`[WHEP Manager ${n}] Max reconnect attempts reached`),e.state="failed",I(n);return}e.reconnectAttempts++;const o=Math.min(St*Math.pow(2,e.reconnectAttempts-1),Ct);console.log(`[WHEP Manager ${n}] Scheduling reconnect #${e.reconnectAttempts} in ${o}ms`),e.state="connecting",I(n),e.reconnectTimeout&&clearTimeout(e.reconnectTimeout),e.reconnectTimeout=setTimeout(()=>{fe(n)},o)}async function fe(n){let e=W.get(n);if(e&&(e.state==="connected"||e.state==="connecting"))return console.log(`[WHEP Manager ${n}] Reusing existing connection (state: ${e.state})`),e;let o=J(),h=0;for(;!o&&h<5;)console.log(`[WHEP Manager ${n}] No device URL yet, waiting... (attempt ${h+1})`),await new Promise(s=>setTimeout(s,100)),o=J(),h++;const d=performance.now(),u=Tt(n);console.log(`[WHEP Manager ${n}] Creating connection to: ${u}`),console.log(`[WHEP Manager ${n}] Device URL was: ${o}`),e!=null&&e.peerConnection&&e.peerConnection.close();const a=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}]});e?(e.peerConnection=a,e.state="connecting",e.whepUrl=u,e.mediaStream=null,e.connectionType="unknown",e.connectionStartTime=d):(e={cameraId:n,peerConnection:a,mediaStream:null,state:"connecting",connectionType:"unknown",refCount:0,whepUrl:u,lastConnectedAt:null,reconnectAttempts:(e==null?void 0:e.reconnectAttempts)||0,reconnectTimeout:null,connectionStartTime:d},W.set(n,e)),a.ontrack=s=>{s.streams[0]&&(e.mediaStream=s.streams[0],console.log(`[WHEP Manager ${n}] Received media stream`),I(n))},a.oniceconnectionstatechange=async()=>{const s=a.iceConnectionState;if(console.log(`[WHEP Manager ${n}] ICE state: ${s}`),s==="connected"||s==="completed"){e.state="connected",e.lastConnectedAt=Date.now(),e.reconnectAttempts=0,e.connectionType=await Mt(a,n);const r=e.connectionStartTime?Math.round(performance.now()-e.connectionStartTime):0;console.log(`[WHEP Manager ${n}] Connected (${e.connectionType}) in ${r}ms`),I(n)}else s==="failed"?(e.state="failed",e.connectionType="unknown",I(n),e.refCount>0&&ie(n)):s==="disconnected"&&setTimeout(()=>{(a.iceConnectionState==="disconnected"||a.iceConnectionState==="failed")&&(e.state="disconnected",I(n),e.refCount>0&&ie(n))},3e3)},a.addTransceiver("video",{direction:"recvonly"}),a.addTransceiver("audio",{direction:"recvonly"});try{const s=await a.createOffer();await a.setLocalDescription(s);const r=await fetch(u,{method:"POST",headers:{"Content-Type":"application/sdp"},body:s.sdp});if(!r.ok)throw new Error(`WHEP request failed: ${r.status}`);const m=await r.text();await a.setRemoteDescription({type:"answer",sdp:m})}catch(s){console.error(`[WHEP Manager ${n}] Connection error:`,s),e.state="failed",I(n),e.refCount>0&&ie(n)}return e}async function Et(n,e){V.has(n)||V.set(n,new Set),V.get(n).add(e);let o=W.get(n);return(!o||o.state==="failed"||o.state==="disconnected")&&(o=await fe(n)),o.refCount++,console.log(`[WHEP Manager ${n}] Acquired connection (refCount: ${o.refCount})`),e(o),o}function Pt(n,e){const o=W.get(n);if(!o)return;const h=V.get(n);h&&(h.delete(e),h.size===0&&V.delete(n)),o.refCount=Math.max(0,o.refCount-1),console.log(`[WHEP Manager ${n}] Released connection (refCount: ${o.refCount})`),o.refCount===0&&(console.log(`[WHEP Manager ${n}] Closing unused connection`),o.reconnectTimeout&&clearTimeout(o.reconnectTimeout),o.peerConnection.close(),W.delete(n))}function le(n){const e=W.get(n);e&&(console.log(`[WHEP Manager ${n}] Force reconnecting...`),e.reconnectAttempts=0,fe(n))}const At={class:"relative w-full h-full bg-black"},Lt=["title"],Bt={key:1,class:"absolute inset-0 flex items-center justify-center bg-black/50"},Dt={key:2,class:"absolute inset-0 flex items-center justify-center bg-black/70"},Wt={class:"text-center"},Nt={class:"text-xs text-amber-400"},Ht={key:3,class:"absolute inset-0 flex items-center justify-center bg-black/80"},Ft={class:"text-center text-r58-text-secondary"},It={class:"text-sm"},Ut=H({__name:"InputPreview",props:{inputId:{},protocol:{}},emits:["videoReady"],setup(n,{emit:e}){const o=n,h=e,d=N();let u=!1;const a=k(()=>d.status==="recording"),s=x(null),r=x(!0),m=x(null),f=x("unknown"),g=x(!1),l=x(0);let i=null;function p(b){switch(console.log(`[InputPreview ${o.inputId}] Connection update:`,{state:b.state,type:b.connectionType,hasStream:!!b.mediaStream}),f.value=b.connectionType,l.value=b.reconnectAttempts,b.state){case"connecting":r.value=!0,m.value=null,g.value=b.reconnectAttempts>0;break;case"connected":r.value=!1,m.value=null,g.value=!1,b.mediaStream&&s.value&&s.value.srcObject!==b.mediaStream&&(s.value.srcObject=b.mediaStream,u||(s.value.onloadeddata=()=>{u||(u=!0,console.log(`[InputPreview ${o.inputId}] Video ready (first frame displayed)`),h("videoReady"))}));break;case"disconnected":g.value=!0,m.value=`Reconnecting... (${b.reconnectAttempts}/5)`;break;case"failed":r.value=!1,g.value=!1,m.value="Connection failed after multiple attempts";break}}async function c(){if(s.value){v(),r.value=!0,m.value=null,i=p;try{await Et(o.inputId,i)}catch(b){console.error(`[InputPreview ${o.inputId}] Failed to acquire connection:`,b),m.value=b instanceof Error?b.message:"Failed to connect",r.value=!1}}}function w(){le(o.inputId)}function v(){i&&(Pt(o.inputId,i),i=null)}return O(()=>{c()}),D(()=>o.inputId,()=>{c()}),D(a,(b,A)=>{A&&!b&&m.value?(console.log("[InputPreview] Recording stopped, reconnecting preview..."),le(o.inputId)):!A&&b&&(console.log("[InputPreview] Recording started, will try to reconnect preview after delay..."),setTimeout(()=>{a.value&&(console.log("[InputPreview] Attempting to reconnect preview during recording..."),le(o.inputId))},2e3))}),Z(()=>{v()}),(b,A)=>(y(),_("div",At,[t("video",{ref_key:"videoRef",ref:s,autoplay:"",muted:"",playsinline:"",class:"w-full h-full object-contain"},null,512),!r.value&&!m.value&&f.value!=="unknown"?(y(),_("div",{key:0,class:R(["absolute top-1 right-1 px-1.5 py-0.5 text-[10px] font-medium rounded",f.value==="p2p"?"bg-emerald-500/80 text-white":"bg-amber-500/80 text-white"]),title:f.value==="p2p"?"Direct P2P connection":"Relay connection (FRP)"},$(f.value==="p2p"?"P2P":"RELAY"),11,Lt)):C("",!0),r.value&&!g.value?(y(),_("div",Bt,[...A[0]||(A[0]=[t("div",{class:"animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"},null,-1)])])):C("",!0),g.value?(y(),_("div",Dt,[t("div",Wt,[A[1]||(A[1]=t("div",{class:"animate-spin w-5 h-5 border-2 border-amber-400 border-t-transparent rounded-full mx-auto mb-2"},null,-1)),t("p",Nt,$(m.value||"Reconnecting..."),1)])])):m.value&&!r.value?(y(),_("div",Ht,[t("div",Ft,[t("p",It,$(m.value),1),t("button",{onClick:w,class:"mt-2 text-xs text-r58-accent-primary hover:underline"}," Retry ")])])):C("",!0)]))}}),Vt={key:0,class:"h-full flex items-center justify-center"},Gt={key:1,class:"h-full flex flex-col gap-2"},jt={key:0,class:"flex items-center gap-2 px-3 py-1.5 bg-amber-500/10 border border-amber-500/30 rounded-lg text-amber-400 text-sm"},zt=["title"],Ot={key:1,class:"w-full h-full flex items-center justify-center bg-r58-bg-tertiary"},qt={class:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-4"},Kt={class:"flex items-center justify-between"},Yt={class:"flex items-center gap-2"},Qt={class:"font-medium"},Xt={key:0,class:"flex items-center gap-2 text-sm"},Jt={class:"text-r58-text-secondary"},Zt={key:0,class:"mt-2 flex items-center justify-between"},en={class:"text-sm font-mono text-r58-text-secondary"},tn=H({__name:"InputGrid",emits:["allVideosReady"],setup(n,{emit:e}){const o=N(),h=de(),d=e,u=x(new Set);function a(c){u.value.add(c),console.log(`[InputGrid] Video ready: ${c} (${u.value.size}/${r.value.length})`),u.value.size>=r.value.length&&(console.log("[InputGrid] All videos ready!"),d("allVideosReady"))}D(()=>r.value.length,()=>{u.value.clear()});const s=k(()=>{var c;return((c=h.capabilities)==null?void 0:c.current_mode)==="recorder"}),r=k(()=>o.inputs.filter(c=>c.hasSignal)),m=k(()=>o.framerateMismatch);function f(c){return c.isRecording?"border-r58-accent-danger ring-2 ring-r58-accent-danger/20":c.hasSignal?"border-emerald-500/50 hover:border-emerald-500":"border-r58-bg-tertiary/50 opacity-60"}function g(c){return c.hasSignal?c.framerate>=29?"excellent":c.framerate>=24?"good":"unstable":"none"}function l(c){switch(g(c)){case"excellent":return"text-emerald-400";case"good":return"text-emerald-400";case"unstable":return"text-amber-400";case"none":return"text-r58-text-secondary"}}function i(c){if(c===0)return"0 B";const w=1024,v=["B","KB","MB","GB"],b=Math.floor(Math.log(c)/Math.log(w));return parseFloat((c/Math.pow(w,b)).toFixed(1))+" "+v[b]}function p(c){if(!c.hasSignal)return`${c.label}: No signal detected`;const w=[`${c.label}`,`Resolution: ${c.resolution}`,`Framerate: ${c.framerate} fps`,`Quality: ${g(c)}`];return c.isRecording&&w.push(`Written: ${i(c.bytesWritten)}`),w.join(`
`)}return(c,w)=>r.value.length===0?(y(),_("div",Vt,[...w[0]||(w[0]=[He('<div class="text-center text-r58-text-secondary"><svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg><p class="text-lg font-medium">No Video Sources Connected</p><p class="text-sm mt-2">Connect HDMI cables to begin recording</p></div>',1)])])):(y(),_("div",Gt,[m.value?(y(),_("div",jt,[w[1]||(w[1]=t("svg",{class:"w-4 h-4 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20"},[t("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),t("span",null,$(m.value),1)])):C("",!0),t("div",{class:R(["flex-1 grid gap-4",r.value.length===1?"grid-cols-1":"grid-cols-2"])},[(y(!0),_(U,null,we(r.value,v=>(y(),_("div",{key:v.id,class:R(["relative rounded-lg overflow-hidden border-2 transition-all cursor-pointer aspect-video bg-black",f(v)]),title:p(v)},[s.value?(y(),ce(Ut,{key:0,"input-id":v.id,class:"w-full h-full",onVideoReady:b=>a(v.id)},null,8,["input-id","onVideoReady"])):(y(),_("div",Ot,[...w[2]||(w[2]=[t("div",{class:"text-center"},[t("svg",{class:"w-8 h-8 mx-auto mb-2 text-r58-text-secondary/50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})]),t("span",{class:"text-xs text-r58-text-secondary/70"},"Mixer mode")],-1)])])),t("div",qt,[t("div",Kt,[t("div",Yt,[t("span",{class:R(["w-2 h-2 rounded-full transition-colors",{"bg-emerald-500":g(v)==="excellent"||g(v)==="good","bg-amber-500 animate-pulse":g(v)==="unstable","bg-r58-text-secondary":g(v)==="none"}])},null,2),t("span",Qt,$(v.label),1)]),v.hasSignal?(y(),_("div",Xt,[t("span",Jt,$(v.resolution),1),t("span",{class:R(l(v))},$(v.framerate)+"fps",3)])):C("",!0)]),v.isRecording?(y(),_("div",Zt,[w[3]||(w[3]=t("div",{class:"flex items-center gap-2 text-r58-accent-danger"},[t("span",{class:"w-2 h-2 rounded-full bg-r58-accent-danger animate-recording"}),t("span",{class:"text-sm font-medium"},"REC")],-1)),t("span",en,$(i(v.bytesWritten)),1)])):C("",!0)])],10,zt))),128))],2)]))}}),nn={class:"space-y-4"},on={class:"flex items-center justify-between py-2 cursor-pointer"},sn=["aria-checked"],an={class:"flex items-center justify-between py-2 cursor-pointer"},rn=["aria-checked"],ln={class:"flex items-center justify-between py-2 cursor-pointer"},cn={class:"text-xs text-r58-text-secondary"},un={key:0,class:"text-amber-400"},dn=["aria-checked"],fn={class:"flex items-center justify-between py-2 pl-4 cursor-pointer opacity-80"},gn=["aria-checked"],vn=H({__name:"SettingsPanel",setup(n){const{enabled:e,toggle:o,playClick:h}=_e(),{enabled:d,autoEnable:u,isActive:a,setEnabled:s,setAutoEnable:r}=xe(),m=x(!1);function f(){m.value=!m.value,m.value?(document.body.classList.add("touch-mode"),localStorage.setItem("r58_touch_mode","true")):(document.body.classList.remove("touch-mode"),localStorage.setItem("r58_touch_mode","false"))}O(()=>{const l=localStorage.getItem("r58_touch_mode")==="true";m.value=l,l&&document.body.classList.add("touch-mode")});function g(){o(),e.value&&h()}return(l,i)=>(y(),_("div",nn,[i[7]||(i[7]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide"}," Interface Settings ",-1)),t("label",on,[i[2]||(i[2]=t("div",null,[t("span",{class:"text-r58-text-primary"},"Audio Feedback"),t("p",{class:"text-xs text-r58-text-secondary"},"Play sounds for recording start/stop")],-1)),t("button",{onClick:g,class:R(["relative w-12 h-7 rounded-full transition-colors",S(e)?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":S(e)},[t("span",{class:R(["absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform",S(e)?"translate-x-6":"translate-x-1"])},null,2)],10,sn)]),t("label",an,[i[3]||(i[3]=t("div",null,[t("span",{class:"text-r58-text-primary"},"Touch Mode"),t("p",{class:"text-xs text-r58-text-secondary"},"Larger buttons for touchscreen")],-1)),t("button",{onClick:f,class:R(["relative w-12 h-7 rounded-full transition-colors",m.value?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":m.value},[t("span",{class:R(["absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform",m.value?"translate-x-6":"translate-x-1"])},null,2)],10,rn)]),t("label",ln,[t("div",null,[i[5]||(i[5]=t("span",{class:"text-r58-text-primary"},"Performance Mode",-1)),t("p",cn,[i[4]||(i[4]=z(" Reduce UI updates during recording ",-1)),S(a)&&!S(d)?(y(),_("span",un,"(auto-enabled)")):C("",!0)])]),t("button",{onClick:i[0]||(i[0]=p=>S(s)(!S(d))),class:R(["relative w-12 h-7 rounded-full transition-colors",S(d)?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":S(d)},[t("span",{class:R(["absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform",S(d)?"translate-x-6":"translate-x-1"])},null,2)],10,dn)]),t("label",fn,[i[6]||(i[6]=t("div",null,[t("span",{class:"text-sm text-r58-text-primary"},"Auto-enable when recording 3+ inputs")],-1)),t("button",{onClick:i[1]||(i[1]=p=>S(r)(!S(u))),class:R(["relative w-10 h-6 rounded-full transition-colors",S(u)?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":S(u)},[t("span",{class:R(["absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform",S(u)?"translate-x-4":"translate-x-0.5"])},null,2)],10,gn)])]))}}),pn={class:"session-sidebar"},mn={class:"sidebar-card sidebar-card--recording"},hn={class:"recording-duration"},bn={class:"recording-meta"},yn={class:"sidebar-card"},wn={class:"stats-grid"},_n={class:"stat-label"},xn={class:"stat-value"},kn={key:0,class:"sidebar-card sidebar-card--warning"},$n={class:"warning-text"},Rn={class:"sidebar-card"},Sn={class:"sidebar-hint"},Cn={key:0,class:"sidebar-card"},Tn={class:"storage-info"},Mn={class:"storage-bar"},En={class:"storage-text"},Pn={class:"storage-free"},An={class:"storage-estimate"},Ln={class:"sidebar-card"},Bn={class:"action-buttons"},Dn={key:0,class:"sidebar-card"},Wn=H({__name:"SessionInfoV2",setup(n){const e=Ie(),o=N(),h=de();k(()=>o.currentSession);const d=k(()=>o.activeInputs),u=k(()=>o.isRecording),a=k(()=>o.inputs.filter(g=>g.isRecording)),s=x(!1),r=k(()=>{const g=h.capabilities;if(!g)return null;const l=g.storage_used_gb||0,i=g.storage_total_gb||1,p=i-l,c=Math.round(l/i*100),w=p/10;return{freeGB:Math.round(p),totalGB:Math.round(i),percent:c,hoursRemaining:Math.round(w*10)/10,isLow:c>85,isCritical:c>95}});function m(g){if(g===0)return"0 B";const l=1024,i=["B","KB","MB","GB","TB"],p=Math.floor(Math.log(g)/Math.log(l));return parseFloat((g/Math.pow(l,p)).toFixed(2))+" "+i[p]}function f(){e.push({name:"admin",query:{tab:"settings"}})}return(g,l)=>{var i;return y(),_("div",pn,[u.value?(y(),_(U,{key:0},[t("section",mn,[l[1]||(l[1]=t("div",{class:"recording-header"},[t("span",{class:"recording-dot"}),t("span",{class:"recording-label"},"Recording")],-1)),t("div",hn,$(S(o).formattedDuration),1),t("div",bn,$(a.value.length)+" camera"+$(a.value.length!==1?"s":"")+" recording ",1)]),t("section",yn,[l[2]||(l[2]=t("h3",{class:"sidebar-title"},"Recording Stats",-1)),t("div",wn,[(y(!0),_(U,null,we(a.value,p=>(y(),_("div",{key:p.id,class:"stat-item"},[t("span",_n,$(p.label),1),t("span",xn,$(m(p.bytesWritten)),1)]))),128))])]),(i=r.value)!=null&&i.isLow?(y(),_("section",kn,[l[4]||(l[4]=t("div",{class:"warning-icon"},"âš ï¸",-1)),t("div",$n,[l[3]||(l[3]=t("strong",null,"Low storage",-1)),t("span",null,$(r.value.freeGB)+" GB remaining (~"+$(r.value.hoursRemaining)+"h)",1)])])):C("",!0)],64)):(y(),_(U,{key:1},[t("section",Rn,[l[7]||(l[7]=t("h3",{class:"sidebar-title"},"Ready to Record",-1)),t("p",Sn,[z($(d.value.length)+" input"+$(d.value.length!==1?"s":"")+" with signal detected. Press ",1),l[5]||(l[5]=t("kbd",null,"Space",-1)),l[6]||(l[6]=z(" or click Start Recording to begin. ",-1))])]),r.value?(y(),_("section",Cn,[l[8]||(l[8]=t("h3",{class:"sidebar-title"},"Storage",-1)),t("div",Tn,[t("div",Mn,[t("div",{class:R(["storage-fill",{"storage-fill--ok":!r.value.isLow,"storage-fill--low":r.value.isLow&&!r.value.isCritical,"storage-fill--critical":r.value.isCritical}]),style:Fe({width:`${r.value.percent}%`})},null,6)]),t("div",En,[t("span",Pn,$(r.value.freeGB)+" GB free",1),t("span",An,"~"+$(r.value.hoursRemaining)+"h recording",1)])])])):C("",!0),t("section",Ln,[l[9]||(l[9]=t("h3",{class:"sidebar-title"},"Quick Actions",-1)),t("div",Bn,[t("button",{onClick:f,class:"action-btn"}," âš™ï¸ Configure Inputs "),t("button",{onClick:l[0]||(l[0]=p=>s.value=!s.value),class:"action-btn"},$(s.value?"âœ• Hide Settings":"ðŸŽ¨ Interface Settings"),1)])]),L(Q,{name:"slide-fade"},{default:X(()=>[s.value?(y(),_("section",Dn,[L(vn)])):C("",!0)]),_:1})],64))])}}}),Nn=ue(Wn,[["__scopeId","data-v-c601be94"]]),Hn={class:"h-full flex flex-col"},Fn={class:"flex items-center justify-between px-6 py-4 border-b border-r58-bg-tertiary bg-r58-bg-secondary"},In={class:"flex items-center gap-4"},Un={class:"flex items-center gap-2"},Vn={key:0,class:"badge badge-danger"},Gn={class:"flex-1 flex overflow-hidden"},jn={class:"flex-1 p-4"},zn={class:"w-80 border-l border-r58-bg-tertiary bg-r58-bg-secondary p-4 overflow-y-auto"},On=H({__name:"RecorderView",setup(n){const e=N(),o=de(),{showLeaveConfirmation:h,confirmLeave:d,cancelLeave:u}=ze(),a=k(()=>e.status==="recording"),s=k(()=>e.formattedDuration),r=x(!0),m=x(!1),f=x(!1),g=k(()=>m.value&&f.value);function l(){r.value=!1}async function i(){var v;if(!Ue())return;await o.fetchCapabilities();const w=(v=o.capabilities)==null?void 0:v.current_mode;if(w&&w!=="recorder"){console.log("[Recorder] Not in recorder mode, switching...");try{(await fetch(Ve("/api/mode/recorder"),{method:"POST"})).ok&&(await o.fetchCapabilities(),F.success("Switched to Recorder mode"))}catch(b){console.warn("[Recorder] Failed to switch mode:",b)}}}function p(){console.log("[Recorder] All videos ready!"),f.value=!0}O(async()=>{const w=performance.now();await Promise.all([i(),e.fetchInputs(),e.fetchStatus()]);const v=e.inputs.filter(b=>b.hasSignal).length;console.log(`[Recorder] Data loaded: ${e.inputs.length} inputs, ${v} with signal (${Math.round(performance.now()-w)}ms)`),m.value=!0,v===0&&(f.value=!0)});const c=x(null);return D(h,w=>{var v,b;w?(v=c.value)==null||v.open():(b=c.value)==null||b.close()}),(w,v)=>(y(),_(U,null,[L(Q,{name:"fade"},{default:X(()=>[r.value?(y(),ce(je,{key:0,mode:"recorder","content-ready":g.value,"min-time":1500,"max-time":5e3,onReady:l},null,8,["content-ready"])):C("",!0)]),_:1}),L(Q,{name:"content-fade"},{default:X(()=>[he(t("div",Hn,[t("header",Fn,[t("div",In,[t("div",Un,[t("span",{class:R(["w-3 h-3 rounded-full",a.value?"bg-r58-accent-danger animate-recording":"bg-r58-bg-tertiary"])},null,2),v[0]||(v[0]=t("span",{class:"text-xl font-semibold"},"Recorder",-1))]),a.value?(y(),_("span",Vn,"RECORDING")):C("",!0),L(kt)]),L(vt)]),t("div",Gn,[t("div",jn,[L(tn,{onAllVideosReady:p})]),t("aside",zn,[L(Nn)])]),L(be,{ref_key:"leaveDialog",ref:c,title:"Recording in Progress",message:`You are currently recording (${s.value}). Leaving will stop the recording and save all files.`,"confirm-text":"Leave and Stop Recording","cancel-text":"Stay",danger:!0,onConfirm:S(d),onCancel:S(u)},null,8,["message","onConfirm","onCancel"])],512),[[Ge,!r.value]])]),_:1})],64))}}),Yn=ue(On,[["__scopeId","data-v-d987df66"]]);export{Yn as default};
