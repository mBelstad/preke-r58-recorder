const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DlQ8AlmE.js","assets/index-_akB68C_.css"])))=>i.map(i=>d[i]);
import{r as k,D as Y,E as z,o as ee,l as pe,G as Ne,j as M,H as ue,d as Q,I as me,m as j,T as Ce,p as ne,c as w,f as H,z as He,e,w as K,A as le,t as R,J as We,i as _,_ as re,K as Fe,h as J,F as O,n as U,x as oe,L as Ee,q as ae,M as fe,N as Ue,O as Pe,u as xe,a as Le,y as ve,B as Ve,P as Ae,Q as je,R as Ge,S as Ie,U as Oe,V as ze,k as qe,g as De,W as Ke,b as Ye,v as Qe}from"./index-DlQ8AlmE.js";import{u as Xe,C as Je,M as Ze}from"./ModeLoadingScreen-C6b745km.js";function et(){const n=k(!1),t=k(!1);let o=null;const v=Y();z(()=>v.status,a=>{n.value=a==="recording"},{immediate:!0});function i(a){if(n.value)return a.preventDefault(),a.returnValue="Recording in progress. Are you sure you want to leave?",a.returnValue}ee(()=>{window.addEventListener("beforeunload",i)}),pe(()=>{window.removeEventListener("beforeunload",i)}),Ne((a,d,p)=>{n.value?(o=()=>p(),t.value=!0,p(!1)):p()});function s(){t.value=!1,n.value=!1,v.stopRecording().finally(()=>{o&&(o(),o=null)})}function l(){t.value=!1,o=null}return{isGuardActive:n,showLeaveConfirmation:t,confirmLeave:s,cancelLeave:l}}const N=k(null),ge=k(!1),Re=k(null),_e=k(null),tt=10,he=2,nt=25;function ot(){const n=M(()=>N.value?N.value.available_gb<he?"critical":N.value.available_gb<tt?"warning":"ok":"unknown"),t=M(()=>N.value?N.value.available_gb>=he:!0),o=M(()=>{if(!N.value)return null;const a=N.value.available_gb*1024*1024*1024,d=nt*1024*1024,p=a/d,c=Math.floor(p/3600),h=Math.floor(p%3600/60);return c>24?`${Math.floor(c/24)}d ${c%24}h`:c>0?`${c}h ${h}m`:`${h}m`}),v=M(()=>{switch(n.value){case"ok":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}}),i=M(()=>N.value?n.value==="critical"?`Disk space critically low (${N.value.available_gb.toFixed(1)} GB). Cannot start recording.`:n.value==="warning"?`Low disk space (${N.value.available_gb.toFixed(1)} GB). Estimated recording time: ${o.value}`:null:null);async function s(){ge.value=!0,_e.value=null;try{const a=await ue.getDegradation();if(a.resources&&a.resources.disk_free_gb!==void 0){const d=a.resources.disk_free_gb,p=d*3;N.value={available_gb:d,total_gb:p,used_percent:100-d/p*100,recording_path:"/opt/r58-app/shared/recordings"}}return Re.value=new Date,N.value}catch(a){return _e.value=a.message||"Failed to check disk space",console.error("Failed to check disk space:",a),null}finally{ge.value=!1}}async function l(){return await s(),N.value?n.value==="critical"?{ok:!1,message:`Insufficient disk space (${N.value.available_gb.toFixed(1)} GB). Need at least ${he} GB to start recording.`}:n.value==="warning"?{ok:!0,message:`Low disk space warning: ${N.value.available_gb.toFixed(1)} GB available. Estimated recording time: ${o.value}`}:{ok:!0}:{ok:!0,message:"Could not verify disk space. Proceeding with caution."}}return{diskSpace:N,isLoading:ge,lastCheck:Re,error:_e,status:n,statusColor:v,canStartRecording:t,estimatedRecordingTime:o,warningMessage:i,checkDiskSpace:s,preflightCheck:l}}const G=k(localStorage.getItem("r58_audio_feedback")!=="false");let be=null;function at(){return be||(be=new(window.AudioContext||window.webkitAudioContext)),be}function V(n,t,o="sine",v=.3){if(G.value)try{const i=at();i.state==="suspended"&&i.resume();const s=i.createOscillator(),l=i.createGain();s.connect(l),l.connect(i.destination),s.type=o,s.frequency.value=n;const a=i.currentTime;l.gain.setValueAtTime(0,a),l.gain.linearRampToValueAtTime(v,a+.01),l.gain.linearRampToValueAtTime(0,a+t),s.start(a),s.stop(a+t)}catch(i){console.warn("Audio feedback failed:",i)}}function st(){G.value&&(V(440,.1,"sine",.2),setTimeout(()=>V(554,.1,"sine",.2),100),setTimeout(()=>V(659,.15,"sine",.25),200))}function rt(){G.value&&(V(880,.08,"sine",.3),setTimeout(()=>V(880,.15,"sine",.3),120))}function it(){G.value&&(V(659,.1,"sine",.25),setTimeout(()=>V(554,.1,"sine",.2),100),setTimeout(()=>V(440,.15,"sine",.2),200))}function lt(){G.value&&(V(200,.15,"square",.15),setTimeout(()=>V(180,.2,"square",.15),180))}function ct(){G.value&&(V(1e3,.08,"sine",.2),setTimeout(()=>V(1e3,.08,"sine",.2),150))}function Se(){G.value&&V(1200,.03,"sine",.1)}function ut(n=50){if(G.value&&"vibrate"in navigator)try{navigator.vibrate(n)}catch{}}function dt(){function n(o){G.value=o,localStorage.setItem("r58_audio_feedback",String(o))}function t(){n(!G.value),G.value&&Se()}return{enabled:G,setEnabled:n,toggle:t,playSuccess:st,playError:lt,playWarning:ct,playClick:Se,playRecordStart:rt,playRecordStop:it,vibrate:ut}}const ft={class:"bg-preke-bg-elevated rounded-lg shadow-xl max-w-md w-full p-6"},vt=["placeholder"],pt={class:"text-xs text-preke-text-dim mt-2"},mt=Q({__name:"SessionNameDialog",props:{open:{type:Boolean},suggestedName:{}},emits:["confirm","cancel","skip"],setup(n,{emit:t}){const o=n,v=t,i=k(""),s=k(null),l=M(()=>{const u=new Date,b=u.toLocaleDateString("en-CA"),m=u.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}).replace(":","");return`Recording_${b}_${m}`}),a=M(()=>o.suggestedName||l.value);z(()=>o.open,u=>{u&&(i.value=a.value,setTimeout(()=>{var b,m;(b=s.value)==null||b.focus(),(m=s.value)==null||m.select()},100))});function d(){v("confirm",i.value.trim()||a.value)}function p(){v("skip")}function c(){v("cancel")}function h(u){u.key==="Enter"?d():u.key==="Escape"&&c()}return(u,b)=>(_(),me(We,{to:"body"},[j(Ce,{name:"fade"},{default:ne(()=>[n.open?(_(),w("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:He(c,["self"]),onKeydown:h},[e("div",ft,[b[1]||(b[1]=e("h2",{class:"text-lg font-semibold mb-2"},"Name This Recording",-1)),b[2]||(b[2]=e("p",{class:"text-preke-text-dim text-sm mb-4"}," Give your recording a name to find it easily later (optional). ",-1)),K(e("input",{ref_key:"inputRef",ref:s,"onUpdate:modelValue":b[0]||(b[0]=m=>i.value=m),type:"text",placeholder:a.value,class:"w-full px-4 py-2 bg-preke-bg-surface border border-preke-bg-surface rounded-lg text-preke-text placeholder-preke-text-dim focus:outline-none focus:ring-2 focus:ring-preke-gold"},null,8,vt),[[le,i.value]]),e("p",pt," Suggested: "+R(a.value),1),e("div",{class:"flex justify-between mt-6"},[e("button",{onClick:p,class:"text-sm text-preke-text-dim hover:text-preke-text transition-colors"}," Skip (use default) "),e("div",{class:"flex gap-3"},[e("button",{onClick:c,class:"btn"}," Cancel "),e("button",{onClick:d,class:"btn btn-primary"}," Start Recording ")])])])],32)):H("",!0)]),_:1})]))}}),gt=re(mt,[["__scopeId","data-v-2eeca4e8"]]),_t={class:"recorder-controls"},ht={key:0,class:"recorder-controls__duration"},bt=["disabled","title"],yt={key:0,class:"recorder-controls__spinner"},wt={key:0,class:"recorder-controls__icon recorder-controls__icon--stop"},kt={key:1,class:"recorder-controls__icon recorder-controls__icon--record"},Ct={class:"recorder-controls__hint"},xt=Q({__name:"RecorderControls",setup(n){const t=Y(),{register:o}=Fe(),{preflightCheck:v,status:i,canStartRecording:s}=ot(),{playRecordStart:l,playRecordStop:a,playError:d,playWarning:p,vibrate:c}=dt(),h=k(null),u=k(!1),b=k(!1),m=k(!1),x=k(!1),L=k(void 0),T=M(()=>t.status==="recording"),r=M(()=>t.status==="starting"),f=M(()=>t.status==="stopping"),$=M(()=>t.formattedDuration),F=M(()=>r.value||f.value||b.value),te=M(()=>r.value?"Starting recording...":f.value?"Stopping recording...":b.value?"Checking disk space...":!T.value&&!s.value?"Insufficient disk space":"");let X=null;ee(()=>{X=o({key:" ",description:"Toggle Recording",action:ie,context:"recorder",enabled:()=>!r.value&&!f.value})}),pe(()=>{X&&X()});async function ie(){T.value?y():await D()}async function D(P){b.value=!0;try{const B=await v();if(!B.ok){d(),c(200),J.error("Cannot start recording",B.message||"Preflight check failed");return}if(B.message&&i.value==="warning"&&(p(),J.warning("Low disk space",B.message)),x.value&&!P){L.value=void 0,m.value=!0;return}await q(P||L.value)}finally{b.value=!1}}async function q(P){try{await t.startRecording(P);const B=P||t.sessionId;l(),c([50,30,50]),J.success("Recording started",`Session: ${B}`)}catch(B){d(),c(200),J.error("Failed to start recording",B.message||"Unknown error",{label:"Retry",onClick:()=>D(P)})}}function A(P){m.value=!1,L.value=P,D(P)}function S(){m.value=!1,L.value=void 0,D()}function g(){m.value=!1,b.value=!1}async function E(){try{await t.stopRecording(),a(),c(100),J.success("Recording stopped")}catch(P){d(),c(200),J.error("Failed to stop recording",P.message||"Unknown error")}}function y(){var P;u.value=!1,(P=h.value)==null||P.open(),setTimeout(()=>{u.value=!0},500)}function C(){u.value&&E()}async function W(){T.value?y():await q()}return(P,B)=>(_(),w(O,null,[e("div",_t,[T.value?(_(),w("div",ht,R($.value),1)):H("",!0),e("button",{onClick:W,disabled:F.value,class:U(["recorder-controls__btn",T.value?"recorder-controls__btn--stop":"recorder-controls__btn--start"]),title:te.value||(T.value?"Stop Recording (Space)":"Start Recording (Space)")},[r.value||f.value||b.value?(_(),w("span",yt)):(_(),w(O,{key:1},[T.value?(_(),w("span",wt)):(_(),w("span",kt))],64)),e("span",null,R(b.value?"Checking...":T.value?"Stop":"Start Recording"),1)],10,bt),e("span",Ct,[B[0]||(B[0]=oe(" Press ",-1)),B[1]||(B[1]=e("kbd",null,"Space",-1)),oe(" to "+R(T.value?"stop":"start"),1)])]),j(Ee,{ref_key:"stopConfirmDialog",ref:h,title:"Stop Recording?",message:`You have been recording for ${$.value}. This will finalize all files.`,"confirm-text":"Stop Recording","cancel-text":"Keep Recording",danger:!0,onConfirm:C},null,8,["message"]),j(gt,{open:m.value,onConfirm:A,onSkip:S,onCancel:g},null,8,["open"])],64))}}),$t=re(xt,[["__scopeId","data-v-1e32920d"]]),ce=k(localStorage.getItem("r58_performance_mode")==="true"),ye=k(localStorage.getItem("r58_performance_mode_auto")!=="false"),Rt=3,St=100,Mt=500;function Tt(){const n=Y(),t=M(()=>ce.value?!0:ye.value&&n.isRecording?n.inputs.filter(h=>h.isRecording).length>=Rt:!1),o=M(()=>t.value?Mt:St);z(t,c=>{c?document.body.classList.add("performance-mode"):document.body.classList.remove("performance-mode")},{immediate:!0});function v(c){ce.value=c,localStorage.setItem("r58_performance_mode",String(c))}function i(c){ye.value=c,localStorage.setItem("r58_performance_mode_auto",String(c))}function s(){v(!ce.value)}function l(c,h){let u=0,b=null;return(...m)=>{const x=Date.now(),L=h??o.value,T=x-u;T>=L?(u=x,c(...m)):b||(b=window.setTimeout(()=>{u=Date.now(),b=null,c(...m)},L-T))}}function a(c,h){let u=null;return(...b)=>{u&&clearTimeout(u),u=window.setTimeout(()=>{c(...b),u=null},h??o.value)}}function d(c){return t.value?window.setTimeout(()=>c(performance.now()),o.value):requestAnimationFrame(c)}function p(c){t.value?clearTimeout(c):cancelAnimationFrame(c)}return{enabled:ce,autoEnable:ye,isActive:t,updateInterval:o,setEnabled:v,setAutoEnable:i,toggle:s,throttle:l,debounce:a,requestFrame:d,cancelFrame:p}}const Et=["title"],Pt={class:"flex items-center gap-1.5 text-sm"},Lt={key:0,class:"flex items-center gap-1.5 text-sm"},At={key:1,class:"flex items-center gap-1.5 text-sm text-red-400"},Dt={class:"font-mono"},Bt=Q({__name:"RecordingHealth",setup(n,{expose:t}){const o=Y(),{isActive:v}=Tt(),i=k({}),s=k(0),l=k(0),a=k(0);let d=null;function p(){const m={};let x=0;o.inputs.forEach(T=>{m[T.id]=T.bytesWritten;const r=i.value[T.id]||0;x+=T.bytesWritten-r});const L=v.value?2:1;s.value=Math.round(x/(1024*1024)/L*10)/10,i.value=m}z(()=>o.isRecording,m=>{if(m){i.value={},s.value=0,l.value=0,a.value=0;const x=v.value?2e3:1e3;d=window.setInterval(p,x)}else d&&(clearInterval(d),d=null)},{immediate:!0}),z(v,m=>{if(o.isRecording&&d){clearInterval(d);const x=m?2e3:1e3;d=window.setInterval(p,x)}}),pe(()=>{d&&clearInterval(d)});const c=M(()=>o.isRecording?a.value>0||l.value>90?"critical":s.value<1||l.value>70?"warning":"healthy":"idle"),h=M(()=>{switch(c.value){case"healthy":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}});M(()=>{switch(c.value){case"healthy":return"Healthy";case"warning":return"Warning";case"critical":return"Critical";default:return"Idle"}});const u=M(()=>{if(!o.isRecording)return"Not recording";const m=[`Write speed: ${s.value} MB/s`,`Buffer: ${l.value}%`];return a.value>0&&m.push(`Frames dropped: ${a.value}`),m.join(`
`)});function b(m){m.buffer_percent!==void 0&&(l.value=m.buffer_percent),m.frames_dropped!==void 0&&(a.value=m.frames_dropped)}return t({updateFromMetrics:b}),(m,x)=>ae(o).isRecording?(_(),w("div",{key:0,class:U(["flex items-center gap-3 px-3 py-1.5 rounded-lg transition-colors cursor-help",{"bg-emerald-500/10":h.value==="emerald","bg-amber-500/10":h.value==="amber","bg-red-500/10":h.value==="red"}]),title:u.value},[e("span",{class:U(["w-2 h-2 rounded-full",h.value==="emerald"?"bg-emerald-500":"",h.value==="amber"?"bg-amber-500 animate-pulse":"",h.value==="red"?"bg-red-500 animate-pulse":""])},null,2),e("div",Pt,[x[0]||(x[0]=e("svg",{class:"w-3.5 h-3.5 text-preke-text-dim",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})],-1)),e("span",{class:U(["font-mono",h.value==="emerald"?"text-emerald-400":"",h.value==="amber"?"text-amber-400":"",h.value==="red"?"text-red-400":""])},R(s.value)+" MB/s ",3)]),l.value>0?(_(),w("div",Lt,[x[1]||(x[1]=e("span",{class:"text-preke-text-dim"},"Buf:",-1)),e("span",{class:U(["font-mono",l.value<50?"text-emerald-400":"",l.value>=50&&l.value<80?"text-amber-400":"",l.value>=80?"text-red-400":""])},R(l.value)+"% ",3)])):H("",!0),a.value>0?(_(),w("div",At,[x[2]||(x[2]=e("svg",{class:"w-3.5 h-3.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),e("span",Dt,R(a.value)+" dropped",1)])):H("",!0)],10,Et)):H("",!0)}});function Me(n){return n.startsWith("192.168.")||n.startsWith("10.")||n.startsWith("172.")||n.startsWith("100.")||n==="127.0.0.1"||n==="localhost"}const Nt=5,Ht=1e3,Wt=3e4,Ft=()=>typeof window<"u"&&window.__NETWORK_DEBUG__===!0,Te=new Map,Ut=1e3;function de(n,t,...o){if(!Ft())return;const v=Date.now(),i=Te.get(n)||0;v-i<Ut||(Te.set(n,v),console.log(`[NETWORK DEBUG ${n}] ${t}`,...o))}const I=new Map,se=new Map;async function Vt(n){const t=fe(),o=Pe();if(t&&!o)try{return`http://${new URL(t).hostname}:8889/${n}/whep`}catch{console.warn("[WHEP Manager] Invalid device URL, falling back to FRP")}if(typeof window<"u"&&window.location.hostname==="app.itagenten.no")return console.log("[WHEP Manager] Browser access from app.itagenten.no, using same-domain proxy"),`https://app.itagenten.no/${n}/whep`;const{getFrpUrl:v}=await Ue(async()=>{const{getFrpUrl:s}=await import("./index-DlQ8AlmE.js").then(l=>l.a3);return{getFrpUrl:s}},__vite__mapDeps([0,1])),i=await v();if(i)try{const s=new URL(i);return s.hostname.includes("itagenten.no")?`https://app.itagenten.no/${n}/whep`:s.hostname.includes("mediamtx")?`${i}/${n}/whep`:`https://${s.hostname.replace("api","mediamtx")}/${n}/whep`}catch{console.warn("[WHEP Manager] Invalid FRP URL, cannot build WHEP URL")}throw new Error("No device configured and no FRP fallback available")}async function jt(n,t){const o=I.get(t);if(!o)return"unknown";try{const s=new URL(o.whepUrl).hostname;if(s.includes("itagenten.no"))return console.log(`[WHEP Manager ${t}] Detected relay (FRP URL)`),"relay";if(Me(s))return console.log(`[WHEP Manager ${t}] Detected P2P (private IP: ${s})`),"p2p"}catch(i){console.warn(`[WHEP Manager ${t}] Failed to parse WHEP URL:`,i)}try{const i=await n.getStats();for(const s of i.values())if(s.type==="candidate-pair"&&s.state==="succeeded"){const l=i.get(s.remoteCandidateId);if((l==null?void 0:l.candidateType)==="relay")return console.log(`[WHEP Manager ${t}] Detected relay (TURN candidate)`),"relay";const a=l==null?void 0:l.address;if(a&&!Me(a))return console.log(`[WHEP Manager ${t}] Detected relay (public IP: ${a})`),"relay"}}catch(i){console.warn(`[WHEP Manager ${t}] Failed to get WebRTC stats:`,i)}return fe()&&!Pe()?(console.log(`[WHEP Manager ${t}] Assuming P2P (direct device URL configured)`),"p2p"):"unknown"}function Z(n){const t=I.get(n);if(!t)return;const o=se.get(n);o&&o.forEach(v=>v(t))}function we(n){const t=I.get(n);if(!t)return;if(t.reconnectAttempts>=Nt){console.error(`[WHEP Manager ${n}] Max reconnect attempts reached`),t.state="failed",Z(n);return}t.reconnectAttempts++;const o=Math.min(Ht*Math.pow(2,t.reconnectAttempts-1),Wt),v=o*.2*(Math.random()*2-1),i=Math.max(100,Math.round(o+v));de("WHEP",`Camera ${n}: Reconnect #${t.reconnectAttempts} in ${i}ms (base: ${o}ms)`),console.log(`[WHEP Manager ${n}] Scheduling reconnect #${t.reconnectAttempts} in ${i}ms`),t.state="connecting",Z(n),t.reconnectTimeout&&clearTimeout(t.reconnectTimeout),t.reconnectTimeout=setTimeout(()=>{$e(n)},i)}async function $e(n){let t=I.get(n);if(t&&(t.state==="connected"||t.state==="connecting"))return console.log(`[WHEP Manager ${n}] Reusing existing connection (state: ${t.state})`),t;if(t!=null&&t.isConnecting){for(de("WHEP",`Camera ${n}: Connection already in progress, skipping duplicate attempt`),console.log(`[WHEP Manager ${n}] Connection already in progress, waiting...`);t.isConnecting&&t.state==="connecting"&&(await new Promise(a=>setTimeout(a,100)),t=I.get(n),!!t););if(t)return t}const o=typeof window<"u"&&window.location.hostname==="app.itagenten.no";let v=fe();if(o)console.log(`[WHEP Manager ${n}] Browser mode - using MediaMTX proxy`);else{let a=0;for(;!v&&a<5;)console.log(`[WHEP Manager ${n}] No device URL yet, waiting... (attempt ${a+1})`),await new Promise(d=>setTimeout(d,100)),v=fe(),a++}const i=performance.now(),s=await Vt(n);de("WHEP",`Camera ${n}: Creating connection to ${s}`),console.log(`[WHEP Manager ${n}] Creating connection to: ${s}`),console.log(`[WHEP Manager ${n}] Device URL was: ${v||"none (browser mode)"}`),t!=null&&t.peerConnection&&t.peerConnection.close(),t!=null&&t.disconnectedTimeout&&(clearTimeout(t.disconnectedTimeout),t.disconnectedTimeout=null),t&&(t.isConnecting=!0);const l=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}]});t?(t.peerConnection=l,t.state="connecting",t.whepUrl=s,t.mediaStream=null,t.connectionType="unknown",t.connectionStartTime=i,t.isConnecting=!0):(t={cameraId:n,peerConnection:l,mediaStream:null,state:"connecting",connectionType:"unknown",refCount:0,whepUrl:s,lastConnectedAt:null,reconnectAttempts:0,reconnectTimeout:null,disconnectedTimeout:null,connectionStartTime:i,isConnecting:!0},I.set(n,t)),l.ontrack=a=>{a.streams[0]&&(t.mediaStream=a.streams[0],console.log(`[WHEP Manager ${n}] Received media stream`),Z(n))},l.oniceconnectionstatechange=async()=>{const a=l.iceConnectionState;if(de("WHEP",`Camera ${n}: ICE state changed to ${a}`),console.log(`[WHEP Manager ${n}] ICE state: ${a}`),a==="connected"||a==="completed"){t.state="connected",t.lastConnectedAt=Date.now(),t.reconnectAttempts=0,t.isConnecting=!1,t.connectionType=await jt(l,n),t.disconnectedTimeout&&(clearTimeout(t.disconnectedTimeout),t.disconnectedTimeout=null);const d=t.connectionStartTime?Math.round(performance.now()-t.connectionStartTime):0;console.log(`[WHEP Manager ${n}] Connected (${t.connectionType}) in ${d}ms`),Z(n)}else a==="failed"?(t.state="failed",t.connectionType="unknown",t.isConnecting=!1,Z(n),t.refCount>0&&we(n)):a==="disconnected"&&(t.disconnectedTimeout&&clearTimeout(t.disconnectedTimeout),t.disconnectedTimeout=setTimeout(()=>{(l.iceConnectionState==="disconnected"||l.iceConnectionState==="failed")&&(t.state="disconnected",t.isConnecting=!1,Z(n),t.refCount>0&&we(n)),t.disconnectedTimeout=null},3e3))},l.addTransceiver("video",{direction:"recvonly"}),l.addTransceiver("audio",{direction:"recvonly"});try{const a=await l.createOffer();await l.setLocalDescription(a);const d=await fetch(s,{method:"POST",headers:{"Content-Type":"application/sdp"},body:a.sdp});if(!d.ok)throw new Error(`WHEP request failed: ${d.status}`);const p=await d.text();await l.setRemoteDescription({type:"answer",sdp:p})}catch(a){console.error(`[WHEP Manager ${n}] Connection error:`,a),t.state="failed",t.isConnecting=!1,Z(n),t.refCount>0&&we(n)}return t}async function Gt(n,t){se.has(n)||se.set(n,new Set),se.get(n).add(t);let o=I.get(n);return(!o||o.state==="failed"||o.state==="disconnected")&&(o=await $e(n)),o.refCount++,console.log(`[WHEP Manager ${n}] Acquired connection (refCount: ${o.refCount})`),t(o),o}function It(n,t){const o=I.get(n);if(!o)return;const v=se.get(n);v&&(v.delete(t),v.size===0&&se.delete(n)),o.refCount=Math.max(0,o.refCount-1),console.log(`[WHEP Manager ${n}] Released connection (refCount: ${o.refCount})`),o.refCount===0&&(console.log(`[WHEP Manager ${n}] Closing unused connection`),o.reconnectTimeout&&clearTimeout(o.reconnectTimeout),o.disconnectedTimeout&&clearTimeout(o.disconnectedTimeout),o.peerConnection.close(),I.delete(n))}function ke(n){const t=I.get(n);t&&(console.log(`[WHEP Manager ${n}] Force reconnecting...`),t.reconnectAttempts=0,$e(n))}const Ot={class:"relative w-full h-full bg-black"},zt=["title"],qt={key:1,class:"absolute inset-0 flex items-center justify-center bg-black/50"},Kt={key:2,class:"absolute inset-0 flex items-center justify-center bg-black/70"},Yt={class:"text-center"},Qt={class:"text-xs text-amber-400"},Xt={key:3,class:"absolute inset-0 flex items-center justify-center bg-black/80"},Jt={class:"text-center text-preke-text-dim"},Zt={class:"text-sm"},en=Q({__name:"InputPreview",props:{inputId:{},protocol:{}},emits:["videoReady","aspectRatio"],setup(n,{emit:t}){const o=n,v=t,i=Y();let s=!1;const l=M(()=>i.status==="recording"),a=k(null),d=k(!0),p=k(null),c=k("unknown"),h=k(!1),u=k(0);let b=null;function m(r){switch(console.log(`[InputPreview ${o.inputId}] Connection update:`,{state:r.state,type:r.connectionType,hasStream:!!r.mediaStream}),c.value=r.connectionType,u.value=r.reconnectAttempts,r.state){case"connecting":d.value=!0,p.value=null,h.value=r.reconnectAttempts>0;break;case"connected":d.value=!1,p.value=null,h.value=!1,r.mediaStream&&a.value&&a.value.srcObject!==r.mediaStream&&(a.value.srcObject=r.mediaStream,a.value.play().catch(f=>{console.warn(`[InputPreview ${o.inputId}] Autoplay prevented:`,f)}),s||(a.value.onloadeddata=()=>{if(!s&&a.value){s=!0;const f=a.value.videoWidth,$=a.value.videoHeight,F=f&&$?f/$:16/9;console.log(`[InputPreview ${o.inputId}] Video ready (${f}x${$}, ratio: ${F.toFixed(3)})`),v("aspectRatio",F),v("videoReady")}}));break;case"disconnected":h.value=!0,p.value=`Reconnecting... (${r.reconnectAttempts}/5)`;break;case"failed":d.value=!1,h.value=!1,p.value="Connection failed after multiple attempts";break}}async function x(){if(a.value){T(),d.value=!0,p.value=null,b=m;try{await Gt(o.inputId,b)}catch(r){console.error(`[InputPreview ${o.inputId}] Failed to acquire connection:`,r),p.value=r instanceof Error?r.message:"Failed to connect",d.value=!1}}}function L(){ke(o.inputId)}function T(){b&&(It(o.inputId,b),b=null)}return ee(()=>{x()}),z(()=>o.inputId,()=>{x()}),z(l,(r,f)=>{f&&!r&&p.value?(console.log("[InputPreview] Recording stopped, reconnecting preview..."),ke(o.inputId)):!f&&r&&(console.log("[InputPreview] Recording started, will try to reconnect preview after delay..."),setTimeout(()=>{l.value&&(console.log("[InputPreview] Attempting to reconnect preview during recording..."),ke(o.inputId))},2e3))}),pe(()=>{T()}),(r,f)=>(_(),w("div",Ot,[e("video",{ref_key:"videoRef",ref:a,autoplay:"",muted:"",playsinline:"",class:"w-full h-full object-contain"},null,512),!d.value&&!p.value&&c.value!=="unknown"?(_(),w("div",{key:0,class:U(["absolute top-1 right-1 px-1.5 py-0.5 text-[10px] font-medium rounded",c.value==="p2p"?"bg-emerald-500/80 text-white":"bg-amber-500/80 text-white"]),title:c.value==="p2p"?"Direct P2P connection":"Relay connection (FRP)"},R(c.value==="p2p"?"P2P":"RELAY"),11,zt)):H("",!0),d.value&&!h.value?(_(),w("div",qt,[...f[0]||(f[0]=[e("div",{class:"animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"},null,-1)])])):H("",!0),h.value?(_(),w("div",Kt,[e("div",Yt,[f[1]||(f[1]=e("div",{class:"animate-spin w-5 h-5 border-2 border-amber-400 border-t-transparent rounded-full mx-auto mb-2"},null,-1)),e("p",Qt,R(p.value||"Reconnecting..."),1)])])):p.value&&!d.value?(_(),w("div",Xt,[e("div",Jt,[e("p",Zt,R(p.value),1),e("button",{onClick:L,class:"mt-2 text-xs text-preke-gold hover:underline"}," Retry ")])])):H("",!0)]))}}),tn={key:0,class:"h-full flex items-center justify-center"},nn={key:1,class:"input-grid"},on={key:0,class:"input-grid__warning"},an=["data-count"],sn=["title"],rn={key:1,class:"w-full h-full flex items-center justify-center bg-preke-bg-surface"},ln={class:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-4"},cn={class:"flex items-center justify-between"},un={class:"flex items-center gap-2"},dn={class:"font-medium"},fn={key:0,class:"flex items-center gap-2 text-sm"},vn={class:"text-preke-text-dim"},pn=Q({__name:"InputGrid",emits:["allVideosReady"],setup(n,{emit:t}){const o=Y(),v=xe(),i=t,s=k(new Set),l=k({});function a(r){s.value.add(r),console.log(`[InputGrid] Video ready: ${r} (${s.value.size}/${h.value.length})`),s.value.size>=h.value.length&&(console.log("[InputGrid] All videos ready!"),i("allVideosReady"))}function d(r,f){l.value[r]=f,console.log(`[InputGrid] Aspect ratio for ${r}: ${f.toFixed(3)}`)}function p(r){return{aspectRatio:`${l.value[r]||1.7777777777777777}`}}z(()=>h.value.length,()=>{s.value.clear()});const c=M(()=>{var r;return((r=v.capabilities)==null?void 0:r.current_mode)==="recorder"}),h=M(()=>o.inputs.filter(r=>r.hasSignal)),u=M(()=>o.framerateMismatch);function b(r){return r.isRecording?"border-preke-red ring-2 ring-preke-red/20":r.hasSignal?"border-emerald-500/50 hover:border-emerald-500":"border-preke-bg-surface/50 opacity-60"}function m(r){return r.hasSignal?r.framerate>=29?"excellent":r.framerate>=24?"good":"unstable":"none"}function x(r){switch(m(r)){case"excellent":return"text-emerald-400";case"good":return"text-emerald-400";case"unstable":return"text-amber-400";case"none":return"text-preke-text-dim"}}function L(r){if(r===0)return"0 B";const f=1024,$=["B","KB","MB","GB"],F=Math.floor(Math.log(r)/Math.log(f));return parseFloat((r/Math.pow(f,F)).toFixed(1))+" "+$[F]}function T(r){if(!r.hasSignal)return`${r.label}: No signal detected`;const f=[`${r.label}`,`Resolution: ${r.resolution}`,`Framerate: ${r.framerate} fps`,`Quality: ${m(r)}`];return r.isRecording&&f.push(`Written: ${L(r.bytesWritten)}`),f.join(`
`)}return(r,f)=>h.value.length===0?(_(),w("div",tn,[...f[0]||(f[0]=[Le('<div class="text-center text-preke-text-dim" data-v-206e9703><svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-206e9703><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" data-v-206e9703></path></svg><p class="text-lg font-medium" data-v-206e9703>No Video Sources Connected</p><p class="text-sm mt-2" data-v-206e9703>Connect HDMI cables to begin recording</p></div>',1)])])):(_(),w("div",nn,[u.value?(_(),w("div",on,[f[1]||(f[1]=e("svg",{class:"w-4 h-4 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),e("span",null,R(u.value),1)])):H("",!0),e("div",{class:"input-grid__container","data-count":h.value.length},[(_(!0),w(O,null,ve(h.value,$=>(_(),w("div",{key:$.id,class:U(["input-grid__tile",b($)]),style:Ve(p($.id)),title:T($)},[c.value?(_(),me(en,{key:0,"input-id":$.id,class:"w-full h-full",onVideoReady:F=>a($.id),onAspectRatio:F=>d($.id,F)},null,8,["input-id","onVideoReady","onAspectRatio"])):(_(),w("div",rn,[...f[2]||(f[2]=[e("div",{class:"text-center"},[e("svg",{class:"w-8 h-8 mx-auto mb-2 text-preke-text-dim/50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})]),e("span",{class:"text-xs text-preke-text-dim/70"},"Mixer mode")],-1)])])),e("div",ln,[e("div",cn,[e("div",un,[e("span",{class:U(["w-2 h-2 rounded-full transition-colors",{"bg-emerald-500":m($)==="excellent"||m($)==="good","bg-amber-500 animate-pulse":m($)==="unstable","bg-preke-text-dim":m($)==="none"}])},null,2),e("span",dn,R($.label),1)]),$.hasSignal?(_(),w("div",fn,[e("span",vn,R($.resolution),1),e("span",{class:U(x($))},R($.framerate)+"fps",3)])):H("",!0)])])],14,sn))),128))],8,an)]))}}),mn=re(pn,[["__scopeId","data-v-206e9703"]]),gn={key:0,class:"py-8 text-center text-preke-text-muted"},_n={key:1,class:"camera-setup"},hn={class:"camera-list"},bn={class:"list-header"},yn=["disabled"],wn={key:0,class:"empty-state"},kn={key:1,class:"camera-items"},Cn={class:"camera-item__info"},xn={class:"camera-item__header"},$n={class:"camera-item__name"},Rn={class:"camera-item__details"},Sn={class:"camera-item__type"},Mn={class:"camera-item__ip"},Tn={class:"camera-item__actions"},En=["onClick","disabled"],Pn={key:0,class:"btn-icon-sm",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Ln={key:1,class:"spinner"},An=["onClick","disabled"],Dn=["onClick","disabled"],Bn={key:0,class:"camera-form"},Nn={class:"form-header"},Hn={class:"form-title"},Wn={class:"form-content"},Fn={class:"form-group"},Un={class:"form-group"},Vn=["value"],jn={class:"form-group"},Gn={class:"form-group"},In=["placeholder"],On={class:"form-hint"},zn={class:"form-group"},qn={class:"form-checkbox"},Kn={class:"form-actions"},Yn={class:"flex items-center justify-between w-full"},Qn={key:0,class:"text-sm text-amber-400"},Xn={key:1,class:"text-sm text-preke-text-muted"},Jn={class:"flex gap-3"},Zn=["disabled"],eo=Q({__name:"CameraSetupModal",emits:["close","updated"],setup(n,{expose:t,emit:o}){const v=o,i=k(null),s=Ae(),l=k(!1),a=k(!1),d=k(null),p=k([]),c=k(null),h=[{value:"blackmagic",label:"Blackmagic Design Studio Camera 4K Pro"},{value:"obsbot_tail2",label:"OBSbot Tail 2"}],u=k({name:"",type:"blackmagic",ip:"",port:void 0,enabled:!0}),b={blackmagic:80,obsbot_tail2:52381},m=M(()=>c.value!==null),x=k(!1);async function L(){l.value=!0;try{const S=await ue.cameras.getConfig();p.value=S.cameras.map(g=>({name:g.name,type:g.type,ip:g.ip,port:g.port,enabled:g.enabled??!0})),x.value=!1}catch(S){console.error("[CameraSetup] Failed to load config:",S),s.error("Failed to load camera configuration")}finally{l.value=!1}}function T(){u.value={name:"",type:"blackmagic",ip:"",port:void 0,enabled:!0},c.value=null}function r(S){c.value=S,u.value={...p.value[S]}}function f(){T()}function $(){T(),c.value=-1}async function F(S){confirm(`Delete camera "${p.value[S].name}"?`)&&(p.value.splice(S,1),x.value=!0,await D())}async function te(S){d.value=S.name;try{(await ue.cameras.getStatus(S.name)).connected?s.success(`${S.name} is connected!`):s.warning(`${S.name} is not connected`)}catch{try{const E=await fetch(`http://${S.ip}:${S.port||b[S.type]}/`,{method:"HEAD",mode:"no-cors",signal:AbortSignal.timeout(3e3)});s.info(`${S.name}: IP ${S.ip} is reachable`)}catch{s.error(`${S.name}: Cannot reach ${S.ip}`)}}finally{d.value=null}}function X(){return u.value.name.trim()?u.value.ip.trim()?/^(\d{1,3}\.){3}\d{1,3}$/.test(u.value.ip)?p.value.findIndex((E,y)=>E.name===u.value.name&&y!==c.value)>=0?(s.error("Camera name already exists"),!1):!0:(s.error("Invalid IP address format"),!1):(s.error("Camera IP address is required"),!1):(s.error("Camera name is required"),!1)}function ie(){X()&&(u.value.port||(u.value.port=b[u.value.type]),c.value===-1?p.value.push({...u.value}):c.value!==null&&c.value>=0&&(p.value[c.value]={...u.value}),x.value=!0,T())}async function D(){a.value=!0;try{await ue.cameras.updateConfig(p.value),s.success("Camera configuration saved!"),x.value=!1,v("updated")}catch(S){console.error("[CameraSetup] Failed to save config:",S),s.error("Failed to save configuration: "+(S.message||"Unknown error"))}finally{a.value=!1}}function q(){var S;(S=i.value)==null||S.open(),L()}function A(){var S;x.value&&!confirm("You have unsaved changes. Close anyway?")||((S=i.value)==null||S.close(),T(),x.value=!1,v("close"))}return t({open:q,close:A}),ee(()=>{L()}),(S,g)=>(_(),me(Ie,{ref_key:"modalRef",ref:i,title:"Camera Setup",size:"xl",onClose:A},{header:ne(()=>[...g[5]||(g[5]=[e("div",{class:"flex items-center justify-between w-full"},[e("div",null,[e("h2",{class:"text-lg font-semibold text-preke-text"},"Camera Setup"),e("p",{class:"text-sm text-preke-text-muted mt-1"}," Configure external cameras for control ")])],-1)])]),footer:ne(()=>[e("div",Yn,[x.value?(_(),w("div",Qn," You have unsaved changes ")):(_(),w("div",Xn,R(p.value.length)+" camera"+R(p.value.length!==1?"s":"")+" configured ",1)),e("div",Jn,[e("button",{onClick:A,class:"btn-secondary"}," Close "),e("button",{onClick:D,disabled:!x.value||a.value,class:"btn-primary"},R(a.value?"Saving...":"Save Configuration"),9,Zn)])])]),default:ne(()=>[l.value?(_(),w("div",gn," Loading camera configuration... ")):(_(),w("div",_n,[e("div",hn,[e("div",bn,[g[7]||(g[7]=e("h3",{class:"list-title"},"Configured Cameras",-1)),e("button",{onClick:$,class:"btn-add",disabled:m.value},[...g[6]||(g[6]=[e("svg",{class:"btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),oe(" Add Camera ",-1)])],8,yn)]),p.value.length===0&&!m.value?(_(),w("div",wn,[...g[8]||(g[8]=[e("svg",{class:"empty-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})],-1),e("p",{class:"empty-text"},"No cameras configured",-1),e("p",{class:"empty-hint"},'Click "Add Camera" to get started',-1)])])):(_(),w("div",kn,[(_(!0),w(O,null,ve(p.value,(E,y)=>{var C;return _(),w("div",{key:y,class:U(["camera-item",{"camera-item--disabled":!E.enabled}])},[e("div",Cn,[e("div",xn,[e("span",$n,R(E.name),1),e("span",{class:U(["camera-item__badge",E.enabled?"camera-item__badge--enabled":"camera-item__badge--disabled"])},R(E.enabled?"Enabled":"Disabled"),3)]),e("div",Rn,[e("span",Sn,R(((C=h.find(W=>W.value===E.type))==null?void 0:C.label)||E.type),1),e("span",Mn,R(E.ip)+":"+R(E.port||b[E.type]),1)])]),e("div",Tn,[e("button",{onClick:W=>te(E),disabled:d.value===E.name,class:"btn-test",title:"Test Connection"},[d.value!==E.name?(_(),w("svg",Pn,[...g[9]||(g[9]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 10V3L4 14h7v7l9-11h-7z"},null,-1)])])):(_(),w("span",Ln))],8,En),e("button",{onClick:W=>r(y),disabled:m.value,class:"btn-edit",title:"Edit"},[...g[10]||(g[10]=[e("svg",{class:"btn-icon-sm",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})],-1)])],8,An),e("button",{onClick:W=>F(y),disabled:m.value,class:"btn-delete",title:"Delete"},[...g[11]||(g[11]=[e("svg",{class:"btn-icon-sm",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})],-1)])],8,Dn)])],2)}),128))]))]),m.value?(_(),w("div",Bn,[e("div",Nn,[e("h3",Hn,R(c.value===-1?"Add Camera":"Edit Camera"),1),e("button",{onClick:f,class:"btn-cancel-form"},"Cancel")]),e("div",Wn,[e("div",Fn,[g[12]||(g[12]=e("label",{class:"form-label"},"Camera Name *",-1)),K(e("input",{"onUpdate:modelValue":g[0]||(g[0]=E=>u.value.name=E),type:"text",class:"form-input",placeholder:"e.g., BMD Cam 1"},null,512),[[le,u.value.name]])]),e("div",Un,[g[13]||(g[13]=e("label",{class:"form-label"},"Camera Type *",-1)),K(e("select",{"onUpdate:modelValue":g[1]||(g[1]=E=>u.value.type=E),class:"form-input"},[(_(),w(O,null,ve(h,E=>e("option",{key:E.value,value:E.value},R(E.label),9,Vn)),64))],512),[[je,u.value.type]])]),e("div",jn,[g[14]||(g[14]=e("label",{class:"form-label"},"IP Address *",-1)),K(e("input",{"onUpdate:modelValue":g[2]||(g[2]=E=>u.value.ip=E),type:"text",class:"form-input",placeholder:"192.168.1.101"},null,512),[[le,u.value.ip]]),g[15]||(g[15]=e("p",{class:"form-hint"},"Camera's network IP address",-1))]),e("div",Gn,[g[16]||(g[16]=e("label",{class:"form-label"},"Port",-1)),K(e("input",{"onUpdate:modelValue":g[3]||(g[3]=E=>u.value.port=E),type:"number",class:"form-input",placeholder:String(b[u.value.type])},null,8,In),[[le,u.value.port,void 0,{number:!0}]]),e("p",On,"Default: "+R(b[u.value.type])+" for "+R(u.value.type),1)]),e("div",zn,[e("label",qn,[K(e("input",{"onUpdate:modelValue":g[4]||(g[4]=E=>u.value.enabled=E),type:"checkbox",class:"checkbox"},null,512),[[Ge,u.value.enabled]]),g[17]||(g[17]=e("span",null,"Enabled",-1))]),g[18]||(g[18]=e("p",{class:"form-hint"},"Disable to keep configuration but not use the camera",-1))]),e("div",Kn,[e("button",{onClick:ie,class:"btn-save-form"},R(c.value===-1?"Add Camera":"Update Camera"),1),e("button",{onClick:f,class:"btn-cancel-form"}," Cancel ")])])])):H("",!0)]))]),_:1},512))}}),to=re(eo,[["__scopeId","data-v-d42e0adf"]]),no={class:"sidebar"},oo={class:"sidebar__card sidebar__card--header"},ao={class:"connection-row"},so={class:"connection-status"},ro={class:"connection-label"},io={key:0,class:"connection-latency"},lo=["disabled"],co={class:"sidebar__card sidebar__card--recording"},uo={class:"recording__duration"},fo={class:"recording__meta"},vo={key:0,class:"sidebar__card sidebar__card--warning"},po={class:"warning__text"},mo={key:1,class:"sidebar__card sidebar__card--davinci"},go={class:"davinci__buttons"},_o=["disabled"],ho=["disabled"],bo=["disabled"],yo={class:"sidebar__card"},wo={key:0,class:"cameras"},ko={class:"camera__header"},Co=["onClick","disabled"],xo={key:1,class:"cameras-empty"},$o=Q({__name:"SessionInfoV2",setup(n){const t=De(),o=Y(),v=xe(),i=Ae(),{state:s,latencyMs:l}=Oe(),{connectionMethod:a}=ze(),d=M(()=>{const y=s.value==="connected",C=s.value==="connecting",W=s.value==="degraded";if(y){let P="";return a.value==="relay"?P="Relay":a.value==="p2p"?P="P2P":a.value==="local"&&(P="Local"),{status:"online",color:"green",label:P||"Connected",latency:l.value,pulse:!1}}return C?{status:"connecting",color:"amber",label:"Connecting...",latency:null,pulse:!0}:W?{status:"degraded",color:"amber",label:"Slow",latency:l.value,pulse:!1}:{status:"offline",color:"red",label:"Offline",latency:null,pulse:!0}}),p=M(()=>o.currentSession);M(()=>o.activeInputs);const c=M(()=>o.isRecording),h=M(()=>o.inputs.filter(y=>y.isRecording)),u=k("");ee(()=>{const C=new Date().toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,".");u.value=`Session ${C}`});const{cameras:b,loadCameras:m}=Xe(),x=k(null),L=k(null),T=k(null);ee(async()=>{await m()});function r(y){var C;x.value=y,(C=L.value)==null||C.open()}function f(){x.value=null}function $(){var y;(y=T.value)==null||y.open()}function F(){m()}const te=M(()=>{const y=v.capabilities;if(!y)return null;const C=y.storage_used_gb||0,W=y.storage_total_gb||1,P=W-C,B=Math.round(C/W*100),Be=P/10;return{freeGB:Math.round(P),totalGB:Math.round(W),percent:B,hoursRemaining:Math.round(Be*10)/10,isLow:B>85,isCritical:B>95}});function X(){t.push({name:"admin",query:{tab:"settings"}})}const ie=M(()=>qe()),D=k(!1),q=M(()=>{const y=p.value;return y!=null&&y.id?`Preke_${y.id}`:`Preke_${u.value.replace(/\s+/g,"_")}`}),A=window.electronAPI;async function S(){if(A!=null&&A.davinciOpenProject){D.value=!0,i.info("Opening DaVinci Resolve...");try{const y=await A.davinciOpenProject(q.value);y.success?i.success(`Opened project: ${y.projectName}`):i.error(y.error||"Failed to open DaVinci project")}catch(y){console.error("DaVinci error:",y),i.error("Failed to connect to DaVinci Resolve")}finally{D.value=!1}}}async function g(){if(A!=null&&A.davinciCreateMulticam){D.value=!0;try{A.davinciOpenProject&&await A.davinciOpenProject(q.value);const y=await A.davinciCreateMulticam({projectName:q.value,clipName:`Multicam_${u.value.replace(/\s+/g,"_")}`,syncMethod:"timecode"});y.success?i.success(`Created timeline: ${y.timelineName}`):i.error(y.error||"Failed to create multicam timeline")}catch(y){console.error("DaVinci error:",y),i.error("Failed to create multicam timeline")}finally{D.value=!1}}}async function E(){if(A!=null&&A.davinciRefreshClips){D.value=!0,i.info("Refreshing growing clips...");try{const y=await A.davinciRefreshClips();if(y.success){const C=y.clipsRefreshed||0;i.success(`Refreshed ${C} clip${C!==1?"s":""}`)}else i.error(y.error||"Failed to refresh clips")}catch(y){console.error("DaVinci refresh error:",y),i.error("Failed to refresh clips")}finally{D.value=!1}}}return(y,C)=>{var W;return _(),w("div",no,[e("div",oo,[e("div",ao,[e("div",so,[e("span",{class:U(["connection-dot",[`connection-dot--${d.value.color}`,{"connection-dot--pulse":d.value.pulse}]])},null,2),e("span",ro,R(d.value.label),1),d.value.latency?(_(),w("span",io,R(d.value.latency)+"ms ",1)):H("",!0)])]),C[1]||(C[1]=e("div",{class:"sidebar__divider"},null,-1)),C[2]||(C[2]=e("label",{class:"sidebar__label"},"Session Name",-1)),K(e("input",{"onUpdate:modelValue":C[0]||(C[0]=P=>u.value=P),type:"text",class:"sidebar__input",placeholder:"Session 06.01.2026",disabled:c.value},null,8,lo),[[le,u.value]])]),c.value?(_(),w(O,{key:0},[e("div",co,[C[3]||(C[3]=e("div",{class:"recording__header"},[e("span",{class:"recording__dot"}),e("span",{class:"recording__label"},"Recording")],-1)),e("div",uo,R(ae(o).formattedDuration),1),e("div",fo,R(h.value.length)+" camera"+R(h.value.length!==1?"s":"")+" recording ",1)]),(W=te.value)!=null&&W.isLow?(_(),w("div",vo,[C[5]||(C[5]=e("span",{class:"warning__icon"},"⚠️",-1)),e("div",po,[C[4]||(C[4]=e("strong",null,"Low storage",-1)),e("span",null,R(te.value.freeGB)+" GB remaining",1)])])):H("",!0),ie.value?(_(),w("div",mo,[C[6]||(C[6]=Le('<div class="davinci__header" data-v-a373edd4><svg class="davinci__icon" viewBox="0 0 24 24" fill="currentColor" data-v-a373edd4><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" data-v-a373edd4></path></svg><span class="davinci__label" data-v-a373edd4>DaVinci Resolve</span></div><p class="davinci__hint" data-v-a373edd4>Edit while recording (mount R58 recordings via SMB)</p>',2)),e("div",go,[e("button",{onClick:S,disabled:D.value,class:"davinci__btn"},R(D.value?"Opening...":"Open Project"),9,_o),e("button",{onClick:g,disabled:D.value,class:"davinci__btn davinci__btn--secondary"}," Create Multicam ",8,ho),e("button",{onClick:E,disabled:D.value,class:"davinci__btn davinci__btn--secondary",title:"Refresh growing clips to update duration"},R(D.value?"Refreshing...":"Refresh Clips"),9,bo)])])):H("",!0)],64)):(_(),w(O,{key:1},[e("div",yo,[e("div",{class:"sidebar__label"},[C[8]||(C[8]=oe(" Camera Controls ",-1)),e("button",{onClick:$,class:"camera-setup-btn",title:"Setup Cameras"},[...C[7]||(C[7]=[e("svg",{class:"camera-setup-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("circle",{cx:"12",cy:"12",r:"3"})],-1)])])]),ae(b).length>0?(_(),w("div",wo,[(_(!0),w(O,null,ve(ae(b),P=>(_(),w("div",{key:P.name,class:"camera"},[e("div",ko,[oe(R(P.name)+" ",1),e("span",{class:U(["camera__status",P.connected?"camera__status--connected":"camera__status--disconnected"])},R(P.connected?"●":"○"),3)]),e("button",{class:"camera__control-btn",onClick:B=>r(P.name),disabled:!P.connected},[...C[9]||(C[9]=[e("svg",{class:"camera__control-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("circle",{cx:"12",cy:"12",r:"3"})],-1),e("span",null,"Controls",-1)])],8,Co)]))),128))])):(_(),w("div",xo,[C[10]||(C[10]=e("p",{class:"cameras-empty__text"},"No cameras configured",-1)),e("button",{onClick:$,class:"cameras-empty__btn"}," Setup Cameras ")]))]),j(Je,{ref_key:"cameraModalRef",ref:L,"camera-name":x.value,onClose:f},null,8,["camera-name"]),j(to,{ref_key:"cameraSetupModalRef",ref:T,onUpdated:F},null,512),e("div",{class:"sidebar__card"},[C[12]||(C[12]=e("div",{class:"sidebar__label"},"Quick Actions",-1)),e("button",{onClick:X,class:"sidebar__btn"},[...C[11]||(C[11]=[e("svg",{class:"sidebar__btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","stroke-width":"1.8"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("circle",{cx:"12",cy:"12",r:"3"})],-1),oe(" Configure Inputs ",-1)])])])],64))])}}}),Ro=re($o,[["__scopeId","data-v-a373edd4"]]),So={class:"h-full flex flex-col"},Mo={class:"recorder-header"},To={class:"recorder-header__left"},Eo={class:"recorder-header__title"},Po={key:0,class:"recorder-header__badge"},Lo={class:"flex-1 flex min-h-0 overflow-hidden"},Ao={class:"flex-1 min-h-0 min-w-0 p-3 overflow-hidden"},Do={class:"w-72 flex-shrink-0 border-l border-preke-surface-border bg-preke-surface/80 backdrop-blur-lg p-4 overflow-y-auto"},Bo=Q({__name:"RecorderView",setup(n){const t=De(),o=Y(),v=xe(),{showLeaveConfirmation:i,confirmLeave:s,cancelLeave:l}=et();function a(){t.push("/")}const d=M(()=>o.status==="recording"),p=M(()=>o.formattedDuration),c=k(!0),h=k(!1),u=k(!1),b=M(()=>h.value&&u.value);function m(){c.value=!1}async function x(){var f;if(!Ke())return;await v.fetchCapabilities();const r=(f=v.capabilities)==null?void 0:f.current_mode;if(r&&r!=="recorder"){console.log("[Recorder] Not in recorder mode, switching...");try{(await fetch(await Ye("/api/mode/recorder"),{method:"POST"})).ok&&(await v.fetchCapabilities(),J.success("Switched to Recorder mode"))}catch($){console.warn("[Recorder] Failed to switch mode:",$)}}}function L(){console.log("[Recorder] All videos ready!"),u.value=!0}ee(async()=>{const r=performance.now();await Promise.all([x(),o.fetchInputs(),o.fetchStatus()]);const f=o.inputs.filter($=>$.hasSignal).length;console.log(`[Recorder] Data loaded: ${o.inputs.length} inputs, ${f} with signal (${Math.round(performance.now()-r)}ms)`),h.value=!0,f===0&&(u.value=!0)});const T=k(null);return z(i,r=>{var f,$;r?(f=T.value)==null||f.open():($=T.value)==null||$.close()}),(r,f)=>(_(),w(O,null,[j(Ce,{name:"fade"},{default:ne(()=>[c.value?(_(),me(Ze,{key:0,mode:"recorder","content-ready":b.value,"min-time":1500,"max-time":5e3,"show-cancel":!0,onReady:m,onCancel:a},null,8,["content-ready"])):H("",!0)]),_:1}),j(Ce,{name:"content-fade"},{default:ne(()=>[K(e("div",So,[e("header",Mo,[e("div",To,[e("div",Eo,[e("span",{class:U(["recorder-header__indicator",{"recorder-header__indicator--active":d.value}])},null,2),f[0]||(f[0]=e("span",{class:"recorder-header__label"},"Recorder",-1))]),d.value?(_(),w("span",Po," REC ")):H("",!0),j(Bt)]),j($t)]),e("div",Lo,[e("div",Ao,[j(mn,{onAllVideosReady:L})]),e("aside",Do,[j(Ro)])]),j(Ee,{ref_key:"leaveDialog",ref:T,title:"Recording in Progress",message:`You are currently recording (${p.value}). Leaving will stop the recording and save all files.`,"confirm-text":"Leave and Stop Recording","cancel-text":"Stay",danger:!0,onConfirm:ae(s),onCancel:ae(l)},null,8,["message","onConfirm","onCancel"])],512),[[Qe,!c.value]])]),_:1})],64))}}),Wo=re(Bo,[["__scopeId","data-v-a7fdeea3"]]);export{Wo as default};
