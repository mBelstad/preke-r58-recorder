import{D as F,E as N,o as K,l as ne,G as Be,r as C,j as x,H as De,d as I,I as pe,m as D,T as de,p as fe,c as y,f as M,z as We,e as t,w as ge,A as Ce,t as $,J as Ne,i as b,_ as Y,K as He,h as G,F as H,n as T,x as q,L as $e,q as ee,M as te,N as xe,u as me,a as Fe,y as ve,O as Ue,P as Ge,B as Ve,g as Se,Q as Ie,b as je,v as Oe}from"./index-ByV_i8IW.js";import{M as ze}from"./ModeLoadingScreen-BwyCPbkH.js";const O=C(!1),X=C(!1);let z=null;function qe(){const n=F();N(()=>n.status,l=>{O.value=l==="recording"},{immediate:!0});function e(l){if(O.value)return l.preventDefault(),l.returnValue="Recording in progress. Are you sure you want to leave?",l.returnValue}K(()=>{window.addEventListener("beforeunload",e)}),ne(()=>{window.removeEventListener("beforeunload",e)}),Be((l,u,r)=>{O.value?(z=()=>r(),X.value=!0,r(!1)):r()});function o(){X.value=!1,O.value=!1,n.stopRecording().finally(()=>{z&&(z(),z=null)})}function p(){X.value=!1,z=null}return{isGuardActive:O,showLeaveConfirmation:X,confirmLeave:o,cancelLeave:p}}const R=C(null),se=C(!1),we=C(null),ae=C(null),Ke=10,re=2,Ye=25;function Qe(){const n=x(()=>R.value?R.value.available_gb<re?"critical":R.value.available_gb<Ke?"warning":"ok":"unknown"),e=x(()=>R.value?R.value.available_gb>=re:!0),o=x(()=>{if(!R.value)return null;const a=R.value.available_gb*1024*1024*1024,f=Ye*1024*1024,w=a/f,d=Math.floor(w/3600),g=Math.floor(w%3600/60);return d>24?`${Math.floor(d/24)}d ${d%24}h`:d>0?`${d}h ${g}m`:`${g}m`}),p=x(()=>{switch(n.value){case"ok":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}}),l=x(()=>R.value?n.value==="critical"?`Disk space critically low (${R.value.available_gb.toFixed(1)} GB). Cannot start recording.`:n.value==="warning"?`Low disk space (${R.value.available_gb.toFixed(1)} GB). Estimated recording time: ${o.value}`:null:null);async function u(){se.value=!0,ae.value=null;try{const a=await De.getDegradation();if(a.resources&&a.resources.disk_free_gb!==void 0){const f=a.resources.disk_free_gb,w=f*3;R.value={available_gb:f,total_gb:w,used_percent:100-f/w*100,recording_path:"/opt/r58-app/shared/recordings"}}return we.value=new Date,R.value}catch(a){return ae.value=a.message||"Failed to check disk space",console.error("Failed to check disk space:",a),null}finally{se.value=!1}}async function r(){return await u(),R.value?n.value==="critical"?{ok:!1,message:`Insufficient disk space (${R.value.available_gb.toFixed(1)} GB). Need at least ${re} GB to start recording.`}:n.value==="warning"?{ok:!0,message:`Low disk space warning: ${R.value.available_gb.toFixed(1)} GB available. Estimated recording time: ${o.value}`}:{ok:!0}:{ok:!0,message:"Could not verify disk space. Proceeding with caution."}}return{diskSpace:R,isLoading:se,lastCheck:we,error:ae,status:n,statusColor:p,canStartRecording:e,estimatedRecordingTime:o,warningMessage:l,checkDiskSpace:u,preflightCheck:r}}const L=C(localStorage.getItem("r58_audio_feedback")!=="false");let ie=null;function Xe(){return ie||(ie=new(window.AudioContext||window.webkitAudioContext)),ie}function A(n,e,o="sine",p=.3){if(L.value)try{const l=Xe();l.state==="suspended"&&l.resume();const u=l.createOscillator(),r=l.createGain();u.connect(r),r.connect(l.destination),u.type=o,u.frequency.value=n;const a=l.currentTime;r.gain.setValueAtTime(0,a),r.gain.linearRampToValueAtTime(p,a+.01),r.gain.linearRampToValueAtTime(0,a+e),u.start(a),u.stop(a+e)}catch(l){console.warn("Audio feedback failed:",l)}}function Je(){L.value&&(A(440,.1,"sine",.2),setTimeout(()=>A(554,.1,"sine",.2),100),setTimeout(()=>A(659,.15,"sine",.25),200))}function Ze(){L.value&&(A(880,.08,"sine",.3),setTimeout(()=>A(880,.15,"sine",.3),120))}function et(){L.value&&(A(659,.1,"sine",.25),setTimeout(()=>A(554,.1,"sine",.2),100),setTimeout(()=>A(440,.15,"sine",.2),200))}function tt(){L.value&&(A(200,.15,"square",.15),setTimeout(()=>A(180,.2,"square",.15),180))}function nt(){L.value&&(A(1e3,.08,"sine",.2),setTimeout(()=>A(1e3,.08,"sine",.2),150))}function ye(){L.value&&A(1200,.03,"sine",.1)}function ot(n=50){if(L.value&&"vibrate"in navigator)try{navigator.vibrate(n)}catch{}}function st(){function n(o){L.value=o,localStorage.setItem("r58_audio_feedback",String(o))}function e(){n(!L.value),L.value&&ye()}return{enabled:L,setEnabled:n,toggle:e,playSuccess:Je,playError:tt,playWarning:nt,playClick:ye,playRecordStart:Ze,playRecordStop:et,vibrate:ot}}const at={class:"bg-preke-bg-elevated rounded-lg shadow-xl max-w-md w-full p-6"},rt=["placeholder"],it={class:"text-xs text-preke-text-dim mt-2"},lt=I({__name:"SessionNameDialog",props:{open:{type:Boolean},suggestedName:{}},emits:["confirm","cancel","skip"],setup(n,{emit:e}){const o=n,p=e,l=C(""),u=C(null),r=x(()=>{const k=new Date,m=k.toLocaleDateString("en-CA"),v=k.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}).replace(":","");return`Recording_${m}_${v}`}),a=x(()=>o.suggestedName||r.value);N(()=>o.open,k=>{k&&(l.value=a.value,setTimeout(()=>{var m,v;(m=u.value)==null||m.focus(),(v=u.value)==null||v.select()},100))});function f(){p("confirm",l.value.trim()||a.value)}function w(){p("skip")}function d(){p("cancel")}function g(k){k.key==="Enter"?f():k.key==="Escape"&&d()}return(k,m)=>(b(),pe(Ne,{to:"body"},[D(de,{name:"fade"},{default:fe(()=>[n.open?(b(),y("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:We(d,["self"]),onKeydown:g},[t("div",at,[m[1]||(m[1]=t("h2",{class:"text-lg font-semibold mb-2"},"Name This Recording",-1)),m[2]||(m[2]=t("p",{class:"text-preke-text-dim text-sm mb-4"}," Give your recording a name to find it easily later (optional). ",-1)),ge(t("input",{ref_key:"inputRef",ref:u,"onUpdate:modelValue":m[0]||(m[0]=v=>l.value=v),type:"text",placeholder:a.value,class:"w-full px-4 py-2 bg-preke-bg-surface border border-preke-bg-surface rounded-lg text-preke-text placeholder-preke-text-dim focus:outline-none focus:ring-2 focus:ring-preke-gold"},null,8,rt),[[Ce,l.value]]),t("p",it," Suggested: "+$(a.value),1),t("div",{class:"flex justify-between mt-6"},[t("button",{onClick:w,class:"text-sm text-preke-text-dim hover:text-preke-text transition-colors"}," Skip (use default) "),t("div",{class:"flex gap-3"},[t("button",{onClick:d,class:"btn"}," Cancel "),t("button",{onClick:f,class:"btn btn-primary"}," Start Recording ")])])])],32)):M("",!0)]),_:1})]))}}),ct=Y(lt,[["__scopeId","data-v-2eeca4e8"]]),ut={class:"recorder-controls"},dt={key:0,class:"recorder-controls__duration"},ft=["disabled","title"],vt={key:0,class:"recorder-controls__spinner"},pt={key:0,class:"recorder-controls__icon recorder-controls__icon--stop"},gt={key:1,class:"recorder-controls__icon recorder-controls__icon--record"},mt={class:"recorder-controls__hint"},_t=I({__name:"RecorderControls",setup(n){const e=F(),{register:o}=He(),{preflightCheck:p,status:l,canStartRecording:u}=Qe(),{playRecordStart:r,playRecordStop:a,playError:f,playWarning:w,vibrate:d}=st(),g=C(null),k=C(!1),m=C(!1),v=C(!1),c=C(!1),S=C(void 0),i=x(()=>e.status==="recording"),s=x(()=>e.status==="starting"),_=x(()=>e.status==="stopping"),h=x(()=>e.formattedDuration),B=x(()=>s.value||_.value||m.value),U=x(()=>s.value?"Starting recording...":_.value?"Stopping recording...":m.value?"Checking disk space...":!i.value&&!u.value?"Insufficient disk space":"");let oe=null;K(()=>{oe=o({key:" ",description:"Toggle Recording",action:Re,context:"recorder",enabled:()=>!s.value&&!_.value})}),ne(()=>{oe&&oe()});async function Re(){i.value?be():await Q()}async function Q(E){m.value=!0;try{const P=await p();if(!P.ok){f(),d(200),G.error("Cannot start recording",P.message||"Preflight check failed");return}if(P.message&&l.value==="warning"&&(w(),G.warning("Low disk space",P.message)),c.value&&!E){S.value=void 0,v.value=!0;return}await he(E||S.value)}finally{m.value=!1}}async function he(E){try{await e.startRecording(E);const P=E||e.sessionId;r(),d([50,30,50]),G.success("Recording started",`Session: ${P}`)}catch(P){f(),d(200),G.error("Failed to start recording",P.message||"Unknown error",{label:"Retry",onClick:()=>Q(E)})}}function Te(E){v.value=!1,S.value=E,Q(E)}function Me(){v.value=!1,S.value=void 0,Q()}function Ee(){v.value=!1,m.value=!1}async function Pe(){try{await e.stopRecording(),a(),d(100),G.success("Recording stopped",`Duration: ${h.value}`)}catch(E){f(),d(200),G.error("Failed to stop recording",E.message||"Unknown error")}}function be(){var E;k.value=!1,(E=g.value)==null||E.open(),setTimeout(()=>{k.value=!0},500)}function Ae(){k.value&&Pe()}async function Le(){i.value?be():await he()}return(E,P)=>(b(),y(H,null,[t("div",ut,[i.value?(b(),y("div",dt,$(h.value),1)):M("",!0),t("button",{onClick:Le,disabled:B.value,class:T(["recorder-controls__btn",i.value?"recorder-controls__btn--stop":"recorder-controls__btn--start"]),title:U.value||(i.value?"Stop Recording (Space)":"Start Recording (Space)")},[s.value||_.value||m.value?(b(),y("span",vt)):(b(),y(H,{key:1},[i.value?(b(),y("span",pt)):(b(),y("span",gt))],64)),t("span",null,$(m.value?"Checking...":i.value?"Stop":"Start Recording"),1)],10,ft),t("span",mt,[P[0]||(P[0]=q(" Press ",-1)),P[1]||(P[1]=t("kbd",null,"Space",-1)),q(" to "+$(i.value?"stop":"start"),1)])]),D($e,{ref_key:"stopConfirmDialog",ref:g,title:"Stop Recording?",message:`You have been recording for ${h.value}. This will finalize all files.`,"confirm-text":"Stop Recording","cancel-text":"Keep Recording",danger:!0,onConfirm:Ae},null,8,["message"]),D(ct,{open:v.value,onConfirm:Te,onSkip:Me,onCancel:Ee},null,8,["open"])],64))}}),ht=Y(_t,[["__scopeId","data-v-38c04e0c"]]),J=C(localStorage.getItem("r58_performance_mode")==="true"),le=C(localStorage.getItem("r58_performance_mode_auto")!=="false"),bt=3,wt=100,yt=500;function kt(){const n=F(),e=x(()=>J.value?!0:le.value&&n.isRecording?n.inputs.filter(g=>g.isRecording).length>=bt:!1),o=x(()=>e.value?yt:wt);N(e,d=>{d?document.body.classList.add("performance-mode"):document.body.classList.remove("performance-mode")},{immediate:!0});function p(d){J.value=d,localStorage.setItem("r58_performance_mode",String(d))}function l(d){le.value=d,localStorage.setItem("r58_performance_mode_auto",String(d))}function u(){p(!J.value)}function r(d,g){let k=0,m=null;return(...v)=>{const c=Date.now(),S=g??o.value,i=c-k;i>=S?(k=c,d(...v)):m||(m=window.setTimeout(()=>{k=Date.now(),m=null,d(...v)},S-i))}}function a(d,g){let k=null;return(...m)=>{k&&clearTimeout(k),k=window.setTimeout(()=>{d(...m),k=null},g??o.value)}}function f(d){return e.value?window.setTimeout(()=>d(performance.now()),o.value):requestAnimationFrame(d)}function w(d){e.value?clearTimeout(d):cancelAnimationFrame(d)}return{enabled:J,autoEnable:le,isActive:e,updateInterval:o,setEnabled:p,setAutoEnable:l,toggle:u,throttle:r,debounce:a,requestFrame:f,cancelFrame:w}}const Ct=["title"],$t={class:"flex items-center gap-1.5 text-sm"},xt={key:0,class:"flex items-center gap-1.5 text-sm"},St={key:1,class:"flex items-center gap-1.5 text-sm text-red-400"},Rt={class:"font-mono"},Tt=I({__name:"RecordingHealth",setup(n,{expose:e}){const o=F(),{isActive:p}=kt(),l=C({}),u=C(0),r=C(0),a=C(0);let f=null;function w(){const v={};let c=0;o.inputs.forEach(i=>{v[i.id]=i.bytesWritten;const s=l.value[i.id]||0;c+=i.bytesWritten-s});const S=p.value?2:1;u.value=Math.round(c/(1024*1024)/S*10)/10,l.value=v}N(()=>o.isRecording,v=>{if(v){l.value={},u.value=0,r.value=0,a.value=0;const c=p.value?2e3:1e3;f=window.setInterval(w,c)}else f&&(clearInterval(f),f=null)},{immediate:!0}),N(p,v=>{if(o.isRecording&&f){clearInterval(f);const c=v?2e3:1e3;f=window.setInterval(w,c)}}),ne(()=>{f&&clearInterval(f)});const d=x(()=>o.isRecording?a.value>0||r.value>90?"critical":u.value<1||r.value>70?"warning":"healthy":"idle"),g=x(()=>{switch(d.value){case"healthy":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}});x(()=>{switch(d.value){case"healthy":return"Healthy";case"warning":return"Warning";case"critical":return"Critical";default:return"Idle"}});const k=x(()=>{if(!o.isRecording)return"Not recording";const v=[`Write speed: ${u.value} MB/s`,`Buffer: ${r.value}%`];return a.value>0&&v.push(`Frames dropped: ${a.value}`),v.join(`
`)});function m(v){v.buffer_percent!==void 0&&(r.value=v.buffer_percent),v.frames_dropped!==void 0&&(a.value=v.frames_dropped)}return e({updateFromMetrics:m}),(v,c)=>ee(o).isRecording?(b(),y("div",{key:0,class:T(["flex items-center gap-3 px-3 py-1.5 rounded-lg transition-colors cursor-help",{"bg-emerald-500/10":g.value==="emerald","bg-amber-500/10":g.value==="amber","bg-red-500/10":g.value==="red"}]),title:k.value},[t("span",{class:T(["w-2 h-2 rounded-full",g.value==="emerald"?"bg-emerald-500":"",g.value==="amber"?"bg-amber-500 animate-pulse":"",g.value==="red"?"bg-red-500 animate-pulse":""])},null,2),t("div",$t,[c[0]||(c[0]=t("svg",{class:"w-3.5 h-3.5 text-preke-text-dim",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})],-1)),t("span",{class:T(["font-mono",g.value==="emerald"?"text-emerald-400":"",g.value==="amber"?"text-amber-400":"",g.value==="red"?"text-red-400":""])},$(u.value)+" MB/s ",3)]),r.value>0?(b(),y("div",xt,[c[1]||(c[1]=t("span",{class:"text-preke-text-dim"},"Buf:",-1)),t("span",{class:T(["font-mono",r.value<50?"text-emerald-400":"",r.value>=50&&r.value<80?"text-amber-400":"",r.value>=80?"text-red-400":""])},$(r.value)+"% ",3)])):M("",!0),a.value>0?(b(),y("div",St,[c[2]||(c[2]=t("svg",{class:"w-3.5 h-3.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),t("span",Rt,$(a.value)+" dropped",1)])):M("",!0)],10,Ct)):M("",!0)}}),Mt=["65.109.32.111"],Et=5,Pt=1e3,At=3e4,Lt=()=>typeof window<"u"&&window.__NETWORK_DEBUG__===!0,ke=new Map,Bt=1e3;function Z(n,e,...o){if(!Lt())return;const p=Date.now(),l=ke.get(n)||0;p-l<Bt||(ke.set(n,p),console.log(`[NETWORK DEBUG ${n}] ${e}`,...o))}const W=new Map,j=new Map;function Dt(n){const e=te(),o=xe();if(e&&!o)try{return`http://${new URL(e).hostname}:8889/${n}/whep`}catch{console.warn("[WHEP Manager] Invalid device URL, falling back to FRP")}return`https://r58-mediamtx.itagenten.no/${n}/whep`}async function Wt(n,e){const o=W.get(e);if(!o)return"unknown";try{const u=new URL(o.whepUrl).hostname;if(u.includes("itagenten.no"))return console.log(`[WHEP Manager ${e}] Detected relay (FRP URL)`),"relay";if(u.startsWith("100."))return console.log(`[WHEP Manager ${e}] Detected P2P (Tailscale IP: ${u})`),"p2p";if(u.startsWith("192.168.")||u.startsWith("10.")||u.startsWith("172."))return console.log(`[WHEP Manager ${e}] Detected P2P (LAN IP: ${u})`),"p2p"}catch(l){console.warn(`[WHEP Manager ${e}] Failed to parse WHEP URL:`,l)}try{const l=await n.getStats();for(const u of l.values())if(u.type==="candidate-pair"&&u.state==="succeeded"){const r=l.get(u.remoteCandidateId);if((r==null?void 0:r.candidateType)==="relay")return console.log(`[WHEP Manager ${e}] Detected relay (TURN candidate)`),"relay";const a=r==null?void 0:r.address;if(a&&Mt.includes(a))return console.log(`[WHEP Manager ${e}] Detected relay (VPS IP: ${a})`),"relay"}}catch(l){console.warn(`[WHEP Manager ${e}] Failed to get WebRTC stats:`,l)}return te()&&!xe()?(console.log(`[WHEP Manager ${e}] Assuming P2P (direct device URL configured)`),"p2p"):"unknown"}function V(n){const e=W.get(n);if(!e)return;const o=j.get(n);o&&o.forEach(p=>p(e))}function ce(n){const e=W.get(n);if(!e)return;if(e.reconnectAttempts>=Et){console.error(`[WHEP Manager ${n}] Max reconnect attempts reached`),e.state="failed",V(n);return}e.reconnectAttempts++;const o=Math.min(Pt*Math.pow(2,e.reconnectAttempts-1),At),p=o*.2*(Math.random()*2-1),l=Math.max(100,Math.round(o+p));Z("WHEP",`Camera ${n}: Reconnect #${e.reconnectAttempts} in ${l}ms (base: ${o}ms)`),console.log(`[WHEP Manager ${n}] Scheduling reconnect #${e.reconnectAttempts} in ${l}ms`),e.state="connecting",V(n),e.reconnectTimeout&&clearTimeout(e.reconnectTimeout),e.reconnectTimeout=setTimeout(()=>{_e(n)},l)}async function _e(n){let e=W.get(n);if(e&&(e.state==="connected"||e.state==="connecting"))return console.log(`[WHEP Manager ${n}] Reusing existing connection (state: ${e.state})`),e;if(e!=null&&e.isConnecting){for(Z("WHEP",`Camera ${n}: Connection already in progress, skipping duplicate attempt`),console.log(`[WHEP Manager ${n}] Connection already in progress, waiting...`);e.isConnecting&&e.state==="connecting"&&(await new Promise(a=>setTimeout(a,100)),e=W.get(n),!!e););if(e)return e}let o=te(),p=0;for(;!o&&p<5;)console.log(`[WHEP Manager ${n}] No device URL yet, waiting... (attempt ${p+1})`),await new Promise(a=>setTimeout(a,100)),o=te(),p++;const l=performance.now(),u=Dt(n);Z("WHEP",`Camera ${n}: Creating connection to ${u}`),console.log(`[WHEP Manager ${n}] Creating connection to: ${u}`),console.log(`[WHEP Manager ${n}] Device URL was: ${o}`),e!=null&&e.peerConnection&&e.peerConnection.close(),e!=null&&e.disconnectedTimeout&&(clearTimeout(e.disconnectedTimeout),e.disconnectedTimeout=null),e&&(e.isConnecting=!0);const r=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}]});e?(e.peerConnection=r,e.state="connecting",e.whepUrl=u,e.mediaStream=null,e.connectionType="unknown",e.connectionStartTime=l,e.isConnecting=!0):(e={cameraId:n,peerConnection:r,mediaStream:null,state:"connecting",connectionType:"unknown",refCount:0,whepUrl:u,lastConnectedAt:null,reconnectAttempts:0,reconnectTimeout:null,disconnectedTimeout:null,connectionStartTime:l,isConnecting:!0},W.set(n,e)),r.ontrack=a=>{a.streams[0]&&(e.mediaStream=a.streams[0],console.log(`[WHEP Manager ${n}] Received media stream`),V(n))},r.oniceconnectionstatechange=async()=>{const a=r.iceConnectionState;if(Z("WHEP",`Camera ${n}: ICE state changed to ${a}`),console.log(`[WHEP Manager ${n}] ICE state: ${a}`),a==="connected"||a==="completed"){e.state="connected",e.lastConnectedAt=Date.now(),e.reconnectAttempts=0,e.isConnecting=!1,e.connectionType=await Wt(r,n),e.disconnectedTimeout&&(clearTimeout(e.disconnectedTimeout),e.disconnectedTimeout=null);const f=e.connectionStartTime?Math.round(performance.now()-e.connectionStartTime):0;console.log(`[WHEP Manager ${n}] Connected (${e.connectionType}) in ${f}ms`),V(n)}else a==="failed"?(e.state="failed",e.connectionType="unknown",e.isConnecting=!1,V(n),e.refCount>0&&ce(n)):a==="disconnected"&&(e.disconnectedTimeout&&clearTimeout(e.disconnectedTimeout),e.disconnectedTimeout=setTimeout(()=>{(r.iceConnectionState==="disconnected"||r.iceConnectionState==="failed")&&(e.state="disconnected",e.isConnecting=!1,V(n),e.refCount>0&&ce(n)),e.disconnectedTimeout=null},3e3))},r.addTransceiver("video",{direction:"recvonly"}),r.addTransceiver("audio",{direction:"recvonly"});try{const a=await r.createOffer();await r.setLocalDescription(a);const f=await fetch(u,{method:"POST",headers:{"Content-Type":"application/sdp"},body:a.sdp});if(!f.ok)throw new Error(`WHEP request failed: ${f.status}`);const w=await f.text();await r.setRemoteDescription({type:"answer",sdp:w})}catch(a){console.error(`[WHEP Manager ${n}] Connection error:`,a),e.state="failed",e.isConnecting=!1,V(n),e.refCount>0&&ce(n)}return e}async function Nt(n,e){j.has(n)||j.set(n,new Set),j.get(n).add(e);let o=W.get(n);return(!o||o.state==="failed"||o.state==="disconnected")&&(o=await _e(n)),o.refCount++,console.log(`[WHEP Manager ${n}] Acquired connection (refCount: ${o.refCount})`),e(o),o}function Ht(n,e){const o=W.get(n);if(!o)return;const p=j.get(n);p&&(p.delete(e),p.size===0&&j.delete(n)),o.refCount=Math.max(0,o.refCount-1),console.log(`[WHEP Manager ${n}] Released connection (refCount: ${o.refCount})`),o.refCount===0&&(console.log(`[WHEP Manager ${n}] Closing unused connection`),o.reconnectTimeout&&clearTimeout(o.reconnectTimeout),o.disconnectedTimeout&&clearTimeout(o.disconnectedTimeout),o.peerConnection.close(),W.delete(n))}function ue(n){const e=W.get(n);e&&(console.log(`[WHEP Manager ${n}] Force reconnecting...`),e.reconnectAttempts=0,_e(n))}const Ft={class:"relative w-full h-full bg-black"},Ut=["title"],Gt={key:1,class:"absolute inset-0 flex items-center justify-center bg-black/50"},Vt={key:2,class:"absolute inset-0 flex items-center justify-center bg-black/70"},It={class:"text-center"},jt={class:"text-xs text-amber-400"},Ot={key:3,class:"absolute inset-0 flex items-center justify-center bg-black/80"},zt={class:"text-center text-preke-text-dim"},qt={class:"text-sm"},Kt=I({__name:"InputPreview",props:{inputId:{},protocol:{}},emits:["videoReady"],setup(n,{emit:e}){const o=n,p=e,l=F();let u=!1;const r=x(()=>l.status==="recording"),a=C(null),f=C(!0),w=C(null),d=C("unknown"),g=C(!1),k=C(0);let m=null;function v(s){switch(console.log(`[InputPreview ${o.inputId}] Connection update:`,{state:s.state,type:s.connectionType,hasStream:!!s.mediaStream}),d.value=s.connectionType,k.value=s.reconnectAttempts,s.state){case"connecting":f.value=!0,w.value=null,g.value=s.reconnectAttempts>0;break;case"connected":f.value=!1,w.value=null,g.value=!1,s.mediaStream&&a.value&&a.value.srcObject!==s.mediaStream&&(a.value.srcObject=s.mediaStream,a.value.play().catch(_=>{console.warn(`[InputPreview ${o.inputId}] Autoplay prevented:`,_)}),u||(a.value.onloadeddata=()=>{u||(u=!0,console.log(`[InputPreview ${o.inputId}] Video ready (first frame displayed)`),p("videoReady"))}));break;case"disconnected":g.value=!0,w.value=`Reconnecting... (${s.reconnectAttempts}/5)`;break;case"failed":f.value=!1,g.value=!1,w.value="Connection failed after multiple attempts";break}}async function c(){if(a.value){i(),f.value=!0,w.value=null,m=v;try{await Nt(o.inputId,m)}catch(s){console.error(`[InputPreview ${o.inputId}] Failed to acquire connection:`,s),w.value=s instanceof Error?s.message:"Failed to connect",f.value=!1}}}function S(){ue(o.inputId)}function i(){m&&(Ht(o.inputId,m),m=null)}return K(()=>{c()}),N(()=>o.inputId,()=>{c()}),N(r,(s,_)=>{_&&!s&&w.value?(console.log("[InputPreview] Recording stopped, reconnecting preview..."),ue(o.inputId)):!_&&s&&(console.log("[InputPreview] Recording started, will try to reconnect preview after delay..."),setTimeout(()=>{r.value&&(console.log("[InputPreview] Attempting to reconnect preview during recording..."),ue(o.inputId))},2e3))}),ne(()=>{i()}),(s,_)=>(b(),y("div",Ft,[t("video",{ref_key:"videoRef",ref:a,autoplay:"",muted:"",playsinline:"",class:"w-full h-full object-contain"},null,512),!f.value&&!w.value&&d.value!=="unknown"?(b(),y("div",{key:0,class:T(["absolute top-1 right-1 px-1.5 py-0.5 text-[10px] font-medium rounded",d.value==="p2p"?"bg-emerald-500/80 text-white":"bg-amber-500/80 text-white"]),title:d.value==="p2p"?"Direct P2P connection":"Relay connection (FRP)"},$(d.value==="p2p"?"P2P":"RELAY"),11,Ut)):M("",!0),f.value&&!g.value?(b(),y("div",Gt,[..._[0]||(_[0]=[t("div",{class:"animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"},null,-1)])])):M("",!0),g.value?(b(),y("div",Vt,[t("div",It,[_[1]||(_[1]=t("div",{class:"animate-spin w-5 h-5 border-2 border-amber-400 border-t-transparent rounded-full mx-auto mb-2"},null,-1)),t("p",jt,$(w.value||"Reconnecting..."),1)])])):w.value&&!f.value?(b(),y("div",Ot,[t("div",zt,[t("p",qt,$(w.value),1),t("button",{onClick:S,class:"mt-2 text-xs text-preke-gold hover:underline"}," Retry ")])])):M("",!0)]))}}),Yt={key:0,class:"h-full flex items-center justify-center"},Qt={key:1,class:"input-grid"},Xt={key:0,class:"input-grid__warning"},Jt=["data-count"],Zt=["title"],en={key:1,class:"w-full h-full flex items-center justify-center bg-preke-bg-surface"},tn={class:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-4"},nn={class:"flex items-center justify-between"},on={class:"flex items-center gap-2"},sn={class:"font-medium"},an={key:0,class:"flex items-center gap-2 text-sm"},rn={class:"text-preke-text-dim"},ln={key:0,class:"mt-2 flex items-center justify-between"},cn={class:"text-sm font-mono text-preke-text-dim"},un=I({__name:"InputGrid",emits:["allVideosReady"],setup(n,{emit:e}){const o=F(),p=me(),l=e,u=C(new Set);function r(c){u.value.add(c),console.log(`[InputGrid] Video ready: ${c} (${u.value.size}/${f.value.length})`),u.value.size>=f.value.length&&(console.log("[InputGrid] All videos ready!"),l("allVideosReady"))}N(()=>f.value.length,()=>{u.value.clear()});const a=x(()=>{var c;return((c=p.capabilities)==null?void 0:c.current_mode)==="recorder"}),f=x(()=>o.inputs.filter(c=>c.hasSignal)),w=x(()=>o.framerateMismatch);function d(c){return c.isRecording?"border-preke-red ring-2 ring-preke-red/20":c.hasSignal?"border-emerald-500/50 hover:border-emerald-500":"border-preke-bg-surface/50 opacity-60"}function g(c){return c.hasSignal?c.framerate>=29?"excellent":c.framerate>=24?"good":"unstable":"none"}function k(c){switch(g(c)){case"excellent":return"text-emerald-400";case"good":return"text-emerald-400";case"unstable":return"text-amber-400";case"none":return"text-preke-text-dim"}}function m(c){if(c===0)return"0 B";const S=1024,i=["B","KB","MB","GB"],s=Math.floor(Math.log(c)/Math.log(S));return parseFloat((c/Math.pow(S,s)).toFixed(1))+" "+i[s]}function v(c){if(!c.hasSignal)return`${c.label}: No signal detected`;const S=[`${c.label}`,`Resolution: ${c.resolution}`,`Framerate: ${c.framerate} fps`,`Quality: ${g(c)}`];return c.isRecording&&S.push(`Written: ${m(c.bytesWritten)}`),S.join(`
`)}return(c,S)=>f.value.length===0?(b(),y("div",Yt,[...S[0]||(S[0]=[Fe('<div class="text-center text-preke-text-dim" data-v-d523ea77><svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-d523ea77><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" data-v-d523ea77></path></svg><p class="text-lg font-medium" data-v-d523ea77>No Video Sources Connected</p><p class="text-sm mt-2" data-v-d523ea77>Connect HDMI cables to begin recording</p></div>',1)])])):(b(),y("div",Qt,[w.value?(b(),y("div",Xt,[S[1]||(S[1]=t("svg",{class:"w-4 h-4 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20"},[t("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),t("span",null,$(w.value),1)])):M("",!0),t("div",{class:"input-grid__container","data-count":f.value.length},[(b(!0),y(H,null,ve(f.value,i=>(b(),y("div",{key:i.id,class:T(["input-grid__tile",d(i)]),title:v(i)},[a.value?(b(),pe(Kt,{key:0,"input-id":i.id,class:"w-full h-full",onVideoReady:s=>r(i.id)},null,8,["input-id","onVideoReady"])):(b(),y("div",en,[...S[2]||(S[2]=[t("div",{class:"text-center"},[t("svg",{class:"w-8 h-8 mx-auto mb-2 text-preke-text-dim/50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})]),t("span",{class:"text-xs text-preke-text-dim/70"},"Mixer mode")],-1)])])),t("div",tn,[t("div",nn,[t("div",on,[t("span",{class:T(["w-2 h-2 rounded-full transition-colors",{"bg-emerald-500":g(i)==="excellent"||g(i)==="good","bg-amber-500 animate-pulse":g(i)==="unstable","bg-preke-text-dim":g(i)==="none"}])},null,2),t("span",sn,$(i.label),1)]),i.hasSignal?(b(),y("div",an,[t("span",rn,$(i.resolution),1),t("span",{class:T(k(i))},$(i.framerate)+"fps",3)])):M("",!0)]),i.isRecording?(b(),y("div",ln,[S[3]||(S[3]=t("div",{class:"flex items-center gap-2 text-preke-red"},[t("span",{class:"w-2 h-2 rounded-full bg-preke-red animate-recording"}),t("span",{class:"text-sm font-medium"},"REC")],-1)),t("span",cn,$(m(i.bytesWritten)),1)])):M("",!0)])],10,Zt))),128))],8,Jt)]))}}),dn=Y(un,[["__scopeId","data-v-d523ea77"]]),fn={class:"sidebar"},vn={class:"sidebar__card sidebar__card--header"},pn={class:"connection-row"},gn={class:"connection-status"},mn={class:"connection-label"},_n={key:0,class:"connection-latency"},hn=["disabled"],bn={class:"sidebar__card sidebar__card--recording"},wn={class:"recording__duration"},yn={class:"recording__meta"},kn={class:"sidebar__card"},Cn={class:"stats"},$n={class:"stats__label"},xn={class:"stats__value"},Sn={key:0,class:"sidebar__card sidebar__card--warning"},Rn={class:"warning__text"},Tn={class:"sidebar__card"},Mn={class:"sidebar__hint"},En={class:"sidebar__card"},Pn={class:"cameras"},An={class:"camera__header"},Ln={class:"camera__controls"},Bn=["onClick"],Dn={class:"camera__btn-label"},Wn=["onClick"],Nn={class:"camera__btn-label"},Hn=["onClick"],Fn={class:"camera__btn-label"},Un=["onClick"],Gn={class:"camera__btn-label"},Vn={key:0,class:"sidebar__card"},In={class:"storage"},jn={class:"storage__bar"},On={class:"storage__info"},zn={class:"storage__estimate"},qn=I({__name:"SessionInfoV2",setup(n){const e=Se(),o=F(),p=me(),{state:l,latencyMs:u}=Ue(),{connectionMethod:r}=Ge(),a=x(()=>{const i=l.value==="connected",s=l.value==="connecting",_=l.value==="degraded";if(i){let h="";return r.value==="relay"?h="Relay":r.value==="p2p"?h="P2P":r.value==="local"&&(h="Local"),{status:"online",color:"green",label:h||"Connected",latency:u.value,pulse:!1}}return s?{status:"connecting",color:"amber",label:"Connecting...",latency:null,pulse:!0}:_?{status:"degraded",color:"amber",label:"Slow",latency:u.value,pulse:!1}:{status:"offline",color:"red",label:"Offline",latency:null,pulse:!0}});x(()=>o.currentSession);const f=x(()=>o.activeInputs),w=x(()=>o.isRecording),d=x(()=>o.inputs.filter(i=>i.isRecording)),g=C("");K(()=>{const s=new Date().toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,".");g.value=`Session ${s}`});const k=C([{id:"cam1",name:"CAM 1",focus:"auto",wb:"auto",shutter:"auto",aperture:"auto"},{id:"cam2",name:"CAM 2",focus:"auto",wb:"auto",shutter:"auto",aperture:"auto"},{id:"cam3",name:"CAM 3",focus:"auto",wb:"auto",shutter:"auto",aperture:"auto"},{id:"cam4",name:"CAM 4",focus:"auto",wb:"auto",shutter:"auto",aperture:"auto"}]);function m(i,s){const _=k.value[i];_&&(_[s]=_[s]==="auto"?"manual":"auto")}const v=x(()=>{const i=p.capabilities;if(!i)return null;const s=i.storage_used_gb||0,_=i.storage_total_gb||1,h=_-s,B=Math.round(s/_*100),U=h/10;return{freeGB:Math.round(h),totalGB:Math.round(_),percent:B,hoursRemaining:Math.round(U*10)/10,isLow:B>85,isCritical:B>95}});function c(i){if(i===0)return"0 B";const s=1024,_=["B","KB","MB","GB","TB"],h=Math.floor(Math.log(i)/Math.log(s));return parseFloat((i/Math.pow(s,h)).toFixed(2))+" "+_[h]}function S(){e.push({name:"admin",query:{tab:"settings"}})}return(i,s)=>{var _;return b(),y("div",fn,[t("div",vn,[t("div",pn,[t("div",gn,[t("span",{class:T(["connection-dot",[`connection-dot--${a.value.color}`,{"connection-dot--pulse":a.value.pulse}]])},null,2),t("span",mn,$(a.value.label),1),a.value.latency?(b(),y("span",_n,$(a.value.latency)+"ms ",1)):M("",!0)])]),s[1]||(s[1]=t("div",{class:"sidebar__divider"},null,-1)),s[2]||(s[2]=t("label",{class:"sidebar__label"},"Session Name",-1)),ge(t("input",{"onUpdate:modelValue":s[0]||(s[0]=h=>g.value=h),type:"text",class:"sidebar__input",placeholder:"Session 06.01.2026",disabled:w.value},null,8,hn),[[Ce,g.value]])]),w.value?(b(),y(H,{key:0},[t("div",bn,[s[3]||(s[3]=t("div",{class:"recording__header"},[t("span",{class:"recording__dot"}),t("span",{class:"recording__label"},"Recording")],-1)),t("div",wn,$(ee(o).formattedDuration),1),t("div",yn,$(d.value.length)+" camera"+$(d.value.length!==1?"s":"")+" recording ",1)]),t("div",kn,[s[4]||(s[4]=t("div",{class:"sidebar__label"},"Recording Stats",-1)),t("div",Cn,[(b(!0),y(H,null,ve(d.value,h=>(b(),y("div",{key:h.id,class:"stats__item"},[t("span",$n,$(h.label),1),t("span",xn,$(c(h.bytesWritten)),1)]))),128))])]),(_=v.value)!=null&&_.isLow?(b(),y("div",Sn,[s[6]||(s[6]=t("span",{class:"warning__icon"},"⚠️",-1)),t("div",Rn,[s[5]||(s[5]=t("strong",null,"Low storage",-1)),t("span",null,$(v.value.freeGB)+" GB remaining",1)])])):M("",!0)],64)):(b(),y(H,{key:1},[t("div",Tn,[s[9]||(s[9]=t("div",{class:"sidebar__label"},"Status",-1)),t("p",Mn,[q($(f.value.length)+" input"+$(f.value.length!==1?"s":"")+" with signal. Press ",1),s[7]||(s[7]=t("kbd",null,"Space",-1)),s[8]||(s[8]=q(" to start recording. ",-1))])]),t("div",En,[s[14]||(s[14]=t("div",{class:"sidebar__label"},"Camera Controls",-1)),t("div",Pn,[(b(!0),y(H,null,ve(k.value,(h,B)=>(b(),y("div",{key:h.id,class:"camera"},[t("div",An,$(h.name),1),t("div",Ln,[t("button",{class:T(["camera__btn",{"camera__btn--auto":h.focus==="auto"}]),onClick:U=>m(B,"focus"),title:"Focus"},[s[10]||(s[10]=t("span",{class:"camera__btn-icon"},"◎",-1)),t("span",Dn,$(h.focus==="auto"?"A":"M"),1)],10,Bn),t("button",{class:T(["camera__btn",{"camera__btn--auto":h.wb==="auto"}]),onClick:U=>m(B,"wb"),title:"White Balance"},[s[11]||(s[11]=t("span",{class:"camera__btn-icon"},"☀",-1)),t("span",Nn,$(h.wb==="auto"?"A":"M"),1)],10,Wn),t("button",{class:T(["camera__btn",{"camera__btn--auto":h.shutter==="auto"}]),onClick:U=>m(B,"shutter"),title:"Shutter"},[s[12]||(s[12]=t("span",{class:"camera__btn-icon"},"⏱",-1)),t("span",Fn,$(h.shutter==="auto"?"A":"M"),1)],10,Hn),t("button",{class:T(["camera__btn",{"camera__btn--auto":h.aperture==="auto"}]),onClick:U=>m(B,"aperture"),title:"Aperture"},[s[13]||(s[13]=t("span",{class:"camera__btn-icon"},"◐",-1)),t("span",Gn,$(h.aperture==="auto"?"A":"M"),1)],10,Un)])]))),128))])]),v.value?(b(),y("div",Vn,[s[15]||(s[15]=t("div",{class:"sidebar__label"},"Storage",-1)),t("div",In,[t("div",jn,[t("div",{class:T(["storage__fill",{"storage__fill--ok":!v.value.isLow,"storage__fill--low":v.value.isLow&&!v.value.isCritical,"storage__fill--critical":v.value.isCritical}]),style:Ve({width:`${v.value.percent}%`})},null,6)]),t("div",On,[t("span",null,$(v.value.freeGB)+" GB free",1),t("span",zn,"~"+$(v.value.hoursRemaining)+"h",1)])])])):M("",!0),t("div",{class:"sidebar__card"},[s[17]||(s[17]=t("div",{class:"sidebar__label"},"Quick Actions",-1)),t("button",{onClick:S,class:"sidebar__btn"},[...s[16]||(s[16]=[t("svg",{class:"sidebar__btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","stroke-width":"1.8"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),t("circle",{cx:"12",cy:"12",r:"3"})],-1),q(" Configure Inputs ",-1)])])])],64))])}}}),Kn=Y(qn,[["__scopeId","data-v-dd5d083c"]]),Yn={class:"h-full flex flex-col"},Qn={class:"recorder-header"},Xn={class:"recorder-header__left"},Jn={class:"recorder-header__title"},Zn={key:0,class:"recorder-header__badge"},eo={class:"flex-1 flex min-h-0 overflow-hidden"},to={class:"flex-1 min-h-0 min-w-0 p-3 overflow-hidden"},no={class:"w-72 flex-shrink-0 border-l border-preke-surface-border bg-preke-surface/80 backdrop-blur-lg p-4 overflow-y-auto"},oo=I({__name:"RecorderView",setup(n){const e=Se(),o=F(),p=me(),{showLeaveConfirmation:l,confirmLeave:u,cancelLeave:r}=qe();function a(){e.push("/")}const f=x(()=>o.status==="recording"),w=x(()=>o.formattedDuration),d=C(!0),g=C(!1),k=C(!1),m=x(()=>g.value&&k.value);function v(){d.value=!1}async function c(){var _;if(!Ie())return;await p.fetchCapabilities();const s=(_=p.capabilities)==null?void 0:_.current_mode;if(s&&s!=="recorder"){console.log("[Recorder] Not in recorder mode, switching...");try{(await fetch(je("/api/mode/recorder"),{method:"POST"})).ok&&(await p.fetchCapabilities(),G.success("Switched to Recorder mode"))}catch(h){console.warn("[Recorder] Failed to switch mode:",h)}}}function S(){console.log("[Recorder] All videos ready!"),k.value=!0}K(async()=>{const s=performance.now();await Promise.all([c(),o.fetchInputs(),o.fetchStatus()]);const _=o.inputs.filter(h=>h.hasSignal).length;console.log(`[Recorder] Data loaded: ${o.inputs.length} inputs, ${_} with signal (${Math.round(performance.now()-s)}ms)`),g.value=!0,_===0&&(k.value=!0)});const i=C(null);return N(l,s=>{var _,h;s?(_=i.value)==null||_.open():(h=i.value)==null||h.close()}),(s,_)=>(b(),y(H,null,[D(de,{name:"fade"},{default:fe(()=>[d.value?(b(),pe(ze,{key:0,mode:"recorder","content-ready":m.value,"min-time":1500,"max-time":5e3,"show-cancel":!0,onReady:v,onCancel:a},null,8,["content-ready"])):M("",!0)]),_:1}),D(de,{name:"content-fade"},{default:fe(()=>[ge(t("div",Yn,[t("header",Qn,[t("div",Xn,[t("div",Jn,[t("span",{class:T(["recorder-header__indicator",{"recorder-header__indicator--active":f.value}])},null,2),_[0]||(_[0]=t("span",{class:"recorder-header__label"},"Recorder",-1))]),f.value?(b(),y("span",Zn," REC ")):M("",!0),D(Tt)]),D(ht)]),t("div",eo,[t("div",to,[D(dn,{onAllVideosReady:S})]),t("aside",no,[D(Kn)])]),D($e,{ref_key:"leaveDialog",ref:i,title:"Recording in Progress",message:`You are currently recording (${w.value}). Leaving will stop the recording and save all files.`,"confirm-text":"Leave and Stop Recording","cancel-text":"Stay",danger:!0,onConfirm:ee(u),onCancel:ee(r)},null,8,["message","onConfirm","onCancel"])],512),[[Oe,!d.value]])]),_:1})],64))}}),ro=Y(oo,[["__scopeId","data-v-52bf7624"]]);export{ro as default};
