import{A as D,B as L,j as V,k as Q,C as Te,r as y,h as x,D as Ee,d as N,E as ge,l as M,T as re,m as ie,G as Ae,c as h,b as C,a as t,w as Me,x as Pe,t as _,s as Le,o as m,_ as le,H as Be,g as W,F as U,n as w,p as Y,I as ve,J as k,K as De,L as Ne,e as Ie,q as me,u as Fe}from"./index-DQzi4bBh.js";import{M as We}from"./ModeLoadingScreen-XM81gNKd.js";const H=y(!1),z=y(!1);let G=null;function je(){const o=D();L(()=>o.status,a=>{H.value=a==="recording"},{immediate:!0});function e(a){if(H.value)return a.preventDefault(),a.returnValue="Recording in progress. Are you sure you want to leave?",a.returnValue}V(()=>{window.addEventListener("beforeunload",e)}),Q(()=>{window.removeEventListener("beforeunload",e)}),Te((a,i,r)=>{H.value?(G=()=>r(),z.value=!0,r(!1)):r()});function s(){z.value=!1,H.value=!1,o.stopRecording().finally(()=>{G&&(G(),G=null)})}function c(){z.value=!1,G=null}return{isGuardActive:H,showLeaveConfirmation:z,confirmLeave:s,cancelLeave:c}}const R=y(null),Z=y(!1),fe=y(null),ee=y(null),He=10,te=2,Ge=25;function Ue(){const o=x(()=>R.value?R.value.available_gb<te?"critical":R.value.available_gb<He?"warning":"ok":"unknown"),e=x(()=>R.value?R.value.available_gb>=te:!0),s=x(()=>{if(!R.value)return null;const f=R.value.available_gb*1024*1024*1024,g=Ge*1024*1024,u=f/g,n=Math.floor(u/3600),l=Math.floor(u%3600/60);return n>24?`${Math.floor(n/24)}d ${n%24}h`:n>0?`${n}h ${l}m`:`${l}m`}),c=x(()=>{switch(o.value){case"ok":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}}),a=x(()=>R.value?o.value==="critical"?`Disk space critically low (${R.value.available_gb.toFixed(1)} GB). Cannot start recording.`:o.value==="warning"?`Low disk space (${R.value.available_gb.toFixed(1)} GB). Estimated recording time: ${s.value}`:null:null);async function i(){Z.value=!0,ee.value=null;try{const f=await Ee.getDegradation();if(f.resources&&f.resources.disk_free_gb!==void 0){const g=f.resources.disk_free_gb,u=g*3;R.value={available_gb:g,total_gb:u,used_percent:100-g/u*100,recording_path:"/opt/r58-app/shared/recordings"}}return fe.value=new Date,R.value}catch(f){return ee.value=f.message||"Failed to check disk space",console.error("Failed to check disk space:",f),null}finally{Z.value=!1}}async function r(){return await i(),R.value?o.value==="critical"?{ok:!1,message:`Insufficient disk space (${R.value.available_gb.toFixed(1)} GB). Need at least ${te} GB to start recording.`}:o.value==="warning"?{ok:!0,message:`Low disk space warning: ${R.value.available_gb.toFixed(1)} GB available. Estimated recording time: ${s.value}`}:{ok:!0}:{ok:!0,message:"Could not verify disk space. Proceeding with caution."}}return{diskSpace:R,isLoading:Z,lastCheck:fe,error:ee,status:o,statusColor:c,canStartRecording:e,estimatedRecordingTime:s,warningMessage:a,checkDiskSpace:i,preflightCheck:r}}const P=y(localStorage.getItem("r58_audio_feedback")!=="false");let ne=null;function Ve(){return ne||(ne=new(window.AudioContext||window.webkitAudioContext)),ne}function A(o,e,s="sine",c=.3){if(P.value)try{const a=Ve();a.state==="suspended"&&a.resume();const i=a.createOscillator(),r=a.createGain();i.connect(r),r.connect(a.destination),i.type=s,i.frequency.value=o;const f=a.currentTime;r.gain.setValueAtTime(0,f),r.gain.linearRampToValueAtTime(c,f+.01),r.gain.linearRampToValueAtTime(0,f+e),i.start(f),i.stop(f+e)}catch(a){console.warn("Audio feedback failed:",a)}}function Oe(){P.value&&(A(440,.1,"sine",.2),setTimeout(()=>A(554,.1,"sine",.2),100),setTimeout(()=>A(659,.15,"sine",.25),200))}function qe(){P.value&&(A(880,.08,"sine",.3),setTimeout(()=>A(880,.15,"sine",.3),120))}function ze(){P.value&&(A(659,.1,"sine",.25),setTimeout(()=>A(554,.1,"sine",.2),100),setTimeout(()=>A(440,.15,"sine",.2),200))}function Ke(){P.value&&(A(200,.15,"square",.15),setTimeout(()=>A(180,.2,"square",.15),180))}function Ye(){P.value&&(A(1e3,.08,"sine",.2),setTimeout(()=>A(1e3,.08,"sine",.2),150))}function pe(){P.value&&A(1200,.03,"sine",.1)}function Qe(o=50){if(P.value&&"vibrate"in navigator)try{navigator.vibrate(o)}catch{}}function be(){function o(s){P.value=s,localStorage.setItem("r58_audio_feedback",String(s))}function e(){o(!P.value),P.value&&pe()}return{enabled:P,setEnabled:o,toggle:e,playSuccess:Oe,playError:Ke,playWarning:Ye,playClick:pe,playRecordStart:qe,playRecordStop:ze,vibrate:Qe}}const Xe={class:"bg-r58-bg-secondary rounded-lg shadow-xl max-w-md w-full p-6"},Je=["placeholder"],Ze={class:"text-xs text-r58-text-secondary mt-2"},et=N({__name:"SessionNameDialog",props:{open:{type:Boolean},suggestedName:{}},emits:["confirm","cancel","skip"],setup(o,{emit:e}){const s=o,c=e,a=y(""),i=y(null),r=x(()=>{const p=new Date,d=p.toLocaleDateString("en-CA"),b=p.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}).replace(":","");return`Recording_${d}_${b}`}),f=x(()=>s.suggestedName||r.value);L(()=>s.open,p=>{p&&(a.value=f.value,setTimeout(()=>{var d,b;(d=i.value)==null||d.focus(),(b=i.value)==null||b.select()},100))});function g(){c("confirm",a.value.trim()||f.value)}function u(){c("skip")}function n(){c("cancel")}function l(p){p.key==="Enter"?g():p.key==="Escape"&&n()}return(p,d)=>(m(),ge(Ae,{to:"body"},[M(re,{name:"fade"},{default:ie(()=>[o.open?(m(),h("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:Le(n,["self"]),onKeydown:l},[t("div",Xe,[d[1]||(d[1]=t("h2",{class:"text-lg font-semibold mb-2"},"Name This Recording",-1)),d[2]||(d[2]=t("p",{class:"text-r58-text-secondary text-sm mb-4"}," Give your recording a name to find it easily later (optional). ",-1)),Me(t("input",{ref_key:"inputRef",ref:i,"onUpdate:modelValue":d[0]||(d[0]=b=>a.value=b),type:"text",placeholder:f.value,class:"w-full px-4 py-2 bg-r58-bg-tertiary border border-r58-bg-tertiary rounded-lg text-r58-text-primary placeholder-r58-text-secondary focus:outline-none focus:ring-2 focus:ring-r58-accent-primary"},null,8,Je),[[Pe,a.value]]),t("p",Ze," Suggested: "+_(f.value),1),t("div",{class:"flex justify-between mt-6"},[t("button",{onClick:u,class:"text-sm text-r58-text-secondary hover:text-r58-text-primary transition-colors"}," Skip (use default) "),t("div",{class:"flex gap-3"},[t("button",{onClick:n,class:"btn"}," Cancel "),t("button",{onClick:g,class:"btn btn-primary"}," Start Recording ")])])])],32)):C("",!0)]),_:1})]))}}),tt=le(et,[["__scopeId","data-v-df8c0a50"]]),nt={class:"flex items-center gap-4"},ot={key:0,class:"font-mono text-xl text-r58-accent-danger"},st=["disabled","title"],at={key:0,class:"animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"},rt={key:0,class:"w-3 h-3 bg-white rounded-sm"},it={key:1,class:"w-3 h-3 bg-white rounded-full"},lt={class:"text-xs text-r58-text-secondary hidden md:inline"},ct=N({__name:"RecorderControls",setup(o){const e=D(),{register:s}=Be(),{preflightCheck:c,status:a,canStartRecording:i}=Ue(),{playRecordStart:r,playRecordStop:f,playError:g,playWarning:u,vibrate:n}=be(),l=y(null),p=y(!1),d=y(!1),b=y(!1),v=y(!1),S=y(void 0),$=x(()=>e.status==="recording"),F=x(()=>e.status==="starting"),O=x(()=>e.status==="stopping"),X=x(()=>e.formattedDuration),ye=x(()=>F.value||O.value||d.value),xe=x(()=>F.value?"Starting recording...":O.value?"Stopping recording...":d.value?"Checking disk space...":!$.value&&!i.value?"Insufficient disk space":"");let J=null;V(()=>{J=s({key:" ",description:"Toggle Recording",action:_e,context:"recorder",enabled:()=>!F.value&&!O.value})}),Q(()=>{J&&J()});async function _e(){$.value?de():await q()}async function q(T){d.value=!0;try{const E=await c();if(!E.ok){g(),n(200),W.error("Cannot start recording",E.message||"Preflight check failed");return}if(E.message&&a.value==="warning"&&(u(),W.warning("Low disk space",E.message)),v.value&&!T){S.value=void 0,b.value=!0;return}await ue(T||S.value)}finally{d.value=!1}}async function ue(T){try{await e.startRecording(T);const E=T||e.sessionId;r(),n([50,30,50]),W.success("Recording started",`Session: ${E}`)}catch(E){g(),n(200),W.error("Failed to start recording",E.message||"Unknown error",{label:"Retry",onClick:()=>q(T)})}}function we(T){b.value=!1,S.value=T,q(T)}function ke(){b.value=!1,S.value=void 0,q()}function Se(){b.value=!1,d.value=!1}async function $e(){try{await e.stopRecording(),f(),n(100),W.success("Recording stopped",`Duration: ${X.value}`)}catch(T){g(),n(200),W.error("Failed to stop recording",T.message||"Unknown error")}}function de(){var T;p.value=!1,(T=l.value)==null||T.open(),setTimeout(()=>{p.value=!0},500)}function Ce(){p.value&&$e()}async function Re(){$.value?de():await ue()}return(T,E)=>(m(),h(U,null,[t("div",nt,[$.value?(m(),h("div",ot,_(X.value),1)):C("",!0),t("button",{onClick:Re,disabled:ye.value,class:w(["flex items-center gap-2 px-6 py-2 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed",[$.value?"bg-r58-accent-danger hover:bg-red-600 text-white":"bg-r58-accent-success hover:bg-green-600 text-white"]]),title:xe.value||($.value?"Stop Recording (Space)":"Start Recording (Space)")},[F.value||O.value||d.value?(m(),h("span",at)):(m(),h(U,{key:1},[$.value?(m(),h("span",rt)):(m(),h("span",it))],64)),t("span",null,_(d.value?"Checking...":$.value?"Stop":"Start Recording"),1)],10,st),t("span",lt,[E[0]||(E[0]=Y(" Press ",-1)),E[1]||(E[1]=t("kbd",{class:"px-1 py-0.5 bg-r58-bg-tertiary rounded text-xs font-mono"},"Space",-1)),Y(" to "+_($.value?"stop":"start"),1)])]),M(ve,{ref_key:"stopConfirmDialog",ref:l,title:"Stop Recording?",message:`You have been recording for ${X.value}. This will finalize all files.`,"confirm-text":"Stop Recording","cancel-text":"Keep Recording",danger:!0,onConfirm:Ce},null,8,["message"]),M(tt,{open:b.value,onConfirm:we,onSkip:ke,onCancel:Se},null,8,["open"])],64))}}),K=y(localStorage.getItem("r58_performance_mode")==="true"),oe=y(localStorage.getItem("r58_performance_mode_auto")!=="false"),ut=3,dt=100,ft=500;function he(){const o=D(),e=x(()=>K.value?!0:oe.value&&o.isRecording?o.inputs.filter(l=>l.isRecording).length>=ut:!1),s=x(()=>e.value?ft:dt);L(e,n=>{n?document.body.classList.add("performance-mode"):document.body.classList.remove("performance-mode")},{immediate:!0});function c(n){K.value=n,localStorage.setItem("r58_performance_mode",String(n))}function a(n){oe.value=n,localStorage.setItem("r58_performance_mode_auto",String(n))}function i(){c(!K.value)}function r(n,l){let p=0,d=null;return(...b)=>{const v=Date.now(),S=l??s.value,$=v-p;$>=S?(p=v,n(...b)):d||(d=window.setTimeout(()=>{p=Date.now(),d=null,n(...b)},S-$))}}function f(n,l){let p=null;return(...d)=>{p&&clearTimeout(p),p=window.setTimeout(()=>{n(...d),p=null},l??s.value)}}function g(n){return e.value?window.setTimeout(()=>n(performance.now()),s.value):requestAnimationFrame(n)}function u(n){e.value?clearTimeout(n):cancelAnimationFrame(n)}return{enabled:K,autoEnable:oe,isActive:e,updateInterval:s,setEnabled:c,setAutoEnable:a,toggle:i,throttle:r,debounce:f,requestFrame:g,cancelFrame:u}}const pt=["title"],gt={class:"flex items-center gap-1.5 text-sm"},vt={key:0,class:"flex items-center gap-1.5 text-sm"},mt={key:1,class:"flex items-center gap-1.5 text-sm text-red-400"},bt={class:"font-mono"},ht=N({__name:"RecordingHealth",setup(o,{expose:e}){const s=D(),{isActive:c}=he(),a=y({}),i=y(0),r=y(0),f=y(0);let g=null;function u(){const b={};let v=0;s.inputs.forEach($=>{b[$.id]=$.bytesWritten;const F=a.value[$.id]||0;v+=$.bytesWritten-F});const S=c.value?2:1;i.value=Math.round(v/(1024*1024)/S*10)/10,a.value=b}L(()=>s.isRecording,b=>{if(b){a.value={},i.value=0,r.value=0,f.value=0;const v=c.value?2e3:1e3;g=window.setInterval(u,v)}else g&&(clearInterval(g),g=null)},{immediate:!0}),L(c,b=>{if(s.isRecording&&g){clearInterval(g);const v=b?2e3:1e3;g=window.setInterval(u,v)}}),Q(()=>{g&&clearInterval(g)});const n=x(()=>s.isRecording?f.value>0||r.value>90?"critical":i.value<1||r.value>70?"warning":"healthy":"idle"),l=x(()=>{switch(n.value){case"healthy":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}});x(()=>{switch(n.value){case"healthy":return"Healthy";case"warning":return"Warning";case"critical":return"Critical";default:return"Idle"}});const p=x(()=>{if(!s.isRecording)return"Not recording";const b=[`Write speed: ${i.value} MB/s`,`Buffer: ${r.value}%`];return f.value>0&&b.push(`Frames dropped: ${f.value}`),b.join(`
`)});function d(b){b.buffer_percent!==void 0&&(r.value=b.buffer_percent),b.frames_dropped!==void 0&&(f.value=b.frames_dropped)}return e({updateFromMetrics:d}),(b,v)=>k(s).isRecording?(m(),h("div",{key:0,class:w(["flex items-center gap-3 px-3 py-1.5 rounded-lg transition-colors cursor-help",{"bg-emerald-500/10":l.value==="emerald","bg-amber-500/10":l.value==="amber","bg-red-500/10":l.value==="red"}]),title:p.value},[t("span",{class:w(["w-2 h-2 rounded-full",l.value==="emerald"?"bg-emerald-500":"",l.value==="amber"?"bg-amber-500 animate-pulse":"",l.value==="red"?"bg-red-500 animate-pulse":""])},null,2),t("div",gt,[v[0]||(v[0]=t("svg",{class:"w-3.5 h-3.5 text-r58-text-secondary",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})],-1)),t("span",{class:w(["font-mono",l.value==="emerald"?"text-emerald-400":"",l.value==="amber"?"text-amber-400":"",l.value==="red"?"text-red-400":""])},_(i.value)+" MB/s ",3)]),r.value>0?(m(),h("div",vt,[v[1]||(v[1]=t("span",{class:"text-r58-text-secondary"},"Buf:",-1)),t("span",{class:w(["font-mono",r.value<50?"text-emerald-400":"",r.value>=50&&r.value<80?"text-amber-400":"",r.value>=80?"text-red-400":""])},_(r.value)+"% ",3)])):C("",!0),f.value>0?(m(),h("div",mt,[v[2]||(v[2]=t("svg",{class:"w-3.5 h-3.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),t("span",bt,_(f.value)+" dropped",1)])):C("",!0)],10,pt)):C("",!0)}}),yt=["65.109.32.111"],xt=["100.98.37.53","192.168.1.24"],_t=5,wt=1e3,kt=3e4,B=new Map,j=new Map;function St(o){const e=Ne();if(e&&!De())try{return`http://${new URL(e).hostname}:8889/${o}/whep`}catch{console.warn("[WHEP Manager] Invalid device URL, falling back to FRP")}return`https://r58-mediamtx.itagenten.no/${o}/whep`}async function $t(o,e){for(let s=0;s<3;s++){s>0&&await new Promise(c=>setTimeout(c,200));try{const c=await o.getStats();for(const a of c.values())if(a.type==="candidate-pair"&&a.state==="succeeded"){const i=c.get(a.remoteCandidateId),r=i==null?void 0:i.address;return(i==null?void 0:i.candidateType)==="relay"||r&&yt.includes(r)?"relay":r&&xt.includes(r)||r&&(r.startsWith("100.")||r.startsWith("192.168.")||r.startsWith("10.")||r.startsWith("172."))?"p2p":"relay"}}catch(c){console.warn(`[WHEP Manager ${e}] Failed to detect connection type:`,c)}}return"unknown"}function I(o){const e=B.get(o);if(!e)return;const s=j.get(o);s&&s.forEach(c=>c(e))}function se(o){const e=B.get(o);if(!e)return;if(e.reconnectAttempts>=_t){console.error(`[WHEP Manager ${o}] Max reconnect attempts reached`),e.state="failed",I(o);return}e.reconnectAttempts++;const s=Math.min(wt*Math.pow(2,e.reconnectAttempts-1),kt);console.log(`[WHEP Manager ${o}] Scheduling reconnect #${e.reconnectAttempts} in ${s}ms`),e.state="connecting",I(o),e.reconnectTimeout&&clearTimeout(e.reconnectTimeout),e.reconnectTimeout=setTimeout(()=>{ce(o)},s)}async function ce(o){let e=B.get(o);if(e&&(e.state==="connected"||e.state==="connecting"))return console.log(`[WHEP Manager ${o}] Reusing existing connection (state: ${e.state})`),e;const s=St(o);console.log(`[WHEP Manager ${o}] Creating new connection: ${s}`),e!=null&&e.peerConnection&&e.peerConnection.close();const c=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}]});e?(e.peerConnection=c,e.state="connecting",e.whepUrl=s,e.mediaStream=null,e.connectionType="unknown"):(e={cameraId:o,peerConnection:c,mediaStream:null,state:"connecting",connectionType:"unknown",refCount:0,whepUrl:s,lastConnectedAt:null,reconnectAttempts:(e==null?void 0:e.reconnectAttempts)||0,reconnectTimeout:null},B.set(o,e)),c.ontrack=a=>{a.streams[0]&&(e.mediaStream=a.streams[0],console.log(`[WHEP Manager ${o}] Received media stream`),I(o))},c.oniceconnectionstatechange=async()=>{const a=c.iceConnectionState;console.log(`[WHEP Manager ${o}] ICE state: ${a}`),a==="connected"||a==="completed"?(e.state="connected",e.lastConnectedAt=Date.now(),e.reconnectAttempts=0,e.connectionType=await $t(c,o),console.log(`[WHEP Manager ${o}] Connected (${e.connectionType})`),I(o)):a==="failed"?(e.state="failed",e.connectionType="unknown",I(o),e.refCount>0&&se(o)):a==="disconnected"&&setTimeout(()=>{(c.iceConnectionState==="disconnected"||c.iceConnectionState==="failed")&&(e.state="disconnected",I(o),e.refCount>0&&se(o))},3e3)},c.addTransceiver("video",{direction:"recvonly"}),c.addTransceiver("audio",{direction:"recvonly"});try{const a=await c.createOffer();await c.setLocalDescription(a);const i=await fetch(s,{method:"POST",headers:{"Content-Type":"application/sdp"},body:a.sdp});if(!i.ok)throw new Error(`WHEP request failed: ${i.status}`);const r=await i.text();await c.setRemoteDescription({type:"answer",sdp:r})}catch(a){console.error(`[WHEP Manager ${o}] Connection error:`,a),e.state="failed",I(o),e.refCount>0&&se(o)}return e}async function Ct(o,e){j.has(o)||j.set(o,new Set),j.get(o).add(e);let s=B.get(o);return(!s||s.state==="failed"||s.state==="disconnected")&&(s=await ce(o)),s.refCount++,console.log(`[WHEP Manager ${o}] Acquired connection (refCount: ${s.refCount})`),e(s),s}function Rt(o,e){const s=B.get(o);if(!s)return;const c=j.get(o);c&&(c.delete(e),c.size===0&&j.delete(o)),s.refCount=Math.max(0,s.refCount-1),console.log(`[WHEP Manager ${o}] Released connection (refCount: ${s.refCount})`),s.refCount===0&&(console.log(`[WHEP Manager ${o}] Closing unused connection`),s.reconnectTimeout&&clearTimeout(s.reconnectTimeout),s.peerConnection.close(),B.delete(o))}function ae(o){const e=B.get(o);e&&(console.log(`[WHEP Manager ${o}] Force reconnecting...`),e.reconnectAttempts=0,ce(o))}const Tt={class:"relative w-full h-full bg-black"},Et=["title"],At={key:1,class:"absolute inset-0 flex items-center justify-center bg-black/50"},Mt={key:2,class:"absolute inset-0 flex items-center justify-center bg-black/70"},Pt={class:"text-center"},Lt={class:"text-xs text-amber-400"},Bt={key:3,class:"absolute inset-0 flex items-center justify-center bg-black/80"},Dt={class:"text-center text-r58-text-secondary"},Nt={class:"text-sm"},It=N({__name:"InputPreview",props:{inputId:{},protocol:{}},setup(o){const e=o,s=D(),c=x(()=>s.status==="recording"),a=y(null),i=y(!0),r=y(null),f=y("unknown"),g=y(!1),u=y(0);let n=null;function l(v){switch(console.log(`[InputPreview ${e.inputId}] Connection update:`,{state:v.state,type:v.connectionType,hasStream:!!v.mediaStream}),f.value=v.connectionType,u.value=v.reconnectAttempts,v.state){case"connecting":i.value=!0,r.value=null,g.value=v.reconnectAttempts>0;break;case"connected":i.value=!1,r.value=null,g.value=!1,v.mediaStream&&a.value&&a.value.srcObject!==v.mediaStream&&(a.value.srcObject=v.mediaStream);break;case"disconnected":g.value=!0,r.value=`Reconnecting... (${v.reconnectAttempts}/5)`;break;case"failed":i.value=!1,g.value=!1,r.value="Connection failed after multiple attempts";break}}async function p(){if(a.value){b(),i.value=!0,r.value=null,n=l;try{await Ct(e.inputId,n)}catch(v){console.error(`[InputPreview ${e.inputId}] Failed to acquire connection:`,v),r.value=v instanceof Error?v.message:"Failed to connect",i.value=!1}}}function d(){ae(e.inputId)}function b(){n&&(Rt(e.inputId,n),n=null)}return V(()=>{p()}),L(()=>e.inputId,()=>{p()}),L(c,(v,S)=>{S&&!v&&r.value?(console.log("[InputPreview] Recording stopped, reconnecting preview..."),ae(e.inputId)):!S&&v&&(console.log("[InputPreview] Recording started, will try to reconnect preview after delay..."),setTimeout(()=>{c.value&&(console.log("[InputPreview] Attempting to reconnect preview during recording..."),ae(e.inputId))},2e3))}),Q(()=>{b()}),(v,S)=>(m(),h("div",Tt,[t("video",{ref_key:"videoRef",ref:a,autoplay:"",muted:"",playsinline:"",class:"w-full h-full object-contain"},null,512),!i.value&&!r.value&&f.value!=="unknown"?(m(),h("div",{key:0,class:w(["absolute top-1 right-1 px-1.5 py-0.5 text-[10px] font-medium rounded",f.value==="p2p"?"bg-emerald-500/80 text-white":"bg-amber-500/80 text-white"]),title:f.value==="p2p"?"Direct P2P connection":"Relay connection (FRP)"},_(f.value==="p2p"?"P2P":"RELAY"),11,Et)):C("",!0),i.value&&!g.value?(m(),h("div",At,[...S[0]||(S[0]=[t("div",{class:"animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"},null,-1)])])):C("",!0),g.value?(m(),h("div",Mt,[t("div",Pt,[S[1]||(S[1]=t("div",{class:"animate-spin w-5 h-5 border-2 border-amber-400 border-t-transparent rounded-full mx-auto mb-2"},null,-1)),t("p",Lt,_(r.value||"Reconnecting..."),1)])])):r.value&&!i.value?(m(),h("div",Bt,[t("div",Dt,[t("p",Nt,_(r.value),1),t("button",{onClick:d,class:"mt-2 text-xs text-r58-accent-primary hover:underline"}," Retry ")])])):C("",!0)]))}}),Ft={key:0,class:"h-full flex items-center justify-center"},Wt={key:1,class:"h-full flex flex-col gap-2"},jt={key:0,class:"flex items-center gap-2 px-3 py-1.5 bg-amber-500/10 border border-amber-500/30 rounded-lg text-amber-400 text-sm"},Ht=["title"],Gt={class:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-4"},Ut={class:"flex items-center justify-between"},Vt={class:"flex items-center gap-2"},Ot={class:"font-medium"},qt={key:0,class:"flex items-center gap-2 text-sm"},zt={class:"text-r58-text-secondary"},Kt={key:0,class:"mt-2 flex items-center justify-between"},Yt={class:"text-sm font-mono text-r58-text-secondary"},Qt=N({__name:"InputGrid",setup(o){const e=D(),s=x(()=>e.inputs.filter(u=>u.hasSignal)),c=x(()=>e.framerateMismatch);function a(u){return u.isRecording?"border-r58-accent-danger ring-2 ring-r58-accent-danger/20":u.hasSignal?"border-emerald-500/50 hover:border-emerald-500":"border-r58-bg-tertiary/50 opacity-60"}function i(u){return u.hasSignal?u.framerate>=29?"excellent":u.framerate>=24?"good":"unstable":"none"}function r(u){switch(i(u)){case"excellent":return"text-emerald-400";case"good":return"text-emerald-400";case"unstable":return"text-amber-400";case"none":return"text-r58-text-secondary"}}function f(u){if(u===0)return"0 B";const n=1024,l=["B","KB","MB","GB"],p=Math.floor(Math.log(u)/Math.log(n));return parseFloat((u/Math.pow(n,p)).toFixed(1))+" "+l[p]}function g(u){if(!u.hasSignal)return`${u.label}: No signal detected`;const n=[`${u.label}`,`Resolution: ${u.resolution}`,`Framerate: ${u.framerate} fps`,`Quality: ${i(u)}`];return u.isRecording&&n.push(`Written: ${f(u.bytesWritten)}`),n.join(`
`)}return(u,n)=>s.value.length===0?(m(),h("div",Ft,[...n[0]||(n[0]=[Ie('<div class="text-center text-r58-text-secondary"><svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg><p class="text-lg font-medium">No Video Sources Connected</p><p class="text-sm mt-2">Connect HDMI cables to begin recording</p></div>',1)])])):(m(),h("div",Wt,[c.value?(m(),h("div",jt,[n[1]||(n[1]=t("svg",{class:"w-4 h-4 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20"},[t("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),t("span",null,_(c.value),1)])):C("",!0),t("div",{class:w(["flex-1 grid gap-4",s.value.length===1?"grid-cols-1":"grid-cols-2"])},[(m(!0),h(U,null,me(s.value,l=>(m(),h("div",{key:l.id,class:w(["relative rounded-lg overflow-hidden border-2 transition-all cursor-pointer aspect-video bg-black",a(l)]),title:g(l)},[M(It,{"input-id":l.id,class:"w-full h-full"},null,8,["input-id"]),t("div",Gt,[t("div",Ut,[t("div",Vt,[t("span",{class:w(["w-2 h-2 rounded-full transition-colors",{"bg-emerald-500":i(l)==="excellent"||i(l)==="good","bg-amber-500 animate-pulse":i(l)==="unstable","bg-r58-text-secondary":i(l)==="none"}])},null,2),t("span",Ot,_(l.label),1)]),l.hasSignal?(m(),h("div",qt,[t("span",zt,_(l.resolution),1),t("span",{class:w(r(l))},_(l.framerate)+"fps",3)])):C("",!0)]),l.isRecording?(m(),h("div",Kt,[n[2]||(n[2]=t("div",{class:"flex items-center gap-2 text-r58-accent-danger"},[t("span",{class:"w-2 h-2 rounded-full bg-r58-accent-danger animate-recording"}),t("span",{class:"text-sm font-medium"},"REC")],-1)),t("span",Yt,_(f(l.bytesWritten)),1)])):C("",!0)])],10,Ht))),128))],2)]))}}),Xt={class:"space-y-4"},Jt={class:"flex items-center justify-between py-2 cursor-pointer"},Zt=["aria-checked"],en={class:"flex items-center justify-between py-2 cursor-pointer"},tn=["aria-checked"],nn={class:"flex items-center justify-between py-2 cursor-pointer"},on={class:"text-xs text-r58-text-secondary"},sn={key:0,class:"text-amber-400"},an=["aria-checked"],rn={class:"flex items-center justify-between py-2 pl-4 cursor-pointer opacity-80"},ln=["aria-checked"],cn=N({__name:"SettingsPanel",setup(o){const{enabled:e,toggle:s,playClick:c}=be(),{enabled:a,autoEnable:i,isActive:r,setEnabled:f,setAutoEnable:g}=he(),u=y(!1);function n(){u.value=!u.value,u.value?(document.body.classList.add("touch-mode"),localStorage.setItem("r58_touch_mode","true")):(document.body.classList.remove("touch-mode"),localStorage.setItem("r58_touch_mode","false"))}V(()=>{const p=localStorage.getItem("r58_touch_mode")==="true";u.value=p,p&&document.body.classList.add("touch-mode")});function l(){s(),e.value&&c()}return(p,d)=>(m(),h("div",Xt,[d[7]||(d[7]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide"}," Interface Settings ",-1)),t("label",Jt,[d[2]||(d[2]=t("div",null,[t("span",{class:"text-r58-text-primary"},"Audio Feedback"),t("p",{class:"text-xs text-r58-text-secondary"},"Play sounds for recording start/stop")],-1)),t("button",{onClick:l,class:w(["relative w-12 h-7 rounded-full transition-colors",k(e)?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":k(e)},[t("span",{class:w(["absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform",k(e)?"translate-x-6":"translate-x-1"])},null,2)],10,Zt)]),t("label",en,[d[3]||(d[3]=t("div",null,[t("span",{class:"text-r58-text-primary"},"Touch Mode"),t("p",{class:"text-xs text-r58-text-secondary"},"Larger buttons for touchscreen")],-1)),t("button",{onClick:n,class:w(["relative w-12 h-7 rounded-full transition-colors",u.value?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":u.value},[t("span",{class:w(["absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform",u.value?"translate-x-6":"translate-x-1"])},null,2)],10,tn)]),t("label",nn,[t("div",null,[d[5]||(d[5]=t("span",{class:"text-r58-text-primary"},"Performance Mode",-1)),t("p",on,[d[4]||(d[4]=Y(" Reduce UI updates during recording ",-1)),k(r)&&!k(a)?(m(),h("span",sn,"(auto-enabled)")):C("",!0)])]),t("button",{onClick:d[0]||(d[0]=b=>k(f)(!k(a))),class:w(["relative w-12 h-7 rounded-full transition-colors",k(a)?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":k(a)},[t("span",{class:w(["absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform",k(a)?"translate-x-6":"translate-x-1"])},null,2)],10,an)]),t("label",rn,[d[6]||(d[6]=t("div",null,[t("span",{class:"text-sm text-r58-text-primary"},"Auto-enable when recording 3+ inputs")],-1)),t("button",{onClick:d[1]||(d[1]=b=>k(g)(!k(i))),class:w(["relative w-10 h-6 rounded-full transition-colors",k(i)?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":k(i)},[t("span",{class:w(["absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform",k(i)?"translate-x-4":"translate-x-0.5"])},null,2)],10,ln)])]))}}),un={class:"space-y-6"},dn={key:0,class:"card"},fn={class:"space-y-2"},pn={class:"flex justify-between"},gn={class:"flex justify-between"},vn={class:"font-mono"},mn={class:"flex justify-between"},bn={class:"card"},hn={class:"space-y-3"},yn={class:"flex items-center gap-2"},xn={key:0,class:"text-sm text-r58-text-secondary"},_n={key:0,class:"text-r58-accent-danger"},wn={key:1},kn={key:1,class:"text-sm text-r58-text-secondary"},Sn={class:"card"},$n={class:"space-y-2"},Cn=["disabled","title"],Rn={key:0,class:"absolute -top-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-r58-bg-tertiary text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none"},Tn={key:0,class:"card"},En=N({__name:"SessionInfo",setup(o){const e=Fe(),s=D(),c=x(()=>s.currentSession),a=x(()=>s.activeInputs),i=x(()=>s.isRecording),r=y(!1);function f(u){if(u===0)return"0 B";const n=1024,l=["B","KB","MB","GB","TB"],p=Math.floor(Math.log(u)/Math.log(n));return parseFloat((u/Math.pow(n,p)).toFixed(2))+" "+l[p]}function g(){e.push({name:"admin",query:{tab:"settings"}})}return(u,n)=>(m(),h("div",un,[c.value?(m(),h("div",dn,[n[4]||(n[4]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide mb-3"},"Current Session",-1)),t("div",fn,[t("div",pn,[n[1]||(n[1]=t("span",{class:"text-r58-text-secondary"},"Started",-1)),t("span",null,_(c.value.startedAt.toLocaleTimeString()),1)]),t("div",gn,[n[2]||(n[2]=t("span",{class:"text-r58-text-secondary"},"Duration",-1)),t("span",vn,_(k(s).formattedDuration),1)]),t("div",mn,[n[3]||(n[3]=t("span",{class:"text-r58-text-secondary"},"Inputs",-1)),t("span",null,_(a.value.length)+" active",1)])])])):C("",!0),t("div",bn,[n[5]||(n[5]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide mb-3"},"Input Status",-1)),t("div",hn,[(m(!0),h(U,null,me(k(s).inputs,l=>(m(),h("div",{key:l.id,class:"flex items-center justify-between py-2 border-b border-r58-bg-tertiary last:border-0"},[t("div",yn,[t("span",{class:w(["w-2 h-2 rounded-full",l.hasSignal?"bg-r58-accent-success":"bg-r58-text-secondary"])},null,2),t("span",{class:w(l.hasSignal?"":"text-r58-text-secondary")},_(l.label),3)]),l.hasSignal?(m(),h("div",xn,[l.isRecording?(m(),h("span",_n,_(f(l.bytesWritten)),1)):(m(),h("span",wn,_(l.resolution),1))])):(m(),h("span",kn,"No signal"))]))),128))])]),t("div",Sn,[n[7]||(n[7]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide mb-3"},"Quick Actions",-1)),t("div",$n,[t("button",{onClick:g,class:"btn w-full justify-center disabled:opacity-50 disabled:cursor-not-allowed group relative",disabled:i.value,title:i.value?"Cannot configure while recording":"Open input configuration"},[n[6]||(n[6]=Y(" Configure Inputs ",-1)),i.value?(m(),h("span",Rn," Stop recording first ")):C("",!0)],8,Cn),t("button",{onClick:n[0]||(n[0]=l=>r.value=!r.value),class:"btn w-full justify-center"},_(r.value?"Hide Settings":"Interface Settings"),1)])]),M(re,{name:"slide-fade"},{default:ie(()=>[r.value?(m(),h("div",Tn,[M(cn)])):C("",!0)]),_:1})]))}}),An=le(En,[["__scopeId","data-v-8910ebdc"]]),Mn={class:"h-full flex flex-col"},Pn={class:"flex items-center justify-between px-6 py-4 border-b border-r58-bg-tertiary bg-r58-bg-secondary"},Ln={class:"flex items-center gap-4"},Bn={class:"flex items-center gap-2"},Dn={key:0,class:"badge badge-danger"},Nn={class:"flex-1 flex overflow-hidden"},In={class:"flex-1 p-4"},Fn={class:"w-80 border-l border-r58-bg-tertiary bg-r58-bg-secondary p-4 overflow-y-auto"},Wn=N({__name:"RecorderView",setup(o){const e=D(),{showLeaveConfirmation:s,confirmLeave:c,cancelLeave:a}=je(),i=x(()=>e.status==="recording"),r=x(()=>e.formattedDuration),f=y(!0),g=y(!1);function u(){f.value=!1}V(async()=>{await e.fetchInputs(),await e.fetchStatus(),g.value=!0});const n=y(null);return L(s,l=>{var p,d;l?(p=n.value)==null||p.open():(d=n.value)==null||d.close()}),(l,p)=>(m(),h(U,null,[M(re,{name:"fade"},{default:ie(()=>[f.value?(m(),ge(We,{key:0,mode:"recorder","content-ready":g.value,"min-time":1500,"max-time":6e3,onReady:u},null,8,["content-ready"])):C("",!0)]),_:1}),t("div",Mn,[t("header",Pn,[t("div",Ln,[t("div",Bn,[t("span",{class:w(["w-3 h-3 rounded-full",i.value?"bg-r58-accent-danger animate-recording":"bg-r58-bg-tertiary"])},null,2),p[0]||(p[0]=t("span",{class:"text-xl font-semibold"},"Recorder",-1))]),i.value?(m(),h("span",Dn,"RECORDING")):C("",!0),M(ht)]),M(ct)]),t("div",Nn,[t("div",In,[M(Qt)]),t("aside",Fn,[M(An)])]),M(ve,{ref_key:"leaveDialog",ref:n,title:"Recording in Progress",message:`You are currently recording (${r.value}). Leaving will stop the recording and save all files.`,"confirm-text":"Leave and Stop Recording","cancel-text":"Stay",danger:!0,onConfirm:k(c),onCancel:k(a)},null,8,["message","onConfirm","onCancel"])])],64))}}),Gn=le(Wn,[["__scopeId","data-v-3d0e61bc"]]);export{Gn as default};
