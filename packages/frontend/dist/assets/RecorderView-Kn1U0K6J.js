import{A as D,B as L,j as V,k as Q,C as Me,r as y,h as x,D as Ae,d as N,E as ae,l as P,T as ie,m as le,G as Ee,c as b,b as C,a as t,w as Pe,x as Le,t as _,s as Be,o as m,_ as ce,H as De,g as I,F as U,n as w,p as Y,I as ve,J as k,K as Ne,L as Ie,M as me,e as Fe,q as be,u as We,N as je,f as He}from"./index-DPtvnC1X.js";import{M as Ge}from"./ModeLoadingScreen-B05WPC8i.js";const H=y(!1),z=y(!1);let G=null;function Ue(){const n=D();L(()=>n.status,i=>{H.value=i==="recording"},{immediate:!0});function e(i){if(H.value)return i.preventDefault(),i.returnValue="Recording in progress. Are you sure you want to leave?",i.returnValue}V(()=>{window.addEventListener("beforeunload",e)}),Q(()=>{window.removeEventListener("beforeunload",e)}),Me((i,u,l)=>{H.value?(G=()=>l(),z.value=!0,l(!1)):l()});function o(){z.value=!1,H.value=!1,n.stopRecording().finally(()=>{G&&(G(),G=null)})}function c(){z.value=!1,G=null}return{isGuardActive:H,showLeaveConfirmation:z,confirmLeave:o,cancelLeave:c}}const R=y(null),Z=y(!1),pe=y(null),ee=y(null),Ve=10,te=2,Oe=25;function qe(){const n=x(()=>R.value?R.value.available_gb<te?"critical":R.value.available_gb<Ve?"warning":"ok":"unknown"),e=x(()=>R.value?R.value.available_gb>=te:!0),o=x(()=>{if(!R.value)return null;const f=R.value.available_gb*1024*1024*1024,v=Oe*1024*1024,h=f/v,r=Math.floor(h/3600),a=Math.floor(h%3600/60);return r>24?`${Math.floor(r/24)}d ${r%24}h`:r>0?`${r}h ${a}m`:`${a}m`}),c=x(()=>{switch(n.value){case"ok":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}}),i=x(()=>R.value?n.value==="critical"?`Disk space critically low (${R.value.available_gb.toFixed(1)} GB). Cannot start recording.`:n.value==="warning"?`Low disk space (${R.value.available_gb.toFixed(1)} GB). Estimated recording time: ${o.value}`:null:null);async function u(){Z.value=!0,ee.value=null;try{const f=await Ae.getDegradation();if(f.resources&&f.resources.disk_free_gb!==void 0){const v=f.resources.disk_free_gb,h=v*3;R.value={available_gb:v,total_gb:h,used_percent:100-v/h*100,recording_path:"/opt/r58-app/shared/recordings"}}return pe.value=new Date,R.value}catch(f){return ee.value=f.message||"Failed to check disk space",console.error("Failed to check disk space:",f),null}finally{Z.value=!1}}async function l(){return await u(),R.value?n.value==="critical"?{ok:!1,message:`Insufficient disk space (${R.value.available_gb.toFixed(1)} GB). Need at least ${te} GB to start recording.`}:n.value==="warning"?{ok:!0,message:`Low disk space warning: ${R.value.available_gb.toFixed(1)} GB available. Estimated recording time: ${o.value}`}:{ok:!0}:{ok:!0,message:"Could not verify disk space. Proceeding with caution."}}return{diskSpace:R,isLoading:Z,lastCheck:pe,error:ee,status:n,statusColor:c,canStartRecording:e,estimatedRecordingTime:o,warningMessage:i,checkDiskSpace:u,preflightCheck:l}}const E=y(localStorage.getItem("r58_audio_feedback")!=="false");let ne=null;function ze(){return ne||(ne=new(window.AudioContext||window.webkitAudioContext)),ne}function A(n,e,o="sine",c=.3){if(E.value)try{const i=ze();i.state==="suspended"&&i.resume();const u=i.createOscillator(),l=i.createGain();u.connect(l),l.connect(i.destination),u.type=o,u.frequency.value=n;const f=i.currentTime;l.gain.setValueAtTime(0,f),l.gain.linearRampToValueAtTime(c,f+.01),l.gain.linearRampToValueAtTime(0,f+e),u.start(f),u.stop(f+e)}catch(i){console.warn("Audio feedback failed:",i)}}function Ke(){E.value&&(A(440,.1,"sine",.2),setTimeout(()=>A(554,.1,"sine",.2),100),setTimeout(()=>A(659,.15,"sine",.25),200))}function Ye(){E.value&&(A(880,.08,"sine",.3),setTimeout(()=>A(880,.15,"sine",.3),120))}function Qe(){E.value&&(A(659,.1,"sine",.25),setTimeout(()=>A(554,.1,"sine",.2),100),setTimeout(()=>A(440,.15,"sine",.2),200))}function Xe(){E.value&&(A(200,.15,"square",.15),setTimeout(()=>A(180,.2,"square",.15),180))}function Je(){E.value&&(A(1e3,.08,"sine",.2),setTimeout(()=>A(1e3,.08,"sine",.2),150))}function ge(){E.value&&A(1200,.03,"sine",.1)}function Ze(n=50){if(E.value&&"vibrate"in navigator)try{navigator.vibrate(n)}catch{}}function he(){function n(o){E.value=o,localStorage.setItem("r58_audio_feedback",String(o))}function e(){n(!E.value),E.value&&ge()}return{enabled:E,setEnabled:n,toggle:e,playSuccess:Ke,playError:Xe,playWarning:Je,playClick:ge,playRecordStart:Ye,playRecordStop:Qe,vibrate:Ze}}const et={class:"bg-r58-bg-secondary rounded-lg shadow-xl max-w-md w-full p-6"},tt=["placeholder"],nt={class:"text-xs text-r58-text-secondary mt-2"},ot=N({__name:"SessionNameDialog",props:{open:{type:Boolean},suggestedName:{}},emits:["confirm","cancel","skip"],setup(n,{emit:e}){const o=n,c=e,i=y(""),u=y(null),l=x(()=>{const d=new Date,s=d.toLocaleDateString("en-CA"),p=d.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}).replace(":","");return`Recording_${s}_${p}`}),f=x(()=>o.suggestedName||l.value);L(()=>o.open,d=>{d&&(i.value=f.value,setTimeout(()=>{var s,p;(s=u.value)==null||s.focus(),(p=u.value)==null||p.select()},100))});function v(){c("confirm",i.value.trim()||f.value)}function h(){c("skip")}function r(){c("cancel")}function a(d){d.key==="Enter"?v():d.key==="Escape"&&r()}return(d,s)=>(m(),ae(Ee,{to:"body"},[P(ie,{name:"fade"},{default:le(()=>[n.open?(m(),b("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:Be(r,["self"]),onKeydown:a},[t("div",et,[s[1]||(s[1]=t("h2",{class:"text-lg font-semibold mb-2"},"Name This Recording",-1)),s[2]||(s[2]=t("p",{class:"text-r58-text-secondary text-sm mb-4"}," Give your recording a name to find it easily later (optional). ",-1)),Pe(t("input",{ref_key:"inputRef",ref:u,"onUpdate:modelValue":s[0]||(s[0]=p=>i.value=p),type:"text",placeholder:f.value,class:"w-full px-4 py-2 bg-r58-bg-tertiary border border-r58-bg-tertiary rounded-lg text-r58-text-primary placeholder-r58-text-secondary focus:outline-none focus:ring-2 focus:ring-r58-accent-primary"},null,8,tt),[[Le,i.value]]),t("p",nt," Suggested: "+_(f.value),1),t("div",{class:"flex justify-between mt-6"},[t("button",{onClick:h,class:"text-sm text-r58-text-secondary hover:text-r58-text-primary transition-colors"}," Skip (use default) "),t("div",{class:"flex gap-3"},[t("button",{onClick:r,class:"btn"}," Cancel "),t("button",{onClick:v,class:"btn btn-primary"}," Start Recording ")])])])],32)):C("",!0)]),_:1})]))}}),st=ce(ot,[["__scopeId","data-v-df8c0a50"]]),rt={class:"flex items-center gap-4"},at={key:0,class:"font-mono text-xl text-r58-accent-danger"},it=["disabled","title"],lt={key:0,class:"animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"},ct={key:0,class:"w-3 h-3 bg-white rounded-sm"},ut={key:1,class:"w-3 h-3 bg-white rounded-full"},dt={class:"text-xs text-r58-text-secondary hidden md:inline"},ft=N({__name:"RecorderControls",setup(n){const e=D(),{register:o}=De(),{preflightCheck:c,status:i,canStartRecording:u}=qe(),{playRecordStart:l,playRecordStop:f,playError:v,playWarning:h,vibrate:r}=he(),a=y(null),d=y(!1),s=y(!1),p=y(!1),g=y(!1),S=y(void 0),$=x(()=>e.status==="recording"),W=x(()=>e.status==="starting"),O=x(()=>e.status==="stopping"),X=x(()=>e.formattedDuration),xe=x(()=>W.value||O.value||s.value),_e=x(()=>W.value?"Starting recording...":O.value?"Stopping recording...":s.value?"Checking disk space...":!$.value&&!u.value?"Insufficient disk space":"");let J=null;V(()=>{J=o({key:" ",description:"Toggle Recording",action:we,context:"recorder",enabled:()=>!W.value&&!O.value})}),Q(()=>{J&&J()});async function we(){$.value?fe():await q()}async function q(T){s.value=!0;try{const M=await c();if(!M.ok){v(),r(200),I.error("Cannot start recording",M.message||"Preflight check failed");return}if(M.message&&i.value==="warning"&&(h(),I.warning("Low disk space",M.message)),g.value&&!T){S.value=void 0,p.value=!0;return}await de(T||S.value)}finally{s.value=!1}}async function de(T){try{await e.startRecording(T);const M=T||e.sessionId;l(),r([50,30,50]),I.success("Recording started",`Session: ${M}`)}catch(M){v(),r(200),I.error("Failed to start recording",M.message||"Unknown error",{label:"Retry",onClick:()=>q(T)})}}function ke(T){p.value=!1,S.value=T,q(T)}function Se(){p.value=!1,S.value=void 0,q()}function $e(){p.value=!1,s.value=!1}async function Ce(){try{await e.stopRecording(),f(),r(100),I.success("Recording stopped",`Duration: ${X.value}`)}catch(T){v(),r(200),I.error("Failed to stop recording",T.message||"Unknown error")}}function fe(){var T;d.value=!1,(T=a.value)==null||T.open(),setTimeout(()=>{d.value=!0},500)}function Re(){d.value&&Ce()}async function Te(){$.value?fe():await de()}return(T,M)=>(m(),b(U,null,[t("div",rt,[$.value?(m(),b("div",at,_(X.value),1)):C("",!0),t("button",{onClick:Te,disabled:xe.value,class:w(["flex items-center gap-2 px-6 py-2 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed",[$.value?"bg-r58-accent-danger hover:bg-red-600 text-white":"bg-r58-accent-success hover:bg-green-600 text-white"]]),title:_e.value||($.value?"Stop Recording (Space)":"Start Recording (Space)")},[W.value||O.value||s.value?(m(),b("span",lt)):(m(),b(U,{key:1},[$.value?(m(),b("span",ct)):(m(),b("span",ut))],64)),t("span",null,_(s.value?"Checking...":$.value?"Stop":"Start Recording"),1)],10,it),t("span",dt,[M[0]||(M[0]=Y(" Press ",-1)),M[1]||(M[1]=t("kbd",{class:"px-1 py-0.5 bg-r58-bg-tertiary rounded text-xs font-mono"},"Space",-1)),Y(" to "+_($.value?"stop":"start"),1)])]),P(ve,{ref_key:"stopConfirmDialog",ref:a,title:"Stop Recording?",message:`You have been recording for ${X.value}. This will finalize all files.`,"confirm-text":"Stop Recording","cancel-text":"Keep Recording",danger:!0,onConfirm:Re},null,8,["message"]),P(st,{open:p.value,onConfirm:ke,onSkip:Se,onCancel:$e},null,8,["open"])],64))}}),K=y(localStorage.getItem("r58_performance_mode")==="true"),oe=y(localStorage.getItem("r58_performance_mode_auto")!=="false"),pt=3,gt=100,vt=500;function ye(){const n=D(),e=x(()=>K.value?!0:oe.value&&n.isRecording?n.inputs.filter(a=>a.isRecording).length>=pt:!1),o=x(()=>e.value?vt:gt);L(e,r=>{r?document.body.classList.add("performance-mode"):document.body.classList.remove("performance-mode")},{immediate:!0});function c(r){K.value=r,localStorage.setItem("r58_performance_mode",String(r))}function i(r){oe.value=r,localStorage.setItem("r58_performance_mode_auto",String(r))}function u(){c(!K.value)}function l(r,a){let d=0,s=null;return(...p)=>{const g=Date.now(),S=a??o.value,$=g-d;$>=S?(d=g,r(...p)):s||(s=window.setTimeout(()=>{d=Date.now(),s=null,r(...p)},S-$))}}function f(r,a){let d=null;return(...s)=>{d&&clearTimeout(d),d=window.setTimeout(()=>{r(...s),d=null},a??o.value)}}function v(r){return e.value?window.setTimeout(()=>r(performance.now()),o.value):requestAnimationFrame(r)}function h(r){e.value?clearTimeout(r):cancelAnimationFrame(r)}return{enabled:K,autoEnable:oe,isActive:e,updateInterval:o,setEnabled:c,setAutoEnable:i,toggle:u,throttle:l,debounce:f,requestFrame:v,cancelFrame:h}}const mt=["title"],bt={class:"flex items-center gap-1.5 text-sm"},ht={key:0,class:"flex items-center gap-1.5 text-sm"},yt={key:1,class:"flex items-center gap-1.5 text-sm text-red-400"},xt={class:"font-mono"},_t=N({__name:"RecordingHealth",setup(n,{expose:e}){const o=D(),{isActive:c}=ye(),i=y({}),u=y(0),l=y(0),f=y(0);let v=null;function h(){const p={};let g=0;o.inputs.forEach($=>{p[$.id]=$.bytesWritten;const W=i.value[$.id]||0;g+=$.bytesWritten-W});const S=c.value?2:1;u.value=Math.round(g/(1024*1024)/S*10)/10,i.value=p}L(()=>o.isRecording,p=>{if(p){i.value={},u.value=0,l.value=0,f.value=0;const g=c.value?2e3:1e3;v=window.setInterval(h,g)}else v&&(clearInterval(v),v=null)},{immediate:!0}),L(c,p=>{if(o.isRecording&&v){clearInterval(v);const g=p?2e3:1e3;v=window.setInterval(h,g)}}),Q(()=>{v&&clearInterval(v)});const r=x(()=>o.isRecording?f.value>0||l.value>90?"critical":u.value<1||l.value>70?"warning":"healthy":"idle"),a=x(()=>{switch(r.value){case"healthy":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}});x(()=>{switch(r.value){case"healthy":return"Healthy";case"warning":return"Warning";case"critical":return"Critical";default:return"Idle"}});const d=x(()=>{if(!o.isRecording)return"Not recording";const p=[`Write speed: ${u.value} MB/s`,`Buffer: ${l.value}%`];return f.value>0&&p.push(`Frames dropped: ${f.value}`),p.join(`
`)});function s(p){p.buffer_percent!==void 0&&(l.value=p.buffer_percent),p.frames_dropped!==void 0&&(f.value=p.frames_dropped)}return e({updateFromMetrics:s}),(p,g)=>k(o).isRecording?(m(),b("div",{key:0,class:w(["flex items-center gap-3 px-3 py-1.5 rounded-lg transition-colors cursor-help",{"bg-emerald-500/10":a.value==="emerald","bg-amber-500/10":a.value==="amber","bg-red-500/10":a.value==="red"}]),title:d.value},[t("span",{class:w(["w-2 h-2 rounded-full",a.value==="emerald"?"bg-emerald-500":"",a.value==="amber"?"bg-amber-500 animate-pulse":"",a.value==="red"?"bg-red-500 animate-pulse":""])},null,2),t("div",bt,[g[0]||(g[0]=t("svg",{class:"w-3.5 h-3.5 text-r58-text-secondary",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})],-1)),t("span",{class:w(["font-mono",a.value==="emerald"?"text-emerald-400":"",a.value==="amber"?"text-amber-400":"",a.value==="red"?"text-red-400":""])},_(u.value)+" MB/s ",3)]),l.value>0?(m(),b("div",ht,[g[1]||(g[1]=t("span",{class:"text-r58-text-secondary"},"Buf:",-1)),t("span",{class:w(["font-mono",l.value<50?"text-emerald-400":"",l.value>=50&&l.value<80?"text-amber-400":"",l.value>=80?"text-red-400":""])},_(l.value)+"% ",3)])):C("",!0),f.value>0?(m(),b("div",yt,[g[2]||(g[2]=t("svg",{class:"w-3.5 h-3.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),t("span",xt,_(f.value)+" dropped",1)])):C("",!0)],10,mt)):C("",!0)}}),wt=["65.109.32.111"],kt=["100.98.37.53","192.168.1.24"],St=5,$t=1e3,Ct=3e4,B=new Map,j=new Map;function Rt(n){const e=Ie();if(e&&!Ne())try{return`http://${new URL(e).hostname}:8889/${n}/whep`}catch{console.warn("[WHEP Manager] Invalid device URL, falling back to FRP")}return`https://r58-mediamtx.itagenten.no/${n}/whep`}async function Tt(n,e){for(let o=0;o<3;o++){o>0&&await new Promise(c=>setTimeout(c,200));try{const c=await n.getStats();for(const i of c.values())if(i.type==="candidate-pair"&&i.state==="succeeded"){const u=c.get(i.remoteCandidateId),l=u==null?void 0:u.address;return(u==null?void 0:u.candidateType)==="relay"||l&&wt.includes(l)?"relay":l&&kt.includes(l)||l&&(l.startsWith("100.")||l.startsWith("192.168.")||l.startsWith("10.")||l.startsWith("172."))?"p2p":"relay"}}catch(c){console.warn(`[WHEP Manager ${e}] Failed to detect connection type:`,c)}}return"unknown"}function F(n){const e=B.get(n);if(!e)return;const o=j.get(n);o&&o.forEach(c=>c(e))}function se(n){const e=B.get(n);if(!e)return;if(e.reconnectAttempts>=St){console.error(`[WHEP Manager ${n}] Max reconnect attempts reached`),e.state="failed",F(n);return}e.reconnectAttempts++;const o=Math.min($t*Math.pow(2,e.reconnectAttempts-1),Ct);console.log(`[WHEP Manager ${n}] Scheduling reconnect #${e.reconnectAttempts} in ${o}ms`),e.state="connecting",F(n),e.reconnectTimeout&&clearTimeout(e.reconnectTimeout),e.reconnectTimeout=setTimeout(()=>{ue(n)},o)}async function ue(n){let e=B.get(n);if(e&&(e.state==="connected"||e.state==="connecting"))return console.log(`[WHEP Manager ${n}] Reusing existing connection (state: ${e.state})`),e;const o=Rt(n);console.log(`[WHEP Manager ${n}] Creating new connection: ${o}`),e!=null&&e.peerConnection&&e.peerConnection.close();const c=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}]});e?(e.peerConnection=c,e.state="connecting",e.whepUrl=o,e.mediaStream=null,e.connectionType="unknown"):(e={cameraId:n,peerConnection:c,mediaStream:null,state:"connecting",connectionType:"unknown",refCount:0,whepUrl:o,lastConnectedAt:null,reconnectAttempts:(e==null?void 0:e.reconnectAttempts)||0,reconnectTimeout:null},B.set(n,e)),c.ontrack=i=>{i.streams[0]&&(e.mediaStream=i.streams[0],console.log(`[WHEP Manager ${n}] Received media stream`),F(n))},c.oniceconnectionstatechange=async()=>{const i=c.iceConnectionState;console.log(`[WHEP Manager ${n}] ICE state: ${i}`),i==="connected"||i==="completed"?(e.state="connected",e.lastConnectedAt=Date.now(),e.reconnectAttempts=0,e.connectionType=await Tt(c,n),console.log(`[WHEP Manager ${n}] Connected (${e.connectionType})`),F(n)):i==="failed"?(e.state="failed",e.connectionType="unknown",F(n),e.refCount>0&&se(n)):i==="disconnected"&&setTimeout(()=>{(c.iceConnectionState==="disconnected"||c.iceConnectionState==="failed")&&(e.state="disconnected",F(n),e.refCount>0&&se(n))},3e3)},c.addTransceiver("video",{direction:"recvonly"}),c.addTransceiver("audio",{direction:"recvonly"});try{const i=await c.createOffer();await c.setLocalDescription(i);const u=await fetch(o,{method:"POST",headers:{"Content-Type":"application/sdp"},body:i.sdp});if(!u.ok)throw new Error(`WHEP request failed: ${u.status}`);const l=await u.text();await c.setRemoteDescription({type:"answer",sdp:l})}catch(i){console.error(`[WHEP Manager ${n}] Connection error:`,i),e.state="failed",F(n),e.refCount>0&&se(n)}return e}async function Mt(n,e){j.has(n)||j.set(n,new Set),j.get(n).add(e);let o=B.get(n);return(!o||o.state==="failed"||o.state==="disconnected")&&(o=await ue(n)),o.refCount++,console.log(`[WHEP Manager ${n}] Acquired connection (refCount: ${o.refCount})`),e(o),o}function At(n,e){const o=B.get(n);if(!o)return;const c=j.get(n);c&&(c.delete(e),c.size===0&&j.delete(n)),o.refCount=Math.max(0,o.refCount-1),console.log(`[WHEP Manager ${n}] Released connection (refCount: ${o.refCount})`),o.refCount===0&&(console.log(`[WHEP Manager ${n}] Closing unused connection`),o.reconnectTimeout&&clearTimeout(o.reconnectTimeout),o.peerConnection.close(),B.delete(n))}function re(n){const e=B.get(n);e&&(console.log(`[WHEP Manager ${n}] Force reconnecting...`),e.reconnectAttempts=0,ue(n))}const Et={class:"relative w-full h-full bg-black"},Pt=["title"],Lt={key:1,class:"absolute inset-0 flex items-center justify-center bg-black/50"},Bt={key:2,class:"absolute inset-0 flex items-center justify-center bg-black/70"},Dt={class:"text-center"},Nt={class:"text-xs text-amber-400"},It={key:3,class:"absolute inset-0 flex items-center justify-center bg-black/80"},Ft={class:"text-center text-r58-text-secondary"},Wt={class:"text-sm"},jt=N({__name:"InputPreview",props:{inputId:{},protocol:{}},setup(n){const e=n,o=D(),c=x(()=>o.status==="recording"),i=y(null),u=y(!0),l=y(null),f=y("unknown"),v=y(!1),h=y(0);let r=null;function a(g){switch(console.log(`[InputPreview ${e.inputId}] Connection update:`,{state:g.state,type:g.connectionType,hasStream:!!g.mediaStream}),f.value=g.connectionType,h.value=g.reconnectAttempts,g.state){case"connecting":u.value=!0,l.value=null,v.value=g.reconnectAttempts>0;break;case"connected":u.value=!1,l.value=null,v.value=!1,g.mediaStream&&i.value&&i.value.srcObject!==g.mediaStream&&(i.value.srcObject=g.mediaStream);break;case"disconnected":v.value=!0,l.value=`Reconnecting... (${g.reconnectAttempts}/5)`;break;case"failed":u.value=!1,v.value=!1,l.value="Connection failed after multiple attempts";break}}async function d(){if(i.value){p(),u.value=!0,l.value=null,r=a;try{await Mt(e.inputId,r)}catch(g){console.error(`[InputPreview ${e.inputId}] Failed to acquire connection:`,g),l.value=g instanceof Error?g.message:"Failed to connect",u.value=!1}}}function s(){re(e.inputId)}function p(){r&&(At(e.inputId,r),r=null)}return V(()=>{d()}),L(()=>e.inputId,()=>{d()}),L(c,(g,S)=>{S&&!g&&l.value?(console.log("[InputPreview] Recording stopped, reconnecting preview..."),re(e.inputId)):!S&&g&&(console.log("[InputPreview] Recording started, will try to reconnect preview after delay..."),setTimeout(()=>{c.value&&(console.log("[InputPreview] Attempting to reconnect preview during recording..."),re(e.inputId))},2e3))}),Q(()=>{p()}),(g,S)=>(m(),b("div",Et,[t("video",{ref_key:"videoRef",ref:i,autoplay:"",muted:"",playsinline:"",class:"w-full h-full object-contain"},null,512),!u.value&&!l.value&&f.value!=="unknown"?(m(),b("div",{key:0,class:w(["absolute top-1 right-1 px-1.5 py-0.5 text-[10px] font-medium rounded",f.value==="p2p"?"bg-emerald-500/80 text-white":"bg-amber-500/80 text-white"]),title:f.value==="p2p"?"Direct P2P connection":"Relay connection (FRP)"},_(f.value==="p2p"?"P2P":"RELAY"),11,Pt)):C("",!0),u.value&&!v.value?(m(),b("div",Lt,[...S[0]||(S[0]=[t("div",{class:"animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"},null,-1)])])):C("",!0),v.value?(m(),b("div",Bt,[t("div",Dt,[S[1]||(S[1]=t("div",{class:"animate-spin w-5 h-5 border-2 border-amber-400 border-t-transparent rounded-full mx-auto mb-2"},null,-1)),t("p",Nt,_(l.value||"Reconnecting..."),1)])])):l.value&&!u.value?(m(),b("div",It,[t("div",Ft,[t("p",Wt,_(l.value),1),t("button",{onClick:s,class:"mt-2 text-xs text-r58-accent-primary hover:underline"}," Retry ")])])):C("",!0)]))}}),Ht={key:0,class:"h-full flex items-center justify-center"},Gt={key:1,class:"h-full flex flex-col gap-2"},Ut={key:0,class:"flex items-center gap-2 px-3 py-1.5 bg-amber-500/10 border border-amber-500/30 rounded-lg text-amber-400 text-sm"},Vt=["title"],Ot={key:1,class:"w-full h-full flex items-center justify-center bg-r58-bg-tertiary"},qt={class:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-4"},zt={class:"flex items-center justify-between"},Kt={class:"flex items-center gap-2"},Yt={class:"font-medium"},Qt={key:0,class:"flex items-center gap-2 text-sm"},Xt={class:"text-r58-text-secondary"},Jt={key:0,class:"mt-2 flex items-center justify-between"},Zt={class:"text-sm font-mono text-r58-text-secondary"},en=N({__name:"InputGrid",setup(n){const e=D(),o=me(),c=x(()=>{var s;const a=(s=o.capabilities)==null?void 0:s.current_mode,d=a==="recorder";return console.log(`[InputGrid] Mode check: current_mode="${a}", isRecorderMode=${d}`),d}),i=x(()=>e.inputs.filter(a=>a.hasSignal)),u=x(()=>e.framerateMismatch);function l(a){return a.isRecording?"border-r58-accent-danger ring-2 ring-r58-accent-danger/20":a.hasSignal?"border-emerald-500/50 hover:border-emerald-500":"border-r58-bg-tertiary/50 opacity-60"}function f(a){return a.hasSignal?a.framerate>=29?"excellent":a.framerate>=24?"good":"unstable":"none"}function v(a){switch(f(a)){case"excellent":return"text-emerald-400";case"good":return"text-emerald-400";case"unstable":return"text-amber-400";case"none":return"text-r58-text-secondary"}}function h(a){if(a===0)return"0 B";const d=1024,s=["B","KB","MB","GB"],p=Math.floor(Math.log(a)/Math.log(d));return parseFloat((a/Math.pow(d,p)).toFixed(1))+" "+s[p]}function r(a){if(!a.hasSignal)return`${a.label}: No signal detected`;const d=[`${a.label}`,`Resolution: ${a.resolution}`,`Framerate: ${a.framerate} fps`,`Quality: ${f(a)}`];return a.isRecording&&d.push(`Written: ${h(a.bytesWritten)}`),d.join(`
`)}return(a,d)=>i.value.length===0?(m(),b("div",Ht,[...d[0]||(d[0]=[Fe('<div class="text-center text-r58-text-secondary"><svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg><p class="text-lg font-medium">No Video Sources Connected</p><p class="text-sm mt-2">Connect HDMI cables to begin recording</p></div>',1)])])):(m(),b("div",Gt,[u.value?(m(),b("div",Ut,[d[1]||(d[1]=t("svg",{class:"w-4 h-4 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20"},[t("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),t("span",null,_(u.value),1)])):C("",!0),t("div",{class:w(["flex-1 grid gap-4",i.value.length===1?"grid-cols-1":"grid-cols-2"])},[(m(!0),b(U,null,be(i.value,s=>(m(),b("div",{key:s.id,class:w(["relative rounded-lg overflow-hidden border-2 transition-all cursor-pointer aspect-video bg-black",l(s)]),title:r(s)},[c.value?(m(),ae(jt,{key:0,"input-id":s.id,class:"w-full h-full"},null,8,["input-id"])):(m(),b("div",Ot,[...d[2]||(d[2]=[t("div",{class:"text-center"},[t("svg",{class:"w-8 h-8 mx-auto mb-2 text-r58-text-secondary/50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})]),t("span",{class:"text-xs text-r58-text-secondary/70"},"Mixer mode")],-1)])])),t("div",qt,[t("div",zt,[t("div",Kt,[t("span",{class:w(["w-2 h-2 rounded-full transition-colors",{"bg-emerald-500":f(s)==="excellent"||f(s)==="good","bg-amber-500 animate-pulse":f(s)==="unstable","bg-r58-text-secondary":f(s)==="none"}])},null,2),t("span",Yt,_(s.label),1)]),s.hasSignal?(m(),b("div",Qt,[t("span",Xt,_(s.resolution),1),t("span",{class:w(v(s))},_(s.framerate)+"fps",3)])):C("",!0)]),s.isRecording?(m(),b("div",Jt,[d[3]||(d[3]=t("div",{class:"flex items-center gap-2 text-r58-accent-danger"},[t("span",{class:"w-2 h-2 rounded-full bg-r58-accent-danger animate-recording"}),t("span",{class:"text-sm font-medium"},"REC")],-1)),t("span",Zt,_(h(s.bytesWritten)),1)])):C("",!0)])],10,Vt))),128))],2)]))}}),tn={class:"space-y-4"},nn={class:"flex items-center justify-between py-2 cursor-pointer"},on=["aria-checked"],sn={class:"flex items-center justify-between py-2 cursor-pointer"},rn=["aria-checked"],an={class:"flex items-center justify-between py-2 cursor-pointer"},ln={class:"text-xs text-r58-text-secondary"},cn={key:0,class:"text-amber-400"},un=["aria-checked"],dn={class:"flex items-center justify-between py-2 pl-4 cursor-pointer opacity-80"},fn=["aria-checked"],pn=N({__name:"SettingsPanel",setup(n){const{enabled:e,toggle:o,playClick:c}=he(),{enabled:i,autoEnable:u,isActive:l,setEnabled:f,setAutoEnable:v}=ye(),h=y(!1);function r(){h.value=!h.value,h.value?(document.body.classList.add("touch-mode"),localStorage.setItem("r58_touch_mode","true")):(document.body.classList.remove("touch-mode"),localStorage.setItem("r58_touch_mode","false"))}V(()=>{const d=localStorage.getItem("r58_touch_mode")==="true";h.value=d,d&&document.body.classList.add("touch-mode")});function a(){o(),e.value&&c()}return(d,s)=>(m(),b("div",tn,[s[7]||(s[7]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide"}," Interface Settings ",-1)),t("label",nn,[s[2]||(s[2]=t("div",null,[t("span",{class:"text-r58-text-primary"},"Audio Feedback"),t("p",{class:"text-xs text-r58-text-secondary"},"Play sounds for recording start/stop")],-1)),t("button",{onClick:a,class:w(["relative w-12 h-7 rounded-full transition-colors",k(e)?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":k(e)},[t("span",{class:w(["absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform",k(e)?"translate-x-6":"translate-x-1"])},null,2)],10,on)]),t("label",sn,[s[3]||(s[3]=t("div",null,[t("span",{class:"text-r58-text-primary"},"Touch Mode"),t("p",{class:"text-xs text-r58-text-secondary"},"Larger buttons for touchscreen")],-1)),t("button",{onClick:r,class:w(["relative w-12 h-7 rounded-full transition-colors",h.value?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":h.value},[t("span",{class:w(["absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform",h.value?"translate-x-6":"translate-x-1"])},null,2)],10,rn)]),t("label",an,[t("div",null,[s[5]||(s[5]=t("span",{class:"text-r58-text-primary"},"Performance Mode",-1)),t("p",ln,[s[4]||(s[4]=Y(" Reduce UI updates during recording ",-1)),k(l)&&!k(i)?(m(),b("span",cn,"(auto-enabled)")):C("",!0)])]),t("button",{onClick:s[0]||(s[0]=p=>k(f)(!k(i))),class:w(["relative w-12 h-7 rounded-full transition-colors",k(i)?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":k(i)},[t("span",{class:w(["absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform",k(i)?"translate-x-6":"translate-x-1"])},null,2)],10,un)]),t("label",dn,[s[6]||(s[6]=t("div",null,[t("span",{class:"text-sm text-r58-text-primary"},"Auto-enable when recording 3+ inputs")],-1)),t("button",{onClick:s[1]||(s[1]=p=>k(v)(!k(u))),class:w(["relative w-10 h-6 rounded-full transition-colors",k(u)?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":k(u)},[t("span",{class:w(["absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform",k(u)?"translate-x-4":"translate-x-0.5"])},null,2)],10,fn)])]))}}),gn={class:"space-y-6"},vn={key:0,class:"card"},mn={class:"space-y-2"},bn={class:"flex justify-between"},hn={class:"flex justify-between"},yn={class:"font-mono"},xn={class:"flex justify-between"},_n={class:"card"},wn={class:"space-y-3"},kn={class:"flex items-center gap-2"},Sn={key:0,class:"text-sm text-r58-text-secondary"},$n={key:0,class:"text-r58-accent-danger"},Cn={key:1},Rn={key:1,class:"text-sm text-r58-text-secondary"},Tn={class:"card"},Mn={class:"space-y-2"},An=["disabled","title"],En={key:0,class:"absolute -top-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-r58-bg-tertiary text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none"},Pn={key:0,class:"card"},Ln=N({__name:"SessionInfo",setup(n){const e=We(),o=D(),c=x(()=>o.currentSession),i=x(()=>o.activeInputs),u=x(()=>o.isRecording),l=y(!1);function f(h){if(h===0)return"0 B";const r=1024,a=["B","KB","MB","GB","TB"],d=Math.floor(Math.log(h)/Math.log(r));return parseFloat((h/Math.pow(r,d)).toFixed(2))+" "+a[d]}function v(){e.push({name:"admin",query:{tab:"settings"}})}return(h,r)=>(m(),b("div",gn,[c.value?(m(),b("div",vn,[r[4]||(r[4]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide mb-3"},"Current Session",-1)),t("div",mn,[t("div",bn,[r[1]||(r[1]=t("span",{class:"text-r58-text-secondary"},"Started",-1)),t("span",null,_(c.value.startedAt.toLocaleTimeString()),1)]),t("div",hn,[r[2]||(r[2]=t("span",{class:"text-r58-text-secondary"},"Duration",-1)),t("span",yn,_(k(o).formattedDuration),1)]),t("div",xn,[r[3]||(r[3]=t("span",{class:"text-r58-text-secondary"},"Inputs",-1)),t("span",null,_(i.value.length)+" active",1)])])])):C("",!0),t("div",_n,[r[5]||(r[5]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide mb-3"},"Input Status",-1)),t("div",wn,[(m(!0),b(U,null,be(k(o).inputs,a=>(m(),b("div",{key:a.id,class:"flex items-center justify-between py-2 border-b border-r58-bg-tertiary last:border-0"},[t("div",kn,[t("span",{class:w(["w-2 h-2 rounded-full",a.hasSignal?"bg-r58-accent-success":"bg-r58-text-secondary"])},null,2),t("span",{class:w(a.hasSignal?"":"text-r58-text-secondary")},_(a.label),3)]),a.hasSignal?(m(),b("div",Sn,[a.isRecording?(m(),b("span",$n,_(f(a.bytesWritten)),1)):(m(),b("span",Cn,_(a.resolution),1))])):(m(),b("span",Rn,"No signal"))]))),128))])]),t("div",Tn,[r[7]||(r[7]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide mb-3"},"Quick Actions",-1)),t("div",Mn,[t("button",{onClick:v,class:"btn w-full justify-center disabled:opacity-50 disabled:cursor-not-allowed group relative",disabled:u.value,title:u.value?"Cannot configure while recording":"Open input configuration"},[r[6]||(r[6]=Y(" Configure Inputs ",-1)),u.value?(m(),b("span",En," Stop recording first ")):C("",!0)],8,An),t("button",{onClick:r[0]||(r[0]=a=>l.value=!l.value),class:"btn w-full justify-center"},_(l.value?"Hide Settings":"Interface Settings"),1)])]),P(ie,{name:"slide-fade"},{default:le(()=>[l.value?(m(),b("div",Pn,[P(pn)])):C("",!0)]),_:1})]))}}),Bn=ce(Ln,[["__scopeId","data-v-8910ebdc"]]),Dn={class:"h-full flex flex-col"},Nn={class:"flex items-center justify-between px-6 py-4 border-b border-r58-bg-tertiary bg-r58-bg-secondary"},In={class:"flex items-center gap-4"},Fn={class:"flex items-center gap-2"},Wn={key:0,class:"badge badge-danger"},jn={class:"flex-1 flex overflow-hidden"},Hn={class:"flex-1 p-4"},Gn={class:"w-80 border-l border-r58-bg-tertiary bg-r58-bg-secondary p-4 overflow-y-auto"},Un=N({__name:"RecorderView",setup(n){const e=D(),o=me(),{showLeaveConfirmation:c,confirmLeave:i,cancelLeave:u}=Ue(),l=x(()=>e.status==="recording"),f=x(()=>e.formattedDuration),v=y(!0),h=y(!1);function r(){v.value=!1}async function a(){var p;if(!je())return;await o.fetchCapabilities();const s=(p=o.capabilities)==null?void 0:p.current_mode;if(s&&s!=="recorder"){console.log("[Recorder] Not in recorder mode, switching...");try{(await fetch(He("/api/mode/recorder"),{method:"POST"})).ok&&(await o.fetchCapabilities(),I.success("Switched to Recorder mode"))}catch(g){console.warn("[Recorder] Failed to switch mode:",g)}}}V(async()=>{await a(),await e.fetchInputs(),await e.fetchStatus(),h.value=!0});const d=y(null);return L(c,s=>{var p,g;s?(p=d.value)==null||p.open():(g=d.value)==null||g.close()}),(s,p)=>(m(),b(U,null,[P(ie,{name:"fade"},{default:le(()=>[v.value?(m(),ae(Ge,{key:0,mode:"recorder","content-ready":h.value,"min-time":1500,"max-time":6e3,onReady:r},null,8,["content-ready"])):C("",!0)]),_:1}),t("div",Dn,[t("header",Nn,[t("div",In,[t("div",Fn,[t("span",{class:w(["w-3 h-3 rounded-full",l.value?"bg-r58-accent-danger animate-recording":"bg-r58-bg-tertiary"])},null,2),p[0]||(p[0]=t("span",{class:"text-xl font-semibold"},"Recorder",-1))]),l.value?(m(),b("span",Wn,"RECORDING")):C("",!0),P(_t)]),P(ft)]),t("div",jn,[t("div",Hn,[P(en)]),t("aside",Gn,[P(Bn)])]),P(ve,{ref_key:"leaveDialog",ref:d,title:"Recording in Progress",message:`You are currently recording (${f.value}). Leaving will stop the recording and save all files.`,"confirm-text":"Leave and Stop Recording","cancel-text":"Stay",danger:!0,onConfirm:k(i),onCancel:k(u)},null,8,["message","onConfirm","onCancel"])])],64))}}),qn=ce(Un,[["__scopeId","data-v-abd95771"]]);export{qn as default};
