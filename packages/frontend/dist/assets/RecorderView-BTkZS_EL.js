import{B as W,C as B,o as O,l as X,D as Ae,r as _,j as k,E as Pe,d as H,G as ie,m as D,T as le,p as ce,H as Le,c as y,e as C,a as t,w as De,y as Be,t as $,x as Ne,i as m,_ as ue,I as We,h as F,F as G,n as S,q as Y,J as me,K as R,L as Q,M as be,u as he,f as He,s as ye,g as Fe,N as Ie,b as Ue}from"./index-DvfUJgjj.js";import{M as je}from"./ModeLoadingScreen-DNQQHoD2.js";const j=_(!1),q=_(!1);let V=null;function Ve(){const n=W();B(()=>n.status,c=>{j.value=c==="recording"},{immediate:!0});function e(c){if(j.value)return c.preventDefault(),c.returnValue="Recording in progress. Are you sure you want to leave?",c.returnValue}O(()=>{window.addEventListener("beforeunload",e)}),X(()=>{window.removeEventListener("beforeunload",e)}),Ae((c,i,r)=>{j.value?(V=()=>r(),q.value=!0,r(!1)):r()});function o(){q.value=!1,j.value=!1,n.stopRecording().finally(()=>{V&&(V(),V=null)})}function v(){q.value=!1,V=null}return{isGuardActive:j,showLeaveConfirmation:q,confirmLeave:o,cancelLeave:v}}const T=_(null),ee=_(!1),pe=_(null),te=_(null),Ge=10,ne=2,Oe=25;function ze(){const n=k(()=>T.value?T.value.available_gb<ne?"critical":T.value.available_gb<Ge?"warning":"ok":"unknown"),e=k(()=>T.value?T.value.available_gb>=ne:!0),o=k(()=>{if(!T.value)return null;const a=T.value.available_gb*1024*1024*1024,d=Oe*1024*1024,p=a/d,s=Math.floor(p/3600),f=Math.floor(p%3600/60);return s>24?`${Math.floor(s/24)}d ${s%24}h`:s>0?`${s}h ${f}m`:`${f}m`}),v=k(()=>{switch(n.value){case"ok":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}}),c=k(()=>T.value?n.value==="critical"?`Disk space critically low (${T.value.available_gb.toFixed(1)} GB). Cannot start recording.`:n.value==="warning"?`Low disk space (${T.value.available_gb.toFixed(1)} GB). Estimated recording time: ${o.value}`:null:null);async function i(){ee.value=!0,te.value=null;try{const a=await Pe.getDegradation();if(a.resources&&a.resources.disk_free_gb!==void 0){const d=a.resources.disk_free_gb,p=d*3;T.value={available_gb:d,total_gb:p,used_percent:100-d/p*100,recording_path:"/opt/r58-app/shared/recordings"}}return pe.value=new Date,T.value}catch(a){return te.value=a.message||"Failed to check disk space",console.error("Failed to check disk space:",a),null}finally{ee.value=!1}}async function r(){return await i(),T.value?n.value==="critical"?{ok:!1,message:`Insufficient disk space (${T.value.available_gb.toFixed(1)} GB). Need at least ${ne} GB to start recording.`}:n.value==="warning"?{ok:!0,message:`Low disk space warning: ${T.value.available_gb.toFixed(1)} GB available. Estimated recording time: ${o.value}`}:{ok:!0}:{ok:!0,message:"Could not verify disk space. Proceeding with caution."}}return{diskSpace:T,isLoading:ee,lastCheck:pe,error:te,status:n,statusColor:v,canStartRecording:e,estimatedRecordingTime:o,warningMessage:c,checkDiskSpace:i,preflightCheck:r}}const L=_(localStorage.getItem("r58_audio_feedback")!=="false");let oe=null;function qe(){return oe||(oe=new(window.AudioContext||window.webkitAudioContext)),oe}function A(n,e,o="sine",v=.3){if(L.value)try{const c=qe();c.state==="suspended"&&c.resume();const i=c.createOscillator(),r=c.createGain();i.connect(r),r.connect(c.destination),i.type=o,i.frequency.value=n;const a=c.currentTime;r.gain.setValueAtTime(0,a),r.gain.linearRampToValueAtTime(v,a+.01),r.gain.linearRampToValueAtTime(0,a+e),i.start(a),i.stop(a+e)}catch(c){console.warn("Audio feedback failed:",c)}}function Ke(){L.value&&(A(440,.1,"sine",.2),setTimeout(()=>A(554,.1,"sine",.2),100),setTimeout(()=>A(659,.15,"sine",.25),200))}function Ye(){L.value&&(A(880,.08,"sine",.3),setTimeout(()=>A(880,.15,"sine",.3),120))}function Qe(){L.value&&(A(659,.1,"sine",.25),setTimeout(()=>A(554,.1,"sine",.2),100),setTimeout(()=>A(440,.15,"sine",.2),200))}function Xe(){L.value&&(A(200,.15,"square",.15),setTimeout(()=>A(180,.2,"square",.15),180))}function Je(){L.value&&(A(1e3,.08,"sine",.2),setTimeout(()=>A(1e3,.08,"sine",.2),150))}function ve(){L.value&&A(1200,.03,"sine",.1)}function Ze(n=50){if(L.value&&"vibrate"in navigator)try{navigator.vibrate(n)}catch{}}function xe(){function n(o){L.value=o,localStorage.setItem("r58_audio_feedback",String(o))}function e(){n(!L.value),L.value&&ve()}return{enabled:L,setEnabled:n,toggle:e,playSuccess:Ke,playError:Xe,playWarning:Je,playClick:ve,playRecordStart:Ye,playRecordStop:Qe,vibrate:Ze}}const et={class:"bg-r58-bg-secondary rounded-lg shadow-xl max-w-md w-full p-6"},tt=["placeholder"],nt={class:"text-xs text-r58-text-secondary mt-2"},ot=H({__name:"SessionNameDialog",props:{open:{type:Boolean},suggestedName:{}},emits:["confirm","cancel","skip"],setup(n,{emit:e}){const o=n,v=e,c=_(""),i=_(null),r=k(()=>{const x=new Date,u=x.toLocaleDateString("en-CA"),b=x.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}).replace(":","");return`Recording_${u}_${b}`}),a=k(()=>o.suggestedName||r.value);B(()=>o.open,x=>{x&&(c.value=a.value,setTimeout(()=>{var u,b;(u=i.value)==null||u.focus(),(b=i.value)==null||b.select()},100))});function d(){v("confirm",c.value.trim()||a.value)}function p(){v("skip")}function s(){v("cancel")}function f(x){x.key==="Enter"?d():x.key==="Escape"&&s()}return(x,u)=>(m(),ie(Le,{to:"body"},[D(le,{name:"fade"},{default:ce(()=>[n.open?(m(),y("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:Ne(s,["self"]),onKeydown:f},[t("div",et,[u[1]||(u[1]=t("h2",{class:"text-lg font-semibold mb-2"},"Name This Recording",-1)),u[2]||(u[2]=t("p",{class:"text-r58-text-secondary text-sm mb-4"}," Give your recording a name to find it easily later (optional). ",-1)),De(t("input",{ref_key:"inputRef",ref:i,"onUpdate:modelValue":u[0]||(u[0]=b=>c.value=b),type:"text",placeholder:a.value,class:"w-full px-4 py-2 bg-r58-bg-tertiary border border-r58-bg-tertiary rounded-lg text-r58-text-primary placeholder-r58-text-secondary focus:outline-none focus:ring-2 focus:ring-r58-accent-primary"},null,8,tt),[[Be,c.value]]),t("p",nt," Suggested: "+$(a.value),1),t("div",{class:"flex justify-between mt-6"},[t("button",{onClick:p,class:"text-sm text-r58-text-secondary hover:text-r58-text-primary transition-colors"}," Skip (use default) "),t("div",{class:"flex gap-3"},[t("button",{onClick:s,class:"btn"}," Cancel "),t("button",{onClick:d,class:"btn btn-primary"}," Start Recording ")])])])],32)):C("",!0)]),_:1})]))}}),st=ue(ot,[["__scopeId","data-v-df8c0a50"]]),at={class:"flex items-center gap-4"},rt={key:0,class:"font-mono text-xl text-r58-accent-danger"},it=["disabled","title"],lt={key:0,class:"animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"},ct={key:0,class:"w-3 h-3 bg-white rounded-sm"},ut={key:1,class:"w-3 h-3 bg-white rounded-full"},dt={class:"text-xs text-r58-text-secondary hidden md:inline"},ft=H({__name:"RecorderControls",setup(n){const e=W(),{register:o}=We(),{preflightCheck:v,status:c,canStartRecording:i}=ze(),{playRecordStart:r,playRecordStop:a,playError:d,playWarning:p,vibrate:s}=xe(),f=_(null),x=_(!1),u=_(!1),b=_(!1),l=_(!1),w=_(void 0),g=k(()=>e.status==="recording"),h=k(()=>e.status==="starting"),P=k(()=>e.status==="stopping"),J=k(()=>e.formattedDuration),_e=k(()=>h.value||P.value||u.value),ke=k(()=>h.value?"Starting recording...":P.value?"Stopping recording...":u.value?"Checking disk space...":!g.value&&!i.value?"Insufficient disk space":"");let Z=null;O(()=>{Z=o({key:" ",description:"Toggle Recording",action:$e,context:"recorder",enabled:()=>!h.value&&!P.value})}),X(()=>{Z&&Z()});async function $e(){g.value?ge():await z()}async function z(M){u.value=!0;try{const E=await v();if(!E.ok){d(),s(200),F.error("Cannot start recording",E.message||"Preflight check failed");return}if(E.message&&c.value==="warning"&&(p(),F.warning("Low disk space",E.message)),l.value&&!M){w.value=void 0,b.value=!0;return}await fe(M||w.value)}finally{u.value=!1}}async function fe(M){try{await e.startRecording(M);const E=M||e.sessionId;r(),s([50,30,50]),F.success("Recording started",`Session: ${E}`)}catch(E){d(),s(200),F.error("Failed to start recording",E.message||"Unknown error",{label:"Retry",onClick:()=>z(M)})}}function Se(M){b.value=!1,w.value=M,z(M)}function Re(){b.value=!1,w.value=void 0,z()}function Ce(){b.value=!1,u.value=!1}async function Te(){try{await e.stopRecording(),a(),s(100),F.success("Recording stopped",`Duration: ${J.value}`)}catch(M){d(),s(200),F.error("Failed to stop recording",M.message||"Unknown error")}}function ge(){var M;x.value=!1,(M=f.value)==null||M.open(),setTimeout(()=>{x.value=!0},500)}function Me(){x.value&&Te()}async function Ee(){g.value?ge():await fe()}return(M,E)=>(m(),y(G,null,[t("div",at,[g.value?(m(),y("div",rt,$(J.value),1)):C("",!0),t("button",{onClick:Ee,disabled:_e.value,class:S(["flex items-center gap-2 px-6 py-2 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed",[g.value?"bg-r58-accent-danger hover:bg-red-600 text-white":"bg-r58-accent-success hover:bg-green-600 text-white"]]),title:ke.value||(g.value?"Stop Recording (Space)":"Start Recording (Space)")},[h.value||P.value||u.value?(m(),y("span",lt)):(m(),y(G,{key:1},[g.value?(m(),y("span",ct)):(m(),y("span",ut))],64)),t("span",null,$(u.value?"Checking...":g.value?"Stop":"Start Recording"),1)],10,it),t("span",dt,[E[0]||(E[0]=Y(" Press ",-1)),E[1]||(E[1]=t("kbd",{class:"px-1 py-0.5 bg-r58-bg-tertiary rounded text-xs font-mono"},"Space",-1)),Y(" to "+$(g.value?"stop":"start"),1)])]),D(me,{ref_key:"stopConfirmDialog",ref:f,title:"Stop Recording?",message:`You have been recording for ${J.value}. This will finalize all files.`,"confirm-text":"Stop Recording","cancel-text":"Keep Recording",danger:!0,onConfirm:Me},null,8,["message"]),D(st,{open:b.value,onConfirm:Se,onSkip:Re,onCancel:Ce},null,8,["open"])],64))}}),K=_(localStorage.getItem("r58_performance_mode")==="true"),se=_(localStorage.getItem("r58_performance_mode_auto")!=="false"),gt=3,pt=100,vt=500;function we(){const n=W(),e=k(()=>K.value?!0:se.value&&n.isRecording?n.inputs.filter(f=>f.isRecording).length>=gt:!1),o=k(()=>e.value?vt:pt);B(e,s=>{s?document.body.classList.add("performance-mode"):document.body.classList.remove("performance-mode")},{immediate:!0});function v(s){K.value=s,localStorage.setItem("r58_performance_mode",String(s))}function c(s){se.value=s,localStorage.setItem("r58_performance_mode_auto",String(s))}function i(){v(!K.value)}function r(s,f){let x=0,u=null;return(...b)=>{const l=Date.now(),w=f??o.value,g=l-x;g>=w?(x=l,s(...b)):u||(u=window.setTimeout(()=>{x=Date.now(),u=null,s(...b)},w-g))}}function a(s,f){let x=null;return(...u)=>{x&&clearTimeout(x),x=window.setTimeout(()=>{s(...u),x=null},f??o.value)}}function d(s){return e.value?window.setTimeout(()=>s(performance.now()),o.value):requestAnimationFrame(s)}function p(s){e.value?clearTimeout(s):cancelAnimationFrame(s)}return{enabled:K,autoEnable:se,isActive:e,updateInterval:o,setEnabled:v,setAutoEnable:c,toggle:i,throttle:r,debounce:a,requestFrame:d,cancelFrame:p}}const mt=["title"],bt={class:"flex items-center gap-1.5 text-sm"},ht={key:0,class:"flex items-center gap-1.5 text-sm"},yt={key:1,class:"flex items-center gap-1.5 text-sm text-red-400"},xt={class:"font-mono"},wt=H({__name:"RecordingHealth",setup(n,{expose:e}){const o=W(),{isActive:v}=we(),c=_({}),i=_(0),r=_(0),a=_(0);let d=null;function p(){const b={};let l=0;o.inputs.forEach(g=>{b[g.id]=g.bytesWritten;const h=c.value[g.id]||0;l+=g.bytesWritten-h});const w=v.value?2:1;i.value=Math.round(l/(1024*1024)/w*10)/10,c.value=b}B(()=>o.isRecording,b=>{if(b){c.value={},i.value=0,r.value=0,a.value=0;const l=v.value?2e3:1e3;d=window.setInterval(p,l)}else d&&(clearInterval(d),d=null)},{immediate:!0}),B(v,b=>{if(o.isRecording&&d){clearInterval(d);const l=b?2e3:1e3;d=window.setInterval(p,l)}}),X(()=>{d&&clearInterval(d)});const s=k(()=>o.isRecording?a.value>0||r.value>90?"critical":i.value<1||r.value>70?"warning":"healthy":"idle"),f=k(()=>{switch(s.value){case"healthy":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}});k(()=>{switch(s.value){case"healthy":return"Healthy";case"warning":return"Warning";case"critical":return"Critical";default:return"Idle"}});const x=k(()=>{if(!o.isRecording)return"Not recording";const b=[`Write speed: ${i.value} MB/s`,`Buffer: ${r.value}%`];return a.value>0&&b.push(`Frames dropped: ${a.value}`),b.join(`
`)});function u(b){b.buffer_percent!==void 0&&(r.value=b.buffer_percent),b.frames_dropped!==void 0&&(a.value=b.frames_dropped)}return e({updateFromMetrics:u}),(b,l)=>R(o).isRecording?(m(),y("div",{key:0,class:S(["flex items-center gap-3 px-3 py-1.5 rounded-lg transition-colors cursor-help",{"bg-emerald-500/10":f.value==="emerald","bg-amber-500/10":f.value==="amber","bg-red-500/10":f.value==="red"}]),title:x.value},[t("span",{class:S(["w-2 h-2 rounded-full",f.value==="emerald"?"bg-emerald-500":"",f.value==="amber"?"bg-amber-500 animate-pulse":"",f.value==="red"?"bg-red-500 animate-pulse":""])},null,2),t("div",bt,[l[0]||(l[0]=t("svg",{class:"w-3.5 h-3.5 text-r58-text-secondary",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})],-1)),t("span",{class:S(["font-mono",f.value==="emerald"?"text-emerald-400":"",f.value==="amber"?"text-amber-400":"",f.value==="red"?"text-red-400":""])},$(i.value)+" MB/s ",3)]),r.value>0?(m(),y("div",ht,[l[1]||(l[1]=t("span",{class:"text-r58-text-secondary"},"Buf:",-1)),t("span",{class:S(["font-mono",r.value<50?"text-emerald-400":"",r.value>=50&&r.value<80?"text-amber-400":"",r.value>=80?"text-red-400":""])},$(r.value)+"% ",3)])):C("",!0),a.value>0?(m(),y("div",yt,[l[2]||(l[2]=t("svg",{class:"w-3.5 h-3.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),t("span",xt,$(a.value)+" dropped",1)])):C("",!0)],10,mt)):C("",!0)}}),_t=["65.109.32.111"],kt=5,$t=1e3,St=3e4,N=new Map,U=new Map;function Rt(n){const e=Q(),o=be();if(e&&!o)try{return`http://${new URL(e).hostname}:8889/${n}/whep`}catch{console.warn("[WHEP Manager] Invalid device URL, falling back to FRP")}return`https://r58-mediamtx.itagenten.no/${n}/whep`}async function Ct(n,e){const o=N.get(e);if(!o)return"unknown";try{const i=new URL(o.whepUrl).hostname;if(i.includes("itagenten.no"))return console.log(`[WHEP Manager ${e}] Detected relay (FRP URL)`),"relay";if(i.startsWith("100."))return console.log(`[WHEP Manager ${e}] Detected P2P (Tailscale IP: ${i})`),"p2p";if(i.startsWith("192.168.")||i.startsWith("10.")||i.startsWith("172."))return console.log(`[WHEP Manager ${e}] Detected P2P (LAN IP: ${i})`),"p2p"}catch(c){console.warn(`[WHEP Manager ${e}] Failed to parse WHEP URL:`,c)}try{const c=await n.getStats();for(const i of c.values())if(i.type==="candidate-pair"&&i.state==="succeeded"){const r=c.get(i.remoteCandidateId);if((r==null?void 0:r.candidateType)==="relay")return console.log(`[WHEP Manager ${e}] Detected relay (TURN candidate)`),"relay";const a=r==null?void 0:r.address;if(a&&_t.includes(a))return console.log(`[WHEP Manager ${e}] Detected relay (VPS IP: ${a})`),"relay"}}catch(c){console.warn(`[WHEP Manager ${e}] Failed to get WebRTC stats:`,c)}return Q()&&!be()?(console.log(`[WHEP Manager ${e}] Assuming P2P (direct device URL configured)`),"p2p"):"unknown"}function I(n){const e=N.get(n);if(!e)return;const o=U.get(n);o&&o.forEach(v=>v(e))}function ae(n){const e=N.get(n);if(!e)return;if(e.reconnectAttempts>=kt){console.error(`[WHEP Manager ${n}] Max reconnect attempts reached`),e.state="failed",I(n);return}e.reconnectAttempts++;const o=Math.min($t*Math.pow(2,e.reconnectAttempts-1),St);console.log(`[WHEP Manager ${n}] Scheduling reconnect #${e.reconnectAttempts} in ${o}ms`),e.state="connecting",I(n),e.reconnectTimeout&&clearTimeout(e.reconnectTimeout),e.reconnectTimeout=setTimeout(()=>{de(n)},o)}async function de(n){let e=N.get(n);if(e&&(e.state==="connected"||e.state==="connecting"))return console.log(`[WHEP Manager ${n}] Reusing existing connection (state: ${e.state})`),e;let o=Q(),v=0;for(;!o&&v<5;)console.log(`[WHEP Manager ${n}] No device URL yet, waiting... (attempt ${v+1})`),await new Promise(a=>setTimeout(a,100)),o=Q(),v++;const c=performance.now(),i=Rt(n);console.log(`[WHEP Manager ${n}] Creating connection to: ${i}`),console.log(`[WHEP Manager ${n}] Device URL was: ${o}`),e!=null&&e.peerConnection&&e.peerConnection.close();const r=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}]});e?(e.peerConnection=r,e.state="connecting",e.whepUrl=i,e.mediaStream=null,e.connectionType="unknown",e.connectionStartTime=c):(e={cameraId:n,peerConnection:r,mediaStream:null,state:"connecting",connectionType:"unknown",refCount:0,whepUrl:i,lastConnectedAt:null,reconnectAttempts:(e==null?void 0:e.reconnectAttempts)||0,reconnectTimeout:null,connectionStartTime:c},N.set(n,e)),r.ontrack=a=>{a.streams[0]&&(e.mediaStream=a.streams[0],console.log(`[WHEP Manager ${n}] Received media stream`),I(n))},r.oniceconnectionstatechange=async()=>{const a=r.iceConnectionState;if(console.log(`[WHEP Manager ${n}] ICE state: ${a}`),a==="connected"||a==="completed"){e.state="connected",e.lastConnectedAt=Date.now(),e.reconnectAttempts=0,e.connectionType=await Ct(r,n);const d=e.connectionStartTime?Math.round(performance.now()-e.connectionStartTime):0;console.log(`[WHEP Manager ${n}] Connected (${e.connectionType}) in ${d}ms`),I(n)}else a==="failed"?(e.state="failed",e.connectionType="unknown",I(n),e.refCount>0&&ae(n)):a==="disconnected"&&setTimeout(()=>{(r.iceConnectionState==="disconnected"||r.iceConnectionState==="failed")&&(e.state="disconnected",I(n),e.refCount>0&&ae(n))},3e3)},r.addTransceiver("video",{direction:"recvonly"}),r.addTransceiver("audio",{direction:"recvonly"});try{const a=await r.createOffer();await r.setLocalDescription(a);const d=await fetch(i,{method:"POST",headers:{"Content-Type":"application/sdp"},body:a.sdp});if(!d.ok)throw new Error(`WHEP request failed: ${d.status}`);const p=await d.text();await r.setRemoteDescription({type:"answer",sdp:p})}catch(a){console.error(`[WHEP Manager ${n}] Connection error:`,a),e.state="failed",I(n),e.refCount>0&&ae(n)}return e}async function Tt(n,e){U.has(n)||U.set(n,new Set),U.get(n).add(e);let o=N.get(n);return(!o||o.state==="failed"||o.state==="disconnected")&&(o=await de(n)),o.refCount++,console.log(`[WHEP Manager ${n}] Acquired connection (refCount: ${o.refCount})`),e(o),o}function Mt(n,e){const o=N.get(n);if(!o)return;const v=U.get(n);v&&(v.delete(e),v.size===0&&U.delete(n)),o.refCount=Math.max(0,o.refCount-1),console.log(`[WHEP Manager ${n}] Released connection (refCount: ${o.refCount})`),o.refCount===0&&(console.log(`[WHEP Manager ${n}] Closing unused connection`),o.reconnectTimeout&&clearTimeout(o.reconnectTimeout),o.peerConnection.close(),N.delete(n))}function re(n){const e=N.get(n);e&&(console.log(`[WHEP Manager ${n}] Force reconnecting...`),e.reconnectAttempts=0,de(n))}const Et={class:"relative w-full h-full bg-black"},At=["title"],Pt={key:1,class:"absolute inset-0 flex items-center justify-center bg-black/50"},Lt={key:2,class:"absolute inset-0 flex items-center justify-center bg-black/70"},Dt={class:"text-center"},Bt={class:"text-xs text-amber-400"},Nt={key:3,class:"absolute inset-0 flex items-center justify-center bg-black/80"},Wt={class:"text-center text-r58-text-secondary"},Ht={class:"text-sm"},Ft=H({__name:"InputPreview",props:{inputId:{},protocol:{}},emits:["videoReady"],setup(n,{emit:e}){const o=n,v=e,c=W();let i=!1;const r=k(()=>c.status==="recording"),a=_(null),d=_(!0),p=_(null),s=_("unknown"),f=_(!1),x=_(0);let u=null;function b(h){switch(console.log(`[InputPreview ${o.inputId}] Connection update:`,{state:h.state,type:h.connectionType,hasStream:!!h.mediaStream}),s.value=h.connectionType,x.value=h.reconnectAttempts,h.state){case"connecting":d.value=!0,p.value=null,f.value=h.reconnectAttempts>0;break;case"connected":d.value=!1,p.value=null,f.value=!1,h.mediaStream&&a.value&&a.value.srcObject!==h.mediaStream&&(a.value.srcObject=h.mediaStream,i||(a.value.onloadeddata=()=>{i||(i=!0,console.log(`[InputPreview ${o.inputId}] Video ready (first frame displayed)`),v("videoReady"))}));break;case"disconnected":f.value=!0,p.value=`Reconnecting... (${h.reconnectAttempts}/5)`;break;case"failed":d.value=!1,f.value=!1,p.value="Connection failed after multiple attempts";break}}async function l(){if(a.value){g(),d.value=!0,p.value=null,u=b;try{await Tt(o.inputId,u)}catch(h){console.error(`[InputPreview ${o.inputId}] Failed to acquire connection:`,h),p.value=h instanceof Error?h.message:"Failed to connect",d.value=!1}}}function w(){re(o.inputId)}function g(){u&&(Mt(o.inputId,u),u=null)}return O(()=>{l()}),B(()=>o.inputId,()=>{l()}),B(r,(h,P)=>{P&&!h&&p.value?(console.log("[InputPreview] Recording stopped, reconnecting preview..."),re(o.inputId)):!P&&h&&(console.log("[InputPreview] Recording started, will try to reconnect preview after delay..."),setTimeout(()=>{r.value&&(console.log("[InputPreview] Attempting to reconnect preview during recording..."),re(o.inputId))},2e3))}),X(()=>{g()}),(h,P)=>(m(),y("div",Et,[t("video",{ref_key:"videoRef",ref:a,autoplay:"",muted:"",playsinline:"",class:"w-full h-full object-contain"},null,512),!d.value&&!p.value&&s.value!=="unknown"?(m(),y("div",{key:0,class:S(["absolute top-1 right-1 px-1.5 py-0.5 text-[10px] font-medium rounded",s.value==="p2p"?"bg-emerald-500/80 text-white":"bg-amber-500/80 text-white"]),title:s.value==="p2p"?"Direct P2P connection":"Relay connection (FRP)"},$(s.value==="p2p"?"P2P":"RELAY"),11,At)):C("",!0),d.value&&!f.value?(m(),y("div",Pt,[...P[0]||(P[0]=[t("div",{class:"animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"},null,-1)])])):C("",!0),f.value?(m(),y("div",Lt,[t("div",Dt,[P[1]||(P[1]=t("div",{class:"animate-spin w-5 h-5 border-2 border-amber-400 border-t-transparent rounded-full mx-auto mb-2"},null,-1)),t("p",Bt,$(p.value||"Reconnecting..."),1)])])):p.value&&!d.value?(m(),y("div",Nt,[t("div",Wt,[t("p",Ht,$(p.value),1),t("button",{onClick:w,class:"mt-2 text-xs text-r58-accent-primary hover:underline"}," Retry ")])])):C("",!0)]))}}),It={key:0,class:"h-full flex items-center justify-center"},Ut={key:1,class:"h-full flex flex-col gap-2"},jt={key:0,class:"flex items-center gap-2 px-3 py-1.5 bg-amber-500/10 border border-amber-500/30 rounded-lg text-amber-400 text-sm"},Vt=["title"],Gt={key:1,class:"w-full h-full flex items-center justify-center bg-r58-bg-tertiary"},Ot={class:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-4"},zt={class:"flex items-center justify-between"},qt={class:"flex items-center gap-2"},Kt={class:"font-medium"},Yt={key:0,class:"flex items-center gap-2 text-sm"},Qt={class:"text-r58-text-secondary"},Xt={key:0,class:"mt-2 flex items-center justify-between"},Jt={class:"text-sm font-mono text-r58-text-secondary"},Zt=H({__name:"InputGrid",emits:["allVideosReady"],setup(n,{emit:e}){const o=W(),v=he(),c=e,i=_(new Set);function r(l){i.value.add(l),console.log(`[InputGrid] Video ready: ${l} (${i.value.size}/${d.value.length})`),i.value.size>=d.value.length&&(console.log("[InputGrid] All videos ready!"),c("allVideosReady"))}B(()=>d.value.length,()=>{i.value.clear()});const a=k(()=>{var l;return((l=v.capabilities)==null?void 0:l.current_mode)==="recorder"}),d=k(()=>o.inputs.filter(l=>l.hasSignal)),p=k(()=>o.framerateMismatch);function s(l){return l.isRecording?"border-r58-accent-danger ring-2 ring-r58-accent-danger/20":l.hasSignal?"border-emerald-500/50 hover:border-emerald-500":"border-r58-bg-tertiary/50 opacity-60"}function f(l){return l.hasSignal?l.framerate>=29?"excellent":l.framerate>=24?"good":"unstable":"none"}function x(l){switch(f(l)){case"excellent":return"text-emerald-400";case"good":return"text-emerald-400";case"unstable":return"text-amber-400";case"none":return"text-r58-text-secondary"}}function u(l){if(l===0)return"0 B";const w=1024,g=["B","KB","MB","GB"],h=Math.floor(Math.log(l)/Math.log(w));return parseFloat((l/Math.pow(w,h)).toFixed(1))+" "+g[h]}function b(l){if(!l.hasSignal)return`${l.label}: No signal detected`;const w=[`${l.label}`,`Resolution: ${l.resolution}`,`Framerate: ${l.framerate} fps`,`Quality: ${f(l)}`];return l.isRecording&&w.push(`Written: ${u(l.bytesWritten)}`),w.join(`
`)}return(l,w)=>d.value.length===0?(m(),y("div",It,[...w[0]||(w[0]=[He('<div class="text-center text-r58-text-secondary"><svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg><p class="text-lg font-medium">No Video Sources Connected</p><p class="text-sm mt-2">Connect HDMI cables to begin recording</p></div>',1)])])):(m(),y("div",Ut,[p.value?(m(),y("div",jt,[w[1]||(w[1]=t("svg",{class:"w-4 h-4 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20"},[t("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),t("span",null,$(p.value),1)])):C("",!0),t("div",{class:S(["flex-1 grid gap-4",d.value.length===1?"grid-cols-1":"grid-cols-2"])},[(m(!0),y(G,null,ye(d.value,g=>(m(),y("div",{key:g.id,class:S(["relative rounded-lg overflow-hidden border-2 transition-all cursor-pointer aspect-video bg-black",s(g)]),title:b(g)},[a.value?(m(),ie(Ft,{key:0,"input-id":g.id,class:"w-full h-full",onVideoReady:h=>r(g.id)},null,8,["input-id","onVideoReady"])):(m(),y("div",Gt,[...w[2]||(w[2]=[t("div",{class:"text-center"},[t("svg",{class:"w-8 h-8 mx-auto mb-2 text-r58-text-secondary/50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})]),t("span",{class:"text-xs text-r58-text-secondary/70"},"Mixer mode")],-1)])])),t("div",Ot,[t("div",zt,[t("div",qt,[t("span",{class:S(["w-2 h-2 rounded-full transition-colors",{"bg-emerald-500":f(g)==="excellent"||f(g)==="good","bg-amber-500 animate-pulse":f(g)==="unstable","bg-r58-text-secondary":f(g)==="none"}])},null,2),t("span",Kt,$(g.label),1)]),g.hasSignal?(m(),y("div",Yt,[t("span",Qt,$(g.resolution),1),t("span",{class:S(x(g))},$(g.framerate)+"fps",3)])):C("",!0)]),g.isRecording?(m(),y("div",Xt,[w[3]||(w[3]=t("div",{class:"flex items-center gap-2 text-r58-accent-danger"},[t("span",{class:"w-2 h-2 rounded-full bg-r58-accent-danger animate-recording"}),t("span",{class:"text-sm font-medium"},"REC")],-1)),t("span",Jt,$(u(g.bytesWritten)),1)])):C("",!0)])],10,Vt))),128))],2)]))}}),en={class:"space-y-4"},tn={class:"flex items-center justify-between py-2 cursor-pointer"},nn=["aria-checked"],on={class:"flex items-center justify-between py-2 cursor-pointer"},sn=["aria-checked"],an={class:"flex items-center justify-between py-2 cursor-pointer"},rn={class:"text-xs text-r58-text-secondary"},ln={key:0,class:"text-amber-400"},cn=["aria-checked"],un={class:"flex items-center justify-between py-2 pl-4 cursor-pointer opacity-80"},dn=["aria-checked"],fn=H({__name:"SettingsPanel",setup(n){const{enabled:e,toggle:o,playClick:v}=xe(),{enabled:c,autoEnable:i,isActive:r,setEnabled:a,setAutoEnable:d}=we(),p=_(!1);function s(){p.value=!p.value,p.value?(document.body.classList.add("touch-mode"),localStorage.setItem("r58_touch_mode","true")):(document.body.classList.remove("touch-mode"),localStorage.setItem("r58_touch_mode","false"))}O(()=>{const x=localStorage.getItem("r58_touch_mode")==="true";p.value=x,x&&document.body.classList.add("touch-mode")});function f(){o(),e.value&&v()}return(x,u)=>(m(),y("div",en,[u[7]||(u[7]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide"}," Interface Settings ",-1)),t("label",tn,[u[2]||(u[2]=t("div",null,[t("span",{class:"text-r58-text-primary"},"Audio Feedback"),t("p",{class:"text-xs text-r58-text-secondary"},"Play sounds for recording start/stop")],-1)),t("button",{onClick:f,class:S(["relative w-12 h-7 rounded-full transition-colors",R(e)?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":R(e)},[t("span",{class:S(["absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform",R(e)?"translate-x-6":"translate-x-1"])},null,2)],10,nn)]),t("label",on,[u[3]||(u[3]=t("div",null,[t("span",{class:"text-r58-text-primary"},"Touch Mode"),t("p",{class:"text-xs text-r58-text-secondary"},"Larger buttons for touchscreen")],-1)),t("button",{onClick:s,class:S(["relative w-12 h-7 rounded-full transition-colors",p.value?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":p.value},[t("span",{class:S(["absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform",p.value?"translate-x-6":"translate-x-1"])},null,2)],10,sn)]),t("label",an,[t("div",null,[u[5]||(u[5]=t("span",{class:"text-r58-text-primary"},"Performance Mode",-1)),t("p",rn,[u[4]||(u[4]=Y(" Reduce UI updates during recording ",-1)),R(r)&&!R(c)?(m(),y("span",ln,"(auto-enabled)")):C("",!0)])]),t("button",{onClick:u[0]||(u[0]=b=>R(a)(!R(c))),class:S(["relative w-12 h-7 rounded-full transition-colors",R(c)?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":R(c)},[t("span",{class:S(["absolute top-1 w-5 h-5 bg-white rounded-full shadow transition-transform",R(c)?"translate-x-6":"translate-x-1"])},null,2)],10,cn)]),t("label",un,[u[6]||(u[6]=t("div",null,[t("span",{class:"text-sm text-r58-text-primary"},"Auto-enable when recording 3+ inputs")],-1)),t("button",{onClick:u[1]||(u[1]=b=>R(d)(!R(i))),class:S(["relative w-10 h-6 rounded-full transition-colors",R(i)?"bg-r58-accent-primary":"bg-r58-bg-tertiary"]),role:"switch","aria-checked":R(i)},[t("span",{class:S(["absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform",R(i)?"translate-x-4":"translate-x-0.5"])},null,2)],10,dn)])]))}}),gn={class:"space-y-6"},pn={key:0,class:"card"},vn={class:"space-y-2"},mn={class:"flex justify-between"},bn={class:"flex justify-between"},hn={class:"font-mono"},yn={class:"flex justify-between"},xn={class:"card"},wn={class:"space-y-3"},_n={class:"flex items-center gap-2"},kn={key:0,class:"text-sm text-r58-text-secondary"},$n={key:0,class:"text-r58-accent-danger"},Sn={key:1},Rn={key:1,class:"text-sm text-r58-text-secondary"},Cn={class:"card"},Tn={class:"space-y-2"},Mn=["disabled","title"],En={key:0,class:"absolute -top-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-r58-bg-tertiary text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none"},An={key:0,class:"card"},Pn=H({__name:"SessionInfo",setup(n){const e=Fe(),o=W(),v=k(()=>o.currentSession),c=k(()=>o.activeInputs),i=k(()=>o.isRecording),r=_(!1);function a(p){if(p===0)return"0 B";const s=1024,f=["B","KB","MB","GB","TB"],x=Math.floor(Math.log(p)/Math.log(s));return parseFloat((p/Math.pow(s,x)).toFixed(2))+" "+f[x]}function d(){e.push({name:"admin",query:{tab:"settings"}})}return(p,s)=>(m(),y("div",gn,[v.value?(m(),y("div",pn,[s[4]||(s[4]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide mb-3"},"Current Session",-1)),t("div",vn,[t("div",mn,[s[1]||(s[1]=t("span",{class:"text-r58-text-secondary"},"Started",-1)),t("span",null,$(v.value.startedAt.toLocaleTimeString()),1)]),t("div",bn,[s[2]||(s[2]=t("span",{class:"text-r58-text-secondary"},"Duration",-1)),t("span",hn,$(R(o).formattedDuration),1)]),t("div",yn,[s[3]||(s[3]=t("span",{class:"text-r58-text-secondary"},"Inputs",-1)),t("span",null,$(c.value.length)+" active",1)])])])):C("",!0),t("div",xn,[s[5]||(s[5]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide mb-3"},"Input Status",-1)),t("div",wn,[(m(!0),y(G,null,ye(R(o).inputs,f=>(m(),y("div",{key:f.id,class:"flex items-center justify-between py-2 border-b border-r58-bg-tertiary last:border-0"},[t("div",_n,[t("span",{class:S(["w-2 h-2 rounded-full",f.hasSignal?"bg-r58-accent-success":"bg-r58-text-secondary"])},null,2),t("span",{class:S(f.hasSignal?"":"text-r58-text-secondary")},$(f.label),3)]),f.hasSignal?(m(),y("div",kn,[f.isRecording?(m(),y("span",$n,$(a(f.bytesWritten)),1)):(m(),y("span",Sn,$(f.resolution),1))])):(m(),y("span",Rn,"No signal"))]))),128))])]),t("div",Cn,[s[7]||(s[7]=t("h3",{class:"text-sm font-semibold text-r58-text-secondary uppercase tracking-wide mb-3"},"Quick Actions",-1)),t("div",Tn,[t("button",{onClick:d,class:"btn w-full justify-center disabled:opacity-50 disabled:cursor-not-allowed group relative",disabled:i.value,title:i.value?"Cannot configure while recording":"Open input configuration"},[s[6]||(s[6]=Y(" Configure Inputs ",-1)),i.value?(m(),y("span",En," Stop recording first ")):C("",!0)],8,Mn),t("button",{onClick:s[0]||(s[0]=f=>r.value=!r.value),class:"btn w-full justify-center"},$(r.value?"Hide Settings":"Interface Settings"),1)])]),D(le,{name:"slide-fade"},{default:ce(()=>[r.value?(m(),y("div",An,[D(fn)])):C("",!0)]),_:1})]))}}),Ln=ue(Pn,[["__scopeId","data-v-8910ebdc"]]),Dn={class:"h-full flex flex-col"},Bn={class:"flex items-center justify-between px-6 py-4 border-b border-r58-bg-tertiary bg-r58-bg-secondary"},Nn={class:"flex items-center gap-4"},Wn={class:"flex items-center gap-2"},Hn={key:0,class:"badge badge-danger"},Fn={class:"flex-1 flex overflow-hidden"},In={class:"flex-1 p-4"},Un={class:"w-80 border-l border-r58-bg-tertiary bg-r58-bg-secondary p-4 overflow-y-auto"},jn=H({__name:"RecorderView",setup(n){const e=W(),o=he(),{showLeaveConfirmation:v,confirmLeave:c,cancelLeave:i}=Ve(),r=k(()=>e.status==="recording"),a=k(()=>e.formattedDuration),d=_(!0),p=_(!1),s=_(!1),f=k(()=>p.value&&s.value);function x(){d.value=!1}async function u(){var g;if(!Ie())return;await o.fetchCapabilities();const w=(g=o.capabilities)==null?void 0:g.current_mode;if(w&&w!=="recorder"){console.log("[Recorder] Not in recorder mode, switching...");try{(await fetch(Ue("/api/mode/recorder"),{method:"POST"})).ok&&(await o.fetchCapabilities(),F.success("Switched to Recorder mode"))}catch(h){console.warn("[Recorder] Failed to switch mode:",h)}}}function b(){console.log("[Recorder] All videos ready!"),s.value=!0}O(async()=>{const w=performance.now();await Promise.all([u(),e.fetchInputs(),e.fetchStatus()]);const g=e.inputs.filter(h=>h.hasSignal).length;console.log(`[Recorder] Data loaded: ${e.inputs.length} inputs, ${g} with signal (${Math.round(performance.now()-w)}ms)`),p.value=!0,g===0&&(s.value=!0)});const l=_(null);return B(v,w=>{var g,h;w?(g=l.value)==null||g.open():(h=l.value)==null||h.close()}),(w,g)=>(m(),y(G,null,[D(le,{name:"fade"},{default:ce(()=>[d.value?(m(),ie(je,{key:0,mode:"recorder","content-ready":f.value,"min-time":1500,"max-time":5e3,onReady:x},null,8,["content-ready"])):C("",!0)]),_:1}),t("div",Dn,[t("header",Bn,[t("div",Nn,[t("div",Wn,[t("span",{class:S(["w-3 h-3 rounded-full",r.value?"bg-r58-accent-danger animate-recording":"bg-r58-bg-tertiary"])},null,2),g[0]||(g[0]=t("span",{class:"text-xl font-semibold"},"Recorder",-1))]),r.value?(m(),y("span",Hn,"RECORDING")):C("",!0),D(wt)]),D(ft)]),t("div",Fn,[t("div",In,[D(Zt,{onAllVideosReady:b})]),t("aside",Un,[D(Ln)])]),D(me,{ref_key:"leaveDialog",ref:l,title:"Recording in Progress",message:`You are currently recording (${a.value}). Leaving will stop the recording and save all files.`,"confirm-text":"Leave and Stop Recording","cancel-text":"Stay",danger:!0,onConfirm:R(c),onCancel:R(i)},null,8,["message","onConfirm","onCancel"])])],64))}}),On=ue(jn,[["__scopeId","data-v-cf30ce8b"]]);export{On as default};
