const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BpM5UgMz.js","assets/index-_akB68C_.css"])))=>i.map(i=>d[i]);
import{D as Y,E as z,o as ee,l as _e,G as Fe,r as k,j as M,H as ve,d as Q,I as he,m as j,T as Re,p as ne,c as w,f as H,z as Ue,e,w as K,A as ue,t as R,J as Ve,i as g,_ as re,K as je,h as J,F as O,n as U,x as oe,L as Ae,q as ae,M as me,N as Ge,O as De,u as Se,a as Be,y as ge,B as Ie,P as Ne,Q as Oe,R as ze,S as qe,U as Ke,V as Ye,k as Qe,g as He,W as Xe,b as Je,v as Ze}from"./index-BpM5UgMz.js";import{u as et,C as tt,M as nt}from"./ModeLoadingScreen-DRl6Bac2.js";const le=k(!1),de=k(!1);let ce=null;function ot(){const n=Y();z(()=>n.status,r=>{le.value=r==="recording"},{immediate:!0});function t(r){if(le.value)return r.preventDefault(),r.returnValue="Recording in progress. Are you sure you want to leave?",r.returnValue}ee(()=>{window.addEventListener("beforeunload",t)}),_e(()=>{window.removeEventListener("beforeunload",t)}),Fe((r,i,l)=>{le.value?(ce=()=>l(),de.value=!0,l(!1)):l()});function o(){de.value=!1,le.value=!1,n.stopRecording().finally(()=>{ce&&(ce(),ce=null)})}function m(){de.value=!1,ce=null}return{isGuardActive:le,showLeaveConfirmation:de,confirmLeave:o,cancelLeave:m}}const N=k(null),be=k(!1),Te=k(null),ye=k(null),at=10,we=2,st=25;function rt(){const n=M(()=>N.value?N.value.available_gb<we?"critical":N.value.available_gb<at?"warning":"ok":"unknown"),t=M(()=>N.value?N.value.available_gb>=we:!0),o=M(()=>{if(!N.value)return null;const a=N.value.available_gb*1024*1024*1024,d=st*1024*1024,_=a/d,c=Math.floor(_/3600),h=Math.floor(_%3600/60);return c>24?`${Math.floor(c/24)}d ${c%24}h`:c>0?`${c}h ${h}m`:`${h}m`}),m=M(()=>{switch(n.value){case"ok":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}}),r=M(()=>N.value?n.value==="critical"?`Disk space critically low (${N.value.available_gb.toFixed(1)} GB). Cannot start recording.`:n.value==="warning"?`Low disk space (${N.value.available_gb.toFixed(1)} GB). Estimated recording time: ${o.value}`:null:null);async function i(){be.value=!0,ye.value=null;try{const a=await ve.getDegradation();if(a.resources&&a.resources.disk_free_gb!==void 0){const d=a.resources.disk_free_gb,_=d*3;N.value={available_gb:d,total_gb:_,used_percent:100-d/_*100,recording_path:"/opt/r58-app/shared/recordings"}}return Te.value=new Date,N.value}catch(a){return ye.value=a.message||"Failed to check disk space",console.error("Failed to check disk space:",a),null}finally{be.value=!1}}async function l(){return await i(),N.value?n.value==="critical"?{ok:!1,message:`Insufficient disk space (${N.value.available_gb.toFixed(1)} GB). Need at least ${we} GB to start recording.`}:n.value==="warning"?{ok:!0,message:`Low disk space warning: ${N.value.available_gb.toFixed(1)} GB available. Estimated recording time: ${o.value}`}:{ok:!0}:{ok:!0,message:"Could not verify disk space. Proceeding with caution."}}return{diskSpace:N,isLoading:be,lastCheck:Te,error:ye,status:n,statusColor:m,canStartRecording:t,estimatedRecordingTime:o,warningMessage:r,checkDiskSpace:i,preflightCheck:l}}const G=k(localStorage.getItem("r58_audio_feedback")!=="false");let ke=null;function it(){return ke||(ke=new(window.AudioContext||window.webkitAudioContext)),ke}function V(n,t,o="sine",m=.3){if(G.value)try{const r=it();r.state==="suspended"&&r.resume();const i=r.createOscillator(),l=r.createGain();i.connect(l),l.connect(r.destination),i.type=o,i.frequency.value=n;const a=r.currentTime;l.gain.setValueAtTime(0,a),l.gain.linearRampToValueAtTime(m,a+.01),l.gain.linearRampToValueAtTime(0,a+t),i.start(a),i.stop(a+t)}catch(r){console.warn("Audio feedback failed:",r)}}function lt(){G.value&&(V(440,.1,"sine",.2),setTimeout(()=>V(554,.1,"sine",.2),100),setTimeout(()=>V(659,.15,"sine",.25),200))}function ct(){G.value&&(V(880,.08,"sine",.3),setTimeout(()=>V(880,.15,"sine",.3),120))}function ut(){G.value&&(V(659,.1,"sine",.25),setTimeout(()=>V(554,.1,"sine",.2),100),setTimeout(()=>V(440,.15,"sine",.2),200))}function dt(){G.value&&(V(200,.15,"square",.15),setTimeout(()=>V(180,.2,"square",.15),180))}function ft(){G.value&&(V(1e3,.08,"sine",.2),setTimeout(()=>V(1e3,.08,"sine",.2),150))}function Ee(){G.value&&V(1200,.03,"sine",.1)}function vt(n=50){if(G.value&&"vibrate"in navigator)try{navigator.vibrate(n)}catch{}}function pt(){function n(o){G.value=o,localStorage.setItem("r58_audio_feedback",String(o))}function t(){n(!G.value),G.value&&Ee()}return{enabled:G,setEnabled:n,toggle:t,playSuccess:lt,playError:dt,playWarning:ft,playClick:Ee,playRecordStart:ct,playRecordStop:ut,vibrate:vt}}const mt={class:"bg-preke-bg-elevated rounded-lg shadow-xl max-w-md w-full p-6"},gt=["placeholder"],_t={class:"text-xs text-preke-text-dim mt-2"},ht=Q({__name:"SessionNameDialog",props:{open:{type:Boolean},suggestedName:{}},emits:["confirm","cancel","skip"],setup(n,{emit:t}){const o=n,m=t,r=k(""),i=k(null),l=M(()=>{const u=new Date,b=u.toLocaleDateString("en-CA"),v=u.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}).replace(":","");return`Recording_${b}_${v}`}),a=M(()=>o.suggestedName||l.value);z(()=>o.open,u=>{u&&(r.value=a.value,setTimeout(()=>{var b,v;(b=i.value)==null||b.focus(),(v=i.value)==null||v.select()},100))});function d(){m("confirm",r.value.trim()||a.value)}function _(){m("skip")}function c(){m("cancel")}function h(u){u.key==="Enter"?d():u.key==="Escape"&&c()}return(u,b)=>(g(),he(Ve,{to:"body"},[j(Re,{name:"fade"},{default:ne(()=>[n.open?(g(),w("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:Ue(c,["self"]),onKeydown:h},[e("div",mt,[b[1]||(b[1]=e("h2",{class:"text-lg font-semibold mb-2"},"Name This Recording",-1)),b[2]||(b[2]=e("p",{class:"text-preke-text-dim text-sm mb-4"}," Give your recording a name to find it easily later (optional). ",-1)),K(e("input",{ref_key:"inputRef",ref:i,"onUpdate:modelValue":b[0]||(b[0]=v=>r.value=v),type:"text",placeholder:a.value,class:"w-full px-4 py-2 bg-preke-bg-surface border border-preke-bg-surface rounded-lg text-preke-text placeholder-preke-text-dim focus:outline-none focus:ring-2 focus:ring-preke-gold"},null,8,gt),[[ue,r.value]]),e("p",_t," Suggested: "+R(a.value),1),e("div",{class:"flex justify-between mt-6"},[e("button",{onClick:_,class:"text-sm text-preke-text-dim hover:text-preke-text transition-colors"}," Skip (use default) "),e("div",{class:"flex gap-3"},[e("button",{onClick:c,class:"btn"}," Cancel "),e("button",{onClick:d,class:"btn btn-primary"}," Start Recording ")])])])],32)):H("",!0)]),_:1})]))}}),bt=re(ht,[["__scopeId","data-v-2eeca4e8"]]),yt={class:"recorder-controls"},wt={key:0,class:"recorder-controls__duration"},kt=["disabled","title"],Ct={key:0,class:"recorder-controls__spinner"},xt={key:0,class:"recorder-controls__icon recorder-controls__icon--stop"},$t={key:1,class:"recorder-controls__icon recorder-controls__icon--record"},Rt={class:"recorder-controls__hint"},St=Q({__name:"RecorderControls",setup(n){const t=Y(),{register:o}=je(),{preflightCheck:m,status:r,canStartRecording:i}=rt(),{playRecordStart:l,playRecordStop:a,playError:d,playWarning:_,vibrate:c}=pt(),h=k(null),u=k(!1),b=k(!1),v=k(!1),x=k(!1),L=k(void 0),T=M(()=>t.status==="recording"),s=M(()=>t.status==="starting"),f=M(()=>t.status==="stopping"),$=M(()=>t.formattedDuration),F=M(()=>s.value||f.value||b.value),te=M(()=>s.value?"Starting recording...":f.value?"Stopping recording...":b.value?"Checking disk space...":!T.value&&!i.value?"Insufficient disk space":"");let X=null;ee(()=>{X=o({key:" ",description:"Toggle Recording",action:ie,context:"recorder",enabled:()=>!s.value&&!f.value})}),_e(()=>{X&&X()});async function ie(){T.value?y():await D()}async function D(P){b.value=!0;try{const B=await m();if(!B.ok){d(),c(200),J.error("Cannot start recording",B.message||"Preflight check failed");return}if(B.message&&r.value==="warning"&&(_(),J.warning("Low disk space",B.message)),x.value&&!P){L.value=void 0,v.value=!0;return}await q(P||L.value)}finally{b.value=!1}}async function q(P){try{await t.startRecording(P);const B=P||t.sessionId;l(),c([50,30,50]),J.success("Recording started",`Session: ${B}`)}catch(B){d(),c(200),J.error("Failed to start recording",B.message||"Unknown error",{label:"Retry",onClick:()=>D(P)})}}function A(P){v.value=!1,L.value=P,D(P)}function S(){v.value=!1,L.value=void 0,D()}function p(){v.value=!1,b.value=!1}async function E(){try{await t.stopRecording(),a(),c(100),J.success("Recording stopped")}catch(P){d(),c(200),J.error("Failed to stop recording",P.message||"Unknown error")}}function y(){var P;u.value=!1,(P=h.value)==null||P.open(),setTimeout(()=>{u.value=!0},500)}function C(){u.value&&E()}async function W(){T.value?y():await q()}return(P,B)=>(g(),w(O,null,[e("div",yt,[T.value?(g(),w("div",wt,R($.value),1)):H("",!0),e("button",{onClick:W,disabled:F.value,class:U(["recorder-controls__btn",T.value?"recorder-controls__btn--stop":"recorder-controls__btn--start"]),title:te.value||(T.value?"Stop Recording (Space)":"Start Recording (Space)")},[s.value||f.value||b.value?(g(),w("span",Ct)):(g(),w(O,{key:1},[T.value?(g(),w("span",xt)):(g(),w("span",$t))],64)),e("span",null,R(b.value?"Checking...":T.value?"Stop":"Start Recording"),1)],10,kt),e("span",Rt,[B[0]||(B[0]=oe(" Press ",-1)),B[1]||(B[1]=e("kbd",null,"Space",-1)),oe(" to "+R(T.value?"stop":"start"),1)])]),j(Ae,{ref_key:"stopConfirmDialog",ref:h,title:"Stop Recording?",message:`You have been recording for ${$.value}. This will finalize all files.`,"confirm-text":"Stop Recording","cancel-text":"Keep Recording",danger:!0,onConfirm:C},null,8,["message"]),j(bt,{open:v.value,onConfirm:A,onSkip:S,onCancel:p},null,8,["open"])],64))}}),Mt=re(St,[["__scopeId","data-v-1e32920d"]]),fe=k(localStorage.getItem("r58_performance_mode")==="true"),Ce=k(localStorage.getItem("r58_performance_mode_auto")!=="false"),Tt=3,Et=100,Pt=500;function Lt(){const n=Y(),t=M(()=>fe.value?!0:Ce.value&&n.isRecording?n.inputs.filter(h=>h.isRecording).length>=Tt:!1),o=M(()=>t.value?Pt:Et);z(t,c=>{c?document.body.classList.add("performance-mode"):document.body.classList.remove("performance-mode")},{immediate:!0});function m(c){fe.value=c,localStorage.setItem("r58_performance_mode",String(c))}function r(c){Ce.value=c,localStorage.setItem("r58_performance_mode_auto",String(c))}function i(){m(!fe.value)}function l(c,h){let u=0,b=null;return(...v)=>{const x=Date.now(),L=h??o.value,T=x-u;T>=L?(u=x,c(...v)):b||(b=window.setTimeout(()=>{u=Date.now(),b=null,c(...v)},L-T))}}function a(c,h){let u=null;return(...b)=>{u&&clearTimeout(u),u=window.setTimeout(()=>{c(...b),u=null},h??o.value)}}function d(c){return t.value?window.setTimeout(()=>c(performance.now()),o.value):requestAnimationFrame(c)}function _(c){t.value?clearTimeout(c):cancelAnimationFrame(c)}return{enabled:fe,autoEnable:Ce,isActive:t,updateInterval:o,setEnabled:m,setAutoEnable:r,toggle:i,throttle:l,debounce:a,requestFrame:d,cancelFrame:_}}const At=["title"],Dt={class:"flex items-center gap-1.5 text-sm"},Bt={key:0,class:"flex items-center gap-1.5 text-sm"},Nt={key:1,class:"flex items-center gap-1.5 text-sm text-red-400"},Ht={class:"font-mono"},Wt=Q({__name:"RecordingHealth",setup(n,{expose:t}){const o=Y(),{isActive:m}=Lt(),r=k({}),i=k(0),l=k(0),a=k(0);let d=null;function _(){const v={};let x=0;o.inputs.forEach(T=>{v[T.id]=T.bytesWritten;const s=r.value[T.id]||0;x+=T.bytesWritten-s});const L=m.value?2:1;i.value=Math.round(x/(1024*1024)/L*10)/10,r.value=v}z(()=>o.isRecording,v=>{if(v){r.value={},i.value=0,l.value=0,a.value=0;const x=m.value?2e3:1e3;d=window.setInterval(_,x)}else d&&(clearInterval(d),d=null)},{immediate:!0}),z(m,v=>{if(o.isRecording&&d){clearInterval(d);const x=v?2e3:1e3;d=window.setInterval(_,x)}}),_e(()=>{d&&clearInterval(d)});const c=M(()=>o.isRecording?a.value>0||l.value>90?"critical":i.value<1||l.value>70?"warning":"healthy":"idle"),h=M(()=>{switch(c.value){case"healthy":return"emerald";case"warning":return"amber";case"critical":return"red";default:return"zinc"}});M(()=>{switch(c.value){case"healthy":return"Healthy";case"warning":return"Warning";case"critical":return"Critical";default:return"Idle"}});const u=M(()=>{if(!o.isRecording)return"Not recording";const v=[`Write speed: ${i.value} MB/s`,`Buffer: ${l.value}%`];return a.value>0&&v.push(`Frames dropped: ${a.value}`),v.join(`
`)});function b(v){v.buffer_percent!==void 0&&(l.value=v.buffer_percent),v.frames_dropped!==void 0&&(a.value=v.frames_dropped)}return t({updateFromMetrics:b}),(v,x)=>ae(o).isRecording?(g(),w("div",{key:0,class:U(["flex items-center gap-3 px-3 py-1.5 rounded-lg transition-colors cursor-help",{"bg-emerald-500/10":h.value==="emerald","bg-amber-500/10":h.value==="amber","bg-red-500/10":h.value==="red"}]),title:u.value},[e("span",{class:U(["w-2 h-2 rounded-full",h.value==="emerald"?"bg-emerald-500":"",h.value==="amber"?"bg-amber-500 animate-pulse":"",h.value==="red"?"bg-red-500 animate-pulse":""])},null,2),e("div",Dt,[x[0]||(x[0]=e("svg",{class:"w-3.5 h-3.5 text-preke-text-dim",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})],-1)),e("span",{class:U(["font-mono",h.value==="emerald"?"text-emerald-400":"",h.value==="amber"?"text-amber-400":"",h.value==="red"?"text-red-400":""])},R(i.value)+" MB/s ",3)]),l.value>0?(g(),w("div",Bt,[x[1]||(x[1]=e("span",{class:"text-preke-text-dim"},"Buf:",-1)),e("span",{class:U(["font-mono",l.value<50?"text-emerald-400":"",l.value>=50&&l.value<80?"text-amber-400":"",l.value>=80?"text-red-400":""])},R(l.value)+"% ",3)])):H("",!0),a.value>0?(g(),w("div",Nt,[x[2]||(x[2]=e("svg",{class:"w-3.5 h-3.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),e("span",Ht,R(a.value)+" dropped",1)])):H("",!0)],10,At)):H("",!0)}});function Pe(n){return n.startsWith("192.168.")||n.startsWith("10.")||n.startsWith("172.")||n.startsWith("100.")||n==="127.0.0.1"||n==="localhost"}const Ft=5,Ut=1e3,Vt=3e4,jt=()=>typeof window<"u"&&window.__NETWORK_DEBUG__===!0,Le=new Map,Gt=1e3;function pe(n,t,...o){if(!jt())return;const m=Date.now(),r=Le.get(n)||0;m-r<Gt||(Le.set(n,m),console.log(`[NETWORK DEBUG ${n}] ${t}`,...o))}const I=new Map,se=new Map;async function It(n){const t=me(),o=De();if(t&&!o)try{return`http://${new URL(t).hostname}:8889/${n}/whep`}catch{console.warn("[WHEP Manager] Invalid device URL, falling back to FRP")}if(typeof window<"u"&&window.location.hostname==="app.itagenten.no")return console.log("[WHEP Manager] Browser access from app.itagenten.no, using same-domain proxy"),`https://app.itagenten.no/${n}/whep`;const{getFrpUrl:m}=await Ge(async()=>{const{getFrpUrl:i}=await import("./index-BpM5UgMz.js").then(l=>l.a3);return{getFrpUrl:i}},__vite__mapDeps([0,1])),r=await m();if(r)try{const i=new URL(r);return i.hostname.includes("itagenten.no")?`https://app.itagenten.no/${n}/whep`:i.hostname.includes("mediamtx")?`${r}/${n}/whep`:`https://${i.hostname.replace("api","mediamtx")}/${n}/whep`}catch{console.warn("[WHEP Manager] Invalid FRP URL, cannot build WHEP URL")}throw new Error("No device configured and no FRP fallback available")}async function Ot(n,t){const o=I.get(t);if(!o)return"unknown";try{const i=new URL(o.whepUrl).hostname;if(i.includes("itagenten.no"))return console.log(`[WHEP Manager ${t}] Detected relay (FRP URL)`),"relay";if(Pe(i))return console.log(`[WHEP Manager ${t}] Detected P2P (private IP: ${i})`),"p2p"}catch(r){console.warn(`[WHEP Manager ${t}] Failed to parse WHEP URL:`,r)}try{const r=await n.getStats();for(const i of r.values())if(i.type==="candidate-pair"&&i.state==="succeeded"){const l=r.get(i.remoteCandidateId);if((l==null?void 0:l.candidateType)==="relay")return console.log(`[WHEP Manager ${t}] Detected relay (TURN candidate)`),"relay";const a=l==null?void 0:l.address;if(a&&!Pe(a))return console.log(`[WHEP Manager ${t}] Detected relay (public IP: ${a})`),"relay"}}catch(r){console.warn(`[WHEP Manager ${t}] Failed to get WebRTC stats:`,r)}return me()&&!De()?(console.log(`[WHEP Manager ${t}] Assuming P2P (direct device URL configured)`),"p2p"):"unknown"}function Z(n){const t=I.get(n);if(!t)return;const o=se.get(n);o&&o.forEach(m=>m(t))}function xe(n){const t=I.get(n);if(!t)return;if(t.reconnectAttempts>=Ft){console.error(`[WHEP Manager ${n}] Max reconnect attempts reached`),t.state="failed",Z(n);return}t.reconnectAttempts++;const o=Math.min(Ut*Math.pow(2,t.reconnectAttempts-1),Vt),m=o*.2*(Math.random()*2-1),r=Math.max(100,Math.round(o+m));pe("WHEP",`Camera ${n}: Reconnect #${t.reconnectAttempts} in ${r}ms (base: ${o}ms)`),console.log(`[WHEP Manager ${n}] Scheduling reconnect #${t.reconnectAttempts} in ${r}ms`),t.state="connecting",Z(n),t.reconnectTimeout&&clearTimeout(t.reconnectTimeout),t.reconnectTimeout=setTimeout(()=>{Me(n)},r)}async function Me(n){let t=I.get(n);if(t&&(t.state==="connected"||t.state==="connecting"))return console.log(`[WHEP Manager ${n}] Reusing existing connection (state: ${t.state})`),t;if(t!=null&&t.isConnecting){for(pe("WHEP",`Camera ${n}: Connection already in progress, skipping duplicate attempt`),console.log(`[WHEP Manager ${n}] Connection already in progress, waiting...`);t.isConnecting&&t.state==="connecting"&&(await new Promise(a=>setTimeout(a,100)),t=I.get(n),!!t););if(t)return t}const o=typeof window<"u"&&window.location.hostname==="app.itagenten.no";let m=me();if(o)console.log(`[WHEP Manager ${n}] Browser mode - using MediaMTX proxy`);else{let a=0;for(;!m&&a<5;)console.log(`[WHEP Manager ${n}] No device URL yet, waiting... (attempt ${a+1})`),await new Promise(d=>setTimeout(d,100)),m=me(),a++}const r=performance.now(),i=await It(n);pe("WHEP",`Camera ${n}: Creating connection to ${i}`),console.log(`[WHEP Manager ${n}] Creating connection to: ${i}`),console.log(`[WHEP Manager ${n}] Device URL was: ${m||"none (browser mode)"}`),t!=null&&t.peerConnection&&t.peerConnection.close(),t!=null&&t.disconnectedTimeout&&(clearTimeout(t.disconnectedTimeout),t.disconnectedTimeout=null),t&&(t.isConnecting=!0);const l=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}]});t?(t.peerConnection=l,t.state="connecting",t.whepUrl=i,t.mediaStream=null,t.connectionType="unknown",t.connectionStartTime=r,t.isConnecting=!0):(t={cameraId:n,peerConnection:l,mediaStream:null,state:"connecting",connectionType:"unknown",refCount:0,whepUrl:i,lastConnectedAt:null,reconnectAttempts:0,reconnectTimeout:null,disconnectedTimeout:null,connectionStartTime:r,isConnecting:!0},I.set(n,t)),l.ontrack=a=>{a.streams[0]&&(t.mediaStream=a.streams[0],console.log(`[WHEP Manager ${n}] Received media stream`),Z(n))},l.oniceconnectionstatechange=async()=>{const a=l.iceConnectionState;if(pe("WHEP",`Camera ${n}: ICE state changed to ${a}`),console.log(`[WHEP Manager ${n}] ICE state: ${a}`),a==="connected"||a==="completed"){t.state="connected",t.lastConnectedAt=Date.now(),t.reconnectAttempts=0,t.isConnecting=!1,t.connectionType=await Ot(l,n),t.disconnectedTimeout&&(clearTimeout(t.disconnectedTimeout),t.disconnectedTimeout=null);const d=t.connectionStartTime?Math.round(performance.now()-t.connectionStartTime):0;console.log(`[WHEP Manager ${n}] Connected (${t.connectionType}) in ${d}ms`),Z(n)}else a==="failed"?(t.state="failed",t.connectionType="unknown",t.isConnecting=!1,Z(n),t.refCount>0&&xe(n)):a==="disconnected"&&(t.disconnectedTimeout&&clearTimeout(t.disconnectedTimeout),t.disconnectedTimeout=setTimeout(()=>{(l.iceConnectionState==="disconnected"||l.iceConnectionState==="failed")&&(t.state="disconnected",t.isConnecting=!1,Z(n),t.refCount>0&&xe(n)),t.disconnectedTimeout=null},3e3))},l.addTransceiver("video",{direction:"recvonly"}),l.addTransceiver("audio",{direction:"recvonly"});try{const a=await l.createOffer();await l.setLocalDescription(a);const d=await fetch(i,{method:"POST",headers:{"Content-Type":"application/sdp"},body:a.sdp});if(!d.ok)throw new Error(`WHEP request failed: ${d.status}`);const _=await d.text();await l.setRemoteDescription({type:"answer",sdp:_})}catch(a){console.error(`[WHEP Manager ${n}] Connection error:`,a),t.state="failed",t.isConnecting=!1,Z(n),t.refCount>0&&xe(n)}return t}async function zt(n,t){se.has(n)||se.set(n,new Set),se.get(n).add(t);let o=I.get(n);return(!o||o.state==="failed"||o.state==="disconnected")&&(o=await Me(n)),o.refCount++,console.log(`[WHEP Manager ${n}] Acquired connection (refCount: ${o.refCount})`),t(o),o}function qt(n,t){const o=I.get(n);if(!o)return;const m=se.get(n);m&&(m.delete(t),m.size===0&&se.delete(n)),o.refCount=Math.max(0,o.refCount-1),console.log(`[WHEP Manager ${n}] Released connection (refCount: ${o.refCount})`),o.refCount===0&&(console.log(`[WHEP Manager ${n}] Closing unused connection`),o.reconnectTimeout&&clearTimeout(o.reconnectTimeout),o.disconnectedTimeout&&clearTimeout(o.disconnectedTimeout),o.peerConnection.close(),I.delete(n))}function $e(n){const t=I.get(n);t&&(console.log(`[WHEP Manager ${n}] Force reconnecting...`),t.reconnectAttempts=0,Me(n))}const Kt={class:"relative w-full h-full bg-black"},Yt=["title"],Qt={key:1,class:"absolute inset-0 flex items-center justify-center bg-black/50"},Xt={key:2,class:"absolute inset-0 flex items-center justify-center bg-black/70"},Jt={class:"text-center"},Zt={class:"text-xs text-amber-400"},en={key:3,class:"absolute inset-0 flex items-center justify-center bg-black/80"},tn={class:"text-center text-preke-text-dim"},nn={class:"text-sm"},on=Q({__name:"InputPreview",props:{inputId:{},protocol:{}},emits:["videoReady","aspectRatio"],setup(n,{emit:t}){const o=n,m=t,r=Y();let i=!1;const l=M(()=>r.status==="recording"),a=k(null),d=k(!0),_=k(null),c=k("unknown"),h=k(!1),u=k(0);let b=null;function v(s){switch(console.log(`[InputPreview ${o.inputId}] Connection update:`,{state:s.state,type:s.connectionType,hasStream:!!s.mediaStream}),c.value=s.connectionType,u.value=s.reconnectAttempts,s.state){case"connecting":d.value=!0,_.value=null,h.value=s.reconnectAttempts>0;break;case"connected":d.value=!1,_.value=null,h.value=!1,s.mediaStream&&a.value&&a.value.srcObject!==s.mediaStream&&(a.value.srcObject=s.mediaStream,a.value.play().catch(f=>{console.warn(`[InputPreview ${o.inputId}] Autoplay prevented:`,f)}),i||(a.value.onloadeddata=()=>{if(!i&&a.value){i=!0;const f=a.value.videoWidth,$=a.value.videoHeight,F=f&&$?f/$:16/9;console.log(`[InputPreview ${o.inputId}] Video ready (${f}x${$}, ratio: ${F.toFixed(3)})`),m("aspectRatio",F),m("videoReady")}}));break;case"disconnected":h.value=!0,_.value=`Reconnecting... (${s.reconnectAttempts}/5)`;break;case"failed":d.value=!1,h.value=!1,_.value="Connection failed after multiple attempts";break}}async function x(){if(a.value){T(),d.value=!0,_.value=null,b=v;try{await zt(o.inputId,b)}catch(s){console.error(`[InputPreview ${o.inputId}] Failed to acquire connection:`,s),_.value=s instanceof Error?s.message:"Failed to connect",d.value=!1}}}function L(){$e(o.inputId)}function T(){b&&(qt(o.inputId,b),b=null)}return ee(()=>{x()}),z(()=>o.inputId,()=>{x()}),z(l,(s,f)=>{f&&!s&&_.value?(console.log("[InputPreview] Recording stopped, reconnecting preview..."),$e(o.inputId)):!f&&s&&(console.log("[InputPreview] Recording started, will try to reconnect preview after delay..."),setTimeout(()=>{l.value&&(console.log("[InputPreview] Attempting to reconnect preview during recording..."),$e(o.inputId))},2e3))}),_e(()=>{T()}),(s,f)=>(g(),w("div",Kt,[e("video",{ref_key:"videoRef",ref:a,autoplay:"",muted:"",playsinline:"",class:"w-full h-full object-contain"},null,512),!d.value&&!_.value&&c.value!=="unknown"?(g(),w("div",{key:0,class:U(["absolute top-1 right-1 px-1.5 py-0.5 text-[10px] font-medium rounded",c.value==="p2p"?"bg-emerald-500/80 text-white":"bg-amber-500/80 text-white"]),title:c.value==="p2p"?"Direct P2P connection":"Relay connection (FRP)"},R(c.value==="p2p"?"P2P":"RELAY"),11,Yt)):H("",!0),d.value&&!h.value?(g(),w("div",Qt,[...f[0]||(f[0]=[e("div",{class:"animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"},null,-1)])])):H("",!0),h.value?(g(),w("div",Xt,[e("div",Jt,[f[1]||(f[1]=e("div",{class:"animate-spin w-5 h-5 border-2 border-amber-400 border-t-transparent rounded-full mx-auto mb-2"},null,-1)),e("p",Zt,R(_.value||"Reconnecting..."),1)])])):_.value&&!d.value?(g(),w("div",en,[e("div",tn,[e("p",nn,R(_.value),1),e("button",{onClick:L,class:"mt-2 text-xs text-preke-gold hover:underline"}," Retry ")])])):H("",!0)]))}}),an={key:0,class:"h-full flex items-center justify-center"},sn={key:1,class:"input-grid"},rn={key:0,class:"input-grid__warning"},ln=["data-count"],cn=["title"],un={key:1,class:"w-full h-full flex items-center justify-center bg-preke-bg-surface"},dn={class:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-4"},fn={class:"flex items-center justify-between"},vn={class:"flex items-center gap-2"},pn={class:"font-medium"},mn={key:0,class:"flex items-center gap-2 text-sm"},gn={class:"text-preke-text-dim"},_n=Q({__name:"InputGrid",emits:["allVideosReady"],setup(n,{emit:t}){const o=Y(),m=Se(),r=t,i=k(new Set),l=k({});function a(s){i.value.add(s),console.log(`[InputGrid] Video ready: ${s} (${i.value.size}/${h.value.length})`),i.value.size>=h.value.length&&(console.log("[InputGrid] All videos ready!"),r("allVideosReady"))}function d(s,f){l.value[s]=f,console.log(`[InputGrid] Aspect ratio for ${s}: ${f.toFixed(3)}`)}function _(s){return{aspectRatio:`${l.value[s]||1.7777777777777777}`}}z(()=>h.value.length,()=>{i.value.clear()});const c=M(()=>{var s;return((s=m.capabilities)==null?void 0:s.current_mode)==="recorder"}),h=M(()=>o.inputs.filter(s=>s.hasSignal)),u=M(()=>o.framerateMismatch);function b(s){return s.isRecording?"border-preke-red ring-2 ring-preke-red/20":s.hasSignal?"border-emerald-500/50 hover:border-emerald-500":"border-preke-bg-surface/50 opacity-60"}function v(s){return s.hasSignal?s.framerate>=29?"excellent":s.framerate>=24?"good":"unstable":"none"}function x(s){switch(v(s)){case"excellent":return"text-emerald-400";case"good":return"text-emerald-400";case"unstable":return"text-amber-400";case"none":return"text-preke-text-dim"}}function L(s){if(s===0)return"0 B";const f=1024,$=["B","KB","MB","GB"],F=Math.floor(Math.log(s)/Math.log(f));return parseFloat((s/Math.pow(f,F)).toFixed(1))+" "+$[F]}function T(s){if(!s.hasSignal)return`${s.label}: No signal detected`;const f=[`${s.label}`,`Resolution: ${s.resolution}`,`Framerate: ${s.framerate} fps`,`Quality: ${v(s)}`];return s.isRecording&&f.push(`Written: ${L(s.bytesWritten)}`),f.join(`
`)}return(s,f)=>h.value.length===0?(g(),w("div",an,[...f[0]||(f[0]=[Be('<div class="text-center text-preke-text-dim" data-v-206e9703><svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-206e9703><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" data-v-206e9703></path></svg><p class="text-lg font-medium" data-v-206e9703>No Video Sources Connected</p><p class="text-sm mt-2" data-v-206e9703>Connect HDMI cables to begin recording</p></div>',1)])])):(g(),w("div",sn,[u.value?(g(),w("div",rn,[f[1]||(f[1]=e("svg",{class:"w-4 h-4 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),e("span",null,R(u.value),1)])):H("",!0),e("div",{class:"input-grid__container","data-count":h.value.length},[(g(!0),w(O,null,ge(h.value,$=>(g(),w("div",{key:$.id,class:U(["input-grid__tile",b($)]),style:Ie(_($.id)),title:T($)},[c.value?(g(),he(on,{key:0,"input-id":$.id,class:"w-full h-full",onVideoReady:F=>a($.id),onAspectRatio:F=>d($.id,F)},null,8,["input-id","onVideoReady","onAspectRatio"])):(g(),w("div",un,[...f[2]||(f[2]=[e("div",{class:"text-center"},[e("svg",{class:"w-8 h-8 mx-auto mb-2 text-preke-text-dim/50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})]),e("span",{class:"text-xs text-preke-text-dim/70"},"Mixer mode")],-1)])])),e("div",dn,[e("div",fn,[e("div",vn,[e("span",{class:U(["w-2 h-2 rounded-full transition-colors",{"bg-emerald-500":v($)==="excellent"||v($)==="good","bg-amber-500 animate-pulse":v($)==="unstable","bg-preke-text-dim":v($)==="none"}])},null,2),e("span",pn,R($.label),1)]),$.hasSignal?(g(),w("div",mn,[e("span",gn,R($.resolution),1),e("span",{class:U(x($))},R($.framerate)+"fps",3)])):H("",!0)])])],14,cn))),128))],8,ln)]))}}),hn=re(_n,[["__scopeId","data-v-206e9703"]]),bn={key:0,class:"py-8 text-center text-preke-text-muted"},yn={key:1,class:"camera-setup"},wn={class:"camera-list"},kn={class:"list-header"},Cn=["disabled"],xn={key:0,class:"empty-state"},$n={key:1,class:"camera-items"},Rn={class:"camera-item__info"},Sn={class:"camera-item__header"},Mn={class:"camera-item__name"},Tn={class:"camera-item__details"},En={class:"camera-item__type"},Pn={class:"camera-item__ip"},Ln={class:"camera-item__actions"},An=["onClick","disabled"],Dn={key:0,class:"btn-icon-sm",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Bn={key:1,class:"spinner"},Nn=["onClick","disabled"],Hn=["onClick","disabled"],Wn={key:0,class:"camera-form"},Fn={class:"form-header"},Un={class:"form-title"},Vn={class:"form-content"},jn={class:"form-group"},Gn={class:"form-group"},In=["value"],On={class:"form-group"},zn={class:"form-group"},qn=["placeholder"],Kn={class:"form-hint"},Yn={class:"form-group"},Qn={class:"form-checkbox"},Xn={class:"form-actions"},Jn={class:"flex items-center justify-between w-full"},Zn={key:0,class:"text-sm text-amber-400"},eo={key:1,class:"text-sm text-preke-text-muted"},to={class:"flex gap-3"},no=["disabled"],oo=Q({__name:"CameraSetupModal",emits:["close","updated"],setup(n,{expose:t,emit:o}){const m=o,r=k(null),i=Ne(),l=k(!1),a=k(!1),d=k(null),_=k([]),c=k(null),h=[{value:"blackmagic",label:"Blackmagic Design Studio Camera 4K Pro"},{value:"obsbot_tail2",label:"OBSbot Tail 2"}],u=k({name:"",type:"blackmagic",ip:"",port:void 0,enabled:!0}),b={blackmagic:80,obsbot_tail2:52381},v=M(()=>c.value!==null),x=k(!1);async function L(){l.value=!0;try{const S=await ve.cameras.getConfig();_.value=S.cameras.map(p=>({name:p.name,type:p.type,ip:p.ip,port:p.port,enabled:p.enabled??!0})),x.value=!1}catch(S){console.error("[CameraSetup] Failed to load config:",S),i.error("Failed to load camera configuration")}finally{l.value=!1}}function T(){u.value={name:"",type:"blackmagic",ip:"",port:void 0,enabled:!0},c.value=null}function s(S){c.value=S,u.value={..._.value[S]}}function f(){T()}function $(){T(),c.value=-1}async function F(S){confirm(`Delete camera "${_.value[S].name}"?`)&&(_.value.splice(S,1),x.value=!0,await D())}async function te(S){d.value=S.name;try{(await ve.cameras.getStatus(S.name)).connected?i.success(`${S.name} is connected!`):i.warning(`${S.name} is not connected`)}catch{try{const E=await fetch(`http://${S.ip}:${S.port||b[S.type]}/`,{method:"HEAD",mode:"no-cors",signal:AbortSignal.timeout(3e3)});i.info(`${S.name}: IP ${S.ip} is reachable`)}catch{i.error(`${S.name}: Cannot reach ${S.ip}`)}}finally{d.value=null}}function X(){return u.value.name.trim()?u.value.ip.trim()?/^(\d{1,3}\.){3}\d{1,3}$/.test(u.value.ip)?_.value.findIndex((E,y)=>E.name===u.value.name&&y!==c.value)>=0?(i.error("Camera name already exists"),!1):!0:(i.error("Invalid IP address format"),!1):(i.error("Camera IP address is required"),!1):(i.error("Camera name is required"),!1)}function ie(){X()&&(u.value.port||(u.value.port=b[u.value.type]),c.value===-1?_.value.push({...u.value}):c.value!==null&&c.value>=0&&(_.value[c.value]={...u.value}),x.value=!0,T())}async function D(){a.value=!0;try{await ve.cameras.updateConfig(_.value),i.success("Camera configuration saved!"),x.value=!1,m("updated")}catch(S){console.error("[CameraSetup] Failed to save config:",S),i.error("Failed to save configuration: "+(S.message||"Unknown error"))}finally{a.value=!1}}function q(){var S;(S=r.value)==null||S.open(),L()}function A(){var S;x.value&&!confirm("You have unsaved changes. Close anyway?")||((S=r.value)==null||S.close(),T(),x.value=!1,m("close"))}return t({open:q,close:A}),ee(()=>{L()}),(S,p)=>(g(),he(qe,{ref_key:"modalRef",ref:r,title:"Camera Setup",size:"xl",onClose:A},{header:ne(()=>[...p[5]||(p[5]=[e("div",{class:"flex items-center justify-between w-full"},[e("div",null,[e("h2",{class:"text-lg font-semibold text-preke-text"},"Camera Setup"),e("p",{class:"text-sm text-preke-text-muted mt-1"}," Configure external cameras for control ")])],-1)])]),footer:ne(()=>[e("div",Jn,[x.value?(g(),w("div",Zn," You have unsaved changes ")):(g(),w("div",eo,R(_.value.length)+" camera"+R(_.value.length!==1?"s":"")+" configured ",1)),e("div",to,[e("button",{onClick:A,class:"btn-secondary"}," Close "),e("button",{onClick:D,disabled:!x.value||a.value,class:"btn-primary"},R(a.value?"Saving...":"Save Configuration"),9,no)])])]),default:ne(()=>[l.value?(g(),w("div",bn," Loading camera configuration... ")):(g(),w("div",yn,[e("div",wn,[e("div",kn,[p[7]||(p[7]=e("h3",{class:"list-title"},"Configured Cameras",-1)),e("button",{onClick:$,class:"btn-add",disabled:v.value},[...p[6]||(p[6]=[e("svg",{class:"btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),oe(" Add Camera ",-1)])],8,Cn)]),_.value.length===0&&!v.value?(g(),w("div",xn,[...p[8]||(p[8]=[e("svg",{class:"empty-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})],-1),e("p",{class:"empty-text"},"No cameras configured",-1),e("p",{class:"empty-hint"},'Click "Add Camera" to get started',-1)])])):(g(),w("div",$n,[(g(!0),w(O,null,ge(_.value,(E,y)=>{var C;return g(),w("div",{key:y,class:U(["camera-item",{"camera-item--disabled":!E.enabled}])},[e("div",Rn,[e("div",Sn,[e("span",Mn,R(E.name),1),e("span",{class:U(["camera-item__badge",E.enabled?"camera-item__badge--enabled":"camera-item__badge--disabled"])},R(E.enabled?"Enabled":"Disabled"),3)]),e("div",Tn,[e("span",En,R(((C=h.find(W=>W.value===E.type))==null?void 0:C.label)||E.type),1),e("span",Pn,R(E.ip)+":"+R(E.port||b[E.type]),1)])]),e("div",Ln,[e("button",{onClick:W=>te(E),disabled:d.value===E.name,class:"btn-test",title:"Test Connection"},[d.value!==E.name?(g(),w("svg",Dn,[...p[9]||(p[9]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 10V3L4 14h7v7l9-11h-7z"},null,-1)])])):(g(),w("span",Bn))],8,An),e("button",{onClick:W=>s(y),disabled:v.value,class:"btn-edit",title:"Edit"},[...p[10]||(p[10]=[e("svg",{class:"btn-icon-sm",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})],-1)])],8,Nn),e("button",{onClick:W=>F(y),disabled:v.value,class:"btn-delete",title:"Delete"},[...p[11]||(p[11]=[e("svg",{class:"btn-icon-sm",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})],-1)])],8,Hn)])],2)}),128))]))]),v.value?(g(),w("div",Wn,[e("div",Fn,[e("h3",Un,R(c.value===-1?"Add Camera":"Edit Camera"),1),e("button",{onClick:f,class:"btn-cancel-form"},"Cancel")]),e("div",Vn,[e("div",jn,[p[12]||(p[12]=e("label",{class:"form-label"},"Camera Name *",-1)),K(e("input",{"onUpdate:modelValue":p[0]||(p[0]=E=>u.value.name=E),type:"text",class:"form-input",placeholder:"e.g., BMD Cam 1"},null,512),[[ue,u.value.name]])]),e("div",Gn,[p[13]||(p[13]=e("label",{class:"form-label"},"Camera Type *",-1)),K(e("select",{"onUpdate:modelValue":p[1]||(p[1]=E=>u.value.type=E),class:"form-input"},[(g(),w(O,null,ge(h,E=>e("option",{key:E.value,value:E.value},R(E.label),9,In)),64))],512),[[Oe,u.value.type]])]),e("div",On,[p[14]||(p[14]=e("label",{class:"form-label"},"IP Address *",-1)),K(e("input",{"onUpdate:modelValue":p[2]||(p[2]=E=>u.value.ip=E),type:"text",class:"form-input",placeholder:"192.168.1.101"},null,512),[[ue,u.value.ip]]),p[15]||(p[15]=e("p",{class:"form-hint"},"Camera's network IP address",-1))]),e("div",zn,[p[16]||(p[16]=e("label",{class:"form-label"},"Port",-1)),K(e("input",{"onUpdate:modelValue":p[3]||(p[3]=E=>u.value.port=E),type:"number",class:"form-input",placeholder:String(b[u.value.type])},null,8,qn),[[ue,u.value.port,void 0,{number:!0}]]),e("p",Kn,"Default: "+R(b[u.value.type])+" for "+R(u.value.type),1)]),e("div",Yn,[e("label",Qn,[K(e("input",{"onUpdate:modelValue":p[4]||(p[4]=E=>u.value.enabled=E),type:"checkbox",class:"checkbox"},null,512),[[ze,u.value.enabled]]),p[17]||(p[17]=e("span",null,"Enabled",-1))]),p[18]||(p[18]=e("p",{class:"form-hint"},"Disable to keep configuration but not use the camera",-1))]),e("div",Xn,[e("button",{onClick:ie,class:"btn-save-form"},R(c.value===-1?"Add Camera":"Update Camera"),1),e("button",{onClick:f,class:"btn-cancel-form"}," Cancel ")])])])):H("",!0)]))]),_:1},512))}}),ao=re(oo,[["__scopeId","data-v-d42e0adf"]]),so={class:"sidebar"},ro={class:"sidebar__card sidebar__card--header"},io={class:"connection-row"},lo={class:"connection-status"},co={class:"connection-label"},uo={key:0,class:"connection-latency"},fo=["disabled"],vo={class:"sidebar__card sidebar__card--recording"},po={class:"recording__duration"},mo={class:"recording__meta"},go={key:0,class:"sidebar__card sidebar__card--warning"},_o={class:"warning__text"},ho={key:1,class:"sidebar__card sidebar__card--davinci"},bo={class:"davinci__buttons"},yo=["disabled"],wo=["disabled"],ko=["disabled"],Co={class:"sidebar__card"},xo={key:0,class:"cameras"},$o={class:"camera__header"},Ro=["onClick","disabled"],So={key:1,class:"cameras-empty"},Mo=Q({__name:"SessionInfoV2",setup(n){const t=He(),o=Y(),m=Se(),r=Ne(),{state:i,latencyMs:l}=Ke(),{connectionMethod:a}=Ye(),d=M(()=>{const y=i.value==="connected",C=i.value==="connecting",W=i.value==="degraded";if(y){let P="";return a.value==="relay"?P="Relay":a.value==="p2p"?P="P2P":a.value==="local"&&(P="Local"),{status:"online",color:"green",label:P||"Connected",latency:l.value,pulse:!1}}return C?{status:"connecting",color:"amber",label:"Connecting...",latency:null,pulse:!0}:W?{status:"degraded",color:"amber",label:"Slow",latency:l.value,pulse:!1}:{status:"offline",color:"red",label:"Offline",latency:null,pulse:!0}}),_=M(()=>o.currentSession);M(()=>o.activeInputs);const c=M(()=>o.isRecording),h=M(()=>o.inputs.filter(y=>y.isRecording)),u=k("");ee(()=>{const C=new Date().toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,".");u.value=`Session ${C}`});const{cameras:b,loadCameras:v}=et(),x=k(null),L=k(null),T=k(null);ee(async()=>{await v()});function s(y){var C;x.value=y,(C=L.value)==null||C.open()}function f(){x.value=null}function $(){var y;(y=T.value)==null||y.open()}function F(){v()}const te=M(()=>{const y=m.capabilities;if(!y)return null;const C=y.storage_used_gb||0,W=y.storage_total_gb||1,P=W-C,B=Math.round(C/W*100),We=P/10;return{freeGB:Math.round(P),totalGB:Math.round(W),percent:B,hoursRemaining:Math.round(We*10)/10,isLow:B>85,isCritical:B>95}});function X(){t.push({name:"admin",query:{tab:"settings"}})}const ie=M(()=>Qe()),D=k(!1),q=M(()=>{const y=_.value;return y!=null&&y.id?`Preke_${y.id}`:`Preke_${u.value.replace(/\s+/g,"_")}`}),A=window.electronAPI;async function S(){if(A!=null&&A.davinciOpenProject){D.value=!0,r.info("Opening DaVinci Resolve...");try{const y=await A.davinciOpenProject(q.value);y.success?r.success(`Opened project: ${y.projectName}`):r.error(y.error||"Failed to open DaVinci project")}catch(y){console.error("DaVinci error:",y),r.error("Failed to connect to DaVinci Resolve")}finally{D.value=!1}}}async function p(){if(A!=null&&A.davinciCreateMulticam){D.value=!0;try{A.davinciOpenProject&&await A.davinciOpenProject(q.value);const y=await A.davinciCreateMulticam({projectName:q.value,clipName:`Multicam_${u.value.replace(/\s+/g,"_")}`,syncMethod:"timecode"});y.success?r.success(`Created timeline: ${y.timelineName}`):r.error(y.error||"Failed to create multicam timeline")}catch(y){console.error("DaVinci error:",y),r.error("Failed to create multicam timeline")}finally{D.value=!1}}}async function E(){if(A!=null&&A.davinciRefreshClips){D.value=!0,r.info("Refreshing growing clips...");try{const y=await A.davinciRefreshClips();if(y.success){const C=y.clipsRefreshed||0;r.success(`Refreshed ${C} clip${C!==1?"s":""}`)}else r.error(y.error||"Failed to refresh clips")}catch(y){console.error("DaVinci refresh error:",y),r.error("Failed to refresh clips")}finally{D.value=!1}}}return(y,C)=>{var W;return g(),w("div",so,[e("div",ro,[e("div",io,[e("div",lo,[e("span",{class:U(["connection-dot",[`connection-dot--${d.value.color}`,{"connection-dot--pulse":d.value.pulse}]])},null,2),e("span",co,R(d.value.label),1),d.value.latency?(g(),w("span",uo,R(d.value.latency)+"ms ",1)):H("",!0)])]),C[1]||(C[1]=e("div",{class:"sidebar__divider"},null,-1)),C[2]||(C[2]=e("label",{class:"sidebar__label"},"Session Name",-1)),K(e("input",{"onUpdate:modelValue":C[0]||(C[0]=P=>u.value=P),type:"text",class:"sidebar__input",placeholder:"Session 06.01.2026",disabled:c.value},null,8,fo),[[ue,u.value]])]),c.value?(g(),w(O,{key:0},[e("div",vo,[C[3]||(C[3]=e("div",{class:"recording__header"},[e("span",{class:"recording__dot"}),e("span",{class:"recording__label"},"Recording")],-1)),e("div",po,R(ae(o).formattedDuration),1),e("div",mo,R(h.value.length)+" camera"+R(h.value.length!==1?"s":"")+" recording ",1)]),(W=te.value)!=null&&W.isLow?(g(),w("div",go,[C[5]||(C[5]=e("span",{class:"warning__icon"},"⚠️",-1)),e("div",_o,[C[4]||(C[4]=e("strong",null,"Low storage",-1)),e("span",null,R(te.value.freeGB)+" GB remaining",1)])])):H("",!0),ie.value?(g(),w("div",ho,[C[6]||(C[6]=Be('<div class="davinci__header" data-v-a373edd4><svg class="davinci__icon" viewBox="0 0 24 24" fill="currentColor" data-v-a373edd4><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" data-v-a373edd4></path></svg><span class="davinci__label" data-v-a373edd4>DaVinci Resolve</span></div><p class="davinci__hint" data-v-a373edd4>Edit while recording (mount R58 recordings via SMB)</p>',2)),e("div",bo,[e("button",{onClick:S,disabled:D.value,class:"davinci__btn"},R(D.value?"Opening...":"Open Project"),9,yo),e("button",{onClick:p,disabled:D.value,class:"davinci__btn davinci__btn--secondary"}," Create Multicam ",8,wo),e("button",{onClick:E,disabled:D.value,class:"davinci__btn davinci__btn--secondary",title:"Refresh growing clips to update duration"},R(D.value?"Refreshing...":"Refresh Clips"),9,ko)])])):H("",!0)],64)):(g(),w(O,{key:1},[e("div",Co,[e("div",{class:"sidebar__label"},[C[8]||(C[8]=oe(" Camera Controls ",-1)),e("button",{onClick:$,class:"camera-setup-btn",title:"Setup Cameras"},[...C[7]||(C[7]=[e("svg",{class:"camera-setup-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("circle",{cx:"12",cy:"12",r:"3"})],-1)])])]),ae(b).length>0?(g(),w("div",xo,[(g(!0),w(O,null,ge(ae(b),P=>(g(),w("div",{key:P.name,class:"camera"},[e("div",$o,[oe(R(P.name)+" ",1),e("span",{class:U(["camera__status",P.connected?"camera__status--connected":"camera__status--disconnected"])},R(P.connected?"●":"○"),3)]),e("button",{class:"camera__control-btn",onClick:B=>s(P.name),disabled:!P.connected},[...C[9]||(C[9]=[e("svg",{class:"camera__control-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("circle",{cx:"12",cy:"12",r:"3"})],-1),e("span",null,"Controls",-1)])],8,Ro)]))),128))])):(g(),w("div",So,[C[10]||(C[10]=e("p",{class:"cameras-empty__text"},"No cameras configured",-1)),e("button",{onClick:$,class:"cameras-empty__btn"}," Setup Cameras ")]))]),j(tt,{ref_key:"cameraModalRef",ref:L,"camera-name":x.value,onClose:f},null,8,["camera-name"]),j(ao,{ref_key:"cameraSetupModalRef",ref:T,onUpdated:F},null,512),e("div",{class:"sidebar__card"},[C[12]||(C[12]=e("div",{class:"sidebar__label"},"Quick Actions",-1)),e("button",{onClick:X,class:"sidebar__btn"},[...C[11]||(C[11]=[e("svg",{class:"sidebar__btn-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","stroke-width":"1.8"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("circle",{cx:"12",cy:"12",r:"3"})],-1),oe(" Configure Inputs ",-1)])])])],64))])}}}),To=re(Mo,[["__scopeId","data-v-a373edd4"]]),Eo={class:"h-full flex flex-col"},Po={class:"recorder-header"},Lo={class:"recorder-header__left"},Ao={class:"recorder-header__title"},Do={key:0,class:"recorder-header__badge"},Bo={class:"flex-1 flex min-h-0 overflow-hidden"},No={class:"flex-1 min-h-0 min-w-0 p-3 overflow-hidden"},Ho={class:"w-72 flex-shrink-0 border-l border-preke-surface-border bg-preke-surface/80 backdrop-blur-lg p-4 overflow-y-auto"},Wo=Q({__name:"RecorderView",setup(n){const t=He(),o=Y(),m=Se(),{showLeaveConfirmation:r,confirmLeave:i,cancelLeave:l}=ot();function a(){t.push("/")}const d=M(()=>o.status==="recording"),_=M(()=>o.formattedDuration),c=k(!0),h=k(!1),u=k(!1),b=M(()=>h.value&&u.value);function v(){c.value=!1}async function x(){var f;if(!Xe())return;await m.fetchCapabilities();const s=(f=m.capabilities)==null?void 0:f.current_mode;if(s&&s!=="recorder"){console.log("[Recorder] Not in recorder mode, switching...");try{(await fetch(await Je("/api/mode/recorder"),{method:"POST"})).ok&&(await m.fetchCapabilities(),J.success("Switched to Recorder mode"))}catch($){console.warn("[Recorder] Failed to switch mode:",$)}}}function L(){console.log("[Recorder] All videos ready!"),u.value=!0}ee(async()=>{const s=performance.now();await Promise.all([x(),o.fetchInputs(),o.fetchStatus()]);const f=o.inputs.filter($=>$.hasSignal).length;console.log(`[Recorder] Data loaded: ${o.inputs.length} inputs, ${f} with signal (${Math.round(performance.now()-s)}ms)`),h.value=!0,f===0&&(u.value=!0)});const T=k(null);return z(r,s=>{var f,$;s?(f=T.value)==null||f.open():($=T.value)==null||$.close()}),(s,f)=>(g(),w(O,null,[j(Re,{name:"fade"},{default:ne(()=>[c.value?(g(),he(nt,{key:0,mode:"recorder","content-ready":b.value,"min-time":1500,"max-time":5e3,"show-cancel":!0,onReady:v,onCancel:a},null,8,["content-ready"])):H("",!0)]),_:1}),j(Re,{name:"content-fade"},{default:ne(()=>[K(e("div",Eo,[e("header",Po,[e("div",Lo,[e("div",Ao,[e("span",{class:U(["recorder-header__indicator",{"recorder-header__indicator--active":d.value}])},null,2),f[0]||(f[0]=e("span",{class:"recorder-header__label"},"Recorder",-1))]),d.value?(g(),w("span",Do," REC ")):H("",!0),j(Wt)]),j(Mt)]),e("div",Bo,[e("div",No,[j(hn,{onAllVideosReady:L})]),e("aside",Ho,[j(To)])]),j(Ae,{ref_key:"leaveDialog",ref:T,title:"Recording in Progress",message:`You are currently recording (${_.value}). Leaving will stop the recording and save all files.`,"confirm-text":"Leave and Stop Recording","cancel-text":"Stay",danger:!0,onConfirm:ae(i),onCancel:ae(l)},null,8,["message","onConfirm","onCancel"])],512),[[Ze,!c.value]])]),_:1})],64))}}),Vo=re(Wo,[["__scopeId","data-v-a7fdeea3"]]);export{Vo as default};
