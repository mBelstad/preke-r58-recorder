<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R58 WHEP Stream Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        h1 {
            text-align: center;
            color: #4CAF50;
        }
        .status {
            text-align: center;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .cameras {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .camera {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .camera h2 {
            margin-top: 0;
            color: #4CAF50;
        }
        video {
            width: 100%;
            height: auto;
            background: #000;
            border-radius: 4px;
        }
        .info {
            margin-top: 10px;
            font-size: 14px;
            color: #aaa;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-connecting { background: #FFA500; }
        .status-connected { background: #4CAF50; }
        .status-error { background: #f44336; }
        .error-message {
            color: #f44336;
            margin-top: 10px;
            font-size: 12px;
        }
        .cors-test {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .cors-test h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        .cors-result {
            font-family: monospace;
            font-size: 12px;
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ðŸŽ¥ R58 WHEP Stream Test</h1>
    
    <div class="status">
        <h2>System Status</h2>
        <p id="systemStatus">Initializing...</p>
    </div>

    <div class="cors-test">
        <h3>CORS Headers Test</h3>
        <p>Testing CORS headers on WHEP endpoints...</p>
        <div id="corsResults" class="cors-result">Running tests...</div>
    </div>

    <div class="cameras">
        <div class="camera">
            <h2>Camera 0</h2>
            <video id="video0" autoplay playsinline muted controls></video>
            <div class="info">
                <span class="status-indicator status-connecting" id="status0"></span>
                <span id="info0">Connecting...</span>
            </div>
            <div class="error-message" id="error0"></div>
        </div>

        <div class="camera">
            <h2>Camera 2</h2>
            <video id="video2" autoplay playsinline muted controls></video>
            <div class="info">
                <span class="status-indicator status-connecting" id="status2"></span>
                <span id="info2">Connecting...</span>
            </div>
            <div class="error-message" id="error2"></div>
        </div>

        <div class="camera">
            <h2>Camera 3</h2>
            <video id="video3" autoplay playsinline muted controls></video>
            <div class="info">
                <span class="status-indicator status-connecting" id="status3"></span>
                <span id="info3">Connecting...</span>
            </div>
            <div class="error-message" id="error3"></div>
        </div>
    </div>

    <script>
        const MEDIAMTX_HOST = 'https://r58-mediamtx.itagenten.no';
        const cameras = ['cam0', 'cam2', 'cam3'];

        // Test CORS headers first
        async function testCORS() {
            const results = [];
            
            for (const cam of cameras) {
                try {
                    const response = await fetch(`${MEDIAMTX_HOST}/${cam}/whep`, {
                        method: 'OPTIONS'
                    });
                    
                    const headers = {};
                    response.headers.forEach((value, key) => {
                        if (key.toLowerCase().includes('access-control')) {
                            headers[key] = value;
                        }
                    });
                    
                    const allowOrigin = response.headers.get('access-control-allow-origin');
                    const count = allowOrigin ? allowOrigin.split(',').length : 0;
                    
                    results.push(`${cam}: âœ… Status ${response.status}`);
                    results.push(`  Access-Control-Allow-Origin: ${allowOrigin || 'NOT SET'}`);
                    results.push(`  Header count: ${count} ${count === 1 ? 'âœ… GOOD' : 'âŒ DUPLICATE!'}`);
                    results.push('');
                } catch (error) {
                    results.push(`${cam}: âŒ Error - ${error.message}`);
                    results.push('');
                }
            }
            
            document.getElementById('corsResults').textContent = results.join('\n');
        }

        // WHEP client implementation
        async function startWHEP(camName, videoId) {
            const video = document.getElementById(`video${camName.replace('cam', '')}`);
            const statusEl = document.getElementById(`status${camName.replace('cam', '')}`);
            const infoEl = document.getElementById(`info${camName.replace('cam', '')}`);
            const errorEl = document.getElementById(`error${camName.replace('cam', '')}`);
            
            try {
                infoEl.textContent = 'Creating peer connection...';
                
                // Create peer connection
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });

                // Add transceiver for receiving video
                pc.addTransceiver('video', { direction: 'recvonly' });
                pc.addTransceiver('audio', { direction: 'recvonly' });

                // Handle incoming tracks
                pc.ontrack = (event) => {
                    console.log(`${camName}: Received track`, event.track.kind);
                    if (event.track.kind === 'video') {
                        video.srcObject = event.streams[0];
                        statusEl.className = 'status-indicator status-connected';
                        infoEl.textContent = 'Connected! Receiving video';
                    }
                };

                // Handle connection state
                pc.onconnectionstatechange = () => {
                    console.log(`${camName}: Connection state:`, pc.connectionState);
                    infoEl.textContent = `Connection: ${pc.connectionState}`;
                    
                    if (pc.connectionState === 'connected') {
                        statusEl.className = 'status-indicator status-connected';
                    } else if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected') {
                        statusEl.className = 'status-indicator status-error';
                        errorEl.textContent = `Connection ${pc.connectionState}`;
                    }
                };

                // Create offer
                infoEl.textContent = 'Creating offer...';
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                // Send offer to WHEP endpoint
                infoEl.textContent = 'Sending WHEP request...';
                const response = await fetch(`${MEDIAMTX_HOST}/${camName}/whep`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/sdp'
                    },
                    body: offer.sdp
                });

                if (!response.ok) {
                    throw new Error(`WHEP request failed: ${response.status} ${response.statusText}`);
                }

                // Get answer
                const answerSDP = await response.text();
                await pc.setRemoteDescription({
                    type: 'answer',
                    sdp: answerSDP
                });

                infoEl.textContent = 'Waiting for connection...';
                console.log(`${camName}: WHEP negotiation complete`);

            } catch (error) {
                console.error(`${camName}: Error:`, error);
                statusEl.className = 'status-indicator status-error';
                infoEl.textContent = 'Connection failed';
                errorEl.textContent = `Error: ${error.message}`;
            }
        }

        // Initialize
        async function init() {
            document.getElementById('systemStatus').textContent = 'Testing CORS headers...';
            
            // Test CORS first
            await testCORS();
            
            document.getElementById('systemStatus').textContent = 'Starting WHEP connections...';
            
            // Start all cameras
            for (const cam of cameras) {
                await startWHEP(cam, `video${cam.replace('cam', '')}`);
            }
            
            document.getElementById('systemStatus').textContent = 'âœ… All streams initialized';
        }

        // Start when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>

