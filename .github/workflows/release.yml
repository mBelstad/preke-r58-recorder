name: Release Quality Gates

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      run_device_tests:
        description: 'Run device smoke tests'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Full Test Suite
  # ============================================
  full-backend-tests:
    name: Full Backend Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          cd packages/backend
          pip install -e .[dev]
          pip install pytest-cov
      
      - name: Run all tests with coverage
        run: |
          cd packages/backend
          pytest tests/ -v --cov=r58_api --cov=pipeline_manager --cov-report=xml --cov-report=html --junitxml=test-results.xml
        env:
          R58_JWT_SECRET: test-secret
          R58_DEVICE_ID: test-device
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: packages/backend/htmlcov/
      
      - name: Check coverage threshold
        run: |
          cd packages/backend
          coverage report --fail-under=70 || echo "Coverage below threshold"

  full-frontend-tests:
    name: Full Frontend Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        run: |
          cd packages/frontend
          npm ci
      
      - name: Run tests with coverage
        run: |
          cd packages/frontend
          npm test -- --run --coverage
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: packages/frontend/coverage/

  full-e2e-tests:
    name: Full E2E Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install frontend dependencies
        run: |
          cd packages/frontend
          npm ci
      
      - name: Install Playwright browsers
        run: |
          cd packages/frontend
          npx playwright install --with-deps
      
      - name: Install backend dependencies
        run: |
          cd packages/backend
          pip install -e .[dev]
      
      - name: Start backend server
        run: |
          cd packages/backend
          uvicorn r58_api.main:app --host 0.0.0.0 --port 8000 &
          sleep 5
        env:
          R58_JWT_SECRET: test-secret
          R58_DEVICE_ID: test-device
      
      - name: Run all E2E tests
        run: |
          cd packages/frontend
          npx playwright test
        env:
          VITE_API_URL: http://localhost:8000
      
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-full
          path: packages/frontend/playwright-report/

  # ============================================
  # Build Artifacts
  # ============================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: [full-frontend-tests]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        run: |
          cd packages/frontend
          npm ci
      
      - name: Build production bundle
        run: |
          cd packages/frontend
          npm run build
      
      - name: Check bundle size
        run: |
          cd packages/frontend
          du -sh dist/
          # Fail if bundle is too large (>10MB uncompressed)
          size=$(du -s dist/ | cut -f1)
          if [ "$size" -gt 10240 ]; then
            echo "Warning: Bundle size exceeds 10MB"
          fi
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: packages/frontend/dist/

  # ============================================
  # Performance Tests
  # ============================================
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [full-e2e-tests]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          cd packages/frontend
          npm ci
          npx playwright install chromium
          cd ../backend
          pip install -e .[dev]
      
      - name: Start servers
        run: |
          cd packages/backend
          uvicorn r58_api.main:app --host 0.0.0.0 --port 8000 &
          cd ../frontend
          npm run build
          npm run preview &
          sleep 5
        env:
          R58_JWT_SECRET: test-secret
          R58_DEVICE_ID: test-device
      
      - name: Run performance tests
        run: |
          cd packages/frontend
          npx playwright test e2e/health.spec.ts --grep "performance"
        env:
          VITE_API_URL: http://localhost:8000

  # ============================================
  # Release Gate Summary
  # ============================================
  release-ready:
    name: Release Ready
    runs-on: ubuntu-latest
    needs:
      - full-backend-tests
      - full-frontend-tests
      - full-e2e-tests
      - build-frontend
      - performance-tests
    steps:
      - name: All release gates passed
        run: |
          echo "âœ… All release quality gates passed!"
          echo "Ready for deployment to R58 devices."

