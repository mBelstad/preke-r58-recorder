version: '3.8'

services:
  mediamtx:
    image: bluenviron/mediamtx:latest
    container_name: mediamtx-relay
    restart: unless-stopped
    
    ports:
      - "8889:8889"       # WebRTC HTTP/WHIP/WHEP
      - "8189:8189/udp"   # WebRTC UDP
      - "8190:8190"       # WebRTC TCP
      - "8888:8888"       # HLS
      - "8554:8554"       # RTSP (optional)
      - "9997:9997"       # API
    
    volumes:
      - ./mediamtx-coolify.yml:/mediamtx.yml:ro
      - ./ssl:/ssl:ro
      - mediamtx-data:/data
    
    environment:
      - MTX_PROTOCOLS=webrtc,hls,rtsp
      - MTX_LOGLEVEL=info
    
    networks:
      - vdo-network
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9997/v3/config/global/get"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional: VDO.ninja signaling server
  vdo-ninja-signaling:
    image: node:18-alpine
    container_name: vdo-signaling
    restart: unless-stopped
    working_dir: /app
    
    ports:
      - "8443:8443"
    
    volumes:
      - ./vdo-signaling:/app
      - ./ssl:/ssl:ro
    
    command: node server.js
    
    networks:
      - vdo-network
    
    depends_on:
      - mediamtx

  # Optional: Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: vdo-nginx
    restart: unless-stopped
    
    ports:
      - "443:443"
      - "80:80"
    
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/ssl:ro
    
    networks:
      - vdo-network
    
    depends_on:
      - mediamtx
      - vdo-ninja-signaling

volumes:
  mediamtx-data:

networks:
  vdo-network:
    driver: bridge


