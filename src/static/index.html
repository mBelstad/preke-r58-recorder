<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R58 Recorder Control Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.healthy {
            background: #10b981;
        }

        .status-indicator.unhealthy {
            background: #ef4444;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.25rem;
        }

        .camera-control {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .camera-control h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .camera-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .camera-status.idle {
            background: #e5e7eb;
            color: #374151;
        }

        .camera-status.recording {
            background: #fee2e2;
            color: #991b1b;
        }

        .camera-status.error {
            background: #fef3c7;
            color: #92400e;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .video-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #9ca3af;
            text-align: center;
        }

        .recordings-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .recording-item {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recording-item:last-child {
            border-bottom: none;
        }

        .recording-info {
            flex: 1;
        }

        .recording-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }

        .recording-meta {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .recording-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.75rem;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸŽ¥ R58 Recorder Control Panel</h1>
            <div>
                <span class="status-indicator" id="healthIndicator"></span>
                <span id="healthStatus">Checking...</span>
            </div>
        </div>

        <div class="grid">
            <!-- Camera Controls -->
            <div class="card">
                <h2>Camera Controls</h2>
                <div id="cameraControls"></div>
            </div>

            <!-- Live Preview -->
            <div class="card">
                <h2>Live Preview</h2>
                <div class="video-container">
                    <video id="liveVideo" autoplay muted playsinline></video>
                    <div class="video-placeholder" id="videoPlaceholder">
                        <div>No stream available</div>
                        <div style="font-size: 0.75rem; margin-top: 8px;">Enable MediaMTX to view live feed</div>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn-secondary" onclick="toggleStream()" id="streamBtn">Start Stream</button>
                </div>
            </div>
        </div>

        <!-- Recordings -->
        <div class="card">
            <h2>Recordings</h2>
            <div class="button-group" style="margin-bottom: 15px;">
                <button class="btn-secondary" onclick="loadRecordings()">Refresh</button>
            </div>
            <div class="recordings-list" id="recordingsList">
                <div style="text-align: center; padding: 20px; color: #6b7280;">Loading recordings...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let streamActive = false;
        let statusInterval = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            loadStatus();
            loadRecordings();
            
            // Auto-refresh status every 2 seconds
            statusInterval = setInterval(loadStatus, 2000);
        });

        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                const indicator = document.getElementById('healthIndicator');
                const status = document.getElementById('healthStatus');
                
                if (data.status === 'healthy') {
                    indicator.className = 'status-indicator healthy';
                    status.textContent = `System Healthy (${data.platform})`;
                } else {
                    indicator.className = 'status-indicator unhealthy';
                    status.textContent = 'System Unhealthy';
                }
            } catch (error) {
                document.getElementById('healthIndicator').className = 'status-indicator unhealthy';
                document.getElementById('healthStatus').textContent = 'Connection Error';
            }
        }

        async function loadStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const data = await response.json();
                updateCameraControls(data.cameras);
            } catch (error) {
                console.error('Failed to load status:', error);
            }
        }

        function updateCameraControls(cameras) {
            const container = document.getElementById('cameraControls');
            container.innerHTML = '';

            for (const [camId, camData] of Object.entries(cameras)) {
                const status = camData.status;
                const statusClass = status === 'recording' ? 'recording' : 
                                   status === 'error' ? 'error' : 'idle';
                
                const div = document.createElement('div');
                div.className = 'camera-control';
                div.innerHTML = `
                    <h3>${camId.toUpperCase()}</h3>
                    <div class="camera-status ${statusClass}">${status}</div>
                    <div class="button-group">
                        <button class="btn-primary" 
                                onclick="startRecording('${camId}')" 
                                ${status === 'recording' ? 'disabled' : ''}>
                            Start Recording
                        </button>
                        <button class="btn-danger" 
                                onclick="stopRecording('${camId}')" 
                                ${status !== 'recording' ? 'disabled' : ''}>
                            Stop Recording
                        </button>
                    </div>
                `;
                container.appendChild(div);
            }
        }

        async function startRecording(camId) {
            try {
                const response = await fetch(`${API_BASE}/record/start/${camId}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    showAlert(`Recording started for ${camId}`, 'success');
                    loadStatus();
                } else {
                    showAlert(`Failed to start recording: ${data.detail}`, 'error');
                }
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'error');
            }
        }

        async function stopRecording(camId) {
            try {
                const response = await fetch(`${API_BASE}/record/stop/${camId}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    showAlert(`Recording stopped for ${camId}`, 'success');
                    loadStatus();
                    loadRecordings();
                } else {
                    showAlert(`Failed to stop recording: ${data.detail}`, 'error');
                }
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'error');
            }
        }

        async function loadRecordings() {
            try {
                const response = await fetch(`${API_BASE}/recordings/cam0`);
                const data = await response.json();
                
                const list = document.getElementById('recordingsList');
                if (data.recordings && data.recordings.length > 0) {
                    list.innerHTML = data.recordings.map(rec => `
                        <div class="recording-item">
                            <div class="recording-info">
                                <div class="recording-name">${rec.filename}</div>
                                <div class="recording-meta">
                                    ${formatBytes(rec.size)} â€¢ ${formatDate(rec.modified)}
                                </div>
                            </div>
                            <div class="recording-actions">
                                <button class="btn-primary btn-small" onclick="downloadRecording('${rec.filename}')">
                                    Download
                                </button>
                                <button class="btn-secondary btn-small" onclick="viewRecording('${rec.filename}')">
                                    View
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;">No recordings found</div>';
                }
            } catch (error) {
                document.getElementById('recordingsList').innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: #ef4444;">Error loading recordings</div>';
            }
        }

        let webrtcPlayer = null;

        function toggleStream() {
            const video = document.getElementById('liveVideo');
            const placeholder = document.getElementById('videoPlaceholder');
            const btn = document.getElementById('streamBtn');
            
            if (!streamActive) {
                const hostname = window.location.hostname;
                
                // Use HLS with 1-second segments for low latency (~2-3s)
                // WebRTC WHEP is complex and unreliable, HLS is more stable
                // HLS with 1s segments provides acceptable latency for live view
                startHLSStream(video, hostname, btn, placeholder);
            } else {
                // Stop stream
                if (webrtcPlayer) {
                    webrtcPlayer.close();
                    webrtcPlayer = null;
                }
                if (window.hlsPlayer) {
                    window.hlsPlayer.destroy();
                    window.hlsPlayer = null;
                }
                video.pause();
                video.src = '';
                streamActive = false;
                btn.textContent = 'Start Stream';
                placeholder.style.display = 'block';
            }
        }

        function startWebRTCStream(video, webrtcUrl, hostname, btn, placeholder) {
            // WebRTC via MediaMTX WHEP (WebRTC HTTP Egress Protocol)
            // This provides ultra-low latency (<1s) for live view
            const pc = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            pc.ontrack = (event) => {
                console.log('WebRTC track received');
                video.srcObject = event.streams[0];
                video.play().catch(e => {
                    console.error('WebRTC play failed:', e);
                    showAlert('WebRTC stream error. Trying HLS fallback...', 'warning');
                    startHLSStream(video, hostname, btn, placeholder);
                });
            };

            pc.oniceconnectionstatechange = () => {
                if (pc.iceConnectionState === 'failed' || pc.iceConnectionState === 'disconnected') {
                    console.error('WebRTC connection failed, falling back to HLS');
                    showAlert('WebRTC connection lost. Using HLS fallback...', 'warning');
                    startHLSStream(video, hostname, btn, placeholder);
                }
            };

            // WHEP protocol: Create offer with receive-only transceivers
            pc.addTransceiver('video', { direction: 'recvonly' });
            pc.addTransceiver('audio', { direction: 'recvonly' });

            let resourceUrl = null;

            // Create offer and send to MediaMTX WHEP endpoint
            pc.createOffer().then(offer => {
                return pc.setLocalDescription(offer);
            }).then(() => {
                return fetch(webrtcUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/sdp',
                        'Accept': 'application/sdp'
                    },
                    body: pc.localDescription.sdp
                });
            }).then(response => {
                if (!response.ok) {
                    // If WHEP fails, try HLS immediately
                    throw new Error(`WHEP error: ${response.status}`);
                }
                // Get resource URL from Location header (for ICE candidates)
                resourceUrl = response.headers.get('Location') || webrtcUrl;
                return response.text();
            }).then(answerSdp => {
                return pc.setRemoteDescription({ type: 'answer', sdp: answerSdp });
            }).then(() => {
                // Handle ICE candidates - send to resource URL
                pc.onicecandidate = (event) => {
                    if (event.candidate && resourceUrl) {
                        fetch(resourceUrl, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/trickle-ice-sdpfrag' },
                            body: 'a=' + event.candidate.candidate
                        }).catch(err => console.warn('ICE candidate send failed:', err));
                    }
                };
                
                webrtcPlayer = pc;
                streamActive = true;
                btn.textContent = 'Stop Stream';
                placeholder.style.display = 'none';
                console.log('WebRTC stream started (ultra-low latency)');
            }).catch(error => {
                console.error('WebRTC setup failed:', error);
                // Immediately fallback to HLS for better user experience
                console.log('Falling back to HLS (low latency with short segments)');
                startHLSStream(video, hostname, btn, placeholder);
            });
        }

        function startHLSStream(video, hostname, btn, placeholder) {
            const hlsUrl = `http://${hostname}:8888/cam0/index.m3u8`;
            
            if (video.canPlayType('application/vnd.apple.mpegurl') || 
                video.canPlayType('application/x-mpegURL')) {
                video.src = hlsUrl;
                video.play().catch(e => {
                    console.error('Play failed:', e);
                    showAlert('Stream not available. Start recording first.', 'error');
                });
                streamActive = true;
                btn.textContent = 'Stop Stream';
                placeholder.style.display = 'none';
            } else if (window.Hls && window.Hls.isSupported()) {
                const hls = new window.Hls();
                hls.loadSource(hlsUrl);
                hls.attachMedia(video);
                hls.on(window.Hls.Events.MANIFEST_PARSED, () => {
                    video.play();
                });
                hls.on(window.Hls.Events.ERROR, (event, data) => {
                    console.error('HLS error:', data);
                    if (data.fatal) {
                        showAlert('Stream error. Start recording first.', 'error');
                        hls.destroy();
                        streamActive = false;
                        btn.textContent = 'Start Stream';
                        placeholder.style.display = 'block';
                    }
                });
                window.hlsPlayer = hls;
                streamActive = true;
                btn.textContent = 'Stop Stream';
                placeholder.style.display = 'none';
            } else {
                showAlert('Streaming not supported. Use VLC with rtsp://' + hostname + ':8554/cam0', 'error');
            }
        }

        function downloadRecording(filename) {
            window.open(`${API_BASE}/recordings/cam0/${encodeURIComponent(filename)}`, '_blank');
        }

        function viewRecording(filename) {
            const url = `${API_BASE}/recordings/cam0/${encodeURIComponent(filename)}`;
            window.open(url, '_blank');
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatDate(timestamp) {
            return new Date(timestamp * 1000).toLocaleString();
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            document.querySelector('.container').insertBefore(alert, document.querySelector('.header').nextSibling);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>
</body>
</html>

