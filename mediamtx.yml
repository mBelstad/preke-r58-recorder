# MediaMTX configuration for R58 Recorder
logLevel: info
logDestinations: [stdout]

# API settings - needed for stream status checks
api: yes
apiAddress: :9997

# RTSP settings
rtspAddress: :8554

# RTMP settings
rtmpAddress: :1935

# HLS settings - optimized for STABILITY under high load
# Increased buffer to prevent 404 errors when system is busy
hlsAddress: :8888
hlsAlwaysRemux: yes
hlsSegmentCount: 10         # 20-second buffer (10 x 2s) - prevents segment expiry under load
hlsSegmentDuration: 2s      # Longer segments reduce generation frequency and CPU load
hlsPartDuration: 400ms      # Balanced LL-HLS - still fast but more stable
hlsAllowOrigins:
  - "https://preke.no"
  - "https://*.preke.no"
  - "https://itagenten.no"
  - "https://*.itagenten.no"
  - "http://localhost:*"
  - "http://127.0.0.1:*"
  - "http://192.168.*.*:*"
  - "http://100.*.*.*:*"

# SRT settings
srtAddress: :8890

# WebRTC settings (low latency for live view)
webrtcAddress: :8889
webrtcAllowOrigins:
  - "https://preke.no"
  - "https://*.preke.no"
  - "https://app.itagenten.no"  # VDO.ninja now served at /vdo/ on same domain (migrated Jan 2026)
  - "https://r58-vdo.itagenten.no"  # Legacy - kept for backward compatibility (redirects to app.itagenten.no/vdo)
  - "https://itagenten.no"
  - "https://*.itagenten.no"
  - "http://localhost:*"
  - "http://127.0.0.1:*"
  - "http://192.168.*.*:*"
  - "http://100.*.*.*:*"

# TLS encryption - DISABLED because nginx/Traefik handles SSL termination
# The FRP tunnel carries plain HTTP from VPS to R58
# webrtcEncryption: yes  # Enable only for direct HTTPS connections
webrtcEncryption: no
webrtcServerKey: /etc/ssl/r58/privkey.pem
webrtcServerCert: /etc/ssl/r58/fullchain.pem

# ICE configuration for NAT traversal
# webrtcAdditionalHosts advertises these IPs as host candidates (v1.15.6+)
# Priority order: Tailscale (P2P) > LAN (P2P) > VPS (relay fallback)
# This enables direct P2P connections when possible, falling back to VPS relay only when necessary
webrtcAdditionalHosts:
  - "100.65.219.117"  # Tailscale IP - P2P priority (no bandwidth cost)
  - "192.168.1.24"    # LAN IP - P2P priority (local network)
  - "65.109.32.111"   # VPS IP - Relay fallback (for remote access)

# UDP port for WebRTC media (mapped via FRP to 18189 on VPS)
webrtcLocalUDPAddress: :8189

# TCP port for WebRTC when UDP fails (essential for FRP tunnel)
# This enables WebRTC to work over TCP through the FRP tunnel
webrtcLocalTCPAddress: :8190

# STUN servers for ICE gathering
webrtcICEServers2:
  - url: stun:stun.l.google.com:19302

# Paths configuration
# Camera streams published via RTSP (rtspclientsink with H.265)
paths:
  cam0:
    source: publisher
  cam1:
    source: publisher
  cam2:
    source: publisher
  cam3:
    source: publisher
  mixer_program:
    source: publisher
    # Optimize for SFU usage - don't wait for source, accept immediately
    sourceOnDemand: no
    sourceOnDemandStartTimeout: 10s
    sourceOnDemandCloseAfter: 10s
  # Remote guest paths (published via WHIP)
  guest1:
    source: publisher
  guest2:
    source: publisher
  # Remote speaker paths (published via WHIP from guest_join page)
  speaker0:
    source: publisher
  speaker1:
    source: publisher
  speaker2:
    source: publisher
  # Ninja guest paths (published via WebRTC subscriber)
  ninja_guest1:
    source: publisher
  ninja_guest2:
    source: publisher
  ninja_guest3:
    source: publisher
  ninja_guest4:
    source: publisher
  # Ninja program output (if using Ninja mixer)
  ninja_program:
    source: publisher
  # Reveal.js presentation streams
  slides:
    source: publisher
  slides_overlay:
    source: publisher
